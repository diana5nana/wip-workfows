cscope 15 /home/corigine/xf/nfp-drv-kmods-private -q 0000008755 0001365661
	@src/abm/cls.c

4 
	~<lšux/b™f›ld.h
>

5 
	~<Ãt/pkt_þs.h
>

7 
	~"../nåcÜe/nå_ýp.h
"

8 
	~"../nå_­p.h
"

9 
	~"../nå_Ãt_»´.h
"

10 
	~"maš.h
"

12 
	snå_abm_u32_m©ch
 {

13 
u32
 
	mhªdË
;

14 
u32
 
	mbªd
;

15 
u8
 
	mmask
;

16 
u8
 
	mv®
;

17 
li¡_h—d
 
	mli¡
;

20 
boÞ


21 
	$nå_abm_u32_check_knode
(
nå_abm
 *
abm
, 
tc_þs_u32_knode
 *
knode
,

22 
__be16
 
´Ùo
, 
ÃŽšk_ext_ack
 *
exck
)

24 
tc_u32_key
 *
k
;

25 
tos_off
;

27 ià(
knode
->
exts
 && 
	`tcf_exts_has_aùiÚs
(knode->exts)) {

28 
	`NL_SET_ERR_MSG_MOD
(
exck
, "action offload‚ot supported");

29  
çl£
;

31 ià(
knode
->
lšk_hªdË
) {

32 
	`NL_SET_ERR_MSG_MOD
(
exck
, "linking‚ot supported");

33  
çl£
;

35 ià(
knode
->
£l
->
æags
 !ð
TC_U32_TERMINAL
) {

36 
	`NL_SET_ERR_MSG_MOD
(
exck
,

38  
çl£
;

40 ià(
knode
->
£l
->
off
 || knode->£l->
offshiá
 || knode->£l->
offmask
 ||

41 
knode
->
£l
->
offoff
 || knode->
fshiá
) {

42 
	`NL_SET_ERR_MSG_MOD
(
exck
, "variable offseting‚ot supported");

43  
çl£
;

45 ià(
knode
->
£l
->
hoff
 || knode->£l->
hmask
) {

46 
	`NL_SET_ERR_MSG_MOD
(
exck
, "hashing‚ot supported");

47  
çl£
;

49 ià(
knode
->
v®
 || knode->
mask
) {

50 
	`NL_SET_ERR_MSG_MOD
(
exck
, "matching on mark‚ot supported");

51  
çl£
;

53 ià(
knode
->
»s
 && knode->»s->
þass
) {

54 
	`NL_SET_ERR_MSG_MOD
(
exck
, "setting‚on-0 class‚ot supported");

55  
çl£
;

57 ià(
knode
->
»s
 && knode->»s->
þassid
 >ð
abm
->
num_bªds
) {

58 
	`NL_SET_ERR_MSG_MOD
(
exck
,

60  
çl£
;

62 ià(
knode
->
£l
->
nkeys
 != 1) {

63 
	`NL_SET_ERR_MSG_MOD
(
exck
, "exactly one key„equired");

64  
çl£
;

67 
´Ùo
) {

68 
	`htÚs
(
ETH_P_IP
):

69 
tos_off
 = 16;

71 
	`htÚs
(
ETH_P_IPV6
):

72 
tos_off
 = 20;

75 
	`NL_SET_ERR_MSG_MOD
(
exck
, "only IP‡nd IPv6 supported‡s filter…rotocol");

76  
çl£
;

79 
k
 = &
knode
->
£l
->
keys
[0];

80 ià(
k
->
offmask
) {

81 
	`NL_SET_ERR_MSG_MOD
(
exck
, "offset mask - variable offseting‚ot supported");

82  
çl£
;

84 ià(
k
->
off
) {

85 
	`NL_SET_ERR_MSG_MOD
(
exck
, "only DSCP fields can be matched");

86  
çl£
;

88 ià(
k
->
v®
 & ~k->
mask
) {

89 
	`NL_SET_ERR_MSG_MOD
(
exck
, "mask does‚ot coverhe key");

90  
çl£
;

92 ià(
	`be32_to_ýu
(
k
->
mask
è>> 
tos_off
 & ~
abm
->
dsý_mask
) {

93 
	`NL_SET_ERR_MSG_MOD
(
exck
, "only high DSCP class selector bits can be used");

94 
	`nå_”r
(
abm
->
­p
->
ýp
,

96 
	`be32_to_ýu
(
k
->
mask
è>> 
tos_off
, 
abm
->
dsý_mask
);

97  
çl£
;

100  
Œue
;

101 
	}
}

108 
	$nå_abm_fšd_bªd_fÜ_´io
(
nå_abm_lšk
 *
®šk
, 
´io
)

110 
nå_abm_u32_m©ch
 *
™”
;

112 
	`li¡_fÜ_—ch_’Œy
(
™”
, &
®šk
->
dsý_m­
, 
li¡
)

113 ià((
´io
 & 
™”
->
mask
è=ð™”->
v®
)

114  
™”
->
bªd
;

116  
®šk
->
def_bªd
;

117 
	}
}

119 
	$nå_abm_upd©e_bªd_m­
(
nå_abm_lšk
 *
®šk
)

121 
i
, 
b™s_³r_´io
, 
´ios_³r_wÜd
, 
ba£_shiá
;

122 
nå_abm
 *
abm
 = 
®šk
->abm;

123 
u32
 
f›ld_mask
;

125 
®šk
->
has_´io
 = !
	`li¡_em±y
(&®šk->
dsý_m­
);

127 
b™s_³r_´io
 = 
	`roundup_pow_of_two
(
	`Üd”_ba£_2
(
abm
->
num_bªds
));

128 
f›ld_mask
 = (1 << 
b™s_³r_´io
) - 1;

129 
´ios_³r_wÜd
 = (
u32
è* 
BITS_PER_BYTE
 / 
b™s_³r_´io
;

132 
ba£_shiá
 = 8 - 
	`Üd”_ba£_2
(
abm
->
num_´ios
);

134 
i
 = 0; i < 
abm
->
num_´ios
; i++) {

135 
off£t
;

136 
u32
 *
wÜd
;

137 
u8
 
bªd
;

139 
wÜd
 = &
®šk
->
´io_m­
[
i
 / 
´ios_³r_wÜd
];

140 
off£t
 = (
i
 % 
´ios_³r_wÜd
è* 
b™s_³r_´io
;

142 
bªd
 = 
	`nå_abm_fšd_bªd_fÜ_´io
(
®šk
, 
i
 << 
ba£_shiá
);

144 *
wÜd
 &ð~(
f›ld_mask
 << 
off£t
);

145 *
wÜd
 |ð
bªd
 << 
off£t
;

149 
	`nå_abm_qdisc_ofæßd_upd©e
(
®šk
);

151  
	`nå_abm_ù¾_´io_m­_upd©e
(
®šk
,‡lšk->
´io_m­
);

152 
	}
}

155 
	$nå_abm_u32_knode_d–‘e
(
nå_abm_lšk
 *
®šk
,

156 
tc_þs_u32_knode
 *
knode
)

158 
nå_abm_u32_m©ch
 *
™”
;

160 
	`li¡_fÜ_—ch_’Œy
(
™”
, &
®šk
->
dsý_m­
, 
li¡
)

161 ià(
™”
->
hªdË
 =ð
knode
->handle) {

162 
	`li¡_d–
(&
™”
->
li¡
);

163 
	`kä“
(
™”
);

164 
	`nå_abm_upd©e_bªd_m­
(
®šk
);

167 
	}
}

170 
	$nå_abm_u32_knode_»¶aû
(
nå_abm_lšk
 *
®šk
,

171 
tc_þs_u32_knode
 *
knode
,

172 
__be16
 
´Ùo
, 
ÃŽšk_ext_ack
 *
exck
)

174 
nå_abm_u32_m©ch
 *
m©ch
 = 
NULL
, *
™”
;

175 
tos_off
;

176 
u8
 
mask
, 
v®
;

177 
”r
;

179 ià(!
	`nå_abm_u32_check_knode
(
®šk
->
abm
, 
knode
, 
´Ùo
, 
exck
))

180 
”r_d–‘e
;

182 
tos_off
 = 
´Ùo
 =ð
	`htÚs
(
ETH_P_IP
) ? 16 : 20;

185 
v®
 = 
	`be32_to_ýu
(
knode
->
£l
->
keys
[0].v®è>> 
tos_off
 & 0xff;

186 
mask
 = 
	`be32_to_ýu
(
knode
->
£l
->
keys
[0].maskè>> 
tos_off
 & 0xff;

189 
	`li¡_fÜ_—ch_’Œy
(
™”
, &
®šk
->
dsý_m­
, 
li¡
) {

190 
u32
 
cmask
;

192 ià(
™”
->
hªdË
 =ð
knode
->handle) {

193 
m©ch
 = 
™”
;

197 
cmask
 = 
™”
->
mask
 & mask;

198 ià((
™”
->
v®
 & 
cmask
) == (val & cmask) &&

199 
™”
->
bªd
 !ð
knode
->
»s
->
þassid
) {

200 
	`NL_SET_ERR_MSG_MOD
(
exck
, "conflict with‡lready offloaded filter");

201 
”r_d–‘e
;

205 ià(!
m©ch
) {

206 
m©ch
 = 
	`kz®loc
((*m©ch), 
GFP_KERNEL
);

207 ià(!
m©ch
)

208  -
ENOMEM
;

209 
	`li¡_add
(&
m©ch
->
li¡
, &
®šk
->
dsý_m­
);

211 
m©ch
->
hªdË
 = 
knode
->handle;

212 
m©ch
->
bªd
 = 
knode
->
»s
->
þassid
;

213 
m©ch
->
mask
 = mask;

214 
m©ch
->
v®
 = val;

216 
”r
 = 
	`nå_abm_upd©e_bªd_m­
(
®šk
);

217 ià(
”r
)

218 
”r_d–‘e
;

222 
”r_d–‘e
:

223 
	`nå_abm_u32_knode_d–‘e
(
®šk
, 
knode
);

224  -
EOPNOTSUPP
;

225 
	}
}

227 
	$nå_abm_£tup_tc_block_cb
(
tc_£tup_ty³
 
ty³
,

228 *
ty³_d©a
, *
cb_´iv
)

230 
tc_þs_u32_ofæßd
 *
þs_u32
 = 
ty³_d©a
;

231 
nå_»´
 *
»´
 = 
cb_´iv
;

232 
nå_abm_lšk
 *
®šk
;

234 
®šk
 = 
»´
->
­p_´iv
;

236 ià(
ty³
 !ð
TC_SETUP_CLSU32
) {

237 
	`NL_SET_ERR_MSG_MOD
(
þs_u32
->
commÚ
.
exck
,

239  -
EOPNOTSUPP
;

241 ià(!
	`tc_þs_ÿn_ofæßd_ªd_chaš0
(
»´
->
Ãtdev
, &
þs_u32
->
commÚ
))

242  -
EOPNOTSUPP
;

244 ià(
þs_u32
->
commÚ
.
´ÙocÞ
 !ð
	`htÚs
(
ETH_P_IP
) &&

245 
þs_u32
->
commÚ
.
´ÙocÞ
 !ð
	`htÚs
(
ETH_P_IPV6
)) {

246 
	`NL_SET_ERR_MSG_MOD
(
þs_u32
->
commÚ
.
exck
,

248  -
EOPNOTSUPP
;

251 
þs_u32
->
commªd
) {

252 
TC_CLSU32_NEW_KNODE
:

253 
TC_CLSU32_REPLACE_KNODE
:

254  
	`nå_abm_u32_knode_»¶aû
(
®šk
, &
þs_u32
->
knode
,

255 
þs_u32
->
commÚ
.
´ÙocÞ
,

256 
þs_u32
->
commÚ
.
exck
);

257 
TC_CLSU32_DELETE_KNODE
:

258 
	`nå_abm_u32_knode_d–‘e
(
®šk
, &
þs_u32
->
knode
);

261  -
EOPNOTSUPP
;

263 
	}
}

265 
	$nå_abm_£tup_þs_block
(
Ãt_deviû
 *
Ãtdev
, 
nå_»´
 *
»´
,

266 
tc_block_ofæßd
 *
f
)

268 ià(
f
->
bšd”_ty³
 !ð
TCF_BLOCK_BINDER_TYPE_CLSACT_EGRESS
)

269  -
EOPNOTSUPP
;

271 
f
->
commªd
) {

272 
TC_BLOCK_BIND
:

273  
	`tcf_block_cb_»gi¡”
(
f
->
block
,

274 
nå_abm_£tup_tc_block_cb
,

275 
»´
,„•r, 
f
->
exck
);

276 
TC_BLOCK_UNBIND
:

277 
	`tcf_block_cb_uÄegi¡”
(
f
->
block
, 
nå_abm_£tup_tc_block_cb
,

278 
»´
);

281  -
EOPNOTSUPP
;

283 
	}
}

	@src/abm/ctrl.c

4 
	~<lšux/b™Ýs.h
>

5 
	~<lšux/k”Ãl.h
>

6 
	~<lšux/log2.h
>

8 
	~"../nåcÜe/nå_ýp.h
"

9 
	~"../nåcÜe/nå_nffw.h
"

10 
	~"../nå_­p.h
"

11 
	~"../nå_abi.h
"

12 
	~"../nå_maš.h
"

13 
	~"../nå_Ãt.h
"

14 
	~"maš.h
"

16 
	#NFP_NUM_PRIOS_SYM_NAME
 "_abi_pci_dsý_num_´io_%u"

	)

17 
	#NFP_NUM_BANDS_SYM_NAME
 "_abi_pci_dsý_num_bªd_%u"

	)

18 
	#NFP_ACT_MASK_SYM_NAME
 "_abi_nfd_out_q_aùiÚs_%u"

	)

20 
	#NFP_RED_SUPPORT_SYM_NAME
 "_abi_nfd_out_»d_ofæßd_%u"

	)

22 
	#NFP_QLVL_SYM_NAME
 "_abi_nfd_out_q_lvls_%u%s"

	)

23 
	#NFP_QLVL_STRIDE
 16

	)

24 
	#NFP_QLVL_BLOG_BYTES
 0

	)

25 
	#NFP_QLVL_BLOG_PKTS
 4

	)

26 
	#NFP_QLVL_THRS
 8

	)

27 
	#NFP_QLVL_ACT
 12

	)

29 
	#NFP_QMSTAT_SYM_NAME
 "_abi_nfdqm%u_¡©s%s"

	)

30 
	#NFP_QMSTAT_STRIDE
 32

	)

31 
	#NFP_QMSTAT_NON_STO
 0

	)

32 
	#NFP_QMSTAT_STO
 8

	)

33 
	#NFP_QMSTAT_DROP
 16

	)

34 
	#NFP_QMSTAT_ECN
 24

	)

36 
	#NFP_Q_STAT_SYM_NAME
 "_abi_nfd_rxq_¡©s%u%s"

	)

37 
	#NFP_Q_STAT_STRIDE
 16

	)

38 
	#NFP_Q_STAT_PKTS
 0

	)

39 
	#NFP_Q_STAT_BYTES
 8

	)

41 
	#NFP_NET_ABM_MBOX_CMD
 
NFP_NET_CFG_MBOX_SIMPLE_CMD


	)

42 
	#NFP_NET_ABM_MBOX_RET
 
NFP_NET_CFG_MBOX_SIMPLE_RET


	)

43 
	#NFP_NET_ABM_MBOX_DATALEN
 
NFP_NET_CFG_MBOX_SIMPLE_VAL


	)

44 
	#NFP_NET_ABM_MBOX_RESERVED
 (
NFP_NET_CFG_MBOX_SIMPLE_VAL
 + 4)

	)

45 
	#NFP_NET_ABM_MBOX_DATA
 (
NFP_NET_CFG_MBOX_SIMPLE_VAL
 + 8)

	)

48 
	$nå_abm_ù¾_¡©
(
nå_abm_lšk
 *
®šk
, cÚ¡ 
nå_¹sym
 *
sym
,

49 
¡ride
, 
off£t
, 
bªd
,

50 
queue
, 
boÞ
 
is_u64
, 
u64
 *
»s
)

52 
nå_ýp
 *
ýp
 = 
®šk
->
abm
->
­p
->cpp;

53 
u64
 
v®
, 
sym_off£t
;

54 
qid
;

55 
u32
 
v®32
;

56 
”r
;

58 
qid
 = 
bªd
 * 
NFP_NET_MAX_RX_RINGS
 + 
®šk
->
queue_ba£
 + 
queue
;

60 
sym_off£t
 = 
qid
 * 
¡ride
 + 
off£t
;

61 ià(
is_u64
)

62 
”r
 = 
	`__nå_¹sym_»adq
(
ýp
, 
sym
, 3, 0, 
sym_off£t
, &
v®
);

64 
”r
 = 
	`__nå_¹sym_»adl
(
ýp
, 
sym
, 3, 0, 
sym_off£t
, &
v®32
);

65 ià(
”r
) {

66 
	`nå_”r
(
ýp
, "RED offload„eading stat failed on vNIC %d band %d queue %d (+ %d)\n",

67 
®šk
->
id
, 
bªd
, 
queue
,‡lšk->
queue_ba£
);

68  
”r
;

71 *
»s
 = 
is_u64
 ? 
v®
 : 
v®32
;

73 
	}
}

75 
	$__nå_abm_ù¾_£t_q_lvl
(
nå_abm
 *
abm
, 
id
, 
u32
 
v®
)

77 
nå_ýp
 *
ýp
 = 
abm
->
­p
->cpp;

78 
u64
 
sym_off£t
;

79 
”r
;

81 
	`__þ—r_b™
(
id
, 
abm
->
th»shÞd_undef
);

82 ià(
abm
->
th»shÞds
[
id
] =ð
v®
)

85 
sym_off£t
 = 
id
 * 
NFP_QLVL_STRIDE
 + 
NFP_QLVL_THRS
;

86 
”r
 = 
	`__nå_¹sym_wr™–
(
ýp
, 
abm
->
q_lvls
, 4, 0, 
sym_off£t
, 
v®
);

87 ià(
”r
) {

88 
	`nå_”r
(
ýp
,

90 
id
);

91  
”r
;

94 
abm
->
th»shÞds
[
id
] = 
v®
;

96 
	}
}

98 
	$nå_abm_ù¾_£t_q_lvl
(
nå_abm_lšk
 *
®šk
, 
bªd
,

99 
queue
, 
u32
 
v®
)

101 
th»shÞd
;

103 
th»shÞd
 = 
bªd
 * 
NFP_NET_MAX_RX_RINGS
 + 
®šk
->
queue_ba£
 + 
queue
;

105  
	`__nå_abm_ù¾_£t_q_lvl
(
®šk
->
abm
, 
th»shÞd
, 
v®
);

106 
	}
}

108 
	$__nå_abm_ù¾_£t_q_aù
(
nå_abm
 *
abm
, 
id
,

109 
nå_abm_q_aùiÚ
 
aù
)

111 
nå_ýp
 *
ýp
 = 
abm
->
­p
->cpp;

112 
u64
 
sym_off£t
;

113 
”r
;

115 ià(
abm
->
aùiÚs
[
id
] =ð
aù
)

118 
sym_off£t
 = 
id
 * 
NFP_QLVL_STRIDE
 + 
NFP_QLVL_ACT
;

119 
”r
 = 
	`__nå_¹sym_wr™–
(
ýp
, 
abm
->
q_lvls
, 4, 0, 
sym_off£t
, 
aù
);

120 ià(
”r
) {

121 
	`nå_”r
(
ýp
,

123 
id
);

124  
”r
;

127 
abm
->
aùiÚs
[
id
] = 
aù
;

129 
	}
}

131 
	$nå_abm_ù¾_£t_q_aù
(
nå_abm_lšk
 *
®šk
, 
bªd
,

132 
queue
, 
nå_abm_q_aùiÚ
 
aù
)

134 
qid
;

136 
qid
 = 
bªd
 * 
NFP_NET_MAX_RX_RINGS
 + 
®šk
->
queue_ba£
 + 
queue
;

138  
	`__nå_abm_ù¾_£t_q_aù
(
®šk
->
abm
, 
qid
, 
aù
);

139 
	}
}

141 
u64
 
	$nå_abm_ù¾_¡©_nÚ_¡o
(
nå_abm_lšk
 *
®šk
, 
queue
)

143 
bªd
;

144 
u64
 
v®
, 
sum
 = 0;

146 
bªd
 = 0; bªd < 
®šk
->
abm
->
num_bªds
; band++) {

147 ià(
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
qm_¡©s
,

148 
NFP_QMSTAT_STRIDE
, 
NFP_QMSTAT_NON_STO
,

149 
bªd
, 
queue
, 
Œue
, &
v®
))

151 
sum
 +ð
v®
;

154  
sum
;

155 
	}
}

157 
u64
 
	$nå_abm_ù¾_¡©_¡o
(
nå_abm_lšk
 *
®šk
, 
queue
)

159 
bªd
;

160 
u64
 
v®
, 
sum
 = 0;

162 
bªd
 = 0; bªd < 
®šk
->
abm
->
num_bªds
; band++) {

163 ià(
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
qm_¡©s
,

164 
NFP_QMSTAT_STRIDE
, 
NFP_QMSTAT_STO
,

165 
bªd
, 
queue
, 
Œue
, &
v®
))

167 
sum
 +ð
v®
;

170  
sum
;

171 
	}
}

174 
	$nå_abm_ù¾_¡©_basic
(
nå_abm_lšk
 *
®šk
, 
bªd
,

175 
queue
, 
off
, 
u64
 *
v®
)

177 ià(!
	`nå_abm_has_´io
(
®šk
->
abm
)) {

178 ià(!
bªd
) {

179 
id
 = 
®šk
->
queue_ba£
 + 
queue
;

181 *
v®
 = 
	`Â_»adq
(
®šk
->
vnic
,

182 
	`NFP_NET_CFG_RXR_STATS
(
id
è+ 
off
);

184 *
v®
 = 0;

189  
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
q_¡©s
,

190 
NFP_Q_STAT_STRIDE
, 
off
, 
bªd
, 
queue
,

191 
Œue
, 
v®
);

193 
	}
}

195 
	$nå_abm_ù¾_»ad_q_¡©s
(
nå_abm_lšk
 *
®šk
, 
bªd
,

196 
queue
, 
nå_®šk_¡©s
 *
¡©s
)

198 
”r
;

200 
”r
 = 
	`nå_abm_ù¾_¡©_basic
(
®šk
, 
bªd
, 
queue
, 
NFP_Q_STAT_PKTS
,

201 &
¡©s
->
tx_pkts
);

202 ià(
”r
)

203  
”r
;

205 
”r
 = 
	`nå_abm_ù¾_¡©_basic
(
®šk
, 
bªd
, 
queue
, 
NFP_Q_STAT_BYTES
,

206 &
¡©s
->
tx_by‹s
);

207 ià(
”r
)

208  
”r
;

210 
”r
 = 
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
q_lvls
, 
NFP_QLVL_STRIDE
,

211 
NFP_QLVL_BLOG_BYTES
, 
bªd
, 
queue
, 
çl£
,

212 &
¡©s
->
backlog_by‹s
);

213 ià(
”r
)

214  
”r
;

216 
”r
 = 
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
q_lvls
,

217 
NFP_QLVL_STRIDE
, 
NFP_QLVL_BLOG_PKTS
,

218 
bªd
, 
queue
, 
çl£
, &
¡©s
->
backlog_pkts
);

219 ià(
”r
)

220  
”r
;

222 
”r
 = 
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
qm_¡©s
,

223 
NFP_QMSTAT_STRIDE
, 
NFP_QMSTAT_DROP
,

224 
bªd
, 
queue
, 
Œue
, &
¡©s
->
drÝs
);

225 ià(
”r
)

226  
”r
;

228  
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
qm_¡©s
,

229 
NFP_QMSTAT_STRIDE
, 
NFP_QMSTAT_ECN
,

230 
bªd
, 
queue
, 
Œue
, &
¡©s
->
ov”lim™s
);

231 
	}
}

233 
	$nå_abm_ù¾_»ad_q_x¡©s
(
nå_abm_lšk
 *
®šk
,

234 
bªd
, 
queue
,

235 
nå_®šk_x¡©s
 *
x¡©s
)

237 
”r
;

239 
”r
 = 
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
qm_¡©s
,

240 
NFP_QMSTAT_STRIDE
, 
NFP_QMSTAT_DROP
,

241 
bªd
, 
queue
, 
Œue
, &
x¡©s
->
pdrÝ
);

242 ià(
”r
)

243  
”r
;

245  
	`nå_abm_ù¾_¡©
(
®šk
,‡lšk->
abm
->
qm_¡©s
,

246 
NFP_QMSTAT_STRIDE
, 
NFP_QMSTAT_ECN
,

247 
bªd
, 
queue
, 
Œue
, &
x¡©s
->
eú_m¬ked
);

248 
	}
}

250 
	$nå_abm_ù¾_qm_’abË
(
nå_abm
 *
abm
)

252  
	`nå_mbox_cmd
(
abm
->
­p
->
pf
, 
NFP_MBOX_PCIE_ABM_ENABLE
,

253 
NULL
, 0, NULL, 0);

254 
	}
}

256 
	$nå_abm_ù¾_qm_di§bË
(
nå_abm
 *
abm
)

258  
	`nå_mbox_cmd
(
abm
->
­p
->
pf
, 
NFP_MBOX_PCIE_ABM_DISABLE
,

259 
NULL
, 0, NULL, 0);

260 
	}
}

262 
	$nå_abm_ù¾_´io_m­_upd©e
(
nå_abm_lšk
 *
®šk
, 
u32
 *
·cked
)

264 
nå_Ãt
 *
Â
 = 
®šk
->
vnic
;

265 
i
;

266 
”r
;

269 
	`Â_wr™eq
(
Â
,‚n->
Žv_ÿps
.
mbox_off
 + 
NFP_NET_ABM_MBOX_DATALEN
,

270 
®šk
->
abm
->
´io_m­_Ën
);

272 
i
 = 0; i < 
®šk
->
abm
->
´io_m­_Ën
; i +ð(
u32
))

273 
	`Â_wr™–
(
Â
,‚n->
Žv_ÿps
.
mbox_off
 + 
NFP_NET_ABM_MBOX_DATA
 + 
i
,

274 
·cked
[
i
 / (
u32
)]);

276 
”r
 = 
	`nå_Ãt_»cÚfig_mbox
(
Â
,

277 
NFP_NET_CFG_MBOX_CMD_PCI_DSCP_PRIOMAP_SET
);

278 ià(
”r
)

279 
	`nå_”r
(
®šk
->
abm
->
­p
->
ýp
,

280 "£‰šg DSCP -> VQ m­ fažed w™hƒ¼Ü %d\n", 
”r
);

281  
”r
;

282 
	}
}

284 
	$nå_abm_ù¾_´io_check_·¿ms
(
nå_abm_lšk
 *
®šk
)

286 
nå_abm
 *
abm
 = 
®šk
->abm;

287 
nå_Ãt
 *
Â
 = 
®šk
->
vnic
;

288 
mš_mbox_sz
;

290 ià(!
	`nå_abm_has_´io
(
®šk
->
abm
))

293 
mš_mbox_sz
 = 
NFP_NET_ABM_MBOX_DATA
 + 
®šk
->
abm
->
´io_m­_Ën
;

294 ià(
Â
->
Žv_ÿps
.
mbox_Ën
 < 
mš_mbox_sz
) {

295 
	`nå_”r
(
abm
->
­p
->
pf
->
ýp
, "vNIC mailboxoo small for…rio offload: %u,‚eed: %u\n",

296 
Â
->
Žv_ÿps
.
mbox_Ën
, 
mš_mbox_sz
);

297  -
EINVAL
;

301 
	}
}

303 
	$nå_abm_ù¾_»ad_·¿ms
(
nå_abm_lšk
 *
®šk
)

305 
®šk
->
queue_ba£
 = 
	`Â_»adl
×lšk->
vnic
, 
NFP_NET_CFG_START_RXQ
);

306 
®šk
->
queue_ba£
 /ð®šk->
vnic
->
¡ride_rx
;

308  
	`nå_abm_ù¾_´io_check_·¿ms
(
®šk
);

309 
	}
}

311 
	$nå_abm_ù¾_´io_m­_size
(
nå_abm
 *
abm
)

313 
size
;

315 
size
 = 
	`roundup_pow_of_two
(
	`Üd”_ba£_2
(
abm
->
num_bªds
));

316 
size
 = 
	`DIV_ROUND_UP
(siz* 
abm
->
num_´ios
, 
BITS_PER_BYTE
);

317 
size
 = 
	`round_up
(size, (
u32
));

319  
size
;

320 
	}
}

322 cÚ¡ 
nå_¹sym
 *

323 
	$nå_abm_ù¾_fšd_¹sym
(
nå_pf
 *
pf
, cÚ¡ *
Çme
, 
size
)

325 cÚ¡ 
nå_¹sym
 *
sym
;

327 
sym
 = 
	`nå_¹sym_lookup
(
pf
->
¹bl
, 
Çme
);

328 ià(!
sym
) {

329 
	`nå_”r
(
pf
->
ýp
, "SymbÞ '%s'‚Ù found\n", 
Çme
);

330  
	`ERR_PTR
(-
ENOENT
);

332 ià(
	`nå_¹sym_size
(
sym
è!ð
size
) {

333 
	`nå_”r
(
pf
->
ýp
,

335 
Çme
, 
size
, 
	`nå_¹sym_size
(
sym
));

336  
	`ERR_PTR
(-
EINVAL
);

339  
sym
;

340 
	}
}

342 cÚ¡ 
nå_¹sym
 *

343 
	$nå_abm_ù¾_fšd_q_¹sym
(
nå_abm
 *
abm
, cÚ¡ *
Çme_fmt
,

344 
size_t
 
size
)

346 
pf_symbÞ
[64];

348 
size
 = 
	`¬¿y3_size
(size, 
abm
->
num_bªds
, 
NFP_NET_MAX_RX_RINGS
);

349 
	`¢´štf
(
pf_symbÞ
, Õf_symbÞ), 
Çme_fmt
,

350 
abm
->
pf_id
, 
	`nå_abm_has_´io
(abm) ? "_per_band" : "");

352  
	`nå_abm_ù¾_fšd_¹sym
(
abm
->
­p
->
pf
, 
pf_symbÞ
, 
size
);

353 
	}
}

355 
	$nå_abm_ù¾_fšd_addrs
(
nå_abm
 *
abm
)

357 
nå_pf
 *
pf
 = 
abm
->
­p
->pf;

358 cÚ¡ 
nå_¹sym
 *
sym
;

359 
»s
;

361 
abm
->
pf_id
 = 
	`nå_ýpcÜe_pc›_un™
(
pf
->
ýp
);

364 
»s
 = 
	`nå_pf_¹sym_»ad_ÝtiÚ®
(
pf
, 
NFP_RED_SUPPORT_SYM_NAME
, 1);

365 ià(
»s
 < 0)

366  
»s
;

367 
abm
->
»d_suµÜt
 = 
»s
;

370 
»s
 = 
	`nå_pf_¹sym_»ad_ÝtiÚ®
(
pf
, 
NFP_NUM_BANDS_SYM_NAME
, 1);

371 ià(
»s
 < 0)

372  
»s
;

373 
abm
->
num_bªds
 = 
»s
;

375 
»s
 = 
	`nå_pf_¹sym_»ad_ÝtiÚ®
(
pf
, 
NFP_NUM_PRIOS_SYM_NAME
, 1);

376 ià(
»s
 < 0)

377  
»s
;

378 
abm
->
num_´ios
 = 
»s
;

381 
»s
 = 
	`nå_pf_¹sym_»ad_ÝtiÚ®
(
pf
, 
NFP_ACT_MASK_SYM_NAME
,

382 
	`BIT
(
NFP_ABM_ACT_MARK_DROP
));

383 ià(
»s
 < 0)

384  
»s
;

385 
abm
->
aùiÚ_mask
 = 
»s
;

387 
abm
->
´io_m­_Ën
 = 
	`nå_abm_ù¾_´io_m­_size
(abm);

388 
abm
->
dsý_mask
 = 
	`GENMASK
(7, 8 - 
	`Üd”_ba£_2
×bm->
num_´ios
));

391 ià(!
	`is_pow”_of_2
(
abm
->
num_bªds
è|| !is_pow”_of_2×bm->
num_´ios
) ||

392 
abm
->
num_bªds
 > 
U16_MAX
 ||‡bm->
num_´ios
 > U16_MAX ||

393 (
abm
->
num_bªds
 =ð1è!ð×bm->
num_´ios
 == 1)) {

394 
	`nå_”r
(
pf
->
ýp
,

396 
abm
->
num_bªds
,‡bm->
num_´ios
);

397  -
EINVAL
;

401 ià(!
abm
->
»d_suµÜt
)

404 
sym
 = 
	`nå_abm_ù¾_fšd_q_¹sym
(
abm
, 
NFP_QLVL_SYM_NAME
,

405 
NFP_QLVL_STRIDE
);

406 ià(
	`IS_ERR
(
sym
))

407  
	`PTR_ERR
(
sym
);

408 
abm
->
q_lvls
 = 
sym
;

410 
sym
 = 
	`nå_abm_ù¾_fšd_q_¹sym
(
abm
, 
NFP_QMSTAT_SYM_NAME
,

411 
NFP_QMSTAT_STRIDE
);

412 ià(
	`IS_ERR
(
sym
))

413  
	`PTR_ERR
(
sym
);

414 
abm
->
qm_¡©s
 = 
sym
;

416 ià(
	`nå_abm_has_´io
(
abm
)) {

417 
sym
 = 
	`nå_abm_ù¾_fšd_q_¹sym
(
abm
, 
NFP_Q_STAT_SYM_NAME
,

418 
NFP_Q_STAT_STRIDE
);

419 ià(
	`IS_ERR
(
sym
))

420  
	`PTR_ERR
(
sym
);

421 
abm
->
q_¡©s
 = 
sym
;

425 
	}
}

	@src/abm/main.c

4 
	~<lšux/b™f›ld.h
>

5 
	~<lšux/b™m­.h
>

6 
	~<lšux/‘h”deviû.h
>

7 
	~<lšux/lockd•.h
>

8 
	~<lšux/Ãtdeviû.h
>

9 
	~<lšux/rcupd©e.h
>

10 
	~<lšux/¹ÃŽšk.h
>

11 
	~<lšux/¦ab.h
>

13 
	~"../nåcÜe/nå.h
"

14 
	~"../nåcÜe/nå_ýp.h
"

15 
	~"../nåcÜe/nå_n¥.h
"

16 
	~"../nå_­p.h
"

17 
	~"../nå_maš.h
"

18 
	~"../nå_Ãt.h
"

19 
	~"../nå_Ãt_»´.h
"

20 
	~"../nå_pÜt.h
"

21 
	~"maš.h
"

23 
u32
 
	$nå_abm_pÜtid
(
nå_»´_ty³
 
¹y³
, 
id
)

25  
	`FIELD_PREP
(
NFP_ABM_PORTID_TYPE
, 
¹y³
) |

26 
	`FIELD_PREP
(
NFP_ABM_PORTID_ID
, 
id
);

27 
	}
}

30 
	$nå_abm_£tup_tc
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

31 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
)

33 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

34 
nå_pÜt
 *
pÜt
;

36 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

37 ià(!
pÜt
 ||…Üt->
ty³
 !ð
NFP_PORT_PF_PORT
)

38  -
EOPNOTSUPP
;

40 
ty³
) {

41 
TC_SETUP_ROOT_QDISC
:

42  
	`nå_abm_£tup_roÙ
(
Ãtdev
, 
»´
->
­p_´iv
, 
ty³_d©a
);

43 
TC_SETUP_QDISC_MQ
:

44  
	`nå_abm_£tup_tc_mq
(
Ãtdev
, 
»´
->
­p_´iv
, 
ty³_d©a
);

45 
TC_SETUP_QDISC_RED
:

46  
	`nå_abm_£tup_tc_»d
(
Ãtdev
, 
»´
->
­p_´iv
, 
ty³_d©a
);

47 
TC_SETUP_QDISC_GRED
:

48  
	`nå_abm_£tup_tc_g»d
(
Ãtdev
, 
»´
->
­p_´iv
, 
ty³_d©a
);

49 
TC_SETUP_BLOCK
:

50  
	`nå_abm_£tup_þs_block
(
Ãtdev
, 
»´
, 
ty³_d©a
);

52  -
EOPNOTSUPP
;

54 
	}
}

56 
Ãt_deviû
 *
	$nå_abm_»´_g‘
(
nå_­p
 *
­p
, 
u32
 
pÜt_id
)

58 
nå_»´_ty³
 
¹y³
;

59 
nå_»´s
 *
»´s
;

60 
u8
 
pÜt
;

62 
¹y³
 = 
	`FIELD_GET
(
NFP_ABM_PORTID_TYPE
, 
pÜt_id
);

63 
pÜt
 = 
	`FIELD_GET
(
NFP_ABM_PORTID_ID
, 
pÜt_id
);

65 
»´s
 = 
	`rcu_d”eã»nû
(
­p
->»´s[
¹y³
]);

66 ià(!
»´s
)

67  
NULL
;

69 ià(
pÜt
 >ð
»´s
->
num_»´s
)

70  
NULL
;

72  
	`rcu_d”eã»nû
(
»´s
->»´s[
pÜt
]);

73 
	}
}

76 
	$nå_abm_¥awn_»´
(
nå_­p
 *
­p
, 
nå_abm_lšk
 *
®šk
,

77 
nå_pÜt_ty³
 
±y³
)

79 
Ãt_deviû
 *
Ãtdev
;

80 
nå_»´_ty³
 
¹y³
;

81 
nå_»´s
 *
»´s
;

82 
nå_»´
 *
»´
;

83 
nå_pÜt
 *
pÜt
;

84 
txqs
;

85 
”r
;

87 ià(
±y³
 =ð
NFP_PORT_PHYS_PORT
) {

88 
¹y³
 = 
NFP_REPR_TYPE_PHYS_PORT
;

89 
txqs
 = 1;

91 
¹y³
 = 
NFP_REPR_TYPE_PF
;

92 
txqs
 = 
®šk
->
vnic
->
max_rx_ršgs
;

95 
Ãtdev
 = 
	`nå_»´_®loc_mqs
(
­p
, 
txqs
, 1);

96 ià(!
Ãtdev
)

97  -
ENOMEM
;

98 
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

99 
»´
->
­p_´iv
 = 
®šk
;

101 
pÜt
 = 
	`nå_pÜt_®loc
(
­p
, 
±y³
, 
Ãtdev
);

102 ià(
	`IS_ERR
(
pÜt
)) {

103 
”r
 = 
	`PTR_ERR
(
pÜt
);

104 
”r_ä“_»´
;

107 ià(
±y³
 =ð
NFP_PORT_PHYS_PORT
) {

108 
pÜt
->
‘h_fÜûd
 = 
Œue
;

109 
”r
 = 
	`nå_pÜt_š™_phy_pÜt
(
­p
->
pf
,‡µ, 
pÜt
, 
®šk
->
id
);

110 ià(
”r
)

111 
”r_ä“_pÜt
;

113 
pÜt
->
pf_id
 = 
®šk
->
abm
->pf_id;

114 
pÜt
->
pf_¥l™
 = 
­p
->
pf
->
max_d©a_vnics
 > 1;

115 
pÜt
->
pf_¥l™_id
 = 
®šk
->
id
;

116 
pÜt
->
vnic
 = 
®šk
->vnic->
dp
.
ù¾_b¬
;

119 
	`SET_NETDEV_DEV
(
Ãtdev
, &
®šk
->
vnic
->
pdev
->
dev
);

120 
	`‘h_hw_addr_¿ndom
(
Ãtdev
);

122 
”r
 = 
	`nå_»´_š™
(
­p
, 
Ãtdev
, 
	`nå_abm_pÜtid
(
¹y³
, 
®šk
->
id
),

123 
pÜt
, 
®šk
->
vnic
->
dp
.
Ãtdev
);

124 ià(
”r
)

125 
”r_ä“_pÜt
;

127 
»´s
 = 
	`nå_»´s_g‘_locked
(
­p
, 
¹y³
);

128 
	`WARN
(
	`nå_»´_g‘_locked
(
­p
, 
»´s
, 
®šk
->
id
), "duplicate„epr");

129 
	`¹Æ_lock
();

130 
	`rcu_assign_poš‹r
(
»´s
->»´s[
®šk
->
id
], 
Ãtdev
);

131 
	`¹Æ_uÆock
();

133 
	`nå_šfo
(
­p
->
ýp
, "%s Port %d Representor(%s) created\n",

134 
±y³
 =ð
NFP_PORT_PF_PORT
 ? "PCIe" : "Phys",

135 
®šk
->
id
, 
Ãtdev
->
Çme
);

139 
”r_ä“_pÜt
:

140 
	`nå_pÜt_ä“
(
pÜt
);

141 
”r_ä“_»´
:

142 
	`nå_»´_ä“
(
Ãtdev
);

143  
”r
;

144 
	}
}

147 
	$nå_abm_kžl_»´
(
nå_­p
 *
­p
, 
nå_abm_lšk
 *
®šk
,

148 
nå_»´_ty³
 
¹y³
)

150 
Ãt_deviû
 *
Ãtdev
;

151 
nå_»´s
 *
»´s
;

153 
»´s
 = 
	`nå_»´s_g‘_locked
(
­p
, 
¹y³
);

154 
Ãtdev
 = 
	`nå_»´_g‘_locked
(
­p
, 
»´s
, 
®šk
->
id
);

155 ià(!
Ãtdev
)

157 
	`¹Æ_lock
();

158 
	`rcu_assign_poš‹r
(
»´s
->»´s[
®šk
->
id
], 
NULL
);

159 
	`¹Æ_uÆock
();

160 
	`synchrÚize_rcu
();

162 
	`nå_»´_þ—n_ªd_ä“
((
nå_»´
 *)
	`Ãtdev_´iv
(
Ãtdev
));

163 
	}
}

166 
	$nå_abm_kžl_»´s
(
nå_abm
 *
abm
, 
nå_abm_lšk
 *
®šk
)

168 
	`nå_abm_kžl_»´
(
abm
->
­p
, 
®šk
, 
NFP_REPR_TYPE_PF
);

169 
	`nå_abm_kžl_»´
(
abm
->
­p
, 
®šk
, 
NFP_REPR_TYPE_PHYS_PORT
);

170 
	}
}

172 
	$nå_abm_kžl_»´s_®l
(
nå_abm
 *
abm
)

174 
nå_pf
 *
pf
 = 
abm
->
­p
->pf;

175 
nå_Ãt
 *
Â
;

177 
	`li¡_fÜ_—ch_’Œy
(
Â
, &
pf
->
vnics
, 
vnic_li¡
)

178 
	`nå_abm_kžl_»´s
(
abm
, (
nå_abm_lšk
 *)
Â
->
­p_´iv
);

179 
	}
}

181 
devlšk_esw™ch_mode
 
	$nå_abm_esw™ch_mode_g‘
(
nå_­p
 *
­p
)

183 
nå_abm
 *
abm
 = 
­p
->
´iv
;

185  
abm
->
esw™ch_mode
;

186 
	}
}

188 
	$nå_abm_esw™ch_£t_Ëgacy
(
nå_abm
 *
abm
)

190 
	`nå_abm_kžl_»´s_®l
(
abm
);

191 
	`nå_abm_ù¾_qm_di§bË
(
abm
);

193 
abm
->
esw™ch_mode
 = 
DEVLINK_ESWITCH_MODE_LEGACY
;

195 
	}
}

197 
	$nå_abm_esw™ch_þ—n_up
(
nå_abm
 *
abm
)

199 ià(
abm
->
esw™ch_mode
 !ð
DEVLINK_ESWITCH_MODE_LEGACY
)

200 
	`WARN_ON
(
	`nå_abm_esw™ch_£t_Ëgacy
(
abm
));

201 
	}
}

203 
	$nå_abm_esw™ch_£t_sw™chdev
(
nå_abm
 *
abm
)

205 
nå_­p
 *
­p
 = 
abm
->app;

206 
nå_pf
 *
pf
 = 
­p
->pf;

207 
nå_Ãt
 *
Â
;

208 
”r
;

210 ià(!
abm
->
»d_suµÜt
)

211  -
EOPNOTSUPP
;

213 
”r
 = 
	`nå_abm_ù¾_qm_’abË
(
abm
);

214 ià(
”r
)

215  
”r
;

217 
	`li¡_fÜ_—ch_’Œy
(
Â
, &
pf
->
vnics
, 
vnic_li¡
) {

218 
nå_abm_lšk
 *
®šk
 = 
Â
->
­p_´iv
;

220 
”r
 = 
	`nå_abm_¥awn_»´
(
­p
, 
®šk
, 
NFP_PORT_PHYS_PORT
);

221 ià(
”r
)

222 
”r_kžl_®l_»´s
;

224 
”r
 = 
	`nå_abm_¥awn_»´
(
­p
, 
®šk
, 
NFP_PORT_PF_PORT
);

225 ià(
”r
)

226 
”r_kžl_®l_»´s
;

229 
abm
->
esw™ch_mode
 = 
DEVLINK_ESWITCH_MODE_SWITCHDEV
;

232 
”r_kžl_®l_»´s
:

233 
	`nå_abm_kžl_»´s_®l
(
abm
);

234 
	`nå_abm_ù¾_qm_di§bË
(
abm
);

235  
”r
;

236 
	}
}

238 
	$nå_abm_esw™ch_mode_£t
(
nå_­p
 *
­p
, 
u16
 
mode
)

240 
nå_abm
 *
abm
 = 
­p
->
´iv
;

242 ià(
abm
->
esw™ch_mode
 =ð
mode
)

245 
mode
) {

246 
DEVLINK_ESWITCH_MODE_LEGACY
:

247  
	`nå_abm_esw™ch_£t_Ëgacy
(
abm
);

248 
DEVLINK_ESWITCH_MODE_SWITCHDEV
:

249  
	`nå_abm_esw™ch_£t_sw™chdev
(
abm
);

251  -
EINVAL
;

253 
	}
}

256 
	$nå_abm_vnic_£t_mac
(
nå_pf
 *
pf
, 
nå_abm
 *
abm
, 
nå_Ãt
 *
Â
,

257 
id
)

259 
nå_‘h_bË_pÜt
 *
‘h_pÜt
 = &
pf
->
‘h_tbl
->
pÜts
[
id
];

260 
u8
 
mac_addr
[
ETH_ALEN
];

261 
nå_n¥
 *
n¥
;

262 
hwšfo
[32];

263 
”r
;

265 ià(
id
 > 
pf
->
‘h_tbl
->
couÁ
) {

266 
	`nå_w¬n
(
pf
->
ýp
, "Noƒntry for…ersistent MAC‡ddress\n");

267 
	`‘h_hw_addr_¿ndom
(
Â
->
dp
.
Ãtdev
);

271 
	`¢´štf
(
hwšfo
, (hwinfo), "eth%u.mac.pf%u",

272 
‘h_pÜt
->
‘h_šdex
, 
abm
->
pf_id
);

274 
n¥
 = 
	`nå_n¥_Ý’
(
pf
->
ýp
);

275 ià(
	`IS_ERR
(
n¥
)) {

276 
	`nå_w¬n
(
pf
->
ýp
, "Failedo‡ccesshe NSP for…ersistent MAC‡ddress: %ld\n",

277 
	`PTR_ERR
(
n¥
));

278 
	`‘h_hw_addr_¿ndom
(
Â
->
dp
.
Ãtdev
);

282 ià(!
	`nå_n¥_has_hwšfo_lookup
(
n¥
)) {

283 
	`nå_w¬n
(
pf
->
ýp
, "NSP doesn't support PF MAC generation\n");

284 
	`‘h_hw_addr_¿ndom
(
Â
->
dp
.
Ãtdev
);

288 
”r
 = 
	`nå_n¥_hwšfo_lookup
(
n¥
, 
hwšfo
, (hwinfo));

289 
	`nå_n¥_þo£
(
n¥
);

290 ià(
”r
) {

291 
	`nå_w¬n
(
pf
->
ýp
, "Reading…ersistent MAC‡ddress failed: %d\n",

292 
”r
);

293 
	`‘h_hw_addr_¿ndom
(
Â
->
dp
.
Ãtdev
);

297 ià(
	`ssÿnf
(
hwšfo
, "%02hhx:%02hhx:%02hhx:%02hhx:%02hhx:%02hhx",

298 &
mac_addr
[0], &mac_addr[1], &mac_addr[2],

299 &
mac_addr
[3], &mac_addr[4], &mac_addr[5]) != 6) {

300 
	`nå_w¬n
(
pf
->
ýp
, "Can't…arse…ersistent MAC‡ddress (%s)\n",

301 
hwšfo
);

302 
	`‘h_hw_addr_¿ndom
(
Â
->
dp
.
Ãtdev
);

306 
	`‘h”_addr_cÝy
(
Â
->
dp
.
Ãtdev
->
dev_addr
, 
mac_addr
);

307 
	`‘h”_addr_cÝy
(
Â
->
dp
.
Ãtdev
->
³rm_addr
, 
mac_addr
);

308 
	}
}

311 
	$nå_abm_vnic_®loc
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
, 
id
)

313 
nå_‘h_bË_pÜt
 *
‘h_pÜt
 = &
­p
->
pf
->
‘h_tbl
->
pÜts
[
id
];

314 
nå_abm
 *
abm
 = 
­p
->
´iv
;

315 
nå_abm_lšk
 *
®šk
;

316 
”r
;

318 
®šk
 = 
	`kz®loc
((*®šk), 
GFP_KERNEL
);

319 ià(!
®šk
)

320  -
ENOMEM
;

321 
Â
->
­p_´iv
 = 
®šk
;

322 
®šk
->
abm
 =‡bm;

323 
®šk
->
vnic
 = 
Â
;

324 
®šk
->
id
 = id;

325 
®šk
->
tÙ®_queues
 =‡lšk->
vnic
->
max_rx_ršgs
;

327 
	`INIT_LIST_HEAD
(&
®šk
->
dsý_m­
);

329 
”r
 = 
	`nå_abm_ù¾_»ad_·¿ms
(
®šk
);

330 ià(
”r
)

331 
”r_ä“_®šk
;

333 
®šk
->
´io_m­
 = 
	`kz®loc
(
abm
->
´io_m­_Ën
, 
GFP_KERNEL
);

334 ià(!
®šk
->
´io_m­
)

335 
”r_ä“_®šk
;

340 
”r
 = 
	`nå_‘h_£t_cÚfigu»d
(
­p
->
ýp
, 
‘h_pÜt
->
šdex
, 
Œue
);

341 ià(
”r
 < 0)

342 
”r_ä“_´iom­
;

344 
	`Ãtif_k“p_d¡
(
Â
->
dp
.
Ãtdev
);

346 
	`nå_abm_vnic_£t_mac
(
­p
->
pf
, 
abm
, 
Â
, 
id
);

347 
	`INIT_RADIX_TREE
(&
®šk
->
qdiscs
, 
GFP_KERNEL
);

351 
”r_ä“_´iom­
:

352 
	`kä“
(
®šk
->
´io_m­
);

353 
”r_ä“_®šk
:

354 
	`kä“
(
®šk
);

355  
”r
;

356 
	}
}

358 
	$nå_abm_vnic_ä“
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

360 
nå_abm_lšk
 *
®šk
 = 
Â
->
­p_´iv
;

362 
	`nå_abm_kžl_»´s
(
®šk
->
abm
,‡link);

363 
	`WARN
(!
	`¿dix_Œ“_em±y
(&
®šk
->
qdiscs
), "left over qdiscs\n");

364 
	`kä“
(
®šk
->
´io_m­
);

365 
	`kä“
(
®šk
);

366 
	}
}

368 
	$nå_abm_vnic_š™
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

370 
nå_abm_lšk
 *
®šk
 = 
Â
->
­p_´iv
;

372 ià(
	`nå_abm_has_´io
(
®šk
->
abm
))

373  
	`nå_abm_ù¾_´io_m­_upd©e
(
®šk
,‡lšk->
´io_m­
);

375 
	}
}

377 
u64
 *

378 
	$nå_abm_pÜt_g‘_¡©s
(
nå_­p
 *
­p
, 
nå_pÜt
 *
pÜt
, 
u64
 *
d©a
)

380 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
pÜt
->
Ãtdev
);

381 
nå_abm_lšk
 *
®šk
;

382 
i
;

384 ià(
pÜt
->
ty³
 !ð
NFP_PORT_PF_PORT
)

385  
d©a
;

386 
®šk
 = 
»´
->
­p_´iv
;

387 
i
 = 0; i < 
®šk
->
vnic
->
dp
.
num_r_vecs
; i++) {

388 *
d©a
++ = 
	`nå_abm_ù¾_¡©_nÚ_¡o
(
®šk
, 
i
);

389 *
d©a
++ = 
	`nå_abm_ù¾_¡©_¡o
(
®šk
, 
i
);

391  
d©a
;

392 
	}
}

395 
	$nå_abm_pÜt_g‘_¡©s_couÁ
(
nå_­p
 *
­p
, 
nå_pÜt
 *
pÜt
)

397 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
pÜt
->
Ãtdev
);

398 
nå_abm_lšk
 *
®šk
;

400 ià(
pÜt
->
ty³
 !ð
NFP_PORT_PF_PORT
)

402 
®šk
 = 
»´
->
­p_´iv
;

403  
®šk
->
vnic
->
dp
.
num_r_vecs
 * 2;

404 
	}
}

406 
u8
 *

407 
	$nå_abm_pÜt_g‘_¡©s_¡ršgs
(
nå_­p
 *
­p
, 
nå_pÜt
 *
pÜt
,

408 
u8
 *
d©a
)

410 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
pÜt
->
Ãtdev
);

411 
nå_abm_lšk
 *
®šk
;

412 
i
;

414 ià(
pÜt
->
ty³
 !ð
NFP_PORT_PF_PORT
)

415  
d©a
;

416 
®šk
 = 
»´
->
­p_´iv
;

417 
i
 = 0; i < 
®šk
->
vnic
->
dp
.
num_r_vecs
; i++) {

418 
d©a
 = 
	`nå_´_‘
(d©a, "q%u_no_wa™", 
i
);

419 
d©a
 = 
	`nå_´_‘
(d©a, "q%u_d–ayed", 
i
);

421  
d©a
;

422 
	}
}

424 
	$nå_abm_fw_š™_»£t
(
nå_abm
 *
abm
)

426 
i
;

428 ià(!
abm
->
»d_suµÜt
)

431 
i
 = 0; i < 
abm
->
num_bªds
 * 
NFP_NET_MAX_RX_RINGS
; i++) {

432 
	`__nå_abm_ù¾_£t_q_lvl
(
abm
, 
i
, 
NFP_ABM_LVL_INFINITY
);

433 
	`__nå_abm_ù¾_£t_q_aù
(
abm
, 
i
, 
NFP_ABM_ACT_DROP
);

436  
	`nå_abm_ù¾_qm_di§bË
(
abm
);

437 
	}
}

439 
	$nå_abm_š™
(
nå_­p
 *
­p
)

441 
nå_pf
 *
pf
 = 
­p
->pf;

442 
nå_»´s
 *
»´s
;

443 
nå_abm
 *
abm
;

444 
”r
;

446 ià(!
pf
->
‘h_tbl
) {

447 
	`nå_”r
(
pf
->
ýp
, "ABM NIC„equires ETHable\n");

448  -
EINVAL
;

450 ià(
pf
->
max_d©a_vnics
 !ðpf->
‘h_tbl
->
couÁ
) {

451 
	`nå_”r
(
pf
->
ýp
, "ETHƒntries don't match vNICs (%d vs %d)\n",

452 
pf
->
max_d©a_vnics
,…f->
‘h_tbl
->
couÁ
);

453  -
EINVAL
;

455 ià(!
pf
->
mac_¡©s_b¬
) {

456 
	`nå_w¬n
(
­p
->
ýp
, "ABM NIC„equires mac_stats symbol\n");

457  -
EINVAL
;

460 
abm
 = 
	`kz®loc
((*abm), 
GFP_KERNEL
);

461 ià(!
abm
)

462  -
ENOMEM
;

463 
­p
->
´iv
 = 
abm
;

464 
abm
->
­p
 =‡pp;

466 
”r
 = 
	`nå_abm_ù¾_fšd_addrs
(
abm
);

467 ià(
”r
)

468 
”r_ä“_abm
;

470 
”r
 = -
ENOMEM
;

471 
abm
->
num_th»shÞds
 = 
	`¬¿y_size
×bm->
num_bªds
, 
NFP_NET_MAX_RX_RINGS
);

472 
abm
->
th»shÞd_undef
 = 
	`b™m­_z®loc
×bm->
num_th»shÞds
, 
GFP_KERNEL
);

473 ià(!
abm
->
th»shÞd_undef
)

474 
”r_ä“_abm
;

476 
abm
->
th»shÞds
 = 
	`kvÿÎoc
×bm->
num_th»shÞds
,

477 (*
abm
->
th»shÞds
), 
GFP_KERNEL
);

478 ià(!
abm
->
th»shÞds
)

479 
”r_ä“_th»sh_um­
;

481 
abm
->
aùiÚs
 = 
	`kvÿÎoc
×bm->
num_th»shÞds
, (*abm->actions),

482 
GFP_KERNEL
);

483 ià(!
abm
->
aùiÚs
)

484 
”r_ä“_th»sh
;

487 
”r
 = 
	`nå_abm_fw_š™_»£t
(
abm
);

488 ià(
”r
)

489 
”r_ä“_aù
;

491 
”r
 = -
ENOMEM
;

492 
»´s
 = 
	`nå_»´s_®loc
(
pf
->
max_d©a_vnics
);

493 ià(!
»´s
)

494 
”r_ä“_aù
;

495 
	`RCU_INIT_POINTER
(
­p
->
»´s
[
NFP_REPR_TYPE_PHYS_PORT
],„eprs);

497 
»´s
 = 
	`nå_»´s_®loc
(
pf
->
max_d©a_vnics
);

498 ià(!
»´s
)

499 
”r_ä“_phys
;

500 
	`RCU_INIT_POINTER
(
­p
->
»´s
[
NFP_REPR_TYPE_PF
],„eprs);

504 
”r_ä“_phys
:

505 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
);

506 
”r_ä“_aù
:

507 
	`kvä“
(
abm
->
aùiÚs
);

508 
”r_ä“_th»sh
:

509 
	`kvä“
(
abm
->
th»shÞds
);

510 
”r_ä“_th»sh_um­
:

511 
	`b™m­_ä“
(
abm
->
th»shÞd_undef
);

512 
”r_ä“_abm
:

513 
	`kä“
(
abm
);

514 
­p
->
´iv
 = 
NULL
;

515  
”r
;

516 
	}
}

518 
	$nå_abm_þ—n
(
nå_­p
 *
­p
)

520 
nå_abm
 *
abm
 = 
­p
->
´iv
;

522 
	`nå_abm_esw™ch_þ—n_up
(
abm
);

523 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_PF
);

524 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
);

525 
	`b™m­_ä“
(
abm
->
th»shÞd_undef
);

526 
	`kvä“
(
abm
->
aùiÚs
);

527 
	`kvä“
(
abm
->
th»shÞds
);

528 
	`kä“
(
abm
);

529 
­p
->
´iv
 = 
NULL
;

530 
	}
}

532 cÚ¡ 
nå_­p_ty³
 
	g­p_abm
 = {

533 .
id
 = 
NFP_APP_ACTIVE_BUFFER_MGMT_NIC
,

534 .
	gÇme
 = "abm",

536 .
	gš™
 = 
nå_abm_š™
,

537 .
	gþ—n
 = 
nå_abm_þ—n
,

539 .
	gvnic_®loc
 = 
nå_abm_vnic_®loc
,

540 .
	gvnic_ä“
 = 
nå_abm_vnic_ä“
,

541 .
	gvnic_š™
 = 
nå_abm_vnic_š™
,

543 .
	gpÜt_g‘_¡©s
 = 
nå_abm_pÜt_g‘_¡©s
,

544 .
	gpÜt_g‘_¡©s_couÁ
 = 
nå_abm_pÜt_g‘_¡©s_couÁ
,

545 .
	gpÜt_g‘_¡©s_¡ršgs
 = 
nå_abm_pÜt_g‘_¡©s_¡ršgs
,

547 .
	g£tup_tc
 = 
nå_abm_£tup_tc
,

549 .
	gesw™ch_mode_g‘
 = 
nå_abm_esw™ch_mode_g‘
,

550 .
	gesw™ch_mode_£t
 = 
nå_abm_esw™ch_mode_£t
,

552 .
	g»´_g‘
 = 
nå_abm_»´_g‘
,

	@src/abm/main.h

4 #iâdeà
__NFP_ABM_H__


5 
	#__NFP_ABM_H__
 1

	)

7 
	~<lšux/b™s.h
>

8 
	~<lšux/li¡.h
>

9 
	~<lšux/¿dix-Œ“.h
>

10 
	~<Ãt/devlšk.h
>

11 
	~<Ãt/pkt_þs.h
>

12 
	~<Ãt/pkt_sched.h
>

17 
	#NFP_ABM_STATS_REFRESH_IVAL
 (2500 * 1000è

	)

19 
	#NFP_ABM_LVL_INFINITY
 
S32_MAX


	)

21 
	gnå_­p
;

22 
	gnå_Ãt
;

24 
	#NFP_ABM_PORTID_TYPE
 
	`GENMASK
(23, 16)

	)

25 
	#NFP_ABM_PORTID_ID
 
	`GENMASK
(7, 0)

	)

28 
	enå_abm_q_aùiÚ
 {

30 
	mNFP_ABM_ACT_MARK_DROP
 = 0,

32 
	mNFP_ABM_ACT_MARK_QUEUE
 = 1,

33 
	mNFP_ABM_ACT_DROP
 = 2,

34 
	mNFP_ABM_ACT_QUEUE
 = 3,

35 
	mNFP_ABM_ACT_NOQUEUE
 = 4,

63 
	snå_abm
 {

64 
nå_­p
 *
	m­p
;

65 
	mpf_id
;

67 
	m»d_suµÜt
;

68 
	mnum_´ios
;

69 
	mnum_bªds
;

70 
	maùiÚ_mask
;

72 
u32
 *
	mth»shÞds
;

73 *
	mth»shÞd_undef
;

74 
u8
 *
	maùiÚs
;

75 
size_t
 
	mnum_th»shÞds
;

77 
	m´io_m­_Ën
;

78 
u8
 
	mdsý_mask
;

80 
devlšk_esw™ch_mode
 
	mesw™ch_mode
;

82 cÚ¡ 
nå_¹sym
 *
	mq_lvls
;

83 cÚ¡ 
nå_¹sym
 *
	mqm_¡©s
;

84 cÚ¡ 
nå_¹sym
 *
	mq_¡©s
;

96 
	snå_®šk_¡©s
 {

97 
u64
 
	mtx_pkts
;

98 
u64
 
	mtx_by‹s
;

99 
u64
 
	mbacklog_pkts
;

100 
u64
 
	mbacklog_by‹s
;

101 
u64
 
	mov”lim™s
;

102 
u64
 
	mdrÝs
;

110 
	snå_®šk_x¡©s
 {

111 
u64
 
	meú_m¬ked
;

112 
u64
 
	mpdrÝ
;

115 
	enå_qdisc_ty³
 {

116 
	mNFP_QDISC_NONE
 = 0,

117 
	mNFP_QDISC_MQ
,

118 
	mNFP_QDISC_RED
,

119 
	mNFP_QDISC_GRED
,

122 
	#NFP_QDISC_UNTRACKED
 ((
nå_qdisc
 *)1UL)

	)

152 
	snå_qdisc
 {

153 
Ãt_deviû
 *
	mÃtdev
;

154 
nå_qdisc_ty³
 
	mty³
;

155 
u32
 
	mhªdË
;

156 
u32
 
	m·»Á_hªdË
;

157 
	mu£_út
;

158 
	mnum_chžd»n
;

159 
nå_qdisc
 **
	mchžd»n
;

161 
boÞ
 
	m·¿ms_ok
;

162 
boÞ
 
	mofæßd_m¬k
;

163 
boÞ
 
	mofæßded
;

168 
nå_®šk_¡©s
 
	m¡©s
;

169 
nå_®šk_¡©s
 
	m´ev_¡©s
;

170 } 
	mmq
;

173 
	mnum_bªds
;

176 
boÞ
 
	meú
;

177 
u32
 
	mth»shÞd
;

178 
nå_®šk_¡©s
 
	m¡©s
;

179 
nå_®šk_¡©s
 
	m´ev_¡©s
;

180 
nå_®šk_x¡©s
 
	mx¡©s
;

181 
nå_®šk_x¡©s
 
	m´ev_x¡©s
;

182 } 
	mbªd
[
MAX_DPs
];

183 } 
	m»d
;

206 
	snå_abm_lšk
 {

207 
nå_abm
 *
	mabm
;

208 
nå_Ãt
 *
	mvnic
;

209 
	mid
;

210 
	mqueue_ba£
;

211 
	mtÙ®_queues
;

213 
u64
 
	mÏ¡_¡©s_upd©e
;

215 
u32
 *
	m´io_m­
;

216 
boÞ
 
	mhas_´io
;

218 
u8
 
	mdef_bªd
;

219 
li¡_h—d
 
	mdsý_m­
;

221 
nå_qdisc
 *
	mroÙ_qdisc
;

222 
¿dix_Œ“_roÙ
 
	mqdiscs
;

225 
šlše
 
boÞ
 
	$nå_abm_has_´io
(
nå_abm
 *
abm
)

227  
abm
->
num_bªds
 > 1;

228 
	}
}

230 
šlše
 
boÞ
 
	$nå_abm_has_drÝ
(
nå_abm
 *
abm
)

232  
abm
->
aùiÚ_mask
 & 
	`BIT
(
NFP_ABM_ACT_DROP
);

233 
	}
}

235 
šlše
 
boÞ
 
	$nå_abm_has_m¬k
(
nå_abm
 *
abm
)

237  
abm
->
aùiÚ_mask
 & 
	`BIT
(
NFP_ABM_ACT_MARK_DROP
);

238 
	}
}

240 
nå_abm_qdisc_ofæßd_upd©e
(
nå_abm_lšk
 *
®šk
);

241 
nå_abm_£tup_roÙ
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

242 
tc_roÙ_qÝt_ofæßd
 *
Ýt
);

243 
nå_abm_£tup_tc_»d
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

244 
tc_»d_qÝt_ofæßd
 *
Ýt
);

245 
nå_abm_£tup_tc_mq
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

246 
tc_mq_qÝt_ofæßd
 *
Ýt
);

247 
nå_abm_£tup_tc_g»d
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

248 
tc_g»d_qÝt_ofæßd
 *
Ýt
);

249 
nå_abm_£tup_þs_block
(
Ãt_deviû
 *
Ãtdev
, 
nå_»´
 *
»´
,

250 
tc_block_ofæßd
 *
Ýt
);

252 
nå_abm_ù¾_»ad_·¿ms
(
nå_abm_lšk
 *
®šk
);

253 
nå_abm_ù¾_fšd_addrs
(
nå_abm
 *
abm
);

254 
__nå_abm_ù¾_£t_q_lvl
(
nå_abm
 *
abm
, 
id
, 
u32
 
v®
);

255 
nå_abm_ù¾_£t_q_lvl
(
nå_abm_lšk
 *
®šk
, 
bªd
,

256 
queue
, 
u32
 
v®
);

257 
__nå_abm_ù¾_£t_q_aù
(
nå_abm
 *
abm
, 
id
,

258 
nå_abm_q_aùiÚ
 
aù
);

259 
nå_abm_ù¾_£t_q_aù
(
nå_abm_lšk
 *
®šk
, 
bªd
,

260 
queue
, 
nå_abm_q_aùiÚ
 
aù
);

261 
nå_abm_ù¾_»ad_q_¡©s
(
nå_abm_lšk
 *
®šk
,

262 
bªd
, 
queue
,

263 
nå_®šk_¡©s
 *
¡©s
);

264 
nå_abm_ù¾_»ad_q_x¡©s
(
nå_abm_lšk
 *
®šk
,

265 
bªd
, 
queue
,

266 
nå_®šk_x¡©s
 *
x¡©s
);

267 
u64
 
nå_abm_ù¾_¡©_nÚ_¡o
(
nå_abm_lšk
 *
®šk
, 
i
);

268 
u64
 
nå_abm_ù¾_¡©_¡o
(
nå_abm_lšk
 *
®šk
, 
i
);

269 
nå_abm_ù¾_qm_’abË
(
nå_abm
 *
abm
);

270 
nå_abm_ù¾_qm_di§bË
(
nå_abm
 *
abm
);

271 
nå_abm_´io_m­_upd©e
(
nå_abm
 *
abm
);

272 
nå_abm_ù¾_´io_m­_upd©e
(
nå_abm_lšk
 *
®šk
, 
u32
 *
·cked
);

	@src/abm/qdisc.c

4 
	~<lšux/¹ÃŽšk.h
>

5 
	~<Ãt/pkt_þs.h
>

6 
	~<Ãt/pkt_sched.h
>

7 
	~<Ãt/»d.h
>

9 
	~"../nåcÜe/nå_ýp.h
"

10 
	~"../nå_­p.h
"

11 
	~"../nå_maš.h
"

12 
	~"../nå_Ãt.h
"

13 
	~"../nå_pÜt.h
"

14 
	~"maš.h
"

16 
boÞ
 
	$nå_abm_qdisc_is_»d
(
nå_qdisc
 *
qdisc
)

18  
qdisc
->
ty³
 =ð
NFP_QDISC_RED
 || qdisc->ty³ =ð
NFP_QDISC_GRED
;

19 
	}
}

21 
boÞ
 
	$nå_abm_qdisc_chžd_v®id
(
nå_qdisc
 *
qdisc
, 
id
)

23  
qdisc
->
chžd»n
[
id
] &&

24 
qdisc
->
chžd»n
[
id
] !ð
NFP_QDISC_UNTRACKED
;

25 
	}
}

27 *
	$nå_abm_qdisc_Œ“_d”ef_¦Ù
(
__rcu
 **
¦Ù
)

29  
	`¹Æ_d”eã»nû
(*
¦Ù
);

30 
	}
}

33 
	$nå_abm_¡©s_´Ýag©e
(
nå_®šk_¡©s
 *
·»Á
,

34 
nå_®šk_¡©s
 *
chžd
)

36 
·»Á
->
tx_pkts
 +ð
chžd
->tx_pkts;

37 
·»Á
->
tx_by‹s
 +ð
chžd
->tx_bytes;

38 
·»Á
->
backlog_pkts
 +ð
chžd
->backlog_pkts;

39 
·»Á
->
backlog_by‹s
 +ð
chžd
->backlog_bytes;

40 
·»Á
->
ov”lim™s
 +ð
chžd
->overlimits;

41 
·»Á
->
drÝs
 +ð
chžd
->drops;

42 
	}
}

45 
	$nå_abm_¡©s_upd©e_»d
(
nå_abm_lšk
 *
®šk
, 
nå_qdisc
 *
qdisc
,

46 
queue
)

48 
nå_ýp
 *
ýp
 = 
®šk
->
abm
->
­p
->cpp;

49 
i
;

50 
”r
;

52 ià(!
qdisc
->
ofæßded
)

55 
i
 = 0; i < 
qdisc
->
»d
.
num_bªds
; i++) {

56 
”r
 = 
	`nå_abm_ù¾_»ad_q_¡©s
(
®šk
, 
i
, 
queue
,

57 &
qdisc
->
»d
.
bªd
[
i
].
¡©s
);

58 ià(
”r
)

59 
	`nå_”r
(
ýp
, "RED stats (%d, %d)„ead failed withƒrror %d\n",

60 
i
, 
queue
, 
”r
);

62 
”r
 = 
	`nå_abm_ù¾_»ad_q_x¡©s
(
®šk
, 
i
, 
queue
,

63 &
qdisc
->
»d
.
bªd
[
i
].
x¡©s
);

64 ià(
”r
)

65 
	`nå_”r
(
ýp
, "RED xstats (%d, %d)„ead failed withƒrror %d\n",

66 
i
, 
queue
, 
”r
);

68 
	}
}

71 
	$nå_abm_¡©s_upd©e_mq
(
nå_abm_lšk
 *
®šk
, 
nå_qdisc
 *
qdisc
)

73 
i
;

75 ià(
qdisc
->
ty³
 !ð
NFP_QDISC_MQ
)

78 
i
 = 0; i < 
®šk
->
tÙ®_queues
; i++)

79 ià(
	`nå_abm_qdisc_chžd_v®id
(
qdisc
, 
i
))

80 
	`nå_abm_¡©s_upd©e_»d
(
®šk
, 
qdisc
->
chžd»n
[
i
], i);

81 
	}
}

83 
	$__nå_abm_¡©s_upd©e
(
nå_abm_lšk
 *
®šk
, 
u64
 
time_now
)

85 
®šk
->
Ï¡_¡©s_upd©e
 = 
time_now
;

86 ià(
®šk
->
roÙ_qdisc
)

87 
	`nå_abm_¡©s_upd©e_mq
(
®šk
,‡lšk->
roÙ_qdisc
);

88 
	}
}

90 
	$nå_abm_¡©s_upd©e
(
nå_abm_lšk
 *
®šk
)

92 
u64
 
now
;

98 
now
 = 
	`ktime_g‘
();

99 ià(
now
 - 
®šk
->
Ï¡_¡©s_upd©e
 < 
NFP_ABM_STATS_REFRESH_IVAL
)

102 
	`__nå_abm_¡©s_upd©e
(
®šk
, 
now
);

103 
	}
}

106 
	$nå_abm_qdisc_uÆšk_chžd»n
(
nå_qdisc
 *
qdisc
,

107 
¡¬t
, 
’d
)

109 
i
;

111 
i
 = 
¡¬t
; i < 
’d
; i++)

112 ià(
	`nå_abm_qdisc_chžd_v®id
(
qdisc
, 
i
)) {

113 
qdisc
->
chžd»n
[
i
]->
u£_út
--;

114 
qdisc
->
chžd»n
[
i
] = 
NULL
;

116 
	}
}

119 
	$nå_abm_qdisc_ofæßd_¡Ý
(
nå_abm_lšk
 *
®šk
, 
nå_qdisc
 *
qdisc
)

121 
i
;

124 ià(
qdisc
->
u£_út
)

125 
	`nå_w¬n
(
®šk
->
abm
->
­p
->
ýp
, "Offload of '%08x' stopped\n",

126 
qdisc
->
hªdË
);

128 ià(!
	`nå_abm_qdisc_is_»d
(
qdisc
))

131 
i
 = 0; i < 
qdisc
->
»d
.
num_bªds
; i++) {

132 
qdisc
->
»d
.
bªd
[
i
].
¡©s
.
backlog_pkts
 = 0;

133 
qdisc
->
»d
.
bªd
[
i
].
¡©s
.
backlog_by‹s
 = 0;

135 
	}
}

138 
	$__nå_abm_¡©s_š™
(
nå_abm_lšk
 *
®šk
, 
bªd
,

139 
queue
, 
nå_®šk_¡©s
 *
´ev_¡©s
,

140 
nå_®šk_x¡©s
 *
´ev_x¡©s
)

142 
u64
 
backlog_pkts
, 
backlog_by‹s
;

143 
”r
;

148 
backlog_pkts
 = 
´ev_¡©s
->backlog_pkts;

149 
backlog_by‹s
 = 
´ev_¡©s
->backlog_bytes;

151 
”r
 = 
	`nå_abm_ù¾_»ad_q_¡©s
(
®šk
, 
bªd
, 
queue
, 
´ev_¡©s
);

152 ià(
”r
) {

153 
	`nå_”r
(
®šk
->
abm
->
­p
->
ýp
,

155 
bªd
, 
queue
, 
”r
);

156  
”r
;

159 
”r
 = 
	`nå_abm_ù¾_»ad_q_x¡©s
(
®šk
, 
bªd
, 
queue
, 
´ev_x¡©s
);

160 ià(
”r
) {

161 
	`nå_”r
(
®šk
->
abm
->
­p
->
ýp
,

163 
bªd
, 
queue
, 
”r
);

164  
”r
;

167 
´ev_¡©s
->
backlog_pkts
 = backlog_pkts;

168 
´ev_¡©s
->
backlog_by‹s
 = backlog_bytes;

170 
	}
}

173 
	$nå_abm_¡©s_š™
(
nå_abm_lšk
 *
®šk
, 
nå_qdisc
 *
qdisc
,

174 
queue
)

176 
i
;

177 
”r
;

179 
i
 = 0; i < 
qdisc
->
»d
.
num_bªds
; i++) {

180 
”r
 = 
	`__nå_abm_¡©s_š™
(
®šk
, 
i
, 
queue
,

181 &
qdisc
->
»d
.
bªd
[
i
].
´ev_¡©s
,

182 &
qdisc
->
»d
.
bªd
[
i
].
´ev_x¡©s
);

183 ià(
”r
)

184  
”r
;

188 
	}
}

191 
	$nå_abm_ofæßd_compže_»d
(
nå_abm_lšk
 *
®šk
, 
nå_qdisc
 *
qdisc
,

192 
queue
)

194 
boÞ
 
good_»d
, 
good_g»d
;

195 
i
;

197 
good_»d
 = 
qdisc
->
ty³
 =ð
NFP_QDISC_RED
 &&

198 
qdisc
->
·¿ms_ok
 &&

199 
qdisc
->
u£_út
 == 1 &&

200 !
®šk
->
has_´io
 &&

201 !
qdisc
->
chžd»n
[0];

202 
good_g»d
 = 
qdisc
->
ty³
 =ð
NFP_QDISC_GRED
 &&

203 
qdisc
->
·¿ms_ok
 &&

204 
qdisc
->
u£_út
 == 1;

205 
qdisc
->
ofæßd_m¬k
 = 
good_»d
 || 
good_g»d
;

208 ià(
qdisc
->
ofæßd_m¬k
 && !qdisc->
ofæßded
)

209 ià(
	`nå_abm_¡©s_š™
(
®šk
, 
qdisc
, 
queue
))

210 
qdisc
->
ofæßd_m¬k
 = 
çl£
;

212 ià(!
qdisc
->
ofæßd_m¬k
)

215 
i
 = 0; i < 
®šk
->
abm
->
num_bªds
; i++) {

216 
nå_abm_q_aùiÚ
 
aù
;

218 
	`nå_abm_ù¾_£t_q_lvl
(
®šk
, 
i
, 
queue
,

219 
qdisc
->
»d
.
bªd
[
i
].
th»shÞd
);

220 
aù
 = 
qdisc
->
»d
.
bªd
[
i
].
eú
 ?

221 
NFP_ABM_ACT_MARK_DROP
 : 
NFP_ABM_ACT_DROP
;

222 
	`nå_abm_ù¾_£t_q_aù
(
®šk
, 
i
, 
queue
, 
aù
);

224 
	}
}

227 
	$nå_abm_ofæßd_compže_mq
(
nå_abm_lšk
 *
®šk
, 
nå_qdisc
 *
qdisc
)

229 
i
;

231 
qdisc
->
ofæßd_m¬k
 = qdisc->
ty³
 =ð
NFP_QDISC_MQ
;

232 ià(!
qdisc
->
ofæßd_m¬k
)

235 
i
 = 0; i < 
®šk
->
tÙ®_queues
; i++) {

236 
nå_qdisc
 *
chžd
 = 
qdisc
->
chžd»n
[
i
];

238 ià(!
	`nå_abm_qdisc_chžd_v®id
(
qdisc
, 
i
))

241 
	`nå_abm_ofæßd_compže_»d
(
®šk
, 
chžd
, 
i
);

243 
	}
}

245 
	$nå_abm_qdisc_ofæßd_upd©e
(
nå_abm_lšk
 *
®šk
)

247 
nå_abm
 *
abm
 = 
®šk
->abm;

248 
¿dix_Œ“_™”
 
™”
;

249 
nå_qdisc
 *
qdisc
;

250 
__rcu
 **
¦Ù
;

251 
size_t
 
i
;

254 
i
 = 0; i < 
abm
->
num_bªds
; i++)

255 
	`__b™m­_£t
(
abm
->
th»shÞd_undef
,

256 
i
 * 
NFP_NET_MAX_RX_RINGS
 + 
®šk
->
queue_ba£
,

257 
®šk
->
tÙ®_queues
);

260 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
®šk
->
qdiscs
, &
™”
, 0) {

261 
qdisc
 = 
	`nå_abm_qdisc_Œ“_d”ef_¦Ù
(
¦Ù
);

262 
qdisc
->
ofæßd_m¬k
 = 
çl£
;

265 ià(
®šk
->
roÙ_qdisc
)

266 
	`nå_abm_ofæßd_compže_mq
(
®šk
,‡lšk->
roÙ_qdisc
);

269 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
®šk
->
qdiscs
, &
™”
, 0) {

270 
qdisc
 = 
	`nå_abm_qdisc_Œ“_d”ef_¦Ù
(
¦Ù
);

271 ià(!
qdisc
->
ofæßd_m¬k
 && qdisc->
ofæßded
)

272 
	`nå_abm_qdisc_ofæßd_¡Ý
(
®šk
, 
qdisc
);

273 
qdisc
->
ofæßded
 = qdisc->
ofæßd_m¬k
;

277 
i
 = 0; i < 
abm
->
num_th»shÞds
; i++)

278 ià(
	`‹¡_b™
(
i
, 
abm
->
th»shÞd_undef
))

279 
	`__nå_abm_ù¾_£t_q_lvl
(
abm
, 
i
, 
NFP_ABM_LVL_INFINITY
);

281 
	`__nå_abm_¡©s_upd©e
(
®šk
, 
	`ktime_g‘
());

282 
	}
}

285 
	$nå_abm_qdisc_þ—r_mq
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

286 
nå_qdisc
 *
qdisc
)

288 
¿dix_Œ“_™”
 
™”
;

289 
mq_»fs
 = 0;

290 
__rcu
 **
¦Ù
;

292 ià(!
qdisc
->
u£_út
)

297 ià(
qdisc
->
ty³
 =ð
NFP_QDISC_MQ
 &&

298 
qdisc
 =ð
®šk
->
roÙ_qdisc
 &&

299 
Ãtdev
->
»g_¡©e
 =ð
NETREG_UNREGISTERING
)

303 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
®šk
->
qdiscs
, &
™”
, 0) {

304 
nå_qdisc
 *
mq
 = 
	`nå_abm_qdisc_Œ“_d”ef_¦Ù
(
¦Ù
);

305 
i
;

307 ià(
mq
->
ty³
 !ð
NFP_QDISC_MQ
 || mq->
Ãtdev
 !=‚etdev)

309 
i
 = 0; i < 
mq
->
num_chžd»n
; i++)

310 ià(
mq
->
chžd»n
[
i
] =ð
qdisc
) {

311 
mq
->
chžd»n
[
i
] = 
NULL
;

312 
mq_»fs
++;

316 
	`WARN
(
qdisc
->
u£_út
 !ð
mq_»fs
, "non-zero qdisc use count: %d (- %d)\n",

317 
qdisc
->
u£_út
, 
mq_»fs
);

318 
	}
}

321 
	$nå_abm_qdisc_ä“
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

322 
nå_qdisc
 *
qdisc
)

324 
nå_pÜt
 *
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

326 ià(!
qdisc
)

328 
	`nå_abm_qdisc_þ—r_mq
(
Ãtdev
, 
®šk
, 
qdisc
);

329 
	`WARN_ON
(
	`¿dix_Œ“_d–‘e
(&
®šk
->
qdiscs
,

330 
	`TC_H_MAJ
(
qdisc
->
hªdË
)) != qdisc);

332 
	`kä“
(
qdisc
->
chžd»n
);

333 
	`kä“
(
qdisc
);

335 
pÜt
->
tc_ofæßd_út
--;

336 
	}
}

338 
nå_qdisc
 *

339 
	$nå_abm_qdisc_®loc
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

340 
nå_qdisc_ty³
 
ty³
, 
u32
 
·»Á_hªdË
, u32 
hªdË
,

341 
chžd»n
)

343 
nå_pÜt
 *
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

344 
nå_qdisc
 *
qdisc
;

345 
”r
;

347 
qdisc
 = 
	`kz®loc
((*qdisc), 
GFP_KERNEL
);

348 ià(!
qdisc
)

349  
NULL
;

351 ià(
chžd»n
) {

352 
qdisc
->
chžd»n
 = 
	`kÿÎoc
(chžd»n, (*), 
GFP_KERNEL
);

353 ià(!
qdisc
->
chžd»n
)

354 
”r_ä“_qdisc
;

357 
qdisc
->
Ãtdev
 =‚etdev;

358 
qdisc
->
ty³
 =ype;

359 
qdisc
->
·»Á_hªdË
 =…arent_handle;

360 
qdisc
->
hªdË
 = handle;

361 
qdisc
->
num_chžd»n
 = 
chžd»n
;

363 
”r
 = 
	`¿dix_Œ“_š£¹
(&
®šk
->
qdiscs
, 
	`TC_H_MAJ
(
qdisc
->
hªdË
), qdisc);

364 ià(
”r
) {

365 
	`nå_”r
(
®šk
->
abm
->
­p
->
ýp
,

366 "Qdisøš£¹iÚ iÁØ¿dix»çžed: %d\n", 
”r
);

367 
”r_ä“_chžd_tbl
;

370 
pÜt
->
tc_ofæßd_út
++;

371  
qdisc
;

373 
”r_ä“_chžd_tbl
:

374 
	`kä“
(
qdisc
->
chžd»n
);

375 
”r_ä“_qdisc
:

376 
	`kä“
(
qdisc
);

377  
NULL
;

378 
	}
}

380 
nå_qdisc
 *

381 
	$nå_abm_qdisc_fšd
(
nå_abm_lšk
 *
®šk
, 
u32
 
hªdË
)

383  
	`¿dix_Œ“_lookup
(&
®šk
->
qdiscs
, 
	`TC_H_MAJ
(
hªdË
));

384 
	}
}

387 
	$nå_abm_qdisc_»¶aû
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

388 
nå_qdisc_ty³
 
ty³
, 
u32
 
·»Á_hªdË
, u32 
hªdË
,

389 
chžd»n
, 
nå_qdisc
 **
qdisc
)

391 *
qdisc
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
hªdË
);

392 ià(*
qdisc
) {

393 ià(
	`WARN_ON
((*
qdisc
)->
ty³
 !=ype))

394  -
EINVAL
;

398 *
qdisc
 = 
	`nå_abm_qdisc_®loc
(
Ãtdev
, 
®šk
, 
ty³
, 
·»Á_hªdË
, 
hªdË
,

399 
chžd»n
);

400  *
qdisc
 ? 0 : -
ENOMEM
;

401 
	}
}

404 
	$nå_abm_qdisc_de¡roy
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

405 
u32
 
hªdË
)

407 
nå_qdisc
 *
qdisc
;

409 
qdisc
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
hªdË
);

410 ià(!
qdisc
)

414 ià(
®šk
->
roÙ_qdisc
 =ð
qdisc
)

415 
qdisc
->
u£_út
--;

417 
	`nå_abm_qdisc_uÆšk_chžd»n
(
qdisc
, 0, qdisc->
num_chžd»n
);

418 
	`nå_abm_qdisc_ä“
(
Ãtdev
, 
®šk
, 
qdisc
);

420 ià(
®šk
->
roÙ_qdisc
 =ð
qdisc
) {

421 
®šk
->
roÙ_qdisc
 = 
NULL
;

425 
	`nå_abm_qdisc_ofæßd_upd©e
(
®šk
);

427 
	}
}

430 
	$nå_abm_qdisc_g¿á
(
nå_abm_lšk
 *
®šk
, 
u32
 
hªdË
, u32 
chžd_hªdË
,

431 
id
)

433 
nå_qdisc
 *
·»Á
, *
chžd
;

435 
·»Á
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
hªdË
);

436 ià(!
·»Á
)

439 ià(
	`WARN
(
id
 >ð
·»Á
->
num_chžd»n
,

441 
id
, 
·»Á
->
num_chžd»n
))

442  -
EINVAL
;

444 
	`nå_abm_qdisc_uÆšk_chžd»n
(
·»Á
, 
id
, id + 1);

446 
chžd
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
chžd_hªdË
);

447 ià(
chžd
)

448 
chžd
->
u£_út
++;

450 
chžd
 = 
NFP_QDISC_UNTRACKED
;

451 
·»Á
->
chžd»n
[
id
] = 
chžd
;

453 
	`nå_abm_qdisc_ofæßd_upd©e
(
®šk
);

456 
	}
}

459 
	$nå_abm_¡©s_ÿlcuÏ‹
(
nå_®šk_¡©s
 *
Ãw
,

460 
nå_®šk_¡©s
 *
Þd
,

461 
gÃt_¡©s_basic_·cked
 *
b¡©s
,

462 
gÃt_¡©s_queue
 *
q¡©s
)

464 
	`_b¡©s_upd©e
(
b¡©s
, 
Ãw
->
tx_by‹s
 - 
Þd
->tx_bytes,

465 
Ãw
->
tx_pkts
 - 
Þd
->tx_pkts);

466 
q¡©s
->
qËn
 +ð
Ãw
->
backlog_pkts
 - 
Þd
->backlog_pkts;

467 
q¡©s
->
backlog
 +ð
Ãw
->
backlog_by‹s
 - 
Þd
->backlog_bytes;

468 
q¡©s
->
ov”lim™s
 +ð
Ãw
->ov”lim™ - 
Þd
->overlimits;

469 
q¡©s
->
drÝs
 +ð
Ãw
->drÝ - 
Þd
->drops;

470 
	}
}

473 
	$nå_abm_¡©s_»d_ÿlcuÏ‹
(
nå_®šk_x¡©s
 *
Ãw
,

474 
nå_®šk_x¡©s
 *
Þd
,

475 
»d_¡©s
 *
¡©s
)

477 
¡©s
->
fÜûd_m¬k
 +ð
Ãw
->
eú_m¬ked
 - 
Þd
->ecn_marked;

478 
¡©s
->
pdrÝ
 +ð
Ãw
->pdrÝ - 
Þd
->pdrop;

479 
	}
}

482 
	$nå_abm_g»d_¡©s
(
nå_abm_lšk
 *
®šk
, 
u32
 
hªdË
,

483 
tc_g»d_qÝt_ofæßd_¡©s
 *
¡©s
)

485 
nå_qdisc
 *
qdisc
;

486 
i
;

488 
	`nå_abm_¡©s_upd©e
(
®šk
);

490 
qdisc
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
hªdË
);

491 ià(!
qdisc
)

492  -
EOPNOTSUPP
;

497 
i
 = 0; i < 
qdisc
->
»d
.
num_bªds
; i++) {

498 ià(!
¡©s
->
x¡©s
[
i
])

501 
	`nå_abm_¡©s_ÿlcuÏ‹
(&
qdisc
->
»d
.
bªd
[
i
].
¡©s
,

502 &
qdisc
->
»d
.
bªd
[
i
].
´ev_¡©s
,

503 &
¡©s
->
b¡©s
[
i
], &¡©s->
q¡©s
[i]);

504 
qdisc
->
»d
.
bªd
[
i
].
´ev_¡©s
 = qdisc->»d.bªd[i].
¡©s
;

506 
	`nå_abm_¡©s_»d_ÿlcuÏ‹
(&
qdisc
->
»d
.
bªd
[
i
].
x¡©s
,

507 &
qdisc
->
»d
.
bªd
[
i
].
´ev_x¡©s
,

508 
¡©s
->
x¡©s
[
i
]);

509 
qdisc
->
»d
.
bªd
[
i
].
´ev_x¡©s
 = qdisc->»d.bªd[i].
x¡©s
;

512  
qdisc
->
ofæßded
 ? 0 : -
EOPNOTSUPP
;

513 
	}
}

515 
boÞ


516 
	$nå_abm_g»d_check_·¿ms
(
nå_abm_lšk
 *
®šk
,

517 
tc_g»d_qÝt_ofæßd
 *
Ýt
)

519 
nå_ýp
 *
ýp
 = 
®šk
->
abm
->
­p
->cpp;

520 
nå_abm
 *
abm
 = 
®šk
->abm;

521 
i
;

523 ià(
Ýt
->
£t
.
grio_Ú
 || o±->£t.
w»d_Ú
) {

524 
	`nå_w¬n
(
ýp
, "GRED offload failed - GRIO‡nd WRED‚ot supported (p:%08x h:%08x)\n",

525 
Ýt
->
·»Á
, o±->
hªdË
);

526  
çl£
;

528 ià(
Ýt
->
£t
.
dp_def
 !ð
®šk
->
def_bªd
) {

529 
	`nå_w¬n
(
ýp
, "GRED offload failed - default band must be %d (p:%08x h:%08x)\n",

530 
®šk
->
def_bªd
, 
Ýt
->
·»Á
, o±->
hªdË
);

531  
çl£
;

533 ià(
Ýt
->
£t
.
dp_út
 !ð
abm
->
num_bªds
) {

534 
	`nå_w¬n
(
ýp
, "GRED offload failed - band count must be %d (p:%08x h:%08x)\n",

535 
abm
->
num_bªds
, 
Ýt
->
·»Á
, o±->
hªdË
);

536  
çl£
;

539 
i
 = 0; i < 
abm
->
num_bªds
; i++) {

540 
tc_g»d_vq_qÝt_ofæßd_·¿ms
 *
bªd
 = &
Ýt
->
£t
.
b
[
i
];

542 ià(!
bªd
->
´e£Á
)

543  
çl£
;

544 ià(!
bªd
->
is_eú
 && !
	`nå_abm_has_drÝ
(
abm
)) {

545 
	`nå_w¬n
(
ýp
, "GRED offload failed - drop is‚ot supported (ECN option„equired) (p:%08x h:%08x vq:%d)\n",

546 
Ýt
->
·»Á
, o±->
hªdË
, 
i
);

547  
çl£
;

549 ià(
bªd
->
is_eú
 && !
	`nå_abm_has_m¬k
(
abm
)) {

550 
	`nå_w¬n
(
ýp
, "GRED offload failed - ECN marking‚ot supported (p:%08x h:%08x vq:%d)\n",

551 
Ýt
->
·»Á
, o±->
hªdË
, 
i
);

552  
çl£
;

554 ià(
bªd
->
is_h¬ddrÝ
) {

555 
	`nå_w¬n
(
ýp
, "GRED offload failed - harddrop is‚ot supported (p:%08x h:%08x vq:%d)\n",

556 
Ýt
->
·»Á
, o±->
hªdË
, 
i
);

557  
çl£
;

559 ià(
bªd
->
mš
 !ðbªd->
max
) {

560 
	`nå_w¬n
(
ýp
, "GRED offload failed -hreshold mismatch (p:%08x h:%08x vq:%d)\n",

561 
Ýt
->
·»Á
, o±->
hªdË
, 
i
);

562  
çl£
;

564 ià(
bªd
->
mš
 > 
S32_MAX
) {

565 
	`nå_w¬n
(
ýp
, "GRED offload failed -hresholdoo†arge %d > %d (p:%08x h:%08x vq:%d)\n",

566 
bªd
->
mš
, 
S32_MAX
, 
Ýt
->
·»Á
, o±->
hªdË
,

567 
i
);

568  
çl£
;

572  
Œue
;

573 
	}
}

576 
	$nå_abm_g»d_»¶aû
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

577 
tc_g»d_qÝt_ofæßd
 *
Ýt
)

579 
nå_qdisc
 *
qdisc
;

580 
i
;

581 
»t
;

583 
»t
 = 
	`nå_abm_qdisc_»¶aû
(
Ãtdev
, 
®šk
, 
NFP_QDISC_GRED
, 
Ýt
->
·»Á
,

584 
Ýt
->
hªdË
, 0, &
qdisc
);

585 ià(
»t
 < 0)

586  
»t
;

588 
qdisc
->
·¿ms_ok
 = 
	`nå_abm_g»d_check_·¿ms
(
®šk
, 
Ýt
);

589 ià(
qdisc
->
·¿ms_ok
) {

590 
qdisc
->
»d
.
num_bªds
 = 
Ýt
->
£t
.
dp_út
;

591 
i
 = 0; i < 
qdisc
->
»d
.
num_bªds
; i++) {

592 
qdisc
->
»d
.
bªd
[
i
].
eú
 = 
Ýt
->
£t
.
b
[i].
is_eú
;

593 
qdisc
->
»d
.
bªd
[
i
].
th»shÞd
 = 
Ýt
->
£t
.
b
[i].
mš
;

597 ià(
qdisc
->
u£_út
)

598 
	`nå_abm_qdisc_ofæßd_upd©e
(
®šk
);

601 
	}
}

603 
	$nå_abm_£tup_tc_g»d
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

604 
tc_g»d_qÝt_ofæßd
 *
Ýt
)

606 
Ýt
->
commªd
) {

607 
TC_GRED_REPLACE
:

608  
	`nå_abm_g»d_»¶aû
(
Ãtdev
, 
®šk
, 
Ýt
);

609 
TC_GRED_DESTROY
:

610 
	`nå_abm_qdisc_de¡roy
(
Ãtdev
, 
®šk
, 
Ýt
->
hªdË
);

612 
TC_GRED_STATS
:

613  
	`nå_abm_g»d_¡©s
(
®šk
, 
Ýt
->
hªdË
, &Ýt->
¡©s
);

615  -
EOPNOTSUPP
;

617 
	}
}

620 
	$nå_abm_»d_x¡©s
(
nå_abm_lšk
 *
®šk
, 
tc_»d_qÝt_ofæßd
 *
Ýt
)

622 
nå_qdisc
 *
qdisc
;

624 
	`nå_abm_¡©s_upd©e
(
®šk
);

626 
qdisc
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
Ýt
->
hªdË
);

627 ià(!
qdisc
 || !qdisc->
ofæßded
)

628  -
EOPNOTSUPP
;

630 
	`nå_abm_¡©s_»d_ÿlcuÏ‹
(&
qdisc
->
»d
.
bªd
[0].
x¡©s
,

631 &
qdisc
->
»d
.
bªd
[0].
´ev_x¡©s
,

632 
Ýt
->
x¡©s
);

633 
qdisc
->
»d
.
bªd
[0].
´ev_x¡©s
 = qdisc->»d.bªd[0].
x¡©s
;

635 
	}
}

638 
	$nå_abm_»d_¡©s
(
nå_abm_lšk
 *
®šk
, 
u32
 
hªdË
,

639 
tc_qÝt_ofæßd_¡©s
 *
¡©s
)

641 
nå_qdisc
 *
qdisc
;

643 
	`nå_abm_¡©s_upd©e
(
®šk
);

645 
qdisc
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
hªdË
);

646 ià(!
qdisc
)

647  -
EOPNOTSUPP
;

652 
	`nå_abm_¡©s_ÿlcuÏ‹
(&
qdisc
->
»d
.
bªd
[0].
¡©s
,

653 &
qdisc
->
»d
.
bªd
[0].
´ev_¡©s
,

654 
¡©s
->
b¡©s
, sts->
q¡©s
);

655 
qdisc
->
»d
.
bªd
[0].
´ev_¡©s
 = qdisc->»d.bªd[0].
¡©s
;

657  
qdisc
->
ofæßded
 ? 0 : -
EOPNOTSUPP
;

658 
	}
}

660 
boÞ


661 
	$nå_abm_»d_check_·¿ms
(
nå_abm_lšk
 *
®šk
,

662 
tc_»d_qÝt_ofæßd
 *
Ýt
)

664 
nå_ýp
 *
ýp
 = 
®šk
->
abm
->
­p
->cpp;

665 
nå_abm
 *
abm
 = 
®šk
->abm;

667 ià(!
Ýt
->
£t
.
is_eú
 && !
	`nå_abm_has_drÝ
(
abm
)) {

668 
	`nå_w¬n
(
ýp
, "RED offload failed - drop is‚ot supported (ECN option„equired) (p:%08x h:%08x)\n",

669 
Ýt
->
·»Á
, o±->
hªdË
);

670  
çl£
;

672 ià(
Ýt
->
£t
.
is_eú
 && !
	`nå_abm_has_m¬k
(
abm
)) {

673 
	`nå_w¬n
(
ýp
, "RED offload failed - ECN marking‚ot supported (p:%08x h:%08x)\n",

674 
Ýt
->
·»Á
, o±->
hªdË
);

675  
çl£
;

677 ià(
Ýt
->
£t
.
is_h¬ddrÝ
) {

678 
	`nå_w¬n
(
ýp
, "RED offload failed - harddrop is‚ot supported (p:%08x h:%08x)\n",

679 
Ýt
->
·»Á
, o±->
hªdË
);

680  
çl£
;

682 ià(
Ýt
->
£t
.
mš
 !ðÝt->£t.
max
) {

683 
	`nå_w¬n
(
ýp
, "RED offload failed - unsupported min/max…arameters (p:%08x h:%08x)\n",

684 
Ýt
->
·»Á
, o±->
hªdË
);

685  
çl£
;

687 ià(
Ýt
->
£t
.
mš
 > 
NFP_ABM_LVL_INFINITY
) {

688 
	`nå_w¬n
(
ýp
, "RED offload failed -hresholdoo†arge %d > %d (p:%08x h:%08x)\n",

689 
Ýt
->
£t
.
mš
, 
NFP_ABM_LVL_INFINITY
, o±->
·»Á
,

690 
Ýt
->
hªdË
);

691  
çl£
;

694  
Œue
;

695 
	}
}

698 
	$nå_abm_»d_»¶aû
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

699 
tc_»d_qÝt_ofæßd
 *
Ýt
)

701 
nå_qdisc
 *
qdisc
;

702 
»t
;

704 
»t
 = 
	`nå_abm_qdisc_»¶aû
(
Ãtdev
, 
®šk
, 
NFP_QDISC_RED
, 
Ýt
->
·»Á
,

705 
Ýt
->
hªdË
, 1, &
qdisc
);

706 ià(
»t
 < 0)

707  
»t
;

710 ià(
Ýt
->
£t
.
lim™
) {

711 ià(
	`nå_abm_qdisc_chžd_v®id
(
qdisc
, 0))

712 
qdisc
->
chžd»n
[0]->
u£_út
--;

713 
qdisc
->
chžd»n
[0] = 
NULL
;

718 ià(!
»t
)

719 
qdisc
->
chžd»n
[0] = 
NFP_QDISC_UNTRACKED
;

722 
qdisc
->
·¿ms_ok
 = 
	`nå_abm_»d_check_·¿ms
(
®šk
, 
Ýt
);

723 ià(
qdisc
->
·¿ms_ok
) {

724 
qdisc
->
»d
.
num_bªds
 = 1;

725 
qdisc
->
»d
.
bªd
[0].
eú
 = 
Ýt
->
£t
.
is_eú
;

726 
qdisc
->
»d
.
bªd
[0].
th»shÞd
 = 
Ýt
->
£t
.
mš
;

729 ià(
qdisc
->
u£_út
 == 1)

730 
	`nå_abm_qdisc_ofæßd_upd©e
(
®šk
);

733 
	}
}

735 
	$nå_abm_£tup_tc_»d
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

736 
tc_»d_qÝt_ofæßd
 *
Ýt
)

738 
Ýt
->
commªd
) {

739 
TC_RED_REPLACE
:

740  
	`nå_abm_»d_»¶aû
(
Ãtdev
, 
®šk
, 
Ýt
);

741 
TC_RED_DESTROY
:

742 
	`nå_abm_qdisc_de¡roy
(
Ãtdev
, 
®šk
, 
Ýt
->
hªdË
);

744 
TC_RED_STATS
:

745  
	`nå_abm_»d_¡©s
(
®šk
, 
Ýt
->
hªdË
, &Ýt->
¡©s
);

746 
TC_RED_XSTATS
:

747  
	`nå_abm_»d_x¡©s
(
®šk
, 
Ýt
);

748 
TC_RED_GRAFT
:

749  
	`nå_abm_qdisc_g¿á
(
®šk
, 
Ýt
->
hªdË
,

750 
Ýt
->
chžd_hªdË
, 0);

752  -
EOPNOTSUPP
;

754 
	}
}

757 
	$nå_abm_mq_ü—‹
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

758 
tc_mq_qÝt_ofæßd
 *
Ýt
)

760 
nå_qdisc
 *
qdisc
;

761 
»t
;

763 
»t
 = 
	`nå_abm_qdisc_»¶aû
(
Ãtdev
, 
®šk
, 
NFP_QDISC_MQ
,

764 
TC_H_ROOT
, 
Ýt
->
hªdË
, 
®šk
->
tÙ®_queues
,

765 &
qdisc
);

766 ià(
»t
 < 0)

767  
»t
;

769 
qdisc
->
·¿ms_ok
 = 
Œue
;

770 
qdisc
->
ofæßded
 = 
Œue
;

771 
	`nå_abm_qdisc_ofæßd_upd©e
(
®šk
);

773 
	}
}

776 
	$nå_abm_mq_¡©s
(
nå_abm_lšk
 *
®šk
, 
u32
 
hªdË
,

777 
tc_qÝt_ofæßd_¡©s
 *
¡©s
)

779 
nå_qdisc
 *
qdisc
, *
»d
;

780 
i
, 
j
;

782 
qdisc
 = 
	`nå_abm_qdisc_fšd
(
®šk
, 
hªdË
);

783 ià(!
qdisc
)

784  -
EOPNOTSUPP
;

786 
	`nå_abm_¡©s_upd©e
(
®šk
);

791 
	`mem£t
(&
qdisc
->
mq
.
¡©s
, 0, (qdisc->mq.stats));

792 
	`mem£t
(&
qdisc
->
mq
.
´ev_¡©s
, 0, (qdisc->mq.prev_stats));

794 
i
 = 0; i < 
qdisc
->
num_chžd»n
; i++) {

795 ià(!
	`nå_abm_qdisc_chžd_v®id
(
qdisc
, 
i
))

798 ià(!
	`nå_abm_qdisc_is_»d
(
qdisc
->
chžd»n
[
i
]))

800 
»d
 = 
qdisc
->
chžd»n
[
i
];

802 
j
 = 0; j < 
»d
->»d.
num_bªds
; j++) {

803 
	`nå_abm_¡©s_´Ýag©e
(&
qdisc
->
mq
.
¡©s
,

804 &
»d
->»d.
bªd
[
j
].
¡©s
);

805 
	`nå_abm_¡©s_´Ýag©e
(&
qdisc
->
mq
.
´ev_¡©s
,

806 &
»d
->»d.
bªd
[
j
].
´ev_¡©s
);

810 
	`nå_abm_¡©s_ÿlcuÏ‹
(&
qdisc
->
mq
.
¡©s
, &qdisc->mq.
´ev_¡©s
,

811 
¡©s
->
b¡©s
, sts->
q¡©s
);

813  
qdisc
->
ofæßded
 ? 0 : -
EOPNOTSUPP
;

814 
	}
}

816 
	$nå_abm_£tup_tc_mq
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

817 
tc_mq_qÝt_ofæßd
 *
Ýt
)

819 
Ýt
->
commªd
) {

820 
TC_MQ_CREATE
:

821  
	`nå_abm_mq_ü—‹
(
Ãtdev
, 
®šk
, 
Ýt
);

822 
TC_MQ_DESTROY
:

823 
	`nå_abm_qdisc_de¡roy
(
Ãtdev
, 
®šk
, 
Ýt
->
hªdË
);

825 
TC_MQ_STATS
:

826  
	`nå_abm_mq_¡©s
(
®šk
, 
Ýt
->
hªdË
, &Ýt->
¡©s
);

827 
TC_MQ_GRAFT
:

828  
	`nå_abm_qdisc_g¿á
(
®šk
, 
Ýt
->
hªdË
,

829 
Ýt
->
g¿á_·¿ms
.
chžd_hªdË
,

830 
Ýt
->
g¿á_·¿ms
.
queue
);

832  -
EOPNOTSUPP
;

834 
	}
}

836 
	$nå_abm_£tup_roÙ
(
Ãt_deviû
 *
Ãtdev
, 
nå_abm_lšk
 *
®šk
,

837 
tc_roÙ_qÝt_ofæßd
 *
Ýt
)

839 ià(
Ýt
->
šg»ss
)

840  -
EOPNOTSUPP
;

841 ià(
®šk
->
roÙ_qdisc
)

842 
®šk
->
roÙ_qdisc
->
u£_út
--;

843 
®šk
->
roÙ_qdisc
 = 
	`nå_abm_qdisc_fšd
×lšk, 
Ýt
->
hªdË
);

844 ià(
®šk
->
roÙ_qdisc
)

845 
®šk
->
roÙ_qdisc
->
u£_út
++;

847 
	`nå_abm_qdisc_ofæßd_upd©e
(
®šk
);

850 
	}
}

	@src/bpf/cmsg.c

4 
	~<lšux/bpf.h
>

5 
	~<lšux/b™Ýs.h
>

6 
	~<lšux/bug.h
>

7 
	~<lšux/jiff›s.h
>

8 
	~<lšux/skbuff.h
>

9 
	~<lšux/wa™.h
>

11 
	~"../nå_­p.h
"

12 
	~"../nå_Ãt.h
"

13 
	~"fw.h
"

14 
	~"maš.h
"

16 
	#NFP_BPF_TAG_ALLOC_SPAN
 (
U16_MAX
 / 4)

	)

18 
boÞ
 
	$nå_bpf_®l_gs_busy
(
nå_­p_bpf
 *
bpf
)

20 
u16
 
u£d_gs
;

22 
u£d_gs
 = 
bpf
->
g_®loc_Ãxt
 - bpf->
g_®loc_Ï¡
;

24  
u£d_gs
 > 
NFP_BPF_TAG_ALLOC_SPAN
;

25 
	}
}

27 
	$nå_bpf_®loc_g
(
nå_­p_bpf
 *
bpf
)

33 ià(
	`nå_bpf_®l_gs_busy
(
bpf
)) {

34 
	`cmsg_w¬n
(
bpf
, "all FW„equest contexts busy!\n");

35  -
EAGAIN
;

38 
	`WARN_ON
(
	`__‹¡_ªd_£t_b™
(
bpf
->
g_®loc_Ãxt
, bpf->
g_®loÿtÜ
));

39  
bpf
->
g_®loc_Ãxt
++;

40 
	}
}

42 
	$nå_bpf_ä“_g
(
nå_­p_bpf
 *
bpf
, 
u16
 
g
)

44 
	`WARN_ON
(!
	`__‹¡_ªd_þ—r_b™
(
g
, 
bpf
->
g_®loÿtÜ
));

46 !
	`‹¡_b™
(
bpf
->
g_®loc_Ï¡
, bpf->
g_®loÿtÜ
) &&

47 
bpf
->
g_®loc_Ï¡
 !ðbpf->
g_®loc_Ãxt
)

48 
bpf
->
g_®loc_Ï¡
++;

49 
	}
}

51 
sk_buff
 *

52 
	$nå_bpf_cmsg_®loc
(
nå_­p_bpf
 *
bpf
, 
size
)

54 
sk_buff
 *
skb
;

56 
skb
 = 
	`nå_­p_ù¾_msg_®loc
(
bpf
->
­p
, 
size
, 
GFP_KERNEL
);

57 
	`skb_put
(
skb
, 
size
);

59  
skb
;

60 
	}
}

63 
	$nå_bpf_cmsg_m­_»q_size
(
nå_­p_bpf
 *
bpf
, 
n
)

65 
size
;

67 
size
 = (
cmsg_»q_m­_Ý
);

68 
size
 +ð(
bpf
->
cmsg_key_sz
 + bpf->
cmsg_v®_sz
è* 
n
;

70  
size
;

71 
	}
}

73 
sk_buff
 *

74 
	$nå_bpf_cmsg_m­_»q_®loc
(
nå_­p_bpf
 *
bpf
, 
n
)

76  
	`nå_bpf_cmsg_®loc
(
bpf
, 
	`nå_bpf_cmsg_m­_»q_size
(bpf, 
n
));

77 
	}
}

80 
	$nå_bpf_cmsg_m­_»¶y_size
(
nå_­p_bpf
 *
bpf
, 
n
)

82 
size
;

84 
size
 = (
cmsg_»¶y_m­_Ý
);

85 
size
 +ð(
bpf
->
cmsg_key_sz
 + bpf->
cmsg_v®_sz
è* 
n
;

87  
size
;

88 
	}
}

90 
u8
 
	$nå_bpf_cmsg_g‘_ty³
(
sk_buff
 *
skb
)

92 
cmsg_hdr
 *
hdr
;

94 
hdr
 = (
cmsg_hdr
 *)
skb
->
d©a
;

96  
hdr
->
ty³
;

97 
	}
}

99 
	$nå_bpf_cmsg_g‘_g
(
sk_buff
 *
skb
)

101 
cmsg_hdr
 *
hdr
;

103 
hdr
 = (
cmsg_hdr
 *)
skb
->
d©a
;

105  
	`be16_to_ýu
(
hdr
->
g
);

106 
	}
}

108 
sk_buff
 *
	$__nå_bpf_»¶y
(
nå_­p_bpf
 *
bpf
, 
u16
 
g
)

110 
msg_g
;

111 
sk_buff
 *
skb
;

113 
	`skb_queue_w®k
(&
bpf
->
cmsg_»¶›s
, 
skb
) {

114 
msg_g
 = 
	`nå_bpf_cmsg_g‘_g
(
skb
);

115 ià(
msg_g
 =ð
g
) {

116 
	`nå_bpf_ä“_g
(
bpf
, 
g
);

117 
	`__skb_uÆšk
(
skb
, &
bpf
->
cmsg_»¶›s
);

118  
skb
;

122  
NULL
;

123 
	}
}

125 
sk_buff
 *
	$nå_bpf_»¶y
(
nå_­p_bpf
 *
bpf
, 
u16
 
g
)

127 
sk_buff
 *
skb
;

129 
	`nå_ù¾_lock
(
bpf
->
­p
->
ù¾
);

130 
skb
 = 
	`__nå_bpf_»¶y
(
bpf
, 
g
);

131 
	`nå_ù¾_uÆock
(
bpf
->
­p
->
ù¾
);

133  
skb
;

134 
	}
}

136 
sk_buff
 *
	$nå_bpf_»¶y_drÝ_g
(
nå_­p_bpf
 *
bpf
, 
u16
 
g
)

138 
sk_buff
 *
skb
;

140 
	`nå_ù¾_lock
(
bpf
->
­p
->
ù¾
);

141 
skb
 = 
	`__nå_bpf_»¶y
(
bpf
, 
g
);

142 ià(!
skb
)

143 
	`nå_bpf_ä“_g
(
bpf
, 
g
);

144 
	`nå_ù¾_uÆock
(
bpf
->
­p
->
ù¾
);

146  
skb
;

147 
	}
}

149 
sk_buff
 *

150 
	$nå_bpf_cmsg_wa™_»¶y
(
nå_­p_bpf
 *
bpf
, 
nå_bpf_cmsg_ty³
 
ty³
,

151 
g
)

153 
sk_buff
 *
skb
;

154 
i
, 
”r
;

156 
i
 = 0; i < 50; i++) {

157 
	`ud–ay
(4);

158 
skb
 = 
	`nå_bpf_»¶y
(
bpf
, 
g
);

159 ià(
skb
)

160  
skb
;

163 
”r
 = 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
bpf
->
cmsg_wq
,

164 
skb
 = 
	`nå_bpf_»¶y
(
bpf
, 
g
),

165 
	`m£cs_to_jiff›s
(5000));

169 ià(!
skb
)

170 
skb
 = 
	`nå_bpf_»¶y_drÝ_g
(
bpf
, 
g
);

171 ià(
”r
 < 0) {

172 
	`cmsg_w¬n
(
bpf
, "%s waiting for„esponseo 0x%02x: %d\n",

173 
”r
 =ð
ERESTARTSYS
 ? "interrupted" : "error",

174 
ty³
, 
”r
);

175  
	`ERR_PTR
(
”r
);

177 ià(!
skb
) {

178 
	`cmsg_w¬n
(
bpf
, "timeout waiting for„esponseo 0x%02x\n",

179 
ty³
);

180  
	`ERR_PTR
(-
ETIMEDOUT
);

183  
skb
;

184 
	}
}

186 
sk_buff
 *

187 
	$nå_bpf_cmsg_communiÿ‹
(
nå_­p_bpf
 *
bpf
, 
sk_buff
 *
skb
,

188 
nå_bpf_cmsg_ty³
 
ty³
, 
»¶y_size
)

190 
cmsg_hdr
 *
hdr
;

191 
g
;

193 
	`nå_ù¾_lock
(
bpf
->
­p
->
ù¾
);

194 
g
 = 
	`nå_bpf_®loc_g
(
bpf
);

195 ià(
g
 < 0) {

196 
	`nå_ù¾_uÆock
(
bpf
->
­p
->
ù¾
);

197 
	`dev_kä“_skb_ªy
(
skb
);

198  
	`ERR_PTR
(
g
);

201 
hdr
 = (*)
skb
->
d©a
;

202 
hdr
->
v”
 = 
CMSG_MAP_ABI_VERSION
;

203 
hdr
->
ty³
 =ype;

204 
hdr
->
g
 = 
	`ýu_to_be16
(tag);

206 
	`__nå_­p_ù¾_tx
(
bpf
->
­p
, 
skb
);

208 
	`nå_ù¾_uÆock
(
bpf
->
­p
->
ù¾
);

210 
skb
 = 
	`nå_bpf_cmsg_wa™_»¶y
(
bpf
, 
ty³
, 
g
);

211 ià(
	`IS_ERR
(
skb
))

212  
skb
;

214 
hdr
 = (
cmsg_hdr
 *)
skb
->
d©a
;

215 ià(
hdr
->
ty³
 !ð
	`__CMSG_REPLY
(type)) {

216 
	`cmsg_w¬n
(
bpf
, "cmsg drop - wrongype 0x%02x != 0x%02lx!\n",

217 
hdr
->
ty³
, 
	`__CMSG_REPLY
(type));

218 
”r_ä“
;

221 ià(
»¶y_size
 && 
skb
->
Ën
 !=„eply_size) {

222 
	`cmsg_w¬n
(
bpf
, "cmsg drop -ype 0x%02x wrong size %d != %d!\n",

223 
ty³
, 
skb
->
Ën
, 
»¶y_size
);

224 
”r_ä“
;

227  
skb
;

228 
”r_ä“
:

229 
	`dev_kä“_skb_ªy
(
skb
);

230  
	`ERR_PTR
(-
EIO
);

231 
	}
}

234 
	$nå_bpf_ù¾_rc_to_”ºo
(
nå_­p_bpf
 *
bpf
,

235 
cmsg_»¶y_m­_sim¶e
 *
»¶y
)

237 cÚ¡ 
»s_bË
[] = {

238 [
CMSG_RC_SUCCESS
] = 0,

239 [
CMSG_RC_ERR_MAP_FD
] = -
EBADFD
,

240 [
CMSG_RC_ERR_MAP_NOENT
] = -
ENOENT
,

241 [
CMSG_RC_ERR_MAP_ERR
] = -
EINVAL
,

242 [
CMSG_RC_ERR_MAP_PARSE
] = -
EIO
,

243 [
CMSG_RC_ERR_MAP_EXIST
] = -
EEXIST
,

244 [
CMSG_RC_ERR_MAP_NOMEM
] = -
ENOMEM
,

245 [
CMSG_RC_ERR_MAP_E2BIG
] = -
E2BIG
,

247 
u32
 
rc
;

249 
rc
 = 
	`be32_to_ýu
(
»¶y
->rc);

250 ià(
rc
 >ð
	`ARRAY_SIZE
(
»s_bË
)) {

251 
	`cmsg_w¬n
(
bpf
, "FW„e¥Úded w™h inv®id stus: %u\n", 
rc
);

252  -
EIO
;

255  
»s_bË
[
rc
];

256 
	}
}

259 
	$nå_bpf_ù¾_®loc_m­
(
nå_­p_bpf
 *
bpf
, 
bpf_m­
 *
m­
)

261 
cmsg_»¶y_m­_®loc_tbl
 *
»¶y
;

262 
cmsg_»q_m­_®loc_tbl
 *
»q
;

263 
sk_buff
 *
skb
;

264 
u32
 
tid
;

265 
”r
;

267 
skb
 = 
	`nå_bpf_cmsg_®loc
(
bpf
, (*
»q
));

268 ià(!
skb
)

269  -
ENOMEM
;

271 
»q
 = (*)
skb
->
d©a
;

272 
»q
->
key_size
 = 
	`ýu_to_be32
(
m­
->key_size);

273 
»q
->
v®ue_size
 = 
	`ýu_to_be32
(
m­
->value_size);

274 
»q
->
max_’Œ›s
 = 
	`ýu_to_be32
(
m­
->max_entries);

275 
»q
->
m­_ty³
 = 
	`ýu_to_be32
(
m­
->map_type);

276 
»q
->
m­_æags
 = 0;

278 
skb
 = 
	`nå_bpf_cmsg_communiÿ‹
(
bpf
, skb, 
CMSG_TYPE_MAP_ALLOC
,

279 (*
»¶y
));

280 ià(
	`IS_ERR
(
skb
))

281  
	`PTR_ERR
(
skb
);

283 
»¶y
 = (*)
skb
->
d©a
;

284 
”r
 = 
	`nå_bpf_ù¾_rc_to_”ºo
(
bpf
, &
»¶y
->
»¶y_hdr
);

285 ià(
”r
)

286 
”r_ä“
;

288 
tid
 = 
	`be32_to_ýu
(
»¶y
->tid);

289 
	`dev_cÚsume_skb_ªy
(
skb
);

291  
tid
;

292 
”r_ä“
:

293 
	`dev_kä“_skb_ªy
(
skb
);

294  
”r
;

295 
	}
}

297 
	$nå_bpf_ù¾_ä“_m­
(
nå_­p_bpf
 *
bpf
, 
nå_bpf_m­
 *
nå_m­
)

299 
cmsg_»¶y_m­_ä“_tbl
 *
»¶y
;

300 
cmsg_»q_m­_ä“_tbl
 *
»q
;

301 
sk_buff
 *
skb
;

302 
”r
;

304 
skb
 = 
	`nå_bpf_cmsg_®loc
(
bpf
, (*
»q
));

305 ià(!
skb
) {

306 
	`cmsg_w¬n
(
bpf
, "leaking map - failedo‡llocate msg\n");

310 
»q
 = (*)
skb
->
d©a
;

311 
»q
->
tid
 = 
	`ýu_to_be32
(
nå_m­
->tid);

313 
skb
 = 
	`nå_bpf_cmsg_communiÿ‹
(
bpf
, skb, 
CMSG_TYPE_MAP_FREE
,

314 (*
»¶y
));

315 ià(
	`IS_ERR
(
skb
)) {

316 
	`cmsg_w¬n
(
bpf
, "leaking map - I/Oƒrror\n");

320 
»¶y
 = (*)
skb
->
d©a
;

321 
”r
 = 
	`nå_bpf_ù¾_rc_to_”ºo
(
bpf
, &
»¶y
->
»¶y_hdr
);

322 ià(
”r
)

323 
	`cmsg_w¬n
(
bpf
, "Ëakšg m­ - FW„e¥Úded w™h: %d\n", 
”r
);

325 
	`dev_cÚsume_skb_ªy
(
skb
);

326 
	}
}

329 
	$nå_bpf_ù¾_»q_key
(
nå_­p_bpf
 *
bpf
, 
cmsg_»q_m­_Ý
 *
»q
,

330 
n
)

332  &
»q
->
d©a
[
bpf
->
cmsg_key_sz
 * 
n
 + bpf->
cmsg_v®_sz
 *‚];

333 
	}
}

336 
	$nå_bpf_ù¾_»q_v®
(
nå_­p_bpf
 *
bpf
, 
cmsg_»q_m­_Ý
 *
»q
,

337 
n
)

339  &
»q
->
d©a
[
bpf
->
cmsg_key_sz
 * (
n
 + 1è+ bpf->
cmsg_v®_sz
 *‚];

340 
	}
}

343 
	$nå_bpf_ù¾_»¶y_key
(
nå_­p_bpf
 *
bpf
, 
cmsg_»¶y_m­_Ý
 *
»¶y
,

344 
n
)

346  &
»¶y
->
d©a
[
bpf
->
cmsg_key_sz
 * 
n
 + bpf->
cmsg_v®_sz
 *‚];

347 
	}
}

350 
	$nå_bpf_ù¾_»¶y_v®
(
nå_­p_bpf
 *
bpf
, 
cmsg_»¶y_m­_Ý
 *
»¶y
,

351 
n
)

353  &
»¶y
->
d©a
[
bpf
->
cmsg_key_sz
 * (
n
 + 1è+ bpf->
cmsg_v®_sz
 *‚];

354 
	}
}

357 
	$nå_bpf_ù¾_’Œy_Ý
(
bpf_ofæßded_m­
 *
offm­
,

358 
nå_bpf_cmsg_ty³
 
Ý
,

359 
u8
 *
key
, u8 *
v®ue
, 
u64
 
æags
, u8 *
out_key
, u8 *
out_v®ue
)

361 
nå_bpf_m­
 *
nå_m­
 = 
offm­
->
dev_´iv
;

362 
nå_­p_bpf
 *
bpf
 = 
nå_m­
->bpf;

363 
bpf_m­
 *
m­
 = &
offm­
->map;

364 
cmsg_»¶y_m­_Ý
 *
»¶y
;

365 
cmsg_»q_m­_Ý
 *
»q
;

366 
sk_buff
 *
skb
;

367 
”r
;

370 ià(
æags
 >> 32)

371  -
EOPNOTSUPP
;

373 
skb
 = 
	`nå_bpf_cmsg_m­_»q_®loc
(
bpf
, 1);

374 ià(!
skb
)

375  -
ENOMEM
;

377 
»q
 = (*)
skb
->
d©a
;

378 
»q
->
tid
 = 
	`ýu_to_be32
(
nå_m­
->tid);

379 
»q
->
couÁ
 = 
	`ýu_to_be32
(1);

380 
»q
->
æags
 = 
	`ýu_to_be32
(flags);

383 ià(
key
)

384 
	`memýy
(
	`nå_bpf_ù¾_»q_key
(
bpf
, 
»q
, 0), 
key
, 
m­
->
key_size
);

385 ià(
v®ue
)

386 
	`memýy
(
	`nå_bpf_ù¾_»q_v®
(
bpf
, 
»q
, 0), 
v®ue
,

387 
m­
->
v®ue_size
);

389 
skb
 = 
	`nå_bpf_cmsg_communiÿ‹
(
bpf
, skb, 
Ý
,

390 
	`nå_bpf_cmsg_m­_»¶y_size
(
bpf
, 1));

391 ià(
	`IS_ERR
(
skb
))

392  
	`PTR_ERR
(
skb
);

394 
»¶y
 = (*)
skb
->
d©a
;

395 
”r
 = 
	`nå_bpf_ù¾_rc_to_”ºo
(
bpf
, &
»¶y
->
»¶y_hdr
);

396 ià(
”r
)

397 
”r_ä“
;

400 ià(
out_key
)

401 
	`memýy
(
out_key
, 
	`nå_bpf_ù¾_»¶y_key
(
bpf
, 
»¶y
, 0),

402 
m­
->
key_size
);

403 ià(
out_v®ue
)

404 
	`memýy
(
out_v®ue
, 
	`nå_bpf_ù¾_»¶y_v®
(
bpf
, 
»¶y
, 0),

405 
m­
->
v®ue_size
);

407 
	`dev_cÚsume_skb_ªy
(
skb
);

410 
”r_ä“
:

411 
	`dev_kä“_skb_ªy
(
skb
);

412  
”r
;

413 
	}
}

415 
	$nå_bpf_ù¾_upd©e_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

416 *
key
, *
v®ue
, 
u64
 
æags
)

418  
	`nå_bpf_ù¾_’Œy_Ý
(
offm­
, 
CMSG_TYPE_MAP_UPDATE
,

419 
key
, 
v®ue
, 
æags
, 
NULL
, NULL);

420 
	}
}

422 
	$nå_bpf_ù¾_d–_’Œy
(
bpf_ofæßded_m­
 *
offm­
, *
key
)

424  
	`nå_bpf_ù¾_’Œy_Ý
(
offm­
, 
CMSG_TYPE_MAP_DELETE
,

425 
key
, 
NULL
, 0, NULL, NULL);

426 
	}
}

428 
	$nå_bpf_ù¾_lookup_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

429 *
key
, *
v®ue
)

431  
	`nå_bpf_ù¾_’Œy_Ý
(
offm­
, 
CMSG_TYPE_MAP_LOOKUP
,

432 
key
, 
NULL
, 0, NULL, 
v®ue
);

433 
	}
}

435 
	$nå_bpf_ù¾_g‘fœ¡_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

436 *
Ãxt_key
)

438  
	`nå_bpf_ù¾_’Œy_Ý
(
offm­
, 
CMSG_TYPE_MAP_GETFIRST
,

439 
NULL
, NULL, 0, 
Ãxt_key
, NULL);

440 
	}
}

442 
	$nå_bpf_ù¾_g‘Ãxt_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

443 *
key
, *
Ãxt_key
)

445  
	`nå_bpf_ù¾_’Œy_Ý
(
offm­
, 
CMSG_TYPE_MAP_GETNEXT
,

446 
key
, 
NULL
, 0, 
Ãxt_key
, NULL);

447 
	}
}

449 
	$nå_bpf_ù¾_cmsg_mtu
(
nå_­p_bpf
 *
bpf
)

451  
	`max3
(()
NFP_NET_DEFAULT_MTU
,

452 
	`nå_bpf_cmsg_m­_»q_size
(
bpf
, 1),

453 
	`nå_bpf_cmsg_m­_»¶y_size
(
bpf
, 1));

454 
	}
}

456 
	$nå_bpf_ù¾_msg_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

458 
nå_­p_bpf
 *
bpf
 = 
­p
->
´iv
;

459 
g
;

461 ià(
	`uÆik–y
(
skb
->
Ën
 < (
cmsg_»¶y_m­_sim¶e
))) {

462 
	`cmsg_w¬n
(
bpf
, "cmsg drÝ -oØshÜˆ%d!\n", 
skb
->
Ën
);

463 
”r_ä“
;

466 ià(
	`nå_bpf_cmsg_g‘_ty³
(
skb
è=ð
CMSG_TYPE_BPF_EVENT
) {

467 ià(!
	`nå_bpf_ev’t_ouut
(
bpf
, 
skb
->
d©a
, skb->
Ën
))

468 
	`dev_cÚsume_skb_ªy
(
skb
);

470 
	`dev_kä“_skb_ªy
(
skb
);

474 
	`nå_ù¾_lock
(
bpf
->
­p
->
ù¾
);

476 
g
 = 
	`nå_bpf_cmsg_g‘_g
(
skb
);

477 ià(
	`uÆik–y
(!
	`‹¡_b™
(
g
, 
bpf
->
g_®loÿtÜ
))) {

478 
	`cmsg_w¬n
(
bpf
, "cmsg drop -‚o one is waiting forag %u!\n",

479 
g
);

480 
”r_uÆock
;

483 
	`__skb_queue_ž
(&
bpf
->
cmsg_»¶›s
, 
skb
);

484 
	`wake_up_š‹¼u±ibË_®l
(&
bpf
->
cmsg_wq
);

486 
	`nå_ù¾_uÆock
(
bpf
->
­p
->
ù¾
);

489 
”r_uÆock
:

490 
	`nå_ù¾_uÆock
(
bpf
->
­p
->
ù¾
);

491 
”r_ä“
:

492 
	`dev_kä“_skb_ªy
(
skb
);

493 
	}
}

496 
	$nå_bpf_ù¾_msg_rx_¿w
(
nå_­p
 *
­p
, cÚ¡ *
d©a
, 
Ën
)

498 
nå_­p_bpf
 *
bpf
 = 
­p
->
´iv
;

499 cÚ¡ 
cmsg_hdr
 *
hdr
 = 
d©a
;

501 ià(
	`uÆik–y
(
Ën
 < (
cmsg_»¶y_m­_sim¶e
))) {

502 
	`cmsg_w¬n
(
bpf
, "cmsg drÝ -oØshÜˆ%d!\n", 
Ën
);

506 ià(
hdr
->
ty³
 =ð
CMSG_TYPE_BPF_EVENT
)

507 
	`nå_bpf_ev’t_ouut
(
bpf
, 
d©a
, 
Ën
);

509 
	`cmsg_w¬n
(
bpf
, "cmsg drop - msgype %d with„aw buffer!\n",

510 
hdr
->
ty³
);

511 
	}
}

	@src/bpf/fw.h

4 #iâdeà
NFP_BPF_FW_H


5 
	#NFP_BPF_FW_H
 1

	)

7 
	~<lšux/b™Ýs.h
>

8 
	~<lšux/ty³s.h
>

13 
	#NFP_BPF_SCALAR_VALUE
 1

	)

14 
	#NFP_BPF_MAP_VALUE
 4

	)

15 
	#NFP_BPF_STACK
 6

	)

16 
	#NFP_BPF_PACKET_DATA
 8

	)

18 
	ebpf_ÿp_Žv_ty³
 {

19 
	mNFP_BPF_CAP_TYPE_FUNC
 = 1,

20 
	mNFP_BPF_CAP_TYPE_ADJUST_HEAD
 = 2,

21 
	mNFP_BPF_CAP_TYPE_MAPS
 = 3,

22 
	mNFP_BPF_CAP_TYPE_RANDOM
 = 4,

23 
	mNFP_BPF_CAP_TYPE_QUEUE_SELECT
 = 5,

24 
	mNFP_BPF_CAP_TYPE_ADJUST_TAIL
 = 6,

25 
	mNFP_BPF_CAP_TYPE_ABI_VERSION
 = 7,

28 
	snå_bpf_ÿp_Žv_func
 {

29 
__Ë32
 
	mfunc_id
;

30 
__Ë32
 
	mfunc_addr
;

33 
	snå_bpf_ÿp_Žv_adju¡_h—d
 {

34 
__Ë32
 
	mæags
;

35 
__Ë32
 
	moff_mš
;

36 
__Ë32
 
	moff_max
;

37 
__Ë32
 
	mgu¬ª‹ed_sub
;

38 
__Ë32
 
	mgu¬ª‹ed_add
;

41 
	#NFP_BPF_ADJUST_HEAD_NO_META
 
	`BIT
(0)

	)

43 
	snå_bpf_ÿp_Žv_m­s
 {

44 
__Ë32
 
	mty³s
;

45 
__Ë32
 
	mmax_m­s
;

46 
__Ë32
 
	mmax_–ems
;

47 
__Ë32
 
	mmax_key_sz
;

48 
__Ë32
 
	mmax_v®_sz
;

49 
__Ë32
 
	mmax_–em_sz
;

55 
	#CMSG_MAP_ABI_VERSION
 1

	)

57 
	enå_bpf_cmsg_ty³
 {

58 
	mCMSG_TYPE_MAP_ALLOC
 = 1,

59 
	mCMSG_TYPE_MAP_FREE
 = 2,

60 
	mCMSG_TYPE_MAP_LOOKUP
 = 3,

61 
	mCMSG_TYPE_MAP_UPDATE
 = 4,

62 
	mCMSG_TYPE_MAP_DELETE
 = 5,

63 
	mCMSG_TYPE_MAP_GETNEXT
 = 6,

64 
	mCMSG_TYPE_MAP_GETFIRST
 = 7,

65 
	mCMSG_TYPE_BPF_EVENT
 = 8,

66 
	m__CMSG_TYPE_MAP_MAX
,

69 
	#CMSG_TYPE_MAP_REPLY_BIT
 7

	)

70 
	#__CMSG_REPLY
(
»q
è(
	`BIT
(
CMSG_TYPE_MAP_REPLY_BIT
è| (»q))

	)

73 
	#CMSG_MAP_KEY_LW
 16

	)

74 
	#CMSG_MAP_VALUE_LW
 16

	)

76 
	enå_bpf_cmsg_¡©us
 {

77 
	mCMSG_RC_SUCCESS
 = 0,

78 
	mCMSG_RC_ERR_MAP_FD
 = 1,

79 
	mCMSG_RC_ERR_MAP_NOENT
 = 2,

80 
	mCMSG_RC_ERR_MAP_ERR
 = 3,

81 
	mCMSG_RC_ERR_MAP_PARSE
 = 4,

82 
	mCMSG_RC_ERR_MAP_EXIST
 = 5,

83 
	mCMSG_RC_ERR_MAP_NOMEM
 = 6,

84 
	mCMSG_RC_ERR_MAP_E2BIG
 = 7,

87 
	scmsg_hdr
 {

88 
u8
 
	mty³
;

89 
u8
 
	mv”
;

90 
__be16
 
	mg
;

93 
	scmsg_»¶y_m­_sim¶e
 {

94 
cmsg_hdr
 
	mhdr
;

95 
__be32
 
	mrc
;

98 
	scmsg_»q_m­_®loc_tbl
 {

99 
cmsg_hdr
 
	mhdr
;

100 
__be32
 
	mkey_size
;

101 
__be32
 
	mv®ue_size
;

102 
__be32
 
	mmax_’Œ›s
;

103 
__be32
 
	mm­_ty³
;

104 
__be32
 
	mm­_æags
;

107 
	scmsg_»¶y_m­_®loc_tbl
 {

108 
cmsg_»¶y_m­_sim¶e
 
	m»¶y_hdr
;

109 
__be32
 
	mtid
;

112 
	scmsg_»q_m­_ä“_tbl
 {

113 
cmsg_hdr
 
	mhdr
;

114 
__be32
 
	mtid
;

117 
	scmsg_»¶y_m­_ä“_tbl
 {

118 
cmsg_»¶y_m­_sim¶e
 
	m»¶y_hdr
;

119 
__be32
 
	mcouÁ
;

122 
	scmsg_»q_m­_Ý
 {

123 
cmsg_hdr
 
	mhdr
;

124 
__be32
 
	mtid
;

125 
__be32
 
	mcouÁ
;

126 
__be32
 
	mæags
;

127 
u8
 
	md©a
[0];

130 
	scmsg_»¶y_m­_Ý
 {

131 
cmsg_»¶y_m­_sim¶e
 
	m»¶y_hdr
;

132 
__be32
 
	mcouÁ
;

133 
__be32
 
	m»sv
;

134 
u8
 
	md©a
[0];

137 
	scmsg_bpf_ev’t
 {

138 
cmsg_hdr
 
	mhdr
;

139 
__be32
 
	mýu_id
;

140 
__be64
 
	mm­_±r
;

141 
__be32
 
	md©a_size
;

142 
__be32
 
	mpkt_size
;

143 
u8
 
	md©a
[0];

	@src/bpf/jit.c

4 
	#´_fmt
(
fmt
è"NFP‚‘ bpf: " 
	)
fmt

6 
	~"../nåcÜe/kcom·t.h
"

8 
	~<lšux/bug.h
>

9 
	~<lšux/bpf.h
>

10 
	~<lšux/fž‹r.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/pkt_þs.h
>

13 
	~<lšux/»croÿl_div.h
>

14 
	~<lšux/uni¡d.h
>

16 
	~"maš.h
"

17 
	~"../nå_asm.h
"

18 
	~"../nå_Ãt_ù¾.h
"

24 
	#nå_fÜ_—ch_š¢_w®k2
(
nå_´og
, 
pos
, 
Ãxt
) \

25 
pos
 = 
	`li¡_fœ¡_’Œy
(&(
nå_´og
)->
š¢s
, 
	`ty³of
(*pos), 
l
), \

26 
Ãxt
 = 
	`li¡_Ãxt_’Œy
(
pos
, 
l
); \

27 &(
nå_´og
)->
š¢s
 !ð&
pos
->
l
 && \

28 &(
nå_´og
)->
š¢s
 !ð&
Ãxt
->
l
; \

29 
pos
 = 
	`nå_m‘a_Ãxt
(pos), \

30 
Ãxt
 = 
	`nå_m‘a_Ãxt
(
pos
))

	)

32 
	#nå_fÜ_—ch_š¢_w®k3
(
nå_´og
, 
pos
, 
Ãxt
, 
Ãxt2
) \

33 
pos
 = 
	`li¡_fœ¡_’Œy
(&(
nå_´og
)->
š¢s
, 
	`ty³of
(*pos), 
l
), \

34 
Ãxt
 = 
	`li¡_Ãxt_’Œy
(
pos
, 
l
), \

35 
Ãxt2
 = 
	`li¡_Ãxt_’Œy
(
Ãxt
, 
l
); \

36 &(
nå_´og
)->
š¢s
 !ð&
pos
->
l
 && \

37 &(
nå_´og
)->
š¢s
 !ð&
Ãxt
->
l
 && \

38 &(
nå_´og
)->
š¢s
 !ð&
Ãxt2
->
l
; \

39 
pos
 = 
	`nå_m‘a_Ãxt
(pos), \

40 
Ãxt
 = 
	`nå_m‘a_Ãxt
(
pos
), \

41 
Ãxt2
 = 
	`nå_m‘a_Ãxt
(
Ãxt
))

	)

43 
boÞ


44 
	$nå_m‘a_has_´ev
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

46  
m‘a
->
l
.
´ev
 !ð&
nå_´og
->
š¢s
;

47 
	}
}

49 
	$nå_´og_push
(
nå_´og
 *nå_´og, 
u64
 
š¢
)

51 ià(
nå_´og
->
__´og_®loc_Ën
 / (
u64
è=ðnå_´og->
´og_Ën
) {

52 
	`´_w¬n
("instruction†imit„eached (%u NFP instructions)\n",

53 
nå_´og
->
´og_Ën
);

54 
nå_´og
->
”rÜ
 = -
ENOSPC
;

58 
nå_´og
->
´og
[nå_´og->
´og_Ën
] = 
š¢
;

59 
nå_´og
->
´og_Ën
++;

60 
	}
}

62 
	$nå_´og_cu¼’t_off£t
(
nå_´og
 *nfp_prog)

64  
nå_´og
->
´og_Ën
;

65 
	}
}

67 
boÞ


68 
	$nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
 *nå_´og, 
off
)

74 ià(
nå_´og
->
”rÜ
)

75  
Œue
;

76  !
	`WARN_ON_ONCE
(
	`nå_´og_cu¼’t_off£t
(
nå_´og
è!ð
off
);

77 
	}
}

81 
	$__em™_cmd
(
nå_´og
 *nå_´og, 
cmd_tgt_m­
 
Ý
,

82 
u8
 
mode
, u8 
xãr
, u8 
¬eg
, u8 
b»g
, u8 
size
, 
cmd_ùx_sw­
 
ùx
,

83 
boÞ
 
šdœ
)

85 
u64
 
š¢
;

87 
š¢
 = 
	`FIELD_PREP
(
OP_CMD_A_SRC
, 
¬eg
) |

88 
	`FIELD_PREP
(
OP_CMD_CTX
, 
ùx
) |

89 
	`FIELD_PREP
(
OP_CMD_B_SRC
, 
b»g
) |

90 
	`FIELD_PREP
(
OP_CMD_TOKEN
, 
cmd_tgt_aù
[
Ý
].
tok’
) |

91 
	`FIELD_PREP
(
OP_CMD_XFER
, 
xãr
) |

92 
	`FIELD_PREP
(
OP_CMD_CNT
, 
size
) |

93 
	`FIELD_PREP
(
OP_CMD_SIG
, 
ùx
 !ð
CMD_CTX_NO_SWAP
) |

94 
	`FIELD_PREP
(
OP_CMD_TGT_CMD
, 
cmd_tgt_aù
[
Ý
].
tgt_cmd
) |

95 
	`FIELD_PREP
(
OP_CMD_INDIR
, 
šdœ
) |

96 
	`FIELD_PREP
(
OP_CMD_MODE
, 
mode
);

98 
	`nå_´og_push
(
nå_´og
, 
š¢
);

99 
	}
}

102 
	$em™_cmd_ªy
(
nå_´og
 *nå_´og, 
cmd_tgt_m­
 
Ý
, 
u8
 
mode
, u8 
xãr
,

103 
sw»g
 
Ìeg
, sw»g 
¼eg
, 
u8
 
size
, 
cmd_ùx_sw­
 
ùx
, 
boÞ
 
šdœ
)

105 
nå_š¢_»_»gs
 
»g
;

106 
”r
;

108 
”r
 = 
	`sw»g_to_»¡riùed
(
	`»g_nÚe
(), 
Ìeg
, 
¼eg
, &
»g
, 
çl£
);

109 ià(
”r
) {

110 
nå_´og
->
”rÜ
 = 
”r
;

113 ià(
»g
.
sw­
) {

114 
	`´_”r
("cmd can't swap‡rguments\n");

115 
nå_´og
->
”rÜ
 = -
EFAULT
;

118 ià(
»g
.
d¡_lmexŠ
 ||„eg.
¤c_lmexŠ
) {

119 
	`´_”r
("cmd can't use LMextn\n");

120 
nå_´og
->
”rÜ
 = -
EFAULT
;

124 
	`__em™_cmd
(
nå_´og
, 
Ý
, 
mode
, 
xãr
, 
»g
.
¬eg
,„eg.
b»g
, 
size
, 
ùx
,

125 
šdœ
);

126 
	}
}

129 
	$em™_cmd
(
nå_´og
 *nå_´og, 
cmd_tgt_m­
 
Ý
, 
u8
 
mode
, u8 
xãr
,

130 
sw»g
 
Ìeg
, sw»g 
¼eg
, 
u8
 
size
, 
cmd_ùx_sw­
 
ùx
)

132 
	`em™_cmd_ªy
(
nå_´og
, 
Ý
, 
mode
, 
xãr
, 
Ìeg
, 
¼eg
, 
size
, 
ùx
, 
çl£
);

133 
	}
}

136 
	$em™_cmd_šdœ
(
nå_´og
 *nå_´og, 
cmd_tgt_m­
 
Ý
, 
u8
 
mode
, u8 
xãr
,

137 
sw»g
 
Ìeg
, sw»g 
¼eg
, 
u8
 
size
, 
cmd_ùx_sw­
 
ùx
)

139 
	`em™_cmd_ªy
(
nå_´og
, 
Ý
, 
mode
, 
xãr
, 
Ìeg
, 
¼eg
, 
size
, 
ùx
, 
Œue
);

140 
	}
}

143 
	$__em™_br
(
nå_´og
 *nå_´og, 
br_mask
 
mask
, 
br_ev_p
 
ev_p
,

144 
br_ùx_sigÇl_¡©e
 
css
, 
u16
 
addr
, 
u8
 
deãr
)

146 
u16
 
addr_lo
, 
addr_hi
;

147 
u64
 
š¢
;

149 
addr_lo
 = 
addr
 & (
OP_BR_ADDR_LO
 >> 
	`__bf_shf
(OP_BR_ADDR_LO));

150 
addr_hi
 = 
addr
 !ð
addr_lo
;

152 
š¢
 = 
OP_BR_BASE
 |

153 
	`FIELD_PREP
(
OP_BR_MASK
, 
mask
) |

154 
	`FIELD_PREP
(
OP_BR_EV_PIP
, 
ev_p
) |

155 
	`FIELD_PREP
(
OP_BR_CSS
, 
css
) |

156 
	`FIELD_PREP
(
OP_BR_DEFBR
, 
deãr
) |

157 
	`FIELD_PREP
(
OP_BR_ADDR_LO
, 
addr_lo
) |

158 
	`FIELD_PREP
(
OP_BR_ADDR_HI
, 
addr_hi
);

160 
	`nå_´og_push
(
nå_´og
, 
š¢
);

161 
	}
}

164 
	$em™_br_»lo
(
nå_´og
 *nå_´og, 
br_mask
 
mask
, 
u16
 
addr
, 
u8
 
deãr
,

165 
nå_»lo_ty³
 
»lo
)

167 ià(
mask
 =ð
BR_UNC
 && 
deãr
 > 2) {

168 
	`´_”r
("BUG: b¿nch deã¸ouˆoàbound %d\n", 
deãr
);

169 
nå_´og
->
”rÜ
 = -
EFAULT
;

173 
	`__em™_br
(
nå_´og
, 
mask
,

174 
mask
 !ð
BR_UNC
 ? 
BR_EV_PIP_COND
 : 
BR_EV_PIP_UNCOND
,

175 
BR_CSS_NONE
, 
addr
, 
deãr
);

177 
nå_´og
->
´og
[nå_´og->
´og_Ën
 - 1] |=

178 
	`FIELD_PREP
(
OP_RELO_TYPE
, 
»lo
);

179 
	}
}

182 
	$em™_br
(
nå_´og
 *nå_´og, 
br_mask
 
mask
, 
u16
 
addr
, 
u8
 
deãr
)

184 
	`em™_br_»lo
(
nå_´og
, 
mask
, 
addr
, 
deãr
, 
RELO_BR_REL
);

185 
	}
}

188 
	$__em™_br_b™
(
nå_´og
 *nå_´og, 
u16
 
¬eg
, u16 
b»g
, u16 
addr
, 
u8
 
deãr
,

189 
boÞ
 
£t
, boÞ 
¤c_lmexŠ
)

191 
u16
 
addr_lo
, 
addr_hi
;

192 
u64
 
š¢
;

194 
addr_lo
 = 
addr
 & (
OP_BR_BIT_ADDR_LO
 >> 
	`__bf_shf
(OP_BR_BIT_ADDR_LO));

195 
addr_hi
 = 
addr
 !ð
addr_lo
;

197 
š¢
 = 
OP_BR_BIT_BASE
 |

198 
	`FIELD_PREP
(
OP_BR_BIT_A_SRC
, 
¬eg
) |

199 
	`FIELD_PREP
(
OP_BR_BIT_B_SRC
, 
b»g
) |

200 
	`FIELD_PREP
(
OP_BR_BIT_BV
, 
£t
) |

201 
	`FIELD_PREP
(
OP_BR_BIT_DEFBR
, 
deãr
) |

202 
	`FIELD_PREP
(
OP_BR_BIT_ADDR_LO
, 
addr_lo
) |

203 
	`FIELD_PREP
(
OP_BR_BIT_ADDR_HI
, 
addr_hi
) |

204 
	`FIELD_PREP
(
OP_BR_BIT_SRC_LMEXTN
, 
¤c_lmexŠ
);

206 
	`nå_´og_push
(
nå_´og
, 
š¢
);

207 
	}
}

210 
	$em™_br_b™_»lo
(
nå_´og
 *nå_´og, 
sw»g
 
¤c
, 
u8
 
b™
, 
u16
 
addr
,

211 
u8
 
deãr
, 
boÞ
 
£t
, 
nå_»lo_ty³
 
»lo
)

213 
nå_š¢_»_»gs
 
»g
;

214 
”r
;

220 
b™
 += 1;

222 
”r
 = 
	`sw»g_to_»¡riùed
(
	`»g_nÚe
(), 
¤c
, 
	`»g_imm
(
b™
), &
»g
, 
çl£
);

223 ià(
”r
) {

224 
nå_´og
->
”rÜ
 = 
”r
;

228 
	`__em™_br_b™
(
nå_´og
, 
»g
.
¬eg
,„eg.
b»g
, 
addr
, 
deãr
, 
£t
,

229 
»g
.
¤c_lmexŠ
);

231 
nå_´og
->
´og
[nå_´og->
´og_Ën
 - 1] |=

232 
	`FIELD_PREP
(
OP_RELO_TYPE
, 
»lo
);

233 
	}
}

236 
	$em™_br_b£t
(
nå_´og
 *nå_´og, 
sw»g
 
¤c
, 
u8
 
b™
, 
u16
 
addr
, u8 
deãr
)

238 
	`em™_br_b™_»lo
(
nå_´og
, 
¤c
, 
b™
, 
addr
, 
deãr
, 
Œue
, 
RELO_BR_REL
);

239 
	}
}

242 
	$__em™_br_®u
(
nå_´og
 *nå_´og, 
u16
 
¬eg
, u16 
b»g
, u16 
imm_hi
,

243 
u8
 
deãr
, 
boÞ
 
d¡_lmexŠ
, boÞ 
¤c_lmexŠ
)

245 
u64
 
š¢
;

247 
š¢
 = 
OP_BR_ALU_BASE
 |

248 
	`FIELD_PREP
(
OP_BR_ALU_A_SRC
, 
¬eg
) |

249 
	`FIELD_PREP
(
OP_BR_ALU_B_SRC
, 
b»g
) |

250 
	`FIELD_PREP
(
OP_BR_ALU_DEFBR
, 
deãr
) |

251 
	`FIELD_PREP
(
OP_BR_ALU_IMM_HI
, 
imm_hi
) |

252 
	`FIELD_PREP
(
OP_BR_ALU_SRC_LMEXTN
, 
¤c_lmexŠ
) |

253 
	`FIELD_PREP
(
OP_BR_ALU_DST_LMEXTN
, 
d¡_lmexŠ
);

255 
	`nå_´og_push
(
nå_´og
, 
š¢
);

256 
	}
}

258 
	$em™_¹n
(
nå_´og
 *nå_´og, 
sw»g
 
ba£
, 
u8
 
deãr
)

260 
nå_š¢_ur_»gs
 
»g
;

261 
”r
;

263 
”r
 = 
	`sw»g_to_uÄe¡riùed
(
	`»g_nÚe
(), 
ba£
, 
	`»g_imm
(0), &
»g
);

264 ià(
”r
) {

265 
nå_´og
->
”rÜ
 = 
”r
;

269 
	`__em™_br_®u
(
nå_´og
, 
»g
.
¬eg
,„eg.
b»g
, 0, 
deãr
,„eg.
d¡_lmexŠ
,

270 
»g
.
¤c_lmexŠ
);

271 
	}
}

274 
	$__em™_immed
(
nå_´og
 *nå_´og, 
u16
 
¬eg
, u16 
b»g
, u16 
imm_hi
,

275 
immed_width
 
width
, 
boÞ
 
šv”t
,

276 
immed_shiá
 
shiá
, 
boÞ
 
wr_bÙh
,

277 
boÞ
 
d¡_lmexŠ
, boÞ 
¤c_lmexŠ
)

279 
u64
 
š¢
;

281 
š¢
 = 
OP_IMMED_BASE
 |

282 
	`FIELD_PREP
(
OP_IMMED_A_SRC
, 
¬eg
) |

283 
	`FIELD_PREP
(
OP_IMMED_B_SRC
, 
b»g
) |

284 
	`FIELD_PREP
(
OP_IMMED_IMM
, 
imm_hi
) |

285 
	`FIELD_PREP
(
OP_IMMED_WIDTH
, 
width
) |

286 
	`FIELD_PREP
(
OP_IMMED_INV
, 
šv”t
) |

287 
	`FIELD_PREP
(
OP_IMMED_SHIFT
, 
shiá
) |

288 
	`FIELD_PREP
(
OP_IMMED_WR_AB
, 
wr_bÙh
) |

289 
	`FIELD_PREP
(
OP_IMMED_SRC_LMEXTN
, 
¤c_lmexŠ
) |

290 
	`FIELD_PREP
(
OP_IMMED_DST_LMEXTN
, 
d¡_lmexŠ
);

292 
	`nå_´og_push
(
nå_´og
, 
š¢
);

293 
	}
}

296 
	$em™_immed
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, 
u16
 
imm
,

297 
immed_width
 
width
, 
boÞ
 
šv”t
, 
immed_shiá
 
shiá
)

299 
nå_š¢_ur_»gs
 
»g
;

300 
”r
;

302 ià(
	`sw»g_ty³
(
d¡
è=ð
NN_REG_IMM
) {

303 
nå_´og
->
”rÜ
 = -
EFAULT
;

307 
”r
 = 
	`sw»g_to_uÄe¡riùed
(
d¡
, d¡, 
	`»g_imm
(
imm
 & 0xff), &
»g
);

308 ià(
”r
) {

309 
nå_´og
->
”rÜ
 = 
”r
;

314 
	`__em™_immed
(
nå_´og
,

315 
	`sw»g_ty³
(
d¡
è=ð
NN_REG_NONE
 ? 
»g
.d¡ :„eg.
¬eg
,

316 
»g
.
b»g
, 
imm
 >> 8, 
width
, 
šv”t
, 
shiá
,

317 
»g
.
wr_bÙh
,„eg.
d¡_lmexŠ
,„eg.
¤c_lmexŠ
);

318 
	}
}

321 
	$__em™_shf
(
nå_´og
 *nå_´og, 
u16
 
d¡
, 
®u_d¡_ab
 
d¡_ab
,

322 
shf_sc
 
sc
, 
u8
 
shiá
,

323 
u16
 
¬eg
, 
shf_Ý
 
Ý
, u16 
b»g
, 
boÞ
 
i8
, boÞ 
sw
, boÞ 
wr_bÙh
,

324 
boÞ
 
d¡_lmexŠ
, boÞ 
¤c_lmexŠ
)

326 
u64
 
š¢
;

328 ià(!
	`FIELD_FIT
(
OP_SHF_SHIFT
, 
shiá
)) {

329 
nå_´og
->
”rÜ
 = -
EFAULT
;

333 ià(
sc
 =ð
SHF_SC_L_SHF
)

334 
shiá
 = 32 - shift;

336 
š¢
 = 
OP_SHF_BASE
 |

337 
	`FIELD_PREP
(
OP_SHF_A_SRC
, 
¬eg
) |

338 
	`FIELD_PREP
(
OP_SHF_SC
, 
sc
) |

339 
	`FIELD_PREP
(
OP_SHF_B_SRC
, 
b»g
) |

340 
	`FIELD_PREP
(
OP_SHF_I8
, 
i8
) |

341 
	`FIELD_PREP
(
OP_SHF_SW
, 
sw
) |

342 
	`FIELD_PREP
(
OP_SHF_DST
, 
d¡
) |

343 
	`FIELD_PREP
(
OP_SHF_SHIFT
, 
shiá
) |

344 
	`FIELD_PREP
(
OP_SHF_OP
, 
Ý
) |

345 
	`FIELD_PREP
(
OP_SHF_DST_AB
, 
d¡_ab
) |

346 
	`FIELD_PREP
(
OP_SHF_WR_AB
, 
wr_bÙh
) |

347 
	`FIELD_PREP
(
OP_SHF_SRC_LMEXTN
, 
¤c_lmexŠ
) |

348 
	`FIELD_PREP
(
OP_SHF_DST_LMEXTN
, 
d¡_lmexŠ
);

350 
	`nå_´og_push
(
nå_´og
, 
š¢
);

351 
	}
}

354 
	$em™_shf
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
,

355 
sw»g
 
Ìeg
, 
shf_Ý
 
Ý
, sw»g 
¼eg
, 
shf_sc
 
sc
, 
u8
 
shiá
)

357 
nå_š¢_»_»gs
 
»g
;

358 
”r
;

360 
”r
 = 
	`sw»g_to_»¡riùed
(
d¡
, 
Ìeg
, 
¼eg
, &
»g
, 
Œue
);

361 ià(
”r
) {

362 
nå_´og
->
”rÜ
 = 
”r
;

366 
	`__em™_shf
(
nå_´og
, 
»g
.
d¡
,„eg.
d¡_ab
, 
sc
, 
shiá
,

367 
»g
.
¬eg
, 
Ý
,„eg.
b»g
,„eg.
i8
,„eg.
sw­
,„eg.
wr_bÙh
,

368 
»g
.
d¡_lmexŠ
,„eg.
¤c_lmexŠ
);

369 
	}
}

372 
	$em™_shf_šdœ
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
,

373 
sw»g
 
Ìeg
, 
shf_Ý
 
Ý
, sw»g 
¼eg
, 
shf_sc
 
sc
)

375 ià(
sc
 =ð
SHF_SC_R_ROT
) {

376 
	`´_”r
("indirect shift is‚ot‡llowed on„otation\n");

377 
nå_´og
->
”rÜ
 = -
EFAULT
;

381 
	`em™_shf
(
nå_´og
, 
d¡
, 
Ìeg
, 
Ý
, 
¼eg
, 
sc
, 0);

382 
	}
}

385 
	$__em™_®u
(
nå_´og
 *nå_´og, 
u16
 
d¡
, 
®u_d¡_ab
 
d¡_ab
,

386 
u16
 
¬eg
, 
®u_Ý
 
Ý
, u16 
b»g
, 
boÞ
 
sw­
, boÞ 
wr_bÙh
,

387 
boÞ
 
d¡_lmexŠ
, boÞ 
¤c_lmexŠ
)

389 
u64
 
š¢
;

391 
š¢
 = 
OP_ALU_BASE
 |

392 
	`FIELD_PREP
(
OP_ALU_A_SRC
, 
¬eg
) |

393 
	`FIELD_PREP
(
OP_ALU_B_SRC
, 
b»g
) |

394 
	`FIELD_PREP
(
OP_ALU_DST
, 
d¡
) |

395 
	`FIELD_PREP
(
OP_ALU_SW
, 
sw­
) |

396 
	`FIELD_PREP
(
OP_ALU_OP
, 
Ý
) |

397 
	`FIELD_PREP
(
OP_ALU_DST_AB
, 
d¡_ab
) |

398 
	`FIELD_PREP
(
OP_ALU_WR_AB
, 
wr_bÙh
) |

399 
	`FIELD_PREP
(
OP_ALU_SRC_LMEXTN
, 
¤c_lmexŠ
) |

400 
	`FIELD_PREP
(
OP_ALU_DST_LMEXTN
, 
d¡_lmexŠ
);

402 
	`nå_´og_push
(
nå_´og
, 
š¢
);

403 
	}
}

406 
	$em™_®u
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
,

407 
sw»g
 
Ìeg
, 
®u_Ý
 
Ý
, sw»g 
¼eg
)

409 
nå_š¢_ur_»gs
 
»g
;

410 
”r
;

412 
”r
 = 
	`sw»g_to_uÄe¡riùed
(
d¡
, 
Ìeg
, 
¼eg
, &
»g
);

413 ià(
”r
) {

414 
nå_´og
->
”rÜ
 = 
”r
;

418 
	`__em™_®u
(
nå_´og
, 
»g
.
d¡
,„eg.
d¡_ab
,

419 
»g
.
¬eg
, 
Ý
,„eg.
b»g
,„eg.
sw­
,„eg.
wr_bÙh
,

420 
»g
.
d¡_lmexŠ
,„eg.
¤c_lmexŠ
);

421 
	}
}

424 
	$__em™_mul
(
nå_´og
 *nå_´og, 
®u_d¡_ab
 
d¡_ab
, 
u16
 
¬eg
,

425 
mul_ty³
 
ty³
, 
mul_¡•
 
¡•
, 
u16
 
b»g
, 
boÞ
 
sw­
,

426 
boÞ
 
wr_bÙh
, boÞ 
d¡_lmexŠ
, boÞ 
¤c_lmexŠ
)

428 
u64
 
š¢
;

430 
š¢
 = 
OP_MUL_BASE
 |

431 
	`FIELD_PREP
(
OP_MUL_A_SRC
, 
¬eg
) |

432 
	`FIELD_PREP
(
OP_MUL_B_SRC
, 
b»g
) |

433 
	`FIELD_PREP
(
OP_MUL_STEP
, 
¡•
) |

434 
	`FIELD_PREP
(
OP_MUL_DST_AB
, 
d¡_ab
) |

435 
	`FIELD_PREP
(
OP_MUL_SW
, 
sw­
) |

436 
	`FIELD_PREP
(
OP_MUL_TYPE
, 
ty³
) |

437 
	`FIELD_PREP
(
OP_MUL_WR_AB
, 
wr_bÙh
) |

438 
	`FIELD_PREP
(
OP_MUL_SRC_LMEXTN
, 
¤c_lmexŠ
) |

439 
	`FIELD_PREP
(
OP_MUL_DST_LMEXTN
, 
d¡_lmexŠ
);

441 
	`nå_´og_push
(
nå_´og
, 
š¢
);

442 
	}
}

445 
	$em™_mul
(
nå_´og
 *nå_´og, 
sw»g
 
Ìeg
, 
mul_ty³
 
ty³
,

446 
mul_¡•
 
¡•
, 
sw»g
 
¼eg
)

448 
nå_š¢_ur_»gs
 
»g
;

449 
u16
 
¬eg
;

450 
”r
;

452 ià(
ty³
 =ð
MUL_TYPE_START
 && 
¡•
 !ð
MUL_STEP_NONE
) {

453 
nå_´og
->
”rÜ
 = -
EINVAL
;

457 ià(
¡•
 =ð
MUL_LAST
 || s‹°=ð
MUL_LAST_2
) {

461 
”r
 = 
	`sw»g_to_uÄe¡riùed
(
Ìeg
, 
	`»g_nÚe
(), 
¼eg
, &
»g
);

462 
¬eg
 = 
»g
.
d¡
;

464 
”r
 = 
	`sw»g_to_uÄe¡riùed
(
	`»g_nÚe
(), 
Ìeg
, 
¼eg
, &
»g
);

465 
¬eg
 = 
»g
.areg;

468 ià(
”r
) {

469 
nå_´og
->
”rÜ
 = 
”r
;

473 
	`__em™_mul
(
nå_´og
, 
»g
.
d¡_ab
, 
¬eg
, 
ty³
, 
¡•
,„eg.
b»g
,„eg.
sw­
,

474 
»g
.
wr_bÙh
,„eg.
d¡_lmexŠ
,„eg.
¤c_lmexŠ
);

475 
	}
}

478 
	$__em™_ld_f›ld
(
nå_´og
 *nå_´og, 
shf_sc
 
sc
,

479 
u8
 
¬eg
, u8 
bmask
, u8 
b»g
, u8 
shiá
, 
boÞ
 
imm8
,

480 
boÞ
 
z”o
, boÞ 
sw­
, boÞ 
wr_bÙh
,

481 
boÞ
 
d¡_lmexŠ
, boÞ 
¤c_lmexŠ
)

483 
u64
 
š¢
;

485 
š¢
 = 
OP_LDF_BASE
 |

486 
	`FIELD_PREP
(
OP_LDF_A_SRC
, 
¬eg
) |

487 
	`FIELD_PREP
(
OP_LDF_SC
, 
sc
) |

488 
	`FIELD_PREP
(
OP_LDF_B_SRC
, 
b»g
) |

489 
	`FIELD_PREP
(
OP_LDF_I8
, 
imm8
) |

490 
	`FIELD_PREP
(
OP_LDF_SW
, 
sw­
) |

491 
	`FIELD_PREP
(
OP_LDF_ZF
, 
z”o
) |

492 
	`FIELD_PREP
(
OP_LDF_BMASK
, 
bmask
) |

493 
	`FIELD_PREP
(
OP_LDF_SHF
, 
shiá
) |

494 
	`FIELD_PREP
(
OP_LDF_WR_AB
, 
wr_bÙh
) |

495 
	`FIELD_PREP
(
OP_LDF_SRC_LMEXTN
, 
¤c_lmexŠ
) |

496 
	`FIELD_PREP
(
OP_LDF_DST_LMEXTN
, 
d¡_lmexŠ
);

498 
	`nå_´og_push
(
nå_´og
, 
š¢
);

499 
	}
}

502 
	$em™_ld_f›ld_ªy
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, 
u8
 
bmask
, sw»g 
¤c
,

503 
shf_sc
 
sc
, 
u8
 
shiá
, 
boÞ
 
z”o
)

505 
nå_š¢_»_»gs
 
»g
;

506 
”r
;

509 
”r
 = 
	`sw»g_to_»¡riùed
(
d¡
, d¡, 
¤c
, &
»g
, 
Œue
);

510 ià(
”r
) {

511 
nå_´og
->
”rÜ
 = 
”r
;

515 
	`__em™_ld_f›ld
(
nå_´og
, 
sc
, 
»g
.
¬eg
, 
bmask
,„eg.
b»g
, 
shiá
,

516 
»g
.
i8
, 
z”o
,„eg.
sw­
,„eg.
wr_bÙh
,

517 
»g
.
d¡_lmexŠ
,„eg.
¤c_lmexŠ
);

518 
	}
}

521 
	$em™_ld_f›ld
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, 
u8
 
bmask
, sw»g 
¤c
,

522 
shf_sc
 
sc
, 
u8
 
shiá
)

524 
	`em™_ld_f›ld_ªy
(
nå_´og
, 
d¡
, 
bmask
, 
¤c
, 
sc
, 
shiá
, 
çl£
);

525 
	}
}

528 
	$__em™_lc¤
(
nå_´og
 *nå_´og, 
u16
 
¬eg
, u16 
b»g
, 
boÞ
 
wr
, u16 
addr
,

529 
boÞ
 
d¡_lmexŠ
, boÞ 
¤c_lmexŠ
)

531 
u64
 
š¢
;

533 
š¢
 = 
OP_LCSR_BASE
 |

534 
	`FIELD_PREP
(
OP_LCSR_A_SRC
, 
¬eg
) |

535 
	`FIELD_PREP
(
OP_LCSR_B_SRC
, 
b»g
) |

536 
	`FIELD_PREP
(
OP_LCSR_WRITE
, 
wr
) |

537 
	`FIELD_PREP
(
OP_LCSR_ADDR
, 
addr
 / 4) |

538 
	`FIELD_PREP
(
OP_LCSR_SRC_LMEXTN
, 
¤c_lmexŠ
) |

539 
	`FIELD_PREP
(
OP_LCSR_DST_LMEXTN
, 
d¡_lmexŠ
);

541 
	`nå_´og_push
(
nå_´og
, 
š¢
);

542 
	}
}

544 
	$em™_c¤_wr
(
nå_´og
 *nå_´og, 
sw»g
 
¤c
, 
u16
 
addr
)

546 
nå_š¢_ur_»gs
 
»g
;

547 
”r
;

554 ià(
	`sw»g_ty³
(
¤c
è=ð
NN_REG_IMM
) {

555 
”r
 = 
	`sw»g_to_uÄe¡riùed
(
	`»g_nÚe
(), 
¤c
,„eg_nÚe(), &
»g
);

556 
»g
.
b»g
 =„eg.
¬eg
;

558 
”r
 = 
	`sw»g_to_uÄe¡riùed
(
	`»g_nÚe
(), 
¤c
, 
	`»g_imm
(0), &
»g
);

560 ià(
”r
) {

561 
nå_´og
->
”rÜ
 = 
”r
;

565 
	`__em™_lc¤
(
nå_´og
, 
»g
.
¬eg
,„eg.
b»g
, 
Œue
, 
addr
,

566 
çl£
, 
»g
.
¤c_lmexŠ
);

567 
	}
}

570 
	$__em™_c¤_rd
(
nå_´og
 *nå_´og, 
u16
 
addr
)

572 
	`__em™_lc¤
(
nå_´og
, 0, 0, 
çl£
, 
addr
, false, false);

573 
	}
}

575 
	$em™_nÝ
(
nå_´og
 *nfp_prog)

577 
	`__em™_immed
(
nå_´og
, 
UR_REG_IMM
, UR_REG_IMM, 0, 0, 0, 0, 0, 0, 0);

578 
	}
}

581 
boÞ
 
	$·ck_immed
(
u32
 
imm
, 
u16
 *
v®
, 
immed_shiá
 *
shiá
)

583 ià(!(
imm
 & 0xffff0000)) {

584 *
v®
 = 
imm
;

585 *
shiá
 = 
IMMED_SHIFT_0B
;

586 } ià(!(
imm
 & 0xff0000ff)) {

587 *
v®
 = 
imm
 >> 8;

588 *
shiá
 = 
IMMED_SHIFT_1B
;

589 } ià(!(
imm
 & 0x0000ffff)) {

590 *
v®
 = 
imm
 >> 16;

591 *
shiá
 = 
IMMED_SHIFT_2B
;

593  
çl£
;

596  
Œue
;

597 
	}
}

599 
	$w½_immed
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, 
u32
 
imm
)

601 
immed_shiá
 
shiá
;

602 
u16
 
v®
;

604 ià(
	`·ck_immed
(
imm
, &
v®
, &
shiá
)) {

605 
	`em™_immed
(
nå_´og
, 
d¡
, 
v®
, 
IMMED_WIDTH_ALL
, 
çl£
, 
shiá
);

606 } ià(
	`·ck_immed
(~
imm
, &
v®
, &
shiá
)) {

607 
	`em™_immed
(
nå_´og
, 
d¡
, 
v®
, 
IMMED_WIDTH_ALL
, 
Œue
, 
shiá
);

609 
	`em™_immed
(
nå_´og
, 
d¡
, 
imm
 & 0xffff, 
IMMED_WIDTH_ALL
,

610 
çl£
, 
IMMED_SHIFT_0B
);

611 
	`em™_immed
(
nå_´og
, 
d¡
, 
imm
 >> 16, 
IMMED_WIDTH_WORD
,

612 
çl£
, 
IMMED_SHIFT_2B
);

614 
	}
}

617 
	$w½_immed_»lo
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, 
u32
 
imm
,

618 
nå_»lo_ty³
 
»lo
)

620 ià(
imm
 > 0xffff) {

621 
	`´_”r
("relocation of‡†arge immediate!\n");

622 
nå_´og
->
”rÜ
 = -
EFAULT
;

625 
	`em™_immed
(
nå_´og
, 
d¡
, 
imm
, 
IMMED_WIDTH_ALL
, 
çl£
, 
IMMED_SHIFT_0B
);

627 
nå_´og
->
´og
[nå_´og->
´og_Ën
 - 1] |=

628 
	`FIELD_PREP
(
OP_RELO_TYPE
, 
»lo
);

629 
	}
}

635 
sw»g
 
	$ur_lßd_imm_ªy
(
nå_´og
 *nå_´og, 
u32
 
imm
, 
sw»g
 
tmp_»g
)

637 ià(
	`FIELD_FIT
(
UR_REG_IMM_MAX
, 
imm
))

638  
	`»g_imm
(
imm
);

640 
	`w½_immed
(
nå_´og
, 
tmp_»g
, 
imm
);

641  
tmp_»g
;

642 
	}
}

648 
sw»g
 
	$»_lßd_imm_ªy
(
nå_´og
 *nå_´og, 
u32
 
imm
, 
sw»g
 
tmp_»g
)

650 ià(
	`FIELD_FIT
(
RE_REG_IMM_MAX
, 
imm
))

651  
	`»g_imm
(
imm
);

653 
	`w½_immed
(
nå_´og
, 
tmp_»g
, 
imm
);

654  
tmp_»g
;

655 
	}
}

657 
	$w½_nÝs
(
nå_´og
 *nå_´og, 
couÁ
)

659 
couÁ
--)

660 
	`em™_nÝ
(
nå_´og
);

661 
	}
}

663 
	$w½_mov
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, sw»g 
¤c
)

665 
	`em™_®u
(
nå_´og
, 
d¡
, 
	`»g_nÚe
(), 
ALU_OP_NONE
, 
¤c
);

666 
	}
}

668 
	$w½_»g_mov
(
nå_´og
 *nå_´og, 
u16
 
d¡
, u16 
¤c
)

670 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_b
(
¤c
));

671 
	}
}

677 
	$w½_»g_sub·¹
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, sw»g 
¤c
, 
u8
 
f›ld_Ën
,

678 
u8
 
off£t
)

680 
shf_sc
 
sc
 = 
off£t
 ? 
SHF_SC_R_SHF
 : 
SHF_SC_NONE
;

681 
u8
 
mask
 = (1 << 
f›ld_Ën
) - 1;

683 
	`em™_ld_f›ld_ªy
(
nå_´og
, 
d¡
, 
mask
, 
¤c
, 
sc
, 
off£t
 * 8, 
Œue
);

684 
	}
}

690 
	$w½_»g_Ü_sub·¹
(
nå_´og
 *nå_´og, 
sw»g
 
d¡
, sw»g 
¤c
,

691 
u8
 
f›ld_Ën
, u8 
off£t
)

693 
shf_sc
 
sc
 = 
off£t
 ? 
SHF_SC_L_SHF
 : 
SHF_SC_NONE
;

694 
u8
 
mask
 = ((1 << 
f›ld_Ën
è- 1è<< 
off£t
;

696 
	`em™_ld_f›ld
(
nå_´og
, 
d¡
, 
mask
, 
¤c
, 
sc
, 32 - 
off£t
 * 8);

697 
	}
}

700 
	$addr40_off£t
(
nå_´og
 *nå_´og, 
u8
 
¤c_g´
, 
sw»g
 
off£t
,

701 
sw»g
 *
»ga
, sw»g *
»gb
)

703 ià(
off£t
 =ð
	`»g_imm
(0)) {

704 *
»ga
 = 
	`»g_a
(
¤c_g´
);

705 *
»gb
 = 
	`»g_b
(
¤c_g´
 + 1);

709 
	`em™_®u
(
nå_´og
, 
	`imm_a
Òå_´og), 
	`»g_a
(
¤c_g´
), 
ALU_OP_ADD
, 
off£t
);

710 
	`em™_®u
(
nå_´og
, 
	`imm_b
Òå_´og), 
	`»g_b
(
¤c_g´
 + 1), 
ALU_OP_ADD_C
,

711 
	`»g_imm
(0));

712 *
»ga
 = 
	`imm_a
(
nå_´og
);

713 *
»gb
 = 
	`imm_b
(
nå_´og
);

714 
	}
}

717 
	$nå_ýp_memýy
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

719 
boÞ
 
desûndšg_£q
 = 
m‘a
->
ld¡_g©h”_Ën
 < 0;

720 
s16
 
Ën
 = 
	`abs
(
m‘a
->
ld¡_g©h”_Ën
);

721 
sw»g
 
¤c_ba£
, 
off
;

722 
boÞ
 
¤c_40b™_addr
;

723 
i
;

724 
u8
 
xãr_num
;

726 
off
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
š¢
.off, 
	`imm_b
(nfp_prog));

727 
¤c_40b™_addr
 = 
m‘a
->
±r
.
ty³
 =ð
PTR_TO_MAP_VALUE
;

728 
¤c_ba£
 = 
	`»g_a
(
m‘a
->
š¢
.
¤c_»g
 * 2);

729 
xãr_num
 = 
	`round_up
(
Ën
, 4) / 4;

731 ià(
¤c_40b™_addr
)

732 
	`addr40_off£t
(
nå_´og
, 
m‘a
->
š¢
.
¤c_»g
 * 2, 
off
, &
¤c_ba£
,

733 &
off
);

736 ià(
Ën
 > 32)

737 
	`w½_immed
(
nå_´og
, 
	`»g_nÚe
(),

738 
CMD_OVE_LEN
 | 
	`FIELD_PREP
(
CMD_OV_LEN
, 
xãr_num
 - 1));

741 
	`em™_cmd_ªy
(
nå_´og
, 
CMD_TGT_READ32_SWAP
,

742 
¤c_40b™_addr
 ? 
CMD_MODE_40b_BA
 : 
CMD_MODE_32b
, 0,

743 
¤c_ba£
, 
off
, 
xãr_num
 - 1, 
CMD_CTX_SWAP
, 
Ën
 > 32);

746 
i
 = 0; i < 
xãr_num
; i++)

747 
	`w½_mov
(
nå_´og
, 
	`»g_xãr
(
i
),„eg_xfer(i));

749 
off
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
·œed_¡
->off, 
	`imm_b
(nfp_prog));

751 ià(
Ën
 <= 8) {

753 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_WRITE8_SWAP
, 
CMD_MODE_32b
, 0,

754 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
, 
Ën
 - 1,

755 
CMD_CTX_SWAP
);

756 } ià(
Ën
 <ð32 && 
	`IS_ALIGNED
(len, 4)) {

758 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_WRITE32_SWAP
, 
CMD_MODE_32b
, 0,

759 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
, 
xãr_num
 - 1,

760 
CMD_CTX_SWAP
);

761 } ià(
Ën
 <= 32) {

763 
	`w½_immed
(
nå_´og
, 
	`»g_nÚe
(),

764 
CMD_OVE_LEN
 | 
	`FIELD_PREP
(
CMD_OV_LEN
, 
Ën
 - 1));

765 
	`em™_cmd_šdœ
(
nå_´og
, 
CMD_TGT_WRITE8_SWAP
, 
CMD_MODE_32b
, 0,

766 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
,

767 
Ën
 - 1, 
CMD_CTX_SWAP
);

768 } ià(
	`IS_ALIGNED
(
Ën
, 4)) {

770 
	`w½_immed
(
nå_´og
, 
	`»g_nÚe
(),

771 
CMD_OVE_LEN
 | 
	`FIELD_PREP
(
CMD_OV_LEN
, 
xãr_num
 - 1));

772 
	`em™_cmd_šdœ
(
nå_´og
, 
CMD_TGT_WRITE32_SWAP
, 
CMD_MODE_32b
, 0,

773 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
,

774 
xãr_num
 - 1, 
CMD_CTX_SWAP
);

775 } ià(
Ën
 <= 40) {

779 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_WRITE32_SWAP
, 
CMD_MODE_32b
, 0,

780 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
, 7,

781 
CMD_CTX_SWAP
);

783 
off
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
·œed_¡
->off + 32,

784 
	`imm_b
(
nå_´og
));

785 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_WRITE8_SWAP
, 
CMD_MODE_32b
, 8,

786 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
, 
Ën
 - 33,

787 
CMD_CTX_SWAP
);

792 
u8
 
Ãw_off
;

794 
	`w½_immed
(
nå_´og
, 
	`»g_nÚe
(),

795 
CMD_OVE_LEN
 | 
	`FIELD_PREP
(
CMD_OV_LEN
, 
xãr_num
 - 2));

796 
	`em™_cmd_šdœ
(
nå_´og
, 
CMD_TGT_WRITE32_SWAP
, 
CMD_MODE_32b
, 0,

797 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
,

798 
xãr_num
 - 2, 
CMD_CTX_SWAP
);

799 
Ãw_off
 = 
m‘a
->
·œed_¡
->
off
 + (
xãr_num
 - 1) * 4;

800 
off
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
Ãw_off
, 
	`imm_b
(nfp_prog));

801 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_WRITE8_SWAP
, 
CMD_MODE_32b
,

802 
xãr_num
 - 1, 
	`»g_a
(
m‘a
->
·œed_¡
->
d¡_»g
 * 2), 
off
,

803 (
Ën
 & 0x3è- 1, 
CMD_CTX_SWAP
);

816 ià(
desûndšg_£q
)

817 
xãr_num
 = 0;

818 ià(
	`BPF_SIZE
(
m‘a
->
š¢
.
code
è!ð
BPF_DW
)

819 
xãr_num
 = xfer_num - 1;

821 
xãr_num
 = xfer_num - 2;

823 
	`BPF_SIZE
(
m‘a
->
š¢
.
code
)) {

824 
BPF_B
:

825 
	`w½_»g_sub·¹
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2),

826 
	`»g_xãr
(
xãr_num
), 1,

827 
	`IS_ALIGNED
(
Ën
, 4) ? 3 : (len & 3) - 1);

829 
BPF_H
:

830 
	`w½_»g_sub·¹
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2),

831 
	`»g_xãr
(
xãr_num
), 2, (
Ën
 & 3) ^ 2);

833 
BPF_W
:

834 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2),

835 
	`»g_xãr
(0));

837 
BPF_DW
:

838 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2),

839 
	`»g_xãr
(
xãr_num
));

840 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2 + 1),

841 
	`»g_xãr
(
xãr_num
 + 1));

845 ià(
	`BPF_SIZE
(
m‘a
->
š¢
.
code
è!ð
BPF_DW
)

846 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2 + 1), 0);

849 
	}
}

852 
	$d©a_ld
(
nå_´og
 *nå_´og, 
sw»g
 
off£t
, 
u8
 
d¡_g´
, 
size
)

854 
i
;

855 
u16
 
shiá
, 
sz
;

860 
sz
 = 
	`max
(
size
, 4);

861 
shiá
 = 
size
 < 4 ? 4 - size : 0;

863 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_READ8
, 
CMD_MODE_32b
, 0,

864 
	`µŒ_»g
(
nå_´og
), 
off£t
, 
sz
 - 1, 
CMD_CTX_SWAP
);

866 
i
 = 0;

867 ià(
shiá
)

868 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡_g´
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

869 
	`»g_xãr
(0), 
SHF_SC_R_SHF
, 
shiá
 * 8);

871 ; 
i
 * 4 < 
size
; i++)

872 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
d¡_g´
 + 
i
), 
	`»g_xãr
(i));

874 ià(
i
 < 2)

875 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡_g´
 + 1), 0);

878 
	}
}

881 
	$d©a_ld_ho¡_Üd”
(
nå_´og
 *nå_´og, 
u8
 
d¡_g´
,

882 
sw»g
 
Ìeg
, sw»g 
¼eg
, 
size
, 
cmd_mode
 
mode
)

884 
i
;

885 
u8
 
mask
, 
sz
;

890 
sz
 = 
	`max
(
size
, 4);

891 
mask
 = 
size
 < 4 ? 
	`GENMASK
(size - 1, 0) : 0;

893 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_READ32_SWAP
, 
mode
, 0,

894 
Ìeg
, 
¼eg
, 
sz
 / 4 - 1, 
CMD_CTX_SWAP
);

896 
i
 = 0;

897 ià(
mask
)

898 
	`em™_ld_f›ld_ªy
(
nå_´og
, 
	`»g_bÙh
(
d¡_g´
), 
mask
,

899 
	`»g_xãr
(0), 
SHF_SC_NONE
, 0, 
Œue
);

901 ; 
i
 * 4 < 
size
; i++)

902 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
d¡_g´
 + 
i
), 
	`»g_xãr
(i));

904 ià(
i
 < 2)

905 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡_g´
 + 1), 0);

908 
	}
}

911 
	$d©a_ld_ho¡_Üd”_addr32
(
nå_´og
 *nå_´og, 
u8
 
¤c_g´
, 
sw»g
 
off£t
,

912 
u8
 
d¡_g´
, u8 
size
)

914  
	`d©a_ld_ho¡_Üd”
(
nå_´og
, 
d¡_g´
, 
	`»g_a
(
¤c_g´
), 
off£t
,

915 
size
, 
CMD_MODE_32b
);

916 
	}
}

919 
	$d©a_ld_ho¡_Üd”_addr40
(
nå_´og
 *nå_´og, 
u8
 
¤c_g´
, 
sw»g
 
off£t
,

920 
u8
 
d¡_g´
, u8 
size
)

922 
sw»g
 
»ga
, 
»gb
;

924 
	`addr40_off£t
(
nå_´og
, 
¤c_g´
, 
off£t
, &
»ga
, &
»gb
);

926  
	`d©a_ld_ho¡_Üd”
(
nå_´og
, 
d¡_g´
, 
»ga
, 
»gb
,

927 
size
, 
CMD_MODE_40b_BA
);

928 
	}
}

931 
	$cÚ¡ruù_d©a_šd_ld
(
nå_´og
 *nå_´og, 
u16
 
off£t
, u16 
¤c
, 
u8
 
size
)

933 
sw»g
 
tmp_»g
;

936 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
off£t
, 
	`imm_b
(nfp_prog));

937 
	`em™_®u
(
nå_´og
, 
	`imm_bÙh
Òå_´og), 
	`»g_a
(
¤c
), 
ALU_OP_ADD
, 
tmp_»g
);

940 
	`em™_®u
(
nå_´og
, 
	`imm_a
(nfp_prog),

941 
	`imm_a
(
nå_´og
), 
ALU_OP_ADD
, 
	`»g_imm
(
size
));

942 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

943 
	`¶’_»g
(
nå_´og
), 
ALU_OP_SUB
, 
	`imm_a
(nfp_prog));

944 
	`em™_br_»lo
(
nå_´og
, 
BR_BLO
, 
BR_OFF_RELO
, 0, 
RELO_BR_GO_ABORT
);

947  
	`d©a_ld
(
nå_´og
, 
	`imm_b
Òå_´og), 0, 
size
);

948 
	}
}

950 
	$cÚ¡ruù_d©a_ld
(
nå_´og
 *nå_´og, 
u16
 
off£t
, 
u8
 
size
)

952 
sw»g
 
tmp_»g
;

955 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
off£t
 + 
size
, 
	`imm_a
(nfp_prog));

956 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`¶’_»g
Òå_´og), 
ALU_OP_SUB
, 
tmp_»g
);

957 
	`em™_br_»lo
(
nå_´og
, 
BR_BLO
, 
BR_OFF_RELO
, 0, 
RELO_BR_GO_ABORT
);

960 
tmp_»g
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
off£t
, 
	`imm_b
(nfp_prog));

961  
	`d©a_ld
(
nå_´og
, 
tmp_»g
, 0, 
size
);

962 
	}
}

965 
	$d©a_¡x_ho¡_Üd”
(
nå_´og
 *nå_´og, 
u8
 
d¡_g´
, 
sw»g
 
off£t
,

966 
u8
 
¤c_g´
, u8 
size
)

968 
i
;

970 
i
 = 0; i * 4 < 
size
; i++)

971 
	`w½_mov
(
nå_´og
, 
	`»g_xãr
(
i
), 
	`»g_a
(
¤c_g´
 + i));

973 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_WRITE8_SWAP
, 
CMD_MODE_32b
, 0,

974 
	`»g_a
(
d¡_g´
), 
off£t
, 
size
 - 1, 
CMD_CTX_SWAP
);

977 
	}
}

980 
	$d©a_¡_ho¡_Üd”
(
nå_´og
 *nå_´og, 
u8
 
d¡_g´
, 
sw»g
 
off£t
,

981 
u64
 
imm
, 
u8
 
size
)

983 
	`w½_immed
(
nå_´og
, 
	`»g_xãr
(0), 
imm
);

984 ià(
size
 == 8)

985 
	`w½_immed
(
nå_´og
, 
	`»g_xãr
(1), 
imm
 >> 32);

987 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_WRITE8_SWAP
, 
CMD_MODE_32b
, 0,

988 
	`»g_a
(
d¡_g´
), 
off£t
, 
size
 - 1, 
CMD_CTX_SWAP
);

991 
	}
}

994 (*
	tlmem_¡•
)(
	tnå_´og
 *nå_´og, 
	tu8
 
	tg´
, u8 
	tg´_by‹
, 
	ts32
 
	toff
,

995 
	tsize
, 
	tboÞ
 
	tfœ¡
, boÞ 
	tÃw_g´
, boÞ 
	tÏ¡
, boÞ 
	tlm3
,

996 
	tboÞ
 
	tÃeds_šc
);

999 
	$w½_lmem_lßd
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
d¡_by‹
, 
s32
 
off
,

1000 
size
, 
boÞ
 
fœ¡
, boÞ 
Ãw_g´
, boÞ 
Ï¡
, boÞ 
lm3
,

1001 
boÞ
 
Ãeds_šc
)

1003 
boÞ
 
should_šc
 = 
Ãeds_šc
 && 
Ãw_g´
 && !
Ï¡
;

1004 
u32
 
idx
, 
¤c_by‹
;

1005 
shf_sc
 
sc
;

1006 
sw»g
 
»g
;

1007 
shf
;

1008 
u8
 
mask
;

1010 ià(
	`WARN_ON_ONCE
(
d¡_by‹
 + 
size
 > 4 || 
off
 % 4 + size > 4))

1011  -
EOPNOTSUPP
;

1013 
idx
 = 
off
 / 4;

1016 ià(
size
 == 4) {

1017 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
d¡
),

1018 
should_šc
 ? 
	`»g_lm_šc
(3è: 
	`»g_lm
(
lm3
 ? 3 : 0, 
idx
));

1022 ià(
	`WARN_ON_ONCE
(
lm3
 && 
idx
 > 
RE_REG_LM_IDX_MAX
))

1023  -
EOPNOTSUPP
;

1025 
¤c_by‹
 = 
off
 % 4;

1027 
mask
 = (1 << 
size
) - 1;

1028 
mask
 <<ð
d¡_by‹
;

1030 ià(
	`WARN_ON_ONCE
(
mask
 > 0xf))

1031  -
EOPNOTSUPP
;

1033 
shf
 = 
	`abs
(
¤c_by‹
 - 
d¡_by‹
) * 8;

1034 ià(
¤c_by‹
 =ð
d¡_by‹
) {

1035 
sc
 = 
SHF_SC_NONE
;

1036 } ià(
¤c_by‹
 < 
d¡_by‹
) {

1037 
shf
 = 32 - shf;

1038 
sc
 = 
SHF_SC_L_SHF
;

1040 
sc
 = 
SHF_SC_R_SHF
;

1046 ià(
idx
 <ð
RE_REG_LM_IDX_MAX
) {

1047 
»g
 = 
	`»g_lm
(
lm3
 ? 3 : 0, 
idx
);

1049 
»g
 = 
	`imm_a
(
nå_´og
);

1055 ià(
fœ¡
 || !
Ãw_g´
)

1056 
	`w½_mov
(
nå_´og
, 
»g
, 
	`»g_lm
(0, 
idx
));

1059 
	`em™_ld_f›ld_ªy
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
mask
, 
»g
, 
sc
, 
shf
, 
Ãw_g´
);

1061 ià(
should_šc
)

1062 
	`w½_mov
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_lm_šc
(3));

1065 
	}
}

1068 
	$w½_lmem_¡Üe
(
nå_´og
 *nå_´og, 
u8
 
¤c
, u8 
¤c_by‹
, 
s32
 
off
,

1069 
size
, 
boÞ
 
fœ¡
, boÞ 
Ãw_g´
, boÞ 
Ï¡
, boÞ 
lm3
,

1070 
boÞ
 
Ãeds_šc
)

1072 
boÞ
 
should_šc
 = 
Ãeds_šc
 && 
Ãw_g´
 && !
Ï¡
;

1073 
u32
 
idx
, 
d¡_by‹
;

1074 
shf_sc
 
sc
;

1075 
sw»g
 
»g
;

1076 
shf
;

1077 
u8
 
mask
;

1079 ià(
	`WARN_ON_ONCE
(
¤c_by‹
 + 
size
 > 4 || 
off
 % 4 + size > 4))

1080  -
EOPNOTSUPP
;

1082 
idx
 = 
off
 / 4;

1085 ià(
size
 == 4) {

1086 
	`w½_mov
(
nå_´og
,

1087 
should_šc
 ? 
	`»g_lm_šc
(3è: 
	`»g_lm
(
lm3
 ? 3 : 0, 
idx
),

1088 
	`»g_b
(
¤c
));

1092 ià(
	`WARN_ON_ONCE
(
lm3
 && 
idx
 > 
RE_REG_LM_IDX_MAX
))

1093  -
EOPNOTSUPP
;

1095 
d¡_by‹
 = 
off
 % 4;

1097 
mask
 = (1 << 
size
) - 1;

1098 
mask
 <<ð
d¡_by‹
;

1100 ià(
	`WARN_ON_ONCE
(
mask
 > 0xf))

1101  -
EOPNOTSUPP
;

1103 
shf
 = 
	`abs
(
¤c_by‹
 - 
d¡_by‹
) * 8;

1104 ià(
¤c_by‹
 =ð
d¡_by‹
) {

1105 
sc
 = 
SHF_SC_NONE
;

1106 } ià(
¤c_by‹
 < 
d¡_by‹
) {

1107 
shf
 = 32 - shf;

1108 
sc
 = 
SHF_SC_L_SHF
;

1110 
sc
 = 
SHF_SC_R_SHF
;

1116 ià(
idx
 <ð
RE_REG_LM_IDX_MAX
) {

1117 
»g
 = 
	`»g_lm
(
lm3
 ? 3 : 0, 
idx
);

1119 
»g
 = 
	`imm_a
(
nå_´og
);

1123 ià(
fœ¡
 || 
Ï¡
)

1124 
	`w½_mov
(
nå_´og
, 
»g
, 
	`»g_lm
(0, 
idx
));

1127 
	`em™_ld_f›ld
(
nå_´og
, 
»g
, 
mask
, 
	`»g_b
(
¤c
), 
sc
, 
shf
);

1129 ià(
Ãw_g´
 || 
Ï¡
) {

1130 ià(
idx
 > 
RE_REG_LM_IDX_MAX
)

1131 
	`w½_mov
(
nå_´og
, 
	`»g_lm
(0, 
idx
), 
»g
);

1132 ià(
should_šc
)

1133 
	`w½_mov
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_lm_šc
(3));

1137 
	}
}

1140 
	$mem_Ý_¡ack
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

1141 
size
, 
±r_off
, 
u8
 
g´
, u8 
±r_g´
,

1142 
boÞ
 
þr_g´
, 
lmem_¡•
 
¡•
)

1144 
s32
 
off
 = 
nå_´og
->
¡ack_äame_d•th
 + 
m‘a
->
š¢
.ofà+ 
±r_off
;

1145 
boÞ
 
fœ¡
 = 
Œue
, 
Ï¡
;

1146 
boÞ
 
Ãeds_šc
 = 
çl£
;

1147 
sw»g
 
¡ack_off_»g
;

1148 
u8
 
´ev_g´
 = 255;

1149 
u32
 
g´_by‹
 = 0;

1150 
boÞ
 
lm3
 = 
Œue
;

1151 
»t
;

1153 ià(
m‘a
->
±r_nÙ_cÚ¡
 ||

1154 
m‘a
->
æags
 & 
FLAG_INSN_PTR_CALLER_STACK_FRAME
) {

1159 
¡ack_off_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
š¢
.
off
,

1160 
	`¡ack_imm
(
nå_´og
));

1162 
	`em™_®u
(
nå_´og
, 
	`imm_b
(nfp_prog),

1163 
	`»g_a
(
±r_g´
), 
ALU_OP_ADD
, 
¡ack_off_»g
);

1165 
Ãeds_šc
 = 
Œue
;

1166 } ià(
off
 + 
size
 <= 64) {

1168 
lm3
 = 
çl£
;

1169 } ià(
	`round_down
(
off
, 32è=ðround_down(ofà+ 
size
 - 1, 32)) {

1176 
¡ack_off_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
	`round_down
(
off
, 32),

1177 
	`¡ack_imm
(
nå_´og
));

1178 
	`em™_®u
(
nå_´og
, 
	`imm_b
(nfp_prog),

1179 
	`¡ack_»g
(
nå_´og
), 
ALU_OP_ADD
, 
¡ack_off_»g
);

1181 
off
 %= 32;

1183 
¡ack_off_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
	`round_down
(
off
, 4),

1184 
	`¡ack_imm
(
nå_´og
));

1186 
	`em™_®u
(
nå_´og
, 
	`imm_b
(nfp_prog),

1187 
	`¡ack_»g
(
nå_´og
), 
ALU_OP_ADD
, 
¡ack_off_»g
);

1189 
Ãeds_šc
 = 
Œue
;

1191 ià(
lm3
) {

1192 
	`em™_c¤_wr
(
nå_´og
, 
	`imm_b
Òå_´og), 
NFP_CSR_ACT_LM_ADDR3
);

1194 
	`w½_nÝs
(
nå_´og
, 
þr_g´
 && 
size
 < 8 ? 2 : 3);

1197 ià(
þr_g´
 && 
size
 < 8)

1198 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
g´
 + 1), 0);

1200 
size
) {

1201 
u32
 
¦iû_’d
;

1202 
u8
 
¦iû_size
;

1204 
¦iû_size
 = 
	`mš
(
size
, 4 - 
g´_by‹
);

1205 
¦iû_’d
 = 
	`mš
(
off
 + 
¦iû_size
, 
	`round_up
(off + 1, 4));

1206 
¦iû_size
 = 
¦iû_’d
 - 
off
;

1208 
Ï¡
 = 
¦iû_size
 =ð
size
;

1210 ià(
Ãeds_šc
)

1211 
off
 %= 4;

1213 
»t
 = 
	`¡•
(
nå_´og
, 
g´
, 
g´_by‹
, 
off
, 
¦iû_size
,

1214 
fœ¡
, 
g´
 !ð
´ev_g´
, 
Ï¡
, 
lm3
, 
Ãeds_šc
);

1215 ià(
»t
)

1216  
»t
;

1218 
´ev_g´
 = 
g´
;

1219 
fœ¡
 = 
çl£
;

1221 
g´_by‹
 +ð
¦iû_size
;

1222 ià(
g´_by‹
 >= 4) {

1223 
g´_by‹
 -= 4;

1224 
g´
++;

1227 
size
 -ð
¦iû_size
;

1228 
off
 +ð
¦iû_size
;

1232 
	}
}

1235 
	$w½_®u_imm
(
nå_´og
 *nå_´og, 
u8
 
d¡
, 
®u_Ý
‡lu_Ý, 
u32
 
imm
)

1237 
sw»g
 
tmp_»g
;

1239 ià(
®u_Ý
 =ð
ALU_OP_AND
) {

1240 ià(!
imm
)

1241 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 0);

1242 ià(!
imm
 || !~imm)

1245 ià(
®u_Ý
 =ð
ALU_OP_OR
) {

1246 ià(!~
imm
)

1247 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
), ~0U);

1248 ià(!
imm
 || !~imm)

1251 ià(
®u_Ý
 =ð
ALU_OP_XOR
) {

1252 ià(!~
imm
)

1253 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(),

1254 
ALU_OP_NOT
, 
	`»g_b
(
d¡
));

1255 ià(!
imm
 || !~imm)

1259 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
, 
	`imm_b
(nfp_prog));

1260 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_a
(d¡), 
®u_Ý
, 
tmp_»g
);

1261 
	}
}

1264 
	$w½_®u64_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

1265 
®u_Ý
‡lu_Ý, 
boÞ
 
sk
)

1267 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1268 
u64
 
imm
 = 
š¢
->imm;

1270 ià(
sk
) {

1271 
m‘a
->
æags
 |ð
FLAG_INSN_SKIP_NOOP
;

1275 
	`w½_®u_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2, 
®u_Ý
, 
imm
 & ~0U);

1276 
	`w½_®u_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2 + 1, 
®u_Ý
, 
imm
 >> 32);

1279 
	}
}

1282 
	$w½_®u64_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

1283 
®u_Ý
‡lu_op)

1285 
u8
 
d¡
 = 
m‘a
->
š¢
.
d¡_»g
 * 2, 
¤c
 = m‘a->š¢.
¤c_»g
 * 2;

1287 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_a
(d¡), 
®u_Ý
, 
	`»g_b
(
¤c
));

1288 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1),

1289 
	`»g_a
(
d¡
 + 1), 
®u_Ý
, 
	`»g_b
(
¤c
 + 1));

1292 
	}
}

1295 
	$w½_®u32_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

1296 
®u_Ý
‡lu_op)

1298 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1300 
	`w½_®u_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2, 
®u_Ý
, in¢->
imm
);

1301 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2 + 1), 0);

1304 
	}
}

1307 
	$w½_®u32_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

1308 
®u_Ý
‡lu_op)

1310 
u8
 
d¡
 = 
m‘a
->
š¢
.
d¡_»g
 * 2, 
¤c
 = m‘a->š¢.
¤c_»g
 * 2;

1312 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_a
(d¡), 
®u_Ý
, 
	`»g_b
(
¤c
));

1313 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2 + 1), 0);

1316 
	}
}

1319 
	$w½_‹¡_»g_Úe
(
nå_´og
 *nå_´og, 
u8
 
d¡
, 
®u_Ý
‡lu_Ý, u8 
¤c
,

1320 
br_mask
 br_mask, 
u16
 
off
)

1322 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
d¡
), 
®u_Ý
, 
	`»g_b
(
¤c
));

1323 
	`em™_br
(
nå_´og
, 
br_mask
, 
off
, 0);

1324 
	}
}

1327 
	$w½_‹¡_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

1328 
®u_Ý
‡lu_Ý, 
br_mask
 br_mask)

1330 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1332 
	`w½_‹¡_»g_Úe
(
nå_´og
, 
š¢
->
d¡_»g
 * 2, 
®u_Ý
,

1333 
š¢
->
¤c_»g
 * 2, 
br_mask
, in¢->
off
);

1334 ià(
	`is_mbpf_jmp64
(
m‘a
))

1335 
	`w½_‹¡_»g_Úe
(
nå_´og
, 
š¢
->
d¡_»g
 * 2 + 1, 
®u_Ý
,

1336 
š¢
->
¤c_»g
 * 2 + 1, 
br_mask
, in¢->
off
);

1339 
	}
}

1341 cÚ¡ 
	sjmp_code_m­
 {

1342 
br_mask
 
	mbr_mask
;

1343 
boÞ
 
	msw­
;

1344 } 
	gjmp_code_m­
[] = {

1345 [
BPF_JGT
 >> 4] = { 
BR_BLO
, 
Œue
 },

1346 [
BPF_JGE
 >> 4] = { 
BR_BHS
, 
çl£
 },

1347 [
BPF_JLT
 >> 4] = { 
BR_BLO
, 
çl£
 },

1348 [
BPF_JLE
 >> 4] = { 
BR_BHS
, 
Œue
 },

1349 [
BPF_JSGT
 >> 4] = { 
BR_BLT
, 
Œue
 },

1350 [
BPF_JSGE
 >> 4] = { 
BR_BGE
, 
çl£
 },

1351 [
BPF_JSLT
 >> 4] = { 
BR_BLT
, 
çl£
 },

1352 [
BPF_JSLE
 >> 4] = { 
BR_BGE
, 
Œue
 },

1355 cÚ¡ 
jmp_code_m­
 *
	$nå_jmp_code_g‘
(
nå_š¢_m‘a
 *
m‘a
)

1357 
Ý
;

1359 
Ý
 = 
	`BPF_OP
(
m‘a
->
š¢
.
code
) >> 4;

1361 ià(
	`WARN_ONCE
(
Ý
 >ð
	`ARRAY_SIZE
(
jmp_code_m­
) ||

1362 !
jmp_code_m­
[
Ý
].
br_mask
,

1364  
NULL
;

1366  &
jmp_code_m­
[
Ý
];

1367 
	}
}

1369 
	$cmp_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1371 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1372 
u64
 
imm
 = 
š¢
->imm;

1373 cÚ¡ 
jmp_code_m­
 *
code
;

1374 
®u_Ý
‡lu_Ý, 
ÿ¼y_Ý
;

1375 
u8
 
»g
 = 
š¢
->
d¡_»g
 * 2;

1376 
sw»g
 
tmp_»g
;

1378 
code
 = 
	`nå_jmp_code_g‘
(
m‘a
);

1379 ià(!
code
)

1380  -
EINVAL
;

1382 
®u_Ý
 = 
m‘a
->
jump_Ãg_Ý
 ? 
ALU_OP_ADD
 : 
ALU_OP_SUB
;

1383 
ÿ¼y_Ý
 = 
m‘a
->
jump_Ãg_Ý
 ? 
ALU_OP_ADD_C
 : 
ALU_OP_SUB_C
;

1385 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
 & ~0U, 
	`imm_b
(nfp_prog));

1386 ià(!
code
->
sw­
)

1387 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
»g
), 
®u_Ý
, 
tmp_»g
);

1389 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
tmp_»g
, 
®u_Ý
, 
	`»g_a
(
»g
));

1391 ià(
	`is_mbpf_jmp64
(
m‘a
)) {

1392 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
 >> 32, 
	`imm_b
(nfp_prog));

1393 ià(!
code
->
sw­
)

1394 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

1395 
	`»g_a
(
»g
 + 1), 
ÿ¼y_Ý
, 
tmp_»g
);

1397 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

1398 
tmp_»g
, 
ÿ¼y_Ý
, 
	`»g_a
(
»g
 + 1));

1401 
	`em™_br
(
nå_´og
, 
code
->
br_mask
, 
š¢
->
off
, 0);

1404 
	}
}

1406 
	$cmp_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1408 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1409 cÚ¡ 
jmp_code_m­
 *
code
;

1410 
u8
 
¬eg
, 
b»g
;

1412 
code
 = 
	`nå_jmp_code_g‘
(
m‘a
);

1413 ià(!
code
)

1414  -
EINVAL
;

1416 
¬eg
 = 
š¢
->
d¡_»g
 * 2;

1417 
b»g
 = 
š¢
->
¤c_»g
 * 2;

1419 ià(
code
->
sw­
) {

1420 
¬eg
 ^ð
b»g
;

1421 
b»g
 ^ð
¬eg
;

1422 
¬eg
 ^ð
b»g
;

1425 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¬eg
), 
ALU_OP_SUB
, 
	`»g_b
(
b»g
));

1426 ià(
	`is_mbpf_jmp64
(
m‘a
))

1427 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

1428 
	`»g_a
(
¬eg
 + 1), 
ALU_OP_SUB_C
, 
	`»g_b
(
b»g
 + 1));

1429 
	`em™_br
(
nå_´og
, 
code
->
br_mask
, 
š¢
->
off
, 0);

1432 
	}
}

1434 
	$w½_’d32
(
nå_´og
 *nå_´og, 
sw»g
 
»g_š
, 
u8
 
g´_out
)

1436 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_bÙh
(
g´_out
), 0xf, 
»g_š
,

1437 
SHF_SC_R_ROT
, 8);

1438 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_bÙh
(
g´_out
), 0x5, 
	`»g_a
(gpr_out),

1439 
SHF_SC_R_ROT
, 16);

1440 
	}
}

1443 
	$w½_mul_u32
(
nå_´og
 *nå_´og, 
sw»g
 
d¡_hi
, sw»g 
d¡_lo
, sw»g 
Ìeg
,

1444 
sw»g
 
¼eg
, 
boÞ
 
g’_high_h®f
)

1446 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_START
, 
MUL_STEP_NONE
, 
¼eg
);

1447 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_STEP_32x32
, 
MUL_STEP_1
, 
¼eg
);

1448 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_STEP_32x32
, 
MUL_STEP_2
, 
¼eg
);

1449 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_STEP_32x32
, 
MUL_STEP_3
, 
¼eg
);

1450 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_STEP_32x32
, 
MUL_STEP_4
, 
¼eg
);

1451 
	`em™_mul
(
nå_´og
, 
d¡_lo
, 
MUL_TYPE_STEP_32x32
, 
MUL_LAST
, 
	`»g_nÚe
());

1452 ià(
g’_high_h®f
)

1453 
	`em™_mul
(
nå_´og
, 
d¡_hi
, 
MUL_TYPE_STEP_32x32
, 
MUL_LAST_2
,

1454 
	`»g_nÚe
());

1456 
	`w½_immed
(
nå_´og
, 
d¡_hi
, 0);

1457 
	}
}

1460 
	$w½_mul_u16
(
nå_´og
 *nå_´og, 
sw»g
 
d¡_hi
, sw»g 
d¡_lo
, sw»g 
Ìeg
,

1461 
sw»g
 
¼eg
)

1463 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_START
, 
MUL_STEP_NONE
, 
¼eg
);

1464 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_STEP_16x16
, 
MUL_STEP_1
, 
¼eg
);

1465 
	`em™_mul
(
nå_´og
, 
Ìeg
, 
MUL_TYPE_STEP_16x16
, 
MUL_STEP_2
, 
¼eg
);

1466 
	`em™_mul
(
nå_´og
, 
d¡_lo
, 
MUL_TYPE_STEP_16x16
, 
MUL_LAST
, 
	`»g_nÚe
());

1467 
	}
}

1470 
	$w½_mul
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

1471 
boÞ
 
g’_high_h®f
, boÞ 
rÝnd_äom_»g
)

1473 
sw»g
 
muÉl›r
, 
muÉliÿnd
, 
d¡_hi
, 
d¡_lo
;

1474 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1475 
u32
 
lÝnd_max
, 
rÝnd_max
;

1476 
u8
 
d¡_»g
;

1478 
d¡_»g
 = 
š¢
->dst_reg;

1479 
muÉliÿnd
 = 
	`»g_a
(
d¡_»g
 * 2);

1480 
d¡_hi
 = 
	`»g_bÙh
(
d¡_»g
 * 2 + 1);

1481 
d¡_lo
 = 
	`»g_bÙh
(
d¡_»g
 * 2);

1482 
lÝnd_max
 = 
m‘a
->
umax_d¡
;

1483 ià(
rÝnd_äom_»g
) {

1484 
muÉl›r
 = 
	`»g_b
(
š¢
->
¤c_»g
 * 2);

1485 
rÝnd_max
 = 
m‘a
->
umax_¤c
;

1487 
u32
 
imm
 = 
š¢
->imm;

1489 
muÉl›r
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
, 
	`imm_b
(nfp_prog));

1490 
rÝnd_max
 = 
imm
;

1492 ià(
lÝnd_max
 > 
U16_MAX
 || 
rÝnd_max
 > U16_MAX)

1493 
	`w½_mul_u32
(
nå_´og
, 
d¡_hi
, 
d¡_lo
, 
muÉliÿnd
, 
muÉl›r
,

1494 
g’_high_h®f
);

1496 
	`w½_mul_u16
(
nå_´og
, 
d¡_hi
, 
d¡_lo
, 
muÉliÿnd
, 
muÉl›r
);

1499 
	}
}

1501 
	$w½_div_imm
(
nå_´og
 *nå_´og, 
u8
 
d¡
, 
u64
 
imm
)

1503 
sw»g
 
d¡_bÙh
 = 
	`»g_bÙh
(
d¡
), 
d¡_a
 = 
	`»g_a
(d¡), 
d¡_b
 =„eg_a(dst);

1504 
»croÿl_v®ue_adv
 
rv®ue
;

1505 
u8
 
´e_shiá
, 
exp
;

1506 
sw»g
 
magic
;

1508 ià(
imm
 > 
U32_MAX
) {

1509 
	`w½_immed
(
nå_´og
, 
d¡_bÙh
, 0);

1524 ià(
imm
 > 1U << 31) {

1525 
sw»g
 
tmp_b
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
, 
	`imm_b
(nfp_prog));

1527 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
d¡_a
, 
ALU_OP_SUB
, 
tmp_b
);

1528 
	`w½_immed
(
nå_´og
, 
	`imm_a
(nfp_prog), 0);

1529 
	`em™_®u
(
nå_´og
, 
d¡_bÙh
, 
	`imm_a
Òå_´og), 
ALU_OP_ADD_C
,

1530 
	`»g_imm
(0));

1534 
rv®ue
 = 
	`»croÿl_v®ue_adv
(
imm
, 32);

1535 
exp
 = 
rv®ue
.exp;

1536 ià(
rv®ue
.
is_wide_m
 && !(
imm
 & 1)) {

1537 
´e_shiá
 = 
	`æs
(
imm
 & -imm) - 1;

1538 
rv®ue
 = 
	`»croÿl_v®ue_adv
(
imm
 >> 
´e_shiá
, 32 -…re_shift);

1540 
´e_shiá
 = 0;

1542 
magic
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
rv®ue
.
m
, 
	`imm_b
(nfp_prog));

1543 ià(
imm
 =ð1U << 
exp
) {

1544 
	`em™_shf
(
nå_´og
, 
d¡_bÙh
, 
	`»g_nÚe
(), 
SHF_OP_NONE
, 
d¡_b
,

1545 
SHF_SC_R_SHF
, 
exp
);

1546 } ià(
rv®ue
.
is_wide_m
) {

1547 
	`w½_mul_u32
(
nå_´og
, 
	`imm_bÙh
Òå_´og), 
	`»g_nÚe
(), 
d¡_a
,

1548 
magic
, 
Œue
);

1549 
	`em™_®u
(
nå_´og
, 
d¡_bÙh
, 
d¡_a
, 
ALU_OP_SUB
,

1550 
	`imm_b
(
nå_´og
));

1551 
	`em™_shf
(
nå_´og
, 
d¡_bÙh
, 
	`»g_nÚe
(), 
SHF_OP_NONE
, 
d¡_b
,

1552 
SHF_SC_R_SHF
, 1);

1553 
	`em™_®u
(
nå_´og
, 
d¡_bÙh
, 
d¡_a
, 
ALU_OP_ADD
,

1554 
	`imm_b
(
nå_´og
));

1555 
	`em™_shf
(
nå_´og
, 
d¡_bÙh
, 
	`»g_nÚe
(), 
SHF_OP_NONE
, 
d¡_b
,

1556 
SHF_SC_R_SHF
, 
rv®ue
.
sh
 - 1);

1558 ià(
´e_shiá
)

1559 
	`em™_shf
(
nå_´og
, 
d¡_bÙh
, 
	`»g_nÚe
(), 
SHF_OP_NONE
,

1560 
d¡_b
, 
SHF_SC_R_SHF
, 
´e_shiá
);

1561 
	`w½_mul_u32
(
nå_´og
, 
d¡_bÙh
, 
	`»g_nÚe
(), 
d¡_a
, 
magic
, 
Œue
);

1562 
	`em™_shf
(
nå_´og
, 
d¡_bÙh
, 
	`»g_nÚe
(), 
SHF_OP_NONE
,

1563 
d¡_b
, 
SHF_SC_R_SHF
, 
rv®ue
.
sh
);

1567 
	}
}

1569 
	$adju¡_h—d
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1571 
sw»g
 
tmp
 = 
	`imm_a
(
nå_´og
), 
tmp_Ën
 = 
	`imm_b
(nfp_prog);

1572 
nå_bpf_ÿp_adju¡_h—d
 *
adju¡_h—d
;

1573 
u32
 
»t_ešv®
, 
’d
;

1575 
adju¡_h—d
 = &
nå_´og
->
bpf
->adjust_head;

1578 ià(
nå_´og
->
adju¡_h—d_loÿtiÚ
 !ð
UINT_MAX
) {

1579 ià(
	`WARN_ON_ONCE
(
nå_´og
->
adju¡_h—d_loÿtiÚ
 !ð
m‘a
->
n
))

1580  -
EINVAL
;

1582 
	`em™_®u
(
nå_´og
, 
	`µŒ_»g
(nfp_prog),

1583 
	`»g_a
(2 * 2), 
ALU_OP_ADD
, 
	`µŒ_»g
(
nå_´og
));

1584 
	`em™_®u
(
nå_´og
, 
	`¶’_»g
(nfp_prog),

1585 
	`¶’_»g
(
nå_´og
), 
ALU_OP_SUB
, 
	`»g_a
(2 * 2));

1586 
	`em™_®u
(
nå_´og
, 
	`pv_Ën
(nfp_prog),

1587 
	`pv_Ën
(
nå_´og
), 
ALU_OP_SUB
, 
	`»g_a
(2 * 2));

1589 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(0), 0);

1590 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(1), 0);

1599 
»t_ešv®
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 14;

1600 
’d
 = 
»t_ešv®
 + 2;

1603 
	`em™_®u
(
nå_´og
, 
tmp
,

1604 
	`»g_a
(2 * 2), 
ALU_OP_ADD_2B
, 
	`µŒ_»g
(
nå_´og
));

1607 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

1608 
tmp
, 
ALU_OP_SUB
, 
	`»g_imm
(
adju¡_h—d
->
off_mš
));

1609 
	`em™_br
(
nå_´og
, 
BR_BLO
, 
»t_ešv®
, 0);

1610 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

1611 
	`»g_imm
(
adju¡_h—d
->
off_max
), 
ALU_OP_SUB
, 
tmp
);

1612 
	`em™_br
(
nå_´og
, 
BR_BLO
, 
»t_ešv®
, 0);

1615 
	`em™_®u
(
nå_´og
, 
tmp_Ën
,

1616 
	`¶’_»g
(
nå_´og
), 
ALU_OP_SUB
, 
	`»g_a
(2 * 2));

1617 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

1618 
tmp_Ën
, 
ALU_OP_SUB
, 
	`»g_imm
(
ETH_HLEN
));

1619 
	`em™_br
(
nå_´og
, 
BR_BMI
, 
»t_ešv®
, 0);

1622 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(0), 0);

1623 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(1), 0);

1626 
	`em™_ld_f›ld
(
nå_´og
, 
	`µŒ_»g
Òå_´og), 0x3, 
tmp
, 
SHF_SC_NONE
, 0);

1629 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
’d
, 2);

1631 
	`em™_®u
(
nå_´og
, 
	`¶’_»g
(nfp_prog),

1632 
	`¶’_»g
(
nå_´og
), 
ALU_OP_SUB
, 
	`»g_a
(2 * 2));

1633 
	`em™_®u
(
nå_´og
, 
	`pv_Ën
(nfp_prog),

1634 
	`pv_Ën
(
nå_´og
), 
ALU_OP_SUB
, 
	`»g_a
(2 * 2));

1637 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
»t_ešv®
))

1638  -
EINVAL
;

1640 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(0), -22);

1641 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(1), ~0);

1643 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
’d
))

1644  -
EINVAL
;

1647 
	}
}

1649 
	$adju¡_ž
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1651 
u32
 
»t_ešv®
, 
’d
;

1652 
sw»g
 
¶’
, 
d–
;

1654 
	`BUILD_BUG_ON
(
	`¶’_»g
(
nå_´og
è!ð
	`»g_b
(
STATIC_REG_PKT_LEN
));

1656 
¶’
 = 
	`imm_a
(
nå_´og
);

1657 
d–
 = 
	`»g_a
(2 * 2);

1659 
»t_ešv®
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 9;

1660 
’d
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 11;

1663 
	`em™_®u
(
nå_´og
, 
¶’
, 
	`¶’_»g
Òå_´og), 
ALU_OP_ADD
, 
d–
);

1667 
	`em™_br
(
nå_´og
, 
BR_BCC
, 
»t_ešv®
, 0);

1670 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
¶’
, 
ALU_OP_SUB
, 
	`»g_imm
(
ETH_HLEN
));

1671 
	`em™_br
(
nå_´og
, 
BR_BMI
, 
»t_ešv®
, 0);

1673 
	`em™_®u
(
nå_´og
, 
	`¶’_»g
(nfp_prog),

1674 
	`¶’_»g
(
nå_´og
), 
ALU_OP_ADD
, 
d–
);

1675 
	`em™_®u
(
nå_´og
, 
	`pv_Ën
(nfp_prog),

1676 
	`pv_Ën
(
nå_´og
), 
ALU_OP_ADD
, 
d–
);

1678 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
’d
, 2);

1679 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(0), 0);

1680 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(1), 0);

1682 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
»t_ešv®
))

1683  -
EINVAL
;

1685 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(0), -22);

1686 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(1), ~0);

1688 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
’d
))

1689  -
EINVAL
;

1692 
	}
}

1695 
	$m­_ÿÎ_¡ack_commÚ
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1697 
boÞ
 
lßd_lm_±r
;

1698 
u32
 
»t_tgt
;

1699 
s64
 
lm_off
;

1702 
lm_off
 = 
nå_´og
->
¡ack_äame_d•th
;

1703 
lm_off
 +ð
m‘a
->
¬g2
.
»g
.
v¬_off
.
v®ue
 + m‘a->¬g2.»g.
off
;

1704 
lßd_lm_±r
 = 
m‘a
->
¬g2
.
v¬_off
 || 
lm_off
;

1707 ià(
lßd_lm_±r
)

1708 
	`em™_c¤_wr
(
nå_´og
, 
	`»g_b
(2 * 2), 
NFP_CSR_ACT_LM_ADDR0
);

1709 ià(
m‘a
->
func_id
 =ð
BPF_FUNC_m­_upd©e_–em
)

1710 
	`em™_c¤_wr
(
nå_´og
, 
	`»g_b
(3 * 2), 
NFP_CSR_ACT_LM_ADDR2
);

1712 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
 + 
m‘a
->
func_id
,

1713 2, 
RELO_BR_HELPER
);

1714 
»t_tgt
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 2;

1717 
	`w½_mov
(
nå_´og
, 
	`»g_a
(0),„eg_a(2));

1720 
	`w½_immed_»lo
(
nå_´og
, 
	`»g_b
(0), 
»t_tgt
, 
RELO_IMMED_REL
);

1722 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
»t_tgt
))

1723  -
EINVAL
;

1726 ià(!
lßd_lm_±r
)

1729 
	`em™_c¤_wr
(
nå_´og
, 
	`¡ack_»g
Òå_´og), 
NFP_CSR_ACT_LM_ADDR0
);

1730 
	`w½_nÝs
(
nå_´og
, 3);

1733 
	}
}

1736 
	$nå_g‘_´ªdom_u32
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1738 
	`__em™_c¤_rd
(
nå_´og
, 
NFP_CSR_PSEUDO_RND_NUM
);

1740 
	`em™_immed
(
nå_´og
, 
	`»g_bÙh
(0), 0,

1741 
IMMED_WIDTH_ALL
, 
çl£
, 
IMMED_SHIFT_0B
);

1742 
	`em™_immed
(
nå_´og
, 
	`»g_bÙh
(1), 0,

1743 
IMMED_WIDTH_ALL
, 
çl£
, 
IMMED_SHIFT_0B
);

1745 
	}
}

1748 
	$nå_³rf_ev’t_ouut
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1750 
sw»g
 
±r_ty³
;

1751 
u32
 
»t_tgt
;

1753 
±r_ty³
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
¬g1
.
ty³
, 
	`imm_a
(nfp_prog));

1755 
»t_tgt
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 3;

1757 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
 + 
m‘a
->
func_id
,

1758 2, 
RELO_BR_HELPER
);

1761 
	`w½_mov
(
nå_´og
, 
	`»g_a
(1), 
±r_ty³
);

1764 
	`w½_immed_»lo
(
nå_´og
, 
	`»g_b
(0), 
»t_tgt
, 
RELO_IMMED_REL
);

1766 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
»t_tgt
))

1767  -
EINVAL
;

1770 
	}
}

1773 
	$nå_queue_£Ëù
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1775 
u32
 
jmp_tgt
;

1777 
jmp_tgt
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 5;

1780 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
m‘a
->
š¢
.
¤c_»g
 * 2),

1781 
ALU_OP_AND_NOT_B
, 
	`»g_imm
(0xff));

1782 
	`em™_br
(
nå_´og
, 
BR_BEQ
, 
jmp_tgt
, 2);

1785 
	`em™_shf
(
nå_´og
, 
	`pv_q£l_£t
(nfp_prog),

1786 
	`pv_q£l_£t
(
nå_´og
), 
SHF_OP_OR
, 
	`»g_imm
(1),

1787 
SHF_SC_L_SHF
, 
PKT_VEL_QSEL_SET_BIT
);

1788 
	`em™_ld_f›ld
(
nå_´og
,

1789 
	`pv_q£l_v®
(
nå_´og
), 0x1, 
	`»g_b
(
m‘a
->
š¢
.
¤c_»g
 * 2),

1790 
SHF_SC_NONE
, 0);

1794 
	`em™_ld_f›ld
(
nå_´og
,

1795 
	`pv_q£l_v®
(
nå_´og
), 0x1, 
	`»g_imm
(
NFP_NET_RXR_MAX
),

1796 
SHF_SC_NONE
, 0);

1798 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
jmp_tgt
))

1799  -
EINVAL
;

1802 
	}
}

1805 
	$mov_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1807 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1808 
u8
 
d¡
 = 
š¢
->
d¡_»g
 * 2;

1809 
u8
 
¤c
 = 
š¢
->
¤c_»g
 * 2;

1811 ià(
š¢
->
¤c_»g
 =ð
BPF_REG_10
) {

1812 
sw»g
 
¡ack_d•th_»g
;

1814 
¡ack_d•th_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
,

1815 
nå_´og
->
¡ack_äame_d•th
,

1816 
	`¡ack_imm
(
nå_´og
));

1817 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`¡ack_»g
(nfp_prog),

1818 
ALU_OP_ADD
, 
¡ack_d•th_»g
);

1819 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

1821 
	`w½_»g_mov
(
nå_´og
, 
d¡
, 
¤c
);

1822 
	`w½_»g_mov
(
nå_´og
, 
d¡
 + 1, 
¤c
 + 1);

1826 
	}
}

1828 
	$mov_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1830 
u64
 
imm
 = 
m‘a
->
š¢
.imm;

1832 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2), 
imm
 & ~0U);

1833 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2 + 1), 
imm
 >> 32);

1836 
	}
}

1838 
	$xÜ_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1840  
	`w½_®u64_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_XOR
);

1841 
	}
}

1843 
	$xÜ_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1845  
	`w½_®u64_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_XOR
, !m‘a->
š¢
.
imm
);

1846 
	}
}

1848 
	$ªd_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1850  
	`w½_®u64_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_AND
);

1851 
	}
}

1853 
	$ªd_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1855  
	`w½_®u64_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_AND
, !~m‘a->
š¢
.
imm
);

1856 
	}
}

1858 
	$Ü_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1860  
	`w½_®u64_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_OR
);

1861 
	}
}

1863 
	$Ü_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1865  
	`w½_®u64_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_OR
, !m‘a->
š¢
.
imm
);

1866 
	}
}

1868 
	$add_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1870 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1872 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2),

1873 
	`»g_a
(
š¢
->
d¡_»g
 * 2), 
ALU_OP_ADD
,

1874 
	`»g_b
(
š¢
->
¤c_»g
 * 2));

1875 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2 + 1),

1876 
	`»g_a
(
š¢
->
d¡_»g
 * 2 + 1), 
ALU_OP_ADD_C
,

1877 
	`»g_b
(
š¢
->
¤c_»g
 * 2 + 1));

1880 
	}
}

1882 
	$add_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1884 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1885 
u64
 
imm
 = 
š¢
->imm;

1887 
	`w½_®u_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2, 
ALU_OP_ADD
, 
imm
 & ~0U);

1888 
	`w½_®u_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2 + 1, 
ALU_OP_ADD_C
, 
imm
 >> 32);

1891 
	}
}

1893 
	$sub_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1895 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1897 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2),

1898 
	`»g_a
(
š¢
->
d¡_»g
 * 2), 
ALU_OP_SUB
,

1899 
	`»g_b
(
š¢
->
¤c_»g
 * 2));

1900 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2 + 1),

1901 
	`»g_a
(
š¢
->
d¡_»g
 * 2 + 1), 
ALU_OP_SUB_C
,

1902 
	`»g_b
(
š¢
->
¤c_»g
 * 2 + 1));

1905 
	}
}

1907 
	$sub_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1909 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1910 
u64
 
imm
 = 
š¢
->imm;

1912 
	`w½_®u_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2, 
ALU_OP_SUB
, 
imm
 & ~0U);

1913 
	`w½_®u_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2 + 1, 
ALU_OP_SUB_C
, 
imm
 >> 32);

1916 
	}
}

1918 
	$mul_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1920  
	`w½_mul
(
nå_´og
, 
m‘a
, 
Œue
,rue);

1921 
	}
}

1923 
	$mul_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1925  
	`w½_mul
(
nå_´og
, 
m‘a
, 
Œue
, 
çl£
);

1926 
	}
}

1928 
	$div_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1930 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1932  
	`w½_div_imm
(
nå_´og
, 
š¢
->
d¡_»g
 * 2, in¢->
imm
);

1933 
	}
}

1935 
	$div_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1940  
	`w½_div_imm
(
nå_´og
, 
m‘a
->
š¢
.
d¡_»g
 * 2, m‘a->
umš_¤c
);

1941 
	}
}

1943 
	$Ãg_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1945 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1947 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2), 
	`»g_imm
(0),

1948 
ALU_OP_SUB
, 
	`»g_b
(
š¢
->
d¡_»g
 * 2));

1949 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2 + 1), 
	`»g_imm
(0),

1950 
ALU_OP_SUB_C
, 
	`»g_b
(
š¢
->
d¡_»g
 * 2 + 1));

1953 
	}
}

1965 
	$__shl_imm64
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
shiá_amt
)

1967 ià(!
shiá_amt
)

1970 ià(
shiá_amt
 < 32) {

1971 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_a
(dst + 1),

1972 
SHF_OP_NONE
, 
	`»g_b
(
d¡
), 
SHF_SC_R_DSHF
,

1973 32 - 
shiá_amt
);

1974 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

1975 
	`»g_b
(
d¡
), 
SHF_SC_L_SHF
, 
shiá_amt
);

1976 } ià(
shiá_amt
 == 32) {

1977 
	`w½_»g_mov
(
nå_´og
, 
d¡
 + 1, dst);

1978 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 0);

1979 } ià(
shiá_amt
 > 32) {

1980 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

1981 
	`»g_b
(
d¡
), 
SHF_SC_L_SHF
, 
shiá_amt
 - 32);

1982 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 0);

1986 
	}
}

1988 
	$shl_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

1990 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

1991 
u8
 
d¡
 = 
š¢
->
d¡_»g
 * 2;

1993  
	`__shl_imm64
(
nå_´og
, 
d¡
, 
š¢
->
imm
);

1994 
	}
}

1996 
	$shl_»g64_É32_high
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

1998 
	`em™_®u
(
nå_´og
, 
	`imm_bÙh
Òå_´og), 
	`»g_imm
(32), 
ALU_OP_SUB
,

1999 
	`»g_b
(
¤c
));

2000 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`imm_a
Òå_´og), 
ALU_OP_OR
, 
	`»g_imm
(0));

2001 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_a
(d¡ + 1), 
SHF_OP_NONE
,

2002 
	`»g_b
(
d¡
), 
SHF_SC_R_DSHF
);

2003 
	}
}

2006 
	$shl_»g64_É32_low
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2008 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_imm
(0));

2009 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2010 
	`»g_b
(
d¡
), 
SHF_SC_L_SHF
);

2011 
	}
}

2013 
	$shl_»g64_É32
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2015 
	`shl_»g64_É32_high
(
nå_´og
, 
d¡
, 
¤c
);

2016 
	`shl_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2017 
	}
}

2019 
	$shl_»g64_ge32
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2021 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_imm
(0));

2022 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2023 
	`»g_b
(
d¡
), 
SHF_SC_L_SHF
);

2024 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 0);

2025 
	}
}

2027 
	$shl_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2029 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2030 
u64
 
umš
, 
umax
;

2031 
u8
 
d¡
, 
¤c
;

2033 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2034 
umš
 = 
m‘a
->
umš_¤c
;

2035 
umax
 = 
m‘a
->
umax_¤c
;

2036 ià(
umš
 =ð
umax
)

2037  
	`__shl_imm64
(
nå_´og
, 
d¡
, 
umš
);

2039 
¤c
 = 
š¢
->
¤c_»g
 * 2;

2040 ià(
umax
 < 32) {

2041 
	`shl_»g64_É32
(
nå_´og
, 
d¡
, 
¤c
);

2042 } ià(
umš
 >= 32) {

2043 
	`shl_»g64_ge32
(
nå_´og
, 
d¡
, 
¤c
);

2048 
u16
 
Ïb–_ge32
, 
Ïb–_’d
;

2050 
Ïb–_ge32
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 7;

2051 
	`em™_br_b£t
(
nå_´og
, 
	`»g_a
(
¤c
), 5, 
Ïb–_ge32
, 0);

2053 
	`shl_»g64_É32_high
(
nå_´og
, 
d¡
, 
¤c
);

2054 
Ïb–_’d
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 6;

2055 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
Ïb–_’d
, 2);

2057 
	`shl_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2059 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
Ïb–_ge32
))

2060  -
EINVAL
;

2061 
	`shl_»g64_ge32
(
nå_´og
, 
d¡
, 
¤c
);

2063 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
Ïb–_’d
))

2064  -
EINVAL
;

2068 
	}
}

2080 
	$__shr_imm64
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
shiá_amt
)

2082 ià(!
shiá_amt
)

2085 ià(
shiá_amt
 < 32) {

2086 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_a
(d¡ + 1), 
SHF_OP_NONE
,

2087 
	`»g_b
(
d¡
), 
SHF_SC_R_DSHF
, 
shiá_amt
);

2088 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2089 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
, 
shiá_amt
);

2090 } ià(
shiá_amt
 == 32) {

2091 
	`w½_»g_mov
(
nå_´og
, 
d¡
, dst + 1);

2092 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2093 } ià(
shiá_amt
 > 32) {

2094 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2095 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
, 
shiá_amt
 - 32);

2096 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2100 
	}
}

2102 
	$shr_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2104 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2105 
u8
 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2107  
	`__shr_imm64
(
nå_´og
, 
d¡
, 
š¢
->
imm
);

2108 
	}
}

2111 
	$shr_»g64_É32_high
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2113 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_imm
(0));

2114 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2115 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
);

2116 
	}
}

2118 
	$shr_»g64_É32_low
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2120 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_imm
(0));

2121 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_a
(d¡ + 1), 
SHF_OP_NONE
,

2122 
	`»g_b
(
d¡
), 
SHF_SC_R_DSHF
);

2123 
	}
}

2125 
	$shr_»g64_É32
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2127 
	`shr_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2128 
	`shr_»g64_É32_high
(
nå_´og
, 
d¡
, 
¤c
);

2129 
	}
}

2131 
	$shr_»g64_ge32
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2133 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_imm
(0));

2134 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2135 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
);

2136 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2137 
	}
}

2139 
	$shr_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2141 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2142 
u64
 
umš
, 
umax
;

2143 
u8
 
d¡
, 
¤c
;

2145 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2146 
umš
 = 
m‘a
->
umš_¤c
;

2147 
umax
 = 
m‘a
->
umax_¤c
;

2148 ià(
umš
 =ð
umax
)

2149  
	`__shr_imm64
(
nå_´og
, 
d¡
, 
umš
);

2151 
¤c
 = 
š¢
->
¤c_»g
 * 2;

2152 ià(
umax
 < 32) {

2153 
	`shr_»g64_É32
(
nå_´og
, 
d¡
, 
¤c
);

2154 } ià(
umš
 >= 32) {

2155 
	`shr_»g64_ge32
(
nå_´og
, 
d¡
, 
¤c
);

2160 
u16
 
Ïb–_ge32
, 
Ïb–_’d
;

2162 
Ïb–_ge32
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 6;

2163 
	`em™_br_b£t
(
nå_´og
, 
	`»g_a
(
¤c
), 5, 
Ïb–_ge32
, 0);

2164 
	`shr_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2165 
Ïb–_’d
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 6;

2166 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
Ïb–_’d
, 2);

2168 
	`shr_»g64_É32_high
(
nå_´og
, 
d¡
, 
¤c
);

2170 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
Ïb–_ge32
))

2171  -
EINVAL
;

2172 
	`shr_»g64_ge32
(
nå_´og
, 
d¡
, 
¤c
);

2174 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
Ïb–_’d
))

2175  -
EINVAL
;

2179 
	}
}

2184 
	$__ashr_imm64
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
shiá_amt
)

2186 ià(!
shiá_amt
)

2189 ià(
shiá_amt
 < 32) {

2190 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_a
(d¡ + 1), 
SHF_OP_NONE
,

2191 
	`»g_b
(
d¡
), 
SHF_SC_R_DSHF
, 
shiá_amt
);

2193 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
d¡
 + 1), 
ALU_OP_OR
,

2194 
	`»g_imm
(0));

2195 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2196 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
, 
shiá_amt
);

2197 } ià(
shiá_amt
 == 32) {

2199 
	`w½_»g_mov
(
nå_´og
, 
d¡
, dst + 1);

2200 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2201 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
, 31);

2202 } ià(
shiá_amt
 > 32) {

2203 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
d¡
 + 1), 
ALU_OP_OR
,

2204 
	`»g_imm
(0));

2205 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2206 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
, 
shiá_amt
 - 32);

2207 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2208 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
, 31);

2212 
	}
}

2214 
	$ashr_imm64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2216 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2217 
u8
 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2219  
	`__ashr_imm64
(
nå_´og
, 
d¡
, 
š¢
->
imm
);

2220 
	}
}

2222 
	$ashr_»g64_É32_high
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2227 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_b
(
d¡
 + 1));

2228 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2229 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
);

2230 
	}
}

2232 
	$ashr_»g64_É32_low
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2237  
	`shr_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2238 
	}
}

2240 
	$ashr_»g64_É32
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2242 
	`ashr_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2243 
	`ashr_»g64_É32_high
(
nå_´og
, 
d¡
, 
¤c
);

2244 
	}
}

2246 
	$ashr_»g64_ge32
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
¤c
)

2248 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_b
(
d¡
 + 1));

2249 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2250 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
);

2251 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2252 
	`»g_b
(
d¡
 + 1), 
SHF_SC_R_SHF
, 31);

2253 
	}
}

2256 
	$ashr_»g64
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2258 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2259 
u64
 
umš
, 
umax
;

2260 
u8
 
d¡
, 
¤c
;

2262 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2263 
umš
 = 
m‘a
->
umš_¤c
;

2264 
umax
 = 
m‘a
->
umax_¤c
;

2265 ià(
umš
 =ð
umax
)

2266  
	`__ashr_imm64
(
nå_´og
, 
d¡
, 
umš
);

2268 
¤c
 = 
š¢
->
¤c_»g
 * 2;

2269 ià(
umax
 < 32) {

2270 
	`ashr_»g64_É32
(
nå_´og
, 
d¡
, 
¤c
);

2271 } ià(
umš
 >= 32) {

2272 
	`ashr_»g64_ge32
(
nå_´og
, 
d¡
, 
¤c
);

2274 
u16
 
Ïb–_ge32
, 
Ïb–_’d
;

2276 
Ïb–_ge32
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 6;

2277 
	`em™_br_b£t
(
nå_´og
, 
	`»g_a
(
¤c
), 5, 
Ïb–_ge32
, 0);

2278 
	`ashr_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2279 
Ïb–_’d
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 6;

2280 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
Ïb–_’d
, 2);

2282 
	`ashr_»g64_É32_high
(
nå_´og
, 
d¡
, 
¤c
);

2284 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
Ïb–_ge32
))

2285  -
EINVAL
;

2286 
	`ashr_»g64_ge32
(
nå_´og
, 
d¡
, 
¤c
);

2288 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
Ïb–_’d
))

2289  -
EINVAL
;

2293 
	}
}

2295 
	$mov_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2297 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2299 
	`w½_»g_mov
(
nå_´og
, 
š¢
->
d¡_»g
 * 2, in¢->
¤c_»g
 * 2);

2300 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2 + 1), 0);

2303 
	}
}

2305 
	$mov_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2307 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2309 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2), in¢->
imm
);

2310 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
š¢
->
d¡_»g
 * 2 + 1), 0);

2313 
	}
}

2315 
	$xÜ_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2317  
	`w½_®u32_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_XOR
);

2318 
	}
}

2320 
	$xÜ_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2322  
	`w½_®u32_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_XOR
);

2323 
	}
}

2325 
	$ªd_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2327  
	`w½_®u32_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_AND
);

2328 
	}
}

2330 
	$ªd_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2332  
	`w½_®u32_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_AND
);

2333 
	}
}

2335 
	$Ü_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2337  
	`w½_®u32_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_OR
);

2338 
	}
}

2340 
	$Ü_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2342  
	`w½_®u32_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_OR
);

2343 
	}
}

2345 
	$add_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2347  
	`w½_®u32_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_ADD
);

2348 
	}
}

2350 
	$add_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2352  
	`w½_®u32_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_ADD
);

2353 
	}
}

2355 
	$sub_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2357  
	`w½_®u32_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_SUB
);

2358 
	}
}

2360 
	$sub_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2362  
	`w½_®u32_imm
(
nå_´og
, 
m‘a
, 
ALU_OP_SUB
);

2363 
	}
}

2365 
	$mul_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2367  
	`w½_mul
(
nå_´og
, 
m‘a
, 
çl£
, 
Œue
);

2368 
	}
}

2370 
	$mul_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2372  
	`w½_mul
(
nå_´og
, 
m‘a
, 
çl£
, false);

2373 
	}
}

2375 
	$div_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2377  
	`div_»g64
(
nå_´og
, 
m‘a
);

2378 
	}
}

2380 
	$div_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2382  
	`div_imm64
(
nå_´og
, 
m‘a
);

2383 
	}
}

2385 
	$Ãg_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2387 
u8
 
d¡
 = 
m‘a
->
š¢
.
d¡_»g
 * 2;

2389 
	`em™_®u
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_imm
(0), 
ALU_OP_SUB
, 
	`»g_b
(dst));

2390 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2 + 1), 0);

2393 
	}
}

2395 
	$__ashr_imm
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
shiá_amt
)

2397 ià(
shiá_amt
) {

2399 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
d¡
), 
ALU_OP_OR
,

2400 
	`»g_imm
(0));

2401 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2402 
	`»g_b
(
d¡
), 
SHF_SC_R_SHF
, 
shiá_amt
);

2404 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2407 
	}
}

2409 
	$ashr_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2411 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2412 
u64
 
umš
, 
umax
;

2413 
u8
 
d¡
, 
¤c
;

2415 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2416 
umš
 = 
m‘a
->
umš_¤c
;

2417 
umax
 = 
m‘a
->
umax_¤c
;

2418 ià(
umš
 =ð
umax
)

2419  
	`__ashr_imm
(
nå_´og
, 
d¡
, 
umš
);

2421 
¤c
 = 
š¢
->
¤c_»g
 * 2;

2425 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_b
(
d¡
));

2426 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_ASHR
,

2427 
	`»g_b
(
d¡
), 
SHF_SC_R_SHF
);

2428 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2431 
	}
}

2433 
	$ashr_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2435 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2436 
u8
 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2438  
	`__ashr_imm
(
nå_´og
, 
d¡
, 
š¢
->
imm
);

2439 
	}
}

2441 
	$__shr_imm
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
shiá_amt
)

2443 ià(
shiá_amt
)

2444 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2445 
	`»g_b
(
d¡
), 
SHF_SC_R_SHF
, 
shiá_amt
);

2446 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2448 
	}
}

2450 
	$shr_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2452 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2453 
u8
 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2455  
	`__shr_imm
(
nå_´og
, 
d¡
, 
š¢
->
imm
);

2456 
	}
}

2458 
	$shr_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2460 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2461 
u64
 
umš
, 
umax
;

2462 
u8
 
d¡
, 
¤c
;

2464 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2465 
umš
 = 
m‘a
->
umš_¤c
;

2466 
umax
 = 
m‘a
->
umax_¤c
;

2467 ià(
umš
 =ð
umax
)

2468  
	`__shr_imm
(
nå_´og
, 
d¡
, 
umš
);

2470 
¤c
 = 
š¢
->
¤c_»g
 * 2;

2471 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
¤c
), 
ALU_OP_OR
, 
	`»g_imm
(0));

2472 
	`em™_shf_šdœ
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2473 
	`»g_b
(
d¡
), 
SHF_SC_R_SHF
);

2474 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2476 
	}
}

2478 
	$__shl_imm
(
nå_´og
 *nå_´og, 
u8
 
d¡
, u8 
shiá_amt
)

2480 ià(
shiá_amt
)

2481 
	`em™_shf
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
	`»g_nÚe
(), 
SHF_OP_NONE
,

2482 
	`»g_b
(
d¡
), 
SHF_SC_L_SHF
, 
shiá_amt
);

2483 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2485 
	}
}

2487 
	$shl_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2489 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2490 
u8
 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2492  
	`__shl_imm
(
nå_´og
, 
d¡
, 
š¢
->
imm
);

2493 
	}
}

2495 
	$shl_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2497 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2498 
u64
 
umš
, 
umax
;

2499 
u8
 
d¡
, 
¤c
;

2501 
d¡
 = 
š¢
->
d¡_»g
 * 2;

2502 
umš
 = 
m‘a
->
umš_¤c
;

2503 
umax
 = 
m‘a
->
umax_¤c
;

2504 ià(
umš
 =ð
umax
)

2505  
	`__shl_imm
(
nå_´og
, 
d¡
, 
umš
);

2507 
¤c
 = 
š¢
->
¤c_»g
 * 2;

2508 
	`shl_»g64_É32_low
(
nå_´og
, 
d¡
, 
¤c
);

2509 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 0);

2511 
	}
}

2513 
	$’d_»g32
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2515 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

2516 
u8
 
g´
 = 
š¢
->
d¡_»g
 * 2;

2518 
š¢
->
imm
) {

2520 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_bÙh
(
g´
), 0x9, 
	`»g_b
(gpr),

2521 
SHF_SC_R_ROT
, 8);

2522 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_bÙh
(
g´
), 0xe, 
	`»g_a
(gpr),

2523 
SHF_SC_R_SHF
, 16);

2525 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
g´
 + 1), 0);

2528 
	`w½_’d32
(
nå_´og
, 
	`»g_a
(
g´
), gpr);

2529 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
g´
 + 1), 0);

2532 
	`w½_mov
(
nå_´og
, 
	`imm_a
Òå_´og), 
	`»g_b
(
g´
 + 1));

2534 
	`w½_’d32
(
nå_´og
, 
	`»g_a
(
g´
), gpr + 1);

2535 
	`w½_’d32
(
nå_´og
, 
	`imm_a
Òå_´og), 
g´
);

2540 
	}
}

2542 
	$imm_ld8_·¹2
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2544 
nå_š¢_m‘a
 *
´ev
 = 
	`nå_m‘a_´ev
(
m‘a
);

2545 
u32
 
imm_lo
, 
imm_hi
;

2546 
u8
 
d¡
;

2548 
d¡
 = 
´ev
->
š¢
.
d¡_»g
 * 2;

2549 
imm_lo
 = 
´ev
->
š¢
.
imm
;

2550 
imm_hi
 = 
m‘a
->
š¢
.
imm
;

2552 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
), 
imm_lo
);

2555 ià(
imm_hi
 =ð
imm_lo
)

2556 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
	`»g_a
(dst));

2558 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
d¡
 + 1), 
imm_hi
);

2561 
	}
}

2563 
	$imm_ld8
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2565 
m‘a
->
doubË_cb
 = 
imm_ld8_·¹2
;

2567 
	}
}

2569 
	$d©a_ld1
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2571  
	`cÚ¡ruù_d©a_ld
(
nå_´og
, 
m‘a
->
š¢
.
imm
, 1);

2572 
	}
}

2574 
	$d©a_ld2
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2576  
	`cÚ¡ruù_d©a_ld
(
nå_´og
, 
m‘a
->
š¢
.
imm
, 2);

2577 
	}
}

2579 
	$d©a_ld4
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2581  
	`cÚ¡ruù_d©a_ld
(
nå_´og
, 
m‘a
->
š¢
.
imm
, 4);

2582 
	}
}

2584 
	$d©a_šd_ld1
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2586  
	`cÚ¡ruù_d©a_šd_ld
(
nå_´og
, 
m‘a
->
š¢
.
imm
,

2587 
m‘a
->
š¢
.
¤c_»g
 * 2, 1);

2588 
	}
}

2590 
	$d©a_šd_ld2
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2592  
	`cÚ¡ruù_d©a_šd_ld
(
nå_´og
, 
m‘a
->
š¢
.
imm
,

2593 
m‘a
->
š¢
.
¤c_»g
 * 2, 2);

2594 
	}
}

2596 
	$d©a_šd_ld4
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2598  
	`cÚ¡ruù_d©a_šd_ld
(
nå_´og
, 
m‘a
->
š¢
.
imm
,

2599 
m‘a
->
š¢
.
¤c_»g
 * 2, 4);

2600 
	}
}

2603 
	$mem_ldx_¡ack
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2604 
size
, 
±r_off
)

2606  
	`mem_Ý_¡ack
(
nå_´og
, 
m‘a
, 
size
, 
±r_off
,

2607 
m‘a
->
š¢
.
d¡_»g
 * 2, m‘a->š¢.
¤c_»g
 * 2,

2608 
Œue
, 
w½_lmem_lßd
);

2609 
	}
}

2611 
	$mem_ldx_skb
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2612 
u8
 
size
)

2614 
sw»g
 
d¡
 = 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2);

2616 
m‘a
->
š¢
.
off
) {

2617 
	`off£tof
(
__sk_buff
, 
Ën
):

2618 ià(
size
 !ð
	`FIELD_SIZEOF
(
__sk_buff
, 
Ën
))

2619  -
EOPNOTSUPP
;

2620 
	`w½_mov
(
nå_´og
, 
d¡
, 
	`¶’_»g
(nfp_prog));

2622 
	`off£tof
(
__sk_buff
, 
d©a
):

2623 ià(
size
 !ð
	`FIELD_SIZEOF
(
__sk_buff
, 
d©a
))

2624  -
EOPNOTSUPP
;

2625 
	`w½_mov
(
nå_´og
, 
d¡
, 
	`µŒ_»g
(nfp_prog));

2627 
	`off£tof
(
__sk_buff
, 
d©a_’d
):

2628 ià(
size
 !ð
	`FIELD_SIZEOF
(
__sk_buff
, 
d©a_’d
))

2629  -
EOPNOTSUPP
;

2630 
	`em™_®u
(
nå_´og
, 
d¡
,

2631 
	`¶’_»g
(
nå_´og
), 
ALU_OP_ADD
, 
	`µŒ_»g
(nfp_prog));

2634  -
EOPNOTSUPP
;

2637 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2 + 1), 0);

2640 
	}
}

2642 
	$mem_ldx_xdp
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2643 
u8
 
size
)

2645 
sw»g
 
d¡
 = 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2);

2647 
m‘a
->
š¢
.
off
) {

2648 
	`off£tof
(
xdp_md
, 
d©a
):

2649 ià(
size
 !ð
	`FIELD_SIZEOF
(
xdp_md
, 
d©a
))

2650  -
EOPNOTSUPP
;

2651 
	`w½_mov
(
nå_´og
, 
d¡
, 
	`µŒ_»g
(nfp_prog));

2653 
	`off£tof
(
xdp_md
, 
d©a_’d
):

2654 ià(
size
 !ð
	`FIELD_SIZEOF
(
xdp_md
, 
d©a_’d
))

2655  -
EOPNOTSUPP
;

2656 
	`em™_®u
(
nå_´og
, 
d¡
,

2657 
	`¶’_»g
(
nå_´og
), 
ALU_OP_ADD
, 
	`µŒ_»g
(nfp_prog));

2660  -
EOPNOTSUPP
;

2663 
	`w½_immed
(
nå_´og
, 
	`»g_bÙh
(
m‘a
->
š¢
.
d¡_»g
 * 2 + 1), 0);

2666 
	}
}

2669 
	$mem_ldx_d©a
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2670 
size
)

2672 
sw»g
 
tmp_»g
;

2674 
tmp_»g
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
š¢
.
off
, 
	`imm_b
(nfp_prog));

2676  
	`d©a_ld_ho¡_Üd”_addr32
(
nå_´og
, 
m‘a
->
š¢
.
¤c_»g
 * 2,

2677 
tmp_»g
, 
m‘a
->
š¢
.
d¡_»g
 * 2, 
size
);

2678 
	}
}

2681 
	$mem_ldx_emem
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2682 
size
)

2684 
sw»g
 
tmp_»g
;

2686 
tmp_»g
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
š¢
.
off
, 
	`imm_b
(nfp_prog));

2688  
	`d©a_ld_ho¡_Üd”_addr40
(
nå_´og
, 
m‘a
->
š¢
.
¤c_»g
 * 2,

2689 
tmp_»g
, 
m‘a
->
š¢
.
d¡_»g
 * 2, 
size
);

2690 
	}
}

2693 
	$mem_ldx_d©a_š™_pktÿche
(
nå_´og
 *nfp_prog,

2694 
nå_š¢_m‘a
 *
m‘a
)

2696 
s16
 
¿nge_¡¬t
 = 
m‘a
->
pkt_ÿche
.range_start;

2697 
s16
 
¿nge_’d
 = 
m‘a
->
pkt_ÿche
.range_end;

2698 
sw»g
 
¤c_ba£
, 
off
;

2699 
u8
 
xãr_num
, 
Ën
;

2700 
boÞ
 
šdœ
;

2702 
off
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
¿nge_¡¬t
, 
	`imm_b
(nfp_prog));

2703 
¤c_ba£
 = 
	`»g_a
(
m‘a
->
š¢
.
¤c_»g
 * 2);

2704 
Ën
 = 
¿nge_’d
 - 
¿nge_¡¬t
;

2705 
xãr_num
 = 
	`round_up
(
Ën
, 
REG_WIDTH
) / REG_WIDTH;

2707 
šdœ
 = 
Ën
 > 8 * 
REG_WIDTH
;

2709 ià(
šdœ
)

2710 
	`w½_immed
(
nå_´og
, 
	`»g_nÚe
(),

2711 
CMD_OVE_LEN
 | 
	`FIELD_PREP
(
CMD_OV_LEN
, 
xãr_num
 - 1));

2714 
	`em™_cmd_ªy
(
nå_´og
, 
CMD_TGT_READ32_SWAP
, 
CMD_MODE_32b
, 0, 
¤c_ba£
,

2715 
off
, 
xãr_num
 - 1, 
CMD_CTX_SWAP
, 
šdœ
);

2716 
	}
}

2719 
	$mem_ldx_d©a_äom_pktÿche_uÇligÃd
(
nå_´og
 *nfp_prog,

2720 
nå_š¢_m‘a
 *
m‘a
,

2721 
size
)

2723 
s16
 
¿nge_¡¬t
 = 
m‘a
->
pkt_ÿche
.range_start;

2724 
s16
 
š¢_off
 = 
m‘a
->
š¢
.
off
 - 
¿nge_¡¬t
;

2725 
sw»g
 
d¡_lo
, 
d¡_hi
, 
¤c_lo
, 
¤c_mid
;

2726 
u8
 
d¡_g´
 = 
m‘a
->
š¢
.
d¡_»g
 * 2;

2727 
u8
 
Ën_lo
 = 
size
, 
Ën_mid
 = 0;

2728 
u8
 
idx
 = 
š¢_off
 / 
REG_WIDTH
;

2729 
u8
 
off
 = 
š¢_off
 % 
REG_WIDTH
;

2731 
d¡_hi
 = 
	`»g_bÙh
(
d¡_g´
 + 1);

2732 
d¡_lo
 = 
	`»g_bÙh
(
d¡_g´
);

2733 
¤c_lo
 = 
	`»g_xãr
(
idx
);

2736 ià(
size
 > 
REG_WIDTH
 - 
off
) {

2738 
Ën_lo
 = 
REG_WIDTH
 - 
off
;

2739 
Ën_mid
 = 
size
 - 
Ën_lo
;

2742 ià(
size
 > 2 * 
REG_WIDTH
 - 
off
)

2743 
Ën_mid
 = 
REG_WIDTH
;

2746 
	`w½_»g_sub·¹
(
nå_´og
, 
d¡_lo
, 
¤c_lo
, 
Ën_lo
, 
off
);

2748 ià(!
Ën_mid
) {

2749 
	`w½_immed
(
nå_´og
, 
d¡_hi
, 0);

2753 
¤c_mid
 = 
	`»g_xãr
(
idx
 + 1);

2755 ià(
size
 <ð
REG_WIDTH
) {

2756 
	`w½_»g_Ü_sub·¹
(
nå_´og
, 
d¡_lo
, 
¤c_mid
, 
Ën_mid
, 
Ën_lo
);

2757 
	`w½_immed
(
nå_´og
, 
d¡_hi
, 0);

2759 
sw»g
 
¤c_hi
 = 
	`»g_xãr
(
idx
 + 2);

2761 
	`w½_»g_Ü_sub·¹
(
nå_´og
, 
d¡_lo
, 
¤c_mid
,

2762 
REG_WIDTH
 - 
Ën_lo
,†en_lo);

2763 
	`w½_»g_sub·¹
(
nå_´og
, 
d¡_hi
, 
¤c_mid
, 
Ën_lo
,

2764 
REG_WIDTH
 - 
Ën_lo
);

2765 
	`w½_»g_Ü_sub·¹
(
nå_´og
, 
d¡_hi
, 
¤c_hi
, 
REG_WIDTH
 - 
Ën_lo
,

2766 
Ën_lo
);

2770 
	}
}

2773 
	$mem_ldx_d©a_äom_pktÿche_®igÃd
(
nå_´og
 *nfp_prog,

2774 
nå_š¢_m‘a
 *
m‘a
,

2775 
size
)

2777 
sw»g
 
d¡_lo
, 
d¡_hi
, 
¤c_lo
;

2778 
u8
 
d¡_g´
, 
idx
;

2780 
idx
 = (
m‘a
->
š¢
.
off
 - m‘a->
pkt_ÿche
.
¿nge_¡¬t
è/ 
REG_WIDTH
;

2781 
d¡_g´
 = 
m‘a
->
š¢
.
d¡_»g
 * 2;

2782 
d¡_hi
 = 
	`»g_bÙh
(
d¡_g´
 + 1);

2783 
d¡_lo
 = 
	`»g_bÙh
(
d¡_g´
);

2784 
¤c_lo
 = 
	`»g_xãr
(
idx
);

2786 ià(
size
 < 
REG_WIDTH
) {

2787 
	`w½_»g_sub·¹
(
nå_´og
, 
d¡_lo
, 
¤c_lo
, 
size
, 0);

2788 
	`w½_immed
(
nå_´og
, 
d¡_hi
, 0);

2789 } ià(
size
 =ð
REG_WIDTH
) {

2790 
	`w½_mov
(
nå_´og
, 
d¡_lo
, 
¤c_lo
);

2791 
	`w½_immed
(
nå_´og
, 
d¡_hi
, 0);

2793 
sw»g
 
¤c_hi
 = 
	`»g_xãr
(
idx
 + 1);

2795 
	`w½_mov
(
nå_´og
, 
d¡_lo
, 
¤c_lo
);

2796 
	`w½_mov
(
nå_´og
, 
d¡_hi
, 
¤c_hi
);

2800 
	}
}

2803 
	$mem_ldx_d©a_äom_pktÿche
(
nå_´og
 *nfp_prog,

2804 
nå_š¢_m‘a
 *
m‘a
, 
size
)

2806 
u8
 
off
 = 
m‘a
->
š¢
.ofà- m‘a->
pkt_ÿche
.
¿nge_¡¬t
;

2808 ià(
	`IS_ALIGNED
(
off
, 
REG_WIDTH
))

2809  
	`mem_ldx_d©a_äom_pktÿche_®igÃd
(
nå_´og
, 
m‘a
, 
size
);

2811  
	`mem_ldx_d©a_äom_pktÿche_uÇligÃd
(
nå_´og
, 
m‘a
, 
size
);

2812 
	}
}

2815 
	$mem_ldx
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2816 
size
)

2818 ià(
m‘a
->
ld¡_g©h”_Ën
)

2819  
	`nå_ýp_memýy
(
nå_´og
, 
m‘a
);

2821 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_CTX
) {

2822 ià(
nå_´og
->
ty³
 =ð
BPF_PROG_TYPE_XDP
)

2823  
	`mem_ldx_xdp
(
nå_´og
, 
m‘a
, 
size
);

2825  
	`mem_ldx_skb
(
nå_´og
, 
m‘a
, 
size
);

2828 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_PACKET
) {

2829 ià(
m‘a
->
pkt_ÿche
.
¿nge_’d
) {

2830 ià(
m‘a
->
pkt_ÿche
.
do_š™
)

2831 
	`mem_ldx_d©a_š™_pktÿche
(
nå_´og
, 
m‘a
);

2833  
	`mem_ldx_d©a_äom_pktÿche
(
nå_´og
, 
m‘a
, 
size
);

2835  
	`mem_ldx_d©a
(
nå_´og
, 
m‘a
, 
size
);

2839 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_STACK
)

2840  
	`mem_ldx_¡ack
(
nå_´og
, 
m‘a
, 
size
,

2841 
m‘a
->
±r
.
off
 + m‘a->±r.
v¬_off
.
v®ue
);

2843 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_MAP_VALUE
)

2844  
	`mem_ldx_emem
(
nå_´og
, 
m‘a
, 
size
);

2846  -
EOPNOTSUPP
;

2847 
	}
}

2849 
	$mem_ldx1
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2851  
	`mem_ldx
(
nå_´og
, 
m‘a
, 1);

2852 
	}
}

2854 
	$mem_ldx2
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2856  
	`mem_ldx
(
nå_´og
, 
m‘a
, 2);

2857 
	}
}

2859 
	$mem_ldx4
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2861  
	`mem_ldx
(
nå_´og
, 
m‘a
, 4);

2862 
	}
}

2864 
	$mem_ldx8
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2866  
	`mem_ldx
(
nå_´og
, 
m‘a
, 8);

2867 
	}
}

2870 
	$mem_¡_d©a
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2871 
size
)

2873 
u64
 
imm
 = 
m‘a
->
š¢
.imm;

2874 
sw»g
 
off_»g
;

2876 
off_»g
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
š¢
.
off
, 
	`imm_b
(nfp_prog));

2878  
	`d©a_¡_ho¡_Üd”
(
nå_´og
, 
m‘a
->
š¢
.
d¡_»g
 * 2, 
off_»g
,

2879 
imm
, 
size
);

2880 
	}
}

2882 
	$mem_¡
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2883 
size
)

2885 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_PACKET
)

2886  
	`mem_¡_d©a
(
nå_´og
, 
m‘a
, 
size
);

2888  -
EOPNOTSUPP
;

2889 
	}
}

2891 
	$mem_¡1
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2893  
	`mem_¡
(
nå_´og
, 
m‘a
, 1);

2894 
	}
}

2896 
	$mem_¡2
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2898  
	`mem_¡
(
nå_´og
, 
m‘a
, 2);

2899 
	}
}

2901 
	$mem_¡4
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2903  
	`mem_¡
(
nå_´og
, 
m‘a
, 4);

2904 
	}
}

2906 
	$mem_¡8
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2908  
	`mem_¡
(
nå_´og
, 
m‘a
, 8);

2909 
	}
}

2912 
	$mem_¡x_d©a
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2913 
size
)

2915 
sw»g
 
off_»g
;

2917 
off_»g
 = 
	`»_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
š¢
.
off
, 
	`imm_b
(nfp_prog));

2919  
	`d©a_¡x_ho¡_Üd”
(
nå_´og
, 
m‘a
->
š¢
.
d¡_»g
 * 2, 
off_»g
,

2920 
m‘a
->
š¢
.
¤c_»g
 * 2, 
size
);

2921 
	}
}

2924 
	$mem_¡x_¡ack
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2925 
size
, 
±r_off
)

2927  
	`mem_Ý_¡ack
(
nå_´og
, 
m‘a
, 
size
, 
±r_off
,

2928 
m‘a
->
š¢
.
¤c_»g
 * 2, m‘a->š¢.
d¡_»g
 * 2,

2929 
çl£
, 
w½_lmem_¡Üe
);

2930 
	}
}

2932 
	$mem_¡x_xdp
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2934 
m‘a
->
š¢
.
off
) {

2935 
	`off£tof
(
xdp_md
, 
rx_queue_šdex
):

2936  
	`nå_queue_£Ëù
(
nå_´og
, 
m‘a
);

2939 
	`WARN_ON_ONCE
(1);

2940  -
EOPNOTSUPP
;

2941 
	}
}

2944 
	$mem_¡x
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

2945 
size
)

2947 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_PACKET
)

2948  
	`mem_¡x_d©a
(
nå_´og
, 
m‘a
, 
size
);

2950 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_STACK
)

2951  
	`mem_¡x_¡ack
(
nå_´og
, 
m‘a
, 
size
,

2952 
m‘a
->
±r
.
off
 + m‘a->±r.
v¬_off
.
v®ue
);

2954  -
EOPNOTSUPP
;

2955 
	}
}

2957 
	$mem_¡x1
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2959  
	`mem_¡x
(
nå_´og
, 
m‘a
, 1);

2960 
	}
}

2962 
	$mem_¡x2
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2964  
	`mem_¡x
(
nå_´og
, 
m‘a
, 2);

2965 
	}
}

2967 
	$mem_¡x4
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2969 ià(
m‘a
->
±r
.
ty³
 =ð
PTR_TO_CTX
)

2970 ià(
nå_´og
->
ty³
 =ð
BPF_PROG_TYPE_XDP
)

2971  
	`mem_¡x_xdp
(
nå_´og
, 
m‘a
);

2972  
	`mem_¡x
(
nå_´og
, 
m‘a
, 4);

2973 
	}
}

2975 
	$mem_¡x8
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

2977  
	`mem_¡x
(
nå_´og
, 
m‘a
, 8);

2978 
	}
}

2981 
	$mem_xadd
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
, 
boÞ
 
is64
)

2983 
u8
 
d¡_g´
 = 
m‘a
->
š¢
.
d¡_»g
 * 2;

2984 
u8
 
¤c_g´
 = 
m‘a
->
š¢
.
¤c_»g
 * 2;

2985 
fuÎ_add
, 
out
;

2986 
sw»g
 
add¿
, 
addrb
, 
off
;

2988 
off
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
m‘a
->
š¢
.off, 
	`imm_b
(nfp_prog));

2995 
out
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
);

2996 
fuÎ_add
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
);

2998 ià(
m‘a
->
š¢
.
off
) {

2999 
out
 += 2;

3000 
fuÎ_add
 += 2;

3002 ià(
m‘a
->
xadd_maybe_16b™
) {

3003 
out
 += 3;

3004 
fuÎ_add
 += 3;

3006 ià(
m‘a
->
xadd_ov”_16b™
)

3007 
out
 +ð2 + 
is64
;

3008 ià(
m‘a
->
xadd_maybe_16b™
 && m‘a->
xadd_ov”_16b™
) {

3009 
out
 += 5;

3010 
fuÎ_add
 += 5;

3014 ià(
m‘a
->
xadd_maybe_16b™
 && m‘a->
xadd_ov”_16b™
) {

3015 
sw»g
 
max_imm
 = 
	`imm_a
(
nå_´og
);

3017 
	`w½_immed
(
nå_´og
, 
max_imm
, 0xffff);

3018 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

3019 
max_imm
, 
ALU_OP_SUB
, 
	`»g_b
(
¤c_g´
));

3020 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

3021 
	`»g_imm
(0), 
ALU_OP_SUB_C
, 
	`»g_b
(
¤c_g´
 + 1));

3022 
	`em™_br
(
nå_´og
, 
BR_BLO
, 
fuÎ_add
, 
m‘a
->
š¢
.
off
 ? 2 : 0);

3027 ià(!
m‘a
->
š¢
.
off
) {

3028 
add¿
 = 
	`»g_a
(
d¡_g´
);

3029 
addrb
 = 
	`»g_b
(
d¡_g´
 + 1);

3031 
	`em™_®u
(
nå_´og
, 
	`imma_a
(nfp_prog),

3032 
	`»g_a
(
d¡_g´
), 
ALU_OP_ADD
, 
off
);

3033 
	`em™_®u
(
nå_´og
, 
	`imma_b
(nfp_prog),

3034 
	`»g_a
(
d¡_g´
 + 1), 
ALU_OP_ADD_C
, 
	`»g_imm
(0));

3035 
add¿
 = 
	`imma_a
(
nå_´og
);

3036 
addrb
 = 
	`imma_b
(
nå_´og
);

3040 ià(
m‘a
->
xadd_maybe_16b™
) {

3041 
sw»g
 
´ev_®u
 = 
	`imm_a
(
nå_´og
);

3043 
	`w½_immed
(
nå_´og
, 
´ev_®u
,

3044 
	`FIELD_PREP
(
CMD_OVE_DATA
, 2) |

3045 
CMD_OVE_LEN
 |

3046 
	`FIELD_PREP
(
CMD_OV_LEN
, 0x8 | 
is64
 << 2));

3047 
	`w½_»g_Ü_sub·¹
(
nå_´og
, 
´ev_®u
, 
	`»g_b
(
¤c_g´
), 2, 2);

3048 
	`em™_cmd_šdœ
(
nå_´og
, 
CMD_TGT_ADD_IMM
, 
CMD_MODE_40b_BA
, 0,

3049 
add¿
, 
addrb
, 0, 
CMD_CTX_NO_SWAP
);

3051 ià(
m‘a
->
xadd_ov”_16b™
)

3052 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
out
, 0);

3055 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
fuÎ_add
))

3056  -
EINVAL
;

3059 ià(
m‘a
->
xadd_ov”_16b™
) {

3060 
	`em™_cmd
(
nå_´og
, 
CMD_TGT_ADD
, 
CMD_MODE_40b_BA
, 0,

3061 
add¿
, 
addrb
, 
is64
 << 2,

3062 
is64
 ? 
CMD_CTX_SWAP_DEFER2
 : 
CMD_CTX_SWAP_DEFER1
);

3064 
	`w½_mov
(
nå_´og
, 
	`»g_xãr
(0), 
	`»g_a
(
¤c_g´
));

3065 ià(
is64
)

3066 
	`w½_mov
(
nå_´og
, 
	`»g_xãr
(1), 
	`»g_a
(
¤c_g´
 + 1));

3069 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
out
))

3070  -
EINVAL
;

3073 
	}
}

3075 
	$mem_xadd4
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3077  
	`mem_xadd
(
nå_´og
, 
m‘a
, 
çl£
);

3078 
	}
}

3080 
	$mem_xadd8
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3082  
	`mem_xadd
(
nå_´og
, 
m‘a
, 
Œue
);

3083 
	}
}

3085 
	$jump
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3087 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
m‘a
->
š¢
.
off
, 0);

3090 
	}
}

3092 
	$jeq_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3094 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

3095 
u64
 
imm
 = 
š¢
->imm;

3096 
sw»g
 
Ü1
, 
Ü2
, 
tmp_»g
;

3098 
Ü1
 = 
	`»g_a
(
š¢
->
d¡_»g
 * 2);

3099 
Ü2
 = 
	`»g_b
(
š¢
->
d¡_»g
 * 2 + 1);

3101 ià(
imm
 & ~0U) {

3102 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
 & ~0U, 
	`imm_b
(nfp_prog));

3103 
	`em™_®u
(
nå_´og
, 
	`imm_a
(nfp_prog),

3104 
	`»g_a
(
š¢
->
d¡_»g
 * 2), 
ALU_OP_XOR
, 
tmp_»g
);

3105 
Ü1
 = 
	`imm_a
(
nå_´og
);

3108 ià(
imm
 >> 32) {

3109 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
 >> 32, 
	`imm_b
(nfp_prog));

3110 
	`em™_®u
(
nå_´og
, 
	`imm_b
(nfp_prog),

3111 
	`»g_a
(
š¢
->
d¡_»g
 * 2 + 1), 
ALU_OP_XOR
, 
tmp_»g
);

3112 
Ü2
 = 
	`imm_b
(
nå_´og
);

3115 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
Ü1
, 
ALU_OP_OR
, 
Ü2
);

3116 
	`em™_br
(
nå_´og
, 
BR_BEQ
, 
š¢
->
off
, 0);

3119 
	}
}

3121 
	$jeq32_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3123 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

3124 
sw»g
 
tmp_»g
;

3126 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
š¢
->
imm
, 
	`imm_b
(nfp_prog));

3127 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

3128 
	`»g_a
(
š¢
->
d¡_»g
 * 2), 
ALU_OP_XOR
, 
tmp_»g
);

3129 
	`em™_br
(
nå_´og
, 
BR_BEQ
, 
š¢
->
off
, 0);

3132 
	}
}

3134 
	$j£t_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3136 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

3137 
u64
 
imm
 = 
š¢
->imm;

3138 
u8
 
d¡_g´
 = 
š¢
->
d¡_»g
 * 2;

3139 
sw»g
 
tmp_»g
;

3141 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
 & ~0U, 
	`imm_b
(nfp_prog));

3142 
	`em™_®u
(
nå_´og
, 
	`imm_b
(nfp_prog),

3143 
	`»g_a
(
d¡_g´
), 
ALU_OP_AND
, 
tmp_»g
);

3147 ià(
	`is_mbpf_jmp64
(
m‘a
è&& 
imm
 >> 32) {

3148 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

3149 
	`»g_a
(
d¡_g´
 + 1), 
ALU_OP_OR
, 
	`imm_b
(
nå_´og
));

3151 
	`em™_br
(
nå_´og
, 
BR_BNE
, 
š¢
->
off
, 0);

3154 
	}
}

3156 
	$jÃ_imm
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3158 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

3159 
u64
 
imm
 = 
š¢
->imm;

3160 
boÞ
 
is_jmp32
 = 
	`is_mbpf_jmp32
(
m‘a
);

3161 
sw»g
 
tmp_»g
;

3163 ià(!
imm
) {

3164 ià(
is_jmp32
)

3165 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),„eg_nÚe(), 
ALU_OP_NONE
,

3166 
	`»g_b
(
š¢
->
d¡_»g
 * 2));

3168 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(
š¢
->
d¡_»g
 * 2),

3169 
ALU_OP_OR
, 
	`»g_b
(
š¢
->
d¡_»g
 * 2 + 1));

3170 
	`em™_br
(
nå_´og
, 
BR_BNE
, 
š¢
->
off
, 0);

3174 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
 & ~0U, 
	`imm_b
(nfp_prog));

3175 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

3176 
	`»g_a
(
š¢
->
d¡_»g
 * 2), 
ALU_OP_XOR
, 
tmp_»g
);

3177 
	`em™_br
(
nå_´og
, 
BR_BNE
, 
š¢
->
off
, 0);

3179 ià(
is_jmp32
)

3182 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
imm
 >> 32, 
	`imm_b
(nfp_prog));

3183 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(),

3184 
	`»g_a
(
š¢
->
d¡_»g
 * 2 + 1), 
ALU_OP_XOR
, 
tmp_»g
);

3185 
	`em™_br
(
nå_´og
, 
BR_BNE
, 
š¢
->
off
, 0);

3188 
	}
}

3190 
	$jeq_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3192 cÚ¡ 
bpf_š¢
 *
š¢
 = &
m‘a
->insn;

3194 
	`em™_®u
(
nå_´og
, 
	`imm_a
Òå_´og), 
	`»g_a
(
š¢
->
d¡_»g
 * 2),

3195 
ALU_OP_XOR
, 
	`»g_b
(
š¢
->
¤c_»g
 * 2));

3196 ià(
	`is_mbpf_jmp64
(
m‘a
)) {

3197 
	`em™_®u
(
nå_´og
, 
	`imm_b
(nfp_prog),

3198 
	`»g_a
(
š¢
->
d¡_»g
 * 2 + 1), 
ALU_OP_XOR
,

3199 
	`»g_b
(
š¢
->
¤c_»g
 * 2 + 1));

3200 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`imm_a
Òå_´og), 
ALU_OP_OR
,

3201 
	`imm_b
(
nå_´og
));

3203 
	`em™_br
(
nå_´og
, 
BR_BEQ
, 
š¢
->
off
, 0);

3206 
	}
}

3208 
	$j£t_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3210  
	`w½_‹¡_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_AND
, 
BR_BNE
);

3211 
	}
}

3213 
	$jÃ_»g
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3215  
	`w½_‹¡_»g
(
nå_´og
, 
m‘a
, 
ALU_OP_XOR
, 
BR_BNE
);

3216 
	}
}

3219 
	$bpf_to_bpf_ÿÎ
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3221 
u32
 
»t_tgt
, 
¡ack_d•th
, 
off£t_br
;

3222 
sw»g
 
tmp_»g
;

3224 
¡ack_d•th
 = 
	`round_up
(
nå_´og
->
¡ack_äame_d•th
, 
STACK_FRAME_ALIGN
);

3228 ià(
¡ack_d•th
) {

3229 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
¡ack_d•th
,

3230 
	`¡ack_imm
(
nå_´og
));

3231 
	`em™_®u
(
nå_´og
, 
	`¡ack_»g
(nfp_prog),

3232 
	`¡ack_»g
(
nå_´og
), 
ALU_OP_ADD
, 
tmp_»g
);

3233 
	`em™_c¤_wr
(
nå_´og
, 
	`¡ack_»g
(nfp_prog),

3234 
NFP_CSR_ACT_LM_ADDR0
);

3268 ià(!
m‘a
->
jmp_d¡
) {

3269 
	`´_”r
("BUG: BPF-to-BPF call has‚o destination„ecorded\n");

3270  -
ELOOP
;

3272 ià(
nå_´og
->
sub´og
[
m‘a
->
jmp_d¡
->
sub´og_idx
].
Ãeds_»g_push
) {

3273 
»t_tgt
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 3;

3274 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
, 2,

3275 
RELO_BR_GO_CALL_PUSH_REGS
);

3276 
off£t_br
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
);

3277 
	`w½_immed_»lo
(
nå_´og
, 
	`imm_b
Òå_´og), 0, 
RELO_IMMED_REL
);

3279 
»t_tgt
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
) + 2;

3280 
	`em™_br
(
nå_´og
, 
BR_UNC
, 
m‘a
->
š¢
.
imm
, 1);

3281 
off£t_br
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
);

3283 
	`w½_immed_»lo
(
nå_´og
, 
	`»t_»g
Òå_´og), 
»t_tgt
, 
RELO_IMMED_REL
);

3285 ià(!
	`nå_´og_cÚfœm_cu¼’t_off£t
(
nå_´og
, 
»t_tgt
))

3286  -
EINVAL
;

3288 ià(
¡ack_d•th
) {

3289 
tmp_»g
 = 
	`ur_lßd_imm_ªy
(
nå_´og
, 
¡ack_d•th
,

3290 
	`¡ack_imm
(
nå_´og
));

3291 
	`em™_®u
(
nå_´og
, 
	`¡ack_»g
(nfp_prog),

3292 
	`¡ack_»g
(
nå_´og
), 
ALU_OP_SUB
, 
tmp_»g
);

3293 
	`em™_c¤_wr
(
nå_´og
, 
	`¡ack_»g
(nfp_prog),

3294 
NFP_CSR_ACT_LM_ADDR0
);

3295 
	`w½_nÝs
(
nå_´og
, 3);

3298 
m‘a
->
num_š¢s_aá”_br
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
);

3299 
m‘a
->
num_š¢s_aá”_br
 -ð
off£t_br
;

3302 
	}
}

3304 
	$h–³r_ÿÎ
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3306 
m‘a
->
š¢
.
imm
) {

3307 
BPF_FUNC_xdp_adju¡_h—d
:

3308  
	`adju¡_h—d
(
nå_´og
, 
m‘a
);

3309 
BPF_FUNC_xdp_adju¡_ž
:

3310  
	`adju¡_ž
(
nå_´og
, 
m‘a
);

3311 
BPF_FUNC_m­_lookup_–em
:

3312 
BPF_FUNC_m­_upd©e_–em
:

3313 
BPF_FUNC_m­_d–‘e_–em
:

3314  
	`m­_ÿÎ_¡ack_commÚ
(
nå_´og
, 
m‘a
);

3315 
BPF_FUNC_g‘_´ªdom_u32
:

3316  
	`nå_g‘_´ªdom_u32
(
nå_´og
, 
m‘a
);

3317 
BPF_FUNC_³rf_ev’t_ouut
:

3318  
	`nå_³rf_ev’t_ouut
(
nå_´og
, 
m‘a
);

3320 
	`WARN_ONCE
(1, "verifier‡llowed unsupported function\n");

3321  -
EOPNOTSUPP
;

3323 
	}
}

3325 
	$ÿÎ
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3327 ià(
	`is_mbpf_p£udo_ÿÎ
(
m‘a
))

3328  
	`bpf_to_bpf_ÿÎ
(
nå_´og
, 
m‘a
);

3330  
	`h–³r_ÿÎ
(
nå_´og
, 
m‘a
);

3331 
	}
}

3333 
boÞ
 
	$nå_is_maš_funùiÚ
(
nå_š¢_m‘a
 *
m‘a
)

3335  
m‘a
->
sub´og_idx
 == 0;

3336 
	}
}

3338 
	$gÙo_out
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3340 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
, 0, 
RELO_BR_GO_OUT
);

3343 
	}
}

3346 
	$nå_sub´og_•žogue
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3348 ià(
nå_´og
->
sub´og
[
m‘a
->
sub´og_idx
].
Ãeds_»g_push
) {

3354 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
, 1,

3355 
RELO_BR_GO_CALL_POP_REGS
);

3357 
	`w½_mov
(
nå_´og
, 
	`»t_»g
Òå_´og), 
	`»g_lm
(0, 0));

3360 
	`w½_mov
(
nå_´og
, 
	`»t_»g
Òå_´og), 
	`»g_lm
(0, 0));

3364 
	`em™_¹n
(
nå_´og
, 
	`»t_»g
(nfp_prog), 0);

3368 
	}
}

3370 
	$jmp_ex™
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3372 ià(
	`nå_is_maš_funùiÚ
(
m‘a
))

3373  
	`gÙo_out
(
nå_´og
, 
m‘a
);

3375  
	`nå_sub´og_•žogue
(
nå_´og
, 
m‘a
);

3376 
	}
}

3378 cÚ¡ 
š¡r_cb_t
 
	gš¡r_cb
[256] = {

3379 [
BPF_ALU64
 | 
BPF_MOV
 | 
BPF_X
] = 
mov_»g64
,

3380 [
BPF_ALU64
 | 
BPF_MOV
 | 
BPF_K
] = 
mov_imm64
,

3381 [
BPF_ALU64
 | 
BPF_XOR
 | 
BPF_X
] = 
xÜ_»g64
,

3382 [
BPF_ALU64
 | 
BPF_XOR
 | 
BPF_K
] = 
xÜ_imm64
,

3383 [
BPF_ALU64
 | 
BPF_AND
 | 
BPF_X
] = 
ªd_»g64
,

3384 [
BPF_ALU64
 | 
BPF_AND
 | 
BPF_K
] = 
ªd_imm64
,

3385 [
BPF_ALU64
 | 
BPF_OR
 | 
BPF_X
] = 
Ü_»g64
,

3386 [
BPF_ALU64
 | 
BPF_OR
 | 
BPF_K
] = 
Ü_imm64
,

3387 [
BPF_ALU64
 | 
BPF_ADD
 | 
BPF_X
] = 
add_»g64
,

3388 [
BPF_ALU64
 | 
BPF_ADD
 | 
BPF_K
] = 
add_imm64
,

3389 [
BPF_ALU64
 | 
BPF_SUB
 | 
BPF_X
] = 
sub_»g64
,

3390 [
BPF_ALU64
 | 
BPF_SUB
 | 
BPF_K
] = 
sub_imm64
,

3391 [
BPF_ALU64
 | 
BPF_MUL
 | 
BPF_X
] = 
mul_»g64
,

3392 [
BPF_ALU64
 | 
BPF_MUL
 | 
BPF_K
] = 
mul_imm64
,

3393 [
BPF_ALU64
 | 
BPF_DIV
 | 
BPF_X
] = 
div_»g64
,

3394 [
BPF_ALU64
 | 
BPF_DIV
 | 
BPF_K
] = 
div_imm64
,

3395 [
BPF_ALU64
 | 
BPF_NEG
] = 
Ãg_»g64
,

3396 [
BPF_ALU64
 | 
BPF_LSH
 | 
BPF_X
] = 
shl_»g64
,

3397 [
BPF_ALU64
 | 
BPF_LSH
 | 
BPF_K
] = 
shl_imm64
,

3398 [
BPF_ALU64
 | 
BPF_RSH
 | 
BPF_X
] = 
shr_»g64
,

3399 [
BPF_ALU64
 | 
BPF_RSH
 | 
BPF_K
] = 
shr_imm64
,

3400 [
BPF_ALU64
 | 
BPF_ARSH
 | 
BPF_X
] = 
ashr_»g64
,

3401 [
BPF_ALU64
 | 
BPF_ARSH
 | 
BPF_K
] = 
ashr_imm64
,

3402 [
BPF_ALU
 | 
BPF_MOV
 | 
BPF_X
] = 
mov_»g
,

3403 [
BPF_ALU
 | 
BPF_MOV
 | 
BPF_K
] = 
mov_imm
,

3404 [
BPF_ALU
 | 
BPF_XOR
 | 
BPF_X
] = 
xÜ_»g
,

3405 [
BPF_ALU
 | 
BPF_XOR
 | 
BPF_K
] = 
xÜ_imm
,

3406 [
BPF_ALU
 | 
BPF_AND
 | 
BPF_X
] = 
ªd_»g
,

3407 [
BPF_ALU
 | 
BPF_AND
 | 
BPF_K
] = 
ªd_imm
,

3408 [
BPF_ALU
 | 
BPF_OR
 | 
BPF_X
] = 
Ü_»g
,

3409 [
BPF_ALU
 | 
BPF_OR
 | 
BPF_K
] = 
Ü_imm
,

3410 [
BPF_ALU
 | 
BPF_ADD
 | 
BPF_X
] = 
add_»g
,

3411 [
BPF_ALU
 | 
BPF_ADD
 | 
BPF_K
] = 
add_imm
,

3412 [
BPF_ALU
 | 
BPF_SUB
 | 
BPF_X
] = 
sub_»g
,

3413 [
BPF_ALU
 | 
BPF_SUB
 | 
BPF_K
] = 
sub_imm
,

3414 [
BPF_ALU
 | 
BPF_MUL
 | 
BPF_X
] = 
mul_»g
,

3415 [
BPF_ALU
 | 
BPF_MUL
 | 
BPF_K
] = 
mul_imm
,

3416 [
BPF_ALU
 | 
BPF_DIV
 | 
BPF_X
] = 
div_»g
,

3417 [
BPF_ALU
 | 
BPF_DIV
 | 
BPF_K
] = 
div_imm
,

3418 [
BPF_ALU
 | 
BPF_NEG
] = 
Ãg_»g
,

3419 [
BPF_ALU
 | 
BPF_LSH
 | 
BPF_X
] = 
shl_»g
,

3420 [
BPF_ALU
 | 
BPF_LSH
 | 
BPF_K
] = 
shl_imm
,

3421 [
BPF_ALU
 | 
BPF_RSH
 | 
BPF_X
] = 
shr_»g
,

3422 [
BPF_ALU
 | 
BPF_RSH
 | 
BPF_K
] = 
shr_imm
,

3423 [
BPF_ALU
 | 
BPF_ARSH
 | 
BPF_X
] = 
ashr_»g
,

3424 [
BPF_ALU
 | 
BPF_ARSH
 | 
BPF_K
] = 
ashr_imm
,

3425 [
BPF_ALU
 | 
BPF_END
 | 
BPF_X
] = 
’d_»g32
,

3426 [
BPF_LD
 | 
BPF_IMM
 | 
BPF_DW
] = 
imm_ld8
,

3427 [
BPF_LD
 | 
BPF_ABS
 | 
BPF_B
] = 
d©a_ld1
,

3428 [
BPF_LD
 | 
BPF_ABS
 | 
BPF_H
] = 
d©a_ld2
,

3429 [
BPF_LD
 | 
BPF_ABS
 | 
BPF_W
] = 
d©a_ld4
,

3430 [
BPF_LD
 | 
BPF_IND
 | 
BPF_B
] = 
d©a_šd_ld1
,

3431 [
BPF_LD
 | 
BPF_IND
 | 
BPF_H
] = 
d©a_šd_ld2
,

3432 [
BPF_LD
 | 
BPF_IND
 | 
BPF_W
] = 
d©a_šd_ld4
,

3433 [
BPF_LDX
 | 
BPF_MEM
 | 
BPF_B
] = 
mem_ldx1
,

3434 [
BPF_LDX
 | 
BPF_MEM
 | 
BPF_H
] = 
mem_ldx2
,

3435 [
BPF_LDX
 | 
BPF_MEM
 | 
BPF_W
] = 
mem_ldx4
,

3436 [
BPF_LDX
 | 
BPF_MEM
 | 
BPF_DW
] = 
mem_ldx8
,

3437 [
BPF_STX
 | 
BPF_MEM
 | 
BPF_B
] = 
mem_¡x1
,

3438 [
BPF_STX
 | 
BPF_MEM
 | 
BPF_H
] = 
mem_¡x2
,

3439 [
BPF_STX
 | 
BPF_MEM
 | 
BPF_W
] = 
mem_¡x4
,

3440 [
BPF_STX
 | 
BPF_MEM
 | 
BPF_DW
] = 
mem_¡x8
,

3441 [
BPF_STX
 | 
BPF_XADD
 | 
BPF_W
] = 
mem_xadd4
,

3442 [
BPF_STX
 | 
BPF_XADD
 | 
BPF_DW
] = 
mem_xadd8
,

3443 [
BPF_ST
 | 
BPF_MEM
 | 
BPF_B
] = 
mem_¡1
,

3444 [
BPF_ST
 | 
BPF_MEM
 | 
BPF_H
] = 
mem_¡2
,

3445 [
BPF_ST
 | 
BPF_MEM
 | 
BPF_W
] = 
mem_¡4
,

3446 [
BPF_ST
 | 
BPF_MEM
 | 
BPF_DW
] = 
mem_¡8
,

3447 [
BPF_JMP
 | 
BPF_JA
 | 
BPF_K
] = 
jump
,

3448 [
BPF_JMP
 | 
BPF_JEQ
 | 
BPF_K
] = 
jeq_imm
,

3449 [
BPF_JMP
 | 
BPF_JGT
 | 
BPF_K
] = 
cmp_imm
,

3450 [
BPF_JMP
 | 
BPF_JGE
 | 
BPF_K
] = 
cmp_imm
,

3451 [
BPF_JMP
 | 
BPF_JLT
 | 
BPF_K
] = 
cmp_imm
,

3452 [
BPF_JMP
 | 
BPF_JLE
 | 
BPF_K
] = 
cmp_imm
,

3453 [
BPF_JMP
 | 
BPF_JSGT
 | 
BPF_K
] = 
cmp_imm
,

3454 [
BPF_JMP
 | 
BPF_JSGE
 | 
BPF_K
] = 
cmp_imm
,

3455 [
BPF_JMP
 | 
BPF_JSLT
 | 
BPF_K
] = 
cmp_imm
,

3456 [
BPF_JMP
 | 
BPF_JSLE
 | 
BPF_K
] = 
cmp_imm
,

3457 [
BPF_JMP
 | 
BPF_JSET
 | 
BPF_K
] = 
j£t_imm
,

3458 [
BPF_JMP
 | 
BPF_JNE
 | 
BPF_K
] = 
jÃ_imm
,

3459 [
BPF_JMP
 | 
BPF_JEQ
 | 
BPF_X
] = 
jeq_»g
,

3460 [
BPF_JMP
 | 
BPF_JGT
 | 
BPF_X
] = 
cmp_»g
,

3461 [
BPF_JMP
 | 
BPF_JGE
 | 
BPF_X
] = 
cmp_»g
,

3462 [
BPF_JMP
 | 
BPF_JLT
 | 
BPF_X
] = 
cmp_»g
,

3463 [
BPF_JMP
 | 
BPF_JLE
 | 
BPF_X
] = 
cmp_»g
,

3464 [
BPF_JMP
 | 
BPF_JSGT
 | 
BPF_X
] = 
cmp_»g
,

3465 [
BPF_JMP
 | 
BPF_JSGE
 | 
BPF_X
] = 
cmp_»g
,

3466 [
BPF_JMP
 | 
BPF_JSLT
 | 
BPF_X
] = 
cmp_»g
,

3467 [
BPF_JMP
 | 
BPF_JSLE
 | 
BPF_X
] = 
cmp_»g
,

3468 [
BPF_JMP
 | 
BPF_JSET
 | 
BPF_X
] = 
j£t_»g
,

3469 [
BPF_JMP
 | 
BPF_JNE
 | 
BPF_X
] = 
jÃ_»g
,

3470 [
BPF_JMP32
 | 
BPF_JEQ
 | 
BPF_K
] = 
jeq32_imm
,

3471 [
BPF_JMP32
 | 
BPF_JGT
 | 
BPF_K
] = 
cmp_imm
,

3472 [
BPF_JMP32
 | 
BPF_JGE
 | 
BPF_K
] = 
cmp_imm
,

3473 [
BPF_JMP32
 | 
BPF_JLT
 | 
BPF_K
] = 
cmp_imm
,

3474 [
BPF_JMP32
 | 
BPF_JLE
 | 
BPF_K
] = 
cmp_imm
,

3475 [
BPF_JMP32
 | 
BPF_JSGT
 | 
BPF_K
] =
cmp_imm
,

3476 [
BPF_JMP32
 | 
BPF_JSGE
 | 
BPF_K
] =
cmp_imm
,

3477 [
BPF_JMP32
 | 
BPF_JSLT
 | 
BPF_K
] =
cmp_imm
,

3478 [
BPF_JMP32
 | 
BPF_JSLE
 | 
BPF_K
] =
cmp_imm
,

3479 [
BPF_JMP32
 | 
BPF_JSET
 | 
BPF_K
] =
j£t_imm
,

3480 [
BPF_JMP32
 | 
BPF_JNE
 | 
BPF_K
] = 
jÃ_imm
,

3481 [
BPF_JMP32
 | 
BPF_JEQ
 | 
BPF_X
] = 
jeq_»g
,

3482 [
BPF_JMP32
 | 
BPF_JGT
 | 
BPF_X
] = 
cmp_»g
,

3483 [
BPF_JMP32
 | 
BPF_JGE
 | 
BPF_X
] = 
cmp_»g
,

3484 [
BPF_JMP32
 | 
BPF_JLT
 | 
BPF_X
] = 
cmp_»g
,

3485 [
BPF_JMP32
 | 
BPF_JLE
 | 
BPF_X
] = 
cmp_»g
,

3486 [
BPF_JMP32
 | 
BPF_JSGT
 | 
BPF_X
] =
cmp_»g
,

3487 [
BPF_JMP32
 | 
BPF_JSGE
 | 
BPF_X
] =
cmp_»g
,

3488 [
BPF_JMP32
 | 
BPF_JSLT
 | 
BPF_X
] =
cmp_»g
,

3489 [
BPF_JMP32
 | 
BPF_JSLE
 | 
BPF_X
] =
cmp_»g
,

3490 [
BPF_JMP32
 | 
BPF_JSET
 | 
BPF_X
] =
j£t_»g
,

3491 [
BPF_JMP32
 | 
BPF_JNE
 | 
BPF_X
] = 
jÃ_»g
,

3492 [
BPF_JMP
 | 
BPF_CALL
] = 
ÿÎ
,

3493 [
BPF_JMP
 | 
BPF_EXIT
] = 
jmp_ex™
,

3498 
	$nå_fixup_immed_»lo
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

3499 
nå_š¢_m‘a
 *
jmp_d¡
, 
u32
 
br_idx
)

3501 ià(
	`immed_g‘_v®ue
(
nå_´og
->
´og
[
br_idx
 + 1])) {

3502 
	`´_”r
("BUG: failedo fix up callee„egister saving\n");

3503  -
EINVAL
;

3506 
	`immed_£t_v®ue
(&
nå_´og
->
´og
[
br_idx
 + 1], 
jmp_d¡
->
off
);

3509 
	}
}

3511 
	$nå_fixup_b¿nches
(
nå_´og
 *nfp_prog)

3513 
nå_š¢_m‘a
 *
m‘a
, *
jmp_d¡
;

3514 
u32
 
idx
, 
br_idx
;

3515 
”r
;

3517 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

3518 ià(
m‘a
->
æags
 & 
FLAG_INSN_SKIP_MASK
)

3520 ià(!
	`is_mbpf_jmp
(
m‘a
))

3522 ià(
m‘a
->
š¢
.
code
 =ð(
BPF_JMP
 | 
BPF_EXIT
) &&

3523 !
	`nå_is_maš_funùiÚ
(
m‘a
))

3525 ià(
	`is_mbpf_h–³r_ÿÎ
(
m‘a
))

3528 ià(
	`li¡_is_Ï¡
(&
m‘a
->
l
, &
nå_´og
->
š¢s
))

3529 
br_idx
 = 
nå_´og
->
Ï¡_bpf_off
;

3531 
br_idx
 = 
	`li¡_Ãxt_’Œy
(
m‘a
, 
l
)->
off
 - 1;

3538 ià(
	`is_mbpf_p£udo_ÿÎ
(
m‘a
))

3539 
br_idx
 -ð
m‘a
->
num_š¢s_aá”_br
;

3541 ià(!
	`nå_is_br
(
nå_´og
->
´og
[
br_idx
])) {

3542 
	`´_”r
("Fixup found block‚otƒnding in branch %d %02x %016llx!!\n",

3543 
br_idx
, 
m‘a
->
š¢
.
code
, 
nå_´og
->
´og
[br_idx]);

3544  -
ELOOP
;

3547 ià(
m‘a
->
š¢
.
code
 =ð(
BPF_JMP
 | 
BPF_EXIT
))

3551 ià(
	`FIELD_GET
(
OP_RELO_TYPE
, 
nå_´og
->
´og
[
br_idx
]) !=

3552 
RELO_BR_REL
 && !
	`is_mbpf_p£udo_ÿÎ
(
m‘a
))

3555 ià(!
m‘a
->
jmp_d¡
) {

3556 
	`´_”r
("Non-exit jump doesn't have destination info„ecorded!!\n");

3557  -
ELOOP
;

3560 
jmp_d¡
 = 
m‘a
->jmp_dst;

3562 ià(
jmp_d¡
->
æags
 & 
FLAG_INSN_SKIP_PREC_DEPENDENT
) {

3563 
	`´_”r
("Branch†anding on„emoved instruction!!\n");

3564  -
ELOOP
;

3567 ià(
	`is_mbpf_p£udo_ÿÎ
(
m‘a
) &&

3568 
nå_´og
->
sub´og
[
jmp_d¡
->
sub´og_idx
].
Ãeds_»g_push
) {

3569 
”r
 = 
	`nå_fixup_immed_»lo
(
nå_´og
, 
m‘a
,

3570 
jmp_d¡
, 
br_idx
);

3571 ià(
”r
)

3572  
”r
;

3575 ià(
	`FIELD_GET
(
OP_RELO_TYPE
, 
nå_´og
->
´og
[
br_idx
]) !=

3576 
RELO_BR_REL
)

3579 
idx
 = 
m‘a
->
off
; idx <ð
br_idx
; idx++) {

3580 ià(!
	`nå_is_br
(
nå_´og
->
´og
[
idx
]))

3582 
	`br_£t_off£t
(&
nå_´og
->
´og
[
idx
], 
jmp_d¡
->
off
);

3587 
	}
}

3589 
	$nå_šŒo
(
nå_´og
 *nfp_prog)

3591 
	`w½_immed
(
nå_´og
, 
	`¶’_»g
Òå_´og), 
	`GENMASK
(13, 0));

3592 
	`em™_®u
(
nå_´og
, 
	`¶’_»g
(nfp_prog),

3593 
	`¶’_»g
(
nå_´og
), 
ALU_OP_AND
, 
	`pv_Ën
(nfp_prog));

3594 
	}
}

3597 
	$nå_sub´og_´Þogue
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3600 
	`w½_mov
(
nå_´og
, 
	`»g_lm
(0, 0), 
	`»t_»g
(nfp_prog));

3601 
	}
}

3604 
	$nå_¡¬t_sub´og
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
)

3606 
d•th
 = 
nå_´og
->
sub´og
[
m‘a
->
sub´og_idx
].
¡ack_d•th
;

3608 
nå_´og
->
¡ack_äame_d•th
 = 
	`round_up
(
d•th
, 4);

3609 
	`nå_sub´og_´Þogue
(
nå_´og
, 
m‘a
);

3610 
	}
}

3612 
boÞ
 
	$nå_is_sub´og_¡¬t
(
nå_š¢_m‘a
 *
m‘a
)

3614  
m‘a
->
æags
 & 
FLAG_INSN_IS_SUBPROG_START
;

3615 
	}
}

3617 
	$nå_ouŒo_tc_da
(
nå_´og
 *nfp_prog)

3632 
nå_´og
->
tgt_abÜt
 = 
	`nå_´og_cu¼’t_off£t
(nfp_prog);

3634 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
, 2, 
RELO_BR_NEXT_PKT
);

3636 
	`w½_mov
(
nå_´og
, 
	`»g_a
(0), 
NFP_BPF_ABI_FLAGS
);

3637 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_a
(0), 0xc, 
	`»g_imm
(0x11), 
SHF_SC_L_SHF
, 16);

3640 
nå_´og
->
tgt_out
 = 
	`nå_´og_cu¼’t_off£t
(nfp_prog);

3643 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_imm
(7), 
ALU_OP_SUB
, 
	`»g_b
(0));

3644 
	`em™_br
(
nå_´og
, 
BR_BLO
,‚å_´og->
tgt_abÜt
, 0);

3645 
	`w½_mov
(
nå_´og
, 
	`»g_a
(0), 
NFP_BPF_ABI_FLAGS
);

3647 
	`w½_immed
(
nå_´og
, 
	`»g_b
(2), 0x41221211);

3648 
	`w½_immed
(
nå_´og
, 
	`»g_b
(3), 0x41001211);

3650 
	`em™_shf
(
nå_´og
, 
	`»g_a
(1),

3651 
	`»g_nÚe
(), 
SHF_OP_NONE
, 
	`»g_b
(0), 
SHF_SC_L_SHF
, 2);

3653 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(1), 
ALU_OP_OR
, 
	`»g_imm
(0));

3654 
	`em™_shf
(
nå_´og
, 
	`»g_a
(2),

3655 
	`»g_imm
(0xf), 
SHF_OP_AND
, 
	`»g_b
(2), 
SHF_SC_R_SHF
, 0);

3657 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(1), 
ALU_OP_OR
, 
	`»g_imm
(0));

3658 
	`em™_shf
(
nå_´og
, 
	`»g_b
(2),

3659 
	`»g_imm
(0xf), 
SHF_OP_AND
, 
	`»g_b
(3), 
SHF_SC_R_SHF
, 0);

3661 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
, 2, 
RELO_BR_NEXT_PKT
);

3663 
	`em™_shf
(
nå_´og
, 
	`»g_b
(2),

3664 
	`»g_a
(2), 
SHF_OP_OR
, 
	`»g_b
(2), 
SHF_SC_L_SHF
, 4);

3665 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_a
(0), 0xc, 
	`»g_b
(2), 
SHF_SC_L_SHF
, 16);

3666 
	}
}

3668 
	$nå_ouŒo_xdp
(
nå_´og
 *nfp_prog)

3678 
nå_´og
->
tgt_abÜt
 = 
	`nå_´og_cu¼’t_off£t
(nfp_prog);

3680 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
, 2, 
RELO_BR_NEXT_PKT
);

3682 
	`w½_mov
(
nå_´og
, 
	`»g_a
(0), 
NFP_BPF_ABI_FLAGS
);

3683 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_a
(0), 0xc, 
	`»g_imm
(0x82), 
SHF_SC_L_SHF
, 16);

3686 
nå_´og
->
tgt_out
 = 
	`nå_´og_cu¼’t_off£t
(nfp_prog);

3689 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_imm
(3), 
ALU_OP_SUB
, 
	`»g_b
(0));

3690 
	`em™_br
(
nå_´og
, 
BR_BLO
,‚å_´og->
tgt_abÜt
, 0);

3692 
	`w½_immed
(
nå_´og
, 
	`»g_b
(2), 0x44112282);

3694 
	`em™_shf
(
nå_´og
, 
	`»g_a
(1),

3695 
	`»g_nÚe
(), 
SHF_OP_NONE
, 
	`»g_b
(0), 
SHF_SC_L_SHF
, 3);

3697 
	`em™_®u
(
nå_´og
, 
	`»g_nÚe
(), 
	`»g_a
(1), 
ALU_OP_OR
, 
	`»g_imm
(0));

3698 
	`em™_shf
(
nå_´og
, 
	`»g_b
(2),

3699 
	`»g_imm
(0xff), 
SHF_OP_AND
, 
	`»g_b
(2), 
SHF_SC_R_SHF
, 0);

3701 
	`em™_br_»lo
(
nå_´og
, 
BR_UNC
, 
BR_OFF_RELO
, 2, 
RELO_BR_NEXT_PKT
);

3703 
	`w½_mov
(
nå_´og
, 
	`»g_a
(0), 
NFP_BPF_ABI_FLAGS
);

3704 
	`em™_ld_f›ld
(
nå_´og
, 
	`»g_a
(0), 0xc, 
	`»g_b
(2), 
SHF_SC_L_SHF
, 16);

3705 
	}
}

3707 
boÞ
 
	$nå_´og_Ãeds_ÿÎ“_»g_§ve
(
nå_´og
 *nfp_prog)

3709 
idx
;

3711 
idx
 = 1; idx < 
nå_´og
->
sub´og_út
; idx++)

3712 ià(
nå_´og
->
sub´og
[
idx
].
Ãeds_»g_push
)

3713  
Œue
;

3715  
çl£
;

3716 
	}
}

3718 
	$nå_push_ÿÎ“_»gi¡”s
(
nå_´og
 *nfp_prog)

3720 
u8
 
»g
;

3725 
nå_´og
->
tgt_ÿÎ_push_»gs
 = 
	`nå_´og_cu¼’t_off£t
(nfp_prog);

3726 
»g
 = 
BPF_REG_6
;„eg <ð
BPF_REG_9
;„eg++) {

3727 
u8
 
adj
 = (
»g
 - 
BPF_REG_0
) * 2;

3728 
u8
 
idx
 = (
»g
 - 
BPF_REG_6
) * 2;

3733 
	`w½_mov
(
nå_´og
, 
	`»g_lm
(0, 1 + 
idx
), 
	`»g_b
(
adj
));

3735 ià(
»g
 =ð
BPF_REG_8
)

3737 
	`em™_¹n
(
nå_´og
, 
	`imm_b
(nfp_prog), 3);

3739 
	`w½_mov
(
nå_´og
, 
	`»g_lm
(0, 1 + 
idx
 + 1), 
	`»g_b
(
adj
 + 1));

3741 
	}
}

3743 
	$nå_pÝ_ÿÎ“_»gi¡”s
(
nå_´og
 *nfp_prog)

3745 
u8
 
»g
;

3750 
nå_´og
->
tgt_ÿÎ_pÝ_»gs
 = 
	`nå_´og_cu¼’t_off£t
(nfp_prog);

3751 
»g
 = 
BPF_REG_6
;„eg <ð
BPF_REG_9
;„eg++) {

3752 
u8
 
adj
 = (
»g
 - 
BPF_REG_0
) * 2;

3753 
u8
 
idx
 = (
»g
 - 
BPF_REG_6
) * 2;

3758 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
adj
), 
	`»g_lm
(0, 1 + 
idx
));

3760 ià(
»g
 =ð
BPF_REG_8
)

3762 
	`em™_¹n
(
nå_´og
, 
	`»t_»g
(nfp_prog), 3);

3764 
	`w½_mov
(
nå_´og
, 
	`»g_bÙh
(
adj
 + 1), 
	`»g_lm
(0, 1 + 
idx
 + 1));

3766 
	}
}

3768 
	$nå_ouŒo
(
nå_´og
 *nfp_prog)

3770 
nå_´og
->
ty³
) {

3771 
BPF_PROG_TYPE_SCHED_CLS
:

3772 
	`nå_ouŒo_tc_da
(
nå_´og
);

3774 
BPF_PROG_TYPE_XDP
:

3775 
	`nå_ouŒo_xdp
(
nå_´og
);

3778 
	`WARN_ON
(1);

3781 ià(!
	`nå_´og_Ãeds_ÿÎ“_»g_§ve
(
nå_´og
))

3784 
	`nå_push_ÿÎ“_»gi¡”s
(
nå_´og
);

3785 
	`nå_pÝ_ÿÎ“_»gi¡”s
(
nå_´og
);

3786 
	}
}

3788 
	$nå_Œª¦©e
(
nå_´og
 *nfp_prog)

3790 
nå_š¢_m‘a
 *
m‘a
;

3791 
d•th
;

3792 
”r
;

3794 
d•th
 = 
nå_´og
->
sub´og
[0].
¡ack_d•th
;

3795 
nå_´og
->
¡ack_äame_d•th
 = 
	`round_up
(
d•th
, 4);

3797 
	`nå_šŒo
(
nå_´og
);

3798 ià(
nå_´og
->
”rÜ
)

3799  
nå_´og
->
”rÜ
;

3801 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

3802 
š¡r_cb_t
 
cb
 = 
š¡r_cb
[
m‘a
->
š¢
.
code
];

3804 
m‘a
->
off
 = 
	`nå_´og_cu¼’t_off£t
(
nå_´og
);

3806 ià(
	`nå_is_sub´og_¡¬t
(
m‘a
)) {

3807 
	`nå_¡¬t_sub´og
(
nå_´og
, 
m‘a
);

3808 ià(
nå_´og
->
”rÜ
)

3809  
nå_´og
->
”rÜ
;

3812 ià(
m‘a
->
æags
 & 
FLAG_INSN_SKIP_MASK
) {

3813 
nå_´og
->
n_Œª¦©ed
++;

3817 ià(
	`nå_m‘a_has_´ev
(
nå_´og
, 
m‘a
) &&

3818 
	`nå_m‘a_´ev
(
m‘a
)->
doubË_cb
)

3819 
cb
 = 
	`nå_m‘a_´ev
(
m‘a
)->
doubË_cb
;

3820 ià(!
cb
)

3821  -
ENOENT
;

3822 
”r
 = 
	`cb
(
nå_´og
, 
m‘a
);

3823 ià(
”r
)

3824  
”r
;

3825 ià(
nå_´og
->
”rÜ
)

3826  
nå_´og
->
”rÜ
;

3828 
nå_´og
->
n_Œª¦©ed
++;

3831 
nå_´og
->
Ï¡_bpf_off
 = 
	`nå_´og_cu¼’t_off£t
(nfp_prog) - 1;

3833 
	`nå_ouŒo
(
nå_´og
);

3834 ià(
nå_´og
->
”rÜ
)

3835  
nå_´og
->
”rÜ
;

3837 
	`w½_nÝs
(
nå_´og
, 
NFP_USTORE_PREFETCH_WINDOW
);

3838 ià(
nå_´og
->
”rÜ
)

3839  
nå_´og
->
”rÜ
;

3841  
	`nå_fixup_b¿nches
(
nå_´og
);

3842 
	}
}

3845 
	$nå_bpf_Ýt_»g_š™
(
nå_´og
 *nfp_prog)

3847 
nå_š¢_m‘a
 *
m‘a
;

3849 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

3850 
bpf_š¢
 
š¢
 = 
m‘a
->insn;

3853 ià(
š¢
.
code
 =ð(
BPF_ALU64
 | 
BPF_XOR
 | 
BPF_X
) &&

3854 
š¢
.
¤c_»g
 =ðš¢.
d¡_»g
)

3858 ià(
š¢
.
code
 =ð(
BPF_ALU64
 | 
BPF_MOV
 | 
BPF_X
) &&

3859 
š¢
.
¤c_»g
 =ð1 && in¢.
d¡_»g
 == 6)

3860 
m‘a
->
æags
 |ð
FLAG_INSN_SKIP_PREC_DEPENDENT
;

3863 ià(!(
m‘a
->
æags
 & 
FLAG_INSN_SKIP_MASK
))

3866 
	}
}

3871 
	$nå_bpf_Ýt_Ãg_add_sub
(
nå_´og
 *nfp_prog)

3873 
nå_š¢_m‘a
 *
m‘a
;

3875 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

3876 
bpf_š¢
 
š¢
 = 
m‘a
->insn;

3878 ià(
m‘a
->
æags
 & 
FLAG_INSN_SKIP_MASK
)

3881 ià(!
	`is_mbpf_®u
(
m‘a
è&& !
	`is_mbpf_jmp
(meta))

3883 ià(
	`BPF_SRC
(
š¢
.
code
è!ð
BPF_K
)

3885 ià(
š¢
.
imm
 >= 0)

3888 ià(
	`is_mbpf_jmp
(
m‘a
)) {

3889 
	`BPF_OP
(
š¢
.
code
)) {

3890 
BPF_JGE
:

3891 
BPF_JSGE
:

3892 
BPF_JLT
:

3893 
BPF_JSLT
:

3894 
m‘a
->
jump_Ãg_Ý
 = 
Œue
;

3900 ià(
	`BPF_OP
(
š¢
.
code
è=ð
BPF_ADD
)

3901 
š¢
.
code
 = 
	`BPF_CLASS
(š¢.codeè| 
BPF_SUB
;

3902 ià(
	`BPF_OP
(
š¢
.
code
è=ð
BPF_SUB
)

3903 
š¢
.
code
 = 
	`BPF_CLASS
(š¢.codeè| 
BPF_ADD
;

3907 
m‘a
->
š¢
.
code
 = in¢.cod| 
BPF_K
;

3910 
m‘a
->
š¢
.
imm
 = -insn.imm;

3912 
	}
}

3915 
	$nå_bpf_Ýt_ld_mask
(
nå_´og
 *nfp_prog)

3917 
nå_š¢_m‘a
 *
m‘a1
, *
m‘a2
;

3918 cÚ¡ 
s32
 
exp_mask
[] = {

3919 [
BPF_B
] = 0x000000ffU,

3920 [
BPF_H
] = 0x0000ffffU,

3921 [
BPF_W
] = 0xffffffffU,

3924 
	`nå_fÜ_—ch_š¢_w®k2
(
nå_´og
, 
m‘a1
, 
m‘a2
) {

3925 
bpf_š¢
 
š¢
, 
Ãxt
;

3927 
š¢
 = 
m‘a1
->insn;

3928 
Ãxt
 = 
m‘a2
->
š¢
;

3930 ià(
	`BPF_CLASS
(
š¢
.
code
è!ð
BPF_LD
)

3932 ià(
	`BPF_MODE
(
š¢
.
code
è!ð
BPF_ABS
 &&

3933 
	`BPF_MODE
(
š¢
.
code
è!ð
BPF_IND
)

3936 ià(
Ãxt
.
code
 !ð(
BPF_ALU64
 | 
BPF_AND
 | 
BPF_K
))

3939 ià(!
exp_mask
[
	`BPF_SIZE
(
š¢
.
code
)])

3941 ià(
exp_mask
[
	`BPF_SIZE
(
š¢
.
code
)] !ð
Ãxt
.
imm
)

3944 ià(
Ãxt
.
¤c_»g
 ||‚ext.
d¡_»g
)

3947 ià(
m‘a2
->
æags
 & 
FLAG_INSN_IS_JUMP_DST
)

3950 
m‘a2
->
æags
 |ð
FLAG_INSN_SKIP_PREC_DEPENDENT
;

3952 
	}
}

3954 
	$nå_bpf_Ýt_ld_shiá
(
nå_´og
 *nfp_prog)

3956 
nå_š¢_m‘a
 *
m‘a1
, *
m‘a2
, *
m‘a3
;

3958 
	`nå_fÜ_—ch_š¢_w®k3
(
nå_´og
, 
m‘a1
, 
m‘a2
, 
m‘a3
) {

3959 
bpf_š¢
 
š¢
, 
Ãxt1
, 
Ãxt2
;

3961 
š¢
 = 
m‘a1
->insn;

3962 
Ãxt1
 = 
m‘a2
->
š¢
;

3963 
Ãxt2
 = 
m‘a3
->
š¢
;

3965 ià(
	`BPF_CLASS
(
š¢
.
code
è!ð
BPF_LD
)

3967 ià(
	`BPF_MODE
(
š¢
.
code
è!ð
BPF_ABS
 &&

3968 
	`BPF_MODE
(
š¢
.
code
è!ð
BPF_IND
)

3970 ià(
	`BPF_SIZE
(
š¢
.
code
è!ð
BPF_W
)

3973 ià(!(
Ãxt1
.
code
 =ð(
BPF_LSH
 | 
BPF_K
 | 
BPF_ALU64
) &&

3974 
Ãxt2
.
code
 =ð(
BPF_RSH
 | 
BPF_K
 | 
BPF_ALU64
)) &&

3975 !(
Ãxt1
.
code
 =ð(
BPF_RSH
 | 
BPF_K
 | 
BPF_ALU64
) &&

3976 
Ãxt2
.
code
 =ð(
BPF_LSH
 | 
BPF_K
 | 
BPF_ALU64
)))

3979 ià(
Ãxt1
.
¤c_»g
 ||‚ext1.
d¡_»g
 ||

3980 
Ãxt2
.
¤c_»g
 ||‚ext2.
d¡_»g
)

3983 ià(
Ãxt1
.
imm
 !ð0x20 || 
Ãxt2
.imm != 0x20)

3986 ià(
m‘a2
->
æags
 & 
FLAG_INSN_IS_JUMP_DST
 ||

3987 
m‘a3
->
æags
 & 
FLAG_INSN_IS_JUMP_DST
)

3990 
m‘a2
->
æags
 |ð
FLAG_INSN_SKIP_PREC_DEPENDENT
;

3991 
m‘a3
->
æags
 |ð
FLAG_INSN_SKIP_PREC_DEPENDENT
;

3993 
	}
}

4005 
boÞ


4006 
	$cu¼_·œ_is_memýy
(
nå_š¢_m‘a
 *
ld_m‘a
,

4007 
nå_š¢_m‘a
 *
¡_m‘a
)

4009 
bpf_š¢
 *
ld
 = &
ld_m‘a
->
š¢
;

4010 
bpf_š¢
 *
¡
 = &
¡_m‘a
->
š¢
;

4012 ià(!
	`is_mbpf_lßd
(
ld_m‘a
è|| !
	`is_mbpf_¡Üe
(
¡_m‘a
))

4013  
çl£
;

4015 ià(
ld_m‘a
->
±r
.
ty³
 !ð
PTR_TO_PACKET
 &&

4016 
ld_m‘a
->
±r
.
ty³
 !ð
PTR_TO_MAP_VALUE
)

4017  
çl£
;

4019 ià(
¡_m‘a
->
±r
.
ty³
 !ð
PTR_TO_PACKET
)

4020  
çl£
;

4022 ià(
	`BPF_SIZE
(
ld
->
code
è!ðBPF_SIZE(
¡
->code))

4023  
çl£
;

4025 ià(
ld
->
d¡_»g
 !ð
¡
->
¤c_»g
)

4026  
çl£
;

4029 ià(
¡_m‘a
->
æags
 & 
FLAG_INSN_IS_JUMP_DST
)

4030  
çl£
;

4032  
Œue
;

4033 
	}
}

4042 
boÞ


4043 
	$cu¼_·œ_chaš_w™h_´evious
(
nå_š¢_m‘a
 *
ld_m‘a
,

4044 
nå_š¢_m‘a
 *
¡_m‘a
,

4045 
bpf_š¢
 *
´ev_ld
,

4046 
bpf_š¢
 *
´ev_¡
)

4048 
u8
 
´ev_size
, 
cu¼_size
, 
´ev_ld_ba£
, 
´ev_¡_ba£
, 
´ev_ld_d¡
;

4049 
bpf_š¢
 *
ld
 = &
ld_m‘a
->
š¢
;

4050 
bpf_š¢
 *
¡
 = &
¡_m‘a
->
š¢
;

4051 
s16
 
´ev_ld_off
, 
´ev_¡_off
;

4054 ià(!
´ev_ld
)

4055  
Œue
;

4057 
´ev_size
 = 
	`BPF_LDST_BYTES
(
´ev_ld
);

4058 
cu¼_size
 = 
	`BPF_LDST_BYTES
(
ld
);

4059 
´ev_ld_ba£
 = 
´ev_ld
->
¤c_»g
;

4060 
´ev_¡_ba£
 = 
´ev_¡
->
d¡_»g
;

4061 
´ev_ld_d¡
 = 
´ev_ld
->
d¡_»g
;

4062 
´ev_ld_off
 = 
´ev_ld
->
off
;

4063 
´ev_¡_off
 = 
´ev_¡
->
off
;

4065 ià(
ld
->
d¡_»g
 !ð
´ev_ld_d¡
)

4066  
çl£
;

4068 ià(
ld
->
¤c_»g
 !ð
´ev_ld_ba£
 || 
¡
->
d¡_»g
 !ð
´ev_¡_ba£
)

4069  
çl£
;

4071 ià(
cu¼_size
 !ð
´ev_size
)

4072  
çl£
;

4075 ià(
ld_m‘a
->
æags
 & 
FLAG_INSN_IS_JUMP_DST
)

4076  
çl£
;

4079 ià(
´ev_ld_off
 + 
´ev_size
 =ð
ld
->
off
 &&

4080 
´ev_¡_off
 + 
´ev_size
 =ð
¡
->
off
)

4081  
Œue
;

4084 ià(
ld
->
off
 + 
cu¼_size
 =ð
´ev_ld_off
 &&

4085 
¡
->
off
 + 
cu¼_size
 =ð
´ev_¡_off
)

4086  
Œue
;

4088  
çl£
;

4089 
	}
}

4096 
boÞ


4097 
	$üoss_mem_acûss
(
bpf_š¢
 *
ld
, 
nå_š¢_m‘a
 *
h—d_ld_m‘a
,

4098 
nå_š¢_m‘a
 *
h—d_¡_m‘a
)

4100 
s16
 
h—d_ld_off
, 
h—d_¡_off
, 
ld_off
;

4103 ià(
h—d_ld_m‘a
->
±r
.
ty³
 !ð
h—d_¡_m‘a
->ptr.type)

4104  
çl£
;

4107 ià(
h—d_ld_m‘a
->
±r
.
id
 !ð
h—d_¡_m‘a
->ptr.id)

4108  
Œue
;

4113 
h—d_ld_off
 = 
h—d_ld_m‘a
->
š¢
.
off
 + h—d_ld_m‘a->
±r
.off;

4114 
h—d_¡_off
 = 
h—d_¡_m‘a
->
š¢
.
off
 + h—d_¡_m‘a->
±r
.off;

4115 
ld_off
 = 
ld
->
off
 + 
h—d_ld_m‘a
->
±r
.off;

4118 ià(
ld_off
 > 
h—d_ld_off
 &&

4119 
h—d_ld_off
 < 
h—d_¡_off
 && 
ld_off
 >= head_st_off)

4120  
Œue
;

4123 ià(
ld_off
 < 
h—d_ld_off
 &&

4124 
h—d_ld_off
 > 
h—d_¡_off
 && 
ld_off
 <= head_st_off)

4125  
Œue
;

4127  
çl£
;

4128 
	}
}

4143 
	$nå_bpf_Ýt_ld¡_g©h”
(
nå_´og
 *nfp_prog)

4145 
nå_š¢_m‘a
 *
h—d_ld_m‘a
 = 
NULL
;

4146 
nå_š¢_m‘a
 *
h—d_¡_m‘a
 = 
NULL
;

4147 
nå_š¢_m‘a
 *
m‘a1
, *
m‘a2
;

4148 
bpf_š¢
 *
´ev_ld
 = 
NULL
;

4149 
bpf_š¢
 *
´ev_¡
 = 
NULL
;

4150 
u8
 
couÁ
 = 0;

4152 
	`nå_fÜ_—ch_š¢_w®k2
(
nå_´og
, 
m‘a1
, 
m‘a2
) {

4153 
bpf_š¢
 *
ld
 = &
m‘a1
->
š¢
;

4154 
bpf_š¢
 *
¡
 = &
m‘a2
->
š¢
;

4164 ià(!
	`cu¼_·œ_is_memýy
(
m‘a1
, 
m‘a2
) ||

4165 !
	`cu¼_·œ_chaš_w™h_´evious
(
m‘a1
, 
m‘a2
, 
´ev_ld
,

4166 
´ev_¡
) ||

4167 (
h—d_ld_m‘a
 && (
	`üoss_mem_acûss
(
ld
, head_ld_meta,

4168 
h—d_¡_m‘a
) ||

4169 
h—d_ld_m‘a
->
ld¡_g©h”_Ën
 >= 128))) {

4170 ià(!
couÁ
)

4173 ià(
couÁ
 > 1) {

4174 
s16
 
´ev_ld_off
 = 
´ev_ld
->
off
;

4175 
s16
 
´ev_¡_off
 = 
´ev_¡
->
off
;

4176 
s16
 
h—d_ld_off
 = 
h—d_ld_m‘a
->
š¢
.
off
;

4178 ià(
´ev_ld_off
 < 
h—d_ld_off
) {

4179 
h—d_ld_m‘a
->
š¢
.
off
 = 
´ev_ld_off
;

4180 
h—d_¡_m‘a
->
š¢
.
off
 = 
´ev_¡_off
;

4181 
h—d_ld_m‘a
->
ld¡_g©h”_Ën
 =

4182 -
h—d_ld_m‘a
->
ld¡_g©h”_Ën
;

4185 
h—d_ld_m‘a
->
·œed_¡
 = &
h—d_¡_m‘a
->
š¢
;

4186 
h—d_¡_m‘a
->
æags
 |=

4187 
FLAG_INSN_SKIP_PREC_DEPENDENT
;

4189 
h—d_ld_m‘a
->
ld¡_g©h”_Ën
 = 0;

4195 ià(
	`cu¼_·œ_is_memýy
(
m‘a1
, 
m‘a2
)) {

4196 
h—d_ld_m‘a
 = 
m‘a1
;

4197 
h—d_¡_m‘a
 = 
m‘a2
;

4198 
h—d_ld_m‘a
->
ld¡_g©h”_Ën
 =

4199 
	`BPF_LDST_BYTES
(
ld
);

4200 
m‘a1
 = 
	`nå_m‘a_Ãxt
(meta1);

4201 
m‘a2
 = 
	`nå_m‘a_Ãxt
(meta2);

4202 
´ev_ld
 = 
ld
;

4203 
´ev_¡
 = 
¡
;

4204 
couÁ
 = 1;

4206 
h—d_ld_m‘a
 = 
NULL
;

4207 
h—d_¡_m‘a
 = 
NULL
;

4208 
´ev_ld
 = 
NULL
;

4209 
´ev_¡
 = 
NULL
;

4210 
couÁ
 = 0;

4216 ià(!
h—d_ld_m‘a
) {

4217 
h—d_ld_m‘a
 = 
m‘a1
;

4218 
h—d_¡_m‘a
 = 
m‘a2
;

4220 
m‘a1
->
æags
 |ð
FLAG_INSN_SKIP_PREC_DEPENDENT
;

4221 
m‘a2
->
æags
 |ð
FLAG_INSN_SKIP_PREC_DEPENDENT
;

4224 
h—d_ld_m‘a
->
ld¡_g©h”_Ën
 +ð
	`BPF_LDST_BYTES
(
ld
);

4225 
m‘a1
 = 
	`nå_m‘a_Ãxt
(meta1);

4226 
m‘a2
 = 
	`nå_m‘a_Ãxt
(meta2);

4227 
´ev_ld
 = 
ld
;

4228 
´ev_¡
 = 
¡
;

4229 
couÁ
++;

4231 
	}
}

4233 
	$nå_bpf_Ýt_pkt_ÿche
(
nå_´og
 *nfp_prog)

4235 
nå_š¢_m‘a
 *
m‘a
, *
¿nge_node
 = 
NULL
;

4236 
s16
 
¿nge_¡¬t
 = 0, 
¿nge_’d
 = 0;

4237 
boÞ
 
ÿche_avaž
 = 
çl£
;

4238 
bpf_š¢
 *
š¢
;

4239 
s32
 
¿nge_±r_off
 = 0;

4240 
u32
 
¿nge_±r_id
 = 0;

4242 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

4243 ià(
m‘a
->
æags
 & 
FLAG_INSN_IS_JUMP_DST
)

4244 
ÿche_avaž
 = 
çl£
;

4246 ià(
m‘a
->
æags
 & 
FLAG_INSN_SKIP_MASK
)

4249 
š¢
 = &
m‘a
->insn;

4251 ià(
	`is_mbpf_¡Üe_pkt
(
m‘a
) ||

4252 
š¢
->
code
 =ð(
BPF_JMP
 | 
BPF_CALL
) ||

4253 
	`is_mbpf_þassic_¡Üe_pkt
(
m‘a
) ||

4254 
	`is_mbpf_þassic_lßd
(
m‘a
)) {

4255 
ÿche_avaž
 = 
çl£
;

4259 ià(!
	`is_mbpf_lßd
(
m‘a
))

4262 ià(
m‘a
->
±r
.
ty³
 !ð
PTR_TO_PACKET
 || m‘a->
ld¡_g©h”_Ën
) {

4263 
ÿche_avaž
 = 
çl£
;

4267 ià(!
ÿche_avaž
) {

4268 
ÿche_avaž
 = 
Œue
;

4269 ià(
¿nge_node
)

4270 
’d_cu¼’t_th’_¡¬t_Ãw
;

4271 
¡¬t_Ãw
;

4285 ià(
m‘a
->
±r
.
id
 =ð
¿nge_±r_id
 &&

4286 
m‘a
->
±r
.
off
 =ð
¿nge_±r_off
) {

4287 
s16
 
Ãw_¡¬t
 = 
¿nge_¡¬t
;

4288 
s16
 
’d
, 
off
 = 
š¢
->off;

4289 
s16
 
Ãw_’d
 = 
¿nge_’d
;

4290 
boÞ
 
chªged
 = 
çl£
;

4292 ià(
off
 < 
¿nge_¡¬t
) {

4293 
Ãw_¡¬t
 = 
off
;

4294 
chªged
 = 
Œue
;

4297 
’d
 = 
off
 + 
	`BPF_LDST_BYTES
(
š¢
);

4298 ià(
’d
 > 
¿nge_’d
) {

4299 
Ãw_’d
 = 
’d
;

4300 
chªged
 = 
Œue
;

4303 ià(!
chªged
)

4306 ià(
Ãw_’d
 - 
Ãw_¡¬t
 <= 64) {

4308 
¿nge_¡¬t
 = 
Ãw_¡¬t
;

4309 
¿nge_’d
 = 
Ãw_’d
;

4314 
’d_cu¼’t_th’_¡¬t_Ãw
:

4315 
¿nge_node
->
pkt_ÿche
.
¿nge_¡¬t
 =„ange_start;

4316 
¿nge_node
->
pkt_ÿche
.
¿nge_’d
 =„ange_end;

4317 
¡¬t_Ãw
:

4318 
¿nge_node
 = 
m‘a
;

4319 
¿nge_node
->
pkt_ÿche
.
do_š™
 = 
Œue
;

4320 
¿nge_±r_id
 = 
¿nge_node
->
±r
.
id
;

4321 
¿nge_±r_off
 = 
¿nge_node
->
±r
.
off
;

4322 
¿nge_¡¬t
 = 
š¢
->
off
;

4323 
¿nge_’d
 = 
š¢
->
off
 + 
	`BPF_LDST_BYTES
(insn);

4326 ià(
¿nge_node
) {

4327 
¿nge_node
->
pkt_ÿche
.
¿nge_¡¬t
 =„ange_start;

4328 
¿nge_node
->
pkt_ÿche
.
¿nge_’d
 =„ange_end;

4331 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

4332 ià(
m‘a
->
æags
 & 
FLAG_INSN_SKIP_MASK
)

4335 ià(
	`is_mbpf_lßd_pkt
(
m‘a
è&& !m‘a->
ld¡_g©h”_Ën
) {

4336 ià(
m‘a
->
pkt_ÿche
.
do_š™
) {

4337 
¿nge_¡¬t
 = 
m‘a
->
pkt_ÿche
.range_start;

4338 
¿nge_’d
 = 
m‘a
->
pkt_ÿche
.range_end;

4340 
m‘a
->
pkt_ÿche
.
¿nge_¡¬t
 =„ange_start;

4341 
m‘a
->
pkt_ÿche
.
¿nge_’d
 =„ange_end;

4345 
	}
}

4347 
	$nå_bpf_Ýtimize
(
nå_´og
 *nfp_prog)

4349 
	`nå_bpf_Ýt_»g_š™
(
nå_´og
);

4351 
	`nå_bpf_Ýt_Ãg_add_sub
(
nå_´og
);

4352 
	`nå_bpf_Ýt_ld_mask
(
nå_´og
);

4353 
	`nå_bpf_Ýt_ld_shiá
(
nå_´og
);

4354 
	`nå_bpf_Ýt_ld¡_g©h”
(
nå_´og
);

4355 
	`nå_bpf_Ýt_pkt_ÿche
(
nå_´og
);

4358 
	}
}

4360 
	$nå_bpf_»¶aû_m­_±rs
(
nå_´og
 *nfp_prog)

4362 
nå_š¢_m‘a
 *
m‘a1
, *
m‘a2
;

4363 
nå_bpf_m­
 *
nå_m­
;

4364 
bpf_m­
 *
m­
;

4365 
u32
 
id
;

4367 
	`nå_fÜ_—ch_š¢_w®k2
(
nå_´og
, 
m‘a1
, 
m‘a2
) {

4368 ià(
m‘a1
->
æags
 & 
FLAG_INSN_SKIP_MASK
 ||

4369 
m‘a2
->
æags
 & 
FLAG_INSN_SKIP_MASK
)

4372 ià(
m‘a1
->
š¢
.
code
 !ð(
BPF_LD
 | 
BPF_IMM
 | 
BPF_DW
) ||

4373 
m‘a1
->
š¢
.
¤c_»g
 !ð
BPF_PSEUDO_MAP_FD
)

4376 
m­
 = (*)()((
u32
)
m‘a1
->
š¢
.
imm
 |

4377 (
u64
)
m‘a2
->
š¢
.
imm
 << 32);

4378 ià(
	`bpf_m­_ofæßd_ÃuŒ®
(
m­
)) {

4379 
id
 = 
m­
->id;

4381 
nå_m­
 = 
	`m­_to_offm­
(
m­
)->
dev_´iv
;

4382 
id
 = 
nå_m­
->
tid
;

4385 
m‘a1
->
š¢
.
imm
 = 
id
;

4386 
m‘a2
->
š¢
.
imm
 = 0;

4390 
	}
}

4392 
	$nå_bpf_u¡Üe_ÿlc
(
u64
 *
´og
, 
Ën
)

4394 
__Ë64
 *
u¡Üe
 = (
__fÜû
 __Ë64 *)
´og
;

4395 
i
;

4397 
i
 = 0; i < 
Ën
; i++) {

4398 
”r
;

4400 
”r
 = 
	`nå_u¡Üe_check_v®id_no_ecc
(
´og
[
i
]);

4401 ià(
”r
)

4402  
”r
;

4404 
u¡Üe
[
i
] = 
	`ýu_to_Ë64
(
	`nå_u¡Üe_ÿlc_ecc_š¢
(
´og
[i]));

4408 
	}
}

4410 
	$nå_bpf_´og_Œim
(
nå_´og
 *nfp_prog)

4412 *
´og
;

4414 
´og
 = 
	`kvm®loc_¬¿y
(
nå_´og
->
´og_Ën
, (
u64
), 
GFP_KERNEL
);

4415 ià(!
´og
)

4418 
nå_´og
->
__´og_®loc_Ën
 =‚å_´og->
´og_Ën
 * (
u64
);

4419 
	`memýy
(
´og
, 
nå_´og
->´og,‚å_´og->
__´og_®loc_Ën
);

4420 
	`kvä“
(
nå_´og
->
´og
);

4421 
nå_´og
->
´og
 =…rog;

4422 
	}
}

4424 
	$nå_bpf_j™
(
nå_´og
 *nfp_prog)

4426 
»t
;

4428 
»t
 = 
	`nå_bpf_»¶aû_m­_±rs
(
nå_´og
);

4429 ià(
»t
)

4430  
»t
;

4432 
»t
 = 
	`nå_bpf_Ýtimize
(
nå_´og
);

4433 ià(
»t
)

4434  
»t
;

4436 
»t
 = 
	`nå_Œª¦©e
(
nå_´og
);

4437 ià(
»t
) {

4438 
	`´_”r
("Translation failed withƒrror %d (translated: %u)\n",

4439 
»t
, 
nå_´og
->
n_Œª¦©ed
);

4440  -
EINVAL
;

4443 
	`nå_bpf_´og_Œim
(
nå_´og
);

4445  
»t
;

4446 
	}
}

4448 
	$nå_bpf_j™_´•¬e
(
nå_´og
 *nfp_prog)

4450 
nå_š¢_m‘a
 *
m‘a
;

4453 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

4454 
nå_š¢_m‘a
 *
d¡_m‘a
;

4455 
u64
 
code
 = 
m‘a
->
š¢
.code;

4456 
d¡_idx
;

4457 
boÞ
 
p£udo_ÿÎ
;

4459 ià(!
	`is_mbpf_jmp
(
m‘a
))

4461 ià(
	`BPF_OP
(
code
è=ð
BPF_EXIT
)

4463 ià(
	`is_mbpf_h–³r_ÿÎ
(
m‘a
))

4469 
p£udo_ÿÎ
 = 
	`BPF_OP
(
code
è=ð
BPF_CALL
;

4471 ià(
p£udo_ÿÎ
)

4472 
d¡_idx
 = 
m‘a
->
n
 + 1 + m‘a->
š¢
.
imm
;

4474 
d¡_idx
 = 
m‘a
->
n
 + 1 + m‘a->
š¢
.
off
;

4476 
d¡_m‘a
 = 
	`nå_bpf_gÙo_m‘a
(
nå_´og
, 
m‘a
, 
d¡_idx
);

4478 ià(
p£udo_ÿÎ
)

4479 
d¡_m‘a
->
æags
 |ð
FLAG_INSN_IS_SUBPROG_START
;

4481 
d¡_m‘a
->
æags
 |ð
FLAG_INSN_IS_JUMP_DST
;

4482 
m‘a
->
jmp_d¡
 = 
d¡_m‘a
;

4484 
	}
}

4486 
boÞ
 
	$nå_bpf_suµÜ‹d_Ýcode
(
u8
 
code
)

4488  !!
š¡r_cb
[
code
];

4489 
	}
}

4491 *
	$nå_bpf_»lo_fÜ_vnic
(
nå_´og
 *nå_´og, 
nå_bpf_vnic
 *
bv
)

4493 
i
;

4494 
u64
 *
´og
;

4495 
”r
;

4497 
´og
 = 
	`kmemdup
(
nå_´og
->´og,‚å_´og->
´og_Ën
 * (
u64
),

4498 
GFP_KERNEL
);

4499 ià(!
´og
)

4500  
	`ERR_PTR
(-
ENOMEM
);

4502 
i
 = 0; i < 
nå_´og
->
´og_Ën
; i++) {

4503 
nå_»lo_ty³
 
¥ecŸl
;

4504 
u32
 
v®
;

4505 
u16
 
off
;

4507 
¥ecŸl
 = 
	`FIELD_GET
(
OP_RELO_TYPE
, 
´og
[
i
]);

4508 
¥ecŸl
) {

4509 
RELO_NONE
:

4511 
RELO_BR_REL
:

4512 
	`br_add_off£t
(&
´og
[
i
], 
bv
->
¡¬t_off
);

4514 
RELO_BR_GO_OUT
:

4515 
	`br_£t_off£t
(&
´og
[
i
],

4516 
nå_´og
->
tgt_out
 + 
bv
->
¡¬t_off
);

4518 
RELO_BR_GO_ABORT
:

4519 
	`br_£t_off£t
(&
´og
[
i
],

4520 
nå_´og
->
tgt_abÜt
 + 
bv
->
¡¬t_off
);

4522 
RELO_BR_GO_CALL_PUSH_REGS
:

4523 ià(!
nå_´og
->
tgt_ÿÎ_push_»gs
) {

4524 
	`´_”r
("BUG: failedo detect subprogram„egisters‚eeds\n");

4525 
”r
 = -
EINVAL
;

4526 
”r_ä“_´og
;

4528 
off
 = 
nå_´og
->
tgt_ÿÎ_push_»gs
 + 
bv
->
¡¬t_off
;

4529 
	`br_£t_off£t
(&
´og
[
i
], 
off
);

4531 
RELO_BR_GO_CALL_POP_REGS
:

4532 ià(!
nå_´og
->
tgt_ÿÎ_pÝ_»gs
) {

4533 
	`´_”r
("BUG: failedo detect subprogram„egisters‚eeds\n");

4534 
”r
 = -
EINVAL
;

4535 
”r_ä“_´og
;

4537 
off
 = 
nå_´og
->
tgt_ÿÎ_pÝ_»gs
 + 
bv
->
¡¬t_off
;

4538 
	`br_£t_off£t
(&
´og
[
i
], 
off
);

4540 
RELO_BR_NEXT_PKT
:

4541 
	`br_£t_off£t
(&
´og
[
i
], 
bv
->
tgt_dÚe
);

4543 
RELO_BR_HELPER
:

4544 
v®
 = 
	`br_g‘_off£t
(
´og
[
i
]);

4545 
v®
 -ð
BR_OFF_RELO
;

4546 
v®
) {

4547 
BPF_FUNC_m­_lookup_–em
:

4548 
v®
 = 
nå_´og
->
bpf
->
h–³rs
.
m­_lookup
;

4550 
BPF_FUNC_m­_upd©e_–em
:

4551 
v®
 = 
nå_´og
->
bpf
->
h–³rs
.
m­_upd©e
;

4553 
BPF_FUNC_m­_d–‘e_–em
:

4554 
v®
 = 
nå_´og
->
bpf
->
h–³rs
.
m­_d–‘e
;

4556 
BPF_FUNC_³rf_ev’t_ouut
:

4557 
v®
 = 
nå_´og
->
bpf
->
h–³rs
.
³rf_ev’t_ouut
;

4560 
	`´_”r
("relocation of unknown helper %d\n",

4561 
v®
);

4562 
”r
 = -
EINVAL
;

4563 
”r_ä“_´og
;

4565 
	`br_£t_off£t
(&
´og
[
i
], 
v®
);

4567 
RELO_IMMED_REL
:

4568 
	`immed_add_v®ue
(&
´og
[
i
], 
bv
->
¡¬t_off
);

4572 
´og
[
i
] &ð~
OP_RELO_TYPE
;

4575 
”r
 = 
	`nå_bpf_u¡Üe_ÿlc
(
´og
, 
nå_´og
->
´og_Ën
);

4576 ià(
”r
)

4577 
”r_ä“_´og
;

4579  
´og
;

4581 
”r_ä“_´og
:

4582 
	`kä“
(
´og
);

4583  
	`ERR_PTR
(
”r
);

4584 
	}
}

	@src/bpf/main.c

4 
	~<Ãt/pkt_þs.h
>

6 
	~"../nåcÜe/nå_ýp.h
"

7 
	~"../nåcÜe/nå_nffw.h
"

8 
	~"../nåcÜe/nå_n¥.h
"

9 
	~"../nå_­p.h
"

10 
	~"../nå_maš.h
"

11 
	~"../nå_Ãt.h
"

12 
	~"../nå_pÜt.h
"

13 
	~"fw.h
"

14 
	~"maš.h
"

16 cÚ¡ 
rhashbË_·¿ms
 
	gnå_bpf_m­s_ÃuŒ®_·¿ms
 = {

17 .
ÃËm_hšt
 = 4,

18 .
	gkey_Ën
 = 
FIELD_SIZEOF
(
bpf_m­
, 
id
),

19 .
	gkey_off£t
 = 
off£tof
(
nå_bpf_ÃuŒ®_m­
, 
m­_id
),

20 .
	gh—d_off£t
 = 
off£tof
(
nå_bpf_ÃuŒ®_m­
, 
l
),

21 .
	gautom©ic_shrškšg
 = 
Œue
,

24 
boÞ
 
	$nå_Ãt_ebpf_ÿ·bË
(
nå_Ãt
 *
Â
)

26 #ifdeà
__LITTLE_ENDIAN


27 
nå_­p_bpf
 *
bpf
 = 
Â
->
­p
->
´iv
;

29  
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_BPF
 &&

30 
bpf
->
abi_v”siÚ
 &&

31 
	`Â_»adb
(
Â
, 
NFP_NET_CFG_BPF_ABI
è=ð
bpf
->
abi_v”siÚ
;

33  
çl£
;

35 
	}
}

38 
	$nå_bpf_xdp_ofæßd
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

39 
bpf_´og
 *
´og
, 
ÃŽšk_ext_ack
 *
exck
)

41 
boÞ
 
ruÂšg
, 
xdp_ruÂšg
;

43 ià(!
	`nå_Ãt_ebpf_ÿ·bË
(
Â
))

44  -
EINVAL
;

46 
ruÂšg
 = 
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_BPF
;

47 
xdp_ruÂšg
 = 
ruÂšg
 && 
Â
->
xdp_hw
.
´og
;

49 ià(!
´og
 && !
xdp_ruÂšg
)

51 ià(
´og
 && 
ruÂšg
 && !
xdp_ruÂšg
)

52  -
EBUSY
;

54  
	`nå_Ãt_bpf_ofæßd
(
Â
, 
´og
, 
ruÂšg
, 
exck
);

55 
	}
}

57 cÚ¡ *
	$nå_bpf_exŒa_ÿp
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

59  
	`nå_Ãt_ebpf_ÿ·bË
(
Â
) ? "BPF" : "";

60 
	}
}

63 
	$nå_bpf_vnic_®loc
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
, 
id
)

65 
nå_pf
 *
pf
 = 
­p
->pf;

66 
nå_bpf_vnic
 *
bv
;

67 
”r
;

69 ià(!
pf
->
‘h_tbl
) {

70 
	`nå_”r
(
pf
->
ýp
, "No ETHable\n");

71  -
EINVAL
;

73 ià(
pf
->
max_d©a_vnics
 !ðpf->
‘h_tbl
->
couÁ
) {

74 
	`nå_”r
(
pf
->
ýp
, "ETHƒntries don't match vNICs (%d vs %d)\n",

75 
pf
->
max_d©a_vnics
,…f->
‘h_tbl
->
couÁ
);

76  -
EINVAL
;

79 
bv
 = 
	`kz®loc
((*bv), 
GFP_KERNEL
);

80 ià(!
bv
)

81  -
ENOMEM
;

82 
Â
->
­p_´iv
 = 
bv
;

84 
”r
 = 
	`nå_­p_nic_vnic_®loc
(
­p
, 
Â
, 
id
);

85 ià(
”r
)

86 
”r_ä“_´iv
;

88 
bv
->
¡¬t_off
 = 
	`Â_»adw
(
Â
, 
NFP_NET_CFG_BPF_START
);

89 
bv
->
tgt_dÚe
 = 
	`Â_»adw
(
Â
, 
NFP_NET_CFG_BPF_DONE
);

92 
”r_ä“_´iv
:

93 
	`kä“
(
Â
->
­p_´iv
);

94  
”r
;

95 
	}
}

97 
	$nå_bpf_vnic_ä“
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

99 
nå_bpf_vnic
 *
bv
 = 
Â
->
­p_´iv
;

101 
	`WARN_ON
(
bv
->
tc_´og
);

102 
	`kä“
(
bv
);

103 
	}
}

105 
	$nå_bpf_£tup_tc_block_cb
(
tc_£tup_ty³
 
ty³
,

106 *
ty³_d©a
, *
cb_´iv
)

108 
tc_þs_bpf_ofæßd
 *
þs_bpf
 = 
ty³_d©a
;

109 
nå_Ãt
 *
Â
 = 
cb_´iv
;

110 
bpf_´og
 *
Þd´og
;

111 
nå_bpf_vnic
 *
bv
;

112 
”r
;

114 ià(
ty³
 !ð
TC_SETUP_CLSBPF
) {

115 
	`NL_SET_ERR_MSG_MOD
(
þs_bpf
->
commÚ
.
exck
,

117  -
EOPNOTSUPP
;

119 ià(!
	`tc_þs_ÿn_ofæßd_ªd_chaš0
(
Â
->
dp
.
Ãtdev
, &
þs_bpf
->
commÚ
))

120  -
EOPNOTSUPP
;

121 ià(!
	`nå_Ãt_ebpf_ÿ·bË
(
Â
)) {

122 
	`NL_SET_ERR_MSG_MOD
(
þs_bpf
->
commÚ
.
exck
,

124  -
EOPNOTSUPP
;

126 ià(
þs_bpf
->
commÚ
.
´ÙocÞ
 !ð
	`htÚs
(
ETH_P_ALL
)) {

127 
	`NL_SET_ERR_MSG_MOD
(
þs_bpf
->
commÚ
.
exck
,

129  -
EOPNOTSUPP
;

133 ià(!
þs_bpf
->
exts_š‹g¿‹d
 ||

134 
	`tcf_exts_has_aùiÚs
(
þs_bpf
->
exts
)) {

135 
	`NL_SET_ERR_MSG_MOD
(
þs_bpf
->
commÚ
.
exck
,

137  -
EOPNOTSUPP
;

140 ià(
þs_bpf
->
commªd
 !ð
TC_CLSBPF_OFFLOAD
)

141  -
EOPNOTSUPP
;

143 
bv
 = 
Â
->
­p_´iv
;

144 
Þd´og
 = 
þs_bpf
->oldprog;

147 ià(
bv
->
tc_´og
 !ð
Þd´og
) {

148 
Þd´og
 = 
NULL
;

149 ià(!
þs_bpf
->
´og
)

153 
”r
 = 
	`nå_Ãt_bpf_ofæßd
(
Â
, 
þs_bpf
->
´og
, 
Þd´og
,

154 
þs_bpf
->
commÚ
.
exck
);

155 ià(
”r
)

156  
”r
;

158 
bv
->
tc_´og
 = 
þs_bpf
->
´og
;

159 
Â
->
pÜt
->
tc_ofæßd_út
 = !!
bv
->
tc_´og
;

161 
	}
}

163 
	$nå_bpf_£tup_tc_block
(
Ãt_deviû
 *
Ãtdev
,

164 
tc_block_ofæßd
 *
f
)

166 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

168 ià(
f
->
bšd”_ty³
 !ð
TCF_BLOCK_BINDER_TYPE_CLSACT_INGRESS
)

169  -
EOPNOTSUPP
;

171 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 19, 0)

172 ià(
	`tcf_block_sh¬ed
(
f
->
block
))

173  -
EOPNOTSUPP
;

176 
f
->
commªd
) {

177 
TC_BLOCK_BIND
:

178  
	`tcf_block_cb_»gi¡”
(
f
->
block
,

179 
nå_bpf_£tup_tc_block_cb
,

180 
Â
,‚n, 
f
->
exck
);

181 
TC_BLOCK_UNBIND
:

182 
	`tcf_block_cb_uÄegi¡”
(
f
->
block
,

183 
nå_bpf_£tup_tc_block_cb
,

184 
Â
);

187  -
EOPNOTSUPP
;

189 
	}
}

191 
	$nå_bpf_£tup_tc
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

192 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
)

194 
ty³
) {

195 
TC_SETUP_BLOCK
:

196  
	`nå_bpf_£tup_tc_block
(
Ãtdev
, 
ty³_d©a
);

198  -
EOPNOTSUPP
;

200 
	}
}

203 
	$nå_bpf_check_mtu
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
, 
Ãw_mtu
)

205 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

206 
max_mtu
;

208 ià(~
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_BPF
)

211 
max_mtu
 = 
	`Â_»adb
(
Â
, 
NFP_NET_CFG_BPF_INL_MTU
) * 64 - 32;

212 ià(
Ãw_mtu
 > 
max_mtu
) {

213 
	`Â_šfo
(
Â
, "BPF offload‡ctive, MTU over %u‚ot supported\n",

214 
max_mtu
);

215  -
EBUSY
;

218 
	}
}

221 
	$nå_bpf_·r£_ÿp_adju¡_h—d
(
nå_­p_bpf
 *
bpf
, 
__iomem
 *
v®ue
,

222 
u32
 
Ëngth
)

224 
nå_bpf_ÿp_Žv_adju¡_h—d
 
__iomem
 *
ÿp
 = 
v®ue
;

225 
nå_ýp
 *
ýp
 = 
bpf
->
­p
->
pf
->cpp;

227 ià(
Ëngth
 < (*
ÿp
)) {

228 
	`nå_”r
(
ýp
, "Œunÿ‹d‡dju¡_h—d TLV: %d\n", 
Ëngth
);

229  -
EINVAL
;

232 
bpf
->
adju¡_h—d
.
æags
 = 
	`»adl
(&
ÿp
->flags);

233 
bpf
->
adju¡_h—d
.
off_mš
 = 
	`»adl
(&
ÿp
->off_min);

234 
bpf
->
adju¡_h—d
.
off_max
 = 
	`»adl
(&
ÿp
->off_max);

235 
bpf
->
adju¡_h—d
.
gu¬ª‹ed_sub
 = 
	`»adl
(&
ÿp
->guaranteed_sub);

236 
bpf
->
adju¡_h—d
.
gu¬ª‹ed_add
 = 
	`»adl
(&
ÿp
->guaranteed_add);

238 ià(
bpf
->
adju¡_h—d
.
off_mš
 > bpf->adju¡_h—d.
off_max
) {

239 
	`nå_”r
(
ýp
, "invalid‡djust_head TLV: min > max\n");

240  -
EINVAL
;

242 ià(!
	`FIELD_FIT
(
UR_REG_IMM_MAX
, 
bpf
->
adju¡_h—d
.
off_mš
) ||

243 !
	`FIELD_FIT
(
UR_REG_IMM_MAX
, 
bpf
->
adju¡_h—d
.
off_max
)) {

244 
	`nå_w¬n
(
ýp
, "disabling‡djust_head - driverƒxpects min/maxo fit in‡s immediates\n");

245 
	`mem£t
(&
bpf
->
adju¡_h—d
, 0, (bpf->adjust_head));

250 
	}
}

253 
	$nå_bpf_·r£_ÿp_func
(
nå_­p_bpf
 *
bpf
, 
__iomem
 *
v®ue
, 
u32
 
Ëngth
)

255 
nå_bpf_ÿp_Žv_func
 
__iomem
 *
ÿp
 = 
v®ue
;

257 ià(
Ëngth
 < (*
ÿp
)) {

258 
	`nå_”r
(
bpf
->
­p
->
ýp
, "Œunÿ‹d funùiÚ TLV: %d\n", 
Ëngth
);

259  -
EINVAL
;

262 
	`»adl
(&
ÿp
->
func_id
)) {

263 
BPF_FUNC_m­_lookup_–em
:

264 
bpf
->
h–³rs
.
m­_lookup
 = 
	`»adl
(&
ÿp
->
func_addr
);

266 
BPF_FUNC_m­_upd©e_–em
:

267 
bpf
->
h–³rs
.
m­_upd©e
 = 
	`»adl
(&
ÿp
->
func_addr
);

269 
BPF_FUNC_m­_d–‘e_–em
:

270 
bpf
->
h–³rs
.
m­_d–‘e
 = 
	`»adl
(&
ÿp
->
func_addr
);

272 
BPF_FUNC_³rf_ev’t_ouut
:

273 
bpf
->
h–³rs
.
³rf_ev’t_ouut
 = 
	`»adl
(&
ÿp
->
func_addr
);

278 
	}
}

281 
	$nå_bpf_·r£_ÿp_m­s
(
nå_­p_bpf
 *
bpf
, 
__iomem
 *
v®ue
, 
u32
 
Ëngth
)

283 
nå_bpf_ÿp_Žv_m­s
 
__iomem
 *
ÿp
 = 
v®ue
;

285 ià(
Ëngth
 < (*
ÿp
)) {

286 
	`nå_”r
(
bpf
->
­p
->
ýp
, "Œunÿ‹d m­ TLV: %d\n", 
Ëngth
);

287  -
EINVAL
;

290 
bpf
->
m­s
.
ty³s
 = 
	`»adl
(&
ÿp
->types);

291 
bpf
->
m­s
.
max_m­s
 = 
	`»adl
(&
ÿp
->max_maps);

292 
bpf
->
m­s
.
max_–ems
 = 
	`»adl
(&
ÿp
->max_elems);

293 
bpf
->
m­s
.
max_key_sz
 = 
	`»adl
(&
ÿp
->max_key_sz);

294 
bpf
->
m­s
.
max_v®_sz
 = 
	`»adl
(&
ÿp
->max_val_sz);

295 
bpf
->
m­s
.
max_–em_sz
 = 
	`»adl
(&
ÿp
->max_elem_sz);

298 
	}
}

301 
	$nå_bpf_·r£_ÿp_¿ndom
(
nå_­p_bpf
 *
bpf
, 
__iomem
 *
v®ue
,

302 
u32
 
Ëngth
)

304 
bpf
->
p£udo_¿ndom
 = 
Œue
;

306 
	}
}

309 
	$nå_bpf_·r£_ÿp_q£l
(
nå_­p_bpf
 *
bpf
, 
__iomem
 *
v®ue
, 
u32
 
Ëngth
)

311 
bpf
->
queue_£Ëù
 = 
Œue
;

313 
	}
}

316 
	$nå_bpf_·r£_ÿp_adju¡_ž
(
nå_­p_bpf
 *
bpf
, 
__iomem
 *
v®ue
,

317 
u32
 
Ëngth
)

319 
bpf
->
adju¡_ž
 = 
Œue
;

321 
	}
}

324 
	$nå_bpf_·r£_ÿp_abi_v”siÚ
(
nå_­p_bpf
 *
bpf
, 
__iomem
 *
v®ue
,

325 
u32
 
Ëngth
)

327 ià(
Ëngth
 < 4) {

328 
	`nå_”r
(
bpf
->
­p
->
ýp
, "truncated ABI version TLV: %d\n",

329 
Ëngth
);

330  -
EINVAL
;

333 
bpf
->
abi_v”siÚ
 = 
	`»adl
(
v®ue
);

334 ià(
bpf
->
abi_v”siÚ
 < 2 || bpf->abi_version > 3) {

335 
	`nå_w¬n
(
bpf
->
­p
->
ýp
, "unsupported BPF ABI version: %d\n",

336 
bpf
->
abi_v”siÚ
);

337 
bpf
->
abi_v”siÚ
 = 0;

341 
	}
}

343 
	$nå_bpf_·r£_ÿ·bž™›s
(
nå_­p
 *
­p
)

345 
nå_ýp
 *
ýp
 = 
­p
->
pf
->cpp;

346 
nå_ýp_¬—
 *
¬—
;

347 
u8
 
__iomem
 *
mem
, *
¡¬t
;

349 
mem
 = 
	`nå_¹sym_m­
(
­p
->
pf
->
¹bl
, "_abi_bpf_capabilities", "bpf.cap",

350 8, &
¬—
);

351 ià(
	`IS_ERR
(
mem
))

352  
	`PTR_ERR
(
mem
è=ð-
ENOENT
 ? 0 : PTR_ERR(mem);

354 
¡¬t
 = 
mem
;

355 
mem
 - 
¡¬t
 + 8 <ð
	`nå_ýp_¬—_size
(
¬—
)) {

356 
u8
 
__iomem
 *
v®ue
;

357 
u32
 
ty³
, 
Ëngth
;

359 
ty³
 = 
	`»adl
(
mem
);

360 
Ëngth
 = 
	`»adl
(
mem
 + 4);

361 
v®ue
 = 
mem
 + 8;

363 
mem
 +ð8 + 
Ëngth
;

364 ià(
mem
 - 
¡¬t
 > 
	`nå_ýp_¬—_size
(
¬—
))

365 
”r_»Ëa£_ä“
;

367 
ty³
) {

368 
NFP_BPF_CAP_TYPE_FUNC
:

369 ià(
	`nå_bpf_·r£_ÿp_func
(
­p
->
´iv
, 
v®ue
, 
Ëngth
))

370 
”r_»Ëa£_ä“
;

372 
NFP_BPF_CAP_TYPE_ADJUST_HEAD
:

373 ià(
	`nå_bpf_·r£_ÿp_adju¡_h—d
(
­p
->
´iv
, 
v®ue
,

374 
Ëngth
))

375 
”r_»Ëa£_ä“
;

377 
NFP_BPF_CAP_TYPE_MAPS
:

378 ià(
	`nå_bpf_·r£_ÿp_m­s
(
­p
->
´iv
, 
v®ue
, 
Ëngth
))

379 
”r_»Ëa£_ä“
;

381 
NFP_BPF_CAP_TYPE_RANDOM
:

382 ià(
	`nå_bpf_·r£_ÿp_¿ndom
(
­p
->
´iv
, 
v®ue
, 
Ëngth
))

383 
”r_»Ëa£_ä“
;

385 
NFP_BPF_CAP_TYPE_QUEUE_SELECT
:

386 ià(
	`nå_bpf_·r£_ÿp_q£l
(
­p
->
´iv
, 
v®ue
, 
Ëngth
))

387 
”r_»Ëa£_ä“
;

389 
NFP_BPF_CAP_TYPE_ADJUST_TAIL
:

390 ià(
	`nå_bpf_·r£_ÿp_adju¡_ž
(
­p
->
´iv
, 
v®ue
,

391 
Ëngth
))

392 
”r_»Ëa£_ä“
;

394 
NFP_BPF_CAP_TYPE_ABI_VERSION
:

395 ià(
	`nå_bpf_·r£_ÿp_abi_v”siÚ
(
­p
->
´iv
, 
v®ue
,

396 
Ëngth
))

397 
”r_»Ëa£_ä“
;

400 
	`nå_dbg
(
ýp
, "unknowÀBPF c­abž™y: %d\n", 
ty³
);

404 ià(
mem
 - 
¡¬t
 !ð
	`nå_ýp_¬—_size
(
¬—
)) {

405 
	`nå_”r
(
ýp
, "BPF capabilities†eft‡fter…arsing,…arsed:%zdotal†ength:%zu\n",

406 
mem
 - 
¡¬t
, 
	`nå_ýp_¬—_size
(
¬—
));

407 
”r_»Ëa£_ä“
;

410 
	`nå_ýp_¬—_»Ëa£_ä“
(
¬—
);

414 
”r_»Ëa£_ä“
:

415 
	`nå_”r
(
ýp
, "šv®id BPF c­abž™› © off£t:%zd\n", 
mem
 - 
¡¬t
);

416 
	`nå_ýp_¬—_»Ëa£_ä“
(
¬—
);

417  -
EINVAL
;

418 
	}
}

420 
	$nå_bpf_š™_ÿ·bž™›s
(
nå_­p_bpf
 *
bpf
)

422 
bpf
->
abi_v”siÚ
 = 2;

423 
	}
}

425 
	$nå_bpf_ndo_š™
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

427 
nå_­p_bpf
 *
bpf
 = 
­p
->
´iv
;

429  
	`bpf_ofæßd_dev_Ãtdev_»gi¡”
(
bpf
->
bpf_dev
, 
Ãtdev
);

430 
	}
}

432 
	$nå_bpf_ndo_unš™
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

434 
nå_­p_bpf
 *
bpf
 = 
­p
->
´iv
;

436 
	`bpf_ofæßd_dev_Ãtdev_uÄegi¡”
(
bpf
->
bpf_dev
, 
Ãtdev
);

437 
	}
}

439 
	$nå_bpf_š™
(
nå_­p
 *
­p
)

441 
nå_­p_bpf
 *
bpf
;

442 
”r
;

444 
bpf
 = 
	`kz®loc
((*bpf), 
GFP_KERNEL
);

445 ià(!
bpf
)

446  -
ENOMEM
;

447 
bpf
->
­p
 =‡pp;

448 
­p
->
´iv
 = 
bpf
;

450 
	`skb_queue_h—d_š™
(&
bpf
->
cmsg_»¶›s
);

451 
	`š™_wa™queue_h—d
(&
bpf
->
cmsg_wq
);

452 
	`INIT_LIST_HEAD
(&
bpf
->
m­_li¡
);

454 
”r
 = 
	`rhashbË_š™
(&
bpf
->
m­s_ÃuŒ®
, &
nå_bpf_m­s_ÃuŒ®_·¿ms
);

455 ià(
”r
)

456 
”r_ä“_bpf
;

458 
	`nå_bpf_š™_ÿ·bž™›s
(
bpf
);

460 
”r
 = 
	`nå_bpf_·r£_ÿ·bž™›s
(
­p
);

461 ià(
”r
)

462 
”r_ä“_ÃuŒ®_m­s
;

464 ià(
bpf
->
abi_v”siÚ
 < 3) {

465 
bpf
->
cmsg_key_sz
 = 
CMSG_MAP_KEY_LW
 * 4;

466 
bpf
->
cmsg_v®_sz
 = 
CMSG_MAP_VALUE_LW
 * 4;

468 
bpf
->
cmsg_key_sz
 = bpf->
m­s
.
max_key_sz
;

469 
bpf
->
cmsg_v®_sz
 = bpf->
m­s
.
max_v®_sz
;

470 
­p
->
ù¾_mtu
 = 
	`nå_bpf_ù¾_cmsg_mtu
(
bpf
);

473 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

474 
bpf
->
bpf_dev
 = 
	`bpf_ofæßd_dev_ü—‹
();

475 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

476 
bpf
->
bpf_dev
 = 
	`bpf_ofæßd_dev_ü—‹
(&
nå_bpf_dev_Ýs
);

478 
bpf
->
bpf_dev
 = 
	`bpf_ofæßd_dev_ü—‹
(&
nå_bpf_dev_Ýs
, bpf);

480 
”r
 = 
	`PTR_ERR_OR_ZERO
(
bpf
->
bpf_dev
);

481 ià(
”r
)

482 
”r_ä“_ÃuŒ®_m­s
;

486 
”r_ä“_ÃuŒ®_m­s
:

487 
	`rhashbË_de¡roy
(&
bpf
->
m­s_ÃuŒ®
);

488 
”r_ä“_bpf
:

489 
	`kä“
(
bpf
);

490  
”r
;

491 
	}
}

493 
	$nå_bpf_þ—n
(
nå_­p
 *
­p
)

495 
nå_­p_bpf
 *
bpf
 = 
­p
->
´iv
;

497 
	`bpf_ofæßd_dev_de¡roy
(
bpf
->
bpf_dev
);

498 
	`WARN_ON
(!
	`skb_queue_em±y
(&
bpf
->
cmsg_»¶›s
));

499 
	`WARN_ON
(!
	`li¡_em±y
(&
bpf
->
m­_li¡
));

500 
	`WARN_ON
(
bpf
->
m­s_š_u£
 || bpf->
m­_–ems_š_u£
);

501 
	`rhashbË_ä“_ªd_de¡roy
(&
bpf
->
m­s_ÃuŒ®
,

502 
nå_check_rhashbË_em±y
, 
NULL
);

503 
	`kä“
(
bpf
);

504 
	}
}

506 cÚ¡ 
nå_­p_ty³
 
	g­p_bpf
 = {

507 .
id
 = 
NFP_APP_BPF_NIC
,

508 .
	gÇme
 = "ebpf",

510 .
	gù¾_ÿp_mask
 = 0,

512 .
	gš™
 = 
nå_bpf_š™
,

513 .
	gþ—n
 = 
nå_bpf_þ—n
,

515 .
	gcheck_mtu
 = 
nå_bpf_check_mtu
,

517 .
	gexŒa_ÿp
 = 
nå_bpf_exŒa_ÿp
,

519 .
	gndo_š™
 = 
nå_bpf_ndo_š™
,

520 .
	gndo_unš™
 = 
nå_bpf_ndo_unš™
,

522 .
	gvnic_®loc
 = 
nå_bpf_vnic_®loc
,

523 .
	gvnic_ä“
 = 
nå_bpf_vnic_ä“
,

525 .
	gù¾_msg_rx
 = 
nå_bpf_ù¾_msg_rx
,

526 .
	gù¾_msg_rx_¿w
 = 
nå_bpf_ù¾_msg_rx_¿w
,

528 .
	g£tup_tc
 = 
nå_bpf_£tup_tc
,

529 .
	gbpf
 = 
nå_ndo_bpf
,

530 .
	gxdp_ofæßd
 = 
nå_bpf_xdp_ofæßd
,

	@src/bpf/main.h

4 #iâdeà
__NFP_BPF_H__


5 
	#__NFP_BPF_H__
 1

	)

7 
	~"../nå_Ãt_com·t.h
"

9 
	~<lšux/b™f›ld.h
>

10 
	~<lšux/bpf.h
>

11 
	~<lšux/bpf_v”if›r.h
>

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/li¡.h
>

14 
	~<lšux/rhashbË.h
>

15 
	~<lšux/skbuff.h
>

16 
	~<lšux/ty³s.h
>

17 
	~<lšux/wa™.h
>

19 
	~"../nå_asm.h
"

20 
	~"fw.h
"

22 
	#cmsg_w¬n
(
bpf
, 
msg
...è
	`Â_dp_w¬n
(&(bpf)->
­p
->
ù¾
->
dp
, msg)

	)

27 
	#OP_RELO_TYPE
 0xff00000000000000ULL

	)

29 
	enå_»lo_ty³
 {

30 
	mRELO_NONE
 = 0,

32 
	mRELO_BR_REL
,

34 
	mRELO_BR_GO_OUT
,

35 
	mRELO_BR_GO_ABORT
,

36 
	mRELO_BR_GO_CALL_PUSH_REGS
,

37 
	mRELO_BR_GO_CALL_POP_REGS
,

39 
	mRELO_BR_NEXT_PKT
,

40 
	mRELO_BR_HELPER
,

42 
	mRELO_IMMED_REL
,

49 
	#BR_OFF_RELO
 15000

	)

51 
	e¡©ic_»gs
 {

52 
	mSTATIC_REG_IMMA
 = 20,

53 
	mSTATIC_REG_IMM
 = 21,

54 
	mSTATIC_REG_STACK
 = 22,

55 
	mSTATIC_REG_PKT_LEN
 = 22,

58 
	epkt_vec
 {

59 
	mPKT_VEC_PKT_LEN
 = 0,

60 
	mPKT_VEC_PKT_PTR
 = 2,

61 
	mPKT_VEC_QSEL_SET
 = 4,

62 
	mPKT_VEC_QSEL_VAL
 = 6,

65 
	#PKT_VEL_QSEL_SET_BIT
 4

	)

67 
	#pv_Ën
(
Å
è
	`»g_lm
(1, 
PKT_VEC_PKT_LEN
)

	)

68 
	#pv_ùm_±r
(
Å
è
	`»g_lm
(1, 
PKT_VEC_PKT_PTR
)

	)

69 
	#pv_q£l_£t
(
Å
è
	`»g_lm
(1, 
PKT_VEC_QSEL_SET
)

	)

70 
	#pv_q£l_v®
(
Å
è
	`»g_lm
(1, 
PKT_VEC_QSEL_VAL
)

	)

72 
	#¡ack_»g
(
Å
è
	`»g_a
(
STATIC_REG_STACK
)

	)

73 
	#¡ack_imm
(
Å
è
	`imm_b
Òp)

	)

74 
	#¶’_»g
(
Å
è
	`»g_b
(
STATIC_REG_PKT_LEN
)

	)

75 
	#µŒ_»g
(
Å
è
	`pv_ùm_±r
Òp)

	)

76 
	#imm_a
(
Å
è
	`»g_a
(
STATIC_REG_IMM
)

	)

77 
	#imm_b
(
Å
è
	`»g_b
(
STATIC_REG_IMM
)

	)

78 
	#imma_a
(
Å
è
	`»g_a
(
STATIC_REG_IMMA
)

	)

79 
	#imma_b
(
Å
è
	`»g_b
(
STATIC_REG_IMMA
)

	)

80 
	#imm_bÙh
(
Å
è
	`»g_bÙh
(
STATIC_REG_IMM
)

	)

81 
	#»t_»g
(
Å
è
	`imm_a
Òp)

	)

83 
	#NFP_BPF_ABI_FLAGS
 
	`»g_imm
(0)

	)

84 
	#NFP_BPF_ABI_FLAG_MARK
 1

	)

135 
	snå_­p_bpf
 {

136 
nå_­p
 *
	m­p
;

138 
bpf_ofæßd_dev
 *
	mbpf_dev
;

140 
DECLARE_BITMAP
(
g_®loÿtÜ
, 
U16_MAX
 + 1);

141 
u16
 
	mg_®loc_Ãxt
;

142 
u16
 
	mg_®loc_Ï¡
;

144 
sk_buff_h—d
 
	mcmsg_»¶›s
;

145 
wa™_queue_h—d
 
	mcmsg_wq
;

147 
	mcmsg_key_sz
;

148 
	mcmsg_v®_sz
;

150 
li¡_h—d
 
	mm­_li¡
;

151 
	mm­s_š_u£
;

152 
	mm­_–ems_š_u£
;

154 
rhashbË
 
	mm­s_ÃuŒ®
;

156 
u32
 
	mabi_v”siÚ
;

158 
	snå_bpf_ÿp_adju¡_h—d
 {

159 
u32
 
	mæags
;

160 
	moff_mš
;

161 
	moff_max
;

162 
	mgu¬ª‹ed_sub
;

163 
	mgu¬ª‹ed_add
;

164 } 
	madju¡_h—d
;

167 
u32
 
	mty³s
;

168 
u32
 
	mmax_m­s
;

169 
u32
 
	mmax_–ems
;

170 
u32
 
	mmax_key_sz
;

171 
u32
 
	mmax_v®_sz
;

172 
u32
 
	mmax_–em_sz
;

173 } 
	mm­s
;

176 
u32
 
	mm­_lookup
;

177 
u32
 
	mm­_upd©e
;

178 
u32
 
	mm­_d–‘e
;

179 
u32
 
	m³rf_ev’t_ouut
;

180 } 
	mh–³rs
;

182 
boÞ
 
	mp£udo_¿ndom
;

183 
boÞ
 
	mqueue_£Ëù
;

184 
boÞ
 
	madju¡_ž
;

187 
	enå_bpf_m­_u£
 {

188 
	mNFP_MAP_UNUSED
 = 0,

189 
	mNFP_MAP_USE_READ
,

190 
	mNFP_MAP_USE_WRITE
,

191 
	mNFP_MAP_USE_ATOMIC_CNT
,

194 
	snå_bpf_m­_wÜd
 {

195 
	mty³
 :4;

196 
	mnÚ_z”o_upd©e
 :1;

207 
	snå_bpf_m­
 {

208 
bpf_ofæßded_m­
 *
	moffm­
;

209 
nå_­p_bpf
 *
	mbpf
;

210 
u32
 
	mtid
;

211 
li¡_h—d
 
	ml
;

212 
nå_bpf_m­_wÜd
 
	mu£_m­
[];

215 
	snå_bpf_ÃuŒ®_m­
 {

216 
rhash_h—d
 
	ml
;

217 
bpf_m­
 *
	m±r
;

218 
u32
 
	mm­_id
;

219 
u32
 
	mcouÁ
;

222 cÚ¡ 
rhashbË_·¿ms
 
nå_bpf_m­s_ÃuŒ®_·¿ms
;

224 
	gnå_´og
;

225 
	gnå_š¢_m‘a
;

226 (*
	tš¡r_cb_t
)(
	tnå_´og
 *, 
	tnå_š¢_m‘a
 *);

228 
	#nå_´og_fœ¡_m‘a
(
nå_´og
) \

229 
	`li¡_fœ¡_’Œy
(&(
nå_´og
)->
š¢s
, 
nå_š¢_m‘a
, 
l
)

	)

230 
	#nå_´og_Ï¡_m‘a
(
nå_´og
) \

231 
	`li¡_Ï¡_’Œy
(&(
nå_´og
)->
š¢s
, 
nå_š¢_m‘a
, 
l
)

	)

232 
	#nå_m‘a_Ãxt
(
m‘a
è
	`li¡_Ãxt_’Œy
(m‘a, 
l
)

	)

233 
	#nå_m‘a_´ev
(
m‘a
è
	`li¡_´ev_’Œy
(m‘a, 
l
)

	)

240 
	snå_bpf_»g_¡©e
 {

241 
bpf_»g_¡©e
 
»g
;

242 
boÞ
 
v¬_off
;

245 
	#FLAG_INSN_IS_JUMP_DST
 
	`BIT
(0)

	)

246 
	#FLAG_INSN_IS_SUBPROG_START
 
	`BIT
(1)

	)

247 
	#FLAG_INSN_PTR_CALLER_STACK_FRAME
 
	`BIT
(2)

	)

249 
	#FLAG_INSN_SKIP_NOOP
 
	`BIT
(3)

	)

251 
	#FLAG_INSN_SKIP_PREC_DEPENDENT
 
	`BIT
(4)

	)

253 
	#FLAG_INSN_SKIP_VERIFIER_OPT
 
	`BIT
(5)

	)

255 
	#FLAG_INSN_SKIP_MASK
 (
FLAG_INSN_SKIP_NOOP
 | \

256 
FLAG_INSN_SKIP_PREC_DEPENDENT
 | \

257 
FLAG_INSN_SKIP_VERIFIER_OPT
)

	)

289 
	snå_š¢_m‘a
 {

290 
bpf_š¢
 
š¢
;

294 
bpf_»g_¡©e
 
±r
;

295 
bpf_š¢
 *
·œed_¡
;

296 
s16
 
ld¡_g©h”_Ën
;

297 
boÞ
 
±r_nÙ_cÚ¡
;

299 
s16
 
¿nge_¡¬t
;

300 
s16
 
¿nge_’d
;

301 
boÞ
 
do_š™
;

302 } 
pkt_ÿche
;

303 
boÞ
 
xadd_ov”_16b™
;

304 
boÞ
 
xadd_maybe_16b™
;

308 
nå_š¢_m‘a
 *
jmp_d¡
;

309 
boÞ
 
jump_Ãg_Ý
;

310 
u32
 
num_š¢s_aá”_br
;

314 
u32
 
func_id
;

315 
bpf_»g_¡©e
 
¬g1
;

316 
nå_bpf_»g_¡©e
 
¬g2
;

323 
u64
 
umš_¤c
;

324 
u64
 
umax_¤c
;

325 
u64
 
umš_d¡
;

326 
u64
 
umax_d¡
;

329 
off
;

330 
n
;

331 
æags
;

332 
sub´og_idx
;

333 
š¡r_cb_t
 
doubË_cb
;

335 
li¡_h—d
 
l
;

338 
	#BPF_SIZE_MASK
 0x18

	)

340 
šlše
 
u8
 
	$mbpf_þass
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

342  
	`BPF_CLASS
(
m‘a
->
š¢
.
code
);

343 
	}
}

345 
šlše
 
u8
 
	$mbpf_¤c
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

347  
	`BPF_SRC
(
m‘a
->
š¢
.
code
);

348 
	}
}

350 
šlše
 
u8
 
	$mbpf_Ý
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

352  
	`BPF_OP
(
m‘a
->
š¢
.
code
);

353 
	}
}

355 
šlše
 
u8
 
	$mbpf_mode
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

357  
	`BPF_MODE
(
m‘a
->
š¢
.
code
);

358 
	}
}

360 
šlše
 
boÞ
 
	$is_mbpf_®u
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

362  
	`mbpf_þass
(
m‘a
è=ð
BPF_ALU64
 || mbpf_þass(m‘aè=ð
BPF_ALU
;

363 
	}
}

365 
šlše
 
boÞ
 
	$is_mbpf_lßd
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

367  (
m‘a
->
š¢
.
code
 & ~
BPF_SIZE_MASK
è=ð(
BPF_LDX
 | 
BPF_MEM
);

368 
	}
}

370 
šlše
 
boÞ
 
	$is_mbpf_jmp32
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

372  
	`mbpf_þass
(
m‘a
è=ð
BPF_JMP32
;

373 
	}
}

375 
šlše
 
boÞ
 
	$is_mbpf_jmp64
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

377  
	`mbpf_þass
(
m‘a
è=ð
BPF_JMP
;

378 
	}
}

380 
šlše
 
boÞ
 
	$is_mbpf_jmp
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

382  
	`is_mbpf_jmp32
(
m‘a
è|| 
	`is_mbpf_jmp64
(meta);

383 
	}
}

385 
šlše
 
boÞ
 
	$is_mbpf_¡Üe
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

387  (
m‘a
->
š¢
.
code
 & ~
BPF_SIZE_MASK
è=ð(
BPF_STX
 | 
BPF_MEM
);

388 
	}
}

390 
šlše
 
boÞ
 
	$is_mbpf_lßd_pkt
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

392  
	`is_mbpf_lßd
(
m‘a
è&& m‘a->
±r
.
ty³
 =ð
PTR_TO_PACKET
;

393 
	}
}

395 
šlše
 
boÞ
 
	$is_mbpf_¡Üe_pkt
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

397  
	`is_mbpf_¡Üe
(
m‘a
è&& m‘a->
±r
.
ty³
 =ð
PTR_TO_PACKET
;

398 
	}
}

400 
šlše
 
boÞ
 
	$is_mbpf_þassic_lßd
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

402 
u8
 
code
 = 
m‘a
->
š¢
.code;

404  
	`BPF_CLASS
(
code
è=ð
BPF_LD
 &&

405 (
	`BPF_MODE
(
code
è=ð
BPF_ABS
 || BPF_MODE(codeè=ð
BPF_IND
);

406 
	}
}

408 
šlše
 
boÞ
 
	$is_mbpf_þassic_¡Üe
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

410 
u8
 
code
 = 
m‘a
->
š¢
.code;

412  
	`BPF_CLASS
(
code
è=ð
BPF_ST
 && 
	`BPF_MODE
(codeè=ð
BPF_MEM
;

413 
	}
}

415 
šlše
 
boÞ
 
	$is_mbpf_þassic_¡Üe_pkt
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

417  
	`is_mbpf_þassic_¡Üe
(
m‘a
è&& m‘a->
±r
.
ty³
 =ð
PTR_TO_PACKET
;

418 
	}
}

420 
šlše
 
boÞ
 
	$is_mbpf_xadd
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

422  (
m‘a
->
š¢
.
code
 & ~
BPF_SIZE_MASK
è=ð(
BPF_STX
 | 
BPF_XADD
);

423 
	}
}

425 
šlše
 
boÞ
 
	$is_mbpf_mul
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

427  
	`is_mbpf_®u
(
m‘a
è&& 
	`mbpf_Ý
(m‘aè=ð
BPF_MUL
;

428 
	}
}

430 
šlše
 
boÞ
 
	$is_mbpf_div
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

432  
	`is_mbpf_®u
(
m‘a
è&& 
	`mbpf_Ý
(m‘aè=ð
BPF_DIV
;

433 
	}
}

435 
šlše
 
boÞ
 
	$is_mbpf_cÚd_jump
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

437 
u8
 
Ý
;

439 ià(
	`is_mbpf_jmp32
(
m‘a
))

440  
Œue
;

442 ià(!
	`is_mbpf_jmp64
(
m‘a
))

443  
çl£
;

445 
Ý
 = 
	`mbpf_Ý
(
m‘a
);

446  
Ý
 !ð
BPF_JA
 && o°!ð
BPF_EXIT
 && o°!ð
BPF_CALL
;

447 
	}
}

449 
šlše
 
boÞ
 
	$is_mbpf_h–³r_ÿÎ
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

451 
bpf_š¢
 
š¢
 = 
m‘a
->insn;

453  
š¢
.
code
 =ð(
BPF_JMP
 | 
BPF_CALL
) &&

454 
š¢
.
¤c_»g
 !ð
BPF_PSEUDO_CALL
;

455 
	}
}

457 
šlše
 
boÞ
 
	$is_mbpf_p£udo_ÿÎ
(cÚ¡ 
nå_š¢_m‘a
 *
m‘a
)

459 
bpf_š¢
 
š¢
 = 
m‘a
->insn;

461  
š¢
.
code
 =ð(
BPF_JMP
 | 
BPF_CALL
) &&

462 
š¢
.
¤c_»g
 =ð
BPF_PSEUDO_CALL
;

463 
	}
}

465 
	#STACK_FRAME_ALIGN
 64

	)

472 
	snå_bpf_sub´og_šfo
 {

473 
u16
 
	m¡ack_d•th
;

474 
u8
 
	mÃeds_»g_push
 : 1;

502 
	snå_´og
 {

503 
nå_­p_bpf
 *
	mbpf
;

505 
u64
 *
	m´og
;

506 
	m´og_Ën
;

507 
	m__´og_®loc_Ën
;

509 
	m¡ack_size
;

511 
nå_š¢_m‘a
 *
	mv”if›r_m‘a
;

513 
bpf_´og_ty³
 
	mty³
;

515 
	mÏ¡_bpf_off
;

516 
	mtgt_out
;

517 
	mtgt_abÜt
;

518 
	mtgt_ÿÎ_push_»gs
;

519 
	mtgt_ÿÎ_pÝ_»gs
;

521 
	mn_Œª¦©ed
;

522 
	m”rÜ
;

524 
	m¡ack_äame_d•th
;

525 
	madju¡_h—d_loÿtiÚ
;

527 
	mm­_»cÜds_út
;

528 
	msub´og_út
;

529 
nå_bpf_ÃuŒ®_m­
 **
	mm­_»cÜds
;

530 
nå_bpf_sub´og_šfo
 *
	msub´og
;

532 
	mn_š¢s
;

533 
li¡_h—d
 
	mš¢s
;

542 
	snå_bpf_vnic
 {

543 
bpf_´og
 *
	mtc_´og
;

544 
	m¡¬t_off
;

545 
	mtgt_dÚe
;

548 
boÞ
 
nå_is_sub´og_¡¬t
(
nå_š¢_m‘a
 *
m‘a
);

549 
nå_bpf_j™_´•¬e
(
nå_´og
 *nfp_prog);

550 
nå_bpf_j™
(
nå_´og
 *
´og
);

551 
boÞ
 
nå_bpf_suµÜ‹d_Ýcode
(
u8
 
code
);

553 
nå_v”ify_š¢
(
bpf_v”if›r_’v
 *
’v
, 
š¢_idx
,

554 
´ev_š¢_idx
);

555 
nå_bpf_fš®ize
(
bpf_v”if›r_’v
 *
’v
);

557 
nå_bpf_Ýt_»¶aû_š¢
(
bpf_v”if›r_’v
 *
’v
, 
u32
 
off
,

558 
bpf_š¢
 *
š¢
);

559 
nå_bpf_Ýt_»move_š¢s
(
bpf_v”if›r_’v
 *
’v
, 
u32
 
off
, u32 
út
);

561 cÚ¡ 
bpf_´og_ofæßd_Ýs
 
nå_bpf_dev_Ýs
;

563 
	gÃtdev_bpf
;

564 
	gnå_­p
;

565 
	gnå_Ãt
;

567 
nå_ndo_bpf
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

568 
Ãtdev_bpf
 *
bpf
);

569 
nå_Ãt_bpf_ofæßd
(
nå_Ãt
 *
Â
, 
bpf_´og
 *
´og
,

570 
boÞ
 
Þd_´og
, 
ÃŽšk_ext_ack
 *
exck
);

572 
nå_š¢_m‘a
 *

573 
nå_bpf_gÙo_m‘a
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

574 
š¢_idx
);

576 *
nå_bpf_»lo_fÜ_vnic
(
nå_´og
 *nå_´og, 
nå_bpf_vnic
 *
bv
);

578 
nå_bpf_ù¾_cmsg_mtu
(
nå_­p_bpf
 *
bpf
);

580 
nå_bpf_ù¾_®loc_m­
(
nå_­p_bpf
 *
bpf
, 
bpf_m­
 *
m­
);

582 
nå_bpf_ù¾_ä“_m­
(
nå_­p_bpf
 *
bpf
, 
nå_bpf_m­
 *
nå_m­
);

583 
nå_bpf_ù¾_g‘fœ¡_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

584 *
Ãxt_key
);

585 
nå_bpf_ù¾_upd©e_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

586 *
key
, *
v®ue
, 
u64
 
æags
);

587 
nå_bpf_ù¾_d–_’Œy
(
bpf_ofæßded_m­
 *
offm­
, *
key
);

588 
nå_bpf_ù¾_lookup_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

589 *
key
, *
v®ue
);

590 
nå_bpf_ù¾_g‘Ãxt_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

591 *
key
, *
Ãxt_key
);

593 
nå_bpf_ev’t_ouut
(
nå_­p_bpf
 *
bpf
, cÚ¡ *
d©a
,

594 
Ën
);

596 
nå_bpf_ù¾_msg_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
);

598 
nå_bpf_ù¾_msg_rx_¿w
(
nå_­p
 *
­p
, cÚ¡ *
d©a
,

599 
Ën
);

	@src/bpf/offload.c

9 
	#´_fmt
(
fmt
è"NFP‚‘ bpf: " 
	)
fmt

11 
	~"../nå_Ãt_com·t.h
"

13 
	~<lšux/bpf.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/Ãtdeviû.h
>

16 
	~<lšux/pci.h
>

17 
	~<lšux/jiff›s.h
>

18 
	~<lšux/tim”.h
>

19 
	~<lšux/li¡.h
>

20 
	~<lšux/mm.h
>

22 
	~<Ãt/pkt_þs.h
>

23 
	~<Ãt/tc_aù/tc_gaù.h
>

24 
	~<Ãt/tc_aù/tc_mœ»d.h
>

26 
	~"maš.h
"

27 
	~"../nå_­p.h
"

28 
	~"../nå_Ãt_ù¾.h
"

29 
	~"../nå_Ãt.h
"

32 
	$nå_m­_±r_»cÜd
(
nå_­p_bpf
 *
bpf
, 
nå_´og
 *nfp_prog,

33 
bpf_m­
 *
m­
)

35 
nå_bpf_ÃuŒ®_m­
 *
»cÜd
;

36 
”r
;

39 
»cÜd
 = 
	`rhashbË_lookup_ç¡
(&
bpf
->
m­s_ÃuŒ®
, &
m­
->
id
,

40 
nå_bpf_m­s_ÃuŒ®_·¿ms
);

41 ià(
»cÜd
) {

42 
nå_´og
->
m­_»cÜds
[nå_´og->
m­_»cÜds_út
++] = 
»cÜd
;

43 
»cÜd
->
couÁ
++;

50 
m­
 = 
	`bpf_m­_šc
(m­, 
çl£
);

51 ià(
	`IS_ERR
(
m­
))

52  
	`PTR_ERR
(
m­
);

54 
»cÜd
 = 
	`km®loc
((*»cÜd), 
GFP_KERNEL
);

55 ià(!
»cÜd
) {

56 
”r
 = -
ENOMEM
;

57 
”r_m­_put
;

60 
»cÜd
->
±r
 = 
m­
;

61 
»cÜd
->
m­_id
 = 
m­
->
id
;

62 
»cÜd
->
couÁ
 = 1;

64 
”r
 = 
	`rhashbË_š£¹_ç¡
(&
bpf
->
m­s_ÃuŒ®
, &
»cÜd
->
l
,

65 
nå_bpf_m­s_ÃuŒ®_·¿ms
);

66 ià(
”r
)

67 
”r_ä“_»c
;

69 
nå_´og
->
m­_»cÜds
[nå_´og->
m­_»cÜds_út
++] = 
»cÜd
;

73 
”r_ä“_»c
:

74 
	`kä“
(
»cÜd
);

75 
”r_m­_put
:

76 
	`bpf_m­_put
(
m­
);

77  
”r
;

78 
	}
}

81 
	$nå_m­_±rs_fÜg‘
(
nå_­p_bpf
 *
bpf
, 
nå_´og
 *nfp_prog)

83 
boÞ
 
ä“d
 = 
çl£
;

84 
i
;

86 
i
 = 0; i < 
nå_´og
->
m­_»cÜds_út
; i++) {

87 ià(--
nå_´og
->
m­_»cÜds
[
i
]->
couÁ
) {

88 
nå_´og
->
m­_»cÜds
[
i
] = 
NULL
;

92 
	`WARN_ON
(
	`rhashbË_»move_ç¡
(&
bpf
->
m­s_ÃuŒ®
,

93 &
nå_´og
->
m­_»cÜds
[
i
]->
l
,

94 
nå_bpf_m­s_ÃuŒ®_·¿ms
));

95 
ä“d
 = 
Œue
;

98 ià(
ä“d
) {

99 
	`synchrÚize_rcu
();

101 
i
 = 0; i < 
nå_´og
->
m­_»cÜds_út
; i++)

102 ià(
nå_´og
->
m­_»cÜds
[
i
]) {

103 
	`bpf_m­_put
(
nå_´og
->
m­_»cÜds
[
i
]->
±r
);

104 
	`kä“
(
nå_´og
->
m­_»cÜds
[
i
]);

108 
	`kä“
(
nå_´og
->
m­_»cÜds
);

109 
nå_´og
->
m­_»cÜds
 = 
NULL
;

110 
nå_´og
->
m­_»cÜds_út
 = 0;

111 
	}
}

114 
	$nå_m­_±rs_»cÜd
(
nå_­p_bpf
 *
bpf
, 
nå_´og
 *nfp_prog,

115 
bpf_´og
 *
´og
)

117 
i
, 
út
, 
”r
;

120 
út
 = 0;

121 
i
 = 0; i < 
´og
->
aux
->
u£d_m­_út
; i++)

122 ià(
	`bpf_m­_ofæßd_ÃuŒ®
(
´og
->
aux
->
u£d_m­s
[
i
]))

123 
út
++;

124 ià(!
út
)

127 
nå_´og
->
m­_»cÜds
 = 
	`km®loc_¬¿y
(
út
,

128 (
nå_´og
->
m­_»cÜds
[0]),

129 
GFP_KERNEL
);

130 ià(!
nå_´og
->
m­_»cÜds
)

131  -
ENOMEM
;

133 
i
 = 0; i < 
´og
->
aux
->
u£d_m­_út
; i++)

134 ià(
	`bpf_m­_ofæßd_ÃuŒ®
(
´og
->
aux
->
u£d_m­s
[
i
])) {

135 
”r
 = 
	`nå_m­_±r_»cÜd
(
bpf
, 
nå_´og
,

136 
´og
->
aux
->
u£d_m­s
[
i
]);

137 ià(
”r
) {

138 
	`nå_m­_±rs_fÜg‘
(
bpf
, 
nå_´og
);

139  
”r
;

142 
	`WARN_ON
(
út
 !ð
nå_´og
->
m­_»cÜds_út
);

145 
	}
}

148 
	$nå_´og_´•¬e
(
nå_´og
 *nå_´og, cÚ¡ 
bpf_š¢
 *
´og
,

149 
út
)

151 
nå_š¢_m‘a
 *
m‘a
;

152 
i
;

154 
i
 = 0; i < 
út
; i++) {

155 
m‘a
 = 
	`kz®loc
((*m‘a), 
GFP_KERNEL
);

156 ià(!
m‘a
)

157  -
ENOMEM
;

159 
m‘a
->
š¢
 = 
´og
[
i
];

160 
m‘a
->
n
 = 
i
;

161 ià(
	`is_mbpf_®u
(
m‘a
)) {

162 
m‘a
->
umš_¤c
 = 
U64_MAX
;

163 
m‘a
->
umš_d¡
 = 
U64_MAX
;

166 
	`li¡_add_ž
(&
m‘a
->
l
, &
nå_´og
->
š¢s
);

168 
nå_´og
->
n_š¢s
 = 
út
;

170 
	`nå_bpf_j™_´•¬e
(
nå_´og
);

172 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 20, 0)

173 
nå_´og
->
sub´og
 = 
	`kz®loc
(Òå_´og->sub´og[0]), 
GFP_KERNEL
);

174 ià(!
nå_´og
->
sub´og
)

175  -
ENOMEM
;

176 
nå_´og
->
sub´og_út
 = 1;

180 
	}
}

182 
	$nå_´og_ä“
(
nå_´og
 *nfp_prog)

184 
nå_š¢_m‘a
 *
m‘a
, *
tmp
;

186 
	`kä“
(
nå_´og
->
sub´og
);

188 
	`li¡_fÜ_—ch_’Œy_§ã
(
m‘a
, 
tmp
, &
nå_´og
->
š¢s
, 
l
) {

189 
	`li¡_d–
(&
m‘a
->
l
);

190 
	`kä“
(
m‘a
);

192 
	`kä“
(
nå_´og
);

193 
	}
}

195 
	$nå_bpf_v”if›r_´•
(
bpf_´og
 *
´og
)

197 
nå_´og
 *nfp_prog;

198 
»t
;

200 
nå_´og
 = 
	`kz®loc
((*nå_´og), 
GFP_KERNEL
);

201 ià(!
nå_´og
)

202  -
ENOMEM
;

203 
´og
->
aux
->
ofæßd
->
dev_´iv
 = 
nå_´og
;

205 
	`INIT_LIST_HEAD
(&
nå_´og
->
š¢s
);

206 
nå_´og
->
ty³
 = 
´og
->type;

207 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

208 
nå_´og
->
bpf
 = 
	`com·t__bpf_´og_g‘_Â
(
´og
)->
­p
->
´iv
;

210 
nå_´og
->
bpf
 = 
	`bpf_ofæßd_dev_´iv
(
´og
->
aux
->
ofæßd
->
offdev
);

213 
»t
 = 
	`nå_´og_´•¬e
(
nå_´og
, 
´og
->
š¢si
,…rog->
Ën
);

214 ià(
»t
)

215 
”r_ä“
;

217 
nå_´og
->
v”if›r_m‘a
 = 
	`nå_´og_fœ¡_m‘a
(nfp_prog);

221 
”r_ä“
:

222 
	`nå_´og_ä“
(
nå_´og
);

224  
»t
;

225 
	}
}

227 
	$nå_bpf_Œª¦©e
(
bpf_´og
 *
´og
)

229 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
´og
->
aux
->
ofæßd
->
Ãtdev
);

230 
nå_´og
 *nå_´og = 
´og
->
aux
->
ofæßd
->
dev_´iv
;

231 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 20, 0)

232 
¡ack_size
;

234 
max_š¡r
;

235 
”r
;

237 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 20, 0)

238 
¡ack_size
 = 
	`Â_»adb
(
Â
, 
NFP_NET_CFG_BPF_STACK_SZ
) * 64;

239 ià(
´og
->
aux
->
¡ack_d•th
 > 
¡ack_size
) {

240 
	`Â_šfo
(
Â
, "stackoo†arge:…rogram %dB > FW stack %dB\n",

241 
´og
->
aux
->
¡ack_d•th
, 
¡ack_size
);

242  -
EOPNOTSUPP
;

244 
nå_´og
->
sub´og
[0].
¡ack_d•th
 = 
´og
->
aux
->stack_depth;

245 
nå_´og
->
¡ack_size
 = 
´og
->
aux
->
¡ack_d•th
;

248 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

250 ià(
´og
->
aux
->
ofæßd
->
Ýt_çžed
)

251  -
EINVAL
;

254 
max_š¡r
 = 
	`Â_»adw
(
Â
, 
NFP_NET_CFG_BPF_MAX_LEN
);

255 
nå_´og
->
__´og_®loc_Ën
 = 
max_š¡r
 * (
u64
);

257 
nå_´og
->
´og
 = 
	`kvm®loc
Òå_´og->
__´og_®loc_Ën
, 
GFP_KERNEL
);

258 ià(!
nå_´og
->
´og
)

259  -
ENOMEM
;

261 
”r
 = 
	`nå_bpf_j™
(
nå_´og
);

262 ià(
”r
)

263  
”r
;

265 
´og
->
aux
->
ofæßd
->
j™ed_Ën
 = 
nå_´og
->
´og_Ën
 * (
u64
);

266 
´og
->
aux
->
ofæßd
->
j™ed_image
 = 
nå_´og
->prog;

268  
	`nå_m­_±rs_»cÜd
(
nå_´og
->
bpf
,‚å_´og, 
´og
);

269 
	}
}

271 
	$nå_bpf_de¡roy
(
bpf_´og
 *
´og
)

273 
nå_´og
 *nå_´og = 
´og
->
aux
->
ofæßd
->
dev_´iv
;

275 
	`kvä“
(
nå_´og
->
´og
);

276 
	`nå_m­_±rs_fÜg‘
(
nå_´og
->
bpf
,‚fp_prog);

277 
	`nå_´og_ä“
(
nå_´og
);

278 
	}
}

283 
	$nå_m­_bpf_by‹_sw­
(
nå_bpf_m­
 *
nå_m­
, *
v®ue
)

285 
u32
 *
wÜd
 = 
v®ue
;

286 
i
;

288 
i
 = 0; i < 
	`DIV_ROUND_UP
(
nå_m­
->
offm­
->
m­
.
v®ue_size
, 4); i++)

289 ià(
nå_m­
->
u£_m­
[
i
].
ty³
 =ð
NFP_MAP_USE_ATOMIC_CNT
)

290 
wÜd
[
i
] = (
__fÜû
 
u32
)
	`ýu_to_be32
(word[i]);

291 
	}
}

297 
	$nå_m­_bpf_by‹_sw­_»cÜd
(
nå_bpf_m­
 *
nå_m­
, *
v®ue
)

299 
u32
 *
wÜd
 = 
v®ue
;

300 
i
;

302 
i
 = 0; i < 
	`DIV_ROUND_UP
(
nå_m­
->
offm­
->
m­
.
v®ue_size
, 4); i++)

303 ià(
nå_m­
->
u£_m­
[
i
].
ty³
 =ð
NFP_MAP_UNUSED
 &&

304 
wÜd
[
i
] !ð(
__fÜû
 
u32
)
	`ýu_to_be32
(word[i]))

305 
nå_m­
->
u£_m­
[
i
].
nÚ_z”o_upd©e
 = 1;

306 
	}
}

309 
	$nå_bpf_m­_lookup_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

310 *
key
, *
v®ue
)

312 
”r
;

314 
”r
 = 
	`nå_bpf_ù¾_lookup_’Œy
(
offm­
, 
key
, 
v®ue
);

315 ià(
”r
)

316  
”r
;

318 
	`nå_m­_bpf_by‹_sw­
(
offm­
->
dev_´iv
, 
v®ue
);

320 
	}
}

323 
	$nå_bpf_m­_upd©e_’Œy
(
bpf_ofæßded_m­
 *
offm­
,

324 *
key
, *
v®ue
, 
u64
 
æags
)

326 
	`nå_m­_bpf_by‹_sw­
(
offm­
->
dev_´iv
, 
v®ue
);

327 
	`nå_m­_bpf_by‹_sw­_»cÜd
(
offm­
->
dev_´iv
, 
v®ue
);

328  
	`nå_bpf_ù¾_upd©e_’Œy
(
offm­
, 
key
, 
v®ue
, 
æags
);

329 
	}
}

332 
	$nå_bpf_m­_g‘_Ãxt_key
(
bpf_ofæßded_m­
 *
offm­
,

333 *
key
, *
Ãxt_key
)

335 ià(!
key
)

336  
	`nå_bpf_ù¾_g‘fœ¡_’Œy
(
offm­
, 
Ãxt_key
);

337  
	`nå_bpf_ù¾_g‘Ãxt_’Œy
(
offm­
, 
key
, 
Ãxt_key
);

338 
	}
}

341 
	$nå_bpf_m­_d–‘e_–em
(
bpf_ofæßded_m­
 *
offm­
, *
key
)

343 ià(
offm­
->
m­
.
m­_ty³
 =ð
BPF_MAP_TYPE_ARRAY
)

344  -
EINVAL
;

345  
	`nå_bpf_ù¾_d–_’Œy
(
offm­
, 
key
);

346 
	}
}

348 cÚ¡ 
bpf_m­_dev_Ýs
 
	gnå_bpf_m­_Ýs
 = {

349 .
m­_g‘_Ãxt_key
 = 
nå_bpf_m­_g‘_Ãxt_key
,

350 .
	gm­_lookup_–em
 = 
nå_bpf_m­_lookup_’Œy
,

351 .
	gm­_upd©e_–em
 = 
nå_bpf_m­_upd©e_’Œy
,

352 .
	gm­_d–‘e_–em
 = 
nå_bpf_m­_d–‘e_–em
,

356 
	$nå_bpf_m­_®loc
(
nå_­p_bpf
 *
bpf
, 
bpf_ofæßded_m­
 *
offm­
)

358 
nå_bpf_m­
 *
nå_m­
;

359 
u£_m­_size
;

360 
»s
;

362 ià(!
bpf
->
m­s
.
ty³s
)

363  -
EOPNOTSUPP
;

365 ià(
offm­
->
m­
.
m­_æags
 ||

366 
offm­
->
m­
.
numa_node
 !ð
NUMA_NO_NODE
) {

367 
	`´_šfo
("map flags‡re‚ot supported\n");

368  -
EINVAL
;

371 ià(!(
bpf
->
m­s
.
ty³s
 & 1 << 
offm­
->
m­
.
m­_ty³
)) {

372 
	`´_šfo
("mapype‚ot supported\n");

373  -
EOPNOTSUPP
;

375 ià(
bpf
->
m­s
.
max_m­s
 =ðbpf->
m­s_š_u£
) {

376 
	`´_šfo
("too many maps for‡ device\n");

377  -
ENOMEM
;

379 ià(
bpf
->
m­s
.
max_–ems
 - bpf->
m­_–ems_š_u£
 <

380 
offm­
->
m­
.
max_’Œ›s
) {

381 
	`´_šfo
("map withoo manyƒlements: %u,†eft: %u\n",

382 
offm­
->
m­
.
max_’Œ›s
,

383 
bpf
->
m­s
.
max_–ems
 - bpf->
m­_–ems_š_u£
);

384  -
ENOMEM
;

387 ià(
	`round_up
(
offm­
->
m­
.
key_size
, 8) +

388 
	`round_up
(
offm­
->
m­
.
v®ue_size
, 8è> 
bpf
->
m­s
.
max_–em_sz
) {

389 
	`´_šfo
("mapƒlementsoo†arge: %u, FW maxƒlement size (key+value): %u\n",

390 
	`round_up
(
offm­
->
m­
.
key_size
, 8) +

391 
	`round_up
(
offm­
->
m­
.
v®ue_size
, 8),

392 
bpf
->
m­s
.
max_–em_sz
);

393  -
ENOMEM
;

395 ià(
offm­
->
m­
.
key_size
 > 
bpf
->
m­s
.
max_key_sz
) {

396 
	`´_šfo
("map key size %u, FW max is %u\n",

397 
offm­
->
m­
.
key_size
, 
bpf
->
m­s
.
max_key_sz
);

398  -
ENOMEM
;

400 ià(
offm­
->
m­
.
v®ue_size
 > 
bpf
->
m­s
.
max_v®_sz
) {

401 
	`´_šfo
("map value size %u, FW max is %u\n",

402 
offm­
->
m­
.
v®ue_size
, 
bpf
->
m­s
.
max_v®_sz
);

403  -
ENOMEM
;

406 
u£_m­_size
 = 
	`DIV_ROUND_UP
(
offm­
->
m­
.
v®ue_size
, 4) *

407 
	`FIELD_SIZEOF
(
nå_bpf_m­
, 
u£_m­
[0]);

409 
nå_m­
 = 
	`kz®loc
((*nå_m­è+ 
u£_m­_size
, 
GFP_USER
);

410 ià(!
nå_m­
)

411  -
ENOMEM
;

413 
offm­
->
dev_´iv
 = 
nå_m­
;

414 
nå_m­
->
offm­
 = offmap;

415 
nå_m­
->
bpf
 = bpf;

417 
»s
 = 
	`nå_bpf_ù¾_®loc_m­
(
bpf
, &
offm­
->
m­
);

418 ià(
»s
 < 0) {

419 
	`kä“
(
nå_m­
);

420  
»s
;

423 
nå_m­
->
tid
 = 
»s
;

424 
offm­
->
dev_Ýs
 = &
nå_bpf_m­_Ýs
;

425 
bpf
->
m­s_š_u£
++;

426 
bpf
->
m­_–ems_š_u£
 +ð
offm­
->
m­
.
max_’Œ›s
;

427 
	`li¡_add_ž
(&
nå_m­
->
l
, &
bpf
->
m­_li¡
);

430 
	}
}

433 
	$nå_bpf_m­_ä“
(
nå_­p_bpf
 *
bpf
, 
bpf_ofæßded_m­
 *
offm­
)

435 
nå_bpf_m­
 *
nå_m­
 = 
offm­
->
dev_´iv
;

437 
	`nå_bpf_ù¾_ä“_m­
(
bpf
, 
nå_m­
);

438 
	`li¡_d–_š™
(&
nå_m­
->
l
);

439 
bpf
->
m­_–ems_š_u£
 -ð
offm­
->
m­
.
max_’Œ›s
;

440 
bpf
->
m­s_š_u£
--;

441 
	`kä“
(
nå_m­
);

444 
	}
}

446 
	$nå_ndo_bpf
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
, 
Ãtdev_bpf
 *
bpf
)

448 
bpf
->
commªd
) {

449 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

450 
BPF_OFFLOAD_VERIFIER_PREP
:

451 
bpf
->
v”if›r
.
Ýs
 = &
nå_bpf_dev_Ýs
;

452  
	`nå_bpf_v”if›r_´•
(
bpf
->
v”if›r
.
´og
);

453 
BPF_OFFLOAD_TRANSLATE
:

454  
	`nå_bpf_Œª¦©e
(
bpf
->
ofæßd
.
´og
);

455 
BPF_OFFLOAD_DESTROY
:

456 
	`nå_bpf_de¡roy
(
bpf
->
ofæßd
.
´og
);

459 
BPF_OFFLOAD_MAP_ALLOC
:

460  
	`nå_bpf_m­_®loc
(
­p
->
´iv
, 
bpf
->
offm­
);

461 
BPF_OFFLOAD_MAP_FREE
:

462  
	`nå_bpf_m­_ä“
(
­p
->
´iv
, 
bpf
->
offm­
);

464  -
EINVAL
;

466 
	}
}

469 
	$nå_bpf_³rf_ev’t_cÝy
(*
d¡
, cÚ¡ *
¤c
,

470 
off
, 
Ën
)

472 
	`memýy
(
d¡
, 
¤c
 + 
off
, 
Ën
);

474 
	}
}

476 
	$nå_bpf_ev’t_ouut
(
nå_­p_bpf
 *
bpf
, cÚ¡ *
d©a
,

477 
Ën
)

479 
cmsg_bpf_ev’t
 *
cbe
 = (*)
d©a
;

480 
nå_bpf_ÃuŒ®_m­
 *
»cÜd
;

481 
u32
 
pkt_size
, 
d©a_size
, 
m­_id
;

482 
u64
 
m­_id_fuÎ
;

484 ià(
Ën
 < (
cmsg_bpf_ev’t
))

485  -
EINVAL
;

487 
pkt_size
 = 
	`be32_to_ýu
(
cbe
->pkt_size);

488 
d©a_size
 = 
	`be32_to_ýu
(
cbe
->data_size);

489 
m­_id_fuÎ
 = 
	`be64_to_ýu
(
cbe
->
m­_±r
);

490 
m­_id
 = 
m­_id_fuÎ
;

492 ià(
Ën
 < (
cmsg_bpf_ev’t
è+ 
pkt_size
 + 
d©a_size
)

493  -
EINVAL
;

494 ià(
cbe
->
hdr
.
v”
 !ð
CMSG_MAP_ABI_VERSION
)

495  -
EINVAL
;

497 
	`rcu_»ad_lock
();

498 
»cÜd
 = 
	`rhashbË_lookup_ç¡
(&
bpf
->
m­s_ÃuŒ®
, &
m­_id
,

499 
nå_bpf_m­s_ÃuŒ®_·¿ms
);

500 ià(!
»cÜd
 || 
m­_id_fuÎ
 > 
U32_MAX
) {

501 
	`rcu_»ad_uÆock
();

502 
	`cmsg_w¬n
(
bpf
, "perfƒvent: map id %lld (0x%llx)‚ot„ecognized, droppingƒvent\n",

503 
m­_id_fuÎ
, map_id_full);

504  -
EINVAL
;

507 
	`bpf_ev’t_ouut
(
»cÜd
->
±r
, 
	`be32_to_ýu
(
cbe
->
ýu_id
),

508 &
cbe
->
d©a
[
	`round_up
(
pkt_size
, 4)], 
d©a_size
,

509 
cbe
->
d©a
, 
pkt_size
, 
nå_bpf_³rf_ev’t_cÝy
);

510 
	`rcu_»ad_uÆock
();

513 
	}
}

516 
	$nå_Ãt_bpf_lßd
(
nå_Ãt
 *
Â
, 
bpf_´og
 *
´og
,

517 
ÃŽšk_ext_ack
 *
exck
)

519 
nå_´og
 *nå_´og = 
´og
->
aux
->
ofæßd
->
dev_´iv
;

520 
fw_mtu
, 
pkt_off
, 
max_¡ack
, 
max_´og_Ën
;

521 
dma_addr_t
 
dma_addr
;

522 *
img
;

523 
”r
;

525 
fw_mtu
 = 
	`Â_»adb
(
Â
, 
NFP_NET_CFG_BPF_INL_MTU
) * 64 - 32;

526 
pkt_off
 = 
Â
->
dp
.
Ãtdev
->
mtu
;

527 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 0, 0)

528 
pkt_off
 = 
	`mš
(
´og
->
aux
->
max_pkt_off£t
,…kt_off);

530 ià(
fw_mtu
 < 
pkt_off
) {

531 
	`NL_SET_ERR_MSG_MOD
(
exck
, "BPF offload‚ot supported with…otential…acket‡ccess beyond HW…acket split boundary");

532  -
EOPNOTSUPP
;

535 
max_¡ack
 = 
	`Â_»adb
(
Â
, 
NFP_NET_CFG_BPF_STACK_SZ
) * 64;

536 ià(
nå_´og
->
¡ack_size
 > 
max_¡ack
) {

537 
	`NL_SET_ERR_MSG_MOD
(
exck
, "stackoo†arge");

538  -
EOPNOTSUPP
;

541 
max_´og_Ën
 = 
	`Â_»adw
(
Â
, 
NFP_NET_CFG_BPF_MAX_LEN
);

542 ià(
nå_´og
->
´og_Ën
 > 
max_´og_Ën
) {

543 
	`NL_SET_ERR_MSG_MOD
(
exck
, "programoo†ong");

544  -
EOPNOTSUPP
;

547 
img
 = 
	`nå_bpf_»lo_fÜ_vnic
(
nå_´og
, 
Â
->
­p_´iv
);

548 ià(
	`IS_ERR
(
img
))

549  
	`PTR_ERR
(
img
);

551 
dma_addr
 = 
	`dma_m­_sšgË
(
Â
->
dp
.
dev
, 
img
,

552 
nå_´og
->
´og_Ën
 * (
u64
),

553 
DMA_TO_DEVICE
);

554 ià(
	`dma_m­pšg_”rÜ
(
Â
->
dp
.
dev
, 
dma_addr
)) {

555 
	`kä“
(
img
);

556  -
ENOMEM
;

559 
	`Â_wr™ew
(
Â
, 
NFP_NET_CFG_BPF_SIZE
, 
nå_´og
->
´og_Ën
);

560 
	`Â_wr™eq
(
Â
, 
NFP_NET_CFG_BPF_ADDR
, 
dma_addr
);

563 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_BPF
);

564 ià(
”r
)

565 
	`NL_SET_ERR_MSG_MOD
(
exck
,

568 
	`dma_unm­_sšgË
(
Â
->
dp
.
dev
, 
dma_addr
, 
nå_´og
->
´og_Ën
 * (
u64
),

569 
DMA_TO_DEVICE
);

570 
	`kä“
(
img
);

572  
”r
;

573 
	}
}

576 
	$nå_Ãt_bpf_¡¬t
(
nå_Ãt
 *
Â
, 
ÃŽšk_ext_ack
 *
exck
)

578 
”r
;

581 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_BPF
;

582 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_CTRL
,‚n->
dp
.
ù¾
);

583 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_GEN
);

584 ià(
”r
)

585 
	`NL_SET_ERR_MSG_MOD
(
exck
,

587 
	}
}

589 
	$nå_Ãt_bpf_¡Ý
(
nå_Ãt
 *
Â
)

591 ià(!(
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_BPF
))

594 
Â
->
dp
.
ù¾
 &ð~
NFP_NET_CFG_CTRL_BPF
;

595 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_CTRL
,‚n->
dp
.
ù¾
);

597  
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_GEN
);

598 
	}
}

600 
	$nå_Ãt_bpf_ofæßd
(
nå_Ãt
 *
Â
, 
bpf_´og
 *
´og
,

601 
boÞ
 
Þd_´og
, 
ÃŽšk_ext_ack
 *
exck
)

603 
”r
;

605 ià(
´og
 && !
	`bpf_ofæßd_dev_m©ch
Õrog, 
Â
->
dp
.
Ãtdev
))

606  -
EINVAL
;

608 ià(
´og
 && 
Þd_´og
) {

609 
u8
 
ÿp
;

611 
ÿp
 = 
	`Â_»adb
(
Â
, 
NFP_NET_CFG_BPF_CAP
);

612 ià(!(
ÿp
 & 
NFP_NET_BPF_CAP_RELO
)) {

613 
	`NL_SET_ERR_MSG_MOD
(
exck
,

615  -
EBUSY
;

620 ià(!
Þd_´og
 && 
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_BPF
)

621  -
EBUSY
;

623 ià(
Þd_´og
 && !
´og
)

624  
	`nå_Ãt_bpf_¡Ý
(
Â
);

626 
”r
 = 
	`nå_Ãt_bpf_lßd
(
Â
, 
´og
, 
exck
);

627 ià(
”r
)

628  
”r
;

630 ià(!
Þd_´og
)

631 
	`nå_Ãt_bpf_¡¬t
(
Â
, 
exck
);

634 
	}
}

636 cÚ¡ 
bpf_´og_ofæßd_Ýs
 
	gnå_bpf_dev_Ýs
 = {

637 .
š¢_hook
 = 
nå_v”ify_š¢
,

638 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 20, 0)

639 .
	gfš®ize
 = 
nå_bpf_fš®ize
,

641 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

642 .
	g»¶aû_š¢
 = 
nå_bpf_Ýt_»¶aû_š¢
,

643 .
	g»move_š¢s
 = 
nå_bpf_Ýt_»move_š¢s
,

645 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 0, 0)

646 .
	g´•¬e
 = 
nå_bpf_v”if›r_´•
,

647 .
	gŒª¦©e
 = 
nå_bpf_Œª¦©e
,

648 .
	gde¡roy
 = 
nå_bpf_de¡roy
,

	@src/bpf/verifier.c

4 
	~<lšux/bpf.h
>

5 
	~<lšux/bpf_v”if›r.h
>

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/Ãtdeviû.h
>

8 
	~<lšux/pkt_þs.h
>

10 
	~"../nå_­p.h
"

11 
	~"../nå_maš.h
"

12 
	~"../nå_Ãt.h
"

13 
	~"fw.h
"

14 
	~"maš.h
"

16 
	#´_vlog
(
’v
, 
fmt
, ...) \

17 
	`bpf_v”if›r_log_wr™e
(
’v
, "[nå] " 
fmt
, ##
__VA_ARGS__
)

	)

19 
nå_š¢_m‘a
 *

20 
	$nå_bpf_gÙo_m‘a
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

21 
š¢_idx
)

23 
fÜw¬d
, 
backw¬d
, 
i
;

25 
backw¬d
 = 
m‘a
->
n
 - 
š¢_idx
;

26 
fÜw¬d
 = 
š¢_idx
 - 
m‘a
->
n
;

28 ià(
	`mš
(
fÜw¬d
, 
backw¬d
è> 
nå_´og
->
n_š¢s
 - 
š¢_idx
 - 1) {

29 
backw¬d
 = 
nå_´og
->
n_š¢s
 - 
š¢_idx
 - 1;

30 
m‘a
 = 
	`nå_´og_Ï¡_m‘a
(
nå_´og
);

32 ià(
	`mš
(
fÜw¬d
, 
backw¬d
è> 
š¢_idx
 && backward > insn_idx) {

33 
fÜw¬d
 = 
š¢_idx
;

34 
m‘a
 = 
	`nå_´og_fœ¡_m‘a
(
nå_´og
);

37 ià(
fÜw¬d
 < 
backw¬d
)

38 
i
 = 0; i < 
fÜw¬d
; i++)

39 
m‘a
 = 
	`nå_m‘a_Ãxt
(meta);

41 
i
 = 0; i < 
backw¬d
; i++)

42 
m‘a
 = 
	`nå_m‘a_´ev
(meta);

44  
m‘a
;

45 
	}
}

48 
	$nå_»cÜd_adju¡_h—d
(
nå_­p_bpf
 *
bpf
, 
nå_´og
 *nfp_prog,

49 
nå_š¢_m‘a
 *
m‘a
,

50 cÚ¡ 
bpf_»g_¡©e
 *
»g2
)

52 
loÿtiÚ
 = 
UINT_MAX
;

53 
imm
;

59 ià(
»g2
->
ty³
 !ð
SCALAR_VALUE
 || !
	`Šum_is_cÚ¡
Ôeg2->
v¬_off
))

60 
ex™_£t_loÿtiÚ
;

61 
imm
 = 
»g2
->
v¬_off
.
v®ue
;

63 ià(
imm
 > 
ETH_ZLEN
 - 
ETH_HLEN
)

64 
ex™_£t_loÿtiÚ
;

65 ià(
imm
 > ()
bpf
->
adju¡_h—d
.
gu¬ª‹ed_add
 ||

66 
imm
 < -
bpf
->
adju¡_h—d
.
gu¬ª‹ed_sub
)

67 
ex™_£t_loÿtiÚ
;

69 ià(
nå_´og
->
adju¡_h—d_loÿtiÚ
) {

71 ià(
nå_´og
->
adju¡_h—d_loÿtiÚ
 !ð
m‘a
->
n
)

72 
ex™_£t_loÿtiÚ
;

74 ià(
m‘a
->
¬g2
.
»g
.
v¬_off
.
v®ue
 !ð
imm
)

75 
ex™_£t_loÿtiÚ
;

78 
loÿtiÚ
 = 
m‘a
->
n
;

79 
ex™_£t_loÿtiÚ
:

80 
nå_´og
->
adju¡_h—d_loÿtiÚ
 = 
loÿtiÚ
;

81 
	}
}

83 
boÞ
 
	$nå_bpf_m­_upd©e_v®ue_ok
(
bpf_v”if›r_’v
 *
’v
)

85 cÚ¡ 
bpf_»g_¡©e
 *
»g1
 = 
	`cur_»gs
(
’v
è+ 
BPF_REG_1
;

86 cÚ¡ 
bpf_»g_¡©e
 *
»g3
 = 
	`cur_»gs
(
’v
è+ 
BPF_REG_3
;

87 
bpf_ofæßded_m­
 *
offm­
;

88 
bpf_func_¡©e
 *
¡©e
;

89 
nå_bpf_m­
 *
nå_m­
;

90 
off
, 
i
;

92 
¡©e
 = 
’v
->
cur_¡©e
->
äame
[
»g3
->
äam’o
];

99 
offm­
 = 
	`m­_to_offm­
(
»g1
->
m­_±r
);

100 
nå_m­
 = 
offm­
->
dev_´iv
;

101 
off
 = 
»g3
->ofà+„eg3->
v¬_off
.
v®ue
;

103 
i
 = 0; i < 
offm­
->
m­
.
v®ue_size
; i++) {

104 
bpf_¡ack_¡©e
 *
¡ack_’Œy
;

105 
soff
;

107 
soff
 = -(
off
 + 
i
) - 1;

108 
¡ack_’Œy
 = &
¡©e
->
¡ack
[
soff
 / 
BPF_REG_SIZE
];

109 ià(
¡ack_’Œy
->
¦Ù_ty³
[
soff
 % 
BPF_REG_SIZE
] =ð
STACK_ZERO
)

112 ià(
nå_m­
->
u£_m­
[
i
 / 4].
ty³
 =ð
NFP_MAP_USE_ATOMIC_CNT
) {

113 
	`´_vlog
(
’v
, "value‡t offset %d/%d may be‚on-zero, bpf_map_update_elem() is„equiredo initialize‡tomic counterso zeroo‡void offloadƒndian issues\n",

114 
i
, 
soff
);

115  
çl£
;

117 
nå_m­
->
u£_m­
[
i
 / 4].
nÚ_z”o_upd©e
 = 1;

120  
Œue
;

121 
	}
}

124 
	$nå_bpf_¡ack_¬g_ok
(cÚ¡ *
âame
, 
bpf_v”if›r_’v
 *
’v
,

125 cÚ¡ 
bpf_»g_¡©e
 *
»g
,

126 
nå_bpf_»g_¡©e
 *
Þd_¬g
)

128 
s64
 
off
, 
Þd_off
;

130 ià(
»g
->
ty³
 !ð
PTR_TO_STACK
) {

131 
	`´_vlog
(
’v
, "%s: unsupported…trype %d\n",

132 
âame
, 
»g
->
ty³
);

133  
çl£
;

135 ià(!
	`Šum_is_cÚ¡
(
»g
->
v¬_off
)) {

136 
	`´_vlog
(
’v
, "%s: v¬ŸbË…oš‹r\n", 
âame
);

137  
çl£
;

140 
off
 = 
»g
->
v¬_off
.
v®ue
 +„eg->off;

141 ià(-
off
 % 4) {

142 
	`´_vlog
(
’v
, "%s: uÇligÃd sck…oš‹¸%Îd\n", 
âame
, -
off
);

143  
çl£
;

147 ià(!
Þd_¬g
)

148  
Œue
;

150 
Þd_off
 = 
Þd_¬g
->
»g
.
v¬_off
.
v®ue
 + old_¬g->»g.
off
;

151 
Þd_¬g
->
v¬_off
 |ð
off
 !ð
Þd_off
;

153  
Œue
;

154 
	}
}

156 
boÞ


157 
	$nå_bpf_m­_ÿÎ_ok
(cÚ¡ *
âame
, 
bpf_v”if›r_’v
 *
’v
,

158 
nå_š¢_m‘a
 *
m‘a
,

159 
u32
 
h–³r_tgt
, cÚ¡ 
bpf_»g_¡©e
 *
»g1
)

161 ià(!
h–³r_tgt
) {

162 
	`´_vlog
(
’v
, "%s:‚Ù suµÜ‹d by FW\n", 
âame
);

163  
çl£
;

166  
Œue
;

167 
	}
}

170 
	$nå_bpf_check_h–³r_ÿÎ
(
nå_´og
 *nfp_prog,

171 
bpf_v”if›r_’v
 *
’v
,

172 
nå_š¢_m‘a
 *
m‘a
)

174 cÚ¡ 
bpf_»g_¡©e
 *
»g1
 = 
	`cur_»gs
(
’v
è+ 
BPF_REG_1
;

175 cÚ¡ 
bpf_»g_¡©e
 *
»g2
 = 
	`cur_»gs
(
’v
è+ 
BPF_REG_2
;

176 cÚ¡ 
bpf_»g_¡©e
 *
»g3
 = 
	`cur_»gs
(
’v
è+ 
BPF_REG_3
;

177 
nå_­p_bpf
 *
bpf
 = 
nå_´og
->bpf;

178 
u32
 
func_id
 = 
m‘a
->
š¢
.
imm
;

180 
func_id
) {

181 
BPF_FUNC_xdp_adju¡_h—d
:

182 ià(!
bpf
->
adju¡_h—d
.
off_max
) {

183 
	`´_vlog
(
’v
, "adjust_head‚ot supported by FW\n");

184  -
EOPNOTSUPP
;

186 ià(!(
bpf
->
adju¡_h—d
.
æags
 & 
NFP_BPF_ADJUST_HEAD_NO_META
)) {

187 
	`´_vlog
(
’v
, "adjust_head: FW„equires shifting metadata,‚ot supported byhe driver\n");

188  -
EOPNOTSUPP
;

191 
	`nå_»cÜd_adju¡_h—d
(
bpf
, 
nå_´og
, 
m‘a
, 
»g2
);

194 
BPF_FUNC_xdp_adju¡_ž
:

195 ià(!
bpf
->
adju¡_ž
) {

196 
	`´_vlog
(
’v
, "adjust_tail‚ot supported by FW\n");

197  -
EOPNOTSUPP
;

201 
BPF_FUNC_m­_lookup_–em
:

202 ià(!
	`nå_bpf_m­_ÿÎ_ok
("m­_lookup", 
’v
, 
m‘a
,

203 
bpf
->
h–³rs
.
m­_lookup
, 
»g1
) ||

204 !
	`nå_bpf_¡ack_¬g_ok
("m­_lookup", 
’v
, 
»g2
,

205 
m‘a
->
func_id
 ? &m‘a->
¬g2
 : 
NULL
))

206  -
EOPNOTSUPP
;

209 
BPF_FUNC_m­_upd©e_–em
:

210 ià(!
	`nå_bpf_m­_ÿÎ_ok
("m­_upd©e", 
’v
, 
m‘a
,

211 
bpf
->
h–³rs
.
m­_upd©e
, 
»g1
) ||

212 !
	`nå_bpf_¡ack_¬g_ok
("m­_upd©e", 
’v
, 
»g2
,

213 
m‘a
->
func_id
 ? &m‘a->
¬g2
 : 
NULL
) ||

214 !
	`nå_bpf_¡ack_¬g_ok
("m­_upd©e", 
’v
, 
»g3
, 
NULL
) ||

215 !
	`nå_bpf_m­_upd©e_v®ue_ok
(
’v
))

216  -
EOPNOTSUPP
;

219 
BPF_FUNC_m­_d–‘e_–em
:

220 ià(!
	`nå_bpf_m­_ÿÎ_ok
("m­_d–‘e", 
’v
, 
m‘a
,

221 
bpf
->
h–³rs
.
m­_d–‘e
, 
»g1
) ||

222 !
	`nå_bpf_¡ack_¬g_ok
("m­_d–‘e", 
’v
, 
»g2
,

223 
m‘a
->
func_id
 ? &m‘a->
¬g2
 : 
NULL
))

224  -
EOPNOTSUPP
;

227 
BPF_FUNC_g‘_´ªdom_u32
:

228 ià(
bpf
->
p£udo_¿ndom
)

230 
	`´_vlog
(
’v
, "bpf_get_prandom_u32(): FW doesn't support„andom‚umber generation\n");

231  -
EOPNOTSUPP
;

233 
BPF_FUNC_³rf_ev’t_ouut
:

234 
	`BUILD_BUG_ON
(
NFP_BPF_SCALAR_VALUE
 !ð
SCALAR_VALUE
 ||

235 
NFP_BPF_MAP_VALUE
 !ð
PTR_TO_MAP_VALUE
 ||

236 
NFP_BPF_STACK
 !ð
PTR_TO_STACK
 ||

237 
NFP_BPF_PACKET_DATA
 !ð
PTR_TO_PACKET
);

239 ià(!
bpf
->
h–³rs
.
³rf_ev’t_ouut
) {

240 
	`´_vlog
(
’v
, "event_output:‚ot supported by FW\n");

241  -
EOPNOTSUPP
;

247 ià(
»g3
->
v¬_off
.
mask
 & 
BPF_F_INDEX_MASK
 ||

248 (
»g3
->
v¬_off
.
v®ue
 & 
BPF_F_INDEX_MASK
) !=

249 
BPF_F_CURRENT_CPU
) {

250 
Š_buf
[48];

252 
	`Šum_¡º
(
Š_buf
, Ñn_buf), 
»g3
->
v¬_off
);

253 
	`´_vlog
(
’v
, "event_output: must use BPF_F_CURRENT_CPU, var_off: %s\n",

254 
Š_buf
);

255  -
EOPNOTSUPP
;

261 
»g1
 = 
	`cur_»gs
(
’v
è+ 
BPF_REG_4
;

263 ià(
»g1
->
ty³
 !ð
SCALAR_VALUE
 &&

264 
»g1
->
ty³
 !ð
PTR_TO_STACK
 &&

265 
»g1
->
ty³
 !ð
PTR_TO_MAP_VALUE
 &&

266 
»g1
->
ty³
 !ð
PTR_TO_PACKET
) {

267 
	`´_vlog
(
’v
, "event_output: unsupported…trype: %d\n",

268 
»g1
->
ty³
);

269  -
EOPNOTSUPP
;

272 ià(
»g1
->
ty³
 =ð
PTR_TO_STACK
 &&

273 !
	`nå_bpf_¡ack_¬g_ok
("ev’t_ouut", 
’v
, 
»g1
, 
NULL
))

274  -
EOPNOTSUPP
;

284 
	`dev_w¬n_Úû
(&
nå_´og
->
bpf
->
­p
->
pf
->
pdev
->
dev
,

286 
	`´_vlog
(
’v
, "warning:„eturn codes‡nd behavior ofƒvent_output helper differ for offload!\n");

288 ià(!
m‘a
->
func_id
)

291 ià(
»g1
->
ty³
 !ð
m‘a
->
¬g1
.type) {

292 
	`´_vlog
(
’v
, "event_output:…trype changed: %d %d\n",

293 
m‘a
->
¬g1
.
ty³
, 
»g1
->type);

294  -
EINVAL
;

299 
	`´_vlog
(
’v
, "unsuµÜ‹d funùiÚ id: %d\n", 
func_id
);

300  -
EOPNOTSUPP
;

303 
m‘a
->
func_id
 = func_id;

304 
m‘a
->
¬g1
 = *
»g1
;

305 
m‘a
->
¬g2
.
»g
 = *
»g2
;

308 
	}
}

311 
	$nå_bpf_check_ex™
(
nå_´og
 *nfp_prog,

312 
bpf_v”if›r_’v
 *
’v
)

314 cÚ¡ 
bpf_»g_¡©e
 *
»g0
 = 
	`cur_»gs
(
’v
è+ 
BPF_REG_0
;

315 
u64
 
imm
;

317 ià(
nå_´og
->
ty³
 =ð
BPF_PROG_TYPE_XDP
)

320 ià(!(
»g0
->
ty³
 =ð
SCALAR_VALUE
 && 
	`Šum_is_cÚ¡
Ôeg0->
v¬_off
))) {

321 
Š_buf
[48];

323 
	`Šum_¡º
(
Š_buf
, Ñn_buf), 
»g0
->
v¬_off
);

324 
	`´_vlog
(
’v
, "unsupportedƒxit state: %d, var_off: %s\n",

325 
»g0
->
ty³
, 
Š_buf
);

326  -
EINVAL
;

329 
imm
 = 
»g0
->
v¬_off
.
v®ue
;

330 ià(
nå_´og
->
ty³
 =ð
BPF_PROG_TYPE_SCHED_CLS
 &&

331 
imm
 <ð
TC_ACT_REDIRECT
 &&

332 
imm
 !ð
TC_ACT_SHOT
 && imm !ð
TC_ACT_STOLEN
 &&

333 
imm
 !ð
TC_ACT_QUEUED
) {

334 
	`´_vlog
(
’v
, "unsupportedƒxit state: %d, imm: %llx\n",

335 
»g0
->
ty³
, 
imm
);

336  -
EINVAL
;

340 
	}
}

343 
	$nå_bpf_check_¡ack_acûss
(
nå_´og
 *nfp_prog,

344 
nå_š¢_m‘a
 *
m‘a
,

345 cÚ¡ 
bpf_»g_¡©e
 *
»g
,

346 
bpf_v”if›r_’v
 *
’v
)

348 
s32
 
Þd_off
, 
Ãw_off
;

350 ià(
»g
->
äam’o
 !ð
’v
->
cur_¡©e
->
curäame
)

351 
m‘a
->
æags
 |ð
FLAG_INSN_PTR_CALLER_STACK_FRAME
;

353 ià(!
	`Šum_is_cÚ¡
(
»g
->
v¬_off
)) {

354 
	`´_vlog
(
’v
, "variable…tr stack‡ccess\n");

355  -
EINVAL
;

358 ià(
m‘a
->
±r
.
ty³
 =ð
NOT_INIT
)

361 
Þd_off
 = 
m‘a
->
±r
.
off
 + m‘a->±r.
v¬_off
.
v®ue
;

362 
Ãw_off
 = 
»g
->
off
 +„eg->
v¬_off
.
v®ue
;

364 
m‘a
->
±r_nÙ_cÚ¡
 |ð
Þd_off
 !ð
Ãw_off
;

366 ià(!
m‘a
->
±r_nÙ_cÚ¡
)

369 ià(
Þd_off
 % 4 =ð
Ãw_off
 % 4)

372 
	`´_vlog
(
’v
, "stack‡ccess changed†ocation was:%d is:%d\n",

373 
Þd_off
, 
Ãw_off
);

374  -
EINVAL
;

375 
	}
}

377 cÚ¡ *
	$nå_bpf_m­_u£_Çme
(
nå_bpf_m­_u£
 
u£
)

379 cÚ¡ * cÚ¡ 
Çmes
[] = {

380 [
NFP_MAP_UNUSED
] = "unused",

381 [
NFP_MAP_USE_READ
] = "read",

382 [
NFP_MAP_USE_WRITE
] = "write",

383 [
NFP_MAP_USE_ATOMIC_CNT
] = "atomic",

386 ià(
u£
 >ð
	`ARRAY_SIZE
(
Çmes
) || !names[use])

388  
Çmes
[
u£
];

389 
	}
}

392 
	$nå_bpf_m­_m¬k_u£d_Úe
(
bpf_v”if›r_’v
 *
’v
,

393 
nå_bpf_m­
 *
nå_m­
,

394 
off
, 
nå_bpf_m­_u£
 
u£
)

396 ià(
nå_m­
->
u£_m­
[
off
 / 4].
ty³
 !ð
NFP_MAP_UNUSED
 &&

397 
nå_m­
->
u£_m­
[
off
 / 4].
ty³
 !ð
u£
) {

398 
	`´_vlog
(
’v
, "map value useype conflict %s vs %s off: %u\n",

399 
	`nå_bpf_m­_u£_Çme
(
nå_m­
->
u£_m­
[
off
 / 4].
ty³
),

400 
	`nå_bpf_m­_u£_Çme
(
u£
), 
off
);

401  -
EOPNOTSUPP
;

404 ià(
nå_m­
->
u£_m­
[
off
 / 4].
nÚ_z”o_upd©e
 &&

405 
u£
 =ð
NFP_MAP_USE_ATOMIC_CNT
) {

406 
	`´_vlog
(
’v
, "atomic counter in map value may‡lready be initializedo‚on-zero value off: %u\n",

407 
off
);

408  -
EOPNOTSUPP
;

411 
nå_m­
->
u£_m­
[
off
 / 4].
ty³
 = 
u£
;

414 
	}
}

417 
	$nå_bpf_m­_m¬k_u£d
(
bpf_v”if›r_’v
 *
’v
, 
nå_š¢_m‘a
 *
m‘a
,

418 cÚ¡ 
bpf_»g_¡©e
 *
»g
,

419 
nå_bpf_m­_u£
 
u£
)

421 
bpf_ofæßded_m­
 *
offm­
;

422 
nå_bpf_m­
 *
nå_m­
;

423 
size
, 
off
;

424 
i
, 
”r
;

426 ià(!
	`Šum_is_cÚ¡
(
»g
->
v¬_off
)) {

427 
	`´_vlog
(
’v
, "map value offset is variable\n");

428  -
EOPNOTSUPP
;

431 
off
 = 
»g
->
v¬_off
.
v®ue
 + 
m‘a
->
š¢
.off +„eg->off;

432 
size
 = 
	`BPF_LDST_BYTES
(&
m‘a
->
š¢
);

433 
offm­
 = 
	`m­_to_offm­
(
»g
->
m­_±r
);

434 
nå_m­
 = 
offm­
->
dev_´iv
;

436 ià(
off
 + 
size
 > 
offm­
->
m­
.
v®ue_size
) {

437 
	`´_vlog
(
’v
, "map value‡ccess out-of-bounds\n");

438  -
EINVAL
;

441 
i
 = 0; i < 
size
; i +ð4 - (
off
 + i) % 4) {

442 
”r
 = 
	`nå_bpf_m­_m¬k_u£d_Úe
(
’v
, 
nå_m­
, 
off
 + 
i
, 
u£
);

443 ià(
”r
)

444  
”r
;

448 
	}
}

451 
	$nå_bpf_check_±r
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

452 
bpf_v”if›r_’v
 *
’v
, 
u8
 
»g_no
)

454 cÚ¡ 
bpf_»g_¡©e
 *
»g
 = 
	`cur_»gs
(
’v
è+ 
»g_no
;

455 
”r
;

457 ià(
»g
->
ty³
 !ð
PTR_TO_CTX
 &&

458 
»g
->
ty³
 !ð
PTR_TO_STACK
 &&

459 
»g
->
ty³
 !ð
PTR_TO_MAP_VALUE
 &&

460 
»g
->
ty³
 !ð
PTR_TO_PACKET
) {

461 
	`´_vlog
(
’v
, "unsuµÜ‹d…Œy³: %d\n", 
»g
->
ty³
);

462  -
EINVAL
;

465 ià(
»g
->
ty³
 =ð
PTR_TO_STACK
) {

466 
”r
 = 
	`nå_bpf_check_¡ack_acûss
(
nå_´og
, 
m‘a
, 
»g
, 
’v
);

467 ià(
”r
)

468  
”r
;

471 ià(
»g
->
ty³
 =ð
PTR_TO_MAP_VALUE
) {

472 ià(
	`is_mbpf_lßd
(
m‘a
)) {

473 
”r
 = 
	`nå_bpf_m­_m¬k_u£d
(
’v
, 
m‘a
, 
»g
,

474 
NFP_MAP_USE_READ
);

475 ià(
”r
)

476  
”r
;

478 ià(
	`is_mbpf_¡Üe
(
m‘a
)) {

479 
	`´_vlog
(
’v
, "map writes‚ot supported\n");

480  -
EOPNOTSUPP
;

482 ià(
	`is_mbpf_xadd
(
m‘a
)) {

483 
”r
 = 
	`nå_bpf_m­_m¬k_u£d
(
’v
, 
m‘a
, 
»g
,

484 
NFP_MAP_USE_ATOMIC_CNT
);

485 ià(
”r
)

486  
”r
;

490 ià(
m‘a
->
±r
.
ty³
 !ð
NOT_INIT
 && m‘a->±r.ty³ !ð
»g
->type) {

491 
	`´_vlog
(
’v
, "ptrype changed for instruction %d -> %d\n",

492 
m‘a
->
±r
.
ty³
, 
»g
->type);

493  -
EINVAL
;

496 
m‘a
->
±r
 = *
»g
;

499 
	}
}

502 
	$nå_bpf_check_¡Üe
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

503 
bpf_v”if›r_’v
 *
’v
)

505 cÚ¡ 
bpf_»g_¡©e
 *
»g
 = 
	`cur_»gs
(
’v
è+ 
m‘a
->
š¢
.
d¡_»g
;

507 ià(
»g
->
ty³
 =ð
PTR_TO_CTX
) {

508 ià(
nå_´og
->
ty³
 =ð
BPF_PROG_TYPE_XDP
) {

510 
m‘a
->
š¢
.
off
) {

511 
	`off£tof
(
xdp_md
, 
rx_queue_šdex
):

512 ià(
nå_´og
->
bpf
->
queue_£Ëù
)

513 
ex™_check_±r
;

514 
	`´_vlog
(
’v
, "queue selection‚ot supported by FW\n");

515  -
EOPNOTSUPP
;

518 
	`´_vlog
(
’v
, "unsupported storeo context field\n");

519  -
EOPNOTSUPP
;

521 
ex™_check_±r
:

522  
	`nå_bpf_check_±r
(
nå_´og
, 
m‘a
, 
’v
, m‘a->
š¢
.
d¡_»g
);

523 
	}
}

526 
	$nå_bpf_check_xadd
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

527 
bpf_v”if›r_’v
 *
’v
)

529 cÚ¡ 
bpf_»g_¡©e
 *
¤eg
 = 
	`cur_»gs
(
’v
è+ 
m‘a
->
š¢
.
¤c_»g
;

530 cÚ¡ 
bpf_»g_¡©e
 *
d»g
 = 
	`cur_»gs
(
’v
è+ 
m‘a
->
š¢
.
d¡_»g
;

532 ià(
d»g
->
ty³
 !ð
PTR_TO_MAP_VALUE
) {

533 
	`´_vlog
(
’v
, "atomic‡dd‚oto‡ map value…ointer: %d\n",

534 
d»g
->
ty³
);

535  -
EOPNOTSUPP
;

537 ià(
¤eg
->
ty³
 !ð
SCALAR_VALUE
) {

538 
	`´_vlog
(
’v
, "©omiøadd‚Ù oà¨sÿÏr: %d\n", 
¤eg
->
ty³
);

539  -
EOPNOTSUPP
;

542 
m‘a
->
xadd_ov”_16b™
 |=

543 
¤eg
->
v¬_off
.
v®ue
 > 0xfffà|| s»g->v¬_off.
mask
 > 0xffff;

544 
m‘a
->
xadd_maybe_16b™
 |=

545 (
¤eg
->
v¬_off
.
v®ue
 & ~¤eg->v¬_off.
mask
) <= 0xffff;

547  
	`nå_bpf_check_±r
(
nå_´og
, 
m‘a
, 
’v
, m‘a->
š¢
.
d¡_»g
);

548 
	}
}

551 
	$nå_bpf_check_®u
(
nå_´og
 *nå_´og, 
nå_š¢_m‘a
 *
m‘a
,

552 
bpf_v”if›r_’v
 *
’v
)

554 cÚ¡ 
bpf_»g_¡©e
 *
¤eg
 =

555 
	`cur_»gs
(
’v
è+ 
m‘a
->
š¢
.
¤c_»g
;

556 cÚ¡ 
bpf_»g_¡©e
 *
d»g
 =

557 
	`cur_»gs
(
’v
è+ 
m‘a
->
š¢
.
d¡_»g
;

559 
m‘a
->
umš_¤c
 = 
	`mš
(m‘a->umš_¤c, 
¤eg
->
umš_v®ue
);

560 
m‘a
->
umax_¤c
 = 
	`max
(m‘a->umax_¤c, 
¤eg
->
umax_v®ue
);

561 
m‘a
->
umš_d¡
 = 
	`mš
(m‘a->umš_d¡, 
d»g
->
umš_v®ue
);

562 
m‘a
->
umax_d¡
 = 
	`max
(m‘a->umax_d¡, 
d»g
->
umax_v®ue
);

576 ià(
	`is_mbpf_mul
(
m‘a
)) {

577 ià(
m‘a
->
umax_d¡
 > 
U32_MAX
) {

578 
	`´_vlog
(
’v
, "multiplier is‚ot within u32 value„ange\n");

579  -
EINVAL
;

581 ià(
	`mbpf_¤c
(
m‘a
è=ð
BPF_X
 && m‘a->
umax_¤c
 > 
U32_MAX
) {

582 
	`´_vlog
(
’v
, "multiplicand is‚ot within u32 value„ange\n");

583  -
EINVAL
;

585 ià(
	`mbpf_þass
(
m‘a
è=ð
BPF_ALU64
 &&

586 
	`mbpf_¤c
(
m‘a
è=ð
BPF_K
 && m‘a->
š¢
.
imm
 < 0) {

587 
	`´_vlog
(
’v
, "signƒxtended multiplicand won't be within u32 value„ange\n");

588  -
EINVAL
;

602 ià(
	`is_mbpf_div
(
m‘a
)) {

603 ià(
m‘a
->
umax_d¡
 > 
U32_MAX
) {

604 
	`´_vlog
(
’v
, "dividend is‚ot within u32 value„ange\n");

605  -
EINVAL
;

607 ià(
	`mbpf_¤c
(
m‘a
è=ð
BPF_X
) {

608 ià(
m‘a
->
umš_¤c
 !ðm‘a->
umax_¤c
) {

609 
	`´_vlog
(
’v
, "divisor is‚ot constant\n");

610  -
EINVAL
;

612 ià(
m‘a
->
umax_¤c
 > 
U32_MAX
) {

613 
	`´_vlog
(
’v
, "divisor is‚ot within u32 value„ange\n");

614  -
EINVAL
;

617 ià(
	`mbpf_¤c
(
m‘a
è=ð
BPF_K
 && m‘a->
š¢
.
imm
 < 0) {

618 
	`´_vlog
(
’v
, "divide by‚egative constant is‚ot supported\n");

619  -
EINVAL
;

624 
	}
}

626 
	$nå_v”ify_š¢
(
bpf_v”if›r_’v
 *
’v
, 
š¢_idx
,

627 
´ev_š¢_idx
)

629 
nå_´og
 *nå_´og = 
’v
->
´og
->
aux
->
ofæßd
->
dev_´iv
;

630 
nå_š¢_m‘a
 *
m‘a
 = 
nå_´og
->
v”if›r_m‘a
;

632 
m‘a
 = 
	`nå_bpf_gÙo_m‘a
(
nå_´og
, m‘a, 
š¢_idx
);

633 
nå_´og
->
v”if›r_m‘a
 = 
m‘a
;

635 ià(!
	`nå_bpf_suµÜ‹d_Ýcode
(
m‘a
->
š¢
.
code
)) {

636 
	`´_vlog
(
’v
, "instruction %#02x‚ot supported\n",

637 
m‘a
->
š¢
.
code
);

638  -
EINVAL
;

641 ià(
m‘a
->
š¢
.
¤c_»g
 >ð
MAX_BPF_REG
 ||

642 
m‘a
->
š¢
.
d¡_»g
 >ð
MAX_BPF_REG
) {

643 
	`´_vlog
(
’v
, "program usesƒxtended„egisters - jit hardening?\n");

644  -
EINVAL
;

647 ià(
	`is_mbpf_h–³r_ÿÎ
(
m‘a
))

648  
	`nå_bpf_check_h–³r_ÿÎ
(
nå_´og
, 
’v
, 
m‘a
);

649 ià(
m‘a
->
š¢
.
code
 =ð(
BPF_JMP
 | 
BPF_EXIT
))

650  
	`nå_bpf_check_ex™
(
nå_´og
, 
’v
);

652 ià(
	`is_mbpf_lßd
(
m‘a
))

653  
	`nå_bpf_check_±r
(
nå_´og
, 
m‘a
, 
’v
,

654 
m‘a
->
š¢
.
¤c_»g
);

655 ià(
	`is_mbpf_¡Üe
(
m‘a
))

656  
	`nå_bpf_check_¡Üe
(
nå_´og
, 
m‘a
, 
’v
);

658 ià(
	`is_mbpf_xadd
(
m‘a
))

659  
	`nå_bpf_check_xadd
(
nå_´og
, 
m‘a
, 
’v
);

661 ià(
	`is_mbpf_®u
(
m‘a
))

662  
	`nå_bpf_check_®u
(
nå_´og
, 
m‘a
, 
’v
);

665 
	}
}

667 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 20, 0)

669 
	$nå_assign_sub´og_idx_ªd_»gs
(
bpf_v”if›r_’v
 *
’v
,

670 
nå_´og
 *nfp_prog)

672 
nå_š¢_m‘a
 *
m‘a
;

673 
šdex
 = 0;

675 
	`li¡_fÜ_—ch_’Œy
(
m‘a
, &
nå_´og
->
š¢s
, 
l
) {

676 ià(
	`nå_is_sub´og_¡¬t
(
m‘a
))

677 
šdex
++;

678 
m‘a
->
sub´og_idx
 = 
šdex
;

680 ià(
m‘a
->
š¢
.
d¡_»g
 >ð
BPF_REG_6
 &&

681 
m‘a
->
š¢
.
d¡_»g
 <ð
BPF_REG_9
)

682 
nå_´og
->
sub´og
[
šdex
].
Ãeds_»g_push
 = 1;

685 ià(
šdex
 + 1 !ð
nå_´og
->
sub´og_út
) {

686 
	`´_vlog
(
’v
, "BUG:‚umber of…rocessed BPF functions is‚ot consistent (processed %d,ƒxpected %d)\n",

687 
šdex
 + 1, 
nå_´og
->
sub´og_út
);

688  -
EFAULT
;

692 
	}
}

694 
	$nå_bpf_g‘_¡ack_u§ge
(
nå_´og
 *nfp_prog)

696 
nå_š¢_m‘a
 *
m‘a
 = 
	`nå_´og_fœ¡_m‘a
(
nå_´og
);

697 
max_d•th
 = 0, 
d•th
 = 0, 
äame
 = 0;

698 
nå_š¢_m‘a
 *
»t_š¢
[
MAX_CALL_FRAMES
];

699 
äame_d•ths
[
MAX_CALL_FRAMES
];

700 
»t_´og
[
MAX_CALL_FRAMES
];

701 
idx
 = 
m‘a
->
sub´og_idx
;

709 
´oûss_sub´og
:

710 
äame_d•ths
[
äame
] = 
nå_´og
->
sub´og
[
idx
].
¡ack_d•th
;

711 
äame_d•ths
[
äame
] = 
	`round_up
(äame_d•ths[äame], 
STACK_FRAME_ALIGN
);

712 
d•th
 +ð
äame_d•ths
[
äame
];

713 
max_d•th
 = 
	`max
(max_d•th, 
d•th
);

715 
cÚtšue_sub´og
:

716 ; 
m‘a
 !ð
	`nå_´og_Ï¡_m‘a
(
nå_´og
è&& m‘a->
sub´og_idx
 =ð
idx
;

717 
m‘a
 = 
	`nå_m‘a_Ãxt
(meta)) {

718 ià(!
	`is_mbpf_p£udo_ÿÎ
(
m‘a
))

724 
»t_š¢
[
äame
] = 
	`nå_m‘a_Ãxt
(
m‘a
);

725 
»t_´og
[
äame
] = 
idx
;

728 
m‘a
 = 
	`nå_bpf_gÙo_m‘a
(
nå_´og
, meta,

729 
m‘a
->
n
 + 1 + m‘a->
š¢
.
imm
);

730 
idx
 = 
m‘a
->
sub´og_idx
;

731 
äame
++;

732 
´oûss_sub´og
;

738 ià(
äame
 == 0)

739  
max_d•th
;

741 
d•th
 -ð
äame_d•ths
[
äame
];

742 
äame
--;

743 
m‘a
 = 
»t_š¢
[
äame
];

744 
idx
 = 
»t_´og
[
äame
];

745 
cÚtšue_sub´og
;

746 
	}
}

748 
	$nå_bpf_fš®ize
(
bpf_v”if›r_’v
 *
’v
)

750 
bpf_sub´og_šfo
 *
šfo
;

751 
nå_´og
 *nfp_prog;

752 
max_¡ack
;

753 
nå_Ãt
 *
Â
;

754 
i
;

756 
nå_´og
 = 
’v
->
´og
->
aux
->
ofæßd
->
dev_´iv
;

757 
nå_´og
->
sub´og_út
 = 
’v
->subprog_cnt;

758 
nå_´og
->
sub´og
 = 
	`kÿÎoc
Òå_´og->
sub´og_út
,

759 (
nå_´og
->
sub´og
[0]), 
GFP_KERNEL
);

760 ià(!
nå_´og
->
sub´og
)

761  -
ENOMEM
;

763 
	`nå_assign_sub´og_idx_ªd_»gs
(
’v
, 
nå_´og
);

765 
šfo
 = 
’v
->
sub´og_šfo
;

766 
i
 = 0; i < 
nå_´og
->
sub´og_út
; i++) {

767 
nå_´og
->
sub´og
[
i
].
¡ack_d•th
 = 
šfo
[i].stack_depth;

769 ià(
i
 == 0)

773 
nå_´og
->
sub´og
[
i
].
¡ack_d•th
 +ð
REG_WIDTH
;

775 ià(
nå_´og
->
sub´og
[
i
].
Ãeds_»g_push
)

776 
nå_´og
->
sub´og
[
i
].
¡ack_d•th
 +ð
BPF_REG_SIZE
 * 4;

779 
Â
 = 
	`Ãtdev_´iv
(
’v
->
´og
->
aux
->
ofæßd
->
Ãtdev
);

780 
max_¡ack
 = 
	`Â_»adb
(
Â
, 
NFP_NET_CFG_BPF_STACK_SZ
) * 64;

781 
nå_´og
->
¡ack_size
 = 
	`nå_bpf_g‘_¡ack_u§ge
(nfp_prog);

782 ià(
nå_´og
->
¡ack_size
 > 
max_¡ack
) {

783 
	`´_vlog
(
’v
, "stackoo†arge:…rogram %dB > FW stack %dB\n",

784 
nå_´og
->
¡ack_size
, 
max_¡ack
);

785  -
EOPNOTSUPP
;

789 
	}
}

792 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

793 
	$nå_bpf_Ýt_»¶aû_š¢
(
bpf_v”if›r_’v
 *
’v
, 
u32
 
off
,

794 
bpf_š¢
 *
š¢
)

796 
nå_´og
 *nå_´og = 
’v
->
´og
->
aux
->
ofæßd
->
dev_´iv
;

797 
bpf_š¢_aux_d©a
 *
aux_d©a
 = 
’v
->
š¢_aux_d©a
;

798 
nå_š¢_m‘a
 *
m‘a
 = 
nå_´og
->
v”if›r_m‘a
;

800 
m‘a
 = 
	`nå_bpf_gÙo_m‘a
(
nå_´og
, m‘a, 
aux_d©a
[
off
].
Üig_idx
);

801 
nå_´og
->
v”if›r_m‘a
 = 
m‘a
;

804 ià(
	`is_mbpf_cÚd_jump
(
m‘a
) &&

805 
š¢
->
code
 =ð(
BPF_JMP
 | 
BPF_JA
 | 
BPF_K
)) {

806 
tgt_off
;

808 
tgt_off
 = 
off
 + 
š¢
->off + 1;

810 ià(!
š¢
->
off
) {

811 
m‘a
->
jmp_d¡
 = 
	`li¡_Ãxt_’Œy
(m‘a, 
l
);

812 
m‘a
->
jump_Ãg_Ý
 = 
çl£
;

813 } ià(
m‘a
->
jmp_d¡
->
n
 !ð
aux_d©a
[
tgt_off
].
Üig_idx
) {

814 
	`´_vlog
(
’v
, "branch hard wire‡t %d changesarget %d -> %d\n",

815 
off
, 
m‘a
->
jmp_d¡
->
n
,

816 
aux_d©a
[
tgt_off
].
Üig_idx
);

817  -
EINVAL
;

822 
	`´_vlog
(
’v
, "unsupported instruction„eplacement %hhx -> %hhx\n",

823 
m‘a
->
š¢
.
code
, insn->code);

824  -
EINVAL
;

825 
	}
}

827 
	$nå_bpf_Ýt_»move_š¢s
(
bpf_v”if›r_’v
 *
’v
, 
u32
 
off
, u32 
út
)

829 
nå_´og
 *nå_´og = 
’v
->
´og
->
aux
->
ofæßd
->
dev_´iv
;

830 
bpf_š¢_aux_d©a
 *
aux_d©a
 = 
’v
->
š¢_aux_d©a
;

831 
nå_š¢_m‘a
 *
m‘a
 = 
nå_´og
->
v”if›r_m‘a
;

832 
i
;

834 
m‘a
 = 
	`nå_bpf_gÙo_m‘a
(
nå_´og
, m‘a, 
aux_d©a
[
off
].
Üig_idx
);

836 
i
 = 0; i < 
út
; i++) {

837 ià(
	`WARN_ON_ONCE
(&
m‘a
->
l
 =ð&
nå_´og
->
š¢s
))

838  -
EINVAL
;

841 ià(
m‘a
->
æags
 & 
FLAG_INSN_SKIP_VERIFIER_OPT
)

842 
i
--;

844 
m‘a
->
æags
 |ð
FLAG_INSN_SKIP_VERIFIER_OPT
;

845 
m‘a
 = 
	`li¡_Ãxt_’Œy
(m‘a, 
l
);

849 
	}
}

	@src/flower/action.c

4 
	~"../nå_Ãt_com·t.h
"

6 
	~<lšux/b™f›ld.h
>

7 
	~<Ãt/pkt_þs.h
>

8 
	~<Ãt/tc_aù/tc_csum.h
>

9 
	~<Ãt/tc_aù/tc_gaù.h
>

10 
	~<Ãt/tc_aù/tc_mœ»d.h
>

11 
	~<Ãt/tc_aù/tc_³d™.h
>

12 
	~<Ãt/tc_aù/tc_vÏn.h
>

13 
	~<Ãt/tc_aù/tc_tuÂ–_key.h
>

15 
	~"cmsg.h
"

16 
	~"maš.h
"

17 
	~"../nå_Ãt_»´.h
"

22 
	#NFP_FL_TUNNEL_CSUM
 
	`ýu_to_be16
(0x01)

	)

23 
	#NFP_FL_TUNNEL_KEY
 
	`ýu_to_be16
(0x04)

	)

24 
	#NFP_FL_TUNNEL_GENEVE_OPT
 
	`ýu_to_be16
(0x0800)

	)

25 
	#NFP_FL_SUPPORTED_TUNNEL_INFO_FLAGS
 
IP_TUNNEL_INFO_TX


	)

26 
	#NFP_FL_SUPPORTED_IPV4_UDP_TUN_FLAGS
 (
NFP_FL_TUNNEL_CSUM
 | \

27 
NFP_FL_TUNNEL_KEY
 | \

28 
NFP_FL_TUNNEL_GENEVE_OPT
)

	)

30 
	$nå_æ_pÝ_vÏn
(
nå_æ_pÝ_vÏn
 *
pÝ_vÏn
)

32 
size_t
 
aù_size
 = (
nå_æ_pÝ_vÏn
);

34 
pÝ_vÏn
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_POP_VLAN
;

35 
pÝ_vÏn
->
h—d
.
Ën_lw
 = 
aù_size
 >> 
NFP_FL_LW_SIZ
;

36 
pÝ_vÏn
->
»£rved
 = 0;

37 
	}
}

40 
nå_æ_push_vÏn
(nå_æ_push_vÏÀ*
push_vÏn
,

41 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

42 cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

44 cÚ¡ 
tc_aùiÚ
 *
	gaù
)

47 
size_t
 
	gaù_size
 = (
nå_æ_push_vÏn
);

48 
u16
 
	gtmp_push_vÏn_tci
;

50 
	gpush_vÏn
->
	gh—d
.
	gjump_id
 = 
NFP_FL_ACTION_OPCODE_PUSH_VLAN
;

51 
	gpush_vÏn
->
	gh—d
.
	gËn_lw
 = 
aù_size
 >> 
NFP_FL_LW_SIZ
;

52 
	gpush_vÏn
->
	g»£rved
 = 0;

53 
	gpush_vÏn
->
	gvÏn_id
 = 
com·t__tÿ_vÏn_push_´Ùo
(
aù
);

55 
	gtmp_push_vÏn_tci
 =

56 
FIELD_PREP
(
NFP_FL_PUSH_VLAN_PRIO
,

57 
com·t__tÿ_vÏn_push_´io
(
aù
)) |

58 
FIELD_PREP
(
NFP_FL_PUSH_VLAN_VID
,

59 
com·t__tÿ_vÏn_push_vid
(
aù
));

60 
	gpush_vÏn
->
	gvÏn_tci
 = 
ýu_to_be16
(
tmp_push_vÏn_tci
);

64 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

65 
nå_æ_´e_Ïg
(
nå_­p
 *
­p
, cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
,

67 
nå_æ_´e_Ïg
(
nå_­p
 *
­p
, cÚ¡ 
tc_aùiÚ
 *
aù
,

69 
nå_æ_·ylßd
 *
nå_æow
, 
aù_Ën
)

71 
size_t
 
aù_size
 = (
nå_æ_´e_Ïg
);

72 
nå_æ_´e_Ïg
 *
´e_Ïg
;

73 
Ãt_deviû
 *
out_dev
;

74 
”r
;

76 
out_dev
 = 
com·t__tÿ_mœ»d_dev
(
aù
);

77 ià(!
out_dev
 || !
Ãtif_is_Ïg_ma¡”
(out_dev))

80 ià(
aù_Ën
 + 
aù_size
 > 
NFP_FL_MAX_A_SIZ
)

81  -
EOPNOTSUPP
;

86 ià(
aù_Ën
)

87 
memmove
(
nå_æow
->
aùiÚ_d©a
 + 
aù_size
,

88 
nå_æow
->
aùiÚ_d©a
, 
aù_Ën
);

90 
´e_Ïg
 = (
nå_æ_´e_Ïg
 *)
nå_æow
->
aùiÚ_d©a
;

91 
”r
 = 
nå_æow”_Ïg_pÝuÏ‹_´e_aùiÚ
(
­p
, 
out_dev
, 
´e_Ïg
);

92 ià(
”r
)

93  
”r
;

95 
´e_Ïg
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_PRE_LAG
;

96 
´e_Ïg
->
h—d
.
Ën_lw
 = 
aù_size
 >> 
NFP_FL_LW_SIZ
;

98 
nå_æow
->
m‘a
.
shÜtcut
 = 
ýu_to_be32
(
NFP_FL_SC_ACT_NULL
);

100  
aù_size
;

104 
nå_æ_ouut
(
nå_­p
 *
­p
, nå_æ_ouuˆ*
ouut
,

105 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

106 cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
,

108 cÚ¡ 
tc_aùiÚ
 *
aù
,

110 
nå_æ_·ylßd
 *
nå_æow
,

111 
boÞ
 
Ï¡
, 
Ãt_deviû
 *
š_dev
,

112 
nå_æow”_tun_ty³
 
tun_ty³
, *
tun_out_út
)

114 
size_t
 
aù_size
 = (
nå_æ_ouut
);

115 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

116 
Ãt_deviû
 *
out_dev
;

117 
u16
 
tmp_æags
;

119 
ouut
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_OUTPUT
;

120 
ouut
->
h—d
.
Ën_lw
 = 
aù_size
 >> 
NFP_FL_LW_SIZ
;

122 
out_dev
 = 
com·t__tÿ_mœ»d_dev
(
aù
);

123 ià(!
out_dev
)

124  -
EOPNOTSUPP
;

126 
tmp_æags
 = 
Ï¡
 ? 
NFP_FL_OUT_FLAGS_LAST
 : 0;

128 ià(
tun_ty³
) {

130 ià(!
nå_æ_Ãtdev_is_tuÂ–_ty³
(
out_dev
, 
tun_ty³
))

131  -
EOPNOTSUPP
;

133 ià(*
tun_out_út
)

134  -
EOPNOTSUPP
;

135 (*
tun_out_út
)++;

137 
ouut
->
æags
 = 
ýu_to_be16
(
tmp_æags
 |

138 
NFP_FL_OUT_FLAGS_USE_TUN
);

139 
ouut
->
pÜt
 = 
ýu_to_be32
(
NFP_FL_PORT_TYPE_TUN
 | 
tun_ty³
);

140 } ià(
Ãtif_is_Ïg_ma¡”
(
out_dev
) &&

141 
´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_LAG
) {

142 
gid
;

144 
ouut
->
æags
 = 
ýu_to_be16
(
tmp_æags
);

145 
gid
 = 
nå_æow”_Ïg_g‘_ouut_id
(
­p
, 
out_dev
);

146 ià(
gid
 < 0)

147  
gid
;

148 
ouut
->
pÜt
 = 
ýu_to_be32
(
NFP_FL_LAG_OUT
 | 
gid
);

151 
ouut
->
æags
 = 
ýu_to_be16
(
tmp_æags
);

153 ià(
nå_Ãtdev_is_nå_»´
(
š_dev
)) {

155 ià(!
Ãtdev_pÜt_§me_·»Á_id
(
š_dev
, 
out_dev
))

156  -
EOPNOTSUPP
;

159 ià(!
nå_Ãtdev_is_nå_»´
(
out_dev
))

160  -
EOPNOTSUPP
;

162 
ouut
->
pÜt
 = 
ýu_to_be32
(
nå_»´_g‘_pÜt_id
(
out_dev
));

163 ià(!
ouut
->
pÜt
)

164  -
EOPNOTSUPP
;

166 
nå_æow
->
m‘a
.
shÜtcut
 = 
ouut
->
pÜt
;

171 
nå_æow”_tun_ty³


172 
nå_æ_g‘_tun_äom_aù_l4_pÜt
(
nå_­p
 *
­p
,

173 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

174 cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

176 cÚ¡ 
tc_aùiÚ
 *
aù
)

179 
_tuÂ–_šfo
 *
	gtun
 = 
com·t__tÿ_tun_šfo
(
aù
);

180 
nå_æow”_´iv
 *
	g´iv
 = 
­p
->
´iv
;

182 
	gtun
->
	gkey
.
	g_d¡
) {

183 
htÚs
(
IANA_VXLAN_UDP_PORT
):

184  
NFP_FL_TUNNEL_VXLAN
;

185 
htÚs
(
GENEVE_UDP_PORT
):

186 ià(
´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_GENEVE
)

187  
NFP_FL_TUNNEL_GENEVE
;

190  
NFP_FL_TUNNEL_NONE
;

194 
nå_æ_´e_tuÂ–
 *
	$nå_æ_´e_tuÂ–
(*
aù_d©a
, 
aù_Ën
)

196 
size_t
 
aù_size
 = (
nå_æ_´e_tuÂ–
);

197 
nå_æ_´e_tuÂ–
 *
´e_tun_aù
;

202 ià(
aù_Ën
)

203 
	`memmove
(
aù_d©a
 + 
aù_size
,‡ù_d©a, 
aù_Ën
);

205 
´e_tun_aù
 = (
nå_æ_´e_tuÂ–
 *)
aù_d©a
;

207 
	`mem£t
(
´e_tun_aù
, 0, 
aù_size
);

209 
´e_tun_aù
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_PRE_TUNNEL
;

210 
´e_tun_aù
->
h—d
.
Ën_lw
 = 
aù_size
 >> 
NFP_FL_LW_SIZ
;

212  
´e_tun_aù
;

213 
	}
}

216 
nå_æ_push_g’eve_ÝtiÚs
(
nå_æ_·ylßd
 *
nå_æ
, *
li¡_Ën
,

217 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

218 cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

220 cÚ¡ 
tc_aùiÚ
 *
	gaù
)

223 
_tuÂ–_šfo
 *
	g_tun
 = 
com·t__tÿ_tun_šfo
(
aù
);

224 
	gÝt_Ën
, 
	gÝt_út
, 
	gaù_¡¬t
, 
	gtÙ_push_Ën
;

225 
u8
 *
	g¤c
 = 
_tuÂ–_šfo_Ýts
(
_tun
);

232 
	gÝt_út
 = 0;

233 
	gtÙ_push_Ën
 = 0;

234 
	gÝt_Ën
 = 
_tun
->
ÝtiÚs_Ën
;

235 
	gÝt_Ën
 > 0) {

236 
g’eve_Ýt
 *
	gÝt
 = (g’eve_Ýˆ*)
¤c
;

238 
	gÝt_út
++;

239 ià(
	gÝt_út
 > 
	gNFP_FL_MAX_GENEVE_OPT_CNT
)

240  -
	gEOPNOTSUPP
;

242 
	gtÙ_push_Ën
 +ð(
nå_æ_push_g’eve
) +

243 
Ýt
->
Ëngth
 * 4;

244 ià(
	gtÙ_push_Ën
 > 
	gNFP_FL_MAX_GENEVE_OPT_ACT
)

245  -
	gEOPNOTSUPP
;

247 
	gÝt_Ën
 -ð(
g’eve_Ýt
è+ 
Ýt
->
Ëngth
 * 4;

248 
	g¤c
 +ð(
g’eve_Ýt
è+ 
Ýt
->
Ëngth
 * 4;

251 ià(*
	gli¡_Ën
 + 
	gtÙ_push_Ën
 > 
	gNFP_FL_MAX_A_SIZ
)

252  -
	gEOPNOTSUPP
;

254 
	gaù_¡¬t
 = *
li¡_Ën
;

255 *
	gli¡_Ën
 +ð
tÙ_push_Ën
;

256 
	g¤c
 = 
_tuÂ–_šfo_Ýts
(
_tun
);

257 
	gÝt_út
) {

258 
g’eve_Ýt
 *
	gÝt
 = (g’eve_Ýˆ*)
¤c
;

259 
nå_æ_push_g’eve
 *
	gpush
;

260 
size_t
 
	gaù_size
, 
	gËn
;

262 
	gÝt_út
--;

263 
	gaù_size
 = (
nå_æ_push_g’eve
è+ 
Ýt
->
Ëngth
 * 4;

264 
	gtÙ_push_Ën
 -ð
aù_size
;

265 
	gËn
 = 
aù_¡¬t
 + 
tÙ_push_Ën
;

267 
	gpush
 = (
nå_æ_push_g’eve
 *)&
nå_æ
->
aùiÚ_d©a
[
Ën
];

268 
	gpush
->
	gh—d
.
	gjump_id
 = 
NFP_FL_ACTION_OPCODE_PUSH_GENEVE
;

269 
	gpush
->
	gh—d
.
	gËn_lw
 = 
aù_size
 >> 
NFP_FL_LW_SIZ
;

270 
	gpush
->
	g»£rved
 = 0;

271 
	gpush
->
	gþass
 = 
Ýt
->
Ýt_þass
;

272 
	gpush
->
	gty³
 = 
Ýt
->
ty³
;

273 
	gpush
->
	gËngth
 = 
Ýt
->
Ëngth
;

274 
memýy
(&
push
->
Ýt_d©a
, 
Ýt
->Ýt_d©a, o±->
Ëngth
 * 4);

276 
	g¤c
 +ð(
g’eve_Ýt
è+ 
Ýt
->
Ëngth
 * 4;

283 
nå_æ_£t_v4_udp_tun
(
nå_­p
 *
­p
,

284 
nå_æ_£t_v4_udp_tun
 *
£t_tun
,

285 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

286 cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
,

288 cÚ¡ 
tc_aùiÚ
 *
aù
,

290 
nå_æ_´e_tuÂ–
 *
´e_tun
,

291 
nå_æow”_tun_ty³
 
tun_ty³
,

292 
Ãt_deviû
 *
Ãtdev
)

294 
size_t
 
	gaù_size
 = (
nå_æ_£t_v4_udp_tun
);

295 
_tuÂ–_šfo
 *
	g_tun
 = 
com·t__tÿ_tun_šfo
(
aù
);

296 
nå_æow”_´iv
 *
	g´iv
 = 
­p
->
´iv
;

297 
u32
 
	gtmp_£t__tun_ty³_šdex
 = 0;

299 
	g´‘un_idx
 = 0;

301 
BUILD_BUG_ON
(
NFP_FL_TUNNEL_CSUM
 !ð
TUNNEL_CSUM
 ||

302 
NFP_FL_TUNNEL_KEY
 !ð
TUNNEL_KEY
 ||

303 
NFP_FL_TUNNEL_GENEVE_OPT
 !ð
TUNNEL_GENEVE_OPT
);

304 ià(
	g_tun
->
	gÝtiÚs_Ën
 &&

305 (
	gtun_ty³
 !ð
NFP_FL_TUNNEL_GENEVE
 ||

306 !(
´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_GENEVE_OPT
)))

307  -
EOPNOTSUPP
;

309 
	g£t_tun
->
	gh—d
.
	gjump_id
 = 
NFP_FL_ACTION_OPCODE_SET_IPV4_TUNNEL
;

310 
	g£t_tun
->
	gh—d
.
	gËn_lw
 = 
aù_size
 >> 
NFP_FL_LW_SIZ
;

313 
	gtmp_£t__tun_ty³_šdex
 |=

314 
FIELD_PREP
(
NFP_FL_IPV4_TUNNEL_TYPE
, 
tun_ty³
) |

315 
FIELD_PREP
(
NFP_FL_IPV4_PRE_TUN_INDEX
, 
´‘un_idx
);

317 
	g£t_tun
->
	gtun_ty³_šdex
 = 
ýu_to_be32
(
tmp_£t__tun_ty³_šdex
);

318 
	g£t_tun
->
	gtun_id
 = 
_tun
->
key
.
tun_id
;

320 ià(
	g_tun
->
	gkey
.
	g‰l
) {

321 
	g£t_tun
->
	g‰l
 = 
_tun
->
key
.
‰l
;

323 
Ãt
 *
	gÃt
 = 
dev_Ãt
(
Ãtdev
);

324 
æowi4
 
	gæow
 = {};

325 
¹abË
 *
	g¹
;

326 
	g”r
;

332 
	gæow
.
	gdaddr
 = 
_tun
->
key
.
u
.
v4
.
d¡
;

333 
	gæow
.
	gæowi4_´Ùo
 = 
IPPROTO_UDP
;

334 
	g¹
 = 
_rou‹_ouut_key
(
Ãt
, &
æow
);

335 
	g”r
 = 
PTR_ERR_OR_ZERO
(
¹
);

336 ià(!
	g”r
) {

337 
	g£t_tun
->
	g‰l
 = 
4_d¡_hÝlim™
(&
¹
->
d¡
);

338 
_¹_put
(
¹
);

340 
	g£t_tun
->
	g‰l
 = 
Ãt
->
v4
.
sysùl__deçuÉ_‰l
;

344 
	g£t_tun
->
	gtos
 = 
_tun
->
key
.
tos
;

346 ià(!(
	g_tun
->
	gkey
.
	gtun_æags
 & 
	gNFP_FL_TUNNEL_KEY
) ||

347 
	g_tun
->
	gkey
.
	gtun_æags
 & ~
	gNFP_FL_SUPPORTED_IPV4_UDP_TUN_FLAGS
)

348  -
	gEOPNOTSUPP
;

349 
	g£t_tun
->
	gtun_æags
 = 
_tun
->
key
.
tun_æags
;

351 ià(
	gtun_ty³
 =ð
NFP_FL_TUNNEL_GENEVE
) {

352 
£t_tun
->
tun_´Ùo
 = 
htÚs
(
ETH_P_TEB
);

353 
	g£t_tun
->
	gtun_Ën
 = 
_tun
->
ÝtiÚs_Ën
 / 4;

357 
	g´e_tun
->
	gv4_d¡
 = 
_tun
->
key
.
u
.
v4
.
d¡
;

362 
	$nå_æ_£t_h–³r32
(
u32
 
v®ue
, u32 
mask
, 
u8
 *
p_exaù
, u8 *
p_mask
)

364 
u32
 
Þdv®ue
 = 
	`g‘_uÇligÃd
((u32 *)
p_exaù
);

365 
u32
 
Þdmask
 = 
	`g‘_uÇligÃd
((u32 *)
p_mask
);

367 
v®ue
 &ð
mask
;

368 
v®ue
 |ð
Þdv®ue
 & ~
mask
;

370 
	`put_uÇligÃd
(
Þdmask
 | 
mask
, (
u32
 *)
p_mask
);

371 
	`put_uÇligÃd
(
v®ue
, (
u32
 *)
p_exaù
);

372 
	}
}

375 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

376 
nå_æ_£t_‘h
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
, 
u32
 
off
,

378 
nå_æ_£t_‘h
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
, 
u32
 
off
,

380 
nå_æ_£t_‘h
 *
£t_‘h
)

382 
u32
 
exaù
, 
mask
;

384 ià(
off
 + 4 > 
ETH_ALEN
 * 2)

385  -
EOPNOTSUPP
;

387 
mask
 = ~
com·t__tÿ_³d™_mask
(
aù
, 
idx
);

388 
exaù
 = 
com·t__tÿ_³d™_v®
(
aù
, 
idx
);

390 ià(
exaù
 & ~
mask
)

391  -
EOPNOTSUPP
;

393 
nå_æ_£t_h–³r32
(
exaù
, 
mask
, &
£t_‘h
->
‘h_addr_v®
[
off
],

394 &
£t_‘h
->
‘h_addr_mask
[
off
]);

396 
£t_‘h
->
»£rved
 = 
ýu_to_be16
(0);

397 
£t_‘h
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_SET_ETHERNET
;

398 
£t_‘h
->
h—d
.
Ën_lw
 = (*£t_‘hè>> 
NFP_FL_LW_SIZ
;

403 
	sv4_‰l_wÜd
 {

404 
__u8
 
‰l
;

405 
__u8
 
´ÙocÞ
;

406 
__sum16
 
check
;

410 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

411 
nå_æ_£t_4
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
, 
u32
 
off
,

413 
nå_æ_£t_4
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
, 
u32
 
off
,

415 
nå_æ_£t_4_addrs
 *
£t__addr
,

416 
nå_æ_£t_4_‰l_tos
 *
£t__‰l_tos
)

418 
v4_‰l_wÜd
 *
‰l_wÜd_mask
;

419 
v4_‰l_wÜd
 *
‰l_wÜd
;

420 
hdr
 *
tos_wÜd_mask
;

421 
hdr
 *
tos_wÜd
;

422 
__be32
 
exaù
, 
mask
;

425 
mask
 = (
__fÜû
 
__be32
)~
com·t__tÿ_³d™_mask
(
aù
, 
idx
);

426 
exaù
 = (
__fÜû
 
__be32
)
com·t__tÿ_³d™_v®
(
aù
, 
idx
);

428 ià(
exaù
 & ~
mask
)

429  -
EOPNOTSUPP
;

431 
off
) {

432 
off£tof
(
hdr
, 
daddr
):

433 
£t__addr
->
v4_d¡_mask
 |ð
mask
;

434 
£t__addr
->
v4_d¡
 &ð~
mask
;

435 
£t__addr
->
v4_d¡
 |ð
exaù
 & 
mask
;

436 
£t__addr
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_SET_IPV4_ADDRS
;

437 
£t__addr
->
h—d
.
Ën_lw
 = (*set_ip_addr) >>

438 
NFP_FL_LW_SIZ
;

440 
off£tof
(
hdr
, 
§ddr
):

441 
£t__addr
->
v4_¤c_mask
 |ð
mask
;

442 
£t__addr
->
v4_¤c
 &ð~
mask
;

443 
£t__addr
->
v4_¤c
 |ð
exaù
 & 
mask
;

444 
£t__addr
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_SET_IPV4_ADDRS
;

445 
£t__addr
->
h—d
.
Ën_lw
 = (*set_ip_addr) >>

446 
NFP_FL_LW_SIZ
;

448 
off£tof
(
hdr
, 
‰l
):

449 
‰l_wÜd_mask
 = (
v4_‰l_wÜd
 *)&
mask
;

450 
‰l_wÜd
 = (
v4_‰l_wÜd
 *)&
exaù
;

452 ià(
‰l_wÜd_mask
->
´ÙocÞ
 ||Ž_wÜd_mask->
check
)

453  -
EOPNOTSUPP
;

455 
£t__‰l_tos
->
v4_‰l_mask
 |ð
‰l_wÜd_mask
->
‰l
;

456 
£t__‰l_tos
->
v4_‰l
 &ð~
‰l_wÜd_mask
->
‰l
;

457 
£t__‰l_tos
->
v4_‰l
 |ð
‰l_wÜd
->
‰l
 & 
‰l_wÜd_mask
->ttl;

458 
£t__‰l_tos
->
h—d
.
jump_id
 =

459 
NFP_FL_ACTION_OPCODE_SET_IPV4_TTL_TOS
;

460 
£t__‰l_tos
->
h—d
.
Ën_lw
 = (*set_ip_ttl_tos) >>

461 
NFP_FL_LW_SIZ
;

463 
round_down
(
off£tof
(
hdr
, 
tos
), 4):

464 
tos_wÜd_mask
 = (
hdr
 *)&
mask
;

465 
tos_wÜd
 = (
hdr
 *)&
exaù
;

467 ià(
tos_wÜd_mask
->
v”siÚ
 ||os_wÜd_mask->
ihl
 ||

468 
tos_wÜd_mask
->
tÙ_Ën
)

469  -
EOPNOTSUPP
;

471 
£t__‰l_tos
->
v4_tos_mask
 |ð
tos_wÜd_mask
->
tos
;

472 
£t__‰l_tos
->
v4_tos
 &ð~
tos_wÜd_mask
->
tos
;

473 
£t__‰l_tos
->
v4_tos
 |ð
tos_wÜd
->
tos
 & 
tos_wÜd_mask
->tos;

474 
£t__‰l_tos
->
h—d
.
jump_id
 =

475 
NFP_FL_ACTION_OPCODE_SET_IPV4_TTL_TOS
;

476 
£t__‰l_tos
->
h—d
.
Ën_lw
 = (*set_ip_ttl_tos) >>

477 
NFP_FL_LW_SIZ
;

480  -
EOPNOTSUPP
;

487 
	$nå_æ_£t_6_h–³r
(
Ýcode_g
, 
u8
 
wÜd
, 
__be32
 
exaù
, __be32 
mask
,

488 
nå_æ_£t_v6_addr
 *
6
)

490 
6
->
v6
[
wÜd
].
mask
 |= mask;

491 
6
->
v6
[
wÜd
].
exaù
 &ð~
mask
;

492 
6
->
v6
[
wÜd
].
exaù
 |ðexaù & 
mask
;

494 
6
->
»£rved
 = 
	`ýu_to_be16
(0);

495 
6
->
h—d
.
jump_id
 = 
Ýcode_g
;

496 
6
->
h—d
.
Ën_lw
 = (*6è>> 
NFP_FL_LW_SIZ
;

497 
	}
}

499 
	sv6_hÝ_lim™_wÜd
 {

500 
__be16
 
·ylßd_Ën
;

501 
u8
 
Ãxthdr
;

502 
u8
 
hÝ_lim™
;

506 
	$nå_æ_£t_6_hÝ_lim™_æow_Ïb–
(
u32
 
off
, 
__be32
 
exaù
, __be32 
mask
,

507 
nå_æ_£t_v6_tc_hl_æ
 *
_hl_æ
)

509 
v6_hÝ_lim™_wÜd
 *
æ_hl_mask
;

510 
v6_hÝ_lim™_wÜd
 *
æ_hl
;

512 
off
) {

513 
	`off£tof
(
v6hdr
, 
·ylßd_Ën
):

514 
æ_hl_mask
 = (
v6_hÝ_lim™_wÜd
 *)&
mask
;

515 
æ_hl
 = (
v6_hÝ_lim™_wÜd
 *)&
exaù
;

517 ià(
æ_hl_mask
->
Ãxthdr
 || fl_hl_mask->
·ylßd_Ën
)

518  -
EOPNOTSUPP
;

520 
_hl_æ
->
v6_hÝ_lim™_mask
 |ð
æ_hl_mask
->
hÝ_lim™
;

521 
_hl_æ
->
v6_hÝ_lim™
 &ð~
æ_hl_mask
->
hÝ_lim™
;

522 
_hl_æ
->
v6_hÝ_lim™
 |ð
æ_hl
->
hÝ_lim™
 &

523 
æ_hl_mask
->
hÝ_lim™
;

525 
	`round_down
(
	`off£tof
(
v6hdr
, 
æow_lbl
), 4):

526 ià(
mask
 & ~
IPV6_FLOW_LABEL_MASK
 ||

527 
exaù
 & ~
IPV6_FLOW_LABEL_MASK
)

528  -
EOPNOTSUPP
;

530 
_hl_æ
->
v6_Ïb–_mask
 |ð
mask
;

531 
_hl_æ
->
v6_Ïb–
 &ð~
mask
;

532 
_hl_æ
->
v6_Ïb–
 |ð
exaù
 & 
mask
;

536 
_hl_æ
->
h—d
.
jump_id
 = 
NFP_FL_ACTION_OPCODE_SET_IPV6_TC_HL_FL
;

537 
_hl_æ
->
h—d
.
Ën_lw
 = (*_hl_æè>> 
NFP_FL_LW_SIZ
;

540 
	}
}

543 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

544 
nå_æ_£t_6
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
, 
u32
 
off
,

546 
nå_æ_£t_6
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
, 
u32
 
off
,

548 
nå_æ_£t_v6_addr
 *
_d¡
,

549 
nå_æ_£t_v6_addr
 *
_¤c
,

550 
nå_æ_£t_v6_tc_hl_æ
 *
_hl_æ
)

552 
__be32
 
exaù
, 
mask
;

553 
”r
 = 0;

554 
u8
 
wÜd
;

557 
mask
 = (
__fÜû
 
__be32
)~
com·t__tÿ_³d™_mask
(
aù
, 
idx
);

558 
exaù
 = (
__fÜû
 
__be32
)
com·t__tÿ_³d™_v®
(
aù
, 
idx
);

560 ià(
exaù
 & ~
mask
)

561  -
EOPNOTSUPP
;

563 ià(
off
 < 
off£tof
(
v6hdr
, 
§ddr
)) {

564 
”r
 = 
nå_æ_£t_6_hÝ_lim™_æow_Ïb–
(
off
, 
exaù
, 
mask
,

565 
_hl_æ
);

566 } ià(
off
 < 
off£tof
(
v6hdr
, 
daddr
)) {

567 
wÜd
 = (
off
 - 
off£tof
(
v6hdr
, 
§ddr
)è/ (
exaù
);

568 
nå_æ_£t_6_h–³r
(
NFP_FL_ACTION_OPCODE_SET_IPV6_SRC
, 
wÜd
,

569 
exaù
, 
mask
, 
_¤c
);

570 } ià(
off
 < 
off£tof
(
v6hdr
, 
daddr
) +

571 (
š6_addr
)) {

572 
wÜd
 = (
off
 - 
off£tof
(
v6hdr
, 
daddr
)è/ (
exaù
);

573 
nå_æ_£t_6_h–³r
(
NFP_FL_ACTION_OPCODE_SET_IPV6_DST
, 
wÜd
,

574 
exaù
, 
mask
, 
_d¡
);

576  -
EOPNOTSUPP
;

579  
”r
;

583 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

584 
nå_æ_£t_Üt
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
, 
u32
 
off
,

586 
nå_æ_£t_Üt
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
, 
u32
 
off
,

588 
nå_æ_£t_Üt
 *
£t_Üt
, 
Ýcode
)

590 
u32
 
exaù
, 
mask
;

592 ià(
off
)

593  -
EOPNOTSUPP
;

595 
mask
 = ~
com·t__tÿ_³d™_mask
(
aù
, 
idx
);

596 
exaù
 = 
com·t__tÿ_³d™_v®
(
aù
, 
idx
);

598 ià(
exaù
 & ~
mask
)

599  -
EOPNOTSUPP
;

601 
nå_æ_£t_h–³r32
(
exaù
, 
mask
, 
£t_Üt
->
_pÜt_v®
,

602 
£t_Üt
->
_pÜt_mask
);

604 
£t_Üt
->
»£rved
 = 
ýu_to_be16
(0);

605 
£t_Üt
->
h—d
.
jump_id
 = 
Ýcode
;

606 
£t_Üt
->
h—d
.
Ën_lw
 = (*£t_Ütè>> 
NFP_FL_LW_SIZ
;

611 
u32
 
	$nå_æ_csum_l4_to_æag
(
u8
 
_´Ùo
)

613 
_´Ùo
) {

618  
TCA_CSUM_UPDATE_FLAG_TCP
 | 
TCA_CSUM_UPDATE_FLAG_UDP
;

619 
IPPROTO_TCP
:

620  
TCA_CSUM_UPDATE_FLAG_TCP
;

621 
IPPROTO_UDP
:

622  
TCA_CSUM_UPDATE_FLAG_UDP
;

627 
	}
}

629 
	snå_æow”_³d™_aùs
 {

630 
nå_æ_£t_v6_addr
 
£t_6_d¡
, 
£t_6_¤c
;

631 
nå_æ_£t_v6_tc_hl_æ
 
£t_6_tc_hl_æ
;

632 
nå_æ_£t_4_‰l_tos
 
£t__‰l_tos
;

633 
nå_æ_£t_4_addrs
 
£t__addr
;

634 
nå_æ_£t_Üt
 
£t_Üt
;

635 
nå_æ_£t_‘h
 
£t_‘h
;

639 
	$nå_æ_comm™_mªgË
(
tc_þs_æow”_ofæßd
 *
æow
, *
nå_aùiÚ
,

640 *
a_Ën
, 
nå_æow”_³d™_aùs
 *
£t_aù
,

641 
u32
 *
csum_upd©ed
)

643 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

644 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

646 
size_t
 
aù_size
 = 0;

647 
u8
 
_´Ùo
 = 0;

649 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

650 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_BASIC
)) {

651 
æow_m©ch_basic
 
m©ch
;

653 
	`æow_ruË_m©ch_basic
(
ruË
, &
m©ch
);

654 
_´Ùo
 = 
m©ch
.
key
->ip_proto;

657 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_BASIC
)) {

658 
æow_dis£ùÜ_key_basic
 *
basic
;

660 
basic
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

661 
FLOW_DISSECTOR_KEY_BASIC
,

662 
æow
->
key
);

663 
_´Ùo
 = 
basic
->ip_proto;

667 ià(
£t_aù
->
£t_‘h
.
h—d
.
Ën_lw
) {

668 
aù_size
 = (
£t_aù
->
£t_‘h
);

669 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t_‘h
, 
aù_size
);

670 *
a_Ën
 +ð
aù_size
;

673 ià(
£t_aù
->
£t__‰l_tos
.
h—d
.
Ën_lw
) {

674 
nå_aùiÚ
 +ð
aù_size
;

675 
aù_size
 = (
£t_aù
->
£t__‰l_tos
);

676 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t__‰l_tos
, 
aù_size
);

677 *
a_Ën
 +ð
aù_size
;

680 *
csum_upd©ed
 |ð
TCA_CSUM_UPDATE_FLAG_IPV4HDR
 |

681 
	`nå_æ_csum_l4_to_æag
(
_´Ùo
);

684 ià(
£t_aù
->
£t__addr
.
h—d
.
Ën_lw
) {

685 
nå_aùiÚ
 +ð
aù_size
;

686 
aù_size
 = (
£t_aù
->
£t__addr
);

687 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t__addr
, 
aù_size
);

688 *
a_Ën
 +ð
aù_size
;

691 *
csum_upd©ed
 |ð
TCA_CSUM_UPDATE_FLAG_IPV4HDR
 |

692 
	`nå_æ_csum_l4_to_æag
(
_´Ùo
);

695 ià(
£t_aù
->
£t_6_tc_hl_æ
.
h—d
.
Ën_lw
) {

696 
nå_aùiÚ
 +ð
aù_size
;

697 
aù_size
 = (
£t_aù
->
£t_6_tc_hl_æ
);

698 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t_6_tc_hl_æ
, 
aù_size
);

699 *
a_Ën
 +ð
aù_size
;

702 *
csum_upd©ed
 |ð
	`nå_æ_csum_l4_to_æag
(
_´Ùo
);

705 ià(
£t_aù
->
£t_6_d¡
.
h—d
.
Ën_lw
 &&

706 
£t_aù
->
£t_6_¤c
.
h—d
.
Ën_lw
) {

710 
nå_aùiÚ
 +ð
aù_size
;

711 
aù_size
 = (
£t_aù
->
£t_6_¤c
);

712 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t_6_¤c
, 
aù_size
);

713 *
a_Ën
 +ð
aù_size
;

715 
aù_size
 = (
£t_aù
->
£t_6_d¡
);

716 
	`memýy
(&
nå_aùiÚ
[(
£t_aù
->
£t_6_¤c
)],

717 &
£t_aù
->
£t_6_d¡
, 
aù_size
);

718 *
a_Ën
 +ð
aù_size
;

721 *
csum_upd©ed
 |ð
	`nå_æ_csum_l4_to_æag
(
_´Ùo
);

722 } ià(
£t_aù
->
£t_6_d¡
.
h—d
.
Ën_lw
) {

723 
nå_aùiÚ
 +ð
aù_size
;

724 
aù_size
 = (
£t_aù
->
£t_6_d¡
);

725 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t_6_d¡
, 
aù_size
);

726 *
a_Ën
 +ð
aù_size
;

729 *
csum_upd©ed
 |ð
	`nå_æ_csum_l4_to_æag
(
_´Ùo
);

730 } ià(
£t_aù
->
£t_6_¤c
.
h—d
.
Ën_lw
) {

731 
nå_aùiÚ
 +ð
aù_size
;

732 
aù_size
 = (
£t_aù
->
£t_6_¤c
);

733 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t_6_¤c
, 
aù_size
);

734 *
a_Ën
 +ð
aù_size
;

737 *
csum_upd©ed
 |ð
	`nå_æ_csum_l4_to_æag
(
_´Ùo
);

739 ià(
£t_aù
->
£t_Üt
.
h—d
.
Ën_lw
) {

740 
nå_aùiÚ
 +ð
aù_size
;

741 
aù_size
 = (
£t_aù
->
£t_Üt
);

742 
	`memýy
(
nå_aùiÚ
, &
£t_aù
->
£t_Üt
, 
aù_size
);

743 *
a_Ën
 +ð
aù_size
;

746 *
csum_upd©ed
 |ð
	`nå_æ_csum_l4_to_æag
(
_´Ùo
);

750 
	}
}

753 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

754 
	$nå_æ_³d™
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
,

755 
tc_þs_æow”_ofæßd
 *
æow
, *
nå_aùiÚ
, *
a_Ën
,

756 
u32
 *
csum_upd©ed
, 
nå_æow”_³d™_aùs
 *
£t_aù
)

758 
æow_aùiÚ_mªgË_ba£
 
hty³
;

760 
	$nå_æ_³d™
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
tc_þs_æow”_ofæßd
 *
æow
,

761 *
nå_aùiÚ
, *
a_Ën
, 
u32
 *
csum_upd©ed
)

763 
nå_æow”_³d™_aùs
 *
£t_aù
;

764 
³d™_h—d”_ty³
 
hty³
;

766 
idx
, 
nkeys
, 
”r
;

767 
u32
 
off£t
, 
cmd
;

769 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

770 
£t_aù
 = 
	`km®loc
((*£t_aù), 
GFP_KERNEL
);

771 
	`mem£t
(
£t_aù
, 0, (*set_act));

773 
nkeys
 = 
	`com·t__tÿ_³d™_nkeys
(
aù
);

775 
idx
 = 0; idx < 
nkeys
; idx++) {

776 
cmd
 = 
	`com·t__tÿ_³d™_cmd
(
aù
, 
idx
);

777 
hty³
 = 
	`com·t__tÿ_³d™_hty³
(
aù
, 
idx
);

778 
off£t
 = 
	`com·t__tÿ_³d™_off£t
(
aù
, 
idx
);

780 ià(
cmd
 !ð
TCA_PEDIT_KEY_EX_CMD_SET
)

781  -
EOPNOTSUPP
;

783 
hty³
) {

784 
TCA_PEDIT_KEY_EX_HDR_TYPE_ETH
:

785 
”r
 = 
	`nå_æ_£t_‘h
(
aù
, 
idx
, 
off£t
,

786 &
£t_aù
->
£t_‘h
);

788 
TCA_PEDIT_KEY_EX_HDR_TYPE_IP4
:

789 
”r
 = 
	`nå_æ_£t_4
(
aù
, 
idx
, 
off£t
,

790 &
£t_aù
->
£t__addr
,

791 &
£t_aù
->
£t__‰l_tos
);

793 
TCA_PEDIT_KEY_EX_HDR_TYPE_IP6
:

794 
”r
 = 
	`nå_æ_£t_6
(
aù
, 
idx
, 
off£t
,

795 &
£t_aù
->
£t_6_d¡
,

796 &
£t_aù
->
£t_6_¤c
,

797 &
£t_aù
->
£t_6_tc_hl_æ
);

799 
TCA_PEDIT_KEY_EX_HDR_TYPE_TCP
:

800 
”r
 = 
	`nå_æ_£t_Üt
(
aù
, 
idx
, 
off£t
,

801 &
£t_aù
->
£t_Üt
,

802 
NFP_FL_ACTION_OPCODE_SET_TCP
);

804 
TCA_PEDIT_KEY_EX_HDR_TYPE_UDP
:

805 
”r
 = 
	`nå_æ_£t_Üt
(
aù
, 
idx
, 
off£t
,

806 &
£t_aù
->
£t_Üt
,

807 
NFP_FL_ACTION_OPCODE_SET_UDP
);

810  -
EOPNOTSUPP
;

812 ià(
”r
)

813  
”r
;

815 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

816 
	`nå_æ_comm™_mªgË
(
æow
, 
nå_aùiÚ
, 
a_Ën
, 
£t_aù
, 
csum_upd©ed
);

820 
	}
}

823 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

824 
nå_æow”_ouut_aùiÚ
(
nå_­p
 *
­p
,

825 cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
,

827 
nå_æow”_ouut_aùiÚ
(
nå_­p
 *
­p
, cÚ¡ 
tc_aùiÚ
 *
aù
,

829 
nå_æ_·ylßd
 *
nå_æ
, *
a_Ën
,

830 
Ãt_deviû
 *
Ãtdev
, 
boÞ
 
Ï¡
,

831 
nå_æow”_tun_ty³
 *
tun_ty³
, *
tun_out_út
,

832 *
out_út
, 
u32
 *
csum_upd©ed
)

834 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

835 
nå_æ_ouut
 *
ouut
;

836 
”r
, 
´–ag_size
;

841 ià(*
csum_upd©ed
)

842  -
EOPNOTSUPP
;

844 ià(*
a_Ën
 + (
nå_æ_ouut
è> 
NFP_FL_MAX_A_SIZ
)

845  -
EOPNOTSUPP
;

847 
ouut
 = (
nå_æ_ouut
 *)&
nå_æ
->
aùiÚ_d©a
[*
a_Ën
];

848 
”r
 = 
nå_æ_ouut
(
­p
, 
ouut
, 
aù
, 
nå_æ
, 
Ï¡
, 
Ãtdev
, *
tun_ty³
,

849 
tun_out_út
);

850 ià(
”r
)

851  
”r
;

853 *
a_Ën
 +ð(
nå_æ_ouut
);

855 ià(
´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_LAG
) {

859 
´–ag_size
 = 
nå_æ_´e_Ïg
(
­p
, 
aù
, 
nå_æ
, *
a_Ën
);

860 ià(
´–ag_size
 < 0)

861  
´–ag_size
;

862 ià(
´–ag_size
 > 0 && (!
Ï¡
 || *
out_út
))

863  -
EOPNOTSUPP
;

865 *
a_Ën
 +ð
´–ag_size
;

867 (*
out_út
)++;

873 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

874 
	$nå_æow”_loÝ_aùiÚ
(
nå_­p
 *
­p
, cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
,

875 
tc_þs_æow”_ofæßd
 *
æow
,

876 
nå_æ_·ylßd
 *
nå_æ
, *
a_Ën
,

877 
Ãt_deviû
 *
Ãtdev
,

878 
nå_æow”_tun_ty³
 *
tun_ty³
, *
tun_out_út
,

879 *
out_út
, 
u32
 *
csum_upd©ed
,

880 
nå_æow”_³d™_aùs
 *
£t_aù
)

882 
	$nå_æow”_loÝ_aùiÚ
(
nå_­p
 *
­p
, cÚ¡ 
tc_aùiÚ
 *
aù
,

883 
tc_þs_æow”_ofæßd
 *
æow
,

884 
nå_æ_·ylßd
 *
nå_æ
, *
a_Ën
,

885 
Ãt_deviû
 *
Ãtdev
,

886 
nå_æow”_tun_ty³
 *
tun_ty³
, *
tun_out_út
,

887 *
out_út
, 
u32
 *
csum_upd©ed
)

890 
nå_æ_£t_v4_udp_tun
 *
£t_tun
;

891 
nå_æ_´e_tuÂ–
 *
´e_tun
;

892 
nå_æ_push_vÏn
 *
psh_v
;

893 
nå_æ_pÝ_vÏn
 *
pÝ_v
;

894 
”r
;

896 
	`com·t__tÿ_to_æow_aù_id
(
aù
)) {

897 
FLOW_ACTION_DROP
:

898 
nå_æ
->
m‘a
.
shÜtcut
 = 
	`ýu_to_be32
(
NFP_FL_SC_ACT_DROP
);

900 
FLOW_ACTION_REDIRECT
:

901 
”r
 = 
	`nå_æow”_ouut_aùiÚ
(
­p
, 
aù
, 
nå_æ
, 
a_Ën
, 
Ãtdev
,

902 
Œue
, 
tun_ty³
, 
tun_out_út
,

903 
out_út
, 
csum_upd©ed
);

904 ià(
”r
)

905  
”r
;

907 
FLOW_ACTION_MIRRED
:

908 
”r
 = 
	`nå_æow”_ouut_aùiÚ
(
­p
, 
aù
, 
nå_æ
, 
a_Ën
, 
Ãtdev
,

909 
çl£
, 
tun_ty³
, 
tun_out_út
,

910 
out_út
, 
csum_upd©ed
);

911 ià(
”r
)

912  
”r
;

914 
FLOW_ACTION_VLAN_POP
:

915 ià(*
a_Ën
 + (
nå_æ_pÝ_vÏn
è> 
NFP_FL_MAX_A_SIZ
)

916  -
EOPNOTSUPP
;

918 
pÝ_v
 = (
nå_æ_pÝ_vÏn
 *)&
nå_æ
->
aùiÚ_d©a
[*
a_Ën
];

919 
nå_æ
->
m‘a
.
shÜtcut
 = 
	`ýu_to_be32
(
NFP_FL_SC_ACT_POPV
);

921 
	`nå_æ_pÝ_vÏn
(
pÝ_v
);

922 *
a_Ën
 +ð(
nå_æ_pÝ_vÏn
);

924 
FLOW_ACTION_VLAN_PUSH
:

925 ià(*
a_Ën
 + (
nå_æ_push_vÏn
è> 
NFP_FL_MAX_A_SIZ
)

926  -
EOPNOTSUPP
;

928 
psh_v
 = (
nå_æ_push_vÏn
 *)&
nå_æ
->
aùiÚ_d©a
[*
a_Ën
];

929 
nå_æ
->
m‘a
.
shÜtcut
 = 
	`ýu_to_be32
(
NFP_FL_SC_ACT_NULL
);

931 
	`nå_æ_push_vÏn
(
psh_v
, 
aù
);

932 *
a_Ën
 +ð(
nå_æ_push_vÏn
);

934 
FLOW_ACTION_TUNNEL_ENCAP
: {

935 cÚ¡ 
_tuÂ–_šfo
 *
_tun
 = 
	`com·t__tÿ_tun_šfo
(
aù
);

937 *
tun_ty³
 = 
	`nå_æ_g‘_tun_äom_aù_l4_pÜt
(
­p
, 
aù
);

938 ià(*
tun_ty³
 =ð
NFP_FL_TUNNEL_NONE
)

939  -
EOPNOTSUPP
;

941 ià(
_tun
->
mode
 & ~
NFP_FL_SUPPORTED_TUNNEL_INFO_FLAGS
)

942  -
EOPNOTSUPP
;

948 ià(*
a_Ën
 + (
nå_æ_´e_tuÂ–
) +

949 (
nå_æ_£t_v4_udp_tun
è> 
NFP_FL_MAX_A_SIZ
)

950  -
EOPNOTSUPP
;

952 
´e_tun
 = 
	`nå_æ_´e_tuÂ–
(
nå_æ
->
aùiÚ_d©a
, *
a_Ën
);

953 
nå_æ
->
m‘a
.
shÜtcut
 = 
	`ýu_to_be32
(
NFP_FL_SC_ACT_NULL
);

954 *
a_Ën
 +ð(
nå_æ_´e_tuÂ–
);

956 
”r
 = 
	`nå_æ_push_g’eve_ÝtiÚs
(
nå_æ
, 
a_Ën
, 
aù
);

957 ià(
”r
)

958  
”r
;

960 
£t_tun
 = (*)&
nå_æ
->
aùiÚ_d©a
[*
a_Ën
];

961 
”r
 = 
	`nå_æ_£t_v4_udp_tun
(
­p
, 
£t_tun
, 
aù
, 
´e_tun
,

962 *
tun_ty³
, 
Ãtdev
);

963 ià(
”r
)

964  
”r
;

965 *
a_Ën
 +ð(
nå_æ_£t_v4_udp_tun
);

968 
FLOW_ACTION_TUNNEL_DECAP
:

971 
FLOW_ACTION_MANGLE
:

972 ià(
	`nå_æ_³d™
(
aù
, 
æow
, &
nå_æ
->
aùiÚ_d©a
[*
a_Ën
],

973 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

974 
a_Ën
, 
csum_upd©ed
, 
£t_aù
))

976 
a_Ën
, 
csum_upd©ed
))

978  -
EOPNOTSUPP
;

980 
FLOW_ACTION_CSUM
:

982 ià(
	`com·t__tÿ_csum_upd©e_æags
(
aù
è& ~*
csum_upd©ed
)

983  -
EOPNOTSUPP
;

987 *
csum_upd©ed
 &ð~
	`com·t__tÿ_csum_upd©e_æags
(
aù
);

991  -
EOPNOTSUPP
;

995 
	}
}

997 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

998 
boÞ
 
	$nå_æ_check_mªgË_¡¬t
(
æow_aùiÚ
 *
æow_aù
,

999 
cu¼’t_aù_idx
)

1001 
æow_aùiÚ_’Œy
 
cu¼’t_aù
;

1002 
æow_aùiÚ_’Œy
 
´ev_aù
;

1004 
cu¼’t_aù
 = 
æow_aù
->
’Œ›s
[
cu¼’t_aù_idx
];

1005 ià(
cu¼’t_aù
.
id
 !ð
FLOW_ACTION_MANGLE
)

1006  
çl£
;

1008 ià(
cu¼’t_aù_idx
 == 0)

1009  
Œue
;

1011 
´ev_aù
 = 
æow_aù
->
’Œ›s
[
cu¼’t_aù_idx
 - 1];

1013  
´ev_aù
.
id
 !ð
FLOW_ACTION_MANGLE
;

1014 
	}
}

1016 
boÞ
 
	$nå_æ_check_mªgË_’d
(
æow_aùiÚ
 *
æow_aù
,

1017 
cu¼’t_aù_idx
)

1019 
æow_aùiÚ_’Œy
 
cu¼’t_aù
;

1020 
æow_aùiÚ_’Œy
 
Ãxt_aù
;

1022 
cu¼’t_aù
 = 
æow_aù
->
’Œ›s
[
cu¼’t_aù_idx
];

1023 ià(
cu¼’t_aù
.
id
 !ð
FLOW_ACTION_MANGLE
)

1024  
çl£
;

1026 ià(
cu¼’t_aù_idx
 =ð
æow_aù
->
num_’Œ›s
)

1027  
Œue
;

1029 
Ãxt_aù
 = 
æow_aù
->
’Œ›s
[
cu¼’t_aù_idx
 + 1];

1031  
Ãxt_aù
.
id
 !ð
FLOW_ACTION_MANGLE
;

1032 
	}
}

1034 
	$nå_æow”_compže_aùiÚ
(
nå_­p
 *
­p
,

1035 
tc_þs_æow”_ofæßd
 *
æow
,

1036 
Ãt_deviû
 *
Ãtdev
,

1037 
nå_æ_·ylßd
 *
nå_æow
)

1039 
aù_Ën
, 
aù_út
, 
”r
, 
tun_out_út
, 
out_út
, 
i
;

1040 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

1041 
nå_æow”_³d™_aùs
 
£t_aù
;

1043 
nå_æow”_tun_ty³
 
tun_ty³
;

1044 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

1045 
æow_aùiÚ_’Œy
 *
aù
;

1047 cÚ¡ 
tc_aùiÚ
 *
aù
;

1049 
u32
 
csum_upd©ed
 = 0;

1050 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 19, 0)

1051 
	`LIST_HEAD
(
aùiÚs
);

1054 
	`mem£t
(
nå_æow
->
aùiÚ_d©a
, 0, 
NFP_FL_MAX_A_SIZ
);

1055 
nå_æow
->
m‘a
.
aù_Ën
 = 0;

1056 
tun_ty³
 = 
NFP_FL_TUNNEL_NONE
;

1057 
aù_Ën
 = 0;

1058 
aù_út
 = 0;

1059 
tun_out_út
 = 0;

1060 
out_út
 = 0;

1062 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 19, 0)

1063 
i
 = 0; i = i;

1064 
	`tcf_exts_to_li¡
(
æow
->
exts
, &
aùiÚs
);

1065 
	`li¡_fÜ_—ch_’Œy
(
aù
, &
aùiÚs
, 
li¡
) {

1066 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

1067 
	`tcf_exts_fÜ_—ch_aùiÚ
(
i
, 
aù
, 
æow
->
exts
) {

1069 
	`æow_aùiÚ_fÜ_—ch
(
i
, 
aù
, &
æow
->
ruË
->
aùiÚ
) {

1071 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

1072 ià(
	`nå_æ_check_mªgË_¡¬t
(&
æow
->
ruË
->
aùiÚ
, 
i
))

1073 
	`mem£t
(&
£t_aù
, 0, (set_act));

1075 
”r
 = 
	`nå_æow”_loÝ_aùiÚ
(
­p
, 
aù
, 
æow
, 
nå_æow
, &
aù_Ën
,

1076 
Ãtdev
, &
tun_ty³
, &
tun_out_út
,

1077 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

1078 &
out_út
, &
csum_upd©ed
, &
£t_aù
);

1080 &
out_út
, &
csum_upd©ed
);

1082 ià(
”r
)

1083  
”r
;

1084 
aù_út
++;

1085 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

1086 ià(
	`nå_æ_check_mªgË_’d
(&
æow
->
ruË
->
aùiÚ
, 
i
))

1087 
	`nå_æ_comm™_mªgË
(
æow
,

1088 &
nå_æow
->
aùiÚ_d©a
[
aù_Ën
],

1089 &
aù_Ën
, &
£t_aù
, &
csum_upd©ed
);

1096 ià(
aù_út
 > 1)

1097 
nå_æow
->
m‘a
.
shÜtcut
 = 
	`ýu_to_be32
(
NFP_FL_SC_ACT_NULL
);

1099 
nå_æow
->
m‘a
.
aù_Ën
 =‡ct_len;

1102 
	}
}

	@src/flower/cmsg.c

4 
	~<lšux/b™f›ld.h
>

5 
	~<lšux/Ãtdeviû.h
>

6 
	~<lšux/skbuff.h
>

7 
	~<lšux/wÜkqueue.h
>

8 
	~<Ãt/d¡_m‘ad©a.h
>

10 
	~"maš.h
"

11 
	~"../nå_Ãt.h
"

12 
	~"../nå_Ãt_»´.h
"

13 
	~"cmsg.h
"

15 
nå_æow”_cmsg_hdr
 *

16 
	$nå_æow”_cmsg_g‘_hdr
(
sk_buff
 *
skb
)

18  (
nå_æow”_cmsg_hdr
 *)
skb
->
d©a
;

19 
	}
}

21 
sk_buff
 *

22 
	$nå_æow”_cmsg_®loc
(
nå_­p
 *
­p
, 
size
,

23 
nå_æow”_cmsg_ty³_pÜt
 
ty³
, 
gå_t
 
æag
)

25 
nå_æow”_cmsg_hdr
 *
ch
;

26 
sk_buff
 *
skb
;

28 
size
 +ð
NFP_FLOWER_CMSG_HLEN
;

30 
skb
 = 
	`nå_­p_ù¾_msg_®loc
(
­p
, 
size
, 
æag
);

31 ià(!
skb
)

32  
NULL
;

34 
ch
 = 
	`nå_æow”_cmsg_g‘_hdr
(
skb
);

35 
ch
->
·d
 = 0;

36 
ch
->
v”siÚ
 = 
NFP_FLOWER_CMSG_VER1
;

37 
ch
->
ty³
 =ype;

38 
	`skb_put
(
skb
, 
size
);

40  
skb
;

41 
	}
}

43 
sk_buff
 *

44 
	$nå_æow”_cmsg_mac_»´_¡¬t
(
nå_­p
 *
­p
, 
num_pÜts
)

46 
nå_æow”_cmsg_mac_»´
 *
msg
;

47 
sk_buff
 *
skb
;

49 
skb
 = 
	`nå_æow”_cmsg_®loc
(
­p
, 
	`¡ruù_size
(
msg
, 
pÜts
, 
num_pÜts
),

50 
NFP_FLOWER_CMSG_TYPE_MAC_REPR
, 
GFP_KERNEL
);

51 ià(!
skb
)

52  
NULL
;

54 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

55 
	`mem£t
(
msg
->
»£rved
, 0, (msg->reserved));

56 
msg
->
num_pÜts
 =‚um_ports;

58  
skb
;

59 
	}
}

62 
	$nå_æow”_cmsg_mac_»´_add
(
sk_buff
 *
skb
, 
idx
,

63 
nbi
, 
nbi_pÜt
,

64 
phys_pÜt
)

66 
nå_æow”_cmsg_mac_»´
 *
msg
;

68 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

69 
msg
->
pÜts
[
idx
].idx = idx;

70 
msg
->
pÜts
[
idx
].
šfo
 = 
nbi
 & 
NFP_FLOWER_CMSG_MAC_REPR_NBI
;

71 
msg
->
pÜts
[
idx
].
nbi_pÜt
 =‚bi_port;

72 
msg
->
pÜts
[
idx
].
phys_pÜt
 =…hys_port;

73 
	}
}

75 
	$nå_æow”_cmsg_pÜtmod
(
nå_»´
 *
»´
, 
boÞ
 
ÿ¼›r_ok
,

76 
mtu
, 
boÞ
 
mtu_Úly
)

78 
nå_æow”_cmsg_pÜtmod
 *
msg
;

79 
sk_buff
 *
skb
;

81 
skb
 = 
	`nå_æow”_cmsg_®loc
(
»´
->
­p
, (*
msg
),

82 
NFP_FLOWER_CMSG_TYPE_PORT_MOD
, 
GFP_KERNEL
);

83 ià(!
skb
)

84  -
ENOMEM
;

86 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

87 
msg
->
pÜŠum
 = 
	`ýu_to_be32
(
»´
->
d¡
->
u
.
pÜt_šfo
.
pÜt_id
);

88 
msg
->
»£rved
 = 0;

89 
msg
->
šfo
 = 
ÿ¼›r_ok
;

91 ià(
mtu_Úly
)

92 
msg
->
šfo
 |ð
NFP_FLOWER_CMSG_PORTMOD_MTU_CHANGE_ONLY
;

94 
msg
->
mtu
 = 
	`ýu_to_be16
(mtu);

96 
	`nå_ù¾_tx
(
»´
->
­p
->
ù¾
, 
skb
);

99 
	}
}

101 
	$nå_æow”_cmsg_pÜŒeify
(
nå_»´
 *
»´
, 
boÞ
 
exi¡s
)

103 
nå_æow”_cmsg_pÜŒeify
 *
msg
;

104 
sk_buff
 *
skb
;

106 
skb
 = 
	`nå_æow”_cmsg_®loc
(
»´
->
­p
, (*
msg
),

107 
NFP_FLOWER_CMSG_TYPE_PORT_REIFY
,

108 
GFP_KERNEL
);

109 ià(!
skb
)

110  -
ENOMEM
;

112 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

113 
msg
->
pÜŠum
 = 
	`ýu_to_be32
(
»´
->
d¡
->
u
.
pÜt_šfo
.
pÜt_id
);

114 
msg
->
»£rved
 = 0;

115 
msg
->
šfo
 = 
	`ýu_to_be16
(
exi¡s
);

117 
	`nå_ù¾_tx
(
»´
->
­p
->
ù¾
, 
skb
);

120 
	}
}

122 
boÞ


123 
	$nå_æow”_´oûss_mtu_ack
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

125 
nå_æow”_´iv
 *
­p_´iv
 = 
­p
->
´iv
;

126 
nå_æow”_cmsg_pÜtmod
 *
msg
;

128 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

130 ià(!(
msg
->
šfo
 & 
NFP_FLOWER_CMSG_PORTMOD_MTU_CHANGE_ONLY
))

131  
çl£
;

133 
	`¥š_lock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

134 ià(!
­p_´iv
->
mtu_cÚf
.
»que¡ed_v®
 ||

135 
­p_´iv
->
mtu_cÚf
.
pÜŠum
 !ð
	`be32_to_ýu
(
msg
->portnum) ||

136 
	`be16_to_ýu
(
msg
->
mtu
è!ð
­p_´iv
->
mtu_cÚf
.
»que¡ed_v®
) {

138 
	`¥š_uÆock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

139  
çl£
;

142 
­p_´iv
->
mtu_cÚf
.
ack
 = 
Œue
;

143 
­p_´iv
->
mtu_cÚf
.
»que¡ed_v®
 = 0;

144 
	`wake_up
(&
­p_´iv
->
mtu_cÚf
.
wa™_q
);

145 
	`¥š_uÆock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

147  
Œue
;

148 
	}
}

151 
	$nå_æow”_cmsg_pÜtmod_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

153 
nå_æow”_cmsg_pÜtmod
 *
msg
;

154 
Ãt_deviû
 *
Ãtdev
;

155 
boÞ
 
lšk
;

157 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

158 
lšk
 = 
msg
->
šfo
 & 
NFP_FLOWER_CMSG_PORTMOD_INFO_LINK
;

160 
	`¹Æ_lock
();

161 
	`rcu_»ad_lock
();

162 
Ãtdev
 = 
	`nå_­p_»´_g‘
(
­p
, 
	`be32_to_ýu
(
msg
->
pÜŠum
));

163 
	`rcu_»ad_uÆock
();

164 ià(!
Ãtdev
) {

165 
	`nå_æow”_cmsg_w¬n
(
­p
, "ctrl msg for unknown…ort 0x%08x\n",

166 
	`be32_to_ýu
(
msg
->
pÜŠum
));

167 
	`¹Æ_uÆock
();

171 ià(
lšk
) {

172 
u16
 
mtu
 = 
	`be16_to_ýu
(
msg
->mtu);

174 
	`Ãtif_ÿ¼›r_Ú
(
Ãtdev
);

177 ià(
mtu
)

178 
	`dev_£t_mtu
(
Ãtdev
, 
mtu
);

180 
	`Ãtif_ÿ¼›r_off
(
Ãtdev
);

182 
	`¹Æ_uÆock
();

183 
	}
}

186 
	$nå_æow”_cmsg_pÜŒeify_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

188 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

189 
nå_æow”_cmsg_pÜŒeify
 *
msg
;

190 
boÞ
 
exi¡s
;

192 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

194 
	`rcu_»ad_lock
();

195 
exi¡s
 = !!
	`nå_­p_»´_g‘
(
­p
, 
	`be32_to_ýu
(
msg
->
pÜŠum
));

196 
	`rcu_»ad_uÆock
();

197 ià(!
exi¡s
) {

198 
	`nå_æow”_cmsg_w¬n
(
­p
, "ctrl msg for unknown…ort 0x%08x\n",

199 
	`be32_to_ýu
(
msg
->
pÜŠum
));

203 
	`©omic_šc
(&
´iv
->
»ify_»¶›s
);

204 
	`wake_up
(&
´iv
->
»ify_wa™_queue
);

205 
	}
}

208 
	$nå_æow”_cmsg_´oûss_Úe_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

210 
nå_æow”_´iv
 *
­p_´iv
 = 
­p
->
´iv
;

211 
nå_æow”_cmsg_hdr
 *
cmsg_hdr
;

212 
nå_æow”_cmsg_ty³_pÜt
 
ty³
;

213 
boÞ
 
skb_¡Üed
 = 
çl£
;

215 
cmsg_hdr
 = 
	`nå_æow”_cmsg_g‘_hdr
(
skb
);

217 
ty³
 = 
cmsg_hdr
->type;

218 
ty³
) {

219 
NFP_FLOWER_CMSG_TYPE_PORT_REIFY
:

220 
	`nå_æow”_cmsg_pÜŒeify_rx
(
­p
, 
skb
);

222 
NFP_FLOWER_CMSG_TYPE_PORT_MOD
:

223 
	`nå_æow”_cmsg_pÜtmod_rx
(
­p
, 
skb
);

225 
NFP_FLOWER_CMSG_TYPE_NO_NEIGH
:

226 
	`nå_tuÂ–_»que¡_rou‹
(
­p
, 
skb
);

228 
NFP_FLOWER_CMSG_TYPE_ACTIVE_TUNS
:

229 
	`nå_tuÂ–_k“p_®ive
(
­p
, 
skb
);

231 
NFP_FLOWER_CMSG_TYPE_LAG_CONFIG
:

232 ià(
­p_´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_LAG
) {

233 
skb_¡Üed
 = 
	`nå_æow”_Ïg_uÅroûs£d_msg
(
­p
, 
skb
);

238 
	`nå_æow”_cmsg_w¬n
(
­p
, "Cannot handle invalid„epr controlype %u\n",

239 
ty³
);

240 
out
;

243 ià(!
skb_¡Üed
)

244 
	`dev_cÚsume_skb_ªy
(
skb
);

246 
out
:

247 
	`dev_kä“_skb_ªy
(
skb
);

248 
	}
}

250 
	$nå_æow”_cmsg_´oûss_rx
(
wÜk_¡ruù
 *
wÜk
)

252 
sk_buff_h—d
 
cmsg_jošed
;

253 
nå_æow”_´iv
 *
´iv
;

254 
sk_buff
 *
skb
;

256 
´iv
 = 
	`cÚš”_of
(
wÜk
, 
nå_æow”_´iv
, 
cmsg_wÜk
);

257 
	`skb_queue_h—d_š™
(&
cmsg_jošed
);

259 
	`¥š_lock_bh
(&
´iv
->
cmsg_skbs_high
.
lock
);

260 
	`skb_queue_¥liû_ž_š™
(&
´iv
->
cmsg_skbs_high
, &
cmsg_jošed
);

261 
	`¥š_uÆock_bh
(&
´iv
->
cmsg_skbs_high
.
lock
);

263 
	`¥š_lock_bh
(&
´iv
->
cmsg_skbs_low
.
lock
);

264 
	`skb_queue_¥liû_ž_š™
(&
´iv
->
cmsg_skbs_low
, &
cmsg_jošed
);

265 
	`¥š_uÆock_bh
(&
´iv
->
cmsg_skbs_low
.
lock
);

267 (
skb
 = 
	`__skb_dequeue
(&
cmsg_jošed
)))

268 
	`nå_æow”_cmsg_´oûss_Úe_rx
(
´iv
->
­p
, 
skb
);

269 
	}
}

272 
	$nå_æow”_queue_ùl_msg
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
, 
ty³
)

274 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

275 
sk_buff_h—d
 *
skb_h—d
;

277 ià(
ty³
 =ð
NFP_FLOWER_CMSG_TYPE_PORT_REIFY
 ||

278 
ty³
 =ð
NFP_FLOWER_CMSG_TYPE_PORT_MOD
)

279 
skb_h—d
 = &
´iv
->
cmsg_skbs_high
;

281 
skb_h—d
 = &
´iv
->
cmsg_skbs_low
;

283 ià(
	`skb_queue_Ën
(
skb_h—d
è>ð
NFP_FLOWER_WORKQ_MAX_SKBS
) {

284 
	`nå_æow”_cmsg_w¬n
(
­p
, "Dropping queued control messages\n");

285 
	`dev_kä“_skb_ªy
(
skb
);

289 
	`skb_queue_ž
(
skb_h—d
, 
skb
);

290 
	`scheduË_wÜk
(&
´iv
->
cmsg_wÜk
);

291 
	}
}

293 
	$nå_æow”_cmsg_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

295 
nå_æow”_cmsg_hdr
 *
cmsg_hdr
;

297 
cmsg_hdr
 = 
	`nå_æow”_cmsg_g‘_hdr
(
skb
);

299 ià(
	`uÆik–y
(
cmsg_hdr
->
v”siÚ
 !ð
NFP_FLOWER_CMSG_VER1
)) {

300 
	`nå_æow”_cmsg_w¬n
(
­p
, "Cannot handle„epr control version %u\n",

301 
cmsg_hdr
->
v”siÚ
);

302 
	`dev_kä“_skb_ªy
(
skb
);

306 ià(
cmsg_hdr
->
ty³
 =ð
NFP_FLOWER_CMSG_TYPE_FLOW_STATS
) {

308 
	`nå_æow”_rx_æow_¡©s
(
­p
, 
skb
);

309 
	`dev_cÚsume_skb_ªy
(
skb
);

310 } ià(
cmsg_hdr
->
ty³
 =ð
NFP_FLOWER_CMSG_TYPE_PORT_MOD
 &&

311 
	`nå_æow”_´oûss_mtu_ack
(
­p
, 
skb
)) {

313 
	`dev_cÚsume_skb_ªy
(
skb
);

314 } ià(
cmsg_hdr
->
ty³
 =ð
NFP_FLOWER_CMSG_TYPE_TUN_NEIGH
) {

316 
	`dev_cÚsume_skb_ªy
(
skb
);

318 
	`nå_æow”_queue_ùl_msg
(
­p
, 
skb
, 
cmsg_hdr
->
ty³
);

320 
	}
}

	@src/flower/cmsg.h

4 #iâdeà
NFP_FLOWER_CMSG_H


5 
	#NFP_FLOWER_CMSG_H


	)

7 
	~<lšux/b™f›ld.h
>

8 
	~<lšux/skbuff.h
>

9 
	~<lšux/ty³s.h
>

10 
	~<Ãt/g’eve.h
>

11 
	~<Ãt/vxÏn.h
>

13 
	~"../nå_­p.h
"

14 
	~"../nåcÜe/nå_ýp.h
"

16 
	#NFP_FLOWER_LAYER_EXT_META
 
	`BIT
(0)

	)

17 
	#NFP_FLOWER_LAYER_PORT
 
	`BIT
(1)

	)

18 
	#NFP_FLOWER_LAYER_MAC
 
	`BIT
(2)

	)

19 
	#NFP_FLOWER_LAYER_TP
 
	`BIT
(3)

	)

20 
	#NFP_FLOWER_LAYER_IPV4
 
	`BIT
(4)

	)

21 
	#NFP_FLOWER_LAYER_IPV6
 
	`BIT
(5)

	)

22 
	#NFP_FLOWER_LAYER_CT
 
	`BIT
(6)

	)

23 
	#NFP_FLOWER_LAYER_VXLAN
 
	`BIT
(7)

	)

25 
	#NFP_FLOWER_LAYER2_GENEVE
 
	`BIT
(5)

	)

26 
	#NFP_FLOWER_LAYER2_GENEVE_OP
 
	`BIT
(6)

	)

28 
	#NFP_FLOWER_MASK_VLAN_PRIO
 
	`GENMASK
(15, 13)

	)

29 
	#NFP_FLOWER_MASK_VLAN_PRESENT
 
	`BIT
(12)

	)

30 
	#NFP_FLOWER_MASK_VLAN_VID
 
	`GENMASK
(11, 0)

	)

32 
	#NFP_FLOWER_MASK_MPLS_LB
 
	`GENMASK
(31, 12)

	)

33 
	#NFP_FLOWER_MASK_MPLS_TC
 
	`GENMASK
(11, 9)

	)

34 
	#NFP_FLOWER_MASK_MPLS_BOS
 
	`BIT
(8)

	)

35 
	#NFP_FLOWER_MASK_MPLS_Q
 
	`BIT
(0)

	)

37 
	#NFP_FL_IP_FRAG_FIRST
 
	`BIT
(7)

	)

38 
	#NFP_FL_IP_FRAGMENTED
 
	`BIT
(6)

	)

41 
	#NFP_FL_TCP_FLAG_URG
 
	`BIT
(4)

	)

42 
	#NFP_FL_TCP_FLAG_PSH
 
	`BIT
(3)

	)

43 
	#NFP_FL_TCP_FLAG_RST
 
	`BIT
(2)

	)

44 
	#NFP_FL_TCP_FLAG_SYN
 
	`BIT
(1)

	)

45 
	#NFP_FL_TCP_FLAG_FIN
 
	`BIT
(0)

	)

47 
	#NFP_FL_SC_ACT_DROP
 0x80000000

	)

48 
	#NFP_FL_SC_ACT_USER
 0x7D000000

	)

49 
	#NFP_FL_SC_ACT_POPV
 0x6A000000

	)

50 
	#NFP_FL_SC_ACT_NULL
 0x00000000

	)

54 
	#NFP_FL_MAX_A_SIZ
 1216

	)

55 
	#NFP_FL_LW_SIZ
 2

	)

58 
	#NFP_FL_MAX_GENEVE_OPT_ACT
 32

	)

59 
	#NFP_FL_MAX_GENEVE_OPT_CNT
 64

	)

60 
	#NFP_FL_MAX_GENEVE_OPT_KEY
 32

	)

63 
	#NFP_FL_ACTION_OPCODE_OUTPUT
 0

	)

64 
	#NFP_FL_ACTION_OPCODE_PUSH_VLAN
 1

	)

65 
	#NFP_FL_ACTION_OPCODE_POP_VLAN
 2

	)

66 
	#NFP_FL_ACTION_OPCODE_SET_IPV4_TUNNEL
 6

	)

67 
	#NFP_FL_ACTION_OPCODE_SET_ETHERNET
 7

	)

68 
	#NFP_FL_ACTION_OPCODE_SET_IPV4_ADDRS
 9

	)

69 
	#NFP_FL_ACTION_OPCODE_SET_IPV4_TTL_TOS
 10

	)

70 
	#NFP_FL_ACTION_OPCODE_SET_IPV6_SRC
 11

	)

71 
	#NFP_FL_ACTION_OPCODE_SET_IPV6_DST
 12

	)

72 
	#NFP_FL_ACTION_OPCODE_SET_IPV6_TC_HL_FL
 13

	)

73 
	#NFP_FL_ACTION_OPCODE_SET_UDP
 14

	)

74 
	#NFP_FL_ACTION_OPCODE_SET_TCP
 15

	)

75 
	#NFP_FL_ACTION_OPCODE_PRE_LAG
 16

	)

76 
	#NFP_FL_ACTION_OPCODE_PRE_TUNNEL
 17

	)

77 
	#NFP_FL_ACTION_OPCODE_PUSH_GENEVE
 26

	)

78 
	#NFP_FL_ACTION_OPCODE_NUM
 32

	)

80 
	#NFP_FL_OUT_FLAGS_LAST
 
	`BIT
(15)

	)

81 
	#NFP_FL_OUT_FLAGS_USE_TUN
 
	`BIT
(4)

	)

82 
	#NFP_FL_OUT_FLAGS_TYPE_IDX
 
	`GENMASK
(2, 0)

	)

84 
	#NFP_FL_PUSH_VLAN_PRIO
 
	`GENMASK
(15, 13)

	)

85 
	#NFP_FL_PUSH_VLAN_VID
 
	`GENMASK
(11, 0)

	)

87 
	#IPV6_FLOW_LABEL_MASK
 
	`ýu_to_be32
(0x000fffff)

	)

90 
	#NFP_FL_LAG_OUT
 0xC0DE0000

	)

93 
	#NFP_FL_PORT_TYPE_TUN
 0x50000000

	)

94 
	#NFP_FL_IPV4_TUNNEL_TYPE
 
	`GENMASK
(7, 4)

	)

95 
	#NFP_FL_IPV4_PRE_TUN_INDEX
 
	`GENMASK
(2, 0)

	)

97 
	#NFP_FLOWER_WORKQ_MAX_SKBS
 30000

	)

100 
	#NFP_FL_REPLY_TIMEOUT
 
	`m£cs_to_jiff›s
(40)

	)

102 
	#nå_æow”_cmsg_w¬n
(
­p
, 
fmt
, 
¬gs
...) \

104 ià(
	`Ãt_¿‹lim™
()) \

105 
	`nå_w¬n
((
­p
)->
ýp
, 
fmt
, ## 
¬gs
); \

106 } 0)

	)

108 
	enå_æow”_tun_ty³
 {

109 
	mNFP_FL_TUNNEL_NONE
 = 0,

110 
	mNFP_FL_TUNNEL_VXLAN
 = 2,

111 
	mNFP_FL_TUNNEL_GENEVE
 = 4,

114 
	snå_æ_aù_h—d
 {

115 
u8
 
	mjump_id
;

116 
u8
 
	mËn_lw
;

119 
	snå_æ_£t_‘h
 {

120 
nå_æ_aù_h—d
 
	mh—d
;

121 
__be16
 
	m»£rved
;

122 
u8
 
	m‘h_addr_mask
[
ETH_ALEN
 * 2];

123 
u8
 
	m‘h_addr_v®
[
ETH_ALEN
 * 2];

126 
	snå_æ_£t_4_addrs
 {

127 
nå_æ_aù_h—d
 
	mh—d
;

128 
__be16
 
	m»£rved
;

129 
__be32
 
	mv4_¤c_mask
;

130 
__be32
 
	mv4_¤c
;

131 
__be32
 
	mv4_d¡_mask
;

132 
__be32
 
	mv4_d¡
;

135 
	snå_æ_£t_4_‰l_tos
 {

136 
nå_æ_aù_h—d
 
	mh—d
;

137 
u8
 
	mv4_‰l_mask
;

138 
u8
 
	mv4_tos_mask
;

139 
u8
 
	mv4_‰l
;

140 
u8
 
	mv4_tos
;

141 
__be16
 
	m»£rved
;

144 
	snå_æ_£t_v6_tc_hl_æ
 {

145 
nå_æ_aù_h—d
 
	mh—d
;

146 
u8
 
	mv6_tc_mask
;

147 
u8
 
	mv6_hÝ_lim™_mask
;

148 
__be16
 
	m»£rved
;

149 
u8
 
	mv6_tc
;

150 
u8
 
	mv6_hÝ_lim™
;

151 
__be32
 
	mv6_Ïb–_mask
;

152 
__be32
 
	mv6_Ïb–
;

155 
	snå_æ_£t_v6_addr
 {

156 
nå_æ_aù_h—d
 
	mh—d
;

157 
__be16
 
	m»£rved
;

159 
__be32
 
	mmask
;

160 
__be32
 
	mexaù
;

161 } 
	mv6
[4];

164 
	snå_æ_£t_Üt
 {

165 
nå_æ_aù_h—d
 
	mh—d
;

166 
__be16
 
	m»£rved
;

167 
u8
 
	m_pÜt_mask
[4];

168 
u8
 
	m_pÜt_v®
[4];

171 
	snå_æ_ouut
 {

172 
nå_æ_aù_h—d
 
	mh—d
;

173 
__be16
 
	mæags
;

174 
__be32
 
	mpÜt
;

177 
	snå_æ_push_vÏn
 {

178 
nå_æ_aù_h—d
 
	mh—d
;

179 
__be16
 
	m»£rved
;

180 
__be16
 
	mvÏn_id
;

181 
__be16
 
	mvÏn_tci
;

184 
	snå_æ_pÝ_vÏn
 {

185 
nå_æ_aù_h—d
 
	mh—d
;

186 
__be16
 
	m»£rved
;

189 
	snå_æ_´e_Ïg
 {

190 
nå_æ_aù_h—d
 
	mh—d
;

191 
__be16
 
	mgroup_id
;

192 
u8
 
	mÏg_v”siÚ
[3];

193 
u8
 
	mš¡ªû
;

196 
	#NFP_FL_PRE_LAG_VER_OFF
 8

	)

198 
	snå_æ_´e_tuÂ–
 {

199 
nå_æ_aù_h—d
 
	mh—d
;

200 
__be16
 
	m»£rved
;

201 
__be32
 
	mv4_d¡
;

203 
__be32
 
	mexŒa
[3];

206 
	snå_æ_£t_v4_udp_tun
 {

207 
nå_æ_aù_h—d
 
	mh—d
;

208 
__be16
 
	m»£rved
;

209 
__be64
 
tun_id
 
	m__·cked
;

210 
__be32
 
	mtun_ty³_šdex
;

211 
__be16
 
	mtun_æags
;

212 
u8
 
	m‰l
;

213 
u8
 
	mtos
;

214 
__be32
 
	mexŒa
;

215 
u8
 
	mtun_Ën
;

216 
u8
 
	m»s2
;

217 
__be16
 
	mtun_´Ùo
;

220 
	snå_æ_push_g’eve
 {

221 
nå_æ_aù_h—d
 
	mh—d
;

222 
__be16
 
	m»£rved
;

223 
__be16
 
	mþass
;

224 
u8
 
	mty³
;

225 
u8
 
	mËngth
;

226 
u8
 
	mÝt_d©a
[];

240 
	snå_æow”_m‘a_tci
 {

241 
u8
 
	mnå_æow_key_Ïy”
;

242 
u8
 
	mmask_id
;

243 
__be16
 
	mtci
;

254 
	snå_æow”_ext_m‘a
 {

255 
__be32
 
	mnå_æow_key_Ïy”2
;

266 
	snå_æow”_š_pÜt
 {

267 
__be32
 
	mš_pÜt
;

283 
	snå_æow”_mac_m¶s
 {

284 
u8
 
	mmac_d¡
[6];

285 
u8
 
	mmac_¤c
[6];

286 
__be32
 
	mm¶s_l£
;

296 
	snå_æow”__pÜts
 {

297 
__be16
 
	mpÜt_¤c
;

298 
__be16
 
	mpÜt_d¡
;

301 
	snå_æow”__ext
 {

302 
u8
 
	mtos
;

303 
u8
 
	m´Ùo
;

304 
u8
 
	m‰l
;

305 
u8
 
	mæags
;

319 
	snå_æow”_v4
 {

320 
nå_æow”__ext
 
	m_ext
;

321 
__be32
 
	mv4_¤c
;

322 
__be32
 
	mv4_d¡
;

350 
	snå_æow”_v6
 {

351 
nå_æow”__ext
 
	m_ext
;

352 
__be32
 
	mv6_æow_Ïb–_exthdr
;

353 
š6_addr
 
	mv6_¤c
;

354 
š6_addr
 
	mv6_d¡
;

373 
	snå_æow”_v4_udp_tun
 {

374 
__be32
 
	m_¤c
;

375 
__be32
 
	m_d¡
;

376 
__be16
 
	m»£rved1
;

377 
u8
 
	mtos
;

378 
u8
 
	m‰l
;

379 
__be32
 
	m»£rved2
;

380 
__be32
 
	mtun_id
;

383 
	snå_æow”_g’eve_ÝtiÚs
 {

384 
u8
 
	md©a
[
NFP_FL_MAX_GENEVE_OPT_KEY
];

387 
	#NFP_FL_TUN_VNI_OFFSET
 8

	)

393 
	snå_æow”_cmsg_hdr
 {

394 
__be16
 
	m·d
;

395 
u8
 
	mty³
;

396 
u8
 
	mv”siÚ
;

399 
	#NFP_FLOWER_CMSG_HLEN
 (
nå_æow”_cmsg_hdr
)

	)

400 
	#NFP_FLOWER_CMSG_VER1
 1

	)

403 
	enå_æow”_cmsg_ty³_pÜt
 {

404 
	mNFP_FLOWER_CMSG_TYPE_FLOW_ADD
 = 0,

405 
	mNFP_FLOWER_CMSG_TYPE_FLOW_DEL
 = 2,

406 
	mNFP_FLOWER_CMSG_TYPE_LAG_CONFIG
 = 4,

407 
	mNFP_FLOWER_CMSG_TYPE_PORT_REIFY
 = 6,

408 
	mNFP_FLOWER_CMSG_TYPE_MAC_REPR
 = 7,

409 
	mNFP_FLOWER_CMSG_TYPE_PORT_MOD
 = 8,

410 
	mNFP_FLOWER_CMSG_TYPE_NO_NEIGH
 = 10,

411 
	mNFP_FLOWER_CMSG_TYPE_TUN_MAC
 = 11,

412 
	mNFP_FLOWER_CMSG_TYPE_ACTIVE_TUNS
 = 12,

413 
	mNFP_FLOWER_CMSG_TYPE_TUN_NEIGH
 = 13,

414 
	mNFP_FLOWER_CMSG_TYPE_TUN_IPS
 = 14,

415 
	mNFP_FLOWER_CMSG_TYPE_FLOW_STATS
 = 15,

416 
	mNFP_FLOWER_CMSG_TYPE_PORT_ECHO
 = 16,

417 
	mNFP_FLOWER_CMSG_TYPE_MAX
 = 32,

421 
	snå_æow”_cmsg_mac_»´
 {

422 
u8
 
	m»£rved
[3];

423 
u8
 
	mnum_pÜts
;

425 
u8
 
	midx
;

426 
u8
 
	mšfo
;

427 
u8
 
	mnbi_pÜt
;

428 
u8
 
	mphys_pÜt
;

429 } 
	mpÜts
[0];

432 
	#NFP_FLOWER_CMSG_MAC_REPR_NBI
 
	`GENMASK
(1, 0)

	)

435 
	snå_æow”_cmsg_pÜtmod
 {

436 
__be32
 
	mpÜŠum
;

437 
u8
 
	m»£rved
;

438 
u8
 
	mšfo
;

439 
__be16
 
	mmtu
;

442 
	#NFP_FLOWER_CMSG_PORTMOD_INFO_LINK
 
	`BIT
(0)

	)

443 
	#NFP_FLOWER_CMSG_PORTMOD_MTU_CHANGE_ONLY
 
	`BIT
(1)

	)

446 
	snå_æow”_cmsg_pÜŒeify
 {

447 
__be32
 
	mpÜŠum
;

448 
u16
 
	m»£rved
;

449 
__be16
 
	mšfo
;

452 
	#NFP_FLOWER_CMSG_PORTREIFY_INFO_EXIST
 
	`BIT
(0)

	)

454 
	enå_æow”_cmsg_pÜt_ty³
 {

455 
	mNFP_FLOWER_CMSG_PORT_TYPE_UNSPEC
 = 0x0,

456 
	mNFP_FLOWER_CMSG_PORT_TYPE_PHYS_PORT
 = 0x1,

457 
	mNFP_FLOWER_CMSG_PORT_TYPE_PCIE_PORT
 = 0x2,

458 
	mNFP_FLOWER_CMSG_PORT_TYPE_OTHER_PORT
 = 0x3,

461 
	enå_æow”_cmsg_pÜt_vnic_ty³
 {

462 
	mNFP_FLOWER_CMSG_PORT_VNIC_TYPE_VF
 = 0x0,

463 
	mNFP_FLOWER_CMSG_PORT_VNIC_TYPE_PF
 = 0x1,

464 
	mNFP_FLOWER_CMSG_PORT_VNIC_TYPE_CTRL
 = 0x2,

467 
	#NFP_FLOWER_CMSG_PORT_TYPE
 
	`GENMASK
(31, 28)

	)

468 
	#NFP_FLOWER_CMSG_PORT_SYS_ID
 
	`GENMASK
(27, 24)

	)

469 
	#NFP_FLOWER_CMSG_PORT_NFP_ID
 
	`GENMASK
(23, 22)

	)

470 
	#NFP_FLOWER_CMSG_PORT_PCI
 
	`GENMASK
(15, 14)

	)

471 
	#NFP_FLOWER_CMSG_PORT_VNIC_TYPE
 
	`GENMASK
(13, 12)

	)

472 
	#NFP_FLOWER_CMSG_PORT_VNIC
 
	`GENMASK
(11, 6)

	)

473 
	#NFP_FLOWER_CMSG_PORT_PCIE_Q
 
	`GENMASK
(5, 0)

	)

474 
	#NFP_FLOWER_CMSG_PORT_PHYS_PORT_NUM
 
	`GENMASK
(7, 0)

	)

476 
šlše
 
u32
 
	$nå_æow”_cmsg_phys_pÜt
(
u8
 
phys_pÜt
)

478  
	`FIELD_PREP
(
NFP_FLOWER_CMSG_PORT_PHYS_PORT_NUM
, 
phys_pÜt
) |

479 
	`FIELD_PREP
(
NFP_FLOWER_CMSG_PORT_TYPE
,

480 
NFP_FLOWER_CMSG_PORT_TYPE_PHYS_PORT
);

481 
	}
}

483 
šlše
 
u32


484 
	$nå_æow”_cmsg_pc›_pÜt
(
u8
 
nå_pc›
, 
nå_æow”_cmsg_pÜt_vnic_ty³
 
ty³
,

485 
u8
 
vnic
, u8 
q
)

487  
	`FIELD_PREP
(
NFP_FLOWER_CMSG_PORT_PCI
, 
nå_pc›
) |

488 
	`FIELD_PREP
(
NFP_FLOWER_CMSG_PORT_VNIC_TYPE
, 
ty³
) |

489 
	`FIELD_PREP
(
NFP_FLOWER_CMSG_PORT_VNIC
, 
vnic
) |

490 
	`FIELD_PREP
(
NFP_FLOWER_CMSG_PORT_PCIE_Q
, 
q
) |

491 
	`FIELD_PREP
(
NFP_FLOWER_CMSG_PORT_TYPE
,

492 
NFP_FLOWER_CMSG_PORT_TYPE_PCIE_PORT
);

493 
	}
}

495 
šlše
 *
	$nå_æow”_cmsg_g‘_d©a
(
sk_buff
 *
skb
)

497  (*)
skb
->
d©a
 + 
NFP_FLOWER_CMSG_HLEN
;

498 
	}
}

500 
šlše
 
	$nå_æow”_cmsg_g‘_d©a_Ën
(
sk_buff
 *
skb
)

502  
skb
->
Ën
 - 
NFP_FLOWER_CMSG_HLEN
;

503 
	}
}

505 
šlše
 
boÞ


506 
	$nå_æ_Ãtdev_is_tuÂ–_ty³
(
Ãt_deviû
 *
Ãtdev
,

507 
nå_æow”_tun_ty³
 
tun_ty³
)

509 ià(
	`Ãtif_is_vxÏn
(
Ãtdev
))

510  
tun_ty³
 =ð
NFP_FL_TUNNEL_VXLAN
;

511 ià(
	`Ãtif_is_g’eve
(
Ãtdev
))

512  
tun_ty³
 =ð
NFP_FL_TUNNEL_GENEVE
;

514  
çl£
;

515 
	}
}

517 
šlše
 
boÞ
 
	$nå_æ_is_Ãtdev_to_ofæßd
(
Ãt_deviû
 *
Ãtdev
)

519 ià(!
Ãtdev
->
¹Æ_lšk_Ýs
)

520  
çl£
;

521 ià(!
	`¡rcmp
(
Ãtdev
->
¹Æ_lšk_Ýs
->
kšd
, "openvswitch"))

522  
Œue
;

523 ià(
	`Ãtif_is_vxÏn
(
Ãtdev
))

524  
Œue
;

525 ià(
	`Ãtif_is_g’eve
(
Ãtdev
))

526  
Œue
;

528  
çl£
;

529 
	}
}

531 
sk_buff
 *

532 
nå_æow”_cmsg_mac_»´_¡¬t
(
nå_­p
 *
­p
, 
num_pÜts
);

534 
nå_æow”_cmsg_mac_»´_add
(
sk_buff
 *
skb
, 
idx
,

535 
nbi
, 
nbi_pÜt
,

536 
phys_pÜt
);

537 
nå_æow”_cmsg_pÜtmod
(
nå_»´
 *
»´
, 
boÞ
 
ÿ¼›r_ok
,

538 
mtu
, 
boÞ
 
mtu_Úly
);

539 
nå_æow”_cmsg_pÜŒeify
(
nå_»´
 *
»´
, 
boÞ
 
exi¡s
);

540 
nå_æow”_cmsg_´oûss_rx
(
wÜk_¡ruù
 *
wÜk
);

541 
nå_æow”_cmsg_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
);

542 
sk_buff
 *

543 
nå_æow”_cmsg_®loc
(
nå_­p
 *
­p
, 
size
,

544 
nå_æow”_cmsg_ty³_pÜt
 
ty³
, 
gå_t
 
æag
);

	@src/flower/lag_conf.c

4 
	~"../nå_Ãt_com·t.h
"

6 
	~"maš.h
"

9 
	#NFP_FL_LAG_LAST
 
	`BIT
(1)

	)

10 
	#NFP_FL_LAG_FIRST
 
	`BIT
(2)

	)

11 
	#NFP_FL_LAG_DATA
 
	`BIT
(3)

	)

12 
	#NFP_FL_LAG_XON
 
	`BIT
(4)

	)

13 
	#NFP_FL_LAG_SYNC
 
	`BIT
(5)

	)

14 
	#NFP_FL_LAG_SWITCH
 
	`BIT
(6)

	)

15 
	#NFP_FL_LAG_RESET
 
	`BIT
(7)

	)

18 
	#NFP_PORT_LAG_LINK_UP
 
	`BIT
(0)

	)

19 
	#NFP_PORT_LAG_TX_ENABLED
 
	`BIT
(1)

	)

20 
	#NFP_PORT_LAG_CHANGED
 
	`BIT
(2)

	)

22 
	enå_æ_Ïg_b©ch
 {

23 
	mNFP_FL_LAG_BATCH_FIRST
,

24 
	mNFP_FL_LAG_BATCH_MEMBER
,

25 
	mNFP_FL_LAG_BATCH_FINISHED


39 
	snå_æow”_cmsg_Ïg_cÚfig
 {

40 
u8
 
	mù¾_æags
;

41 
u8
 
	m»£rved
[2];

42 
u8
 
	m‰l
;

43 
__be32
 
	mpkt_numb”
;

44 
__be32
 
	mb©ch_v”
;

45 
__be32
 
	mgroup_id
;

46 
__be32
 
	mgroup_š¡
;

47 
__be32
 
	mmemb”s
[];

62 
	snå_æ_Ïg_group
 {

63 
	mgroup_id
;

64 
u8
 
	mgroup_š¡
;

65 
li¡_h—d
 
	mli¡
;

66 
Ãt_deviû
 *
	mma¡”_ndev
;

67 
boÞ
 
	mdœty
;

68 
boÞ
 
	mofæßded
;

69 
boÞ
 
	mto_»move
;

70 
boÞ
 
	mto_de¡roy
;

71 
	m¦ave_út
;

74 
	#NFP_FL_LAG_PKT_NUMBER_MASK
 
	`GENMASK
(30, 0)

	)

75 
	#NFP_FL_LAG_VERSION_MASK
 
	`GENMASK
(22, 0)

	)

76 
	#NFP_FL_LAG_HOST_TTL
 0xff

	)

79 
	#NFP_FL_LAG_SYNC_ID
 0

	)

80 
	#NFP_FL_LAG_GROUP_MIN
 1

	)

81 
	#NFP_FL_LAG_GROUP_MAX
 32

	)

84 
	#NFP_FL_LAG_DELAY
 (
	`m£cs_to_jiff›s
(2))

	)

86 
	#NFP_FL_LAG_RETRANS_LIMIT
 100

	)

88 
	$nå_æ_g‘_Ãxt_pkt_numb”
(
nå_æ_Ïg
 *
Ïg
)

90 
Ïg
->
pkt_num
++;

91 
Ïg
->
pkt_num
 &ð
NFP_FL_LAG_PKT_NUMBER_MASK
;

93  
Ïg
->
pkt_num
;

94 
	}
}

96 
	$nå_æ_šüem’t_v”siÚ
(
nå_æ_Ïg
 *
Ïg
)

99 
Ïg
->
b©ch_v”
 += 2;

100 
Ïg
->
b©ch_v”
 &ð
NFP_FL_LAG_VERSION_MASK
;

103 ià(!
Ïg
->
b©ch_v”
)

104 
Ïg
->
b©ch_v”
 += 2;

105 
	}
}

107 
nå_æ_Ïg_group
 *

108 
	$nå_æ_Ïg_group_ü—‹
(
nå_æ_Ïg
 *
Ïg
, 
Ãt_deviû
 *
ma¡”
)

110 
nå_æ_Ïg_group
 *
group
;

111 
nå_æow”_´iv
 *
´iv
;

112 
id
;

114 
´iv
 = 
	`cÚš”_of
(
Ïg
, 
nå_æow”_´iv
, 
nå_Ïg
);

116 
id
 = 
	`ida_sim¶e_g‘
(&
Ïg
->
ida_hªdË
, 
NFP_FL_LAG_GROUP_MIN
,

117 
NFP_FL_LAG_GROUP_MAX
, 
GFP_KERNEL
);

118 ià(
id
 < 0) {

119 
	`nå_æow”_cmsg_w¬n
(
´iv
->
­p
,

121  
	`ERR_PTR
(
id
);

124 
group
 = 
	`km®loc
((*group), 
GFP_KERNEL
);

125 ià(!
group
) {

126 
	`ida_sim¶e_»move
(&
Ïg
->
ida_hªdË
, 
id
);

127  
	`ERR_PTR
(-
ENOMEM
);

130 
group
->
group_id
 = 
id
;

131 
group
->
ma¡”_ndev
 = 
ma¡”
;

132 
group
->
dœty
 = 
Œue
;

133 
group
->
ofæßded
 = 
çl£
;

134 
group
->
to_»move
 = 
çl£
;

135 
group
->
to_de¡roy
 = 
çl£
;

136 
group
->
¦ave_út
 = 0;

137 
group
->
group_š¡
 = ++
Ïg
->
glob®_š¡
;

138 
	`li¡_add_ž
(&
group
->
li¡
, &
Ïg
->
group_li¡
);

140  
group
;

141 
	}
}

143 
nå_æ_Ïg_group
 *

144 
	$nå_æ_Ïg_fšd_group_fÜ_ma¡”_w™h_Ïg
(
nå_æ_Ïg
 *
Ïg
,

145 
Ãt_deviû
 *
ma¡”
)

147 
nå_æ_Ïg_group
 *
’Œy
;

149 ià(!
ma¡”
)

150  
NULL
;

152 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
Ïg
->
group_li¡
, 
li¡
)

153 ià(
’Œy
->
ma¡”_ndev
 =ð
ma¡”
)

154  
’Œy
;

156  
NULL
;

157 
	}
}

159 
	$nå_æow”_Ïg_pÝuÏ‹_´e_aùiÚ
(
nå_­p
 *
­p
,

160 
Ãt_deviû
 *
ma¡”
,

161 
nå_æ_´e_Ïg
 *
´e_aù
)

163 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

164 
nå_æ_Ïg_group
 *
group
 = 
NULL
;

165 
__be32
 
‹mp_v”s
;

167 
	`mu‹x_lock
(&
´iv
->
nå_Ïg
.
lock
);

168 
group
 = 
	`nå_æ_Ïg_fšd_group_fÜ_ma¡”_w™h_Ïg
(&
´iv
->
nå_Ïg
,

169 
ma¡”
);

170 ià(!
group
) {

171 
	`mu‹x_uÆock
(&
´iv
->
nå_Ïg
.
lock
);

172  -
ENOENT
;

175 
´e_aù
->
group_id
 = 
	`ýu_to_be16
(
group
->group_id);

176 
‹mp_v”s
 = 
	`ýu_to_be32
(
´iv
->
nå_Ïg
.
b©ch_v”
 <<

177 
NFP_FL_PRE_LAG_VER_OFF
);

178 
	`memýy
(
´e_aù
->
Ïg_v”siÚ
, &
‹mp_v”s
, 3);

179 
´e_aù
->
š¡ªû
 = 
group
->
group_š¡
;

180 
	`mu‹x_uÆock
(&
´iv
->
nå_Ïg
.
lock
);

183 
	}
}

185 
	$nå_æow”_Ïg_g‘_ouut_id
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
ma¡”
)

187 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

188 
nå_æ_Ïg_group
 *
group
 = 
NULL
;

189 
group_id
 = -
ENOENT
;

191 
	`mu‹x_lock
(&
´iv
->
nå_Ïg
.
lock
);

192 
group
 = 
	`nå_æ_Ïg_fšd_group_fÜ_ma¡”_w™h_Ïg
(&
´iv
->
nå_Ïg
,

193 
ma¡”
);

194 ià(
group
)

195 
group_id
 = 
group
->group_id;

196 
	`mu‹x_uÆock
(&
´iv
->
nå_Ïg
.
lock
);

198  
group_id
;

199 
	}
}

202 
	$nå_æ_Ïg_cÚfig_group
(
nå_æ_Ïg
 *
Ïg
, 
nå_æ_Ïg_group
 *
group
,

203 
Ãt_deviû
 **
aùive_memb”s
,

204 
memb”_út
, 
nå_æ_Ïg_b©ch
 *
b©ch
)

206 
nå_æow”_cmsg_Ïg_cÚfig
 *
cmsg_·ylßd
;

207 
nå_æow”_´iv
 *
´iv
;

208 
æags
;

209 
size
, 
i
;

210 
sk_buff
 *
skb
;

212 
´iv
 = 
	`cÚš”_of
(
Ïg
, 
nå_æow”_´iv
, 
nå_Ïg
);

213 
size
 = (*
cmsg_·ylßd
è+ (
__be32
è* 
memb”_út
;

214 
skb
 = 
	`nå_æow”_cmsg_®loc
(
´iv
->
­p
, 
size
,

215 
NFP_FLOWER_CMSG_TYPE_LAG_CONFIG
,

216 
GFP_KERNEL
);

217 ià(!
skb
)

218  -
ENOMEM
;

220 
cmsg_·ylßd
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

221 
æags
 = 0;

224 ià(*
b©ch
 =ð
NFP_FL_LAG_BATCH_FIRST
) {

225 
æags
 |ð
NFP_FL_LAG_FIRST
;

226 
	`nå_æ_šüem’t_v”siÚ
(
Ïg
);

227 *
b©ch
 = 
NFP_FL_LAG_BATCH_MEMBER
;

231 ià(
Ïg
->
r¡_cfg
) {

232 
æags
 |ð
NFP_FL_LAG_RESET
;

233 *
b©ch
 = 
NFP_FL_LAG_BATCH_FINISHED
;

239 ià(*
b©ch
 =ð
NFP_FL_LAG_BATCH_FINISHED
) {

240 
æags
 |ð
NFP_FL_LAG_SWITCH
 | 
NFP_FL_LAG_LAST
;

241 
Ïg
->
r¡_cfg
 = 
çl£
;

242 
cmsg_·ylßd
->
group_id
 = 
	`ýu_to_be32
(
NFP_FL_LAG_SYNC_ID
);

243 
cmsg_·ylßd
->
group_š¡
 = 0;

245 
cmsg_·ylßd
->
group_id
 = 
	`ýu_to_be32
(
group
->group_id);

246 
cmsg_·ylßd
->
group_š¡
 = 
	`ýu_to_be32
(
group
->group_inst);

249 
cmsg_·ylßd
->
»£rved
[0] = 0;

250 
cmsg_·ylßd
->
»£rved
[1] = 0;

251 
cmsg_·ylßd
->
‰l
 = 
NFP_FL_LAG_HOST_TTL
;

252 
cmsg_·ylßd
->
ù¾_æags
 = 
æags
;

253 
cmsg_·ylßd
->
b©ch_v”
 = 
	`ýu_to_be32
(
Ïg
->batch_ver);

254 
cmsg_·ylßd
->
pkt_numb”
 = 
	`ýu_to_be32
(
	`nå_æ_g‘_Ãxt_pkt_numb”
(
Ïg
));

256 
i
 = 0; i < 
memb”_út
; i++)

257 
cmsg_·ylßd
->
memb”s
[
i
] =

258 
	`ýu_to_be32
(
	`nå_»´_g‘_pÜt_id
(
aùive_memb”s
[
i
]));

260 
	`nå_ù¾_tx
(
´iv
->
­p
->
ù¾
, 
skb
);

262 
	}
}

264 
	$nå_æ_Ïg_do_wÜk
(
wÜk_¡ruù
 *
wÜk
)

266 
nå_æ_Ïg_b©ch
 
b©ch
 = 
NFP_FL_LAG_BATCH_FIRST
;

267 
nå_æ_Ïg_group
 *
’Œy
, *
¡Üage
;

268 
d–ayed_wÜk
 *delayed_work;

269 
nå_æow”_´iv
 *
´iv
;

270 
nå_æ_Ïg
 *
Ïg
;

271 
”r
;

273 
d–ayed_wÜk
 = 
	`to_d–ayed_wÜk
(
wÜk
);

274 
Ïg
 = 
	`cÚš”_of
(
d–ayed_wÜk
, 
nå_æ_Ïg
, 
wÜk
);

275 
´iv
 = 
	`cÚš”_of
(
Ïg
, 
nå_æow”_´iv
, 
nå_Ïg
);

277 
	`mu‹x_lock
(&
Ïg
->
lock
);

278 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
¡Üage
, &
Ïg
->
group_li¡
, 
li¡
) {

279 
Ãt_deviû
 *
™”_Ãtdev
, **
aùi_Ãtdevs
;

280 
nå_æow”_»´_´iv
 *
»´_´iv
;

281 
aùive_couÁ
 = 0, 
¦aves
 = 0;

282 
nå_»´
 *
»´
;

283 *
æags
;

285 ià(
’Œy
->
to_»move
) {

287 
”r
 = 
	`nå_æ_Ïg_cÚfig_group
(
Ïg
, 
’Œy
, 
NULL
, 0,

288 &
b©ch
);

289 ià(!
”r
) {

290 
’Œy
->
to_»move
 = 
çl£
;

291 
’Œy
->
ofæßded
 = 
çl£
;

293 
	`nå_æow”_cmsg_w¬n
(
´iv
->
­p
,

295 
	`scheduË_d–ayed_wÜk
(&
Ïg
->
wÜk
,

296 
NFP_FL_LAG_DELAY
);

300 ià(
’Œy
->
to_de¡roy
) {

301 
	`ida_sim¶e_»move
(&
Ïg
->
ida_hªdË
,

302 
’Œy
->
group_id
);

303 
	`li¡_d–
(&
’Œy
->
li¡
);

304 
	`kä“
(
’Œy
);

309 
aùi_Ãtdevs
 = 
	`km®loc_¬¿y
(
’Œy
->
¦ave_út
,

310 (*
aùi_Ãtdevs
), 
GFP_KERNEL
);

318 
	`rcu_»ad_lock
();

319 
	`fÜ_—ch_Ãtdev_š_bÚd_rcu
(
’Œy
->
ma¡”_ndev
, 
™”_Ãtdev
) {

320 ià(!
	`nå_Ãtdev_is_nå_»´
(
™”_Ãtdev
)) {

321 
¦aves
 = 0;

325 
»´
 = 
	`Ãtdev_´iv
(
™”_Ãtdev
);

327 ià(
»´
->
­p
 !ð
´iv
->app) {

328 
¦aves
 = 0;

332 
¦aves
++;

333 ià(
¦aves
 > 
’Œy
->
¦ave_út
)

337 
»´_´iv
 = 
»´
->
­p_´iv
;

338 
æags
 = &
»´_´iv
->
Ïg_pÜt_æags
;

340 ià(*
æags
 & 
NFP_PORT_LAG_CHANGED
) {

341 *
æags
 &ð~
NFP_PORT_LAG_CHANGED
;

342 
’Œy
->
dœty
 = 
Œue
;

345 ià((*
æags
 & 
NFP_PORT_LAG_TX_ENABLED
) &&

346 (*
æags
 & 
NFP_PORT_LAG_LINK_UP
))

347 
aùi_Ãtdevs
[
aùive_couÁ
++] = 
™”_Ãtdev
;

349 
	`rcu_»ad_uÆock
();

351 ià(
¦aves
 !ð
’Œy
->
¦ave_út
 || !’Œy->
dœty
) {

352 
	`kä“
(
aùi_Ãtdevs
);

356 
”r
 = 
	`nå_æ_Ïg_cÚfig_group
(
Ïg
, 
’Œy
, 
aùi_Ãtdevs
,

357 
aùive_couÁ
, &
b©ch
);

358 ià(!
”r
) {

359 
’Œy
->
ofæßded
 = 
Œue
;

360 
’Œy
->
dœty
 = 
çl£
;

362 
	`nå_æow”_cmsg_w¬n
(
´iv
->
­p
,

364 
	`scheduË_d–ayed_wÜk
(&
Ïg
->
wÜk
, 
NFP_FL_LAG_DELAY
);

367 
	`kä“
(
aùi_Ãtdevs
);

371 ià(
b©ch
 =ð
NFP_FL_LAG_BATCH_MEMBER
) {

372 
b©ch
 = 
NFP_FL_LAG_BATCH_FINISHED
;

373 
”r
 = 
	`nå_æ_Ïg_cÚfig_group
(
Ïg
, 
NULL
, NULL, 0, &
b©ch
);

374 ià(
”r
)

375 
	`nå_æow”_cmsg_w¬n
(
´iv
->
­p
,

379 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

380 
	}
}

383 
	$nå_æ_Ïg_put_uÅroûs£d
(
nå_æ_Ïg
 *
Ïg
, 
sk_buff
 *
skb
)

385 
nå_æow”_cmsg_Ïg_cÚfig
 *
cmsg_·ylßd
;

387 
cmsg_·ylßd
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

388 ià(
	`be32_to_ýu
(
cmsg_·ylßd
->
group_id
è>ð
NFP_FL_LAG_GROUP_MAX
)

389  -
EINVAL
;

395 ià(
	`skb_queue_Ën
(&
Ïg
->
»Œªs_skbs
è>ð
NFP_FL_LAG_RETRANS_LIMIT
)

396  -
ENOSPC
;

398 
	`__skb_queue_ž
(&
Ïg
->
»Œªs_skbs
, 
skb
);

401 
	}
}

403 
	$nå_æ_£nd_uÅroûs£d
(
nå_æ_Ïg
 *
Ïg
)

405 
nå_æow”_´iv
 *
´iv
;

406 
sk_buff
 *
skb
;

408 
´iv
 = 
	`cÚš”_of
(
Ïg
, 
nå_æow”_´iv
, 
nå_Ïg
);

410 (
skb
 = 
	`__skb_dequeue
(&
Ïg
->
»Œªs_skbs
)))

411 
	`nå_ù¾_tx
(
´iv
->
­p
->
ù¾
, 
skb
);

412 
	}
}

414 
boÞ
 
	$nå_æow”_Ïg_uÅroûs£d_msg
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

416 
nå_æow”_cmsg_Ïg_cÚfig
 *
cmsg_·ylßd
;

417 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

418 
nå_æ_Ïg_group
 *
group_’Œy
;

419 
æags
;

420 
boÞ
 
¡Üe_skb
 = 
çl£
;

421 
”r
;

423 
cmsg_·ylßd
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

424 
æags
 = 
cmsg_·ylßd
->
ù¾_æags
;

432 ià(
æags
 & 
NFP_FL_LAG_DATA
)

433 ià(!
	`nå_æ_Ïg_put_uÅroûs£d
(&
´iv
->
nå_Ïg
, 
skb
))

434 
¡Üe_skb
 = 
Œue
;

437 ià(
æags
 & 
NFP_FL_LAG_XON
)

438 
	`nå_æ_£nd_uÅroûs£d
(&
´iv
->
nå_Ïg
);

441 ià(
æags
 & 
NFP_FL_LAG_SYNC
) {

449 
	`__skb_queue_purge
(&
´iv
->
nå_Ïg
.
»Œªs_skbs
);

451 
	`mu‹x_lock
(&
´iv
->
nå_Ïg
.
lock
);

452 
	`li¡_fÜ_—ch_’Œy
(
group_’Œy
, &
´iv
->
nå_Ïg
.
group_li¡
,

453 
li¡
)

454 
group_’Œy
->
dœty
 = 
Œue
;

456 
”r
 = 
	`nå_æow”_Ïg_»£t
(&
´iv
->
nå_Ïg
);

457 ià(
”r
)

458 
	`nå_æow”_cmsg_w¬n
(
´iv
->
­p
,

460 
	`mu‹x_uÆock
(&
´iv
->
nå_Ïg
.
lock
);

462 
	`scheduË_d–ayed_wÜk
(&
´iv
->
nå_Ïg
.
wÜk
, 0);

465  
¡Üe_skb
;

466 
	}
}

469 
	$nå_æ_Ïg_scheduË_group_»move
(
nå_æ_Ïg
 *
Ïg
,

470 
nå_æ_Ïg_group
 *
group
)

472 
group
->
to_»move
 = 
Œue
;

474 
	`scheduË_d–ayed_wÜk
(&
Ïg
->
wÜk
, 
NFP_FL_LAG_DELAY
);

475 
	}
}

478 
	$nå_æ_Ïg_scheduË_group_d–‘e
(
nå_æ_Ïg
 *
Ïg
,

479 
Ãt_deviû
 *
ma¡”
)

481 
nå_æ_Ïg_group
 *
group
;

482 
nå_æow”_´iv
 *
´iv
;

484 
´iv
 = 
	`cÚš”_of
(
Ïg
, 
nå_æow”_´iv
, 
nå_Ïg
);

486 ià(!
	`Ãtif_is_bÚd_ma¡”
(
ma¡”
))

489 
	`mu‹x_lock
(&
Ïg
->
lock
);

490 
group
 = 
	`nå_æ_Ïg_fšd_group_fÜ_ma¡”_w™h_Ïg
(
Ïg
, 
ma¡”
);

491 ià(!
group
) {

492 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

493 
	`nå_w¬n
(
´iv
->
­p
->
ýp
, "untracked bond got unregistered %s\n",

494 
	`Ãtdev_Çme
(
ma¡”
));

498 
group
->
to_»move
 = 
Œue
;

499 
group
->
to_de¡roy
 = 
Œue
;

500 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

502 
	`scheduË_d–ayed_wÜk
(&
Ïg
->
wÜk
, 
NFP_FL_LAG_DELAY
);

503 
	}
}

506 
	$nå_æ_Ïg_chªgeuµ”_ev’t
(
nå_æ_Ïg
 *
Ïg
,

507 
Ãtdev_nÙif›r_chªgeuµ”_šfo
 *
šfo
)

509 
Ãt_deviû
 *
uµ”
 = 
šfo
->
uµ”_dev
, *
™”_Ãtdev
;

510 
Ãtdev_Ïg_uµ”_šfo
 *
Ïg_uµ”_šfo
;

511 
nå_æ_Ïg_group
 *
group
;

512 
nå_æow”_´iv
 *
´iv
;

513 
¦ave_couÁ
 = 0;

514 
boÞ
 
ÿn_ofæßd
 = 
Œue
;

515 
nå_»´
 *
»´
;

517 ià(!
	`Ãtif_is_Ïg_ma¡”
(
uµ”
))

520 
´iv
 = 
	`cÚš”_of
(
Ïg
, 
nå_æow”_´iv
, 
nå_Ïg
);

522 
	`rcu_»ad_lock
();

523 
	`fÜ_—ch_Ãtdev_š_bÚd_rcu
(
uµ”
, 
™”_Ãtdev
) {

524 ià(!
	`nå_Ãtdev_is_nå_»´
(
™”_Ãtdev
)) {

525 
ÿn_ofæßd
 = 
çl£
;

528 
»´
 = 
	`Ãtdev_´iv
(
™”_Ãtdev
);

531 ià(
»´
->
­p
 !ð
´iv
->app) {

532 
ÿn_ofæßd
 = 
çl£
;

536 
¦ave_couÁ
++;

538 
	`rcu_»ad_uÆock
();

540 
Ïg_uµ”_šfo
 = 
šfo
->
uµ”_šfo
;

542 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 18, 0)

544 ià(
Ïg_uµ”_šfo
 &&

545 
Ïg_uµ”_šfo
->
tx_ty³
 !ð
NETDEV_LAG_TX_TYPE_ACTIVEBACKUP
 &&

546 (
Ïg_uµ”_šfo
->
tx_ty³
 !ð
NETDEV_LAG_TX_TYPE_HASH
 ||

547 (
Ïg_uµ”_šfo
->
hash_ty³
 !ð
NETDEV_LAG_HASH_L34
 &&

548 
Ïg_uµ”_šfo
->
hash_ty³
 !ð
NETDEV_LAG_HASH_E34
 &&

549 
Ïg_uµ”_šfo
->
hash_ty³
 !ð
NETDEV_LAG_HASH_UNKNOWN
))) {

550 
ÿn_ofæßd
 = 
çl£
;

551 
	`nå_æow”_cmsg_w¬n
(
´iv
->
­p
,

553 
Ïg_uµ”_šfo
->
tx_ty³
,

554 
Ïg_uµ”_šfo
->
hash_ty³
);

557 ià(
Ïg_uµ”_šfo
 &&

558 
Ïg_uµ”_šfo
->
tx_ty³
 !ð
NETDEV_LAG_TX_TYPE_ACTIVEBACKUP
 &&

559 
Ïg_uµ”_šfo
->
tx_ty³
 !ð
NETDEV_LAG_TX_TYPE_HASH
) {

560 
ÿn_ofæßd
 = 
çl£
;

561 
	`nå_æow”_cmsg_w¬n
(
´iv
->
­p
,

563 
Ïg_uµ”_šfo
->
tx_ty³
);

567 
	`mu‹x_lock
(&
Ïg
->
lock
);

568 
group
 = 
	`nå_æ_Ïg_fšd_group_fÜ_ma¡”_w™h_Ïg
(
Ïg
, 
uµ”
);

570 ià(
¦ave_couÁ
 =ð0 || !
ÿn_ofæßd
) {

572 ià(
group
 && group->
ofæßded
)

573 
	`nå_æ_Ïg_scheduË_group_»move
(
Ïg
, 
group
);

575 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

579 ià(!
group
) {

580 
group
 = 
	`nå_æ_Ïg_group_ü—‹
(
Ïg
, 
uµ”
);

581 ià(
	`IS_ERR
(
group
)) {

582 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

583  
	`PTR_ERR
(
group
);

587 
group
->
dœty
 = 
Œue
;

588 
group
->
¦ave_út
 = 
¦ave_couÁ
;

591 
group
->
to_»move
 = 
çl£
;

592 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

594 
	`scheduË_d–ayed_wÜk
(&
Ïg
->
wÜk
, 
NFP_FL_LAG_DELAY
);

596 
	}
}

599 
	$nå_æ_Ïg_chªg–s_ev’t
(
nå_æ_Ïg
 *
Ïg
, 
Ãt_deviû
 *
Ãtdev
,

600 
Ãtdev_nÙif›r_chªg–ow”¡©e_šfo
 *
šfo
)

602 
Ãtdev_Ïg_low”_¡©e_šfo
 *
Ïg_low”_šfo
;

603 
nå_æow”_»´_´iv
 *
»´_´iv
;

604 
nå_æow”_´iv
 *
´iv
;

605 
nå_»´
 *
»´
;

606 *
æags
;

608 ià(!
	`Ãtif_is_Ïg_pÜt
(
Ãtdev
è|| !
	`nå_Ãtdev_is_nå_»´
(netdev))

611 
Ïg_low”_šfo
 = 
šfo
->
low”_¡©e_šfo
;

612 ià(!
Ïg_low”_šfo
)

615 
´iv
 = 
	`cÚš”_of
(
Ïg
, 
nå_æow”_´iv
, 
nå_Ïg
);

616 
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

619 ià(
»´
->
­p
 !ð
´iv
->app)

622 
»´_´iv
 = 
»´
->
­p_´iv
;

623 
æags
 = &
»´_´iv
->
Ïg_pÜt_æags
;

625 
	`mu‹x_lock
(&
Ïg
->
lock
);

626 ià(
Ïg_low”_šfo
->
lšk_up
)

627 *
æags
 |ð
NFP_PORT_LAG_LINK_UP
;

629 *
æags
 &ð~
NFP_PORT_LAG_LINK_UP
;

631 ià(
Ïg_low”_šfo
->
tx_’abËd
)

632 *
æags
 |ð
NFP_PORT_LAG_TX_ENABLED
;

634 *
æags
 &ð~
NFP_PORT_LAG_TX_ENABLED
;

636 *
æags
 |ð
NFP_PORT_LAG_CHANGED
;

637 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

639 
	`scheduË_d–ayed_wÜk
(&
Ïg
->
wÜk
, 
NFP_FL_LAG_DELAY
);

640 
	}
}

642 
	$nå_æow”_Ïg_Ãtdev_ev’t
(
nå_æow”_´iv
 *
´iv
,

643 
Ãt_deviû
 *
Ãtdev
,

644 
ev’t
, *
±r
)

646 
nå_æ_Ïg
 *
Ïg
 = &
´iv
->
nå_Ïg
;

647 
”r
;

649 
ev’t
) {

650 
NETDEV_CHANGEUPPER
:

651 
”r
 = 
	`nå_æ_Ïg_chªgeuµ”_ev’t
(
Ïg
, 
±r
);

652 ià(
”r
)

653  
NOTIFY_BAD
;

654  
NOTIFY_OK
;

655 
NETDEV_CHANGELOWERSTATE
:

656 
	`nå_æ_Ïg_chªg–s_ev’t
(
Ïg
, 
Ãtdev
, 
±r
);

657  
NOTIFY_OK
;

658 
NETDEV_UNREGISTER
:

659 
	`nå_æ_Ïg_scheduË_group_d–‘e
(
Ïg
, 
Ãtdev
);

660  
NOTIFY_OK
;

663  
NOTIFY_DONE
;

664 
	}
}

666 
	$nå_æow”_Ïg_»£t
(
nå_æ_Ïg
 *
Ïg
)

668 
nå_æ_Ïg_b©ch
 
b©ch
 = 
NFP_FL_LAG_BATCH_FIRST
;

670 
Ïg
->
r¡_cfg
 = 
Œue
;

671  
	`nå_æ_Ïg_cÚfig_group
(
Ïg
, 
NULL
, NULL, 0, &
b©ch
);

672 
	}
}

674 
	$nå_æow”_Ïg_š™
(
nå_æ_Ïg
 *
Ïg
)

676 
	`INIT_DELAYED_WORK
(&
Ïg
->
wÜk
, 
nå_æ_Ïg_do_wÜk
);

677 
	`INIT_LIST_HEAD
(&
Ïg
->
group_li¡
);

678 
	`mu‹x_š™
(&
Ïg
->
lock
);

679 
	`ida_š™
(&
Ïg
->
ida_hªdË
);

681 
	`__skb_queue_h—d_š™
(&
Ïg
->
»Œªs_skbs
);

684 
	`nå_æ_šüem’t_v”siÚ
(
Ïg
);

685 
	}
}

687 
	$nå_æow”_Ïg_þ—nup
(
nå_æ_Ïg
 *
Ïg
)

689 
nå_æ_Ïg_group
 *
’Œy
, *
¡Üage
;

691 
	`ÿnûl_d–ayed_wÜk_sync
(&
Ïg
->
wÜk
);

693 
	`__skb_queue_purge
(&
Ïg
->
»Œªs_skbs
);

696 
	`mu‹x_lock
(&
Ïg
->
lock
);

697 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
¡Üage
, &
Ïg
->
group_li¡
, 
li¡
) {

698 
	`li¡_d–
(&
’Œy
->
li¡
);

699 
	`kä“
(
’Œy
);

701 
	`mu‹x_uÆock
(&
Ïg
->
lock
);

702 
	`mu‹x_de¡roy
(&
Ïg
->
lock
);

703 
	`ida_de¡roy
(&
Ïg
->
ida_hªdË
);

704 
	}
}

	@src/flower/main.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/‘h”deviû.h
>

7 
	~<lšux/lockd•.h
>

8 
	~<lšux/pci.h
>

9 
	~<lšux/skbuff.h
>

10 
	~<lšux/vm®loc.h
>

11 
	~<Ãt/devlšk.h
>

12 
	~<Ãt/d¡_m‘ad©a.h
>

14 
	~"maš.h
"

15 
	~"../nåcÜe/nå_ýp.h
"

16 
	~"../nåcÜe/nå_nffw.h
"

17 
	~"../nåcÜe/nå_n¥.h
"

18 
	~"../nå_­p.h
"

19 
	~"../nå_maš.h
"

20 
	~"../nå_Ãt.h
"

21 
	~"../nå_Ãt_»´.h
"

22 
	~"../nå_pÜt.h
"

23 
	~"cmsg.h
"

25 
	#NFP_FLOWER_ALLOWED_VER
 0x0001000000010000UL

	)

27 cÚ¡ *
	$nå_æow”_exŒa_ÿp
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

30 
	}
}

32 
devlšk_esw™ch_mode
 
	$esw™ch_mode_g‘
(
nå_­p
 *
­p
)

34  
DEVLINK_ESWITCH_MODE_SWITCHDEV
;

35 
	}
}

37 
nå_æow”_nÚ_»´_´iv
 *

38 
	$nå_æow”_nÚ_»´_´iv_lookup
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

40 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

41 
nå_æow”_nÚ_»´_´iv
 *
’Œy
;

43 
	`ASSERT_RTNL
();

45 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
´iv
->
nÚ_»´_´iv
, 
li¡
)

46 ià(
’Œy
->
Ãtdev
 ==‚etdev)

47  
’Œy
;

49  
NULL
;

50 
	}
}

53 
	$__nå_æow”_nÚ_»´_´iv_g‘
(
nå_æow”_nÚ_»´_´iv
 *
nÚ_»´_´iv
)

55 
nÚ_»´_´iv
->
»f_couÁ
++;

56 
	}
}

58 
nå_æow”_nÚ_»´_´iv
 *

59 
	$nå_æow”_nÚ_»´_´iv_g‘
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

61 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

62 
nå_æow”_nÚ_»´_´iv
 *
’Œy
;

64 
’Œy
 = 
	`nå_æow”_nÚ_»´_´iv_lookup
(
­p
, 
Ãtdev
);

65 ià(
’Œy
)

66 
šc_»f
;

68 
’Œy
 = 
	`kz®loc
((*’Œy), 
GFP_KERNEL
);

69 ià(!
’Œy
)

70  
NULL
;

72 
’Œy
->
Ãtdev
 =‚etdev;

73 
	`li¡_add
(&
’Œy
->
li¡
, &
´iv
->
nÚ_»´_´iv
);

75 
šc_»f
:

76 
	`__nå_æow”_nÚ_»´_´iv_g‘
(
’Œy
);

77  
’Œy
;

78 
	}
}

81 
	$__nå_æow”_nÚ_»´_´iv_put
(
nå_æow”_nÚ_»´_´iv
 *
nÚ_»´_´iv
)

83 ià(--
nÚ_»´_´iv
->
»f_couÁ
)

86 
	`li¡_d–
(&
nÚ_»´_´iv
->
li¡
);

87 
	`kä“
(
nÚ_»´_´iv
);

88 
	}
}

91 
	$nå_æow”_nÚ_»´_´iv_put
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

93 
nå_æow”_nÚ_»´_´iv
 *
’Œy
;

95 
’Œy
 = 
	`nå_æow”_nÚ_»´_´iv_lookup
(
­p
, 
Ãtdev
);

96 ià(!
’Œy
)

99 
	`__nå_æow”_nÚ_»´_´iv_put
(
’Œy
);

100 
	}
}

102 
nå_»´_ty³


103 
	$nå_æow”_»´_g‘_ty³_ªd_pÜt
(
nå_­p
 *
­p
, 
u32
 
pÜt_id
, 
u8
 *
pÜt
)

105 
	`FIELD_GET
(
NFP_FLOWER_CMSG_PORT_TYPE
, 
pÜt_id
)) {

106 
NFP_FLOWER_CMSG_PORT_TYPE_PHYS_PORT
:

107 *
pÜt
 = 
	`FIELD_GET
(
NFP_FLOWER_CMSG_PORT_PHYS_PORT_NUM
,

108 
pÜt_id
);

109  
NFP_REPR_TYPE_PHYS_PORT
;

111 
NFP_FLOWER_CMSG_PORT_TYPE_PCIE_PORT
:

112 *
pÜt
 = 
	`FIELD_GET
(
NFP_FLOWER_CMSG_PORT_VNIC
, 
pÜt_id
);

113 ià(
	`FIELD_GET
(
NFP_FLOWER_CMSG_PORT_VNIC_TYPE
, 
pÜt_id
) ==

114 
NFP_FLOWER_CMSG_PORT_VNIC_TYPE_PF
)

115  
NFP_REPR_TYPE_PF
;

117  
NFP_REPR_TYPE_VF
;

120  
__NFP_REPR_TYPE_MAX
;

121 
	}
}

123 
Ãt_deviû
 *

124 
	$nå_æow”_»´_g‘
(
nå_­p
 *
­p
, 
u32
 
pÜt_id
)

126 
nå_»´_ty³
 
»´_ty³
;

127 
nå_»´s
 *
»´s
;

128 
u8
 
pÜt
 = 0;

130 
»´_ty³
 = 
	`nå_æow”_»´_g‘_ty³_ªd_pÜt
(
­p
, 
pÜt_id
, &
pÜt
);

131 ià(
»´_ty³
 > 
NFP_REPR_TYPE_MAX
)

132  
NULL
;

134 
»´s
 = 
	`rcu_d”eã»nû
(
­p
->»´s[
»´_ty³
]);

135 ià(!
»´s
)

136  
NULL
;

138 ià(
pÜt
 >ð
»´s
->
num_»´s
)

139  
NULL
;

141  
	`rcu_d”eã»nû
(
»´s
->»´s[
pÜt
]);

142 
	}
}

145 
	$nå_æow”_»´s_»ify
(
nå_­p
 *
­p
, 
nå_»´_ty³
 
ty³
,

146 
boÞ
 
exi¡s
)

148 
nå_»´s
 *
»´s
;

149 
i
, 
”r
, 
couÁ
 = 0;

151 
»´s
 = 
	`rcu_d”eã»nû_´Ùeùed
(
­p
->»´s[
ty³
],

152 
	`lockd•_is_h–d
(&
­p
->
pf
->
lock
));

153 ià(!
»´s
)

156 
i
 = 0; i < 
»´s
->
num_»´s
; i++) {

157 
Ãt_deviû
 *
Ãtdev
;

159 
Ãtdev
 = 
	`nå_»´_g‘_locked
(
­p
, 
»´s
, 
i
);

160 ià(
Ãtdev
) {

161 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

163 
”r
 = 
	`nå_æow”_cmsg_pÜŒeify
(
»´
, 
exi¡s
);

164 ià(
”r
)

165  
”r
;

166 
couÁ
++;

170  
couÁ
;

171 
	}
}

174 
	$nå_æow”_wa™_»´_»ify
(
nå_­p
 *
­p
, 
©omic_t
 *
»¶›s
, 
tÙ_»¶
)

176 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

178 ià(!
tÙ_»¶
)

181 
	`lockd•_as£¹_h–d
(&
­p
->
pf
->
lock
);

182 ià(!
	`wa™_ev’t_timeout
(
´iv
->
»ify_wa™_queue
,

183 
	`©omic_»ad
(
»¶›s
è>ð
tÙ_»¶
,

184 
NFP_FL_REPLY_TIMEOUT
)) {

185 
	`nå_w¬n
(
­p
->
ýp
, "Not‡ll„eprs„espondedo„eify\n");

186  -
EIO
;

190 
	}
}

193 
	$nå_æow”_»´_Ãtdev_Ý’
(
nå_­p
 *
­p
, 
nå_»´
 *
»´
)

195 
”r
;

197 
”r
 = 
	`nå_æow”_cmsg_pÜtmod
(
»´
, 
Œue
,„•r->
Ãtdev
->
mtu
, 
çl£
);

198 ià(
”r
)

199  
”r
;

201 
	`Ãtif_tx_wake_®l_queues
(
»´
->
Ãtdev
);

204 
	}
}

207 
	$nå_æow”_»´_Ãtdev_¡Ý
(
nå_­p
 *
­p
, 
nå_»´
 *
»´
)

209 
	`Ãtif_tx_di§bË
(
»´
->
Ãtdev
);

211  
	`nå_æow”_cmsg_pÜtmod
(
»´
, 
çl£
,„•r->
Ãtdev
->
mtu
, false);

212 
	}
}

214 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

216 
	$nå_æow”_»´_Ãtdev_š™
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

218  
	`tc_£tup_cb_egdev_»gi¡”
(
Ãtdev
,

219 
nå_æow”_£tup_tc_eg»ss_cb
,

220 
	`Ãtdev_´iv
(
Ãtdev
));

221 
	}
}

225 
	$nå_æow”_»´_Ãtdev_þ—n
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

227 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

229 
	`kä“
(
»´
->
­p_´iv
);

230 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

232 
	`tc_£tup_cb_egdev_uÄegi¡”
(
Ãtdev
, 
nå_æow”_£tup_tc_eg»ss_cb
,

233 
	`Ãtdev_´iv
(
Ãtdev
));

235 
	}
}

238 
	$nå_æow”_»´_Ãtdev_´eþ—n
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

240 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

241 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

242 
©omic_t
 *
»¶›s
 = &
´iv
->
»ify_»¶›s
;

243 
”r
;

245 
	`©omic_£t
(
»¶›s
, 0);

246 
”r
 = 
	`nå_æow”_cmsg_pÜŒeify
(
»´
, 
çl£
);

247 ià(
”r
) {

248 
	`nå_w¬n
(
­p
->
ýp
, "Failedo‚otify firmware‡bout„epr destruction\n");

252 
	`nå_æow”_wa™_»´_»ify
(
­p
, 
»¶›s
, 1);

253 
	}
}

255 
	$nå_æow”_¤iov_di§bË
(
nå_­p
 *
­p
)

257 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

259 ià(!
´iv
->
Â
)

262 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_VF
);

263 
	}
}

266 
	$nå_æow”_¥awn_vnic_»´s
(
nå_­p
 *
­p
,

267 
nå_æow”_cmsg_pÜt_vnic_ty³
 
vnic_ty³
,

268 
nå_»´_ty³
 
»´_ty³
, 
út
)

270 
u8
 
nå_pc›
 = 
	`nå_ýpcÜe_pc›_un™
(
­p
->
pf
->
ýp
);

271 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

272 
©omic_t
 *
»¶›s
 = &
´iv
->
»ify_»¶›s
;

273 
nå_æow”_»´_´iv
 *
»´_´iv
;

274 
nå_pÜt_ty³
 
pÜt_ty³
;

275 
nå_»´
 *nfp_repr;

276 
nå_»´s
 *
»´s
;

277 
i
, 
”r
, 
»ify_út
;

278 cÚ¡ 
u8
 
queue
 = 0;

280 
pÜt_ty³
 = 
»´_ty³
 =ð
NFP_REPR_TYPE_PF
 ? 
NFP_PORT_PF_PORT
 :

281 
NFP_PORT_VF_PORT
;

283 
»´s
 = 
	`nå_»´s_®loc
(
út
);

284 ià(!
»´s
)

285  -
ENOMEM
;

287 
i
 = 0; i < 
út
; i++) {

288 
Ãt_deviû
 *
»´
;

289 
nå_pÜt
 *
pÜt
;

290 
u32
 
pÜt_id
;

292 
»´
 = 
	`nå_»´_®loc
(
­p
);

293 ià(!
»´
) {

294 
”r
 = -
ENOMEM
;

295 
”r_»´s_þ—n
;

298 
»´_´iv
 = 
	`kz®loc
((*»´_´iv), 
GFP_KERNEL
);

299 ià(!
»´_´iv
) {

300 
”r
 = -
ENOMEM
;

301 
”r_»´s_þ—n
;

304 
nå_»´
 = 
	`Ãtdev_´iv
(
»´
);

305 
nå_»´
->
­p_´iv
 = 
»´_´iv
;

306 
»´_´iv
->
nå_»´
 =‚fp_repr;

309 
	`WARN_ON
(
»´_ty³
 =ð
NFP_REPR_TYPE_PF
 && 
i
);

311 
pÜt
 = 
	`nå_pÜt_®loc
(
­p
, 
pÜt_ty³
, 
»´
);

312 ià(
	`IS_ERR
(
pÜt
)) {

313 
”r
 = 
	`PTR_ERR
(
pÜt
);

314 
	`nå_»´_ä“
(
»´
);

315 
”r_»´s_þ—n
;

317 ià(
»´_ty³
 =ð
NFP_REPR_TYPE_PF
) {

318 
pÜt
->
pf_id
 = 
i
;

319 
pÜt
->
vnic
 = 
´iv
->
Â
->
dp
.
ù¾_b¬
;

321 
pÜt
->
pf_id
 = 0;

322 
pÜt
->
vf_id
 = 
i
;

323 
pÜt
->
vnic
 =

324 
­p
->
pf
->
vf_cfg_mem
 + 
i
 * 
NFP_NET_CFG_BAR_SZ
;

327 
	`‘h_hw_addr_¿ndom
(
»´
);

329 
pÜt_id
 = 
	`nå_æow”_cmsg_pc›_pÜt
(
nå_pc›
, 
vnic_ty³
,

330 
i
, 
queue
);

331 
”r
 = 
	`nå_»´_š™
(
­p
, 
»´
,

332 
pÜt_id
, 
pÜt
, 
´iv
->
Â
->
dp
.
Ãtdev
);

333 ià(
”r
) {

334 
	`nå_pÜt_ä“
(
pÜt
);

335 
	`nå_»´_ä“
(
»´
);

336 
”r_»´s_þ—n
;

339 
	`RCU_INIT_POINTER
(
»´s
->»´s[
i
], 
»´
);

340 
	`nå_šfo
(
­p
->
ýp
, "%s%d Representor(%s) created\n",

341 
»´_ty³
 =ð
NFP_REPR_TYPE_PF
 ? "PF" : "VF", 
i
,

342 
»´
->
Çme
);

345 
	`nå_­p_»´s_£t
(
­p
, 
»´_ty³
, 
»´s
);

347 
	`©omic_£t
(
»¶›s
, 0);

348 
»ify_út
 = 
	`nå_æow”_»´s_»ify
(
­p
, 
»´_ty³
, 
Œue
);

349 ià(
»ify_út
 < 0) {

350 
”r
 = 
»ify_út
;

351 
	`nå_w¬n
(
­p
->
ýp
, "Failedo‚otify firmware‡bout„epr creation\n");

352 
”r_»´s_»move
;

355 
”r
 = 
	`nå_æow”_wa™_»´_»ify
(
­p
, 
»¶›s
, 
»ify_út
);

356 ià(
”r
)

357 
”r_»´s_»move
;

360 
”r_»´s_»move
:

361 
»´s
 = 
	`nå_­p_»´s_£t
(
­p
, 
»´_ty³
, 
NULL
);

362 
”r_»´s_þ—n
:

363 
	`nå_»´s_þ—n_ªd_ä“
(
­p
, 
»´s
);

364  
”r
;

365 
	}
}

367 
	$nå_æow”_¤iov_’abË
(
nå_­p
 *
­p
, 
num_vfs
)

369 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

371 ià(!
´iv
->
Â
)

374  
	`nå_æow”_¥awn_vnic_»´s
(
­p
,

375 
NFP_FLOWER_CMSG_PORT_VNIC_TYPE_VF
,

376 
NFP_REPR_TYPE_VF
, 
num_vfs
);

377 
	}
}

380 
	$nå_æow”_¥awn_phy_»´s
(
nå_­p
 *
­p
, 
nå_æow”_´iv
 *
´iv
)

382 
nå_‘h_bË
 *
‘h_tbl
 = 
­p
->
pf
->eth_tbl;

383 
©omic_t
 *
»¶›s
 = &
´iv
->
»ify_»¶›s
;

384 
nå_æow”_»´_´iv
 *
»´_´iv
;

385 
nå_»´
 *nfp_repr;

386 
sk_buff
 *
ù¾_skb
;

387 
nå_»´s
 *
»´s
;

388 
”r
, 
»ify_út
;

389 
i
;

391 
ù¾_skb
 = 
	`nå_æow”_cmsg_mac_»´_¡¬t
(
­p
, 
‘h_tbl
->
couÁ
);

392 ià(!
ù¾_skb
)

393  -
ENOMEM
;

395 
»´s
 = 
	`nå_»´s_®loc
(
‘h_tbl
->
max_šdex
 + 1);

396 ià(!
»´s
) {

397 
”r
 = -
ENOMEM
;

398 
”r_ä“_ù¾_skb
;

401 
i
 = 0; i < 
‘h_tbl
->
couÁ
; i++) {

402 
phys_pÜt
 = 
‘h_tbl
->
pÜts
[
i
].
šdex
;

403 
Ãt_deviû
 *
»´
;

404 
nå_pÜt
 *
pÜt
;

405 
u32
 
cmsg_pÜt_id
;

407 
»´
 = 
	`nå_»´_®loc
(
­p
);

408 ià(!
»´
) {

409 
”r
 = -
ENOMEM
;

410 
”r_»´s_þ—n
;

413 
»´_´iv
 = 
	`kz®loc
((*»´_´iv), 
GFP_KERNEL
);

414 ià(!
»´_´iv
) {

415 
”r
 = -
ENOMEM
;

416 
”r_»´s_þ—n
;

419 
nå_»´
 = 
	`Ãtdev_´iv
(
»´
);

420 
nå_»´
->
­p_´iv
 = 
»´_´iv
;

421 
»´_´iv
->
nå_»´
 =‚fp_repr;

423 
pÜt
 = 
	`nå_pÜt_®loc
(
­p
, 
NFP_PORT_PHYS_PORT
, 
»´
);

424 ià(
	`IS_ERR
(
pÜt
)) {

425 
”r
 = 
	`PTR_ERR
(
pÜt
);

426 
	`nå_»´_ä“
(
»´
);

427 
”r_»´s_þ—n
;

429 
”r
 = 
	`nå_pÜt_š™_phy_pÜt
(
­p
->
pf
,‡µ, 
pÜt
, 
i
);

430 ià(
”r
) {

431 
	`nå_pÜt_ä“
(
pÜt
);

432 
	`nå_»´_ä“
(
»´
);

433 
”r_»´s_þ—n
;

436 
	`SET_NETDEV_DEV
(
»´
, &
´iv
->
Â
->
pdev
->
dev
);

437 
	`nå_Ãt_g‘_mac_addr
(
­p
->
pf
, 
»´
, 
pÜt
);

439 
cmsg_pÜt_id
 = 
	`nå_æow”_cmsg_phys_pÜt
(
phys_pÜt
);

440 
”r
 = 
	`nå_»´_š™
(
­p
, 
»´
,

441 
cmsg_pÜt_id
, 
pÜt
, 
´iv
->
Â
->
dp
.
Ãtdev
);

442 ià(
”r
) {

443 
	`nå_pÜt_ä“
(
pÜt
);

444 
	`nå_»´_ä“
(
»´
);

445 
”r_»´s_þ—n
;

448 
	`nå_æow”_cmsg_mac_»´_add
(
ù¾_skb
, 
i
,

449 
‘h_tbl
->
pÜts
[
i
].
nbi
,

450 
‘h_tbl
->
pÜts
[
i
].
ba£
,

451 
phys_pÜt
);

453 
	`RCU_INIT_POINTER
(
»´s
->»´s[
phys_pÜt
], 
»´
);

454 
	`nå_šfo
(
­p
->
ýp
, "Phys Port %d Representor(%s) created\n",

455 
phys_pÜt
, 
»´
->
Çme
);

458 
	`nå_­p_»´s_£t
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
, 
»´s
);

467 
	`©omic_£t
(
»¶›s
, 0);

468 
»ify_út
 = 
	`nå_æow”_»´s_»ify
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
, 
Œue
);

469 ià(
»ify_út
 < 0) {

470 
”r
 = 
»ify_út
;

471 
	`nå_w¬n
(
­p
->
ýp
, "Failedo‚otify firmware‡bout„epr creation\n");

472 
”r_»´s_»move
;

475 
”r
 = 
	`nå_æow”_wa™_»´_»ify
(
­p
, 
»¶›s
, 
»ify_út
);

476 ià(
”r
)

477 
”r_»´s_»move
;

479 
	`nå_ù¾_tx
(
­p
->
ù¾
, 
ù¾_skb
);

482 
”r_»´s_»move
:

483 
»´s
 = 
	`nå_­p_»´s_£t
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
, 
NULL
);

484 
”r_»´s_þ—n
:

485 
	`nå_»´s_þ—n_ªd_ä“
(
­p
, 
»´s
);

486 
”r_ä“_ù¾_skb
:

487 
	`kä“_skb
(
ù¾_skb
);

488  
”r
;

489 
	}
}

491 
	$nå_æow”_vnic_®loc
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

492 
id
)

494 ià(
id
 > 0) {

495 
	`nå_w¬n
(
­p
->
ýp
, "FlowerNIC doesn't support morehan one data vNIC\n");

496 
”r_šv®id_pÜt
;

499 
	`‘h_hw_addr_¿ndom
(
Â
->
dp
.
Ãtdev
);

500 
	`Ãtif_k“p_d¡
(
Â
->
dp
.
Ãtdev
);

501 
Â
->
vnic_no_Çme
 = 
Œue
;

505 
”r_šv®id_pÜt
:

506 
Â
->
pÜt
 = 
	`nå_pÜt_®loc
(
­p
, 
NFP_PORT_INVALID
,‚n->
dp
.
Ãtdev
);

507  
	`PTR_ERR_OR_ZERO
(
Â
->
pÜt
);

508 
	}
}

510 
	$nå_æow”_vnic_þ—n
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

512 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

514 ià(
­p
->
pf
->
num_vfs
)

515 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_VF
);

516 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_PF
);

517 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
);

519 
´iv
->
Â
 = 
NULL
;

520 
	}
}

522 
	$nå_æow”_vnic_š™
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

524 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

525 
”r
;

527 
´iv
->
Â
 =‚n;

529 
”r
 = 
	`nå_æow”_¥awn_phy_»´s
(
­p
,‡µ->
´iv
);

530 ià(
”r
)

531 
”r_þ—r_Â
;

533 
”r
 = 
	`nå_æow”_¥awn_vnic_»´s
(
­p
,

534 
NFP_FLOWER_CMSG_PORT_VNIC_TYPE_PF
,

535 
NFP_REPR_TYPE_PF
, 1);

536 ià(
”r
)

537 
”r_de¡roy_»´s_phy
;

539 ià(
­p
->
pf
->
num_vfs
) {

540 
”r
 = 
	`nå_æow”_¥awn_vnic_»´s
(
­p
,

541 
NFP_FLOWER_CMSG_PORT_VNIC_TYPE_VF
,

542 
NFP_REPR_TYPE_VF
,

543 
­p
->
pf
->
num_vfs
);

544 ià(
”r
)

545 
”r_de¡roy_»´s_pf
;

550 
”r_de¡roy_»´s_pf
:

551 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_PF
);

552 
”r_de¡roy_»´s_phy
:

553 
	`nå_»´s_þ—n_ªd_ä“_by_ty³
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
);

554 
”r_þ—r_Â
:

555 
´iv
->
Â
 = 
NULL
;

556  
”r
;

557 
	}
}

559 
	$nå_æow”_š™
(
nå_­p
 *
­p
)

561 
u64
 
v”siÚ
, 
ã©u»s
, 
ùx_couÁ
, 
num_mems
;

562 cÚ¡ 
nå_pf
 *
pf
 = 
­p
->pf;

563 
nå_æow”_´iv
 *
­p_´iv
;

564 
”r
;

566 ià(!
pf
->
‘h_tbl
) {

567 
	`nå_w¬n
(
­p
->
ýp
, "FlowerNIC„equiresƒthable\n");

568  -
EINVAL
;

571 ià(!
pf
->
mac_¡©s_b¬
) {

572 
	`nå_w¬n
(
­p
->
ýp
, "FlowerNIC„equires mac_stats BAR\n");

573  -
EINVAL
;

576 ià(!
pf
->
vf_cfg_b¬
) {

577 
	`nå_w¬n
(
­p
->
ýp
, "FlowerNIC„equires vf_cfg BAR\n");

578  -
EINVAL
;

581 
v”siÚ
 = 
	`nå_¹sym_»ad_Ë
(
­p
->
pf
->
¹bl
, "hw_æow”_v”siÚ", &
”r
);

582 ià(
”r
) {

583 
	`nå_w¬n
(
­p
->
ýp
, "FlowerNIC„equires hw_flower_version memory symbol\n");

584  
”r
;

587 
num_mems
 = 
	`nå_¹sym_»ad_Ë
(
­p
->
pf
->
¹bl
, "CONFIG_FC_HOST_CTX_SPLIT",

588 &
”r
);

589 ià(
”r
) {

590 
	`nå_w¬n
(
­p
->
ýp
,

592 
”r
);

593 
”r
 = 0;

594 
num_mems
 = 1;

597 ià(!
	`FIELD_FIT
(
NFP_FL_STAT_ID_MU_NUM
, 
num_mems
) || !num_mems) {

598 
	`nå_w¬n
(
­p
->
ýp
,

600 
num_mems
);

601  -
EINVAL
;

604 
ùx_couÁ
 = 
	`nå_¹sym_»ad_Ë
(
­p
->
pf
->
¹bl
, "CONFIG_FC_HOST_CTX_COUNT",

605 &
”r
);

606 ià(
”r
) {

607 
	`nå_w¬n
(
­p
->
ýp
,

609 
”r
);

610 
”r
 = 0;

611 
ùx_couÁ
 = 
	`BIT
(17);

615 ià(
v”siÚ
 !ð
NFP_FLOWER_ALLOWED_VER
) {

616 
	`nå_w¬n
(
­p
->
ýp
, "FlowerNIC: unsupported firmware version\n");

617  -
EINVAL
;

620 
­p_´iv
 = 
	`vz®loc
((
nå_æow”_´iv
));

621 ià(!
­p_´iv
)

622  -
ENOMEM
;

624 
­p_´iv
->
tÙ®_mem_un™s
 = 
num_mems
;

625 
­p_´iv
->
aùive_mem_un™
 = 0;

626 
­p_´iv
->
¡©s_ršg_size
 = 
	`roundup_pow_of_two
(
ùx_couÁ
);

627 
­p
->
´iv
 = 
­p_´iv
;

628 
­p_´iv
->
­p
 =‡pp;

629 
	`skb_queue_h—d_š™
(&
­p_´iv
->
cmsg_skbs_high
);

630 
	`skb_queue_h—d_š™
(&
­p_´iv
->
cmsg_skbs_low
);

631 
	`INIT_WORK
(&
­p_´iv
->
cmsg_wÜk
, 
nå_æow”_cmsg_´oûss_rx
);

632 
	`š™_wa™queue_h—d
(&
­p_´iv
->
»ify_wa™_queue
);

634 
	`š™_wa™queue_h—d
(&
­p_´iv
->
mtu_cÚf
.
wa™_q
);

635 
	`¥š_lock_š™
(&
­p_´iv
->
mtu_cÚf
.
lock
);

637 
”r
 = 
	`nå_æow”_m‘ad©a_š™
(
­p
, 
ùx_couÁ
, 
num_mems
);

638 ià(
”r
)

639 
”r_ä“_­p_´iv
;

642 
ã©u»s
 = 
	`nå_¹sym_»ad_Ë
(
­p
->
pf
->
¹bl
,

643 "_abi_æow”_exŒa_ã©u»s", &
”r
);

644 ià(
”r
)

645 
­p_´iv
->
æow”_ext_ã©s
 = 0;

647 
­p_´iv
->
æow”_ext_ã©s
 = 
ã©u»s
;

650 
”r
 = 
	`nå_¹sym_wr™e_Ë
(
­p
->
pf
->
¹bl
,

652 ià(!
”r
) {

653 
­p_´iv
->
æow”_ext_ã©s
 |ð
NFP_FL_FEATS_LAG
;

654 
	`nå_æow”_Ïg_š™
(&
­p_´iv
->
nå_Ïg
);

655 } ià(
”r
 =ð-
ENOENT
) {

656 
	`nå_w¬n
(
­p
->
ýp
, "LAG‚ot supported by FW.\n");

658 
”r_þ—nup_m‘ad©a
;

661 
	`INIT_LIST_HEAD
(&
­p_´iv
->
šdr_block_cb_´iv
);

662 
	`INIT_LIST_HEAD
(&
­p_´iv
->
nÚ_»´_´iv
);

666 
”r_þ—nup_m‘ad©a
:

667 
	`nå_æow”_m‘ad©a_þ—nup
(
­p
);

668 
”r_ä“_­p_´iv
:

669 
	`vä“
(
­p
->
´iv
);

670  
”r
;

671 
	}
}

673 
	$nå_æow”_þ—n
(
nå_­p
 *
­p
)

675 
nå_æow”_´iv
 *
­p_´iv
 = 
­p
->
´iv
;

677 
	`skb_queue_purge
(&
­p_´iv
->
cmsg_skbs_high
);

678 
	`skb_queue_purge
(&
­p_´iv
->
cmsg_skbs_low
);

679 
	`æush_wÜk
(&
­p_´iv
->
cmsg_wÜk
);

681 ià(
­p_´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_LAG
)

682 
	`nå_æow”_Ïg_þ—nup
(&
­p_´iv
->
nå_Ïg
);

684 
	`nå_æow”_m‘ad©a_þ—nup
(
­p
);

685 
	`vä“
(
­p
->
´iv
);

686 
­p
->
´iv
 = 
NULL
;

687 
	}
}

689 
boÞ
 
	$nå_æow”_check_ack
(
nå_æow”_´iv
 *
­p_´iv
)

691 
boÞ
 
»t
;

693 
	`¥š_lock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

694 
»t
 = 
­p_´iv
->
mtu_cÚf
.
ack
;

695 
	`¥š_uÆock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

697  
»t
;

698 
	}
}

701 
	$nå_æow”_»´_chªge_mtu
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

702 
Ãw_mtu
)

704 
nå_æow”_´iv
 *
­p_´iv
 = 
­p
->
´iv
;

705 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

706 
”r
;

709 ià(
»´
->
pÜt
->
ty³
 !ð
NFP_PORT_PHYS_PORT
)

712 ià(!(
­p_´iv
->
æow”_ext_ã©s
 & 
NFP_FL_NBI_MTU_SETTING
)) {

713 
	`nå_”r
(
­p
->
ýp
, "Physical…ort MTU setting‚ot supported\n");

714  -
EINVAL
;

717 
	`¥š_lock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

718 
­p_´iv
->
mtu_cÚf
.
ack
 = 
çl£
;

719 
­p_´iv
->
mtu_cÚf
.
»que¡ed_v®
 = 
Ãw_mtu
;

720 
­p_´iv
->
mtu_cÚf
.
pÜŠum
 = 
»´
->
d¡
->
u
.
pÜt_šfo
.
pÜt_id
;

721 
	`¥š_uÆock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

723 
”r
 = 
	`nå_æow”_cmsg_pÜtmod
(
»´
, 
	`Ãtif_ÿ¼›r_ok
(
Ãtdev
), 
Ãw_mtu
,

724 
Œue
);

725 ià(
”r
) {

726 
	`¥š_lock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

727 
­p_´iv
->
mtu_cÚf
.
»que¡ed_v®
 = 0;

728 
	`¥š_uÆock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

729  
”r
;

733 ià(!
	`wa™_ev’t_timeout
(
­p_´iv
->
mtu_cÚf
.
wa™_q
,

734 
	`nå_æow”_check_ack
(
­p_´iv
),

735 
NFP_FL_REPLY_TIMEOUT
)) {

736 
	`¥š_lock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

737 
­p_´iv
->
mtu_cÚf
.
»que¡ed_v®
 = 0;

738 
	`¥š_uÆock_bh
(&
­p_´iv
->
mtu_cÚf
.
lock
);

739 
	`nå_w¬n
(
­p
->
ýp
, "MTU change‚ot verified with fw\n");

740  -
EIO
;

744 
	}
}

746 
	$nå_æow”_¡¬t
(
nå_­p
 *
­p
)

748 
nå_æow”_´iv
 *
­p_´iv
 = 
­p
->
´iv
;

749 
”r
;

751 ià(
­p_´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_LAG
) {

752 
”r
 = 
	`nå_æow”_Ïg_»£t
(&
­p_´iv
->
nå_Ïg
);

753 ià(
”r
)

754  
”r
;

757  
	`nå_tuÂ–_cÚfig_¡¬t
(
­p
);

758 
	}
}

760 
	$nå_æow”_¡Ý
(
nå_­p
 *
­p
)

762 
	`nå_tuÂ–_cÚfig_¡Ý
(
­p
);

763 
	}
}

766 
	$nå_æow”_Ãtdev_ev’t
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

767 
ev’t
, *
±r
)

769 
nå_æow”_´iv
 *
­p_´iv
 = 
­p
->
´iv
;

770 
»t
;

772 ià(
­p_´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_LAG
) {

773 
»t
 = 
	`nå_æow”_Ïg_Ãtdev_ev’t
(
­p_´iv
, 
Ãtdev
, 
ev’t
, 
±r
);

774 ià(
»t
 & 
NOTIFY_STOP_MASK
)

775  
»t
;

778 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 0, 0)

779 
»t
 = 
	`nå_æow”_»g_šdœ_block_hªdËr
(
­p
, 
Ãtdev
, 
ev’t
);

780 ià(
»t
 & 
NOTIFY_STOP_MASK
)

781  
»t
;

784  
	`nå_tuÂ–_mac_ev’t_hªdËr
(
­p
, 
Ãtdev
, 
ev’t
, 
±r
);

785 
	}
}

787 cÚ¡ 
nå_­p_ty³
 
	g­p_æow”
 = {

788 .
id
 = 
NFP_APP_FLOWER_NIC
,

789 .
	gÇme
 = "flower",

791 .
	gù¾_ÿp_mask
 = ~0U,

792 .
	gù¾_has_m‘a
 = 
Œue
,

794 .
	gexŒa_ÿp
 = 
nå_æow”_exŒa_ÿp
,

796 .
	gš™
 = 
nå_æow”_š™
,

797 .
	gþ—n
 = 
nå_æow”_þ—n
,

799 .
	g»´_chªge_mtu
 = 
nå_æow”_»´_chªge_mtu
,

801 .
	gvnic_®loc
 = 
nå_æow”_vnic_®loc
,

802 .
	gvnic_š™
 = 
nå_æow”_vnic_š™
,

803 .
	gvnic_þ—n
 = 
nå_æow”_vnic_þ—n
,

805 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

806 .
	g»´_š™
 = 
nå_æow”_»´_Ãtdev_š™
,

808 .
	g»´_´eþ—n
 = 
nå_æow”_»´_Ãtdev_´eþ—n
,

809 .
	g»´_þ—n
 = 
nå_æow”_»´_Ãtdev_þ—n
,

811 .
	g»´_Ý’
 = 
nå_æow”_»´_Ãtdev_Ý’
,

812 .
	g»´_¡Ý
 = 
nå_æow”_»´_Ãtdev_¡Ý
,

814 .
	g¡¬t
 = 
nå_æow”_¡¬t
,

815 .
	g¡Ý
 = 
nå_æow”_¡Ý
,

817 .
	gÃtdev_ev’t
 = 
nå_æow”_Ãtdev_ev’t
,

819 .
	gù¾_msg_rx
 = 
nå_æow”_cmsg_rx
,

821 .
	g¤iov_’abË
 = 
nå_æow”_¤iov_’abË
,

822 .
	g¤iov_di§bË
 = 
nå_æow”_¤iov_di§bË
,

824 .
	gesw™ch_mode_g‘
 = 
esw™ch_mode_g‘
,

825 .
	g»´_g‘
 = 
nå_æow”_»´_g‘
,

827 .
	g£tup_tc
 = 
nå_æow”_£tup_tc
,

	@src/flower/main.h

4 #iâdeà
__NFP_FLOWER_H__


5 
	#__NFP_FLOWER_H__
 1

	)

7 
	~"nå_Ãt_com·t.h
"

8 
	~"cmsg.h
"

10 
	~<lšux/cœc_buf.h
>

11 
	~<lšux/hashbË.h
>

12 
	~<lšux/rhashbË.h
>

13 
	~<lšux/time64.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<Ãt/pkt_þs.h
>

16 
	~<Ãt/tý.h
>

17 
	~<lšux/wÜkqueue.h
>

18 
	~<lšux/idr.h
>

20 
	gnå_æ_´e_Ïg
;

21 
	gÃt_deviû
;

22 
	gnå_­p
;

24 
	#NFP_FL_STAT_ID_MU_NUM
 
	`GENMASK
(31, 22)

	)

25 
	#NFP_FL_STAT_ID_STAT
 
	`GENMASK
(21, 0)

	)

27 
	#NFP_FL_STATS_ELEM_RS
 
	`FIELD_SIZEOF
(
nå_æ_¡©s_id
, \

28 
š™_uÇÎoc
)

	)

29 
	#NFP_FLOWER_MASK_ENTRY_RS
 256

	)

30 
	#NFP_FLOWER_MASK_ELEMENT_RS
 1

	)

31 
	#NFP_FLOWER_MASK_HASH_BITS
 10

	)

33 
	#NFP_FL_META_FLAG_MANAGE_MASK
 
	`BIT
(7)

	)

35 
	#NFP_FL_MASK_REUSE_TIME_NS
 40000

	)

36 
	#NFP_FL_MASK_ID_LOCATION
 1

	)

39 
	#NFP_FL_FEATS_GENEVE
 
	`BIT
(0)

	)

40 
	#NFP_FL_NBI_MTU_SETTING
 
	`BIT
(1)

	)

41 
	#NFP_FL_FEATS_GENEVE_OPT
 
	`BIT
(2)

	)

42 
	#NFP_FL_FEATS_VLAN_PCP
 
	`BIT
(3)

	)

43 
	#NFP_FL_FEATS_LAG
 
	`BIT
(31)

	)

45 
	snå_æ_mask_id
 {

46 
cœc_buf
 
	mmask_id_ä“_li¡
;

47 
ktime_t
 *
	mÏ¡_u£d
;

48 
u8
 
	mš™_uÇÎoÿ‹d
;

51 
	snå_æ_¡©s_id
 {

52 
cœc_buf
 
	mä“_li¡
;

53 
u32
 
	mš™_uÇÎoc
;

54 
u8
 
	m»³©ed_em_couÁ
;

67 
	snå_æ_tuÂ–_ofæßds
 {

68 
rhashbË
 
	mofæßded_macs
;

69 
li¡_h—d
 
	mv4_off_li¡
;

70 
li¡_h—d
 
	mÃigh_off_li¡
;

71 
mu‹x
 
	mv4_off_lock
;

72 
¥šlock_t
 
	mÃigh_off_lock
;

73 
ida
 
	mmac_off_ids
;

74 
nÙif›r_block
 
	mÃigh_nb
;

85 
	snå_mtu_cÚf
 {

86 
u32
 
	mpÜŠum
;

87 
	m»que¡ed_v®
;

88 
boÞ
 
	mack
;

89 
wa™_queue_h—d_t
 
	mwa™_q
;

90 
¥šlock_t
 
	mlock
;

106 
	snå_æ_Ïg
 {

107 
d–ayed_wÜk
 
	mwÜk
;

108 
mu‹x
 
	mlock
;

109 
li¡_h—d
 
	mgroup_li¡
;

110 
ida
 
	mida_hªdË
;

111 
	mpkt_num
;

112 
	mb©ch_v”
;

113 
u8
 
	mglob®_š¡
;

114 
boÞ
 
	mr¡_cfg
;

115 
sk_buff_h—d
 
	m»Œªs_skbs
;

148 
	snå_æow”_´iv
 {

149 
nå_­p
 *
	m­p
;

150 
nå_Ãt
 *
	mÂ
;

151 
u32
 
	mmask_id_£ed
;

152 
u64
 
	mæow”_v”siÚ
;

153 
u64
 
	mæow”_ext_ã©s
;

154 
nå_æ_¡©s_id
 
	m¡©s_ids
;

155 
nå_æ_mask_id
 
	mmask_ids
;

156 
DECLARE_HASHTABLE
(
mask_bË
, 
NFP_FLOWER_MASK_HASH_BITS
);

157 
u32
 
	m¡©s_ršg_size
;

158 
rhashbË
 
	mæow_bË
;

159 
nå_æ_¡©s
 *
	m¡©s
;

160 
¥šlock_t
 
	m¡©s_lock
;

161 
wÜk_¡ruù
 
	mcmsg_wÜk
;

162 
sk_buff_h—d
 
	mcmsg_skbs_high
;

163 
sk_buff_h—d
 
	mcmsg_skbs_low
;

164 
nå_æ_tuÂ–_ofæßds
 
	mtun
;

165 
©omic_t
 
	m»ify_»¶›s
;

166 
wa™_queue_h—d_t
 
	m»ify_wa™_queue
;

167 
nå_mtu_cÚf
 
	mmtu_cÚf
;

168 
nå_æ_Ïg
 
	mnå_Ïg
;

169 
li¡_h—d
 
	mšdr_block_cb_´iv
;

170 
li¡_h—d
 
	mnÚ_»´_´iv
;

171 
	maùive_mem_un™
;

172 
	mtÙ®_mem_un™s
;

183 
	snå_æow”_»´_´iv
 {

184 
nå_»´
 *
	mnå_»´
;

185 
	mÏg_pÜt_æags
;

186 
boÞ
 
	mmac_ofæßded
;

187 
u8
 
	mofæßded_mac_addr
[
ETH_ALEN
];

188 
li¡_h—d
 
	mmac_li¡
;

199 
	snå_æow”_nÚ_»´_´iv
 {

200 
li¡_h—d
 
	mli¡
;

201 
Ãt_deviû
 *
	mÃtdev
;

202 
	m»f_couÁ
;

203 
boÞ
 
	mmac_ofæßded
;

204 
u8
 
	mofæßded_mac_addr
[
ETH_ALEN
];

207 
	snå_æ_key_ls
 {

208 
u32
 
	mkey_Ïy”_two
;

209 
u8
 
	mkey_Ïy”
;

210 
	mkey_size
;

213 
	snå_æ_ruË_m‘ad©a
 {

214 
u8
 
	mkey_Ën
;

215 
u8
 
	mmask_Ën
;

216 
u8
 
	maù_Ën
;

217 
u8
 
	mæags
;

218 
__be32
 
	mho¡_ùx_id
;

219 
__be64
 
ho¡_cook›
 
	m__·cked
;

220 
__be64
 
æow_v”siÚ
 
	m__·cked
;

221 
__be32
 
	mshÜtcut
;

224 
	snå_æ_¡©s
 {

225 
u64
 
	mpkts
;

226 
u64
 
	mby‹s
;

227 
u64
 
	mu£d
;

230 
	snå_æ_·ylßd
 {

231 
nå_æ_ruË_m‘ad©a
 
	mm‘a
;

232 
	mtc_æow”_cook›
;

233 
rhash_h—d
 
	mæ_node
;

234 
rcu_h—d
 
	mrcu
;

235 
__be32
 
	mnå_tun_v4_addr
;

236 
Ãt_deviû
 *
	mšg»ss_dev
;

237 *
	munmasked_d©a
;

238 *
	mmask_d©a
;

239 *
	maùiÚ_d©a
;

240 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

241 
boÞ
 
	mšg»ss_ofæßd
;

245 cÚ¡ 
rhashbË_·¿ms
 
nå_æow”_bË_·¿ms
;

247 
	snå_æ_¡©s_äame
 {

248 
__be32
 
	m¡©s_cÚ_id
;

249 
__be32
 
	mpkt_couÁ
;

250 
__be64
 
	mby‹_couÁ
;

251 
__be64
 
	m¡©s_cook›
;

254 
nå_æow”_m‘ad©a_š™
(
nå_­p
 *
­p
, 
u64
 
ho¡_ùx_couÁ
,

255 
ho¡_ùx_¥l™
);

256 
nå_æow”_m‘ad©a_þ—nup
(
nå_­p
 *
­p
);

258 
nå_æow”_£tup_tc
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

259 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
);

260 
nå_æow”_compže_æow_m©ch
(
nå_­p
 *
­p
,

261 
tc_þs_æow”_ofæßd
 *
æow
,

262 
nå_æ_key_ls
 *
key_ls
,

263 
Ãt_deviû
 *
Ãtdev
,

264 
nå_æ_·ylßd
 *
nå_æow
,

265 
nå_æow”_tun_ty³
 
tun_ty³
);

266 
nå_æow”_compže_aùiÚ
(
nå_­p
 *
­p
,

267 
tc_þs_æow”_ofæßd
 *
æow
,

268 
Ãt_deviû
 *
Ãtdev
,

269 
nå_æ_·ylßd
 *
nå_æow
);

270 
nå_compže_æow_m‘ad©a
(
nå_­p
 *
­p
,

271 
tc_þs_æow”_ofæßd
 *
æow
,

272 
nå_æ_·ylßd
 *
nå_æow
,

273 
Ãt_deviû
 *
Ãtdev
);

274 
nå_modify_æow_m‘ad©a
(
nå_­p
 *
­p
,

275 
nå_æ_·ylßd
 *
nå_æow
);

277 
nå_æ_·ylßd
 *

278 
nå_æow”_£¬ch_æ_bË
(
nå_­p
 *
­p
, 
tc_æow”_cook›
,

279 
Ãt_deviû
 *
Ãtdev
);

280 
nå_æ_·ylßd
 *

281 
nå_æow”_»move_æ_bË
(
nå_­p
 *
­p
, 
tc_æow”_cook›
);

283 
nå_æow”_rx_æow_¡©s
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
);

285 
nå_tuÂ–_cÚfig_¡¬t
(
nå_­p
 *
­p
);

286 
nå_tuÂ–_cÚfig_¡Ý
(
nå_­p
 *
­p
);

287 
nå_tuÂ–_mac_ev’t_hªdËr
(
nå_­p
 *
­p
,

288 
Ãt_deviû
 *
Ãtdev
,

289 
ev’t
, *
±r
);

290 
nå_tuÂ–_d–_v4_off
(
nå_­p
 *
­p
, 
__be32
 
v4
);

291 
nå_tuÂ–_add_v4_off
(
nå_­p
 *
­p
, 
__be32
 
v4
);

292 
nå_tuÂ–_»que¡_rou‹
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
);

293 
nå_tuÂ–_k“p_®ive
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
);

294 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

295 
nå_æow”_£tup_tc_eg»ss_cb
(
tc_£tup_ty³
 
ty³
, *
ty³_d©a
,

296 *
cb_´iv
);

298 
nå_æow”_Ïg_š™
(
nå_æ_Ïg
 *
Ïg
);

299 
nå_æow”_Ïg_þ—nup
(
nå_æ_Ïg
 *
Ïg
);

300 
nå_æow”_Ïg_»£t
(
nå_æ_Ïg
 *
Ïg
);

301 
nå_æow”_Ïg_Ãtdev_ev’t
(
nå_æow”_´iv
 *
´iv
,

302 
Ãt_deviû
 *
Ãtdev
,

303 
ev’t
, *
±r
);

304 
boÞ
 
nå_æow”_Ïg_uÅroûs£d_msg
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
);

305 
nå_æow”_Ïg_pÝuÏ‹_´e_aùiÚ
(
nå_­p
 *
­p
,

306 
Ãt_deviû
 *
ma¡”
,

307 
nå_æ_´e_Ïg
 *
´e_aù
);

308 
nå_æow”_Ïg_g‘_ouut_id
(
nå_­p
 *
­p
,

309 
Ãt_deviû
 *
ma¡”
);

310 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 0, 0)

311 
nå_æow”_»g_šdœ_block_hªdËr
(
nå_­p
 *
­p
,

312 
Ãt_deviû
 *
Ãtdev
,

313 
ev’t
);

317 
__nå_æow”_nÚ_»´_´iv_g‘
(
nå_æow”_nÚ_»´_´iv
 *
nÚ_»´_´iv
);

318 
nå_æow”_nÚ_»´_´iv
 *

319 
nå_æow”_nÚ_»´_´iv_g‘
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
);

321 
__nå_æow”_nÚ_»´_´iv_put
(
nå_æow”_nÚ_»´_´iv
 *
nÚ_»´_´iv
);

323 
nå_æow”_nÚ_»´_´iv_put
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
);

	@src/flower/match.c

4 
	~<lšux/b™f›ld.h
>

5 
	~<Ãt/pkt_þs.h
>

7 
	~"cmsg.h
"

8 
	~"maš.h
"

11 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

12 
	$nå_æow”_compže_m‘a_tci
(
nå_æow”_m‘a_tci
 *
ext
,

13 
nå_æow”_m‘a_tci
 *
msk
,

14 
tc_þs_æow”_ofæßd
 *
æow
, 
u8
 
key_ty³
)

16 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

17 
u16
 
tmp_tci
;

19 
	`mem£t
(
ext
, 0, (
nå_æow”_m‘a_tci
));

20 
	`mem£t
(
msk
, 0, (
nå_æow”_m‘a_tci
));

23 
ext
->
nå_æow_key_Ïy”
 = 
key_ty³
;

24 
ext
->
mask_id
 = ~0;

26 
msk
->
nå_æow_key_Ïy”
 = 
key_ty³
;

27 
msk
->
mask_id
 = ~0;

29 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_VLAN
)) {

30 
æow_m©ch_vÏn
 
m©ch
;

32 
	`æow_ruË_m©ch_vÏn
(
ruË
, &
m©ch
);

34 
tmp_tci
 = 
NFP_FLOWER_MASK_VLAN_PRESENT
;

35 
tmp_tci
 |ð
	`FIELD_PREP
(
NFP_FLOWER_MASK_VLAN_PRIO
,

36 
m©ch
.
key
->
vÏn_´iÜ™y
) |

37 
	`FIELD_PREP
(
NFP_FLOWER_MASK_VLAN_VID
,

38 
m©ch
.
key
->
vÏn_id
);

39 
ext
->
tci
 = 
	`ýu_to_be16
(
tmp_tci
);

41 
tmp_tci
 = 
NFP_FLOWER_MASK_VLAN_PRESENT
;

42 
tmp_tci
 |ð
	`FIELD_PREP
(
NFP_FLOWER_MASK_VLAN_PRIO
,

43 
m©ch
.
mask
->
vÏn_´iÜ™y
) |

44 
	`FIELD_PREP
(
NFP_FLOWER_MASK_VLAN_VID
,

45 
m©ch
.
mask
->
vÏn_id
);

46 
msk
->
tci
 = 
	`ýu_to_be16
(
tmp_tci
);

48 
	}
}

50 
	$nå_æow”_compže_m‘a_tci
(
nå_æow”_m‘a_tci
 *
äame
,

51 
tc_þs_æow”_ofæßd
 *
æow
, 
u8
 
key_ty³
,

52 
boÞ
 
mask_v”siÚ
)

54 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

55 
æow_dis£ùÜ_key_vÏn
 *
æow_vÏn
;

56 
u16
 
tmp_tci
;

58 
	`mem£t
(
äame
, 0, (
nå_æow”_m‘a_tci
));

60 
äame
->
nå_æow_key_Ïy”
 = 
key_ty³
;

61 
äame
->
mask_id
 = ~0;

63 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_VLAN
)) {

64 
æow_vÏn
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

65 
FLOW_DISSECTOR_KEY_VLAN
,

66 
rg‘
);

67 
tmp_tci
 = 
NFP_FLOWER_MASK_VLAN_PRESENT
;

69 
tmp_tci
 |ð
	`FIELD_PREP
(
NFP_FLOWER_MASK_VLAN_PRIO
,

70 
æow_vÏn
->
vÏn_´iÜ™y
) |

71 
	`FIELD_PREP
(
NFP_FLOWER_MASK_VLAN_VID
,

72 
æow_vÏn
->
vÏn_id
);

73 
äame
->
tci
 = 
	`ýu_to_be16
(
tmp_tci
);

75 
	}
}

79 
	$nå_æow”_compže_ext_m‘a
(
nå_æow”_ext_m‘a
 *
äame
, 
u32
 
key_ext
)

81 
äame
->
nå_æow_key_Ïy”2
 = 
	`ýu_to_be32
(
key_ext
);

82 
	}
}

85 
	$nå_æow”_compže_pÜt
(
nå_æow”_š_pÜt
 *
äame
, 
u32
 
cmsg_pÜt
,

86 
boÞ
 
mask_v”siÚ
, 
nå_æow”_tun_ty³
 
tun_ty³
)

88 ià(
mask_v”siÚ
) {

89 
äame
->
š_pÜt
 = 
	`ýu_to_be32
(~0);

93 ià(
tun_ty³
) {

94 
äame
->
š_pÜt
 = 
	`ýu_to_be32
(
NFP_FL_PORT_TYPE_TUN
 | 
tun_ty³
);

96 ià(!
cmsg_pÜt
)

97  -
EOPNOTSUPP
;

98 
äame
->
š_pÜt
 = 
	`ýu_to_be32
(
cmsg_pÜt
);

102 
	}
}

105 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

106 
	$nå_æow”_compže_mac
(
nå_æow”_mac_m¶s
 *
ext
,

107 
nå_æow”_mac_m¶s
 *
msk
,

108 
tc_þs_æow”_ofæßd
 *
æow
)

110 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

112 
	`mem£t
(
ext
, 0, (
nå_æow”_mac_m¶s
));

113 
	`mem£t
(
msk
, 0, (
nå_æow”_mac_m¶s
));

115 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ETH_ADDRS
)) {

116 
æow_m©ch_‘h_addrs
 
m©ch
;

118 
	`æow_ruË_m©ch_‘h_addrs
(
ruË
, &
m©ch
);

120 
	`‘h”_addr_cÝy
(
ext
->
mac_d¡
, &
m©ch
.
key
->
d¡
[0]);

121 
	`‘h”_addr_cÝy
(
ext
->
mac_¤c
, &
m©ch
.
key
->
¤c
[0]);

122 
	`‘h”_addr_cÝy
(
msk
->
mac_d¡
, &
m©ch
.
mask
->
d¡
[0]);

123 
	`‘h”_addr_cÝy
(
msk
->
mac_¤c
, &
m©ch
.
mask
->
¤c
[0]);

126 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_MPLS
)) {

127 
æow_m©ch_m¶s
 
m©ch
;

128 
u32
 
t_m¶s
;

130 
	`æow_ruË_m©ch_m¶s
(
ruË
, &
m©ch
);

131 
t_m¶s
 = 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_LB
, 
m©ch
.
key
->
m¶s_Ïb–
) |

132 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_TC
, 
m©ch
.
key
->
m¶s_tc
) |

133 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_BOS
, 
m©ch
.
key
->
m¶s_bos
) |

134 
NFP_FLOWER_MASK_MPLS_Q
;

135 
ext
->
m¶s_l£
 = 
	`ýu_to_be32
(
t_m¶s
);

136 
t_m¶s
 = 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_LB
, 
m©ch
.
mask
->
m¶s_Ïb–
) |

137 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_TC
, 
m©ch
.
mask
->
m¶s_tc
) |

138 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_BOS
, 
m©ch
.
mask
->
m¶s_bos
) |

139 
NFP_FLOWER_MASK_MPLS_Q
;

140 
msk
->
m¶s_l£
 = 
	`ýu_to_be32
(
t_m¶s
);

141 } ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_BASIC
)) {

146 
æow_m©ch_basic
 
m©ch
;

148 
	`æow_ruË_m©ch_basic
(
ruË
, &
m©ch
);

149 ià(
m©ch
.
key
->
n_´Ùo
 =ð
	`ýu_to_be16
(
ETH_P_MPLS_UC
) ||

150 
m©ch
.
key
->
n_´Ùo
 =ð
	`ýu_to_be16
(
ETH_P_MPLS_MC
)) {

151 
ext
->
m¶s_l£
 = 
	`ýu_to_be32
(
NFP_FLOWER_MASK_MPLS_Q
);

152 
msk
->
m¶s_l£
 = 
	`ýu_to_be32
(
NFP_FLOWER_MASK_MPLS_Q
);

155 
	}
}

157 
	$nå_æow”_compže_mac
(
nå_æow”_mac_m¶s
 *
äame
,

158 
tc_þs_æow”_ofæßd
 *
æow
,

159 
boÞ
 
mask_v”siÚ
)

161 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

162 
æow_dis£ùÜ_key_‘h_addrs
 *
addr
;

164 
	`mem£t
(
äame
, 0, (
nå_æow”_mac_m¶s
));

166 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_ETH_ADDRS
)) {

167 
addr
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

168 
FLOW_DISSECTOR_KEY_ETH_ADDRS
,

169 
rg‘
);

171 
	`‘h”_addr_cÝy
(
äame
->
mac_d¡
, &
addr
->
d¡
[0]);

172 
	`‘h”_addr_cÝy
(
äame
->
mac_¤c
, &
addr
->
¤c
[0]);

175 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_MPLS
)) {

176 
æow_dis£ùÜ_key_m¶s
 *
m¶s
;

177 
u32
 
t_m¶s
;

179 
m¶s
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

180 
FLOW_DISSECTOR_KEY_MPLS
,

181 
rg‘
);

183 
t_m¶s
 = 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_LB
, 
m¶s
->
m¶s_Ïb–
) |

184 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_TC
, 
m¶s
->
m¶s_tc
) |

185 
	`FIELD_PREP
(
NFP_FLOWER_MASK_MPLS_BOS
, 
m¶s
->
m¶s_bos
) |

186 
NFP_FLOWER_MASK_MPLS_Q
;

188 
äame
->
m¶s_l£
 = 
	`ýu_to_be32
(
t_m¶s
);

189 } ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
,

190 
FLOW_DISSECTOR_KEY_BASIC
)) {

195 
æow_dis£ùÜ_key_basic
 *
key_basic
;

197 
key_basic
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

198 
FLOW_DISSECTOR_KEY_BASIC
,

199 
æow
->
key
);

200 ià(
key_basic
->
n_´Ùo
 =ð
	`ýu_to_be16
(
ETH_P_MPLS_UC
) ||

201 
key_basic
->
n_´Ùo
 =ð
	`ýu_to_be16
(
ETH_P_MPLS_MC
))

202 
äame
->
m¶s_l£
 = 
	`ýu_to_be32
(
NFP_FLOWER_MASK_MPLS_Q
);

204 
	}
}

208 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

209 
	$nå_æow”_compže_Üt
(
nå_æow”__pÜts
 *
ext
,

210 
nå_æow”__pÜts
 *
msk
,

211 
tc_þs_æow”_ofæßd
 *
æow
)

213 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

215 
	`mem£t
(
ext
, 0, (
nå_æow”__pÜts
));

216 
	`mem£t
(
msk
, 0, (
nå_æow”__pÜts
));

218 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_PORTS
)) {

219 
æow_m©ch_pÜts
 
m©ch
;

221 
	`æow_ruË_m©ch_pÜts
(
ruË
, &
m©ch
);

222 
ext
->
pÜt_¤c
 = 
m©ch
.
key
->
¤c
;

223 
ext
->
pÜt_d¡
 = 
m©ch
.
key
->
d¡
;

224 
msk
->
pÜt_¤c
 = 
m©ch
.
mask
->
¤c
;

225 
msk
->
pÜt_d¡
 = 
m©ch
.
mask
->
d¡
;

227 
	}
}

229 
	$nå_æow”_compže_Üt
(
nå_æow”__pÜts
 *
äame
,

230 
tc_þs_æow”_ofæßd
 *
æow
,

231 
boÞ
 
mask_v”siÚ
)

233 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

234 
æow_dis£ùÜ_key_pÜts
 *

;

236 
	`mem£t
(
äame
, 0, (
nå_æow”__pÜts
));

238 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_PORTS
)) {

239 

 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

240 
FLOW_DISSECTOR_KEY_PORTS
,

241 
rg‘
);

242 
äame
->
pÜt_¤c
 = 

->
¤c
;

243 
äame
->
pÜt_d¡
 = 

->
d¡
;

245 
	}
}

249 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

250 
	$nå_æow”_compže__ext
(
nå_æow”__ext
 *
ext
,

251 
nå_æow”__ext
 *
msk
,

252 
tc_þs_æow”_ofæßd
 *
æow
)

254 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

256 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_BASIC
)) {

257 
æow_m©ch_basic
 
m©ch
;

259 
	`æow_ruË_m©ch_basic
(
ruË
, &
m©ch
);

260 
ext
->
´Ùo
 = 
m©ch
.
key
->
_´Ùo
;

261 
msk
->
´Ùo
 = 
m©ch
.
mask
->
_´Ùo
;

264 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_IP
)) {

265 
æow_m©ch_
 
m©ch
;

267 
	`æow_ruË_m©ch_
(
ruË
, &
m©ch
);

268 
ext
->
tos
 = 
m©ch
.
key
->tos;

269 
ext
->
‰l
 = 
m©ch
.
key
->ttl;

270 
msk
->
tos
 = 
m©ch
.
mask
->tos;

271 
msk
->
‰l
 = 
m©ch
.
mask
->ttl;

274 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_TCP
)) {

275 
u16
 
tý_æags
, 
tý_æags_mask
;

276 
æow_m©ch_tý
 
m©ch
;

278 
	`æow_ruË_m©ch_tý
(
ruË
, &
m©ch
);

279 
tý_æags
 = 
	`be16_to_ýu
(
m©ch
.
key
->
æags
);

280 
tý_æags_mask
 = 
	`be16_to_ýu
(
m©ch
.
mask
->
æags
);

282 ià(
tý_æags
 & 
TCPHDR_FIN
)

283 
ext
->
æags
 |ð
NFP_FL_TCP_FLAG_FIN
;

284 ià(
tý_æags_mask
 & 
TCPHDR_FIN
)

285 
msk
->
æags
 |ð
NFP_FL_TCP_FLAG_FIN
;

287 ià(
tý_æags
 & 
TCPHDR_SYN
)

288 
ext
->
æags
 |ð
NFP_FL_TCP_FLAG_SYN
;

289 ià(
tý_æags_mask
 & 
TCPHDR_SYN
)

290 
msk
->
æags
 |ð
NFP_FL_TCP_FLAG_SYN
;

292 ià(
tý_æags
 & 
TCPHDR_RST
)

293 
ext
->
æags
 |ð
NFP_FL_TCP_FLAG_RST
;

294 ià(
tý_æags_mask
 & 
TCPHDR_RST
)

295 
msk
->
æags
 |ð
NFP_FL_TCP_FLAG_RST
;

297 ià(
tý_æags
 & 
TCPHDR_PSH
)

298 
ext
->
æags
 |ð
NFP_FL_TCP_FLAG_PSH
;

299 ià(
tý_æags_mask
 & 
TCPHDR_PSH
)

300 
msk
->
æags
 |ð
NFP_FL_TCP_FLAG_PSH
;

302 ià(
tý_æags
 & 
TCPHDR_URG
)

303 
ext
->
æags
 |ð
NFP_FL_TCP_FLAG_URG
;

304 ià(
tý_æags_mask
 & 
TCPHDR_URG
)

305 
msk
->
æags
 |ð
NFP_FL_TCP_FLAG_URG
;

308 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_CONTROL
)) {

309 
æow_m©ch_cÚŒÞ
 
m©ch
;

311 
	`æow_ruË_m©ch_cÚŒÞ
(
ruË
, &
m©ch
);

312 ià(
m©ch
.
key
->
æags
 & 
FLOW_DIS_IS_FRAGMENT
)

313 
ext
->
æags
 |ð
NFP_FL_IP_FRAGMENTED
;

314 ià(
m©ch
.
mask
->
æags
 & 
FLOW_DIS_IS_FRAGMENT
)

315 
msk
->
æags
 |ð
NFP_FL_IP_FRAGMENTED
;

316 ià(
m©ch
.
key
->
æags
 & 
FLOW_DIS_FIRST_FRAG
)

317 
ext
->
æags
 |ð
NFP_FL_IP_FRAG_FIRST
;

318 ià(
m©ch
.
mask
->
æags
 & 
FLOW_DIS_FIRST_FRAG
)

319 
msk
->
æags
 |ð
NFP_FL_IP_FRAG_FIRST
;

321 
	}
}

323 
	$nå_æow”_compže__ext
(
nå_æow”__ext
 *
äame
,

324 
tc_þs_æow”_ofæßd
 *
æow
,

325 
boÞ
 
mask_v”siÚ
)

327 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

329 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_BASIC
)) {

330 
æow_dis£ùÜ_key_basic
 *
basic
;

332 
basic
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

333 
FLOW_DISSECTOR_KEY_BASIC
,

334 
rg‘
);

335 
äame
->
´Ùo
 = 
basic
->
_´Ùo
;

338 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_IP
)) {

339 
æow_dis£ùÜ_key_
 *
æow_
;

341 
æow_
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

342 
FLOW_DISSECTOR_KEY_IP
,

343 
rg‘
);

344 
äame
->
tos
 = 
æow_
->tos;

345 
äame
->
‰l
 = 
æow_
->ttl;

348 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_TCP
)) {

349 
æow_dis£ùÜ_key_tý
 *
tý
;

350 
u32
 
tý_æags
;

352 
tý
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

353 
FLOW_DISSECTOR_KEY_TCP
, 
rg‘
);

354 
tý_æags
 = 
	`be16_to_ýu
(
tý
->
æags
);

356 ià(
tý_æags
 & 
TCPHDR_FIN
)

357 
äame
->
æags
 |ð
NFP_FL_TCP_FLAG_FIN
;

358 ià(
tý_æags
 & 
TCPHDR_SYN
)

359 
äame
->
æags
 |ð
NFP_FL_TCP_FLAG_SYN
;

360 ià(
tý_æags
 & 
TCPHDR_RST
)

361 
äame
->
æags
 |ð
NFP_FL_TCP_FLAG_RST
;

362 ià(
tý_æags
 & 
TCPHDR_PSH
)

363 
äame
->
æags
 |ð
NFP_FL_TCP_FLAG_PSH
;

364 ià(
tý_æags
 & 
TCPHDR_URG
)

365 
äame
->
æags
 |ð
NFP_FL_TCP_FLAG_URG
;

368 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_CONTROL
)) {

369 
æow_dis£ùÜ_key_cÚŒÞ
 *
key
;

371 
key
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

372 
FLOW_DISSECTOR_KEY_CONTROL
,

373 
rg‘
);

374 ià(
key
->
æags
 & 
FLOW_DIS_IS_FRAGMENT
)

375 
äame
->
æags
 |ð
NFP_FL_IP_FRAGMENTED
;

376 ià(
key
->
æags
 & 
FLOW_DIS_FIRST_FRAG
)

377 
äame
->
æags
 |ð
NFP_FL_IP_FRAG_FIRST
;

379 
	}
}

383 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

384 
	$nå_æow”_compže_v4
(
nå_æow”_v4
 *
ext
,

385 
nå_æow”_v4
 *
msk
,

386 
tc_þs_æow”_ofæßd
 *
æow
)

388 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

389 
æow_m©ch_v4_addrs
 
m©ch
;

391 
	`mem£t
(
ext
, 0, (
nå_æow”_v4
));

392 
	`mem£t
(
msk
, 0, (
nå_æow”_v4
));

394 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_IPV4_ADDRS
)) {

395 
	`æow_ruË_m©ch_v4_addrs
(
ruË
, &
m©ch
);

396 
ext
->
v4_¤c
 = 
m©ch
.
key
->
¤c
;

397 
ext
->
v4_d¡
 = 
m©ch
.
key
->
d¡
;

398 
msk
->
v4_¤c
 = 
m©ch
.
mask
->
¤c
;

399 
msk
->
v4_d¡
 = 
m©ch
.
mask
->
d¡
;

402 
	`nå_æow”_compže__ext
(&
ext
->
_ext
, &
msk
->_ext, 
æow
);

403 
	}
}

405 
	$nå_æow”_compže_v4
(
nå_æow”_v4
 *
äame
,

406 
tc_þs_æow”_ofæßd
 *
æow
,

407 
boÞ
 
mask_v”siÚ
)

409 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

410 
æow_dis£ùÜ_key_v4_addrs
 *
addr
;

412 
	`mem£t
(
äame
, 0, (
nå_æow”_v4
));

414 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
,

415 
FLOW_DISSECTOR_KEY_IPV4_ADDRS
)) {

416 
addr
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

417 
FLOW_DISSECTOR_KEY_IPV4_ADDRS
,

418 
rg‘
);

419 
äame
->
v4_¤c
 = 
addr
->
¤c
;

420 
äame
->
v4_d¡
 = 
addr
->
d¡
;

423 
	`nå_æow”_compže__ext
(&
äame
->
_ext
, 
æow
, 
mask_v”siÚ
);

424 
	}
}

428 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

429 
	$nå_æow”_compže_v6
(
nå_æow”_v6
 *
ext
,

430 
nå_æow”_v6
 *
msk
,

431 
tc_þs_æow”_ofæßd
 *
æow
)

433 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

435 
	`mem£t
(
ext
, 0, (
nå_æow”_v6
));

436 
	`mem£t
(
msk
, 0, (
nå_æow”_v6
));

438 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_IPV6_ADDRS
)) {

439 
æow_m©ch_v6_addrs
 
m©ch
;

441 
	`æow_ruË_m©ch_v6_addrs
(
ruË
, &
m©ch
);

442 
ext
->
v6_¤c
 = 
m©ch
.
key
->
¤c
;

443 
ext
->
v6_d¡
 = 
m©ch
.
key
->
d¡
;

444 
msk
->
v6_¤c
 = 
m©ch
.
mask
->
¤c
;

445 
msk
->
v6_d¡
 = 
m©ch
.
mask
->
d¡
;

448 
	`nå_æow”_compže__ext
(&
ext
->
_ext
, &
msk
->_ext, 
æow
);

449 
	}
}

451 
	$nå_æow”_compže_v6
(
nå_æow”_v6
 *
äame
,

452 
tc_þs_æow”_ofæßd
 *
æow
,

453 
boÞ
 
mask_v”siÚ
)

455 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

456 
æow_dis£ùÜ_key_v6_addrs
 *
addr
;

458 
	`mem£t
(
äame
, 0, (
nå_æow”_v6
));

460 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
,

461 
FLOW_DISSECTOR_KEY_IPV6_ADDRS
)) {

462 
addr
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

463 
FLOW_DISSECTOR_KEY_IPV6_ADDRS
,

464 
rg‘
);

465 
äame
->
v6_¤c
 = 
addr
->
¤c
;

466 
äame
->
v6_d¡
 = 
addr
->
d¡
;

469 
	`nå_æow”_compže__ext
(&
äame
->
_ext
, 
æow
, 
mask_v”siÚ
);

470 
	}
}

474 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

475 
	$nå_æow”_compže_g’eve_Ýt
(*
ext
, *
msk
,

476 
tc_þs_æow”_ofæßd
 *
æow
)

478 
æow_m©ch_’c_Ýts
 
m©ch
;

480 
	`æow_ruË_m©ch_’c_Ýts
(
æow
->
ruË
, &
m©ch
);

481 
	`memýy
(
ext
, 
m©ch
.
key
->
d©a
, m©ch.key->
Ën
);

482 
	`memýy
(
msk
, 
m©ch
.
mask
->
d©a
, m©ch.mask->
Ën
);

485 
	}
}

487 
	$nå_æow”_compže_g’eve_Ýt
(*
key_buf
, 
tc_þs_æow”_ofæßd
 *
æow
,

488 
boÞ
 
mask_v”siÚ
)

490 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

491 
æow_dis£ùÜ_key_’c_Ýts
 *
Ýts
;

493 
Ýts
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

494 
FLOW_DISSECTOR_KEY_ENC_OPTS
,

495 
rg‘
);

496 
	`memýy
(
key_buf
, 
Ýts
->
d©a
, o±s->
Ën
);

499 
	}
}

503 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

504 
	$nå_æow”_compže_v4_udp_tun
(
nå_æow”_v4_udp_tun
 *
ext
,

505 
nå_æow”_v4_udp_tun
 *
msk
,

506 
tc_þs_æow”_ofæßd
 *
æow
)

508 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

510 
	`mem£t
(
ext
, 0, (
nå_æow”_v4_udp_tun
));

511 
	`mem£t
(
msk
, 0, (
nå_æow”_v4_udp_tun
));

513 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ENC_KEYID
)) {

514 
æow_m©ch_’c_keyid
 
m©ch
;

515 
u32
 
‹mp_vni
;

517 
	`æow_ruË_m©ch_’c_keyid
(
ruË
, &
m©ch
);

518 
‹mp_vni
 = 
	`be32_to_ýu
(
m©ch
.
key
->
keyid
è<< 
NFP_FL_TUN_VNI_OFFSET
;

519 
ext
->
tun_id
 = 
	`ýu_to_be32
(
‹mp_vni
);

520 
‹mp_vni
 = 
	`be32_to_ýu
(
m©ch
.
mask
->
keyid
è<< 
NFP_FL_TUN_VNI_OFFSET
;

521 
msk
->
tun_id
 = 
	`ýu_to_be32
(
‹mp_vni
);

524 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ENC_IPV4_ADDRS
)) {

525 
æow_m©ch_v4_addrs
 
m©ch
;

527 
	`æow_ruË_m©ch_’c_v4_addrs
(
ruË
, &
m©ch
);

528 
ext
->
_¤c
 = 
m©ch
.
key
->
¤c
;

529 
ext
->
_d¡
 = 
m©ch
.
key
->
d¡
;

530 
msk
->
_¤c
 = 
m©ch
.
mask
->
¤c
;

531 
msk
->
_d¡
 = 
m©ch
.
mask
->
d¡
;

534 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ENC_IP
)) {

535 
æow_m©ch_
 
m©ch
;

537 
	`æow_ruË_m©ch_’c_
(
ruË
, &
m©ch
);

538 
ext
->
tos
 = 
m©ch
.
key
->tos;

539 
ext
->
‰l
 = 
m©ch
.
key
->ttl;

540 
msk
->
tos
 = 
m©ch
.
mask
->tos;

541 
msk
->
‰l
 = 
m©ch
.
mask
->ttl;

543 
	}
}

545 
	$nå_æow”_compže_v4_udp_tun
(
nå_æow”_v4_udp_tun
 *
äame
,

546 
tc_þs_æow”_ofæßd
 *
æow
,

547 
boÞ
 
mask_v”siÚ
)

549 
æ_æow_key
 *
rg‘
 = 
mask_v”siÚ
 ? 
æow
->
mask
 : flow->
key
;

550 
æow_dis£ùÜ_key_v4_addrs
 *
tun_s
;

551 
æow_dis£ùÜ_key_keyid
 *
vni
;

552 
æow_dis£ùÜ_key_
 *

;

554 
	`mem£t
(
äame
, 0, (
nå_æow”_v4_udp_tun
));

556 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
,

557 
FLOW_DISSECTOR_KEY_ENC_KEYID
)) {

558 
u32
 
‹mp_vni
;

560 
vni
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

561 
FLOW_DISSECTOR_KEY_ENC_KEYID
,

562 
rg‘
);

563 
‹mp_vni
 = 
	`be32_to_ýu
(
vni
->
keyid
è<< 
NFP_FL_TUN_VNI_OFFSET
;

564 
äame
->
tun_id
 = 
	`ýu_to_be32
(
‹mp_vni
);

567 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
,

568 
FLOW_DISSECTOR_KEY_ENC_IPV4_ADDRS
)) {

569 
tun_s
 =

570 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

571 
FLOW_DISSECTOR_KEY_ENC_IPV4_ADDRS
,

572 
rg‘
);

573 
äame
->
_¤c
 = 
tun_s
->
¤c
;

574 
äame
->
_d¡
 = 
tun_s
->
d¡
;

577 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_ENC_IP
)) {

578 

 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

579 
FLOW_DISSECTOR_KEY_ENC_IP
,

580 
rg‘
);

581 
äame
->
tos
 = 

->tos;

582 
äame
->
‰l
 = 

->ttl;

584 
	}
}

587 
	$nå_æow”_compže_æow_m©ch
(
nå_­p
 *
­p
,

588 
tc_þs_æow”_ofæßd
 *
æow
,

589 
nå_æ_key_ls
 *
key_ls
,

590 
Ãt_deviû
 *
Ãtdev
,

591 
nå_æ_·ylßd
 *
nå_æow
,

592 
nå_æow”_tun_ty³
 
tun_ty³
)

594 
u32
 
cmsg_pÜt
 = 0;

595 
”r
;

596 
u8
 *
ext
;

597 
u8
 *
msk
;

599 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
))

600 
cmsg_pÜt
 = 
	`nå_»´_g‘_pÜt_id
(
Ãtdev
);

602 
	`mem£t
(
nå_æow
->
unmasked_d©a
, 0, 
key_ls
->
key_size
);

603 
	`mem£t
(
nå_æow
->
mask_d©a
, 0, 
key_ls
->
key_size
);

605 
ext
 = 
nå_æow
->
unmasked_d©a
;

606 
msk
 = 
nå_æow
->
mask_d©a
;

608 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

609 
	`nå_æow”_compže_m‘a_tci
((
nå_æow”_m‘a_tci
 *)
ext
,

610 (
nå_æow”_m‘a_tci
 *)
msk
,

611 
æow
, 
key_ls
->
key_Ïy”
);

614 
	`nå_æow”_compže_m‘a_tci
((
nå_æow”_m‘a_tci
 *)
ext
,

615 
æow
, 
key_ls
->
key_Ïy”
, 
çl£
);

617 
	`nå_æow”_compže_m‘a_tci
((
nå_æow”_m‘a_tci
 *)
msk
,

618 
æow
, 
key_ls
->
key_Ïy”
, 
Œue
);

620 
ext
 +ð(
nå_æow”_m‘a_tci
);

621 
msk
 +ð(
nå_æow”_m‘a_tci
);

624 ià(
NFP_FLOWER_LAYER_EXT_META
 & 
key_ls
->
key_Ïy”
) {

625 
	`nå_æow”_compže_ext_m‘a
((
nå_æow”_ext_m‘a
 *)
ext
,

626 
key_ls
->
key_Ïy”_two
);

627 
	`nå_æow”_compže_ext_m‘a
((
nå_æow”_ext_m‘a
 *)
msk
,

628 
key_ls
->
key_Ïy”_two
);

629 
ext
 +ð(
nå_æow”_ext_m‘a
);

630 
msk
 +ð(
nå_æow”_ext_m‘a
);

634 
”r
 = 
	`nå_æow”_compže_pÜt
((
nå_æow”_š_pÜt
 *)
ext
,

635 
cmsg_pÜt
, 
çl£
, 
tun_ty³
);

636 ià(
”r
)

637  
”r
;

640 
”r
 = 
	`nå_æow”_compže_pÜt
((
nå_æow”_š_pÜt
 *)
msk
,

641 
cmsg_pÜt
, 
Œue
, 
tun_ty³
);

642 ià(
”r
)

643  
”r
;

645 
ext
 +ð(
nå_æow”_š_pÜt
);

646 
msk
 +ð(
nå_æow”_š_pÜt
);

648 ià(
NFP_FLOWER_LAYER_MAC
 & 
key_ls
->
key_Ïy”
) {

649 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

650 
	`nå_æow”_compže_mac
((
nå_æow”_mac_m¶s
 *)
ext
,

651 (
nå_æow”_mac_m¶s
 *)
msk
,

652 
æow
);

655 
	`nå_æow”_compže_mac
((
nå_æow”_mac_m¶s
 *)
ext
,

656 
æow
, 
çl£
);

658 
	`nå_æow”_compže_mac
((
nå_æow”_mac_m¶s
 *)
msk
,

659 
æow
, 
Œue
);

661 
ext
 +ð(
nå_æow”_mac_m¶s
);

662 
msk
 +ð(
nå_æow”_mac_m¶s
);

665 ià(
NFP_FLOWER_LAYER_TP
 & 
key_ls
->
key_Ïy”
) {

666 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

667 
	`nå_æow”_compže_Üt
((
nå_æow”__pÜts
 *)
ext
,

668 (
nå_æow”__pÜts
 *)
msk
,

669 
æow
);

672 
	`nå_æow”_compže_Üt
((
nå_æow”__pÜts
 *)
ext
,

673 
æow
, 
çl£
);

675 
	`nå_æow”_compže_Üt
((
nå_æow”__pÜts
 *)
msk
,

676 
æow
, 
Œue
);

678 
ext
 +ð(
nå_æow”__pÜts
);

679 
msk
 +ð(
nå_æow”__pÜts
);

682 ià(
NFP_FLOWER_LAYER_IPV4
 & 
key_ls
->
key_Ïy”
) {

683 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

684 
	`nå_æow”_compže_v4
((
nå_æow”_v4
 *)
ext
,

685 (
nå_æow”_v4
 *)
msk
,

686 
æow
);

689 
	`nå_æow”_compže_v4
((
nå_æow”_v4
 *)
ext
,

690 
æow
, 
çl£
);

692 
	`nå_æow”_compže_v4
((
nå_æow”_v4
 *)
msk
,

693 
æow
, 
Œue
);

695 
ext
 +ð(
nå_æow”_v4
);

696 
msk
 +ð(
nå_æow”_v4
);

699 ià(
NFP_FLOWER_LAYER_IPV6
 & 
key_ls
->
key_Ïy”
) {

700 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

701 
	`nå_æow”_compže_v6
((
nå_æow”_v6
 *)
ext
,

702 (
nå_æow”_v6
 *)
msk
,

703 
æow
);

706 
	`nå_æow”_compže_v6
((
nå_æow”_v6
 *)
ext
,

707 
æow
, 
çl£
);

709 
	`nå_æow”_compže_v6
((
nå_æow”_v6
 *)
msk
,

710 
æow
, 
Œue
);

712 
ext
 +ð(
nå_æow”_v6
);

713 
msk
 +ð(
nå_æow”_v6
);

716 ià(
key_ls
->
key_Ïy”
 & 
NFP_FLOWER_LAYER_VXLAN
 ||

717 
key_ls
->
key_Ïy”_two
 & 
NFP_FLOWER_LAYER2_GENEVE
) {

718 
__be32
 
tun_d¡
;

720 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

721 
	`nå_æow”_compže_v4_udp_tun
((*)
ext
, (*)
msk
, 
æow
);

724 
	`nå_æow”_compže_v4_udp_tun
((*)
ext
, 
æow
, 
çl£
);

726 
	`nå_æow”_compže_v4_udp_tun
((*)
msk
, 
æow
, 
Œue
);

728 
tun_d¡
 = ((
nå_æow”_v4_udp_tun
 *)
ext
)->
_d¡
;

729 
ext
 +ð(
nå_æow”_v4_udp_tun
);

730 
msk
 +ð(
nå_æow”_v4_udp_tun
);

735 
nå_æow
->
nå_tun_v4_addr
 = 
tun_d¡
;

736 
	`nå_tuÂ–_add_v4_off
(
­p
, 
tun_d¡
);

738 ià(
key_ls
->
key_Ïy”_two
 & 
NFP_FLOWER_LAYER2_GENEVE_OP
) {

739 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

740 
”r
 = 
	`nå_æow”_compže_g’eve_Ýt
(
ext
, 
msk
, 
æow
);

742 
”r
 = 
	`nå_æow”_compže_g’eve_Ýt
(
ext
, 
æow
, 
çl£
);

743 ià(
”r
)

744  
”r
;

746 
”r
 = 
	`nå_æow”_compže_g’eve_Ýt
(
msk
, 
æow
, 
Œue
);

748 ià(
”r
)

749  
”r
;

754 
	}
}

	@src/flower/metadata.c

4 
	~<lšux/hash.h
>

5 
	~<lšux/hashbË.h
>

6 
	~<lšux/jhash.h
>

7 
	~<lšux/m©h64.h
>

8 
	~<lšux/vm®loc.h
>

9 
	~<Ãt/pkt_þs.h
>

11 
	~"cmsg.h
"

12 
	~"maš.h
"

13 
	~"../nå_­p.h
"

15 
	snå_mask_id_bË
 {

16 
hli¡_node
 
	mlšk
;

17 
u32
 
	mhash_key
;

18 
u32
 
	m»f_út
;

19 
u8
 
	mmask_id
;

22 
	snå_æ_æow_bË_cmp_¬g
 {

23 
Ãt_deviû
 *
	mÃtdev
;

24 
	mcook›
;

27 
	$nå_»Ëa£_¡©s_’Œy
(
nå_­p
 *
­p
, 
u32
 
¡©s_cÚ‹xt_id
)

29 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

30 
cœc_buf
 *
ršg
;

32 
ršg
 = &
´iv
->
¡©s_ids
.
ä“_li¡
;

34 ià(!
	`CIRC_SPACE
(
ršg
->
h—d
,„šg->
ž
,

35 
´iv
->
¡©s_ršg_size
 * 
NFP_FL_STATS_ELEM_RS
 -

36 
NFP_FL_STATS_ELEM_RS
 + 1))

37  -
ENOBUFS
;

39 
	`memýy
(&
ršg
->
buf
[ršg->
h—d
], &
¡©s_cÚ‹xt_id
, 
NFP_FL_STATS_ELEM_RS
);

40 
ršg
->
h—d
 = (ršg->h—d + 
NFP_FL_STATS_ELEM_RS
) %

41 (
´iv
->
¡©s_ršg_size
 * 
NFP_FL_STATS_ELEM_RS
);

44 
	}
}

46 
	$nå_g‘_¡©s_’Œy
(
nå_­p
 *
­p
, 
u32
 *
¡©s_cÚ‹xt_id
)

48 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

49 
u32
 
ä“d_¡©s_id
, 
‹mp_¡©s_id
;

50 
cœc_buf
 *
ršg
;

52 
ršg
 = &
´iv
->
¡©s_ids
.
ä“_li¡
;

53 
ä“d_¡©s_id
 = 
´iv
->
¡©s_ršg_size
;

55 ià(
´iv
->
¡©s_ids
.
š™_uÇÎoc
 > 0) {

56 ià(
´iv
->
aùive_mem_un™
 =ð´iv->
tÙ®_mem_un™s
) {

57 
´iv
->
¡©s_ids
.
š™_uÇÎoc
--;

58 
´iv
->
aùive_mem_un™
 = 0;

61 *
¡©s_cÚ‹xt_id
 =

62 
	`FIELD_PREP
(
NFP_FL_STAT_ID_STAT
,

63 
´iv
->
¡©s_ids
.
š™_uÇÎoc
 - 1) |

64 
	`FIELD_PREP
(
NFP_FL_STAT_ID_MU_NUM
,

65 
´iv
->
aùive_mem_un™
);

66 
´iv
->
aùive_mem_un™
++;

71 ià(
ršg
->
h—d
 =ðršg->
ž
) {

72 *
¡©s_cÚ‹xt_id
 = 
ä“d_¡©s_id
;

73  -
ENOENT
;

76 
	`memýy
(&
‹mp_¡©s_id
, &
ršg
->
buf
[ršg->
ž
], 
NFP_FL_STATS_ELEM_RS
);

77 *
¡©s_cÚ‹xt_id
 = 
‹mp_¡©s_id
;

78 
	`memýy
(&
ršg
->
buf
[ršg->
ž
], &
ä“d_¡©s_id
, 
NFP_FL_STATS_ELEM_RS
);

79 
ršg
->
ž
 = (ršg->ž + 
NFP_FL_STATS_ELEM_RS
) %

80 (
´iv
->
¡©s_ršg_size
 * 
NFP_FL_STATS_ELEM_RS
);

83 
	}
}

86 
nå_æ_·ylßd
 *

87 
	$nå_æow”_£¬ch_æ_bË
(
nå_­p
 *
­p
, 
tc_æow”_cook›
,

88 
Ãt_deviû
 *
Ãtdev
)

90 
nå_æ_æow_bË_cmp_¬g
 
æow”_cmp_¬g
;

91 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

93 
æow”_cmp_¬g
.
Ãtdev
 =‚etdev;

94 
æow”_cmp_¬g
.
cook›
 = 
tc_æow”_cook›
;

96  
	`rhashbË_lookup_ç¡
(&
´iv
->
æow_bË
, &
æow”_cmp_¬g
,

97 
nå_æow”_bË_·¿ms
);

98 
	}
}

100 
	$nå_æow”_rx_æow_¡©s
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

102 
msg_Ën
 = 
	`nå_æow”_cmsg_g‘_d©a_Ën
(
skb
);

103 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

104 
nå_æ_¡©s_äame
 *
¡©s
;

105 *
msg
;

106 
u32
 
ùx_id
;

107 
i
;

109 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

111 
	`¥š_lock
(&
´iv
->
¡©s_lock
);

112 
i
 = 0; i < 
msg_Ën
 / (*
¡©s
); i++) {

113 
¡©s
 = (
nå_æ_¡©s_äame
 *)
msg
 + 
i
;

114 
ùx_id
 = 
	`be32_to_ýu
(
¡©s
->
¡©s_cÚ_id
);

115 
´iv
->
¡©s
[
ùx_id
].
pkts
 +ð
	`be32_to_ýu
(¡©s->
pkt_couÁ
);

116 
´iv
->
¡©s
[
ùx_id
].
by‹s
 +ð
	`be64_to_ýu
(¡©s->
by‹_couÁ
);

117 
´iv
->
¡©s
[
ùx_id
].
u£d
 = 
jiff›s
;

119 
	`¥š_uÆock
(&
´iv
->
¡©s_lock
);

120 
	}
}

122 
	$nå_»Ëa£_mask_id
(
nå_­p
 *
­p
, 
u8
 
mask_id
)

124 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

125 
cœc_buf
 *
ršg
;

127 
ršg
 = &
´iv
->
mask_ids
.
mask_id_ä“_li¡
;

129 ià(
	`CIRC_SPACE
(
ršg
->
h—d
,„šg->
ž
, 
NFP_FLOWER_MASK_ENTRY_RS
) == 0)

130  -
ENOBUFS
;

132 
	`memýy
(&
ršg
->
buf
[ršg->
h—d
], &
mask_id
, 
NFP_FLOWER_MASK_ELEMENT_RS
);

133 
ršg
->
h—d
 = (ršg->h—d + 
NFP_FLOWER_MASK_ELEMENT_RS
) %

134 (
NFP_FLOWER_MASK_ENTRY_RS
 * 
NFP_FLOWER_MASK_ELEMENT_RS
);

136 
´iv
->
mask_ids
.
Ï¡_u£d
[
mask_id
] = 
	`ktime_g‘
();

139 
	}
}

141 
	$nå_mask_®loc
(
nå_­p
 *
­p
, 
u8
 *
mask_id
)

143 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

144 
ktime_t
 
»u£_timeout
;

145 
cœc_buf
 *
ršg
;

146 
u8
 
‹mp_id
, 
ä“d_id
;

148 
ršg
 = &
´iv
->
mask_ids
.
mask_id_ä“_li¡
;

149 
ä“d_id
 = 
NFP_FLOWER_MASK_ENTRY_RS
 - 1;

151 ià(
´iv
->
mask_ids
.
š™_uÇÎoÿ‹d
 > 0) {

152 *
mask_id
 = 
´iv
->
mask_ids
.
š™_uÇÎoÿ‹d
;

153 
´iv
->
mask_ids
.
š™_uÇÎoÿ‹d
--;

158 ià(
ršg
->
h—d
 =ðršg->
ž
)

159 
”r_nÙ_found
;

161 
	`memýy
(&
‹mp_id
, &
ršg
->
buf
[ršg->
ž
], 
NFP_FLOWER_MASK_ELEMENT_RS
);

162 *
mask_id
 = 
‹mp_id
;

164 
»u£_timeout
 = 
	`ktime_add_ns
(
´iv
->
mask_ids
.
Ï¡_u£d
[*
mask_id
],

165 
NFP_FL_MASK_REUSE_TIME_NS
);

167 ià(
	`ktime_befÜe
(
	`ktime_g‘
(), 
»u£_timeout
))

168 
”r_nÙ_found
;

170 
	`memýy
(&
ršg
->
buf
[ršg->
ž
], &
ä“d_id
, 
NFP_FLOWER_MASK_ELEMENT_RS
);

171 
ršg
->
ž
 = (ršg->ž + 
NFP_FLOWER_MASK_ELEMENT_RS
) %

172 (
NFP_FLOWER_MASK_ENTRY_RS
 * 
NFP_FLOWER_MASK_ELEMENT_RS
);

176 
”r_nÙ_found
:

177 *
mask_id
 = 
ä“d_id
;

178  -
ENOENT
;

179 
	}
}

182 
	$nå_add_mask_bË
(
nå_­p
 *
­p
, *
mask_d©a
, 
u32
 
mask_Ën
)

184 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

185 
nå_mask_id_bË
 *
mask_’Œy
;

186 
hash_key
;

187 
u8
 
mask_id
;

189 ià(
	`nå_mask_®loc
(
­p
, &
mask_id
))

190  -
ENOENT
;

192 
mask_’Œy
 = 
	`km®loc
((*mask_’Œy), 
GFP_KERNEL
);

193 ià(!
mask_’Œy
) {

194 
	`nå_»Ëa£_mask_id
(
­p
, 
mask_id
);

195  -
ENOMEM
;

198 
	`INIT_HLIST_NODE
(&
mask_’Œy
->
lšk
);

199 
mask_’Œy
->
mask_id
 = mask_id;

200 
hash_key
 = 
	`jhash
(
mask_d©a
, 
mask_Ën
, 
´iv
->
mask_id_£ed
);

201 
mask_’Œy
->
hash_key
 = hash_key;

202 
mask_’Œy
->
»f_út
 = 1;

203 
	`hash_add
(
´iv
->
mask_bË
, &
mask_’Œy
->
lšk
, 
hash_key
);

205  
mask_id
;

206 
	}
}

208 
nå_mask_id_bË
 *

209 
	$nå_£¬ch_mask_bË
(
nå_­p
 *
­p
, *
mask_d©a
, 
u32
 
mask_Ën
)

211 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

212 
nå_mask_id_bË
 *
mask_’Œy
;

213 
hash_key
;

215 
hash_key
 = 
	`jhash
(
mask_d©a
, 
mask_Ën
, 
´iv
->
mask_id_£ed
);

217 
	`hash_fÜ_—ch_possibË
(
´iv
->
mask_bË
, 
mask_’Œy
, 
lšk
, 
hash_key
)

218 ià(
mask_’Œy
->
hash_key
 == hash_key)

219  
mask_’Œy
;

221  
NULL
;

222 
	}
}

225 
	$nå_fšd_š_mask_bË
(
nå_­p
 *
­p
, *
mask_d©a
, 
u32
 
mask_Ën
)

227 
nå_mask_id_bË
 *
mask_’Œy
;

229 
mask_’Œy
 = 
	`nå_£¬ch_mask_bË
(
­p
, 
mask_d©a
, 
mask_Ën
);

230 ià(!
mask_’Œy
)

231  -
ENOENT
;

233 
mask_’Œy
->
»f_út
++;

236  
mask_’Œy
->
mask_id
;

237 
	}
}

239 
boÞ


240 
	$nå_check_mask_add
(
nå_­p
 *
­p
, *
mask_d©a
, 
u32
 
mask_Ën
,

241 
u8
 *
m‘a_æags
, u8 *
mask_id
)

243 
id
;

245 
id
 = 
	`nå_fšd_š_mask_bË
(
­p
, 
mask_d©a
, 
mask_Ën
);

246 ià(
id
 < 0) {

247 
id
 = 
	`nå_add_mask_bË
(
­p
, 
mask_d©a
, 
mask_Ën
);

248 ià(
id
 < 0)

249  
çl£
;

250 *
m‘a_æags
 |ð
NFP_FL_META_FLAG_MANAGE_MASK
;

252 *
mask_id
 = 
id
;

254  
Œue
;

255 
	}
}

257 
boÞ


258 
	$nå_check_mask_»move
(
nå_­p
 *
­p
, *
mask_d©a
, 
u32
 
mask_Ën
,

259 
u8
 *
m‘a_æags
, u8 *
mask_id
)

261 
nå_mask_id_bË
 *
mask_’Œy
;

263 
mask_’Œy
 = 
	`nå_£¬ch_mask_bË
(
­p
, 
mask_d©a
, 
mask_Ën
);

264 ià(!
mask_’Œy
)

265  
çl£
;

267 ià(
m‘a_æags
)

268 *
m‘a_æags
 &ð~
NFP_FL_META_FLAG_MANAGE_MASK
;

270 *
mask_id
 = 
mask_’Œy
->mask_id;

271 
mask_’Œy
->
»f_út
--;

272 ià(!
mask_’Œy
->
»f_út
) {

273 
	`hash_d–
(&
mask_’Œy
->
lšk
);

274 
	`nå_»Ëa£_mask_id
(
­p
, *
mask_id
);

275 
	`kä“
(
mask_’Œy
);

276 ià(
m‘a_æags
)

277 *
m‘a_æags
 |ð
NFP_FL_META_FLAG_MANAGE_MASK
;

280  
Œue
;

281 
	}
}

283 
	$nå_compže_æow_m‘ad©a
(
nå_­p
 *
­p
,

284 
tc_þs_æow”_ofæßd
 *
æow
,

285 
nå_æ_·ylßd
 *
nå_æow
,

286 
Ãt_deviû
 *
Ãtdev
)

288 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

289 
nå_æ_·ylßd
 *
check_’Œy
;

290 
u8
 
Ãw_mask_id
;

291 
u32
 
¡©s_cxt
;

293 ià(
	`nå_g‘_¡©s_’Œy
(
­p
, &
¡©s_cxt
))

294  -
ENOENT
;

296 
nå_æow
->
m‘a
.
ho¡_ùx_id
 = 
	`ýu_to_be32
(
¡©s_cxt
);

297 
nå_æow
->
m‘a
.
ho¡_cook›
 = 
	`ýu_to_be64
(
æow
->
cook›
);

298 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 0, 0)

299 
nå_æow
->
šg»ss_dev
 = 
Ãtdev
;

302 
Ãw_mask_id
 = 0;

303 ià(!
	`nå_check_mask_add
(
­p
, 
nå_æow
->
mask_d©a
,

304 
nå_æow
->
m‘a
.
mask_Ën
,

305 &
nå_æow
->
m‘a
.
æags
, &
Ãw_mask_id
)) {

306 ià(
	`nå_»Ëa£_¡©s_’Œy
(
­p
, 
¡©s_cxt
))

307  -
EINVAL
;

308  -
ENOENT
;

311 
nå_æow
->
m‘a
.
æow_v”siÚ
 = 
	`ýu_to_be64
(
´iv
->
æow”_v”siÚ
);

312 
´iv
->
æow”_v”siÚ
++;

315 
nå_æow
->
unmasked_d©a
[
NFP_FL_MASK_ID_LOCATION
] = 
Ãw_mask_id
;

316 
´iv
->
¡©s
[
¡©s_cxt
].
pkts
 = 0;

317 
´iv
->
¡©s
[
¡©s_cxt
].
by‹s
 = 0;

318 
´iv
->
¡©s
[
¡©s_cxt
].
u£d
 = 
jiff›s
;

320 
check_’Œy
 = 
	`nå_æow”_£¬ch_æ_bË
(
­p
, 
æow
->
cook›
, 
Ãtdev
);

321 ià(
check_’Œy
) {

322 ià(
	`nå_»Ëa£_¡©s_’Œy
(
­p
, 
¡©s_cxt
))

323  -
EINVAL
;

325 ià(!
	`nå_check_mask_»move
(
­p
, 
nå_æow
->
mask_d©a
,

326 
nå_æow
->
m‘a
.
mask_Ën
,

327 
NULL
, &
Ãw_mask_id
))

328  -
EINVAL
;

330  -
EEXIST
;

334 
	}
}

336 
	$nå_modify_æow_m‘ad©a
(
nå_­p
 *
­p
,

337 
nå_æ_·ylßd
 *
nå_æow
)

339 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

340 
u8
 
Ãw_mask_id
 = 0;

341 
u32
 
‹mp_ùx_id
;

343 
	`nå_check_mask_»move
(
­p
, 
nå_æow
->
mask_d©a
,

344 
nå_æow
->
m‘a
.
mask_Ën
, &nå_æow->m‘a.
æags
,

345 &
Ãw_mask_id
);

347 
nå_æow
->
m‘a
.
æow_v”siÚ
 = 
	`ýu_to_be64
(
´iv
->
æow”_v”siÚ
);

348 
´iv
->
æow”_v”siÚ
++;

351 
nå_æow
->
unmasked_d©a
[
NFP_FL_MASK_ID_LOCATION
] = 
Ãw_mask_id
;

354 
‹mp_ùx_id
 = 
	`be32_to_ýu
(
nå_æow
->
m‘a
.
ho¡_ùx_id
);

356  
	`nå_»Ëa£_¡©s_’Œy
(
­p
, 
‹mp_ùx_id
);

357 
	}
}

359 
	$nå_æ_obj_cmpâ
(
rhashbË_com·»_¬g
 *
¬g
,

360 cÚ¡ *
obj
)

362 cÚ¡ 
nå_æ_æow_bË_cmp_¬g
 *
cmp_¬g
 = 
¬g
->
key
;

363 cÚ¡ 
nå_æ_·ylßd
 *
æow_’Œy
 = 
obj
;

365 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

366 ià(!
cmp_¬g
->
Ãtdev
 || 
æow_’Œy
->
šg»ss_dev
 == cmp_arg->netdev)

368 ià(
æow_’Œy
->
šg»ss_dev
 =ð
cmp_¬g
->
Ãtdev
)

370  
æow_’Œy
->
tc_æow”_cook›
 !ð
cmp_¬g
->
cook›
;

373 
	}
}

375 
u32
 
	$nå_æ_obj_hashâ
(cÚ¡ *
d©a
, 
u32
 
Ën
, u32 
£ed
)

377 cÚ¡ 
nå_æ_·ylßd
 *
æow”_’Œy
 = 
d©a
;

379  
	`jhash2
((
u32
 *)&
æow”_’Œy
->
tc_æow”_cook›
,

380 (
æow”_’Œy
->
tc_æow”_cook›
è/ (
u32
),

381 
£ed
);

382 
	}
}

384 
u32
 
	$nå_æ_key_hashâ
(cÚ¡ *
d©a
, 
u32
 
Ën
, u32 
£ed
)

386 cÚ¡ 
nå_æ_æow_bË_cmp_¬g
 *
cmp_¬g
 = 
d©a
;

388  
	`jhash2
((
u32
 *)&
cmp_¬g
->
cook›
,

389 (
cmp_¬g
->
cook›
è/ (
u32
), 
£ed
);

390 
	}
}

392 cÚ¡ 
rhashbË_·¿ms
 
	gnå_æow”_bË_·¿ms
 = {

393 .
h—d_off£t
 = 
off£tof
(
nå_æ_·ylßd
, 
æ_node
),

394 .
	ghashâ
 = 
nå_æ_key_hashâ
,

395 .
	gobj_cmpâ
 = 
nå_æ_obj_cmpâ
,

396 .
	gobj_hashâ
 = 
nå_æ_obj_hashâ
,

397 .
	gautom©ic_shrškšg
 = 
Œue
,

400 
	$nå_æow”_m‘ad©a_š™
(
nå_­p
 *
­p
, 
u64
 
ho¡_ùx_couÁ
,

401 
ho¡_num_mems
)

403 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

404 
”r
, 
¡©s_size
;

406 
	`hash_š™
(
´iv
->
mask_bË
);

408 
”r
 = 
	`rhashbË_š™
(&
´iv
->
æow_bË
, &
nå_æow”_bË_·¿ms
);

409 ià(
”r
)

410  
”r
;

412 
	`g‘_¿ndom_by‹s
(&
´iv
->
mask_id_£ed
, (priv->mask_id_seed));

415 
´iv
->
mask_ids
.
mask_id_ä“_li¡
.
buf
 =

416 
	`km®loc_¬¿y
(
NFP_FLOWER_MASK_ENTRY_RS
,

417 
NFP_FLOWER_MASK_ELEMENT_RS
, 
GFP_KERNEL
);

418 ià(!
´iv
->
mask_ids
.
mask_id_ä“_li¡
.
buf
)

419 
”r_ä“_æow_bË
;

421 
´iv
->
mask_ids
.
š™_uÇÎoÿ‹d
 = 
NFP_FLOWER_MASK_ENTRY_RS
 - 1;

424 
´iv
->
mask_ids
.
Ï¡_u£d
 =

425 
	`km®loc_¬¿y
(
NFP_FLOWER_MASK_ENTRY_RS
,

426 (*
´iv
->
mask_ids
.
Ï¡_u£d
), 
GFP_KERNEL
);

427 ià(!
´iv
->
mask_ids
.
Ï¡_u£d
)

428 
”r_ä“_mask_id
;

431 
´iv
->
¡©s_ids
.
ä“_li¡
.
buf
 =

432 
	`vm®loc
(
	`¬¿y_size
(
NFP_FL_STATS_ELEM_RS
,

433 
´iv
->
¡©s_ršg_size
));

434 ià(!
´iv
->
¡©s_ids
.
ä“_li¡
.
buf
)

435 
”r_ä“_Ï¡_u£d
;

437 
´iv
->
¡©s_ids
.
š™_uÇÎoc
 = 
	`div_u64
(
ho¡_ùx_couÁ
, 
ho¡_num_mems
);

439 
¡©s_size
 = 
	`FIELD_PREP
(
NFP_FL_STAT_ID_STAT
, 
ho¡_ùx_couÁ
) |

440 
	`FIELD_PREP
(
NFP_FL_STAT_ID_MU_NUM
, 
ho¡_num_mems
 - 1);

441 
´iv
->
¡©s
 = 
	`kvm®loc_¬¿y
(
¡©s_size
, (
nå_æ_¡©s
),

442 
GFP_KERNEL
);

443 ià(!
´iv
->
¡©s
)

444 
”r_ä“_ršg_buf
;

446 
	`¥š_lock_š™
(&
´iv
->
¡©s_lock
);

450 
”r_ä“_ršg_buf
:

451 
	`vä“
(
´iv
->
¡©s_ids
.
ä“_li¡
.
buf
);

452 
”r_ä“_Ï¡_u£d
:

453 
	`kä“
(
´iv
->
mask_ids
.
Ï¡_u£d
);

454 
”r_ä“_mask_id
:

455 
	`kä“
(
´iv
->
mask_ids
.
mask_id_ä“_li¡
.
buf
);

456 
”r_ä“_æow_bË
:

457 
	`rhashbË_de¡roy
(&
´iv
->
æow_bË
);

458  -
ENOMEM
;

459 
	}
}

461 
	$nå_æow”_m‘ad©a_þ—nup
(
nå_­p
 *
­p
)

463 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

465 ià(!
´iv
)

468 
	`rhashbË_ä“_ªd_de¡roy
(&
´iv
->
æow_bË
,

469 
nå_check_rhashbË_em±y
, 
NULL
);

470 
	`kvä“
(
´iv
->
¡©s
);

471 
	`kä“
(
´iv
->
mask_ids
.
mask_id_ä“_li¡
.
buf
);

472 
	`kä“
(
´iv
->
mask_ids
.
Ï¡_u£d
);

473 
	`vä“
(
´iv
->
¡©s_ids
.
ä“_li¡
.
buf
);

474 
	}
}

	@src/flower/offload.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/skbuff.h
>

7 
	~<Ãt/devlšk.h
>

8 
	~<Ãt/pkt_þs.h
>

10 
	~"cmsg.h
"

11 
	~"maš.h
"

12 
	~"../nåcÜe/nå_ýp.h
"

13 
	~"../nåcÜe/nå_n¥.h
"

14 
	~"../nå_­p.h
"

15 
	~"../nå_maš.h
"

16 
	~"../nå_Ãt.h
"

17 
	~"../nå_pÜt.h
"

19 
	#NFP_FLOWER_SUPPORTED_TCPFLAGS
 \

20 (
TCPHDR_FIN
 | 
TCPHDR_SYN
 | 
TCPHDR_RST
 | \

21 
TCPHDR_PSH
 | 
TCPHDR_URG
)

	)

23 
	#NFP_FLOWER_SUPPORTED_CTLFLAGS
 \

24 (
FLOW_DIS_IS_FRAGMENT
 | \

25 
FLOW_DIS_FIRST_FRAG
)

	)

27 
	#NFP_FLOWER_WHITELIST_DISSECTOR
 \

28 (
	`BIT
(
FLOW_DISSECTOR_KEY_CONTROL
) | \

29 
	`BIT
(
FLOW_DISSECTOR_KEY_BASIC
) | \

30 
	`BIT
(
FLOW_DISSECTOR_KEY_IPV4_ADDRS
) | \

31 
	`BIT
(
FLOW_DISSECTOR_KEY_IPV6_ADDRS
) | \

32 
	`BIT
(
FLOW_DISSECTOR_KEY_TCP
) | \

33 
	`BIT
(
FLOW_DISSECTOR_KEY_PORTS
) | \

34 
	`BIT
(
FLOW_DISSECTOR_KEY_ETH_ADDRS
) | \

35 
	`BIT
(
FLOW_DISSECTOR_KEY_VLAN
) | \

36 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_KEYID
) | \

37 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_IPV4_ADDRS
) | \

38 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_IPV6_ADDRS
) | \

39 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_CONTROL
) | \

40 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_PORTS
) | \

41 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_OPTS
) | \

42 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_IP
) | \

43 
	`BIT
(
FLOW_DISSECTOR_KEY_MPLS
) | \

44 
	`BIT
(
FLOW_DISSECTOR_KEY_IP
))

	)

46 
	#NFP_FLOWER_WHITELIST_TUN_DISSECTOR
 \

47 (
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_CONTROL
) | \

48 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_KEYID
) | \

49 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_IPV4_ADDRS
) | \

50 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_IPV6_ADDRS
) | \

51 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_OPTS
) | \

52 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_PORTS
) | \

53 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_IP
))

	)

55 
	#NFP_FLOWER_WHITELIST_TUN_DISSECTOR_R
 \

56 (
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_CONTROL
) | \

57 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_IPV4_ADDRS
) | \

58 
	`BIT
(
FLOW_DISSECTOR_KEY_ENC_PORTS
))

	)

61 
	$nå_æow”_xm™_æow
(
nå_­p
 *
­p
, 
nå_æ_·ylßd
 *
nå_æow
,

62 
u8
 
mty³
)

64 
u32
 
m‘a_Ën
, 
key_Ën
, 
mask_Ën
, 
aù_Ën
, 
tÙ_Ën
;

65 
sk_buff
 *
skb
;

66 *
msg
;

68 
m‘a_Ën
 = (
nå_æ_ruË_m‘ad©a
);

69 
key_Ën
 = 
nå_æow
->
m‘a
.key_len;

70 
mask_Ën
 = 
nå_æow
->
m‘a
.mask_len;

71 
aù_Ën
 = 
nå_æow
->
m‘a
.act_len;

73 
tÙ_Ën
 = 
m‘a_Ën
 + 
key_Ën
 + 
mask_Ën
 + 
aù_Ën
;

78 
nå_æow
->
m‘a
.
key_Ën
 >>ð
NFP_FL_LW_SIZ
;

79 
nå_æow
->
m‘a
.
mask_Ën
 >>ð
NFP_FL_LW_SIZ
;

80 
nå_æow
->
m‘a
.
aù_Ën
 >>ð
NFP_FL_LW_SIZ
;

82 
skb
 = 
	`nå_æow”_cmsg_®loc
(
­p
, 
tÙ_Ën
, 
mty³
, 
GFP_KERNEL
);

83 ià(!
skb
)

84  -
ENOMEM
;

86 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

87 
	`memýy
(
msg
, &
nå_æow
->
m‘a
, 
m‘a_Ën
);

88 
	`memýy
(&
msg
[
m‘a_Ën
], 
nå_æow
->
unmasked_d©a
, 
key_Ën
);

89 
	`memýy
(&
msg
[
m‘a_Ën
 + 
key_Ën
], 
nå_æow
->
mask_d©a
, 
mask_Ën
);

90 
	`memýy
(&
msg
[
m‘a_Ën
 + 
key_Ën
 + 
mask_Ën
],

91 
nå_æow
->
aùiÚ_d©a
, 
aù_Ën
);

96 
nå_æow
->
m‘a
.
key_Ën
 <<ð
NFP_FL_LW_SIZ
;

97 
nå_æow
->
m‘a
.
mask_Ën
 <<ð
NFP_FL_LW_SIZ
;

98 
nå_æow
->
m‘a
.
aù_Ën
 <<ð
NFP_FL_LW_SIZ
;

100 
	`nå_ù¾_tx
(
­p
->
ù¾
, 
skb
);

103 
	}
}

105 
boÞ
 
	$nå_æow”_check_high”_thª_mac
(
tc_þs_æow”_ofæßd
 *
f
)

107 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

108 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
f
);

110  
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_IPV4_ADDRS
) ||

111 
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_IPV6_ADDRS
) ||

112 
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_PORTS
) ||

113 
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ICMP
);

115  
	`dis£ùÜ_u£s_key
(
f
->
dis£ùÜ
,

116 
FLOW_DISSECTOR_KEY_IPV4_ADDRS
) ||

117 
	`dis£ùÜ_u£s_key
(
f
->
dis£ùÜ
,

118 
FLOW_DISSECTOR_KEY_IPV6_ADDRS
) ||

119 
	`dis£ùÜ_u£s_key
(
f
->
dis£ùÜ
,

120 
FLOW_DISSECTOR_KEY_PORTS
) ||

121 
	`dis£ùÜ_u£s_key
(
f
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_ICMP
);

123 
	}
}

126 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

127 
nå_æow”_ÿlc_Ýt_Ïy”
(
æow_m©ch_’c_Ýts
 *
’c_Ýts
,

129 
nå_æow”_ÿlc_Ýt_Ïy”
(
æow_dis£ùÜ_key_’c_Ýts
 *
’c_Ýts
,

131 
u32
 *
key_Ïy”_two
, *
key_size
)

133 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

134 ià(
’c_Ýts
->
key
->
Ën
 > 
NFP_FL_MAX_GENEVE_OPT_KEY
)

136 ià(
’c_Ýts
->
Ën
 > 
NFP_FL_MAX_GENEVE_OPT_KEY
)

138  -
EOPNOTSUPP
;

140 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

141 ià(
’c_Ýts
->
key
->
Ën
 > 0) {

143 ià(
’c_Ýts
->
Ën
 > 0) {

145 *
key_Ïy”_two
 |ð
NFP_FLOWER_LAYER2_GENEVE_OP
;

146 *
key_size
 +ð(
nå_æow”_g’eve_ÝtiÚs
);

152 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

154 
	$nå_æow”_ÿlcuÏ‹_key_Ïy”s
(
nå_­p
 *
­p
,

155 
Ãt_deviû
 *
Ãtdev
,

156 
nå_æ_key_ls
 *
»t_key_ls
,

157 
tc_þs_æow”_ofæßd
 *
æow
,

158 
boÞ
 
eg»ss
,

159 
nå_æow”_tun_ty³
 *
tun_ty³
)

162 
	$nå_æow”_ÿlcuÏ‹_key_Ïy”s
(
nå_­p
 *
­p
,

163 
Ãt_deviû
 *
Ãtdev
,

164 
nå_æ_key_ls
 *
»t_key_ls
,

165 
tc_þs_æow”_ofæßd
 *
æow
,

166 
nå_æow”_tun_ty³
 *
tun_ty³
)

169 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

170 
æow_ruË
 *
ruË
 = 
	`tc_þs_æow”_ofæßd_æow_ruË
(
æow
);

171 
æow_dis£ùÜ
 *
dis£ùÜ
 = 
ruË
->
m©ch
.dissector;

172 
æow_m©ch_basic
 
basic
 = { 
NULL
, NULL};

174 
æow_dis£ùÜ_key_basic
 *
mask_basic
 = 
NULL
;

175 
æow_dis£ùÜ_key_basic
 *
key_basic
 = 
NULL
;

177 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

178 
u32
 
key_Ïy”_two
;

179 
u8
 
key_Ïy”
;

180 
key_size
;

181 
”r
;

183 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

184 ià(
dis£ùÜ
->
u£d_keys
 & ~
NFP_FLOWER_WHITELIST_DISSECTOR
)

186 ià(
æow
->
dis£ùÜ
->
u£d_keys
 & ~
NFP_FLOWER_WHITELIST_DISSECTOR
)

188  -
EOPNOTSUPP
;

191 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

192 ià(
dis£ùÜ
->
u£d_keys
 & 
NFP_FLOWER_WHITELIST_TUN_DISSECTOR
 &&

193 (
dis£ùÜ
->
u£d_keys
 & 
NFP_FLOWER_WHITELIST_TUN_DISSECTOR_R
)

195 ià(
æow
->
dis£ùÜ
->
u£d_keys
 & 
NFP_FLOWER_WHITELIST_TUN_DISSECTOR
 &&

196 (
æow
->
dis£ùÜ
->
u£d_keys
 & 
NFP_FLOWER_WHITELIST_TUN_DISSECTOR_R
)

198 !ð
NFP_FLOWER_WHITELIST_TUN_DISSECTOR_R
)

199  -
EOPNOTSUPP
;

201 
key_Ïy”_two
 = 0;

202 
key_Ïy”
 = 
NFP_FLOWER_LAYER_PORT
;

203 
key_size
 = (
nå_æow”_m‘a_tci
) +

204 (
nå_æow”_š_pÜt
);

206 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

207 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ETH_ADDRS
) ||

208 
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_MPLS
)) {

210 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_ETH_ADDRS
) ||

211 
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_MPLS
)) {

213 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_MAC
;

214 
key_size
 +ð(
nå_æow”_mac_m¶s
);

217 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

218 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_VLAN
)) {

219 
æow_m©ch_vÏn
 
vÏn
;

221 
	`æow_ruË_m©ch_vÏn
(
ruË
, &
vÏn
);

223 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_VLAN
)) {

224 
æow_dis£ùÜ_key_vÏn
 *
æow_vÏn
;

226 
æow_vÏn
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

227 
FLOW_DISSECTOR_KEY_VLAN
,

228 
æow
->
mask
);

230 ià(!(
´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_VLAN_PCP
) &&

231 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

232 
vÏn
.
key
->
vÏn_´iÜ™y
)

234 
æow_vÏn
->
vÏn_´iÜ™y
)

236  -
EOPNOTSUPP
;

239 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

240 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ENC_CONTROL
)) {

241 
æow_m©ch_’c_Ýts
 
’c_Ý
 = { 
NULL
, NULL };

242 
æow_m©ch_v4_addrs
 
v4_addrs
;

243 
æow_m©ch_cÚŒÞ
 
’c_ùl
;

244 
æow_m©ch_pÜts
 
’c_pÜts
;

246 
	`æow_ruË_m©ch_’c_cÚŒÞ
(
ruË
, &
’c_ùl
);

248 ià(
’c_ùl
.
mask
->
addr_ty³
 != 0xffff ||

249 
’c_ùl
.
key
->
addr_ty³
 !ð
FLOW_DISSECTOR_KEY_IPV4_ADDRS
)

250  -
EOPNOTSUPP
;

253 
	`æow_ruË_m©ch_’c_v4_addrs
(
ruË
, &
v4_addrs
);

254 ià(
v4_addrs
.
mask
->
d¡
 !ð
	`ýu_to_be32
(~0))

255  -
EOPNOTSUPP
;

257 
	`æow_ruË_m©ch_’c_pÜts
(
ruË
, &
’c_pÜts
);

258 ià(
’c_pÜts
.
mask
->
d¡
 !ð
	`ýu_to_be16
(~0))

259  -
EOPNOTSUPP
;

261 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_ENC_OPTS
))

262 
	`æow_ruË_m©ch_’c_Ýts
(
ruË
, &
’c_Ý
);

264 
’c_pÜts
.
key
->
d¡
) {

266 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
,

267 
FLOW_DISSECTOR_KEY_ENC_CONTROL
)) {

268 
æow_dis£ùÜ_key_v4_addrs
 *
mask_v4
 = 
NULL
;

269 
æow_dis£ùÜ_key_pÜts
 *
mask_’c_pÜts
 = 
NULL
;

270 
æow_dis£ùÜ_key_’c_Ýts
 *
’c_Ý
 = 
NULL
;

271 
æow_dis£ùÜ_key_pÜts
 *
’c_pÜts
 = 
NULL
;

272 
æow_dis£ùÜ_key_cÚŒÞ
 *
mask_’c_ùl
 =

273 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

274 
FLOW_DISSECTOR_KEY_ENC_CONTROL
,

275 
æow
->
mask
);

276 
æow_dis£ùÜ_key_cÚŒÞ
 *
’c_ùl
 =

277 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

278 
FLOW_DISSECTOR_KEY_ENC_CONTROL
,

279 
æow
->
key
);

280 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

281 ià(!
eg»ss
)

282  -
EOPNOTSUPP
;

285 ià(
mask_’c_ùl
->
addr_ty³
 != 0xffff ||

286 
’c_ùl
->
addr_ty³
 !ð
FLOW_DISSECTOR_KEY_IPV4_ADDRS
)

287  -
EOPNOTSUPP
;

290 
mask_v4
 =

291 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

292 
FLOW_DISSECTOR_KEY_ENC_IPV4_ADDRS
,

293 
æow
->
mask
);

294 ià(
mask_v4
->
d¡
 !ð
	`ýu_to_be32
(~0))

295  -
EOPNOTSUPP
;

297 
mask_’c_pÜts
 =

298 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

299 
FLOW_DISSECTOR_KEY_ENC_PORTS
,

300 
æow
->
mask
);

301 
’c_pÜts
 =

302 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

303 
FLOW_DISSECTOR_KEY_ENC_PORTS
,

304 
æow
->
key
);

306 ià(
mask_’c_pÜts
->
d¡
 !ð
	`ýu_to_be16
(~0))

307  -
EOPNOTSUPP
;

309 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
,

310 
FLOW_DISSECTOR_KEY_ENC_OPTS
)) {

311 
’c_Ý
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

312 
FLOW_DISSECTOR_KEY_ENC_OPTS
,

313 
æow
->
key
);

316 
’c_pÜts
->
d¡
) {

318 
	`htÚs
(
IANA_VXLAN_UDP_PORT
):

319 *
tun_ty³
 = 
NFP_FL_TUNNEL_VXLAN
;

320 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_VXLAN
;

321 
key_size
 +ð(
nå_æow”_v4_udp_tun
);

323 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

324 ià(
’c_Ý
.
key
)

326 ià(
’c_Ý
)

328  -
EOPNOTSUPP
;

330 
	`htÚs
(
GENEVE_UDP_PORT
):

331 ià(!(
´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_GENEVE
))

332  -
EOPNOTSUPP
;

333 *
tun_ty³
 = 
NFP_FL_TUNNEL_GENEVE
;

334 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_EXT_META
;

335 
key_size
 +ð(
nå_æow”_ext_m‘a
);

336 
key_Ïy”_two
 |ð
NFP_FLOWER_LAYER2_GENEVE
;

337 
key_size
 +ð(
nå_æow”_v4_udp_tun
);

339 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

340 ià(!
’c_Ý
.
key
)

342 ià(!
’c_Ý
)

345 ià(!(
´iv
->
æow”_ext_ã©s
 & 
NFP_FL_FEATS_GENEVE_OPT
))

346  -
EOPNOTSUPP
;

347 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

348 
”r
 = 
	`nå_æow”_ÿlc_Ýt_Ïy”
(&
’c_Ý
, &
key_Ïy”_two
,

350 
”r
 = 
	`nå_æow”_ÿlc_Ýt_Ïy”
(
’c_Ý
, &
key_Ïy”_two
,

352 &
key_size
);

353 ià(
”r
)

354  
”r
;

357  -
EOPNOTSUPP
;

359 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 0, 0)

362 ià(!
	`nå_æ_Ãtdev_is_tuÂ–_ty³
(
Ãtdev
, *
tun_ty³
))

363  -
EOPNOTSUPP
;

365 } ià(
eg»ss
) {

367  -
EOPNOTSUPP
;

371 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

372 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_BASIC
))

373 
	`æow_ruË_m©ch_basic
(
ruË
, &
basic
);

375 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_BASIC
)) {

376 
mask_basic
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

377 
FLOW_DISSECTOR_KEY_BASIC
,

378 
æow
->
mask
);

380 
key_basic
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

381 
FLOW_DISSECTOR_KEY_BASIC
,

382 
æow
->
key
);

386 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

387 ià(
basic
.
mask
 && basic.mask->
n_´Ùo
) {

389 ià(
mask_basic
 && mask_basic->
n_´Ùo
) {

392 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

393 
basic
.
key
->
n_´Ùo
) {

395 
key_basic
->
n_´Ùo
) {

397 
	`ýu_to_be16
(
ETH_P_IP
):

398 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_IPV4
;

399 
key_size
 +ð(
nå_æow”_v4
);

402 
	`ýu_to_be16
(
ETH_P_IPV6
):

403 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_IPV6
;

404 
key_size
 +ð(
nå_æow”_v6
);

410 
	`ýu_to_be16
(
ETH_P_ARP
):

411  -
EOPNOTSUPP
;

413 
	`ýu_to_be16
(
ETH_P_MPLS_UC
):

414 
	`ýu_to_be16
(
ETH_P_MPLS_MC
):

415 ià(!(
key_Ïy”
 & 
NFP_FLOWER_LAYER_MAC
)) {

416 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_MAC
;

417 
key_size
 +ð(
nå_æow”_mac_m¶s
);

422 
	`ýu_to_be16
(
ETH_P_8021Q
):

429 ià(
	`nå_æow”_check_high”_thª_mac
(
æow
))

430  -
EOPNOTSUPP
;

435 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

436 ià(
basic
.
mask
 && basic.mask->
_´Ùo
) {

438 ià(
mask_basic
 && mask_basic->
_´Ùo
) {

441 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

442 
basic
.
key
->
_´Ùo
) {

444 
key_basic
->
_´Ùo
) {

446 
IPPROTO_TCP
:

447 
IPPROTO_UDP
:

448 
IPPROTO_SCTP
:

449 
IPPROTO_ICMP
:

450 
IPPROTO_ICMPV6
:

451 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_TP
;

452 
key_size
 +ð(
nå_æow”__pÜts
);

458  -
EOPNOTSUPP
;

462 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

463 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_TCP
)) {

464 
æow_m©ch_tý
 
tý
;

466 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_TCP
)) {

467 
æow_dis£ùÜ_key_tý
 *
tý
;

469 
u32
 
tý_æags
;

471 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

472 
	`æow_ruË_m©ch_tý
(
ruË
, &
tý
);

473 
tý_æags
 = 
	`be16_to_ýu
(
tý
.
key
->
æags
);

475 
tý
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

476 
FLOW_DISSECTOR_KEY_TCP
,

477 
æow
->
key
);

478 
tý_æags
 = 
	`be16_to_ýu
(
tý
->
æags
);

481 ià(
tý_æags
 & ~
NFP_FLOWER_SUPPORTED_TCPFLAGS
)

482  -
EOPNOTSUPP
;

487 ià((
tý_æags
 & (
TCPHDR_PSH
 | 
TCPHDR_URG
)) &&

488 !(
tý_æags
 & (
TCPHDR_FIN
 | 
TCPHDR_SYN
 | 
TCPHDR_RST
)))

489  -
EOPNOTSUPP
;

495 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

496 ià(!
basic
.
key
)

498 ià(!
key_basic
)

500  -
EOPNOTSUPP
;

502 ià(!(
key_Ïy”
 & 
NFP_FLOWER_LAYER_IPV4
) &&

503 !(
key_Ïy”
 & 
NFP_FLOWER_LAYER_IPV6
)) {

504 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

505 
basic
.
key
->
n_´Ùo
) {

507 
key_basic
->
n_´Ùo
) {

509 
	`ýu_to_be16
(
ETH_P_IP
):

510 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_IPV4
;

511 
key_size
 +ð(
nå_æow”_v4
);

514 
	`ýu_to_be16
(
ETH_P_IPV6
):

515 
key_Ïy”
 |ð
NFP_FLOWER_LAYER_IPV6
;

516 
key_size
 +ð(
nå_æow”_v6
);

520  -
EOPNOTSUPP
;

525 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

526 ià(
	`æow_ruË_m©ch_key
(
ruË
, 
FLOW_DISSECTOR_KEY_CONTROL
)) {

527 
æow_m©ch_cÚŒÞ
 
ùl
;

529 
	`æow_ruË_m©ch_cÚŒÞ
(
ruË
, &
ùl
);

530 ià(
ùl
.
key
->
æags
 & ~
NFP_FLOWER_SUPPORTED_CTLFLAGS
)

531  -
EOPNOTSUPP
;

534 ià(
	`dis£ùÜ_u£s_key
(
æow
->
dis£ùÜ
, 
FLOW_DISSECTOR_KEY_CONTROL
)) {

535 
æow_dis£ùÜ_key_cÚŒÞ
 *
key_ùl
;

537 
key_ùl
 = 
	`skb_æow_dis£ùÜ_rg‘
(
æow
->
dis£ùÜ
,

538 
FLOW_DISSECTOR_KEY_CONTROL
,

539 
æow
->
key
);

541 ià(
key_ùl
->
æags
 & ~
NFP_FLOWER_SUPPORTED_CTLFLAGS
)

542  -
EOPNOTSUPP
;

546 
»t_key_ls
->
key_Ïy”
 = key_layer;

547 
»t_key_ls
->
key_Ïy”_two
 = key_layer_two;

548 
»t_key_ls
->
key_size
 = key_size;

551 
	}
}

553 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

554 
nå_æ_·ylßd
 *

555 
	$nå_æow”_®loÿ‹_Ãw
(
nå_æ_key_ls
 *
key_Ïy”
, 
boÞ
 
eg»ss
)

557 
nå_æ_·ylßd
 *

558 
	$nå_æow”_®loÿ‹_Ãw
(
nå_æ_key_ls
 *
key_Ïy”
)

561 
nå_æ_·ylßd
 *
æow_·y
;

563 
æow_·y
 = 
	`km®loc
((*æow_·y), 
GFP_KERNEL
);

564 ià(!
æow_·y
)

565  
NULL
;

567 
æow_·y
->
m‘a
.
key_Ën
 = 
key_Ïy”
->
key_size
;

568 
æow_·y
->
unmasked_d©a
 = 
	`km®loc
(
key_Ïy”
->
key_size
, 
GFP_KERNEL
);

569 ià(!
æow_·y
->
unmasked_d©a
)

570 
”r_ä“_æow
;

572 
æow_·y
->
m‘a
.
mask_Ën
 = 
key_Ïy”
->
key_size
;

573 
æow_·y
->
mask_d©a
 = 
	`km®loc
(
key_Ïy”
->
key_size
, 
GFP_KERNEL
);

574 ià(!
æow_·y
->
mask_d©a
)

575 
”r_ä“_unmasked
;

577 
æow_·y
->
aùiÚ_d©a
 = 
	`km®loc
(
NFP_FL_MAX_A_SIZ
, 
GFP_KERNEL
);

578 ià(!
æow_·y
->
aùiÚ_d©a
)

579 
”r_ä“_mask
;

581 
æow_·y
->
nå_tun_v4_addr
 = 0;

582 
æow_·y
->
m‘a
.
æags
 = 0;

583 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

584 
æow_·y
->
šg»ss_ofæßd
 = !
eg»ss
;

587  
æow_·y
;

589 
”r_ä“_mask
:

590 
	`kä“
(
æow_·y
->
mask_d©a
);

591 
”r_ä“_unmasked
:

592 
	`kä“
(
æow_·y
->
unmasked_d©a
);

593 
”r_ä“_æow
:

594 
	`kä“
(
æow_·y
);

595  
NULL
;

596 
	}
}

609 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

611 
	$nå_æow”_add_ofæßd
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

612 
tc_þs_æow”_ofæßd
 *
æow
, 
boÞ
 
eg»ss
)

615 
	$nå_æow”_add_ofæßd
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

616 
tc_þs_æow”_ofæßd
 *
æow
)

619 
nå_æow”_tun_ty³
 
tun_ty³
 = 
NFP_FL_TUNNEL_NONE
;

620 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

621 
nå_æ_·ylßd
 *
æow_·y
;

622 
nå_æ_key_ls
 *
key_Ïy”
;

623 
nå_pÜt
 *
pÜt
 = 
NULL
;

624 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

625 
Ãt_deviû
 *
šgr_dev
;

627 
”r
;

629 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
))

630 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

632 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

633 
šgr_dev
 = 
eg»ss
 ? 
NULL
 : 
Ãtdev
;

634 
æow_·y
 = 
	`nå_æow”_£¬ch_æ_bË
(
­p
, 
æow
->
cook›
, 
šgr_dev
);

635 ià(
æow_·y
) {

637 ià(
æow_·y
->
šg»ss_ofæßd
 && 
eg»ss
)

640  -
EOPNOTSUPP
;

644 
key_Ïy”
 = 
	`km®loc
((*key_Ïy”), 
GFP_KERNEL
);

645 ià(!
key_Ïy”
)

646  -
ENOMEM
;

648 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

649 
”r
 = 
	`nå_æow”_ÿlcuÏ‹_key_Ïy”s
(
­p
, 
Ãtdev
, 
key_Ïy”
, 
æow
,

650 
eg»ss
, &
tun_ty³
);

652 
”r
 = 
	`nå_æow”_ÿlcuÏ‹_key_Ïy”s
(
­p
, 
Ãtdev
, 
key_Ïy”
, 
æow
,

653 &
tun_ty³
);

655 ià(
”r
)

656 
”r_ä“_key_ls
;

658 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

659 
æow_·y
 = 
	`nå_æow”_®loÿ‹_Ãw
(
key_Ïy”
, 
eg»ss
);

661 
æow_·y
 = 
	`nå_æow”_®loÿ‹_Ãw
(
key_Ïy”
);

663 ià(!
æow_·y
) {

664 
”r
 = -
ENOMEM
;

665 
”r_ä“_key_ls
;

668 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

669 
æow_·y
->
šg»ss_dev
 = 
eg»ss
 ? 
NULL
 : 
Ãtdev
;

672 
”r
 = 
	`nå_æow”_compže_æow_m©ch
(
­p
, 
æow
, 
key_Ïy”
, 
Ãtdev
,

673 
æow_·y
, 
tun_ty³
);

674 ià(
”r
)

675 
”r_de¡roy_æow
;

677 
”r
 = 
	`nå_æow”_compže_aùiÚ
(
­p
, 
æow
, 
Ãtdev
, 
æow_·y
);

678 ià(
”r
)

679 
”r_de¡roy_æow
;

681 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

682 
”r
 = 
	`nå_compže_æow_m‘ad©a
(
­p
, 
æow
, 
æow_·y
,

683 
æow_·y
->
šg»ss_dev
);

685 
”r
 = 
	`nå_compže_æow_m‘ad©a
(
­p
, 
æow
, 
æow_·y
, 
Ãtdev
);

687 ià(
”r
)

688 
”r_de¡roy_æow
;

690 
æow_·y
->
tc_æow”_cook›
 = 
æow
->
cook›
;

691 
”r
 = 
	`rhashbË_š£¹_ç¡
(&
´iv
->
æow_bË
, &
æow_·y
->
æ_node
,

692 
nå_æow”_bË_·¿ms
);

693 ià(
”r
)

694 
”r_»Ëa£_m‘ad©a
;

696 
”r
 = 
	`nå_æow”_xm™_æow
(
­p
, 
æow_·y
,

697 
NFP_FLOWER_CMSG_TYPE_FLOW_ADD
);

698 ià(
”r
)

699 
”r_»move_rhash
;

701 ià(
pÜt
)

702 
pÜt
->
tc_ofæßd_út
++;

705 
	`kä“
(
key_Ïy”
);

709 
”r_»move_rhash
:

710 
	`WARN_ON_ONCE
(
	`rhashbË_»move_ç¡
(&
´iv
->
æow_bË
,

711 &
æow_·y
->
æ_node
,

712 
nå_æow”_bË_·¿ms
));

713 
”r_»Ëa£_m‘ad©a
:

714 
	`nå_modify_æow_m‘ad©a
(
­p
, 
æow_·y
);

715 
”r_de¡roy_æow
:

716 
	`kä“
(
æow_·y
->
aùiÚ_d©a
);

717 
	`kä“
(
æow_·y
->
mask_d©a
);

718 
	`kä“
(
æow_·y
->
unmasked_d©a
);

719 
	`kä“
(
æow_·y
);

720 
”r_ä“_key_ls
:

721 
	`kä“
(
key_Ïy”
);

722  
”r
;

723 
	}
}

737 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

739 
	$nå_æow”_d–_ofæßd
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

740 
tc_þs_æow”_ofæßd
 *
æow
, 
boÞ
 
eg»ss
)

743 
	$nå_æow”_d–_ofæßd
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

744 
tc_þs_æow”_ofæßd
 *
æow
)

747 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

748 
nå_æ_·ylßd
 *
nå_æow
;

749 
nå_pÜt
 *
pÜt
 = 
NULL
;

750 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

751 
Ãt_deviû
 *
šgr_dev
;

753 
”r
;

755 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
))

756 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

758 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

759 
šgr_dev
 = 
eg»ss
 ? 
NULL
 : 
Ãtdev
;

760 
nå_æow
 = 
	`nå_æow”_£¬ch_æ_bË
(
­p
, 
æow
->
cook›
, 
šgr_dev
);

762 
nå_æow
 = 
	`nå_æow”_£¬ch_æ_bË
(
­p
, 
æow
->
cook›
, 
Ãtdev
);

764 ià(!
nå_æow
)

765 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

766  
eg»ss
 ? 0 : -
ENOENT
;

768  -
ENOENT
;

771 
”r
 = 
	`nå_modify_æow_m‘ad©a
(
­p
, 
nå_æow
);

772 ià(
”r
)

773 
”r_ä“_æow
;

775 ià(
nå_æow
->
nå_tun_v4_addr
)

776 
	`nå_tuÂ–_d–_v4_off
(
­p
, 
nå_æow
->
nå_tun_v4_addr
);

778 
”r
 = 
	`nå_æow”_xm™_æow
(
­p
, 
nå_æow
,

779 
NFP_FLOWER_CMSG_TYPE_FLOW_DEL
);

780 ià(
”r
)

781 
”r_ä“_æow
;

783 
”r_ä“_æow
:

784 ià(
pÜt
)

785 
pÜt
->
tc_ofæßd_út
--;

786 
	`kä“
(
nå_æow
->
aùiÚ_d©a
);

787 
	`kä“
(
nå_æow
->
mask_d©a
);

788 
	`kä“
(
nå_æow
->
unmasked_d©a
);

789 
	`WARN_ON_ONCE
(
	`rhashbË_»move_ç¡
(&
´iv
->
æow_bË
,

790 &
nå_æow
->
æ_node
,

791 
nå_æow”_bË_·¿ms
));

792 
	`kä“_rcu
(
nå_æow
, 
rcu
);

793  
”r
;

794 
	}
}

808 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

810 
	$nå_æow”_g‘_¡©s
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

811 
tc_þs_æow”_ofæßd
 *
æow
, 
boÞ
 
eg»ss
)

814 
	$nå_æow”_g‘_¡©s
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

815 
tc_þs_æow”_ofæßd
 *
æow
)

818 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

819 
nå_æ_·ylßd
 *
nå_æow
;

820 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

821 
Ãt_deviû
 *
šgr_dev
;

823 
u32
 
ùx_id
;

825 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

826 
šgr_dev
 = 
eg»ss
 ? 
NULL
 : 
Ãtdev
;

827 
nå_æow
 = 
	`nå_æow”_£¬ch_æ_bË
(
­p
, 
æow
->
cook›
, 
šgr_dev
);

829 
nå_æow
 = 
	`nå_æow”_£¬ch_æ_bË
(
­p
, 
æow
->
cook›
, 
Ãtdev
);

831 ià(!
nå_æow
)

832  -
EINVAL
;

834 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

835 ià(
nå_æow
->
šg»ss_ofæßd
 && 
eg»ss
)

839 
ùx_id
 = 
	`be32_to_ýu
(
nå_æow
->
m‘a
.
ho¡_ùx_id
);

841 
	`¥š_lock_bh
(&
´iv
->
¡©s_lock
);

842 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

843 
	`tcf_exts_¡©s_upd©e
(
æow
->
exts
, 
´iv
->
¡©s
[
ùx_id
].
by‹s
,

844 
´iv
->
¡©s
[
ùx_id
].
pkts
,

845 
´iv
->
¡©s
[
ùx_id
].
u£d
);

847 
	`æow_¡©s_upd©e
(&
æow
->
¡©s
, 
´iv
->¡©s[
ùx_id
].
by‹s
,

848 
´iv
->
¡©s
[
ùx_id
].
pkts
,…riv->¡©s[ùx_id].
u£d
);

851 
´iv
->
¡©s
[
ùx_id
].
pkts
 = 0;

852 
´iv
->
¡©s
[
ùx_id
].
by‹s
 = 0;

853 
	`¥š_uÆock_bh
(&
´iv
->
¡©s_lock
);

856 
	}
}

858 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

860 
	$nå_æow”_»´_ofæßd
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

861 
tc_þs_æow”_ofæßd
 *
æow”
, 
boÞ
 
eg»ss
)

864 
	$nå_æow”_»´_ofæßd
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

865 
tc_þs_æow”_ofæßd
 *
æow”
)

868 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 15, 0)

869 ià(!
	`‘h_´Ùo_is_802_3
(
æow”
->
commÚ
.
´ÙocÞ
))

870  -
EOPNOTSUPP
;

873 
æow”
->
commªd
) {

874 
TC_CLSFLOWER_REPLACE
:

875 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

876  
	`nå_æow”_add_ofæßd
(
­p
, 
Ãtdev
, 
æow”
, 
eg»ss
);

878  
	`nå_æow”_add_ofæßd
(
­p
, 
Ãtdev
, 
æow”
);

880 
TC_CLSFLOWER_DESTROY
:

881 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

882  
	`nå_æow”_d–_ofæßd
(
­p
, 
Ãtdev
, 
æow”
, 
eg»ss
);

884  
	`nå_æow”_d–_ofæßd
(
­p
, 
Ãtdev
, 
æow”
);

886 
TC_CLSFLOWER_STATS
:

887 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

888  
	`nå_æow”_g‘_¡©s
(
­p
, 
Ãtdev
, 
æow”
, 
eg»ss
);

890  
	`nå_æow”_g‘_¡©s
(
­p
, 
Ãtdev
, 
æow”
);

893  -
EOPNOTSUPP
;

895 
	}
}

897 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 15, 0)

898 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

899 
	$nå_æow”_£tup_tc_eg»ss_cb
(
tc_£tup_ty³
 
ty³
, *
ty³_d©a
,

900 *
cb_´iv
)

902 
nå_»´
 *
»´
 = 
cb_´iv
;

904 ià(!
	`tc_þs_ÿn_ofæßd_ªd_chaš0
(
»´
->
Ãtdev
, 
ty³_d©a
))

905  -
EOPNOTSUPP
;

907 
ty³
) {

908 
TC_SETUP_CLSFLOWER
:

909  
	`nå_æow”_»´_ofæßd
(
»´
->
­p
,„•r->
Ãtdev
,

910 
ty³_d©a
, 
Œue
);

912  -
EOPNOTSUPP
;

914 
	}
}

917 
	$nå_æow”_£tup_tc_block_cb
(
tc_£tup_ty³
 
ty³
,

918 *
ty³_d©a
, *
cb_´iv
)

920 
nå_»´
 *
»´
 = 
cb_´iv
;

922 ià(!
	`tc_þs_ÿn_ofæßd_ªd_chaš0
(
»´
->
Ãtdev
, 
ty³_d©a
))

923  -
EOPNOTSUPP
;

925 
ty³
) {

926 
TC_SETUP_CLSFLOWER
:

927 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 0, 0)

928  
	`nå_æow”_»´_ofæßd
(
»´
->
­p
,„•r->
Ãtdev
,

929 
ty³_d©a
, 
çl£
);

931  
	`nå_æow”_»´_ofæßd
(
»´
->
­p
,„•r->
Ãtdev
,

932 
ty³_d©a
);

935  -
EOPNOTSUPP
;

937 
	}
}

939 
	$nå_æow”_£tup_tc_block
(
Ãt_deviû
 *
Ãtdev
,

940 
tc_block_ofæßd
 *
f
)

942 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

944 ià(
f
->
bšd”_ty³
 !ð
TCF_BLOCK_BINDER_TYPE_CLSACT_INGRESS
)

945  -
EOPNOTSUPP
;

947 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 19, 0)

948 ià(
	`tcf_block_sh¬ed
(
f
->
block
))

949  -
EOPNOTSUPP
;

952 
f
->
commªd
) {

953 
TC_BLOCK_BIND
:

954  
	`tcf_block_cb_»gi¡”
(
f
->
block
,

955 
nå_æow”_£tup_tc_block_cb
,

956 
»´
,„•r, 
f
->
exck
);

957 
TC_BLOCK_UNBIND
:

958 
	`tcf_block_cb_uÄegi¡”
(
f
->
block
,

959 
nå_æow”_£tup_tc_block_cb
,

960 
»´
);

963  -
EOPNOTSUPP
;

965 
	}
}

967 
	$nå_æow”_£tup_tc
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

968 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
)

970 
ty³
) {

971 
TC_SETUP_BLOCK
:

972  
	`nå_æow”_£tup_tc_block
(
Ãtdev
, 
ty³_d©a
);

974  -
EOPNOTSUPP
;

976 
	}
}

977 #–ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 14, 0)

978 
	$nå_æow”_£tup_tc
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

979 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
)

981 
tc_þs_æow”_ofæßd
 *
þs_æow”
 = 
ty³_d©a
;

983 ià(
ty³
 !ð
TC_SETUP_CLSFLOWER
 ||

984 !
	`is_þassid_þ§ù_šg»ss
(
þs_æow”
->
commÚ
.
þassid
) ||

985 !
	`‘h_´Ùo_is_802_3
(
þs_æow”
->
commÚ
.
´ÙocÞ
) ||

986 
þs_æow”
->
commÚ
.
chaš_šdex
)

987  -
EOPNOTSUPP
;

989  
	`nå_æow”_»´_ofæßd
(
­p
, 
Ãtdev
, 
þs_æow”
,

990 
þs_æow”
->
eg»ss_dev
);

991 
	}
}

993 
	$nå_æow”_£tup_tc
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

994 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
)

996 
tc_þs_æow”_ofæßd
 *
þs_æow”
 = 
ty³_d©a
;

998 ià(
ty³
 !ð
TC_SETUP_CLSFLOWER
)

999  -
EOPNOTSUPP
;

1001  
	`nå_æow”_»´_ofæßd
(
­p
, 
Ãtdev
, 
þs_æow”
, 
çl£
);

1002 
	}
}

1005 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 0, 0)

1006 
	snå_æow”_šdr_block_cb_´iv
 {

1007 
Ãt_deviû
 *
Ãtdev
;

1008 
nå_­p
 *
­p
;

1009 
li¡_h—d
 
li¡
;

1012 
nå_æow”_šdr_block_cb_´iv
 *

1013 
	$nå_æow”_šdr_block_cb_´iv_lookup
(
nå_­p
 *
­p
,

1014 
Ãt_deviû
 *
Ãtdev
)

1016 
nå_æow”_šdr_block_cb_´iv
 *
cb_´iv
;

1017 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

1020 
	`ASSERT_RTNL
();

1022 
	`li¡_fÜ_—ch_’Œy
(
cb_´iv
, &
´iv
->
šdr_block_cb_´iv
, 
li¡
)

1023 ià(
cb_´iv
->
Ãtdev
 ==‚etdev)

1024  
cb_´iv
;

1026  
NULL
;

1027 
	}
}

1029 
	$nå_æow”_£tup_šdr_block_cb
(
tc_£tup_ty³
 
ty³
,

1030 *
ty³_d©a
, *
cb_´iv
)

1032 
nå_æow”_šdr_block_cb_´iv
 *
´iv
 = 
cb_´iv
;

1033 
tc_þs_æow”_ofæßd
 *
æow”
 = 
ty³_d©a
;

1035 ià(
æow”
->
commÚ
.
chaš_šdex
)

1036  -
EOPNOTSUPP
;

1038 
ty³
) {

1039 
TC_SETUP_CLSFLOWER
:

1040  
	`nå_æow”_»´_ofæßd
(
´iv
->
­p
,…riv->
Ãtdev
,

1041 
ty³_d©a
);

1043  -
EOPNOTSUPP
;

1045 
	}
}

1048 
	$nå_æow”_£tup_šdr_tc_block
(
Ãt_deviû
 *
Ãtdev
, 
nå_­p
 *
­p
,

1049 
tc_block_ofæßd
 *
f
)

1051 
nå_æow”_šdr_block_cb_´iv
 *
cb_´iv
;

1052 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

1053 
”r
;

1055 ià(
f
->
bšd”_ty³
 !ð
TCF_BLOCK_BINDER_TYPE_CLSACT_INGRESS
)

1056  -
EOPNOTSUPP
;

1058 
f
->
commªd
) {

1059 
TC_BLOCK_BIND
:

1060 
cb_´iv
 = 
	`km®loc
((*cb_´iv), 
GFP_KERNEL
);

1061 ià(!
cb_´iv
)

1062  -
ENOMEM
;

1064 
cb_´iv
->
Ãtdev
 =‚etdev;

1065 
cb_´iv
->
­p
 =‡pp;

1066 
	`li¡_add
(&
cb_´iv
->
li¡
, &
´iv
->
šdr_block_cb_´iv
);

1068 
”r
 = 
	`tcf_block_cb_»gi¡”
(
f
->
block
,

1069 
nå_æow”_£tup_šdr_block_cb
,

1070 
cb_´iv
, cb_´iv, 
f
->
exck
);

1071 ià(
”r
) {

1072 
	`li¡_d–
(&
cb_´iv
->
li¡
);

1073 
	`kä“
(
cb_´iv
);

1076  
”r
;

1077 
TC_BLOCK_UNBIND
:

1078 
cb_´iv
 = 
	`nå_æow”_šdr_block_cb_´iv_lookup
(
­p
, 
Ãtdev
);

1079 ià(!
cb_´iv
)

1080  -
ENOENT
;

1082 
	`tcf_block_cb_uÄegi¡”
(
f
->
block
,

1083 
nå_æow”_£tup_šdr_block_cb
,

1084 
cb_´iv
);

1085 
	`li¡_d–
(&
cb_´iv
->
li¡
);

1086 
	`kä“
(
cb_´iv
);

1090  -
EOPNOTSUPP
;

1093 
	}
}

1096 
	$nå_æow”_šdr_£tup_tc_cb
(
Ãt_deviû
 *
Ãtdev
, *
cb_´iv
,

1097 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
)

1099 
ty³
) {

1100 
TC_SETUP_BLOCK
:

1101  
	`nå_æow”_£tup_šdr_tc_block
(
Ãtdev
, 
cb_´iv
,

1102 
ty³_d©a
);

1104  -
EOPNOTSUPP
;

1106 
	}
}

1108 
	$nå_æow”_»g_šdœ_block_hªdËr
(
nå_­p
 *
­p
,

1109 
Ãt_deviû
 *
Ãtdev
,

1110 
ev’t
)

1112 
”r
;

1114 ià(!
	`nå_æ_is_Ãtdev_to_ofæßd
(
Ãtdev
))

1115  
NOTIFY_OK
;

1117 ià(
ev’t
 =ð
NETDEV_REGISTER
) {

1118 
”r
 = 
	`__tc_šdr_block_cb_»gi¡”
(
Ãtdev
, 
­p
,

1119 
nå_æow”_šdr_£tup_tc_cb
,

1120 
­p
);

1121 ià(
”r
)

1122 
	`nå_æow”_cmsg_w¬n
(
­p
,

1124 
Ãtdev
->
Çme
);

1125 } ià(
ev’t
 =ð
NETDEV_UNREGISTER
) {

1126 
	`__tc_šdr_block_cb_uÄegi¡”
(
Ãtdev
,

1127 
nå_æow”_šdr_£tup_tc_cb
, 
­p
);

1130  
NOTIFY_OK
;

1131 
	}
}

	@src/flower/tunnel_conf.c

4 
	~<lšux/‘h”deviû.h
>

5 
	~<lšux/š‘deviû.h
>

6 
	~<Ãt/Ã‹v’t.h
>

7 
	~<lšux/idr.h
>

8 
	~<Ãt/d¡_m‘ad©a.h
>

9 
	~<Ãt/¬p.h
>

11 
	~"cmsg.h
"

12 
	~"maš.h
"

13 
	~"../nå_Ãt_»´.h
"

14 
	~"../nå_Ãt.h
"

16 
	#NFP_FL_MAX_ROUTES
 32

	)

28 
	snå_tun_aùive_tuns
 {

29 
__be32
 
	m£q
;

30 
__be32
 
	mcouÁ
;

31 
__be32
 
	mæags
;

32 
	srou‹__šfo
 {

33 
__be32
 
	mv4
;

34 
__be32
 
	meg»ss_pÜt
;

35 
__be32
 
	mexŒa
[2];

36 } 
	mtun_šfo
[];

47 
	snå_tun_Ãigh
 {

48 
__be32
 
	md¡_v4
;

49 
__be32
 
	m¤c_v4
;

50 
u8
 
	md¡_addr
[
ETH_ALEN
];

51 
u8
 
	m¤c_addr
[
ETH_ALEN
];

52 
__be32
 
	mpÜt_id
;

61 
	snå_tun_»q_rou‹_v4
 {

62 
__be32
 
	mšg»ss_pÜt
;

63 
__be32
 
	mv4_addr
;

64 
__be32
 
	m»£rved
[2];

72 
	snå_v4_rou‹_’Œy
 {

73 
__be32
 
	mv4_addr
;

74 
li¡_h—d
 
	mli¡
;

77 
	#NFP_FL_IPV4_ADDRS_MAX
 32

	)

84 
	snå_tun_v4_addr
 {

85 
__be32
 
	mcouÁ
;

86 
__be32
 
	mv4_addr
[
NFP_FL_IPV4_ADDRS_MAX
];

95 
	snå_v4_addr_’Œy
 {

96 
__be32
 
	mv4_addr
;

97 
	m»f_couÁ
;

98 
li¡_h—d
 
	mli¡
;

101 
	#NFP_TUN_MAC_OFFLOAD_DEL_FLAG
 0x2

	)

110 
	snå_tun_mac_addr_ofæßd
 {

111 
__be16
 
	mæags
;

112 
__be16
 
	mcouÁ
;

113 
__be16
 
	mšdex
;

114 
u8
 
	maddr
[
ETH_ALEN
];

117 
	enå_æow”_mac_ofæßd_cmd
 {

118 
	mNFP_TUNNEL_MAC_OFFLOAD_ADD
 = 0,

119 
	mNFP_TUNNEL_MAC_OFFLOAD_DEL
 = 1,

120 
	mNFP_TUNNEL_MAC_OFFLOAD_MOD
 = 2,

123 
	#NFP_MAX_MAC_INDEX
 0xff

	)

133 
	snå_tun_ofæßded_mac
 {

134 
rhash_h—d
 
	mht_node
;

135 
u8
 
	maddr
[
ETH_ALEN
];

136 
u16
 
	mšdex
;

137 
	m»f_couÁ
;

138 
li¡_h—d
 
	m»´_li¡
;

141 cÚ¡ 
rhashbË_·¿ms
 
	gofæßded_macs_·¿ms
 = {

142 .
key_off£t
 = 
off£tof
(
nå_tun_ofæßded_mac
, 
addr
),

143 .
	gh—d_off£t
 = 
off£tof
(
nå_tun_ofæßded_mac
, 
ht_node
),

144 .
	gkey_Ën
 = 
ETH_ALEN
,

145 .
	gautom©ic_shrškšg
 = 
Œue
,

148 
	$nå_tuÂ–_k“p_®ive
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

150 
nå_tun_aùive_tuns
 *
·ylßd
;

151 
Ãt_deviû
 *
Ãtdev
;

152 
couÁ
, 
i
, 
·y_Ën
;

153 
Ãighbour
 *
n
;

154 
__be32
 
v4_addr
;

155 
u32
 
pÜt
;

157 
·ylßd
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

158 
couÁ
 = 
	`be32_to_ýu
(
·ylßd
->count);

159 ià(
couÁ
 > 
NFP_FL_MAX_ROUTES
) {

160 
	`nå_æow”_cmsg_w¬n
(
­p
, "Tunnel keep-alive„equestƒxceeds max„outes.\n");

164 
·y_Ën
 = 
	`nå_æow”_cmsg_g‘_d©a_Ën
(
skb
);

165 ià(
·y_Ën
 !ð(
nå_tun_aùive_tuns
) +

166 (
rou‹__šfo
è* 
couÁ
) {

167 
	`nå_æow”_cmsg_w¬n
(
­p
, "Corruption inunnel keep-alive message.\n");

171 
i
 = 0; i < 
couÁ
; i++) {

172 
v4_addr
 = 
·ylßd
->
tun_šfo
[
i
].
v4
;

173 
pÜt
 = 
	`be32_to_ýu
(
·ylßd
->
tun_šfo
[
i
].
eg»ss_pÜt
);

174 
Ãtdev
 = 
	`nå_­p_»´_g‘
(
­p
, 
pÜt
);

175 ià(!
Ãtdev
)

178 
n
 = 
	`Ãigh_lookup
(&
¬p_tbl
, &
v4_addr
, 
Ãtdev
);

179 ià(!
n
)

183 
	`Ãigh_ev’t_£nd
(
n
, 
NULL
);

184 
	`Ãigh_»Ëa£
(
n
);

186 
	}
}

189 
	$nå_æow”_xm™_tun_cÚf
(
nå_­p
 *
­p
, 
u8
 
mty³
, 
u16
 
¶’
, *
pd©a
,

190 
gå_t
 
æag
)

192 
sk_buff
 *
skb
;

193 *
msg
;

195 
skb
 = 
	`nå_æow”_cmsg_®loc
(
­p
, 
¶’
, 
mty³
, 
æag
);

196 ià(!
skb
)

197  -
ENOMEM
;

199 
msg
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

200 
	`memýy
(
msg
, 
pd©a
, 
	`nå_æow”_cmsg_g‘_d©a_Ën
(
skb
));

202 
	`nå_ù¾_tx
(
­p
->
ù¾
, 
skb
);

204 
	}
}

206 
boÞ
 
	$nå_tun_has_rou‹
(
nå_­p
 *
­p
, 
__be32
 
v4_addr
)

208 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

209 
nå_v4_rou‹_’Œy
 *
’Œy
;

210 
li¡_h—d
 *
±r
, *
¡Üage
;

212 
	`¥š_lock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

213 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
Ãigh_off_li¡
) {

214 
’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_rou‹_’Œy
, 
li¡
);

215 ià(
’Œy
->
v4_addr
 == ipv4_addr) {

216 
	`¥š_uÆock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

217  
Œue
;

220 
	`¥š_uÆock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

221  
çl£
;

222 
	}
}

224 
	$nå_tun_add_rou‹_to_ÿche
(
nå_­p
 *
­p
, 
__be32
 
v4_addr
)

226 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

227 
nå_v4_rou‹_’Œy
 *
’Œy
;

228 
li¡_h—d
 *
±r
, *
¡Üage
;

230 
	`¥š_lock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

231 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
Ãigh_off_li¡
) {

232 
’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_rou‹_’Œy
, 
li¡
);

233 ià(
’Œy
->
v4_addr
 == ipv4_addr) {

234 
	`¥š_uÆock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

238 
’Œy
 = 
	`km®loc
((*’Œy), 
GFP_ATOMIC
);

239 ià(!
’Œy
) {

240 
	`¥š_uÆock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

241 
	`nå_æow”_cmsg_w¬n
(
­p
, "Memƒrror when storing‚ew„oute.\n");

245 
’Œy
->
v4_addr
 = ipv4_addr;

246 
	`li¡_add_ž
(&
’Œy
->
li¡
, &
´iv
->
tun
.
Ãigh_off_li¡
);

247 
	`¥š_uÆock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

248 
	}
}

250 
	$nå_tun_d–_rou‹_äom_ÿche
(
nå_­p
 *
­p
, 
__be32
 
v4_addr
)

252 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

253 
nå_v4_rou‹_’Œy
 *
’Œy
;

254 
li¡_h—d
 *
±r
, *
¡Üage
;

256 
	`¥š_lock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

257 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
Ãigh_off_li¡
) {

258 
’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_rou‹_’Œy
, 
li¡
);

259 ià(
’Œy
->
v4_addr
 == ipv4_addr) {

260 
	`li¡_d–
(&
’Œy
->
li¡
);

261 
	`kä“
(
’Œy
);

265 
	`¥š_uÆock_bh
(&
´iv
->
tun
.
Ãigh_off_lock
);

266 
	}
}

269 
	$nå_tun_wr™e_Ãigh
(
Ãt_deviû
 *
Ãtdev
, 
nå_­p
 *
­p
,

270 
æowi4
 *
æow
, 
Ãighbour
 *
Ãigh
, 
gå_t
 
æag
)

272 
nå_tun_Ãigh
 
·ylßd
;

275 ià(!
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
))

278 
	`mem£t
(&
·ylßd
, 0, (
nå_tun_Ãigh
));

279 
·ylßd
.
d¡_v4
 = 
æow
->
daddr
;

282 ià(!(
Ãigh
->
nud_¡©e
 & 
NUD_VALID
è||‚eigh->
d—d
) {

283 
	`nå_tun_d–_rou‹_äom_ÿche
(
­p
, 
·ylßd
.
d¡_v4
);

285 
	`Ãigh_ev’t_£nd
(
Ãigh
, 
NULL
);

286 
£nd_msg
;

290 
·ylßd
.
¤c_v4
 = 
æow
->
§ddr
;

291 
	`‘h”_addr_cÝy
(
·ylßd
.
¤c_addr
, 
Ãtdev
->
dev_addr
);

292 
	`Ãigh_ha_¢­shÙ
(
·ylßd
.
d¡_addr
, 
Ãigh
, 
Ãtdev
);

293 
·ylßd
.
pÜt_id
 = 
	`ýu_to_be32
(
	`nå_»´_g‘_pÜt_id
(
Ãtdev
));

295 
	`nå_tun_add_rou‹_to_ÿche
(
­p
, 
·ylßd
.
d¡_v4
);

297 
£nd_msg
:

298 
	`nå_æow”_xm™_tun_cÚf
(
­p
, 
NFP_FLOWER_CMSG_TYPE_TUN_NEIGH
,

299 (
nå_tun_Ãigh
),

300 (*)&
·ylßd
, 
æag
);

301 
	}
}

304 
	$nå_tun_Ãigh_ev’t_hªdËr
(
nÙif›r_block
 *
nb
, 
ev’t
,

305 *
±r
)

307 
nå_æow”_´iv
 *
­p_´iv
;

308 
Ã‹v’t_»dœeù
 *
»dœ
;

309 
æowi4
 
æow
 = {};

310 
Ãighbour
 *
n
;

311 
nå_­p
 *
­p
;

312 
¹abË
 *
¹
;

313 
”r
;

315 
ev’t
) {

316 
NETEVENT_REDIRECT
:

317 
»dœ
 = (
Ã‹v’t_»dœeù
 *)
±r
;

318 
n
 = 
»dœ
->
Ãigh
;

320 
NETEVENT_NEIGH_UPDATE
:

321 
n
 = (
Ãighbour
 *)
±r
;

324  
NOTIFY_DONE
;

327 
æow
.
daddr
 = *(
__be32
 *)
n
->
´im¬y_key
;

330 ià(!
	`nå_Ãtdev_is_nå_»´
(
n
->
dev
))

331  
NOTIFY_DONE
;

333 
­p_´iv
 = 
	`cÚš”_of
(
nb
, 
nå_æow”_´iv
, 
tun
.
Ãigh_nb
);

334 
­p
 = 
­p_´iv
->app;

337 ià(!
	`nå_tun_has_rou‹
(
­p
, 
æow
.
daddr
))

338  
NOTIFY_DONE
;

340 #ià
	`IS_ENABLED
(
CONFIG_INET
)

342 
¹
 = 
	`_rou‹_ouut_key
(
	`dev_Ãt
(
n
->
dev
), &
æow
);

343 
”r
 = 
	`PTR_ERR_OR_ZERO
(
¹
);

344 ià(
”r
)

345  
NOTIFY_DONE
;

347 
	`_¹_put
(
¹
);

349  
NOTIFY_DONE
;

352 
æow
.
æowi4_´Ùo
 = 
IPPROTO_UDP
;

353 
	`nå_tun_wr™e_Ãigh
(
n
->
dev
, 
­p
, &
æow
,‚, 
GFP_ATOMIC
);

355  
NOTIFY_OK
;

356 
	}
}

358 
	$nå_tuÂ–_»que¡_rou‹
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

360 
nå_tun_»q_rou‹_v4
 *
·ylßd
;

361 
Ãt_deviû
 *
Ãtdev
;

362 
æowi4
 
æow
 = {};

363 
Ãighbour
 *
n
;

364 
¹abË
 *
¹
;

365 
”r
;

367 
·ylßd
 = 
	`nå_æow”_cmsg_g‘_d©a
(
skb
);

369 
Ãtdev
 = 
	`nå_­p_»´_g‘
(
­p
, 
	`be32_to_ýu
(
·ylßd
->
šg»ss_pÜt
));

370 ià(!
Ãtdev
)

371 
rou‹_çž_w¬nšg
;

373 
æow
.
daddr
 = 
·ylßd
->
v4_addr
;

374 
æow
.
æowi4_´Ùo
 = 
IPPROTO_UDP
;

376 #ià
	`IS_ENABLED
(
CONFIG_INET
)

378 
¹
 = 
	`_rou‹_ouut_key
(
	`dev_Ãt
(
Ãtdev
), &
æow
);

379 
”r
 = 
	`PTR_ERR_OR_ZERO
(
¹
);

380 ià(
”r
)

381 
rou‹_çž_w¬nšg
;

383 
rou‹_çž_w¬nšg
;

387 
n
 = 
	`d¡_Ãigh_lookup
(&
¹
->
d¡
, &
æow
.
daddr
);

388 
	`_¹_put
(
¹
);

389 ià(!
n
)

390 
rou‹_çž_w¬nšg
;

391 
	`nå_tun_wr™e_Ãigh
(
n
->
dev
, 
­p
, &
æow
,‚, 
GFP_KERNEL
);

392 
	`Ãigh_»Ëa£
(
n
);

395 
rou‹_çž_w¬nšg
:

396 
	`nå_æow”_cmsg_w¬n
(
­p
, "Requested„oute‚ot found.\n");

397 
	}
}

399 
	$nå_tun_wr™e_v4_li¡
(
nå_­p
 *
­p
)

401 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

402 
nå_v4_addr_’Œy
 *
’Œy
;

403 
nå_tun_v4_addr
 
·ylßd
;

404 
li¡_h—d
 *
±r
, *
¡Üage
;

405 
couÁ
;

407 
	`mem£t
(&
·ylßd
, 0, (
nå_tun_v4_addr
));

408 
	`mu‹x_lock
(&
´iv
->
tun
.
v4_off_lock
);

409 
couÁ
 = 0;

410 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
v4_off_li¡
) {

411 ià(
couÁ
 >ð
NFP_FL_IPV4_ADDRS_MAX
) {

412 
	`mu‹x_uÆock
(&
´iv
->
tun
.
v4_off_lock
);

413 
	`nå_æow”_cmsg_w¬n
(
­p
, "IPv4 offloadƒxceeds†imit.\n");

416 
’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_addr_’Œy
, 
li¡
);

417 
·ylßd
.
v4_addr
[
couÁ
++] = 
’Œy
->ipv4_addr;

419 
·ylßd
.
couÁ
 = 
	`ýu_to_be32
(count);

420 
	`mu‹x_uÆock
(&
´iv
->
tun
.
v4_off_lock
);

422 
	`nå_æow”_xm™_tun_cÚf
(
­p
, 
NFP_FLOWER_CMSG_TYPE_TUN_IPS
,

423 (
nå_tun_v4_addr
),

424 &
·ylßd
, 
GFP_KERNEL
);

425 
	}
}

427 
	$nå_tuÂ–_add_v4_off
(
nå_­p
 *
­p
, 
__be32
 
v4
)

429 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

430 
nå_v4_addr_’Œy
 *
’Œy
;

431 
li¡_h—d
 *
±r
, *
¡Üage
;

433 
	`mu‹x_lock
(&
´iv
->
tun
.
v4_off_lock
);

434 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
v4_off_li¡
) {

435 
’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_addr_’Œy
, 
li¡
);

436 ià(
’Œy
->
v4_addr
 =ð
v4
) {

437 
’Œy
->
»f_couÁ
++;

438 
	`mu‹x_uÆock
(&
´iv
->
tun
.
v4_off_lock
);

443 
’Œy
 = 
	`km®loc
((*’Œy), 
GFP_KERNEL
);

444 ià(!
’Œy
) {

445 
	`mu‹x_uÆock
(&
´iv
->
tun
.
v4_off_lock
);

446 
	`nå_æow”_cmsg_w¬n
(
­p
, "Memƒrror when offloading IP‡ddress.\n");

449 
’Œy
->
v4_addr
 = 
v4
;

450 
’Œy
->
»f_couÁ
 = 1;

451 
	`li¡_add_ž
(&
’Œy
->
li¡
, &
´iv
->
tun
.
v4_off_li¡
);

452 
	`mu‹x_uÆock
(&
´iv
->
tun
.
v4_off_lock
);

454 
	`nå_tun_wr™e_v4_li¡
(
­p
);

455 
	}
}

457 
	$nå_tuÂ–_d–_v4_off
(
nå_­p
 *
­p
, 
__be32
 
v4
)

459 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

460 
nå_v4_addr_’Œy
 *
’Œy
;

461 
li¡_h—d
 *
±r
, *
¡Üage
;

463 
	`mu‹x_lock
(&
´iv
->
tun
.
v4_off_lock
);

464 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
v4_off_li¡
) {

465 
’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_addr_’Œy
, 
li¡
);

466 ià(
’Œy
->
v4_addr
 =ð
v4
) {

467 
’Œy
->
»f_couÁ
--;

468 ià(!
’Œy
->
»f_couÁ
) {

469 
	`li¡_d–
(&
’Œy
->
li¡
);

470 
	`kä“
(
’Œy
);

475 
	`mu‹x_uÆock
(&
´iv
->
tun
.
v4_off_lock
);

477 
	`nå_tun_wr™e_v4_li¡
(
­p
);

478 
	}
}

481 
	$__nå_tuÂ–_ofæßd_mac
(
nå_­p
 *
­p
, 
u8
 *
mac
, 
u16
 
idx
, 
boÞ
 
d–
)

483 
nå_tun_mac_addr_ofæßd
 
·ylßd
;

485 
	`mem£t
(&
·ylßd
, 0, (payload));

487 ià(
d–
)

488 
·ylßd
.
æags
 = 
	`ýu_to_be16
(
NFP_TUN_MAC_OFFLOAD_DEL_FLAG
);

491 
·ylßd
.
couÁ
 = 
	`ýu_to_be16
(1);

492 
·ylßd
.
šdex
 = 
	`ýu_to_be16
(
idx
);

493 
	`‘h”_addr_cÝy
(
·ylßd
.
addr
, 
mac
);

495  
	`nå_æow”_xm™_tun_cÚf
(
­p
, 
NFP_FLOWER_CMSG_TYPE_TUN_MAC
,

496 (
nå_tun_mac_addr_ofæßd
),

497 &
·ylßd
, 
GFP_KERNEL
);

498 
	}
}

500 
boÞ
 
	$nå_tuÂ–_pÜt_is_phy_»´
(
pÜt
)

502 ià(
	`FIELD_GET
(
NFP_FLOWER_CMSG_PORT_TYPE
, 
pÜt
) ==

503 
NFP_FLOWER_CMSG_PORT_TYPE_PHYS_PORT
)

504  
Œue
;

506  
çl£
;

507 
	}
}

509 
u16
 
	$nå_tuÂ–_g‘_mac_idx_äom_phy_pÜt_id
(
pÜt
)

511  
pÜt
 << 8 | 
NFP_FLOWER_CMSG_PORT_TYPE_PHYS_PORT
;

512 
	}
}

514 
u16
 
	$nå_tuÂ–_g‘_glob®_mac_idx_äom_ida
(
id
)

516  
id
 << 8 | 
NFP_FLOWER_CMSG_PORT_TYPE_OTHER_PORT
;

517 
	}
}

519 
	$nå_tuÂ–_g‘_ida_äom_glob®_mac_idx
(
u16
 
nå_mac_idx
)

521  
nå_mac_idx
 >> 8;

522 
	}
}

524 
boÞ
 
	$nå_tuÂ–_is_mac_idx_glob®
(
u16
 
nå_mac_idx
)

526  (
nå_mac_idx
 & 0xffè=ð
NFP_FLOWER_CMSG_PORT_TYPE_OTHER_PORT
;

527 
	}
}

529 
nå_tun_ofæßded_mac
 *

530 
	$nå_tuÂ–_lookup_ofæßded_macs
(
nå_­p
 *
­p
, 
u8
 *
mac
)

532 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

534  
	`rhashbË_lookup_ç¡
(&
´iv
->
tun
.
ofæßded_macs
, 
mac
,

535 
ofæßded_macs_·¿ms
);

536 
	}
}

539 
	$nå_tuÂ–_ofæßded_macs_šc_»f_ªd_lšk
(
nå_tun_ofæßded_mac
 *
’Œy
,

540 
Ãt_deviû
 *
Ãtdev
, 
boÞ
 
mod
)

542 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
)) {

543 
nå_æow”_»´_´iv
 *
»´_´iv
;

544 
nå_»´
 *
»´
;

546 
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

547 
»´_´iv
 = 
»´
->
­p_´iv
;

550 ià(
mod
)

551 
	`li¡_d–
(&
»´_´iv
->
mac_li¡
);

553 
	`li¡_add_ž
(&
»´_´iv
->
mac_li¡
, &
’Œy
->
»´_li¡
);

556 
’Œy
->
»f_couÁ
++;

557 
	}
}

560 
	$nå_tuÂ–_add_sh¬ed_mac
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

561 
pÜt
, 
boÞ
 
mod
)

563 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

564 
ida_idx
 = 
NFP_MAX_MAC_INDEX
, 
”r
;

565 
nå_tun_ofæßded_mac
 *
’Œy
;

566 
u16
 
nå_mac_idx
 = 0;

568 
’Œy
 = 
	`nå_tuÂ–_lookup_ofæßded_macs
(
­p
, 
Ãtdev
->
dev_addr
);

569 ià(
’Œy
 && 
	`nå_tuÂ–_is_mac_idx_glob®
ÓÁry->
šdex
)) {

570 
	`nå_tuÂ–_ofæßded_macs_šc_»f_ªd_lšk
(
’Œy
, 
Ãtdev
, 
mod
);

575 ià(
’Œy
 || !
pÜt
) {

576 
ida_idx
 = 
	`ida_sim¶e_g‘
(&
´iv
->
tun
.
mac_off_ids
, 0,

577 
NFP_MAX_MAC_INDEX
, 
GFP_KERNEL
);

578 ià(
ida_idx
 < 0)

579  
ida_idx
;

581 
nå_mac_idx
 = 
	`nå_tuÂ–_g‘_glob®_mac_idx_äom_ida
(
ida_idx
);

583 
nå_mac_idx
 = 
	`nå_tuÂ–_g‘_mac_idx_äom_phy_pÜt_id
(
pÜt
);

586 ià(!
’Œy
) {

587 
’Œy
 = 
	`kz®loc
((*’Œy), 
GFP_KERNEL
);

588 ià(!
’Œy
) {

589 
”r
 = -
ENOMEM
;

590 
”r_ä“_ida
;

593 
	`‘h”_addr_cÝy
(
’Œy
->
addr
, 
Ãtdev
->
dev_addr
);

594 
	`INIT_LIST_HEAD
(&
’Œy
->
»´_li¡
);

596 ià(
	`rhashbË_š£¹_ç¡
(&
´iv
->
tun
.
ofæßded_macs
,

597 &
’Œy
->
ht_node
,

598 
ofæßded_macs_·¿ms
)) {

599 
”r
 = -
ENOMEM
;

600 
”r_ä“_’Œy
;

604 
”r
 = 
	`__nå_tuÂ–_ofæßd_mac
(
­p
, 
Ãtdev
->
dev_addr
,

605 
nå_mac_idx
, 
çl£
);

606 ià(
”r
) {

608 ià(!
’Œy
->
»f_couÁ
)

609 
”r_»move_hash
;

610 
”r_ä“_ida
;

613 
’Œy
->
šdex
 = 
nå_mac_idx
;

614 
	`nå_tuÂ–_ofæßded_macs_šc_»f_ªd_lšk
(
’Œy
, 
Ãtdev
, 
mod
);

618 
”r_»move_hash
:

619 
	`rhashbË_»move_ç¡
(&
´iv
->
tun
.
ofæßded_macs
, &
’Œy
->
ht_node
,

620 
ofæßded_macs_·¿ms
);

621 
”r_ä“_’Œy
:

622 
	`kä“
(
’Œy
);

623 
”r_ä“_ida
:

624 ià(
ida_idx
 !ð
NFP_MAX_MAC_INDEX
)

625 
	`ida_sim¶e_»move
(&
´iv
->
tun
.
mac_off_ids
, 
ida_idx
);

627  
”r
;

628 
	}
}

631 
	$nå_tuÂ–_d–_sh¬ed_mac
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

632 
u8
 *
mac
, 
boÞ
 
mod
)

634 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

635 
nå_æow”_»´_´iv
 *
»´_´iv
;

636 
nå_tun_ofæßded_mac
 *
’Œy
;

637 
nå_»´
 *
»´
;

638 
ida_idx
;

640 
’Œy
 = 
	`nå_tuÂ–_lookup_ofæßded_macs
(
­p
, 
mac
);

641 ià(!
’Œy
)

644 
’Œy
->
»f_couÁ
--;

646 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
è&& !
mod
) {

647 
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

648 
»´_´iv
 = 
»´
->
­p_´iv
;

649 
	`li¡_d–
(&
»´_´iv
->
mac_li¡
);

653 ià(
’Œy
->
»f_couÁ
 =ð1 && 
	`li¡_is_sšguÏr
(&’Œy->
»´_li¡
)) {

654 
u16
 
nå_mac_idx
;

655 
pÜt
, 
”r
;

657 
»´_´iv
 = 
	`li¡_fœ¡_’Œy
(&
’Œy
->
»´_li¡
,

658 
nå_æow”_»´_´iv
,

659 
mac_li¡
);

660 
»´
 = 
»´_´iv
->
nå_»´
;

661 
pÜt
 = 
	`nå_»´_g‘_pÜt_id
(
»´
->
Ãtdev
);

662 
nå_mac_idx
 = 
	`nå_tuÂ–_g‘_mac_idx_äom_phy_pÜt_id
(
pÜt
);

663 
”r
 = 
	`__nå_tuÂ–_ofæßd_mac
(
­p
, 
mac
, 
nå_mac_idx
, 
çl£
);

664 ià(
”r
) {

665 
	`nå_æow”_cmsg_w¬n
(
­p
, "MAC offload index„evert failed on %s.\n",

666 
	`Ãtdev_Çme
(
Ãtdev
));

670 
ida_idx
 = 
	`nå_tuÂ–_g‘_ida_äom_glob®_mac_idx
(
’Œy
->
šdex
);

671 
	`ida_sim¶e_»move
(&
´iv
->
tun
.
mac_off_ids
, 
ida_idx
);

672 
’Œy
->
šdex
 = 
nå_mac_idx
;

676 ià(
’Œy
->
»f_couÁ
)

679 
	`WARN_ON_ONCE
(
	`rhashbË_»move_ç¡
(&
´iv
->
tun
.
ofæßded_macs
,

680 &
’Œy
->
ht_node
,

681 
ofæßded_macs_·¿ms
));

683 ià(
	`nå_tuÂ–_is_mac_idx_glob®
(
’Œy
->
šdex
)) {

684 
ida_idx
 = 
	`nå_tuÂ–_g‘_ida_äom_glob®_mac_idx
(
’Œy
->
šdex
);

685 
	`ida_sim¶e_»move
(&
´iv
->
tun
.
mac_off_ids
, 
ida_idx
);

688 
	`kä“
(
’Œy
);

690  
	`__nå_tuÂ–_ofæßd_mac
(
­p
, 
mac
, 0, 
Œue
);

691 
	}
}

694 
	$nå_tuÂ–_ofæßd_mac
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

695 
nå_æow”_mac_ofæßd_cmd
 
cmd
)

697 
nå_æow”_nÚ_»´_´iv
 *
Ä_´iv
 = 
NULL
;

698 
boÞ
 
nÚ_»´
 = 
çl£
, *
mac_ofæßded
;

699 
u8
 *
off_mac
 = 
NULL
;

700 
”r
, 
pÜt
 = 0;

702 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
)) {

703 
nå_æow”_»´_´iv
 *
»´_´iv
;

704 
nå_»´
 *
»´
;

706 
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

707 ià(
»´
->
­p
 !=‡pp)

710 
»´_´iv
 = 
»´
->
­p_´iv
;

711 
mac_ofæßded
 = &
»´_´iv
->mac_offloaded;

712 
off_mac
 = &
»´_´iv
->
ofæßded_mac_addr
[0];

713 
pÜt
 = 
	`nå_»´_g‘_pÜt_id
(
Ãtdev
);

714 ià(!
	`nå_tuÂ–_pÜt_is_phy_»´
(
pÜt
))

716 } ià(
	`nå_æ_is_Ãtdev_to_ofæßd
(
Ãtdev
)) {

717 
Ä_´iv
 = 
	`nå_æow”_nÚ_»´_´iv_g‘
(
­p
, 
Ãtdev
);

718 ià(!
Ä_´iv
)

719  -
ENOMEM
;

721 
mac_ofæßded
 = &
Ä_´iv
->mac_offloaded;

722 
off_mac
 = &
Ä_´iv
->
ofæßded_mac_addr
[0];

723 
nÚ_»´
 = 
Œue
;

728 ià(!
	`is_v®id_‘h”_addr
(
Ãtdev
->
dev_addr
)) {

729 
”r
 = -
EINVAL
;

730 
”r_put_nÚ_»´_´iv
;

733 ià(
cmd
 =ð
NFP_TUNNEL_MAC_OFFLOAD_MOD
 && !*
mac_ofæßded
)

734 
cmd
 = 
NFP_TUNNEL_MAC_OFFLOAD_ADD
;

736 
cmd
) {

737 
NFP_TUNNEL_MAC_OFFLOAD_ADD
:

738 
”r
 = 
	`nå_tuÂ–_add_sh¬ed_mac
(
­p
, 
Ãtdev
, 
pÜt
, 
çl£
);

739 ià(
”r
)

740 
”r_put_nÚ_»´_´iv
;

742 ià(
nÚ_»´
)

743 
	`__nå_æow”_nÚ_»´_´iv_g‘
(
Ä_´iv
);

745 *
mac_ofæßded
 = 
Œue
;

746 
	`‘h”_addr_cÝy
(
off_mac
, 
Ãtdev
->
dev_addr
);

748 
NFP_TUNNEL_MAC_OFFLOAD_DEL
:

750 ià(!*
mac_ofæßded
)

753 ià(
nÚ_»´
)

754 
	`__nå_æow”_nÚ_»´_´iv_put
(
Ä_´iv
);

756 *
mac_ofæßded
 = 
çl£
;

758 
”r
 = 
	`nå_tuÂ–_d–_sh¬ed_mac
(
­p
, 
Ãtdev
,‚‘dev->
dev_addr
,

759 
çl£
);

760 ià(
”r
)

761 
”r_put_nÚ_»´_´iv
;

764 
NFP_TUNNEL_MAC_OFFLOAD_MOD
:

766 ià(
	`‘h”_addr_equ®
(
Ãtdev
->
dev_addr
, 
off_mac
))

769 
”r
 = 
	`nå_tuÂ–_add_sh¬ed_mac
(
­p
, 
Ãtdev
, 
pÜt
, 
Œue
);

770 ià(
”r
)

771 
”r_put_nÚ_»´_´iv
;

774 
”r
 = 
	`nå_tuÂ–_d–_sh¬ed_mac
(
­p
, 
Ãtdev
, 
off_mac
, 
Œue
);

775 ià(
”r
)

776 
	`nå_æow”_cmsg_w¬n
(
­p
, "Failedo„emove offload of„eplaced MAC‡ddr on %s.\n",

777 
	`Ãtdev_Çme
(
Ãtdev
));

779 
	`‘h”_addr_cÝy
(
off_mac
, 
Ãtdev
->
dev_addr
);

782 
”r
 = -
EINVAL
;

783 
”r_put_nÚ_»´_´iv
;

786 ià(
nÚ_»´
)

787 
	`__nå_æow”_nÚ_»´_´iv_put
(
Ä_´iv
);

791 
”r_put_nÚ_»´_´iv
:

792 ià(
nÚ_»´
)

793 
	`__nå_æow”_nÚ_»´_´iv_put
(
Ä_´iv
);

795  
”r
;

796 
	}
}

798 
	$nå_tuÂ–_mac_ev’t_hªdËr
(
nå_­p
 *
­p
,

799 
Ãt_deviû
 *
Ãtdev
,

800 
ev’t
, *
±r
)

802 
”r
;

804 ià(
ev’t
 =ð
NETDEV_DOWN
) {

805 
”r
 = 
	`nå_tuÂ–_ofæßd_mac
(
­p
, 
Ãtdev
,

806 
NFP_TUNNEL_MAC_OFFLOAD_DEL
);

807 ià(
”r
)

808 
	`nå_æow”_cmsg_w¬n
(
­p
, "Failedo delete offload MAC on %s.\n",

809 
	`Ãtdev_Çme
(
Ãtdev
));

810 } ià(
ev’t
 =ð
NETDEV_UP
) {

811 
”r
 = 
	`nå_tuÂ–_ofæßd_mac
(
­p
, 
Ãtdev
,

812 
NFP_TUNNEL_MAC_OFFLOAD_ADD
);

813 ià(
”r
)

814 
	`nå_æow”_cmsg_w¬n
(
­p
, "Failedo offload MAC on %s.\n",

815 
	`Ãtdev_Çme
(
Ãtdev
));

816 } ià(
ev’t
 =ð
NETDEV_CHANGEADDR
) {

818 ià(!(
Ãtdev
->
æags
 & 
IFF_UP
))

819  
NOTIFY_OK
;

821 
”r
 = 
	`nå_tuÂ–_ofæßd_mac
(
­p
, 
Ãtdev
,

822 
NFP_TUNNEL_MAC_OFFLOAD_MOD
);

823 ià(
”r
)

824 
	`nå_æow”_cmsg_w¬n
(
­p
, "Failedo offload MAC change on %s.\n",

825 
	`Ãtdev_Çme
(
Ãtdev
));

827  
NOTIFY_OK
;

828 
	}
}

830 
	$nå_tuÂ–_cÚfig_¡¬t
(
nå_­p
 *
­p
)

832 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

833 
”r
;

836 
”r
 = 
	`rhashbË_š™
(&
´iv
->
tun
.
ofæßded_macs
,

837 &
ofæßded_macs_·¿ms
);

838 ià(
”r
)

839  
”r
;

841 
	`ida_š™
(&
´iv
->
tun
.
mac_off_ids
);

844 
	`mu‹x_š™
(&
´iv
->
tun
.
v4_off_lock
);

845 
	`INIT_LIST_HEAD
(&
´iv
->
tun
.
v4_off_li¡
);

848 
	`¥š_lock_š™
(&
´iv
->
tun
.
Ãigh_off_lock
);

849 
	`INIT_LIST_HEAD
(&
´iv
->
tun
.
Ãigh_off_li¡
);

850 
´iv
->
tun
.
Ãigh_nb
.
nÙif›r_ÿÎ
 = 
nå_tun_Ãigh_ev’t_hªdËr
;

852 
”r
 = 
	`»gi¡”_Ã‹v’t_nÙif›r
(&
´iv
->
tun
.
Ãigh_nb
);

853 ià(
”r
) {

854 
	`rhashbË_ä“_ªd_de¡roy
(&
´iv
->
tun
.
ofæßded_macs
,

855 
nå_check_rhashbË_em±y
, 
NULL
);

856  
”r
;

860 
	}
}

862 
	$nå_tuÂ–_cÚfig_¡Ý
(
nå_­p
 *
­p
)

864 
nå_æow”_´iv
 *
´iv
 = 
­p
->priv;

865 
nå_v4_rou‹_’Œy
 *
rou‹_’Œy
;

866 
nå_v4_addr_’Œy
 *
_’Œy
;

867 
li¡_h—d
 *
±r
, *
¡Üage
;

869 
	`uÄegi¡”_Ã‹v’t_nÙif›r
(&
´iv
->
tun
.
Ãigh_nb
);

871 
	`ida_de¡roy
(&
´iv
->
tun
.
mac_off_ids
);

874 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
v4_off_li¡
) {

875 
_’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_addr_’Œy
, 
li¡
);

876 
	`li¡_d–
(&
_’Œy
->
li¡
);

877 
	`kä“
(
_’Œy
);

881 
	`li¡_fÜ_—ch_§ã
(
±r
, 
¡Üage
, &
´iv
->
tun
.
Ãigh_off_li¡
) {

882 
rou‹_’Œy
 = 
	`li¡_’Œy
(
±r
, 
nå_v4_rou‹_’Œy
,

883 
li¡
);

884 
	`li¡_d–
(&
rou‹_’Œy
->
li¡
);

885 
	`kä“
(
rou‹_’Œy
);

889 
	`rhashbË_ä“_ªd_de¡roy
(&
´iv
->
tun
.
ofæßded_macs
,

890 
nå_check_rhashbË_em±y
, 
NULL
);

891 
	}
}

	@src/nfd3/dp.c

4 
	~"nå_Ãt_com·t.h
"

6 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 11, 0)

7 
	~<lšux/bpf_Œaû.h
>

9 
	~<lšux/Ãtdeviû.h
>

11 
	~"../nå_­p.h
"

12 
	~"../nå_Ãt.h
"

13 
	~"../nå_Ãt_dp.h
"

14 
	~"nfd3.h
"

30 
	$nå_nfd3_tx_ršg_should_wake
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

32  !
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 
MAX_SKB_FRAGS
 * 4);

33 
	}
}

35 
	$nå_nfd3_tx_ršg_should_¡Ý
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

37  
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 
MAX_SKB_FRAGS
 + 1);

38 
	}
}

50 
	$nå_nfd3_tx_ršg_¡Ý
(
Ãtdev_queue
 *
nd_q
,

51 
nå_Ãt_tx_ršg
 *
tx_ršg
)

53 
	`Ãtif_tx_¡Ý_queue
(
nd_q
);

56 
	`smp_mb
();

57 ià(
	`uÆik–y
(
	`nå_nfd3_tx_ršg_should_wake
(
tx_ršg
)))

58 
	`Ãtif_tx_¡¬t_queue
(
nd_q
);

59 
	}
}

73 
	$nå_nfd3_tx_tso
(
nå_Ãt_r_veùÜ
 *
r_vec
, 
nå_nfd3_tx_buf
 *
txbuf
,

74 
nå_nfd3_tx_desc
 *
txd
, 
sk_buff
 *
skb
, 
u32
 
md_by‹s
)

76 
u32
 
l3_off£t
, 
l4_off£t
, 
hd¾’
;

77 
u16
 
mss
;

79 ià(!
	`skb_is_gso
(
skb
))

82 ià(!
skb
->
’ÿpsuÏtiÚ
) {

83 
l3_off£t
 = 
	`skb_ÃtwÜk_off£t
(
skb
);

84 
l4_off£t
 = 
	`skb_Œª¥Üt_off£t
(
skb
);

85 
hd¾’
 = 
	`skb_Œª¥Üt_off£t
(
skb
è+ 
	`tý_hd¾’
(skb);

87 
l3_off£t
 = 
	`skb_šÃr_ÃtwÜk_off£t
(
skb
);

88 
l4_off£t
 = 
	`skb_šÃr_Œª¥Üt_off£t
(
skb
);

89 
hd¾’
 = 
	`skb_šÃr_Œª¥Üt_h—d”
(
skb
è- skb->
d©a
 +

90 
	`šÃr_tý_hd¾’
(
skb
);

93 
txbuf
->
pkt_út
 = 
	`skb_shšfo
(
skb
)->
gso_£gs
;

94 
txbuf
->
»®_Ën
 +ð
hd¾’
 * (txbuf->
pkt_út
 - 1);

96 
mss
 = 
	`skb_shšfo
(
skb
)->
gso_size
 & 
NFD3_DESC_TX_MSS_MASK
;

97 
txd
->
l3_off£t
 =†3_off£ˆ- 
md_by‹s
;

98 
txd
->
l4_off£t
 =†4_off£ˆ- 
md_by‹s
;

99 
txd
->
lso_hd¾’
 = 
hd¾’
 - 
md_by‹s
;

100 
txd
->
mss
 = 
	`ýu_to_Ë16
(mss);

101 
txd
->
æags
 |ð
NFD3_DESC_TX_LSO
;

103 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

104 
r_vec
->
tx_lso
++;

105 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

106 
	}
}

120 
	$nå_nfd3_tx_csum
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

121 
nå_nfd3_tx_buf
 *
txbuf
, 
nå_nfd3_tx_desc
 *
txd
,

122 
sk_buff
 *
skb
)

124 
v6hdr
 *
v6h
;

125 
hdr
 *
h
;

126 
u8
 
l4_hdr
;

128 ià(!(
dp
->
ù¾
 & 
NFP_NET_CFG_CTRL_TXCSUM
))

131 ià(
skb
->
_summed
 !ð
CHECKSUM_PARTIAL
)

134 
txd
->
æags
 |ð
NFD3_DESC_TX_CSUM
;

135 ià(
skb
->
’ÿpsuÏtiÚ
)

136 
txd
->
æags
 |ð
NFD3_DESC_TX_ENCAP
;

138 
h
 = 
skb
->
’ÿpsuÏtiÚ
 ? 
	`šÃr__hdr
(skbè: 
	`_hdr
(skb);

139 
v6h
 = 
skb
->
’ÿpsuÏtiÚ
 ? 
	`šÃr_v6_hdr
(skbè: 
	`v6_hdr
(skb);

141 ià(
h
->
v”siÚ
 == 4) {

142 
txd
->
æags
 |ð
NFD3_DESC_TX_IP4_CSUM
;

143 
l4_hdr
 = 
h
->
´ÙocÞ
;

144 } ià(
v6h
->
v”siÚ
 == 6) {

145 
l4_hdr
 = 
v6h
->
Ãxthdr
;

147 
	`Â_dp_w¬n
(
dp
, "·¹ŸÈchecksum buˆv=%x!\n", 
h
->
v”siÚ
);

151 
l4_hdr
) {

152 
IPPROTO_TCP
:

153 
txd
->
æags
 |ð
NFD3_DESC_TX_TCP_CSUM
;

155 
IPPROTO_UDP
:

156 
txd
->
æags
 |ð
NFD3_DESC_TX_UDP_CSUM
;

159 
	`Â_dp_w¬n
(
dp
, "·¹ŸÈchecksum buˆl4…rÙo=%x!\n", 
l4_hdr
);

163 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

164 ià(
skb
->
’ÿpsuÏtiÚ
)

165 
r_vec
->
hw_csum_tx_šÃr
 +ð
txbuf
->
pkt_út
;

167 
r_vec
->
hw_csum_tx
 +ð
txbuf
->
pkt_út
;

168 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

169 
	}
}

171 #ifdeà
COMPAT__HAVE_METADATA_IP_TUNNEL


172 
	$nå_nfd3_´•_pÜt_id
(
sk_buff
 *
skb
)

174 
m‘ad©a_d¡
 *
md_d¡
 = 
	`skb_m‘ad©a_d¡
(
skb
);

175 *
d©a
;

177 ià(
	`lik–y
(!
md_d¡
))

179 ià(
	`uÆik–y
(
md_d¡
->
ty³
 !ð
METADATA_HW_PORT_MUX
))

182 ià(
	`uÆik–y
(
	`skb_cow_h—d
(
skb
, 8)))

183  -
ENOMEM
;

185 
d©a
 = 
	`skb_push
(
skb
, 8);

186 
	`put_uÇligÃd_be32
(
NFP_NET_META_PORTID
, 
d©a
);

187 
	`put_uÇligÃd_be32
(
md_d¡
->
u
.
pÜt_šfo
.
pÜt_id
, 
d©a
 + 4);

190 
	}
}

192 
	$nå_nfd3_´•_pÜt_id
(
sk_buff
 *
skb
)

195 
	}
}

205 
	$nå_nfd3_tx
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
)

207 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

208 cÚ¡ 
skb_äag_¡ruù
 *
äag
;

209 
f
, 
Ä_äags
, 
wr_idx
, 
md_by‹s
;

210 
nå_Ãt_tx_ršg
 *
tx_ršg
;

211 
nå_Ãt_r_veùÜ
 *
r_vec
;

212 
nå_nfd3_tx_buf
 *
txbuf
;

213 
nå_nfd3_tx_desc
 *
txd
;

214 
Ãtdev_queue
 *
nd_q
;

215 
nå_Ãt_dp
 *
dp
;

216 
dma_addr_t
 
dma_addr
;

217 
fsize
;

218 
u16
 
qidx
;

220 
dp
 = &
Â
->dp;

221 
qidx
 = 
	`skb_g‘_queue_m­pšg
(
skb
);

222 
tx_ršg
 = &
dp
->
tx_ršgs
[
qidx
];

223 
r_vec
 = 
tx_ršg
->r_vec;

225 
Ä_äags
 = 
	`skb_shšfo
(
skb
)->nr_frags;

227 ià(
	`uÆik–y
(
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 
Ä_äags
 + 1))) {

228 
	`Â_dp_w¬n
(
dp
, "TX„ing %d busy. wrp=%u„dp=%u\n",

229 
qidx
, 
tx_ršg
->
wr_p
,x_ršg->
rd_p
);

230 
nd_q
 = 
	`Ãtdev_g‘_tx_queue
(
dp
->
Ãtdev
, 
qidx
);

231 
	`Ãtif_tx_¡Ý_queue
(
nd_q
);

232 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

233 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

234 
r_vec
->
tx_busy
++;

235 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

236  
NETDEV_TX_BUSY
;

239 
md_by‹s
 = 
	`nå_nfd3_´•_pÜt_id
(
skb
);

240 ià(
	`uÆik–y
(
md_by‹s
 < 0)) {

241 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

242 
	`dev_kä“_skb_ªy
(
skb
);

243  
NETDEV_TX_OK
;

246 ià(
	`uÆik–y
(
	`com·t_ndo_ã©u»s_check
(
Â
, 
skb
))) {

247 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

248 
	`dev_kä“_skb_ªy
(
skb
);

249  
NETDEV_TX_OK
;

253 
dma_addr
 = 
	`dma_m­_sšgË
(
dp
->
dev
, 
skb
->
d©a
, 
	`skb_h—dËn
(skb),

254 
DMA_TO_DEVICE
);

255 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, 
dma_addr
))

256 
”r_ä“
;

258 
wr_idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
wr_p
);

261 
txbuf
 = &
tx_ršg
->
txbufs
[
wr_idx
];

262 
txbuf
->
skb
 = skb;

263 
txbuf
->
dma_addr
 = dma_addr;

264 
txbuf
->
fidx
 = -1;

265 
txbuf
->
pkt_út
 = 1;

266 
txbuf
->
»®_Ën
 = 
skb
->
Ën
;

269 
txd
 = &
tx_ršg
->
txds
[
wr_idx
];

270 
txd
->
off£t_eÝ
 = (
Ä_äags
 ? 0 : 
NFD3_DESC_TX_EOP
è| 
md_by‹s
;

271 
txd
->
dma_Ën
 = 
	`ýu_to_Ë16
(
	`skb_h—dËn
(
skb
));

272 
	`nå_desc_£t_dma_addr_40b
(
txd
, 
dma_addr
);

273 
txd
->
d©a_Ën
 = 
	`ýu_to_Ë16
(
skb
->
Ën
);

275 
txd
->
æags
 = 0;

276 
txd
->
mss
 = 0;

277 
txd
->
lso_hd¾’
 = 0;

280 
	`nå_nfd3_tx_tso
(
r_vec
, 
txbuf
, 
txd
, 
skb
, 
md_by‹s
);

281 
	`nå_nfd3_tx_csum
(
dp
, 
r_vec
, 
txbuf
, 
txd
, 
skb
);

282 ià(
	`skb_vÏn_g_´e£Á
(
skb
è&& 
dp
->
ù¾
 & 
NFP_NET_CFG_CTRL_TXVLAN
) {

283 
txd
->
æags
 |ð
NFD3_DESC_TX_VLAN
;

284 
txd
->
vÏn
 = 
	`ýu_to_Ë16
(
	`skb_vÏn_g_g‘
(
skb
));

288 ià(
Ä_äags
 > 0) {

289 
__Ë64
 
£cÚd_h®f
;

292 
£cÚd_h®f
 = 
txd
->
v®s8
[1];

294 
f
 = 0; f < 
Ä_äags
; f++) {

295 
äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
f
];

296 
fsize
 = 
	`skb_äag_size
(
äag
);

298 
dma_addr
 = 
	`skb_äag_dma_m­
(
dp
->
dev
, 
äag
, 0,

299 
fsize
, 
DMA_TO_DEVICE
);

300 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, 
dma_addr
))

301 
”r_unm­
;

303 
wr_idx
 = 
	`D_IDX
(
tx_ršg
, wr_idx + 1);

304 
tx_ršg
->
txbufs
[
wr_idx
].
skb
 = skb;

305 
tx_ršg
->
txbufs
[
wr_idx
].
dma_addr
 = dma_addr;

306 
tx_ršg
->
txbufs
[
wr_idx
].
fidx
 = 
f
;

308 
txd
 = &
tx_ršg
->
txds
[
wr_idx
];

309 
txd
->
dma_Ën
 = 
	`ýu_to_Ë16
(
fsize
);

310 
	`nå_desc_£t_dma_addr_40b
(
txd
, 
dma_addr
);

311 
txd
->
off£t_eÝ
 = 
md_by‹s
 |

312 ((
f
 =ð
Ä_äags
 - 1è? 
NFD3_DESC_TX_EOP
 : 0);

313 
txd
->
v®s8
[1] = 
£cÚd_h®f
;

316 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

317 
r_vec
->
tx_g©h”
++;

318 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

321 
	`skb_tx_time¡amp
(
skb
);

323 
nd_q
 = 
	`Ãtdev_g‘_tx_queue
(
dp
->
Ãtdev
, 
tx_ršg
->
idx
);

325 
tx_ršg
->
wr_p
 +ð
Ä_äags
 + 1;

326 ià(
	`nå_nfd3_tx_ršg_should_¡Ý
(
tx_ršg
))

327 
	`nå_nfd3_tx_ršg_¡Ý
(
nd_q
, 
tx_ršg
);

329 
tx_ršg
->
wr_±r_add
 +ð
Ä_äags
 + 1;

330 ià(
	`__Ãtdev_tx_£Á_queue
(
nd_q
, 
txbuf
->
»®_Ën
, 
	`skb_xm™_mÜe
(
skb
)))

331 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

333  
NETDEV_TX_OK
;

335 
”r_unm­
:

336 --
f
 >= 0) {

337 
äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
f
];

338 
	`dma_unm­_·ge
(
dp
->
dev
, 
tx_ršg
->
txbufs
[
wr_idx
].
dma_addr
,

339 
	`skb_äag_size
(
äag
), 
DMA_TO_DEVICE
);

340 
tx_ršg
->
txbufs
[
wr_idx
].
skb
 = 
NULL
;

341 
tx_ršg
->
txbufs
[
wr_idx
].
dma_addr
 = 0;

342 
tx_ršg
->
txbufs
[
wr_idx
].
fidx
 = -2;

343 
wr_idx
 = wr_idx - 1;

344 ià(
wr_idx
 < 0)

345 
wr_idx
 +ð
tx_ršg
->
út
;

347 
	`dma_unm­_sšgË
(
dp
->
dev
, 
tx_ršg
->
txbufs
[
wr_idx
].
dma_addr
,

348 
	`skb_h—dËn
(
skb
), 
DMA_TO_DEVICE
);

349 
tx_ršg
->
txbufs
[
wr_idx
].
skb
 = 
NULL
;

350 
tx_ršg
->
txbufs
[
wr_idx
].
dma_addr
 = 0;

351 
tx_ršg
->
txbufs
[
wr_idx
].
fidx
 = -2;

352 
”r_ä“
:

353 
	`Â_dp_w¬n
(
dp
, "Failedo map DMA TX buffer\n");

354 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

355 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

356 
r_vec
->
tx_”rÜs
++;

357 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

358 
	`dev_kä“_skb_ªy
(
skb
);

359  
NETDEV_TX_OK
;

360 
	}
}

367 
	$nå_nfd3_tx_com¶‘e
(
nå_Ãt_tx_ršg
 *
tx_ršg
, 
budg‘
)

369 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
tx_ršg
->r_vec;

370 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

371 
u32
 
dÚe_pkts
 = 0, 
dÚe_by‹s
 = 0;

372 
Ãtdev_queue
 *
nd_q
;

373 
u32
 
qý_rd_p
;

374 
todo
;

376 ià(
tx_ršg
->
wr_p
 =ðtx_ršg->
rd_p
)

380 
qý_rd_p
 = 
	`nå_Ãt_»ad_tx_cm¶
(
tx_ršg
, 
dp
);

382 ià(
qý_rd_p
 =ð
tx_ršg
->qcp_rd_p)

385 
todo
 = 
	`D_IDX
(
tx_ršg
, 
qý_rd_p
 -x_ring->qcp_rd_p);

387 
todo
--) {

388 cÚ¡ 
skb_äag_¡ruù
 *
äag
;

389 
nå_nfd3_tx_buf
 *
tx_buf
;

390 
sk_buff
 *
skb
;

391 
fidx
, 
Ä_äags
;

392 
idx
;

394 
idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
rd_p
++);

395 
tx_buf
 = &
tx_ršg
->
txbufs
[
idx
];

397 
skb
 = 
tx_buf
->skb;

398 ià(!
skb
)

401 
Ä_äags
 = 
	`skb_shšfo
(
skb
)->nr_frags;

402 
fidx
 = 
tx_buf
->fidx;

404 ià(
fidx
 == -1) {

406 
	`dma_unm­_sšgË
(
dp
->
dev
, 
tx_buf
->
dma_addr
,

407 
	`skb_h—dËn
(
skb
), 
DMA_TO_DEVICE
);

409 
dÚe_pkts
 +ð
tx_buf
->
pkt_út
;

410 
dÚe_by‹s
 +ð
tx_buf
->
»®_Ën
;

413 
äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
fidx
];

414 
	`dma_unm­_·ge
(
dp
->
dev
, 
tx_buf
->
dma_addr
,

415 
	`skb_äag_size
(
äag
), 
DMA_TO_DEVICE
);

419 ià(
fidx
 =ð
Ä_äags
 - 1)

420 
	`Çpi_cÚsume_skb
(
skb
, 
budg‘
);

422 
tx_buf
->
dma_addr
 = 0;

423 
tx_buf
->
skb
 = 
NULL
;

424 
tx_buf
->
fidx
 = -2;

427 
tx_ršg
->
qý_rd_p
 = qcp_rd_p;

429 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

430 
r_vec
->
tx_by‹s
 +ð
dÚe_by‹s
;

431 
r_vec
->
tx_pkts
 +ð
dÚe_pkts
;

432 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

434 ià(!
dp
->
Ãtdev
)

437 
nd_q
 = 
	`Ãtdev_g‘_tx_queue
(
dp
->
Ãtdev
, 
tx_ršg
->
idx
);

438 
	`Ãtdev_tx_com¶‘ed_queue
(
nd_q
, 
dÚe_pkts
, 
dÚe_by‹s
);

439 ià(
	`nå_nfd3_tx_ršg_should_wake
(
tx_ršg
)) {

441 
	`smp_mb
();

443 ià(
	`uÆik–y
(
	`Ãtif_tx_queue_¡Ý³d
(
nd_q
)))

444 
	`Ãtif_tx_wake_queue
(
nd_q
);

447 
	`WARN_ONCE
(
tx_ršg
->
wr_p
 -x_ršg->
rd_p
 >x_ršg->
út
,

449 
tx_ršg
->
rd_p
,x_ršg->
wr_p
,x_ršg->
út
);

450 
	}
}

452 
boÞ
 
	$nå_nfd3_xdp_com¶‘e
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

454 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
tx_ršg
->r_vec;

455 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

456 
u32
 
dÚe_pkts
 = 0, 
dÚe_by‹s
 = 0;

457 
boÞ
 
dÚe_®l
;

458 
idx
, 
todo
;

459 
u32
 
qý_rd_p
;

462 
qý_rd_p
 = 
	`nå_Ãt_»ad_tx_cm¶
(
tx_ršg
, 
dp
);

464 ià(
qý_rd_p
 =ð
tx_ršg
->qcp_rd_p)

465  
Œue
;

467 
todo
 = 
	`D_IDX
(
tx_ršg
, 
qý_rd_p
 -x_ring->qcp_rd_p);

469 
dÚe_®l
 = 
todo
 <ð
NFP_NET_XDP_MAX_COMPLETE
;

470 
todo
 = 
	`mš
Ñodo, 
NFP_NET_XDP_MAX_COMPLETE
);

472 
tx_ršg
->
qý_rd_p
 = 
	`D_IDX
Ñx_ršg,x_ršg->qý_rd_°+ 
todo
);

474 
dÚe_pkts
 = 
todo
;

475 
todo
--) {

476 
idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
rd_p
);

477 
tx_ršg
->
rd_p
++;

479 
dÚe_by‹s
 +ð
tx_ršg
->
txbufs
[
idx
].
»®_Ën
;

482 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

483 
r_vec
->
tx_by‹s
 +ð
dÚe_by‹s
;

484 
r_vec
->
tx_pkts
 +ð
dÚe_pkts
;

485 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

487 
	`WARN_ONCE
(
tx_ršg
->
wr_p
 -x_ršg->
rd_p
 >x_ršg->
út
,

489 
tx_ršg
->
rd_p
,x_ršg->
wr_p
,x_ršg->
út
);

491  
dÚe_®l
;

492 
	}
}

498 
	$nå_nfd3_Çpi_®loc_Úe
(
nå_Ãt_dp
 *
dp
, 
dma_addr_t
 *
dma_addr
)

500 *
äag
;

502 ià(!
dp
->
xdp_´og
) {

503 
äag
 = 
	`Çpi_®loc_äag
(
dp
->
æ_bufsz
);

504 ià(
	`uÆik–y
(!
äag
))

505  
NULL
;

507 
·ge
 *page;

509 
·ge
 = 
	`dev_®loc_·ge
();

510 ià(
	`uÆik–y
(!
·ge
))

511  
NULL
;

512 
äag
 = 
	`·ge_add»ss
(
·ge
);

515 *
dma_addr
 = 
	`nå_Ãt_dma_m­_rx
(
dp
, 
äag
);

516 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, *
dma_addr
)) {

517 
	`nå_Ãt_ä“_äag
(
äag
, 
dp
->
xdp_´og
);

518 
	`Â_dp_w¬n
(
dp
, "Failedo map DMA RX buffer\n");

519  
NULL
;

522  
äag
;

523 
	}
}

533 
	$nå_nfd3_rx_give_Úe
(cÚ¡ 
nå_Ãt_dp
 *
dp
,

534 
nå_Ãt_rx_ršg
 *
rx_ršg
,

535 *
äag
, 
dma_addr_t
 
dma_addr
)

537 
wr_idx
;

539 
wr_idx
 = 
	`D_IDX
(
rx_ršg
,„x_ršg->
wr_p
);

541 
	`nå_Ãt_dma_sync_dev_rx
(
dp
, 
dma_addr
);

544 
rx_ršg
->
rxbufs
[
wr_idx
].
äag
 = frag;

545 
rx_ršg
->
rxbufs
[
wr_idx
].
dma_addr
 = dma_addr;

548 
rx_ršg
->
rxds
[
wr_idx
].
æd
.
»£rved
 = 0;

549 
rx_ršg
->
rxds
[
wr_idx
].
æd
.
m‘a_Ën_dd
 = 0;

550 
	`nå_desc_£t_dma_addr_48b
(&
rx_ršg
->
rxds
[
wr_idx
].
æd
,

551 
dma_addr
 + 
dp
->
rx_dma_off
);

553 
rx_ršg
->
wr_p
++;

554 ià(!(
rx_ršg
->
wr_p
 % 
NFP_NET_FL_BATCH
)) {

558 
	`wmb
();

559 
	`nå_qý_wr_±r_add
(
rx_ršg
->
qý_æ
, 
NFP_NET_FL_BATCH
);

561 
	}
}

568 
	$nå_nfd3_rx_ršg_fžl_ä“li¡
(
nå_Ãt_dp
 *
dp
,

569 
nå_Ãt_rx_ršg
 *
rx_ršg
)

571 
i
;

573 
i
 = 0; i < 
rx_ršg
->
út
 - 1; i++)

574 
	`nå_nfd3_rx_give_Úe
(
dp
, 
rx_ršg
,„x_ršg->
rxbufs
[
i
].
äag
,

575 
rx_ršg
->
rxbufs
[
i
].
dma_addr
);

576 
	}
}

582 
	$nå_nfd3_rx_csum_has_”rÜs
(
u16
 
æags
)

584 
u16
 
csum_®l_checked
, 
csum_®l_ok
;

586 
csum_®l_checked
 = 
æags
 & 
__PCIE_DESC_RX_CSUM_ALL
;

587 
csum_®l_ok
 = 
æags
 & 
__PCIE_DESC_RX_CSUM_ALL_OK
;

589  
csum_®l_checked
 !ð(
csum_®l_ok
 << 
PCIE_DESC_RX_CSUM_OK_SHIFT
);

590 
	}
}

601 
	$nå_nfd3_rx_csum
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

602 
nå_Ãt_rx_desc
 *
rxd
, 
nå_m‘a_·r£d
 *
m‘a
,

603 
sk_buff
 *
skb
)

605 
	`skb_checksum_nÚe_as£¹
(
skb
);

607 ià(!(
dp
->
Ãtdev
->
ã©u»s
 & 
NETIF_F_RXCSUM
))

610 ià(
m‘a
->
csum_ty³
) {

611 
skb
->
_summed
 = 
m‘a
->
csum_ty³
;

612 
skb
->
csum
 = 
m‘a
->csum;

613 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

614 
r_vec
->
hw_csum_rx_com¶‘e
++;

615 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

619 ià(
	`nå_nfd3_rx_csum_has_”rÜs
(
	`Ë16_to_ýu
(
rxd
->rxd.
æags
))) {

620 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

621 
r_vec
->
hw_csum_rx_”rÜ
++;

622 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

630 ià(
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_TCP_CSUM_OK
 ||

631 
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_UDP_CSUM_OK
) {

632 
	`com·t_šü_checksum_uÂeûs§ry
(
skb
, 
çl£
);

633 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

634 
r_vec
->
hw_csum_rx_ok
++;

635 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

638 ià(
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_I_TCP_CSUM_OK
 ||

639 
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_I_UDP_CSUM_OK
) {

640 
	`com·t_šü_checksum_uÂeûs§ry
(
skb
, 
Œue
);

641 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

642 
r_vec
->
hw_csum_rx_šÃr_ok
++;

643 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

645 
	}
}

648 
	$nå_nfd3_£t_hash
(
Ãt_deviû
 *
Ãtdev
, 
nå_m‘a_·r£d
 *
m‘a
,

649 
ty³
, 
__be32
 *
hash
)

651 ià(!(
Ãtdev
->
ã©u»s
 & 
NETIF_F_RXHASH
))

654 
ty³
) {

655 
NFP_NET_RSS_IPV4
:

656 
NFP_NET_RSS_IPV6
:

657 
NFP_NET_RSS_IPV6_EX
:

658 
m‘a
->
hash_ty³
 = 
PKT_HASH_TYPE_L3
;

661 
m‘a
->
hash_ty³
 = 
PKT_HASH_TYPE_L4
;

665 
m‘a
->
hash
 = 
	`g‘_uÇligÃd_be32
(hash);

666 
	}
}

669 
	$nå_nfd3_£t_hash_desc
(
Ãt_deviû
 *
Ãtdev
, 
nå_m‘a_·r£d
 *
m‘a
,

670 *
d©a
, 
nå_Ãt_rx_desc
 *
rxd
)

672 
nå_Ãt_rx_hash
 *
rx_hash
 = 
d©a
;

674 ià(!(
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_RSS
))

677 
	`nå_nfd3_£t_hash
(
Ãtdev
, 
m‘a
, 
	`g‘_uÇligÃd_be32
(&
rx_hash
->
hash_ty³
),

678 &
rx_hash
->
hash
);

679 
	}
}

682 
	$nå_nfd3_·r£_m‘a
(
Ãt_deviû
 *
Ãtdev
, 
nå_m‘a_·r£d
 *
m‘a
,

683 *
d©a
, 
m‘a_Ën
)

685 
u32
 
m‘a_šfo
;

687 
m‘a_šfo
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

688 
d©a
 += 4;

690 
m‘a_šfo
) {

691 
m‘a_šfo
 & 
NFP_NET_META_FIELD_MASK
) {

692 
NFP_NET_META_HASH
:

693 
m‘a_šfo
 >>ð
NFP_NET_META_FIELD_SIZE
;

694 
	`nå_nfd3_£t_hash
(
Ãtdev
, 
m‘a
,

695 
m‘a_šfo
 & 
NFP_NET_META_FIELD_MASK
,

696 (
__be32
 *)
d©a
);

697 
d©a
 += 4;

699 
NFP_NET_META_MARK
:

700 
m‘a
->
m¬k
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

701 
d©a
 += 4;

703 
NFP_NET_META_PORTID
:

704 
m‘a
->
pÜtid
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

705 
d©a
 += 4;

707 
NFP_NET_META_CSUM
:

708 
m‘a
->
csum_ty³
 = 
CHECKSUM_COMPLETE
;

709 
m‘a
->
csum
 =

710 (
__fÜû
 
__wsum
)
	`__g‘_uÇligÃd_ýu32
(
d©a
);

711 
d©a
 += 4;

714  
NULL
;

717 
m‘a_šfo
 >>ð
NFP_NET_META_FIELD_SIZE
;

720  
d©a
;

721 
	}
}

724 
	$nå_nfd3_rx_drÝ
(cÚ¡ 
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

725 
nå_Ãt_rx_ršg
 *
rx_ršg
, 
nå_Ãt_rx_buf
 *
rxbuf
,

726 
sk_buff
 *
skb
)

728 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

729 
r_vec
->
rx_drÝs
++;

733 ià(
skb
 && 
rxbuf
)

734 
r_vec
->
rx_»¶aû_buf_®loc_çž
++;

735 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

740 ià(
skb
 && 
rxbuf
 && skb->
h—d
 =ðrxbuf->
äag
)

741 
	`·ge_»f_šc
(
	`vœt_to_h—d_·ge
(
rxbuf
->
äag
));

742 ià(
rxbuf
)

743 
	`nå_nfd3_rx_give_Úe
(
dp
, 
rx_ršg
, 
rxbuf
->
äag
,„xbuf->
dma_addr
);

744 ià(
skb
)

745 
	`dev_kä“_skb_ªy
(
skb
);

746 
	}
}

748 #ià
COMPAT__HAVE_XDP


749 
boÞ


750 
	$nå_nfd3_tx_xdp_buf
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_rx_ršg
 *
rx_ršg
,

751 
nå_Ãt_tx_ršg
 *
tx_ršg
,

752 
nå_Ãt_rx_buf
 *
rxbuf
, 
dma_off
,

753 
pkt_Ën
, 
boÞ
 *
com¶‘ed
)

755 
nå_nfd3_tx_buf
 *
txbuf
;

756 
nå_nfd3_tx_desc
 *
txd
;

757 
wr_idx
;

759 ià(
	`uÆik–y
(
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 1))) {

760 ià(!*
com¶‘ed
) {

761 
	`nå_nfd3_xdp_com¶‘e
(
tx_ršg
);

762 *
com¶‘ed
 = 
Œue
;

765 ià(
	`uÆik–y
(
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 1))) {

766 
	`nå_nfd3_rx_drÝ
(
dp
, 
rx_ršg
->
r_vec
,„x_ršg, 
rxbuf
,

767 
NULL
);

768  
çl£
;

772 
wr_idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
wr_p
);

775 
txbuf
 = &
tx_ršg
->
txbufs
[
wr_idx
];

777 
	`nå_nfd3_rx_give_Úe
(
dp
, 
rx_ršg
, 
txbuf
->
äag
,xbuf->
dma_addr
);

779 
txbuf
->
äag
 = 
rxbuf
->frag;

780 
txbuf
->
dma_addr
 = 
rxbuf
->dma_addr;

781 
txbuf
->
fidx
 = -1;

782 
txbuf
->
pkt_út
 = 1;

783 
txbuf
->
»®_Ën
 = 
pkt_Ën
;

785 
	`dma_sync_sšgË_fÜ_deviû
(
dp
->
dev
, 
rxbuf
->
dma_addr
 + 
dma_off
,

786 
pkt_Ën
, 
DMA_BIDIRECTIONAL
);

789 
txd
 = &
tx_ršg
->
txds
[
wr_idx
];

790 
txd
->
off£t_eÝ
 = 
NFD3_DESC_TX_EOP
;

791 
txd
->
dma_Ën
 = 
	`ýu_to_Ë16
(
pkt_Ën
);

792 
	`nå_desc_£t_dma_addr_40b
(
txd
, 
rxbuf
->
dma_addr
 + 
dma_off
);

793 
txd
->
d©a_Ën
 = 
	`ýu_to_Ë16
(
pkt_Ën
);

795 
txd
->
æags
 = 0;

796 
txd
->
mss
 = 0;

797 
txd
->
lso_hd¾’
 = 0;

799 
tx_ršg
->
wr_p
++;

800 
tx_ršg
->
wr_±r_add
++;

801  
Œue
;

802 
	}
}

816 
	$nå_nfd3_rx
(
nå_Ãt_rx_ršg
 *
rx_ršg
, 
budg‘
)

818 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
rx_ršg
->r_vec;

819 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

820 
nå_Ãt_tx_ršg
 *
tx_ršg
;

821 
bpf_´og
 *
xdp_´og
;

822 
boÞ
 
xdp_tx_cm¶
 = 
çl£
;

823 
Œue_bufsz
;

824 
sk_buff
 *
skb
;

825 
pkts_pÞËd
 = 0;

826 #ià
COMPAT__HAVE_XDP


827 
xdp_buff
 
xdp
;

829 
idx
;

831 
	`rcu_»ad_lock
();

832 
xdp_´og
 = 
	`READ_ONCE
(
dp
->xdp_prog);

833 
Œue_bufsz
 = 
xdp_´og
 ? 
PAGE_SIZE
 : 
dp
->
æ_bufsz
;

834 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 16, 0)

835 
xdp
.
rxq
 = &
rx_ršg
->
xdp_rxq
;

837 
tx_ršg
 = 
r_vec
->
xdp_ršg
;

839 
pkts_pÞËd
 < 
budg‘
) {

840 
m‘a_Ën
, 
d©a_Ën
, 
m‘a_off
, 
pkt_Ën
, 
pkt_off
;

841 
nå_Ãt_rx_buf
 *
rxbuf
;

842 
nå_Ãt_rx_desc
 *
rxd
;

843 
nå_m‘a_·r£d
 
m‘a
;

844 
Ãt_deviû
 *
Ãtdev
;

845 
dma_addr_t
 
Ãw_dma_addr
;

846 
u32
 
m‘a_Ën_xdp
 = 0;

847 *
Ãw_äag
;

849 
idx
 = 
	`D_IDX
(
rx_ršg
,„x_ršg->
rd_p
);

851 
rxd
 = &
rx_ršg
->
rxds
[
idx
];

852 ià(!(
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_DD
))

858 
	`dma_rmb
();

860 
	`mem£t
(&
m‘a
, 0, (meta));

862 
rx_ršg
->
rd_p
++;

863 
pkts_pÞËd
++;

865 
rxbuf
 = &
rx_ršg
->
rxbufs
[
idx
];

878 
m‘a_Ën
 = 
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_META_LEN_MASK
;

879 
d©a_Ën
 = 
	`Ë16_to_ýu
(
rxd
->rxd.data_len);

880 
pkt_Ën
 = 
d©a_Ën
 - 
m‘a_Ën
;

882 
pkt_off
 = 
NFP_NET_RX_BUF_HEADROOM
 + 
dp
->
rx_dma_off
;

883 ià(
dp
->
rx_off£t
 =ð
NFP_NET_CFG_RX_OFFSET_DYNAMIC
)

884 
pkt_off
 +ð
m‘a_Ën
;

886 
pkt_off
 +ð
dp
->
rx_off£t
;

887 
m‘a_off
 = 
pkt_off
 - 
m‘a_Ën
;

890 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

891 
r_vec
->
rx_pkts
++;

892 
r_vec
->
rx_by‹s
 +ð
pkt_Ën
;

893 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

895 ià(
	`uÆik–y
(
m‘a_Ën
 > 
NFP_NET_MAX_PREPEND
 ||

896 (
dp
->
rx_off£t
 && 
m‘a_Ën
 > dp->rx_offset))) {

897 
	`Â_dp_w¬n
(
dp
, "oversized RX…acket metadata %u\n",

898 
m‘a_Ën
);

899 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

903 
	`nå_Ãt_dma_sync_ýu_rx
(
dp
, 
rxbuf
->
dma_addr
 + 
m‘a_off
,

904 
d©a_Ën
);

906 ià(!
dp
->
chašed_m‘ad©a_fÜm©
) {

907 
	`nå_nfd3_£t_hash_desc
(
dp
->
Ãtdev
, &
m‘a
,

908 
rxbuf
->
äag
 + 
m‘a_off
, 
rxd
);

909 } ià(
m‘a_Ën
) {

910 *
’d
;

912 
’d
 = 
	`nå_nfd3_·r£_m‘a
(
dp
->
Ãtdev
, &
m‘a
,

913 
rxbuf
->
äag
 + 
m‘a_off
,

914 
m‘a_Ën
);

915 ià(
	`uÆik–y
(
’d
 !ð
rxbuf
->
äag
 + 
pkt_off
)) {

916 
	`Â_dp_w¬n
(
dp
, "invalid RX…acket metadata\n");

917 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
,

918 
NULL
);

923 #ià
COMPAT__HAVE_XDP


924 ià(
xdp_´og
 && !
m‘a
.
pÜtid
) {

925 *
Üig_d©a
 = 
rxbuf
->
äag
 + 
pkt_off
;

926 
dma_off
;

927 
aù
;

929 #ià
COMPAT__HAVE_XDP_ADJUST_HEAD


930 
xdp
.
d©a_h¬d_¡¬t
 = 
rxbuf
->
äag
 +

931 
NFP_NET_RX_BUF_HEADROOM
;

933 
xdp
.
d©a
 = 
Üig_d©a
;

934 #ià
COMPAT__HAVE_XDP_METADATA


935 
xdp
.
d©a_m‘a
 = 
Üig_d©a
;

937 
xdp
.
d©a_’d
 = 
Üig_d©a
 + 
pkt_Ën
;

939 
aù
 = 
	`bpf_´og_run_xdp
(
xdp_´og
, &
xdp
);

941 
pkt_Ën
 = 
xdp
.
d©a_’d
 - xdp.
d©a
;

942 
pkt_off
 +ð
xdp
.
d©a
 - 
Üig_d©a
;

944 
aù
) {

945 
XDP_PASS
:

946 #ià
COMPAT__HAVE_XDP_METADATA


947 
m‘a_Ën_xdp
 = 
xdp
.
d©a
 - xdp.
d©a_m‘a
;

950 
XDP_TX
:

951 
dma_off
 = 
pkt_off
 - 
NFP_NET_RX_BUF_HEADROOM
;

952 ià(
	`uÆik–y
(!
	`nå_nfd3_tx_xdp_buf
(
dp
, 
rx_ršg
,

953 
tx_ršg
,

954 
rxbuf
,

955 
dma_off
,

956 
pkt_Ën
,

957 &
xdp_tx_cm¶
)))

958 
	`Œaû_xdp_exû±iÚ
(
dp
->
Ãtdev
,

959 
xdp_´og
, 
aù
);

962 
	`bpf_w¬n_šv®id_xdp_aùiÚ
(
aù
);

964 
XDP_ABORTED
:

965 
	`Œaû_xdp_exû±iÚ
(
dp
->
Ãtdev
, 
xdp_´og
, 
aù
);

967 
XDP_DROP
:

968 
	`nå_nfd3_rx_give_Úe
(
dp
, 
rx_ršg
, 
rxbuf
->
äag
,

969 
rxbuf
->
dma_addr
);

974 
xdp_tx_cm¶
 = xdp_tx_cmpl;

977 ià(
	`lik–y
(!
m‘a
.
pÜtid
)) {

978 
Ãtdev
 = 
dp
->netdev;

979 } ià(
m‘a
.
pÜtid
 =ð
NFP_META_PORT_ID_CTRL
) {

980 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
dp
->
Ãtdev
);

982 
	`nå_­p_ù¾_rx_¿w
(
Â
->
­p
, 
rxbuf
->
äag
 + 
pkt_off
,

983 
pkt_Ën
);

984 
	`nå_nfd3_rx_give_Úe
(
dp
, 
rx_ršg
, 
rxbuf
->
äag
,

985 
rxbuf
->
dma_addr
);

988 
nå_Ãt
 *
Â
;

990 
Â
 = 
	`Ãtdev_´iv
(
dp
->
Ãtdev
);

991 
Ãtdev
 = 
	`nå_­p_»´_g‘
(
Â
->
­p
, 
m‘a
.
pÜtid
);

992 ià(
	`uÆik–y
(!
Ãtdev
)) {

993 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
,

994 
NULL
);

997 
	`nå_»´_šc_rx_¡©s
(
Ãtdev
, 
pkt_Ën
);

1000 
skb
 = 
	`bužd_skb
(
rxbuf
->
äag
, 
Œue_bufsz
);

1001 ià(
	`uÆik–y
(!
skb
)) {

1002 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

1005 
Ãw_äag
 = 
	`nå_nfd3_Çpi_®loc_Úe
(
dp
, &
Ãw_dma_addr
);

1006 ià(
	`uÆik–y
(!
Ãw_äag
)) {

1007 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
skb
);

1011 
	`nå_Ãt_dma_unm­_rx
(
dp
, 
rxbuf
->
dma_addr
);

1013 
	`nå_nfd3_rx_give_Úe
(
dp
, 
rx_ršg
, 
Ãw_äag
, 
Ãw_dma_addr
);

1015 
	`skb_»£rve
(
skb
, 
pkt_off
);

1016 
	`skb_put
(
skb
, 
pkt_Ën
);

1018 
skb
->
m¬k
 = 
m‘a
.mark;

1019 
	`skb_£t_hash
(
skb
, 
m‘a
.
hash
, m‘a.
hash_ty³
);

1021 
	`skb_»cÜd_rx_queue
(
skb
, 
rx_ršg
->
idx
);

1022 
skb
->
´ÙocÞ
 = 
	`‘h_ty³_Œªs
(skb, 
Ãtdev
);

1024 
	`nå_nfd3_rx_csum
(
dp
, 
r_vec
, 
rxd
, &
m‘a
, 
skb
);

1026 ià(
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_VLAN
)

1027 
	`__vÏn_hwacûl_put_g
(
skb
, 
	`htÚs
(
ETH_P_8021Q
),

1028 
	`Ë16_to_ýu
(
rxd
->rxd.
vÏn
));

1029 ià(
m‘a_Ën_xdp
)

1030 
	`skb_m‘ad©a_£t
(
skb
, 
m‘a_Ën_xdp
);

1032 
	`Çpi_gro_»ûive
(&
rx_ršg
->
r_vec
->
Çpi
, 
skb
);

1035 ià(
xdp_´og
) {

1036 ià(
tx_ršg
->
wr_±r_add
)

1037 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

1038 ià(
	`uÆik–y
(
tx_ršg
->
wr_p
 !ðtx_ršg->
rd_p
) &&

1039 !
xdp_tx_cm¶
)

1040 ià(!
	`nå_nfd3_xdp_com¶‘e
(
tx_ršg
))

1041 
pkts_pÞËd
 = 
budg‘
;

1043 
	`rcu_»ad_uÆock
();

1045  
pkts_pÞËd
;

1046 
	}
}

1055 
	$nå_nfd3_pÞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

1057 
nå_Ãt_r_veùÜ
 *
r_vec
 =

1058 
	`cÚš”_of
(
Çpi
, 
nå_Ãt_r_veùÜ
,‚api);

1059 
pkts_pÞËd
 = 0;

1061 ià(
r_vec
->
tx_ršg
)

1062 
	`nå_nfd3_tx_com¶‘e
(
r_vec
->
tx_ršg
, 
budg‘
);

1063 ià(
r_vec
->
rx_ršg
)

1064 
pkts_pÞËd
 = 
	`nå_nfd3_rx
(
r_vec
->
rx_ršg
, 
budg‘
);

1066 ià(
pkts_pÞËd
 < 
budg‘
)

1067 ià(
	`Çpi_com¶‘e_dÚe
(
Çpi
, 
pkts_pÞËd
))

1068 
	`nå_Ãt_œq_unmask
(
r_vec
->
nå_Ãt
,„_vec->
œq_’Œy
);

1070  
pkts_pÞËd
;

1071 
	}
}

1073 #ifdeà
CONFIG_NFP_NET_PF


1077 
boÞ


1078 
	$nå_ù¾_tx_Úe
(
nå_Ãt
 *
Â
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

1079 
sk_buff
 *
skb
, 
boÞ
 
Þd
)

1081 
»®_Ën
 = 
skb
->
Ën
, 
m‘a_Ën
 = 0;

1082 
nå_Ãt_tx_ršg
 *
tx_ršg
;

1083 
nå_nfd3_tx_buf
 *
txbuf
;

1084 
nå_nfd3_tx_desc
 *
txd
;

1085 
nå_Ãt_dp
 *
dp
;

1086 
dma_addr_t
 
dma_addr
;

1087 
wr_idx
;

1089 
dp
 = &
r_vec
->
nå_Ãt
->dp;

1090 
tx_ršg
 = 
r_vec
->tx_ring;

1092 ià(
	`WARN_ON_ONCE
(
	`skb_shšfo
(
skb
)->
Ä_äags
)) {

1093 
	`Â_dp_w¬n
(
dp
, "Driver's CTRL TX does‚ot implement gather\n");

1094 
”r_ä“
;

1097 ià(
	`uÆik–y
(
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 1))) {

1098 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

1099 
r_vec
->
tx_busy
++;

1100 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

1101 ià(!
Þd
)

1102 
	`__skb_queue_ž
(&
r_vec
->
queue
, 
skb
);

1104 
	`__skb_queue_h—d
(&
r_vec
->
queue
, 
skb
);

1105  
Œue
;

1108 ià(
	`nå_­p_ù¾_has_m‘a
(
Â
->
­p
)) {

1109 ià(
	`uÆik–y
(
	`skb_h—droom
(
skb
) < 8)) {

1110 
	`Â_dp_w¬n
(
dp
, "CTRL TX on skb without headroom\n");

1111 
”r_ä“
;

1113 
m‘a_Ën
 = 8;

1114 
	`put_uÇligÃd_be32
(
NFP_META_PORT_ID_CTRL
, 
	`skb_push
(
skb
, 4));

1115 
	`put_uÇligÃd_be32
(
NFP_NET_META_PORTID
, 
	`skb_push
(
skb
, 4));

1119 
dma_addr
 = 
	`dma_m­_sšgË
(
dp
->
dev
, 
skb
->
d©a
, 
	`skb_h—dËn
(skb),

1120 
DMA_TO_DEVICE
);

1121 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, 
dma_addr
))

1122 
”r_dma_w¬n
;

1124 
wr_idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
wr_p
);

1127 
txbuf
 = &
tx_ršg
->
txbufs
[
wr_idx
];

1128 
txbuf
->
skb
 = skb;

1129 
txbuf
->
dma_addr
 = dma_addr;

1130 
txbuf
->
fidx
 = -1;

1131 
txbuf
->
pkt_út
 = 1;

1132 
txbuf
->
»®_Ën
 =„eal_len;

1135 
txd
 = &
tx_ršg
->
txds
[
wr_idx
];

1136 
txd
->
off£t_eÝ
 = 
m‘a_Ën
 | 
NFD3_DESC_TX_EOP
;

1137 
txd
->
dma_Ën
 = 
	`ýu_to_Ë16
(
	`skb_h—dËn
(
skb
));

1138 
	`nå_desc_£t_dma_addr_40b
(
txd
, 
dma_addr
);

1139 
txd
->
d©a_Ën
 = 
	`ýu_to_Ë16
(
skb
->
Ën
);

1141 
txd
->
æags
 = 0;

1142 
txd
->
mss
 = 0;

1143 
txd
->
lso_hd¾’
 = 0;

1145 
tx_ršg
->
wr_p
++;

1146 
tx_ršg
->
wr_±r_add
++;

1147 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

1149  
çl£
;

1151 
”r_dma_w¬n
:

1152 
	`Â_dp_w¬n
(
dp
, "Failedo DMA map TX CTRL buffer\n");

1153 
”r_ä“
:

1154 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

1155 
r_vec
->
tx_”rÜs
++;

1156 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

1157 
	`dev_kä“_skb_ªy
(
skb
);

1158  
çl£
;

1159 
	}
}

1161 
boÞ
 
	$__nå_nfd3_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
)

1163 
nå_Ãt_r_veùÜ
 *
r_vec
 = &
Â
->
r_vecs
[0];

1165  
	`nå_ù¾_tx_Úe
(
Â
, 
r_vec
, 
skb
, 
çl£
);

1166 
	}
}

1168 
boÞ
 
	$nå_nfd3_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
)

1170 
nå_Ãt_r_veùÜ
 *
r_vec
 = &
Â
->
r_vecs
[0];

1171 
boÞ
 
»t
;

1173 
	`¥š_lock_bh
(&
r_vec
->
lock
);

1174 
»t
 = 
	`nå_ù¾_tx_Úe
(
Â
, 
r_vec
, 
skb
, 
çl£
);

1175 
	`¥š_uÆock_bh
(&
r_vec
->
lock
);

1177  
»t
;

1178 
	}
}

1180 
	$__nå_ù¾_tx_queued
(
nå_Ãt_r_veùÜ
 *
r_vec
)

1182 
sk_buff
 *
skb
;

1184 (
skb
 = 
	`__skb_dequeue
(&
r_vec
->
queue
)))

1185 ià(
	`nå_ù¾_tx_Úe
(
r_vec
->
nå_Ãt
,„_vec, 
skb
, 
Œue
))

1187 
	}
}

1189 
boÞ


1190 
	$nå_ù¾_m‘a_ok
(
nå_Ãt
 *
Â
, *
d©a
, 
m‘a_Ën
)

1192 
u32
 
m‘a_ty³
, 
m‘a_g
;

1194 ià(!
	`nå_­p_ù¾_has_m‘a
(
Â
->
­p
))

1195  !
m‘a_Ën
;

1197 ià(
m‘a_Ën
 != 8)

1198  
çl£
;

1200 
m‘a_ty³
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

1201 
m‘a_g
 = 
	`g‘_uÇligÃd_be32
(
d©a
 + 4);

1203  (
m‘a_ty³
 =ð
NFP_NET_META_PORTID
 &&

1204 
m‘a_g
 =ð
NFP_META_PORT_ID_CTRL
);

1205 
	}
}

1207 
boÞ


1208 
	$nå_ù¾_rx_Úe
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
,

1209 
nå_Ãt_r_veùÜ
 *
r_vec
, 
nå_Ãt_rx_ršg
 *
rx_ršg
)

1211 
m‘a_Ën
, 
d©a_Ën
, 
m‘a_off
, 
pkt_Ën
, 
pkt_off
;

1212 
nå_Ãt_rx_buf
 *
rxbuf
;

1213 
nå_Ãt_rx_desc
 *
rxd
;

1214 
dma_addr_t
 
Ãw_dma_addr
;

1215 
sk_buff
 *
skb
;

1216 *
Ãw_äag
;

1217 
idx
;

1219 
idx
 = 
	`D_IDX
(
rx_ršg
,„x_ršg->
rd_p
);

1221 
rxd
 = &
rx_ršg
->
rxds
[
idx
];

1222 ià(!(
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_DD
))

1223  
çl£
;

1228 
	`dma_rmb
();

1230 
rx_ršg
->
rd_p
++;

1232 
rxbuf
 = &
rx_ršg
->
rxbufs
[
idx
];

1233 
m‘a_Ën
 = 
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_META_LEN_MASK
;

1234 
d©a_Ën
 = 
	`Ë16_to_ýu
(
rxd
->rxd.data_len);

1235 
pkt_Ën
 = 
d©a_Ën
 - 
m‘a_Ën
;

1237 
pkt_off
 = 
NFP_NET_RX_BUF_HEADROOM
 + 
dp
->
rx_dma_off
;

1238 ià(
dp
->
rx_off£t
 =ð
NFP_NET_CFG_RX_OFFSET_DYNAMIC
)

1239 
pkt_off
 +ð
m‘a_Ën
;

1241 
pkt_off
 +ð
dp
->
rx_off£t
;

1242 
m‘a_off
 = 
pkt_off
 - 
m‘a_Ën
;

1245 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

1246 
r_vec
->
rx_pkts
++;

1247 
r_vec
->
rx_by‹s
 +ð
pkt_Ën
;

1248 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

1250 
	`nå_Ãt_dma_sync_ýu_rx
(
dp
, 
rxbuf
->
dma_addr
 + 
m‘a_off
, 
d©a_Ën
);

1252 ià(
	`uÆik–y
(!
	`nå_ù¾_m‘a_ok
(
Â
, 
rxbuf
->
äag
 + 
m‘a_off
, 
m‘a_Ën
))) {

1253 
	`Â_dp_w¬n
(
dp
, "incorrect metadata for ctrl…acket (%d)\n",

1254 
m‘a_Ën
);

1255 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

1256  
Œue
;

1259 
skb
 = 
	`bužd_skb
(
rxbuf
->
äag
, 
dp
->
æ_bufsz
);

1260 ià(
	`uÆik–y
(!
skb
)) {

1261 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

1262  
Œue
;

1264 
Ãw_äag
 = 
	`nå_nfd3_Çpi_®loc_Úe
(
dp
, &
Ãw_dma_addr
);

1265 ià(
	`uÆik–y
(!
Ãw_äag
)) {

1266 
	`nå_nfd3_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
skb
);

1267  
Œue
;

1270 
	`nå_Ãt_dma_unm­_rx
(
dp
, 
rxbuf
->
dma_addr
);

1272 
	`nå_nfd3_rx_give_Úe
(
dp
, 
rx_ršg
, 
Ãw_äag
, 
Ãw_dma_addr
);

1274 
	`skb_»£rve
(
skb
, 
pkt_off
);

1275 
	`skb_put
(
skb
, 
pkt_Ën
);

1277 
	`nå_­p_ù¾_rx
(
Â
->
­p
, 
skb
);

1279  
Œue
;

1280 
	}
}

1282 
boÞ
 
	$nå_ù¾_rx
(
nå_Ãt_r_veùÜ
 *
r_vec
)

1284 
nå_Ãt_rx_ršg
 *
rx_ršg
 = 
r_vec
->rx_ring;

1285 
nå_Ãt
 *
Â
 = 
r_vec
->nfp_net;

1286 
nå_Ãt_dp
 *
dp
 = &
Â
->dp;

1287 
budg‘
 = 512;

1289 
	`nå_ù¾_rx_Úe
(
Â
, 
dp
, 
r_vec
, 
rx_ršg
è&& 
budg‘
--)

1292  
budg‘
;

1293 
	}
}

1296 
	$nå_nfd3_ù¾_pÞl
(
¬g
)

1298 #ifdeà
CONFIG_NFP_NET_PF


1299 
nå_Ãt_r_veùÜ
 *
r_vec
 = (*)
¬g
;

1301 
	`¥š_lock
(&
r_vec
->
lock
);

1302 
	`nå_nfd3_tx_com¶‘e
(
r_vec
->
tx_ršg
, 0);

1303 
	`__nå_ù¾_tx_queued
(
r_vec
);

1304 
	`¥š_uÆock
(&
r_vec
->
lock
);

1306 ià(
	`nå_ù¾_rx
(
r_vec
)) {

1307 
	`nå_Ãt_œq_unmask
(
r_vec
->
nå_Ãt
,„_vec->
œq_’Œy
);

1309 
	`skËt_scheduË
(&
r_vec
->
skËt
);

1310 
	`Â_dp_w¬n
(&
r_vec
->
nå_Ãt
->
dp
,

1314 
	}
}

	@src/nfd3/nfd3.h

4 #iâdeà
_NFP_DP_NFD3_H_


5 
	#_NFP_DP_NFD3_H_


	)

7 
	gsk_buff
;

8 
	gÃt_deviû
;

12 
	#NFD3_DESC_TX_EOP
 
	`BIT
(7)

	)

13 
	#NFD3_DESC_TX_OFFSET_MASK
 
	`GENMASK
(6, 0)

	)

14 
	#NFD3_DESC_TX_MSS_MASK
 
	`GENMASK
(13, 0)

	)

17 
	#NFD3_DESC_TX_CSUM
 
	`BIT
(7)

	)

18 
	#NFD3_DESC_TX_IP4_CSUM
 
	`BIT
(6)

	)

19 
	#NFD3_DESC_TX_TCP_CSUM
 
	`BIT
(5)

	)

20 
	#NFD3_DESC_TX_UDP_CSUM
 
	`BIT
(4)

	)

21 
	#NFD3_DESC_TX_VLAN
 
	`BIT
(3)

	)

22 
	#NFD3_DESC_TX_LSO
 
	`BIT
(2)

	)

23 
	#NFD3_DESC_TX_ENCAP
 
	`BIT
(1)

	)

24 
	#NFD3_DESC_TX_O_IP4_CSUM
 
	`BIT
(0)

	)

26 
	snå_nfd3_tx_desc
 {

29 
u8
 
	mdma_addr_hi
;

30 
__Ë16
 
	mdma_Ën
;

31 
u8
 
	moff£t_eÝ
;

34 
__Ë32
 
	mdma_addr_lo
;

36 
__Ë16
 
	mmss
;

37 
u8
 
	mlso_hd¾’
;

38 
u8
 
	mæags
;

41 
u8
 
	ml3_off£t
;

42 
u8
 
	ml4_off£t
;

44 
__Ë16
 
	mvÏn
;

46 
__Ë16
 
	md©a_Ën
;

47 } 
	m__·cked
;

48 
__Ë32
 
	mv®s
[4];

49 
__Ë64
 
	mv®s8
[2];

65 
	snå_nfd3_tx_buf
 {

67 
sk_buff
 *
	mskb
;

68 *
	mäag
;

70 
dma_addr_t
 
	mdma_addr
;

71 
	mfidx
;

72 
u16
 
	mpkt_út
;

73 
u32
 
	m»®_Ën
;

76 
nå_nfd3_pÞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
);

77 
nå_nfd3_ù¾_pÞl
(
¬g
);

78 
nå_nfd3_rx_ršg_fžl_ä“li¡
(
nå_Ãt_dp
 *
dp
,

79 
nå_Ãt_rx_ršg
 *
rx_ršg
);

	@src/nfd3/rings.c

4 
	~"../nå_Ãt_com·t.h
"

6 
	~<lšux/£q_fže.h
>

8 
	~"../nå_Ãt.h
"

9 
	~"../nå_Ãt_dp.h
"

10 
	~"nfd3.h
"

20 
	$nå_nfd3_tx_ršg_»£t
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_tx_ršg
 *
tx_ršg
)

22 cÚ¡ 
skb_äag_¡ruù
 *
äag
;

23 
Ãtdev_queue
 *
nd_q
;

25 !
tx_ršg
->
is_xdp
 &&x_ršg->
rd_p
 !ðtx_ršg->
wr_p
) {

26 
nå_nfd3_tx_buf
 *
tx_buf
;

27 
sk_buff
 *
skb
;

28 
idx
, 
Ä_äags
;

30 
idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
rd_p
);

31 
tx_buf
 = &
tx_ršg
->
txbufs
[
idx
];

33 
skb
 = 
tx_ršg
->
txbufs
[
idx
].skb;

34 
Ä_äags
 = 
	`skb_shšfo
(
skb
)->nr_frags;

36 ià(
tx_buf
->
fidx
 == -1) {

38 
	`dma_unm­_sšgË
(
dp
->
dev
, 
tx_buf
->
dma_addr
,

39 
	`skb_h—dËn
(
skb
), 
DMA_TO_DEVICE
);

42 
äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
tx_buf
->
fidx
];

43 
	`dma_unm­_·ge
(
dp
->
dev
, 
tx_buf
->
dma_addr
,

44 
	`skb_äag_size
(
äag
), 
DMA_TO_DEVICE
);

48 ià(
tx_buf
->
fidx
 =ð
Ä_äags
 - 1)

49 
	`dev_kä“_skb_ªy
(
skb
);

51 
tx_buf
->
dma_addr
 = 0;

52 
tx_buf
->
skb
 = 
NULL
;

53 
tx_buf
->
fidx
 = -2;

55 
tx_ršg
->
qý_rd_p
++;

56 
tx_ršg
->
rd_p
++;

59 
	`mem£t
(
tx_ršg
->
txds
, 0,x_ršg->
size
);

60 
tx_ršg
->
wr_p
 = 0;

61 
tx_ršg
->
rd_p
 = 0;

62 
tx_ršg
->
qý_rd_p
 = 0;

63 
tx_ršg
->
wr_±r_add
 = 0;

65 ià(
tx_ršg
->
is_xdp
 || !
dp
->
Ãtdev
)

68 
nd_q
 = 
	`Ãtdev_g‘_tx_queue
(
dp
->
Ãtdev
, 
tx_ršg
->
idx
);

69 
	`Ãtdev_tx_»£t_queue
(
nd_q
);

70 
	}
}

76 
	$nå_nfd3_tx_ršg_ä“
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

78 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
tx_ršg
->r_vec;

79 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

81 
	`kvä“
(
tx_ršg
->
txbufs
);

83 ià(
tx_ršg
->
txds
)

84 
	`dma_ä“_coh”’t
(
dp
->
dev
, 
tx_ršg
->
size
,

85 
tx_ršg
->
txds
,x_ršg->
dma
);

87 
tx_ršg
->
út
 = 0;

88 
tx_ršg
->
txbufs
 = 
NULL
;

89 
tx_ršg
->
txds
 = 
NULL
;

90 
tx_ršg
->
dma
 = 0;

91 
tx_ršg
->
size
 = 0;

92 
	}
}

102 
	$nå_nfd3_tx_ršg_®loc
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_tx_ršg
 *
tx_ršg
)

104 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
tx_ršg
->r_vec;

106 
tx_ršg
->
út
 = 
dp
->
txd_út
;

108 
tx_ršg
->
size
 = 
	`¬¿y_size
Ñx_ršg->
út
, (*tx_ršg->
txds
));

109 
tx_ršg
->
txds
 = 
	`dma_z®loc_coh”’t
(
dp
->
dev
,x_ršg->
size
,

110 &
tx_ršg
->
dma
,

111 
GFP_KERNEL
 | 
__GFP_NOWARN
);

112 ià(!
tx_ršg
->
txds
) {

113 
	`Ãtdev_w¬n
(
dp
->
Ãtdev
, "failedo‡llocate TX descriptor„ing memory,„equested descriptor count: %d, consider†owering descriptor count\n",

114 
tx_ršg
->
út
);

115 
”r_®loc
;

118 
tx_ršg
->
txbufs
 = 
	`kvÿÎoc
Ñx_ršg->
út
, (*tx_ring->txbufs),

119 
GFP_KERNEL
);

120 ià(!
tx_ršg
->
txbufs
)

121 
”r_®loc
;

123 ià(!
tx_ršg
->
is_xdp
 && 
dp
->
Ãtdev
)

124 
	`Ãtif_£t_xps_queue
(
dp
->
Ãtdev
, &
r_vec
->
affš™y_mask
,

125 
tx_ršg
->
idx
);

129 
”r_®loc
:

130 
	`nå_nfd3_tx_ršg_ä“
(
tx_ršg
);

131  -
ENOMEM
;

132 
	}
}

135 
	$nå_nfd3_tx_ršg_bufs_ä“
(
nå_Ãt_dp
 *
dp
,

136 
nå_Ãt_tx_ršg
 *
tx_ršg
)

138 
i
;

140 ià(!
tx_ršg
->
is_xdp
)

143 
i
 = 0; i < 
tx_ršg
->
út
; i++) {

144 ià(!
tx_ršg
->
txbufs
[
i
].
äag
)

147 
	`nå_Ãt_dma_unm­_rx
(
dp
, 
tx_ršg
->
txbufs
[
i
].
dma_addr
);

148 
	`__ä“_·ge
(
	`vœt_to_·ge
(
tx_ršg
->
txbufs
[
i
].
äag
));

150 
	}
}

153 
	$nå_nfd3_tx_ršg_bufs_®loc
(
nå_Ãt_dp
 *
dp
,

154 
nå_Ãt_tx_ršg
 *
tx_ršg
)

156 
nå_nfd3_tx_buf
 *
txbufs
 = 
tx_ršg
->txbufs;

157 
i
;

159 ià(!
tx_ršg
->
is_xdp
)

162 
i
 = 0; i < 
tx_ršg
->
út
; i++) {

163 
txbufs
[
i
].
äag
 = 
	`nå_Ãt_rx_®loc_Úe
(
dp
, &txbufs[i].
dma_addr
);

164 ià(!
txbufs
[
i
].
äag
) {

165 
	`nå_nfd3_tx_ršg_bufs_ä“
(
dp
, 
tx_ršg
);

166  -
ENOMEM
;

171 
	}
}

174 
	$nå_nfd3_´št_tx_descs
(
£q_fže
 *
fže
,

175 
nå_Ãt_r_veùÜ
 *
r_vec
,

176 
nå_Ãt_tx_ršg
 *
tx_ršg
,

177 
u32
 
d_rd_p
, u32 
d_wr_p
)

179 
nå_nfd3_tx_desc
 *
txd
;

180 
u32
 
txd_út
 = 
tx_ršg
->
út
;

181 
i
;

184 
i
 = 0; i < 
txd_út
; i++) {

185 
txd
 = &
tx_ršg
->
txds
[
i
];

187 
	`£q_´štf
(
fže
, "%04d: 0x%08x 0x%08x 0x%08x 0x%08x", 
i
,

188 
txd
->
v®s
[0],xd->vals[1],

189 
txd
->
v®s
[2],xd->vals[3]);

191 ià(
tx_ršg
 =ð
r_vec
->tx_ring) {

192 
sk_buff
 *
skb
 = 
	`READ_ONCE
(
tx_ršg
->
txbufs
[
i
].skb);

194 ià(
skb
)

195 
	`£q_´štf
(
fže
, " skb->head=%p skb->data=%p",

196 
skb
->
h—d
, skb->
d©a
);

198 
	`£q_´štf
(
fže
, " frag=%p",

199 
	`READ_ONCE
(
tx_ršg
->
txbufs
[
i
].
äag
));

202 ià(
tx_ršg
->
txbufs
[
i
].
dma_addr
)

203 
	`£q_´štf
(
fže
, " dma_addr=%pad",

204 &
tx_ršg
->
txbufs
[
i
].
dma_addr
);

206 ià(
i
 =ð
tx_ršg
->
rd_p
 % 
txd_út
)

207 
	`£q_puts
(
fže
, " H_RD");

208 ià(
i
 =ð
tx_ršg
->
wr_p
 % 
txd_út
)

209 
	`£q_puts
(
fže
, " H_WR");

210 ià(
i
 =ð
d_rd_p
 % 
txd_út
)

211 
	`£q_puts
(
fže
, " D_RD");

212 ià(
i
 =ð
d_wr_p
 % 
txd_út
)

213 
	`£q_puts
(
fže
, " D_WR");

215 
	`£q_putc
(
fže
, '\n');

217 
	}
}

219 
	#NFP_NFD3_CFG_CTRL_SUPPORTED
 \

220 (
NFP_NET_CFG_CTRL_ENABLE
 | 
NFP_NET_CFG_CTRL_PROMISC
 | \

221 
NFP_NET_CFG_CTRL_L2BC
 | 
NFP_NET_CFG_CTRL_L2MC
 | \

222 
NFP_NET_CFG_CTRL_RXCSUM
 | 
NFP_NET_CFG_CTRL_TXCSUM
 | \

223 
NFP_NET_CFG_CTRL_RXVLAN
 | 
NFP_NET_CFG_CTRL_TXVLAN
 | \

224 
NFP_NET_CFG_CTRL_GATHER
 | 
NFP_NET_CFG_CTRL_LSO
 | \

225 
NFP_NET_CFG_CTRL_CTAG_FILTER
 | 
NFP_NET_CFG_CTRL_CMSG_DATA
 | \

226 
NFP_NET_CFG_CTRL_RINGCFG
 | 
NFP_NET_CFG_CTRL_RSS
 | \

227 
NFP_NET_CFG_CTRL_IRQMOD
 | 
NFP_NET_CFG_CTRL_TXRWB
 | \

228 
NFP_NET_CFG_CTRL_VXLAN
 | 
NFP_NET_CFG_CTRL_NVGRE
 | \

229 
NFP_NET_CFG_CTRL_BPF
 | 
NFP_NET_CFG_CTRL_LSO2
 | \

230 
NFP_NET_CFG_CTRL_RSS2
 | 
NFP_NET_CFG_CTRL_CSUM_COMPLETE
 | \

231 
NFP_NET_CFG_CTRL_LIVE_ADDR
)

	)

233 cÚ¡ 
nå_dp_Ýs
 
	gnå_nfd3_Ýs
 = {

234 .
v”siÚ
 = 
NFP_NFD_VER_NFD3
,

235 .
	gtx_mš_desc_³r_pkt
 = 1,

236 .
	gÿp_mask
 = 
NFP_NFD3_CFG_CTRL_SUPPORTED
,

237 .
	gpÞl
 = 
nå_nfd3_pÞl
,

238 .
	gù¾_pÞl
 = 
nå_nfd3_ù¾_pÞl
,

239 .
	grx_ršg_fžl_ä“li¡
 = 
nå_nfd3_rx_ršg_fžl_ä“li¡
,

240 .
	gtx_ršg_®loc
 = 
nå_nfd3_tx_ršg_®loc
,

241 .
	gtx_ršg_»£t
 = 
nå_nfd3_tx_ršg_»£t
,

242 .
	gtx_ršg_ä“
 = 
nå_nfd3_tx_ršg_ä“
,

243 .
	gtx_ršg_bufs_®loc
 = 
nå_nfd3_tx_ršg_bufs_®loc
,

244 .
	gtx_ršg_bufs_ä“
 = 
nå_nfd3_tx_ršg_bufs_ä“
,

245 .
	g´št_tx_descs
 = 
nå_nfd3_´št_tx_descs


	@src/nfdk/dp.c

4 
	~"nå_Ãt_com·t.h
"

6 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 11, 0)

7 
	~<lšux/bpf_Œaû.h
>

9 
	~<lšux/Ãtdeviû.h
>

10 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 18, 0)

11 
	~<lšux/ov”æow.h
>

13 
	~<lšux/sizes.h
>

15 
	~"../nå_­p.h
"

16 
	~"../nå_Ãt.h
"

17 
	~"../nå_Ãt_dp.h
"

18 
	~"nfdk.h
"

20 
	$nå_nfdk_tx_ršg_should_wake
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

22  !
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 
NFDK_TX_DESC_STOP_CNT
 * 2);

23 
	}
}

25 
	$nå_nfdk_tx_ršg_should_¡Ý
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

27  
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 
NFDK_TX_DESC_STOP_CNT
);

28 
	}
}

30 
	$nå_nfdk_tx_ršg_¡Ý
(
Ãtdev_queue
 *
nd_q
,

31 
nå_Ãt_tx_ršg
 *
tx_ršg
)

33 
	`Ãtif_tx_¡Ý_queue
(
nd_q
);

36 
	`smp_mb
();

37 ià(
	`uÆik–y
(
	`nå_nfdk_tx_ršg_should_wake
(
tx_ršg
)))

38 
	`Ãtif_tx_¡¬t_queue
(
nd_q
);

39 
	}
}

41 
__Ë64


42 
	$nå_nfdk_tx_tso
(
nå_Ãt_r_veùÜ
 *
r_vec
, 
nå_nfdk_tx_buf
 *
txbuf
,

43 
sk_buff
 *
skb
)

45 
nå_nfdk_tx_desc
 
txd
;

46 
u32
 
£gs
, 
hd¾’
, 
l3_off£t
, 
l4_off£t
;

47 
u16
 
mss
;

49 ià(!
skb
->
’ÿpsuÏtiÚ
) {

50 
l3_off£t
 = 
	`skb_ÃtwÜk_off£t
(
skb
);

51 
l4_off£t
 = 
	`skb_Œª¥Üt_off£t
(
skb
);

52 
hd¾’
 = 
	`skb_Œª¥Üt_off£t
(
skb
è+ 
	`tý_hd¾’
(skb);

54 
l3_off£t
 = 
	`skb_šÃr_ÃtwÜk_off£t
(
skb
);

55 
l4_off£t
 = 
	`skb_šÃr_Œª¥Üt_off£t
(
skb
);

56 
hd¾’
 = 
	`skb_šÃr_Œª¥Üt_h—d”
(
skb
è- skb->
d©a
 +

57 
	`šÃr_tý_hd¾’
(
skb
);

60 
£gs
 = 
	`skb_shšfo
(
skb
)->
gso_£gs
;

61 
mss
 = 
	`skb_shšfo
(
skb
)->
gso_size
 & 
NFDK_DESC_TX_MSS_MASK
;

70 
txd
.
l3_off£t
 =†3_offset;

71 
txd
.
l4_off£t
 =†4_offset;

72 
txd
.
lso_m‘a_»s
 = 0;

73 
txd
.
mss
 = 
	`ýu_to_Ë16
(mss);

74 
txd
.
lso_hd¾’
 = 
hd¾’
;

75 
txd
.
lso_tÙ£gs
 = 
£gs
;

77 
txbuf
->
pkt_út
 = 
£gs
;

78 
txbuf
->
»®_Ën
 = 
skb
->
Ën
 + 
hd¾’
 * (txbuf->
pkt_út
 - 1);

80 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

81 
r_vec
->
tx_lso
++;

82 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

84  
txd
.
¿w
;

85 
	}
}

87 
u8


88 
	$nå_nfdk_tx_csum
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

89 
pkt_út
, 
sk_buff
 *
skb
, 
u64
 
æags
)

91 ià(!(
dp
->
ù¾
 & 
NFP_NET_CFG_CTRL_TXCSUM
))

92  
æags
;

94 ià(
skb
->
_summed
 !ð
CHECKSUM_PARTIAL
)

95  
æags
;

97 
æags
 |ð
NFDK_DESC_TX_L4_CSUM
;

99 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

100 ià(!
skb
->
’ÿpsuÏtiÚ
) {

101 
r_vec
->
hw_csum_tx
 +ð
pkt_út
;

103 
æags
 |ð
NFDK_DESC_TX_ENCAP
;

104 
r_vec
->
hw_csum_tx_šÃr
 +ð
pkt_út
;

106 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

108  
æags
;

109 
	}
}

112 
	$nå_nfdk_tx_maybe_þo£_block
(
nå_Ãt_tx_ršg
 *
tx_ršg
,

113 
Ä_äags
, 
sk_buff
 *
skb
)

115 cÚ¡ 
skb_äag_¡ruù
 *
äag
, *
ãnd
;

116 
n_descs
, 
wr_p
, 
nÝ_¦Ùs
;

117 
nå_nfdk_tx_desc
 *
txd
;

118 
wr_idx
;

119 
”r
;

121 
»couÁ_descs
:

122 
n_descs
 = 
	`nå_nfdk_h—dËn_to_£gs
(
	`skb_h—dËn
(
skb
));

124 
äag
 = 
	`skb_shšfo
(
skb
)->
äags
;

125 
ãnd
 = 
äag
 + 
Ä_äags
;

126 ; 
äag
 < 
ãnd
; frag++)

127 
n_descs
 +ð
	`DIV_ROUND_UP
(
	`skb_äag_size
(
äag
),

128 
NFDK_TX_MAX_DATA_PER_DESC
);

130 ià(
	`uÆik–y
(
n_descs
 > 
NFDK_TX_DESC_GATHER_MAX
)) {

131 ià(
	`skb_is_nÚlš—r
(
skb
)) {

132 
”r
 = 
	`skb_lš—rize
(
skb
);

133 ià(
”r
)

134  
”r
;

135 
»couÁ_descs
;

137  -
EINVAL
;

141 
n_descs
 +ð!!
	`skb_is_gso
(
skb
);

143 ià(
	`round_down
(
tx_ršg
->
wr_p
, 
NFDK_TX_DESC_BLOCK_CNT
) !=

144 
	`round_down
(
tx_ršg
->
wr_p
 + 
n_descs
, 
NFDK_TX_DESC_BLOCK_CNT
))

145 
þo£_block
;

147 ià((
u32
)
tx_ršg
->
d©a_³ndšg
 + 
skb
->
Ën
 > 
NFDK_TX_MAX_DATA_PER_BLOCK
)

148 
þo£_block
;

152 
þo£_block
:

153 
wr_p
 = 
tx_ršg
->wr_p;

154 
nÝ_¦Ùs
 = 
	`D_BLOCK_CPL
(
wr_p
);

156 
wr_idx
 = 
	`D_IDX
(
tx_ršg
, 
wr_p
);

157 
tx_ršg
->
ktxbufs
[
wr_idx
].
skb
 = 
NULL
;

158 
txd
 = &
tx_ršg
->
ktxds
[
wr_idx
];

160 
	`mem£t
(
txd
, 0, 
	`¬¿y_size
(
nÝ_¦Ùs
, (
nå_nfdk_tx_desc
)));

162 
tx_ršg
->
d©a_³ndšg
 = 0;

163 
tx_ršg
->
wr_p
 +ð
nÝ_¦Ùs
;

164 
tx_ršg
->
wr_±r_add
 +ð
nÝ_¦Ùs
;

167 
	}
}

169 #ifdeà
COMPAT__HAVE_METADATA_IP_TUNNEL


170 
	$nå_nfdk_´•_pÜt_id
(
sk_buff
 *
skb
)

172 
m‘ad©a_d¡
 *
md_d¡
 = 
	`skb_m‘ad©a_d¡
(
skb
);

173 *
d©a
;

175 ià(
	`lik–y
(!
md_d¡
))

177 ià(
	`uÆik–y
(
md_d¡
->
ty³
 !ð
METADATA_HW_PORT_MUX
))

180 ià(
	`uÆik–y
(
	`skb_cow_h—d
(
skb
, (
md_d¡
->
u
.
pÜt_šfo
.
pÜt_id
))))

181  -
ENOMEM
;

183 
d©a
 = 
	`skb_push
(
skb
, (
md_d¡
->
u
.
pÜt_šfo
.
pÜt_id
));

184 
	`put_uÇligÃd_be32
(
md_d¡
->
u
.
pÜt_šfo
.
pÜt_id
, 
d©a
);

186  (
md_d¡
->
u
.
pÜt_šfo
.
pÜt_id
);

187 
	}
}

189 
	$nå_nfdk_´•_pÜt_id
(
sk_buff
 *
skb
)

192 
	}
}

196 
	$nå_nfdk_´•_tx_m‘a
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
,

197 
nå_Ãt_r_veùÜ
 *
r_vec
)

199 *
d©a
;

200 
»s
, 
md_by‹s
;

201 
u32
 
m‘a_id
 = 0;

203 
»s
 = 
	`nå_nfdk_´•_pÜt_id
(
skb
);

204 ià(
	`uÆik–y
(
»s
 <= 0))

205  
»s
;

207 
md_by‹s
 = 
»s
;

208 
m‘a_id
 = 
NFP_NET_META_PORTID
;

210 ià(
	`uÆik–y
(
	`skb_cow_h—d
(
skb
, (
m‘a_id
))))

211  -
ENOMEM
;

213 
md_by‹s
 +ð(
m‘a_id
);

215 
m‘a_id
 = 
	`FIELD_PREP
(
NFDK_META_LEN
, 
md_by‹s
) |

216 
	`FIELD_PREP
(
NFDK_META_FIELDS
, 
m‘a_id
);

218 
d©a
 = 
	`skb_push
(
skb
, (
m‘a_id
));

219 
	`put_uÇligÃd_be32
(
m‘a_id
, 
d©a
);

221  
NFDK_DESC_TX_CHAIN_META
;

222 
	}
}

231 
	$nå_nfdk_tx
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
)

233 cÚ¡ 
skb_äag_¡ruù
 *
äag
, *
ãnd
;

234 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

235 
nå_nfdk_tx_buf
 *
txbuf
, *
‘xbuf
;

236 
u32
 
út
, 
tmp_dËn
, 
dËn_ty³
 = 0;

237 
nå_Ãt_tx_ršg
 *
tx_ršg
;

238 
nå_Ãt_r_veùÜ
 *
r_vec
;

239 
nå_nfdk_tx_desc
 *
txd
;

240 
»®_Ën
, 
qidx
;

241 
dma_Ën
, 
ty³
;

242 
Ãtdev_queue
 *
nd_q
;

243 
nå_Ãt_dp
 *
dp
;

244 
Ä_äags
, 
wr_idx
;

245 
dma_addr_t
 
dma_addr
;

246 
u64
 
m‘ad©a
;

248 
dp
 = &
Â
->dp;

249 
qidx
 = 
	`skb_g‘_queue_m­pšg
(
skb
);

250 
tx_ršg
 = &
dp
->
tx_ršgs
[
qidx
];

251 
r_vec
 = 
tx_ršg
->r_vec;

252 
nd_q
 = 
	`Ãtdev_g‘_tx_queue
(
dp
->
Ãtdev
, 
qidx
);

255 ià(
	`uÆik–y
(
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 
NFDK_TX_DESC_STOP_CNT
))) {

256 
	`Â_dp_w¬n
(
dp
, "TX„ing %d busy. wrp=%u„dp=%u\n",

257 
qidx
, 
tx_ršg
->
wr_p
,x_ršg->
rd_p
);

258 
	`Ãtif_tx_¡Ý_queue
(
nd_q
);

259 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

260 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

261 
r_vec
->
tx_busy
++;

262 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

263  
NETDEV_TX_BUSY
;

266 
m‘ad©a
 = 
	`nå_nfdk_´•_tx_m‘a
(
Â
->
­p
, 
skb
, 
r_vec
);

267 ià(
	`uÆik–y
(()
m‘ad©a
 < 0))

268 
”r_æush
;

270 ià(
	`uÆik–y
(
	`com·t_ndo_ã©u»s_check
(
Â
, 
skb
)))

271 
”r_æush
;

273 
Ä_äags
 = 
	`skb_shšfo
(
skb
)->nr_frags;

274 ià(
	`nå_nfdk_tx_maybe_þo£_block
(
tx_ršg
, 
Ä_äags
, 
skb
))

275 
”r_æush
;

278 
wr_idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
wr_p
);

279 
txd
 = &
tx_ršg
->
ktxds
[
wr_idx
];

280 
txbuf
 = &
tx_ršg
->
ktxbufs
[
wr_idx
];

282 
dma_Ën
 = 
	`skb_h—dËn
(
skb
);

283 ià(
	`skb_is_gso
(
skb
))

284 
ty³
 = 
NFDK_DESC_TX_TYPE_TSO
;

285 ià(!
Ä_äags
 && 
dma_Ën
 < 
NFDK_TX_MAX_DATA_PER_HEAD
)

286 
ty³
 = 
NFDK_DESC_TX_TYPE_SIMPLE
;

288 
ty³
 = 
NFDK_DESC_TX_TYPE_GATHER
;

290 
dma_addr
 = 
	`dma_m­_sšgË
(
dp
->
dev
, 
skb
->
d©a
, 
dma_Ën
, 
DMA_TO_DEVICE
);

291 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, 
dma_addr
))

292 
”r_w¬n_dma
;

294 
txbuf
->
skb
 = skb;

295 
txbuf
++;

297 
txbuf
->
dma_addr
 = dma_addr;

298 
txbuf
++;

301 
dma_Ën
 -= 1;

302 
dËn_ty³
 = 
	`FIELD_PREP
(
NFDK_DESC_TX_DMA_LEN_HEAD
, 
dma_Ën
) |

303 
	`FIELD_PREP
(
NFDK_DESC_TX_TYPE_HEAD
, 
ty³
);

305 
txd
->
dma_Ën_ty³
 = 
	`ýu_to_Ë16
(
dËn_ty³
);

306 
	`nå_desc_£t_dma_addr_48b
(
txd
, 
dma_addr
);

309 
	`BUILD_BUG_ON
(!(
NFDK_DESC_TX_DMA_LEN_HEAD
 & 1));

314 
tmp_dËn
 = 
dËn_ty³
 & 
NFDK_DESC_TX_DMA_LEN_HEAD
;

315 
dma_Ën
 -ð
tmp_dËn
;

316 
dma_addr
 +ð
tmp_dËn
 + 1;

317 
txd
++;

323 
äag
 = 
	`skb_shšfo
(
skb
)->
äags
;

324 
ãnd
 = 
äag
 + 
Ä_äags
;

326 
Œue
) {

327 
dma_Ën
 > 0) {

328 
dma_Ën
 -= 1;

329 
dËn_ty³
 = 
	`FIELD_PREP
(
NFDK_DESC_TX_DMA_LEN
, 
dma_Ën
);

331 
txd
->
dma_Ën_ty³
 = 
	`ýu_to_Ë16
(
dËn_ty³
);

332 
	`nå_desc_£t_dma_addr_48b
(
txd
, 
dma_addr
);

334 
dma_Ën
 -ð
dËn_ty³
;

335 
dma_addr
 +ð
dËn_ty³
 + 1;

336 
txd
++;

339 ià(
äag
 >ð
ãnd
)

342 
dma_Ën
 = 
	`skb_äag_size
(
äag
);

343 
dma_addr
 = 
	`skb_äag_dma_m­
(
dp
->
dev
, 
äag
, 0, 
dma_Ën
,

344 
DMA_TO_DEVICE
);

345 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, 
dma_addr
))

346 
”r_unm­
;

348 
txbuf
->
dma_addr
 = dma_addr;

349 
txbuf
++;

351 
äag
++;

354 (
txd
 - 1)->
dma_Ën_ty³
 = 
	`ýu_to_Ë16
(
dËn_ty³
 | 
NFDK_DESC_TX_EOP
);

357 
m‘ad©a
 = 
	`nå_nfdk_tx_csum
(
dp
, 
r_vec
, 1, 
skb
, metadata);

358 
txd
->
¿w
 = 
	`ýu_to_Ë64
(
m‘ad©a
);

359 
txd
++;

361 ià(!
	`skb_is_gso
(
skb
)) {

362 
»®_Ën
 = 
skb
->
Ën
;

364 
txd
->
¿w
 = 
	`nå_nfdk_tx_tso
(
r_vec
, 
txbuf
, 
skb
);

365 
txd
++;

366 
»®_Ën
 = 
txbuf
->real_len;

367 
txbuf
++;

370 
út
 = 
txd
 - 
tx_ršg
->
ktxds
 - 
wr_idx
;

371 ià(
	`uÆik–y
(
	`round_down
(
wr_idx
, 
NFDK_TX_DESC_BLOCK_CNT
) !=

372 
	`round_down
(
wr_idx
 + 
út
 - 1, 
NFDK_TX_DESC_BLOCK_CNT
)))

373 
”r_w¬n_ov”æow
;

375 
	`skb_tx_time¡amp
(
skb
);

377 
tx_ršg
->
wr_p
 +ð
út
;

378 ià(
tx_ršg
->
wr_p
 % 
NFDK_TX_DESC_BLOCK_CNT
)

379 
tx_ršg
->
d©a_³ndšg
 +ð
skb
->
Ën
;

381 
tx_ršg
->
d©a_³ndšg
 = 0;

383 ià(
	`nå_nfdk_tx_ršg_should_¡Ý
(
tx_ršg
))

384 
	`nå_nfdk_tx_ršg_¡Ý
(
nd_q
, 
tx_ršg
);

386 
tx_ršg
->
wr_±r_add
 +ð
út
;

387 ià(
	`__Ãtdev_tx_£Á_queue
(
nd_q
, 
»®_Ën
, 
	`skb_xm™_mÜe
(
skb
)))

388 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

390  
NETDEV_TX_OK
;

392 
”r_w¬n_ov”æow
:

393 
	`WARN_ONCE
(1, "unableo fit…acket into‡ descriptor wr_idx:%d head:%d frags:%d cnt:%d",

394 
wr_idx
, 
	`skb_h—dËn
(
skb
), 
Ä_äags
, 
út
);

395 ià(
	`skb_is_gso
(
skb
))

396 
txbuf
--;

397 
”r_unm­
:

399 
‘xbuf
 = 
txbuf
;

401 
txbuf
 = &
tx_ršg
->
ktxbufs
[
wr_idx
 + 1];

402 ià(
txbuf
 < 
‘xbuf
) {

403 
	`dma_unm­_sšgË
(
dp
->
dev
, 
txbuf
->
dma_addr
,

404 
	`skb_h—dËn
(
skb
), 
DMA_TO_DEVICE
);

405 
txbuf
->
¿w
 = 0;

406 
txbuf
++;

408 
äag
 = 
	`skb_shšfo
(
skb
)->
äags
;

409 
‘xbuf
 < 
txbuf
) {

410 
	`dma_unm­_·ge
(
dp
->
dev
, 
txbuf
->
dma_addr
,

411 
	`skb_äag_size
(
äag
), 
DMA_TO_DEVICE
);

412 
txbuf
->
¿w
 = 0;

413 
äag
++;

414 
txbuf
++;

416 
”r_w¬n_dma
:

417 
	`Â_dp_w¬n
(
dp
, "Failedo map DMA TX buffer\n");

418 
”r_æush
:

419 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

420 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

421 
r_vec
->
tx_”rÜs
++;

422 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

423 
	`dev_kä“_skb_ªy
(
skb
);

424  
NETDEV_TX_OK
;

425 
	}
}

432 
	$nå_nfdk_tx_com¶‘e
(
nå_Ãt_tx_ršg
 *
tx_ršg
, 
budg‘
)

434 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
tx_ršg
->r_vec;

435 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

436 
u32
 
dÚe_pkts
 = 0, 
dÚe_by‹s
 = 0;

437 
nå_nfdk_tx_buf
 *
ktxbufs
;

438 
deviû
 *
dev
 = 
dp
->dev;

439 
Ãtdev_queue
 *
nd_q
;

440 
u32
 
rd_p
, 
qý_rd_p
;

441 
todo
;

443 
rd_p
 = 
tx_ršg
->rd_p;

444 ià(
tx_ršg
->
wr_p
 =ð
rd_p
)

448 
qý_rd_p
 = 
	`nå_Ãt_»ad_tx_cm¶
(
tx_ršg
, 
dp
);

450 ià(
qý_rd_p
 =ð
tx_ršg
->qcp_rd_p)

453 
todo
 = 
	`D_IDX
(
tx_ršg
, 
qý_rd_p
 -x_ring->qcp_rd_p);

454 
ktxbufs
 = 
tx_ršg
->ktxbufs;

456 
todo
 > 0) {

457 cÚ¡ 
skb_äag_¡ruù
 *
äag
, *
ãnd
;

458 
size
, 
n_descs
 = 1;

459 
nå_nfdk_tx_buf
 *
txbuf
;

460 
sk_buff
 *
skb
;

462 
txbuf
 = &
ktxbufs
[
	`D_IDX
(
tx_ršg
, 
rd_p
)];

463 
skb
 = 
txbuf
->skb;

464 
txbuf
++;

467 ià(!
skb
) {

468 
n_descs
 = 
	`D_BLOCK_CPL
(
rd_p
);

469 
Ãxt
;

473 
size
 = 
	`skb_h—dËn
(
skb
);

474 
n_descs
 +ð
	`nå_nfdk_h—dËn_to_£gs
(
size
);

475 
	`dma_unm­_sšgË
(
dev
, 
txbuf
->
dma_addr
, 
size
, 
DMA_TO_DEVICE
);

476 
txbuf
++;

479 
äag
 = 
	`skb_shšfo
(
skb
)->
äags
;

480 
ãnd
 = 
äag
 + 
	`skb_shšfo
(
skb
)->
Ä_äags
;

481 ; 
äag
 < 
ãnd
; frag++) {

482 
size
 = 
	`skb_äag_size
(
äag
);

483 
n_descs
 +ð
	`DIV_ROUND_UP
(
size
,

484 
NFDK_TX_MAX_DATA_PER_DESC
);

485 
	`dma_unm­_·ge
(
dev
, 
txbuf
->
dma_addr
,

486 
	`skb_äag_size
(
äag
), 
DMA_TO_DEVICE
);

487 
txbuf
++;

490 ià(!
	`skb_is_gso
(
skb
)) {

491 
dÚe_by‹s
 +ð
skb
->
Ën
;

492 
dÚe_pkts
++;

494 
dÚe_by‹s
 +ð
txbuf
->
»®_Ën
;

495 
dÚe_pkts
 +ð
txbuf
->
pkt_út
;

496 
n_descs
++;

499 
	`Çpi_cÚsume_skb
(
skb
, 
budg‘
);

500 
Ãxt
:

501 
rd_p
 +ð
n_descs
;

502 
todo
 -ð
n_descs
;

505 
tx_ršg
->
rd_p
 =„d_p;

506 
tx_ršg
->
qý_rd_p
 = qcp_rd_p;

508 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

509 
r_vec
->
tx_by‹s
 +ð
dÚe_by‹s
;

510 
r_vec
->
tx_pkts
 +ð
dÚe_pkts
;

511 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

513 ià(!
dp
->
Ãtdev
)

516 
nd_q
 = 
	`Ãtdev_g‘_tx_queue
(
dp
->
Ãtdev
, 
tx_ršg
->
idx
);

517 
	`Ãtdev_tx_com¶‘ed_queue
(
nd_q
, 
dÚe_pkts
, 
dÚe_by‹s
);

518 ià(
	`nå_nfdk_tx_ršg_should_wake
(
tx_ršg
)) {

520 
	`smp_mb
();

522 ià(
	`uÆik–y
(
	`Ãtif_tx_queue_¡Ý³d
(
nd_q
)))

523 
	`Ãtif_tx_wake_queue
(
nd_q
);

526 
	`WARN_ONCE
(
tx_ršg
->
wr_p
 -x_ršg->
rd_p
 >x_ršg->
út
,

528 
tx_ršg
->
rd_p
,x_ršg->
wr_p
,x_ršg->
út
);

529 
	}
}

531 
boÞ
 
	$nå_nfdk_xdp_com¶‘e
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

534  
Œue
;

535 
	}
}

541 
	$nå_nfdk_Çpi_®loc_Úe
(
nå_Ãt_dp
 *
dp
, 
dma_addr_t
 *
dma_addr
)

543 *
äag
;

545 ià(!
dp
->
xdp_´og
) {

546 
äag
 = 
	`Çpi_®loc_äag
(
dp
->
æ_bufsz
);

547 ià(
	`uÆik–y
(!
äag
))

548  
NULL
;

550 
·ge
 *page;

552 
·ge
 = 
	`dev_®loc_·ge
();

553 ià(
	`uÆik–y
(!
·ge
))

554  
NULL
;

555 
äag
 = 
	`·ge_add»ss
(
·ge
);

558 *
dma_addr
 = 
	`nå_Ãt_dma_m­_rx
(
dp
, 
äag
);

559 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, *
dma_addr
)) {

560 
	`nå_Ãt_ä“_äag
(
äag
, 
dp
->
xdp_´og
);

561 
	`Â_dp_w¬n
(
dp
, "Failedo map DMA RX buffer\n");

562  
NULL
;

565  
äag
;

566 
	}
}

576 
	$nå_nfdk_rx_give_Úe
(cÚ¡ 
nå_Ãt_dp
 *
dp
,

577 
nå_Ãt_rx_ršg
 *
rx_ršg
,

578 *
äag
, 
dma_addr_t
 
dma_addr
)

580 
wr_idx
;

582 
wr_idx
 = 
	`D_IDX
(
rx_ršg
,„x_ršg->
wr_p
);

584 
	`nå_Ãt_dma_sync_dev_rx
(
dp
, 
dma_addr
);

587 
rx_ršg
->
rxbufs
[
wr_idx
].
äag
 = frag;

588 
rx_ršg
->
rxbufs
[
wr_idx
].
dma_addr
 = dma_addr;

591 
rx_ršg
->
rxds
[
wr_idx
].
æd
.
»£rved
 = 0;

592 
rx_ršg
->
rxds
[
wr_idx
].
æd
.
m‘a_Ën_dd
 = 0;

593 
	`nå_desc_£t_dma_addr_48b
(&
rx_ršg
->
rxds
[
wr_idx
].
æd
,

594 
dma_addr
 + 
dp
->
rx_dma_off
);

596 
rx_ršg
->
wr_p
++;

597 ià(!(
rx_ršg
->
wr_p
 % 
NFP_NET_FL_BATCH
)) {

601 
	`wmb
();

602 
	`nå_qý_wr_±r_add
(
rx_ršg
->
qý_æ
, 
NFP_NET_FL_BATCH
);

604 
	}
}

611 
	$nå_nfdk_rx_ršg_fžl_ä“li¡
(
nå_Ãt_dp
 *
dp
,

612 
nå_Ãt_rx_ršg
 *
rx_ršg
)

614 
i
;

616 
i
 = 0; i < 
rx_ršg
->
út
 - 1; i++)

617 
	`nå_nfdk_rx_give_Úe
(
dp
, 
rx_ršg
,„x_ršg->
rxbufs
[
i
].
äag
,

618 
rx_ršg
->
rxbufs
[
i
].
dma_addr
);

619 
	}
}

625 
	$nå_nfdk_rx_csum_has_”rÜs
(
u16
 
æags
)

627 
u16
 
csum_®l_checked
, 
csum_®l_ok
;

629 
csum_®l_checked
 = 
æags
 & 
__PCIE_DESC_RX_CSUM_ALL
;

630 
csum_®l_ok
 = 
æags
 & 
__PCIE_DESC_RX_CSUM_ALL_OK
;

632  
csum_®l_checked
 !ð(
csum_®l_ok
 << 
PCIE_DESC_RX_CSUM_OK_SHIFT
);

633 
	}
}

644 
	$nå_nfdk_rx_csum
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

645 
nå_Ãt_rx_desc
 *
rxd
, 
nå_m‘a_·r£d
 *
m‘a
,

646 
sk_buff
 *
skb
)

648 
	`skb_checksum_nÚe_as£¹
(
skb
);

650 ià(!(
dp
->
Ãtdev
->
ã©u»s
 & 
NETIF_F_RXCSUM
))

653 ià(
m‘a
->
csum_ty³
) {

654 
skb
->
_summed
 = 
m‘a
->
csum_ty³
;

655 
skb
->
csum
 = 
m‘a
->csum;

656 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

657 
r_vec
->
hw_csum_rx_com¶‘e
++;

658 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

662 ià(
	`nå_nfdk_rx_csum_has_”rÜs
(
	`Ë16_to_ýu
(
rxd
->rxd.
æags
))) {

663 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

664 
r_vec
->
hw_csum_rx_”rÜ
++;

665 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

673 ià(
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_TCP_CSUM_OK
 ||

674 
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_UDP_CSUM_OK
) {

675 
	`com·t_šü_checksum_uÂeûs§ry
(
skb
, 
çl£
);

676 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

677 
r_vec
->
hw_csum_rx_ok
++;

678 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

681 ià(
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_I_TCP_CSUM_OK
 ||

682 
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_I_UDP_CSUM_OK
) {

683 
	`com·t_šü_checksum_uÂeûs§ry
(
skb
, 
Œue
);

684 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

685 
r_vec
->
hw_csum_rx_šÃr_ok
++;

686 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

688 
	}
}

691 
	$nå_nfdk_£t_hash
(
Ãt_deviû
 *
Ãtdev
, 
nå_m‘a_·r£d
 *
m‘a
,

692 
ty³
, 
__be32
 *
hash
)

694 ià(!(
Ãtdev
->
ã©u»s
 & 
NETIF_F_RXHASH
))

697 
ty³
) {

698 
NFP_NET_RSS_IPV4
:

699 
NFP_NET_RSS_IPV6
:

700 
NFP_NET_RSS_IPV6_EX
:

701 
m‘a
->
hash_ty³
 = 
PKT_HASH_TYPE_L3
;

704 
m‘a
->
hash_ty³
 = 
PKT_HASH_TYPE_L4
;

708 
m‘a
->
hash
 = 
	`g‘_uÇligÃd_be32
(hash);

709 
	}
}

712 
	$nå_nfdk_·r£_m‘a
(
Ãt_deviû
 *
Ãtdev
, 
nå_m‘a_·r£d
 *
m‘a
,

713 *
d©a
, 
m‘a_Ën
)

715 
u32
 
m‘a_šfo
;

717 
m‘a_šfo
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

718 
d©a
 += 4;

720 
m‘a_šfo
) {

721 
m‘a_šfo
 & 
NFP_NET_META_FIELD_MASK
) {

722 
NFP_NET_META_HASH
:

723 
m‘a_šfo
 >>ð
NFP_NET_META_FIELD_SIZE
;

724 
	`nå_nfdk_£t_hash
(
Ãtdev
, 
m‘a
,

725 
m‘a_šfo
 & 
NFP_NET_META_FIELD_MASK
,

726 (
__be32
 *)
d©a
);

727 
d©a
 += 4;

729 
NFP_NET_META_MARK
:

730 
m‘a
->
m¬k
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

731 
d©a
 += 4;

733 
NFP_NET_META_PORTID
:

734 
m‘a
->
pÜtid
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

735 
d©a
 += 4;

737 
NFP_NET_META_CSUM
:

738 
m‘a
->
csum_ty³
 = 
CHECKSUM_COMPLETE
;

739 
m‘a
->
csum
 =

740 (
__fÜû
 
__wsum
)
	`__g‘_uÇligÃd_ýu32
(
d©a
);

741 
d©a
 += 4;

744  
NULL
;

747 
m‘a_šfo
 >>ð
NFP_NET_META_FIELD_SIZE
;

750  
d©a
;

751 
	}
}

754 
	$nå_nfdk_rx_drÝ
(cÚ¡ 
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

755 
nå_Ãt_rx_ršg
 *
rx_ršg
, 
nå_Ãt_rx_buf
 *
rxbuf
,

756 
sk_buff
 *
skb
)

758 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

759 
r_vec
->
rx_drÝs
++;

763 ià(
skb
 && 
rxbuf
)

764 
r_vec
->
rx_»¶aû_buf_®loc_çž
++;

765 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

770 ià(
skb
 && 
rxbuf
 && skb->
h—d
 =ðrxbuf->
äag
)

771 
	`·ge_»f_šc
(
	`vœt_to_h—d_·ge
(
rxbuf
->
äag
));

772 ià(
rxbuf
)

773 
	`nå_nfdk_rx_give_Úe
(
dp
, 
rx_ršg
, 
rxbuf
->
äag
,„xbuf->
dma_addr
);

774 ià(
skb
)

775 
	`dev_kä“_skb_ªy
(
skb
);

776 
	}
}

778 #ià
COMPAT__HAVE_XDP


779 
boÞ


780 
	$nå_nfdk_tx_xdp_buf
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_rx_ršg
 *
rx_ršg
,

781 
nå_Ãt_tx_ršg
 *
tx_ršg
,

782 
nå_Ãt_rx_buf
 *
rxbuf
, 
dma_off
,

783 
pkt_Ën
, 
boÞ
 *
com¶‘ed
)

786 
	`nå_nfdk_rx_drÝ
(
dp
, 
rx_ršg
->
r_vec
,„x_ršg, 
rxbuf
, 
NULL
);

787  
çl£
;

788 
	}
}

802 
	$nå_nfdk_rx
(
nå_Ãt_rx_ršg
 *
rx_ršg
, 
budg‘
)

804 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
rx_ršg
->r_vec;

805 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

806 
nå_Ãt_tx_ršg
 *
tx_ršg
;

807 
bpf_´og
 *
xdp_´og
;

808 
boÞ
 
xdp_tx_cm¶
 = 
çl£
;

809 
Œue_bufsz
;

810 
sk_buff
 *
skb
;

811 
pkts_pÞËd
 = 0;

812 #ià
COMPAT__HAVE_XDP


813 
xdp_buff
 
xdp
;

815 
idx
;

817 
	`rcu_»ad_lock
();

818 
xdp_´og
 = 
	`READ_ONCE
(
dp
->xdp_prog);

819 
Œue_bufsz
 = 
xdp_´og
 ? 
PAGE_SIZE
 : 
dp
->
æ_bufsz
;

820 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 16, 0)

821 
xdp
.
rxq
 = &
rx_ršg
->
xdp_rxq
;

823 
tx_ršg
 = 
r_vec
->
xdp_ršg
;

825 
pkts_pÞËd
 < 
budg‘
) {

826 
m‘a_Ën
, 
d©a_Ën
, 
m‘a_off
, 
pkt_Ën
, 
pkt_off
;

827 
nå_Ãt_rx_buf
 *
rxbuf
;

828 
nå_Ãt_rx_desc
 *
rxd
;

829 
nå_m‘a_·r£d
 
m‘a
;

830 
Ãt_deviû
 *
Ãtdev
;

831 
dma_addr_t
 
Ãw_dma_addr
;

832 
u32
 
m‘a_Ën_xdp
 = 0;

833 *
Ãw_äag
;

835 
idx
 = 
	`D_IDX
(
rx_ršg
,„x_ršg->
rd_p
);

837 
rxd
 = &
rx_ršg
->
rxds
[
idx
];

838 ià(!(
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_DD
))

844 
	`dma_rmb
();

846 
	`mem£t
(&
m‘a
, 0, (meta));

848 
rx_ršg
->
rd_p
++;

849 
pkts_pÞËd
++;

851 
rxbuf
 = &
rx_ršg
->
rxbufs
[
idx
];

864 
m‘a_Ën
 = 
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_META_LEN_MASK
;

865 
d©a_Ën
 = 
	`Ë16_to_ýu
(
rxd
->rxd.data_len);

866 
pkt_Ën
 = 
d©a_Ën
 - 
m‘a_Ën
;

868 
pkt_off
 = 
NFP_NET_RX_BUF_HEADROOM
 + 
dp
->
rx_dma_off
;

869 ià(
dp
->
rx_off£t
 =ð
NFP_NET_CFG_RX_OFFSET_DYNAMIC
)

870 
pkt_off
 +ð
m‘a_Ën
;

872 
pkt_off
 +ð
dp
->
rx_off£t
;

873 
m‘a_off
 = 
pkt_off
 - 
m‘a_Ën
;

876 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

877 
r_vec
->
rx_pkts
++;

878 
r_vec
->
rx_by‹s
 +ð
pkt_Ën
;

879 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

881 ià(
	`uÆik–y
(
m‘a_Ën
 > 
NFP_NET_MAX_PREPEND
 ||

882 (
dp
->
rx_off£t
 && 
m‘a_Ën
 > dp->rx_offset))) {

883 
	`Â_dp_w¬n
(
dp
, "oversized RX…acket metadata %u\n",

884 
m‘a_Ën
);

885 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

889 
	`nå_Ãt_dma_sync_ýu_rx
(
dp
, 
rxbuf
->
dma_addr
 + 
m‘a_off
,

890 
d©a_Ën
);

892 ià(
m‘a_Ën
) {

893 *
’d
;

895 
’d
 = 
	`nå_nfdk_·r£_m‘a
(
dp
->
Ãtdev
, &
m‘a
,

896 
rxbuf
->
äag
 + 
m‘a_off
,

897 
m‘a_Ën
);

898 ià(
	`uÆik–y
(
’d
 !ð
rxbuf
->
äag
 + 
pkt_off
)) {

899 
	`Â_dp_w¬n
(
dp
, "invalid RX…acket metadata\n");

900 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
,

901 
NULL
);

906 #ià
COMPAT__HAVE_XDP


907 ià(
xdp_´og
 && !
m‘a
.
pÜtid
) {

908 *
Üig_d©a
 = 
rxbuf
->
äag
 + 
pkt_off
;

909 
dma_off
;

910 
aù
;

912 #ià
COMPAT__HAVE_XDP_ADJUST_HEAD


913 
xdp
.
d©a_h¬d_¡¬t
 = 
rxbuf
->
äag
 +

914 
NFP_NET_RX_BUF_HEADROOM
;

916 
xdp
.
d©a
 = 
Üig_d©a
;

917 #ià
COMPAT__HAVE_XDP_METADATA


918 
xdp
.
d©a_m‘a
 = 
Üig_d©a
;

920 
xdp
.
d©a_’d
 = 
Üig_d©a
 + 
pkt_Ën
;

922 
aù
 = 
	`bpf_´og_run_xdp
(
xdp_´og
, &
xdp
);

924 
pkt_Ën
 = 
xdp
.
d©a_’d
 - xdp.
d©a
;

925 
pkt_off
 +ð
xdp
.
d©a
 - 
Üig_d©a
;

927 
aù
) {

928 
XDP_PASS
:

929 #ià
COMPAT__HAVE_XDP_METADATA


930 
m‘a_Ën_xdp
 = 
xdp
.
d©a
 - xdp.
d©a_m‘a
;

933 
XDP_TX
:

934 
dma_off
 = 
pkt_off
 - 
NFP_NET_RX_BUF_HEADROOM
;

935 ià(
	`uÆik–y
(!
	`nå_nfdk_tx_xdp_buf
(
dp
, 
rx_ršg
,

936 
tx_ršg
,

937 
rxbuf
,

938 
dma_off
,

939 
pkt_Ën
,

940 &
xdp_tx_cm¶
)))

941 
	`Œaû_xdp_exû±iÚ
(
dp
->
Ãtdev
,

942 
xdp_´og
, 
aù
);

945 
	`bpf_w¬n_šv®id_xdp_aùiÚ
(
aù
);

947 
XDP_ABORTED
:

948 
	`Œaû_xdp_exû±iÚ
(
dp
->
Ãtdev
, 
xdp_´og
, 
aù
);

950 
XDP_DROP
:

951 
	`nå_nfdk_rx_give_Úe
(
dp
, 
rx_ršg
, 
rxbuf
->
äag
,

952 
rxbuf
->
dma_addr
);

957 
xdp_tx_cm¶
 = xdp_tx_cmpl;

960 ià(
	`lik–y
(!
m‘a
.
pÜtid
)) {

961 
Ãtdev
 = 
dp
->netdev;

962 } ià(
m‘a
.
pÜtid
 =ð
NFP_META_PORT_ID_CTRL
) {

963 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
dp
->
Ãtdev
);

965 
	`nå_­p_ù¾_rx_¿w
(
Â
->
­p
, 
rxbuf
->
äag
 + 
pkt_off
,

966 
pkt_Ën
);

967 
	`nå_nfdk_rx_give_Úe
(
dp
, 
rx_ršg
, 
rxbuf
->
äag
,

968 
rxbuf
->
dma_addr
);

971 
nå_Ãt
 *
Â
;

973 
Â
 = 
	`Ãtdev_´iv
(
dp
->
Ãtdev
);

974 
Ãtdev
 = 
	`nå_­p_»´_g‘
(
Â
->
­p
, 
m‘a
.
pÜtid
);

975 ià(
	`uÆik–y
(!
Ãtdev
)) {

976 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
,

977 
NULL
);

980 
	`nå_»´_šc_rx_¡©s
(
Ãtdev
, 
pkt_Ën
);

983 
skb
 = 
	`bužd_skb
(
rxbuf
->
äag
, 
Œue_bufsz
);

984 ià(
	`uÆik–y
(!
skb
)) {

985 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

988 
Ãw_äag
 = 
	`nå_nfdk_Çpi_®loc_Úe
(
dp
, &
Ãw_dma_addr
);

989 ià(
	`uÆik–y
(!
Ãw_äag
)) {

990 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
skb
);

994 
	`nå_Ãt_dma_unm­_rx
(
dp
, 
rxbuf
->
dma_addr
);

996 
	`nå_nfdk_rx_give_Úe
(
dp
, 
rx_ršg
, 
Ãw_äag
, 
Ãw_dma_addr
);

998 
	`skb_»£rve
(
skb
, 
pkt_off
);

999 
	`skb_put
(
skb
, 
pkt_Ën
);

1001 
skb
->
m¬k
 = 
m‘a
.mark;

1002 
	`skb_£t_hash
(
skb
, 
m‘a
.
hash
, m‘a.
hash_ty³
);

1004 
	`skb_»cÜd_rx_queue
(
skb
, 
rx_ršg
->
idx
);

1005 
skb
->
´ÙocÞ
 = 
	`‘h_ty³_Œªs
(skb, 
Ãtdev
);

1007 
	`nå_nfdk_rx_csum
(
dp
, 
r_vec
, 
rxd
, &
m‘a
, 
skb
);

1009 ià(
rxd
->rxd.
æags
 & 
PCIE_DESC_RX_VLAN
)

1010 
	`__vÏn_hwacûl_put_g
(
skb
, 
	`htÚs
(
ETH_P_8021Q
),

1011 
	`Ë16_to_ýu
(
rxd
->rxd.
vÏn
));

1012 ià(
m‘a_Ën_xdp
)

1013 
	`skb_m‘ad©a_£t
(
skb
, 
m‘a_Ën_xdp
);

1015 
	`Çpi_gro_»ûive
(&
rx_ršg
->
r_vec
->
Çpi
, 
skb
);

1018 ià(
xdp_´og
) {

1019 ià(
tx_ršg
->
wr_±r_add
)

1020 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

1021 ià(
	`uÆik–y
(
tx_ršg
->
wr_p
 !ðtx_ršg->
rd_p
) &&

1022 !
xdp_tx_cm¶
)

1023 ià(!
	`nå_nfdk_xdp_com¶‘e
(
tx_ršg
))

1024 
pkts_pÞËd
 = 
budg‘
;

1026 
	`rcu_»ad_uÆock
();

1028  
pkts_pÞËd
;

1029 
	}
}

1038 
	$nå_nfdk_pÞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

1040 
nå_Ãt_r_veùÜ
 *
r_vec
 =

1041 
	`cÚš”_of
(
Çpi
, 
nå_Ãt_r_veùÜ
,‚api);

1042 
pkts_pÞËd
 = 0;

1044 ià(
r_vec
->
tx_ršg
)

1045 
	`nå_nfdk_tx_com¶‘e
(
r_vec
->
tx_ršg
, 
budg‘
);

1046 ià(
r_vec
->
rx_ršg
)

1047 
pkts_pÞËd
 = 
	`nå_nfdk_rx
(
r_vec
->
rx_ršg
, 
budg‘
);

1049 ià(
pkts_pÞËd
 < 
budg‘
)

1050 ià(
	`Çpi_com¶‘e_dÚe
(
Çpi
, 
pkts_pÞËd
))

1051 
	`nå_Ãt_œq_unmask
(
r_vec
->
nå_Ãt
,„_vec->
œq_’Œy
);

1053  
pkts_pÞËd
;

1054 
	}
}

1056 #ifdeà
CONFIG_NFP_NET_PF


1060 
boÞ


1061 
	$nå_ù¾_tx_Úe
(
nå_Ãt
 *
Â
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

1062 
sk_buff
 *
skb
, 
boÞ
 
Þd
)

1064 
u32
 
út
, 
tmp_dËn
, 
dËn_ty³
 = 0;

1065 
nå_Ãt_tx_ršg
 *
tx_ršg
;

1066 
nå_nfdk_tx_buf
 *
txbuf
;

1067 
nå_nfdk_tx_desc
 *
txd
;

1068 
dma_Ën
, 
ty³
;

1069 
nå_Ãt_dp
 *
dp
;

1070 
dma_addr_t
 
dma_addr
;

1071 
u64
 
m‘ad©a
 = 0;

1072 
wr_idx
;

1074 
dp
 = &
r_vec
->
nå_Ãt
->dp;

1075 
tx_ršg
 = 
r_vec
->tx_ring;

1077 ià(
	`WARN_ON_ONCE
(
	`skb_shšfo
(
skb
)->
Ä_äags
)) {

1078 
	`Â_dp_w¬n
(
dp
, "Driver's CTRL TX does‚ot implement gather\n");

1079 
”r_ä“
;

1083 ià(
	`uÆik–y
(
	`nå_Ãt_tx_fuÎ
(
tx_ršg
, 
NFDK_TX_DESC_STOP_CNT
))) {

1084 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

1085 
r_vec
->
tx_busy
++;

1086 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

1087 ià(!
Þd
)

1088 
	`__skb_queue_ž
(&
r_vec
->
queue
, 
skb
);

1090 
	`__skb_queue_h—d
(&
r_vec
->
queue
, 
skb
);

1091  
NETDEV_TX_BUSY
;

1094 ià(
	`nå_­p_ù¾_has_m‘a
(
Â
->
­p
)) {

1095 ià(
	`uÆik–y
(
	`skb_h—droom
(
skb
) < 8)) {

1096 
	`Â_dp_w¬n
(
dp
, "CTRL TX on skb without headroom\n");

1097 
”r_ä“
;

1099 
m‘ad©a
 = 
NFDK_DESC_TX_CHAIN_META
;

1100 
	`put_uÇligÃd_be32
(
NFP_META_PORT_ID_CTRL
, 
	`skb_push
(
skb
, 4));

1101 
	`put_uÇligÃd_be32
(
	`FIELD_PREP
(
NFDK_META_LEN
, 8) |

1102 
	`FIELD_PREP
(
NFDK_META_FIELDS
,

1103 
NFP_NET_META_PORTID
),

1104 
	`skb_push
(
skb
, 4));

1107 ià(
	`nå_nfdk_tx_maybe_þo£_block
(
tx_ršg
, 0, 
skb
))

1108 
”r_ä“
;

1111 
wr_idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
wr_p
);

1112 
txd
 = &
tx_ršg
->
ktxds
[
wr_idx
];

1113 
txbuf
 = &
tx_ršg
->
ktxbufs
[
wr_idx
];

1115 
dma_Ën
 = 
	`skb_h—dËn
(
skb
);

1116 ià(
dma_Ën
 < 
NFDK_TX_MAX_DATA_PER_HEAD
)

1117 
ty³
 = 
NFDK_DESC_TX_TYPE_SIMPLE
;

1119 
ty³
 = 
NFDK_DESC_TX_TYPE_GATHER
;

1121 
dma_addr
 = 
	`dma_m­_sšgË
(
dp
->
dev
, 
skb
->
d©a
, 
dma_Ën
, 
DMA_TO_DEVICE
);

1122 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, 
dma_addr
))

1123 
”r_w¬n_dma
;

1125 
txbuf
->
skb
 = skb;

1126 
txbuf
++;

1128 
txbuf
->
dma_addr
 = dma_addr;

1129 
txbuf
++;

1131 
dma_Ën
 -= 1;

1132 
dËn_ty³
 = 
	`FIELD_PREP
(
NFDK_DESC_TX_DMA_LEN_HEAD
, 
dma_Ën
) |

1133 
	`FIELD_PREP
(
NFDK_DESC_TX_TYPE_HEAD
, 
ty³
);

1135 
txd
->
dma_Ën_ty³
 = 
	`ýu_to_Ë16
(
dËn_ty³
);

1136 
	`nå_desc_£t_dma_addr_48b
(
txd
, 
dma_addr
);

1138 
tmp_dËn
 = 
dËn_ty³
 & 
NFDK_DESC_TX_DMA_LEN_HEAD
;

1139 
dma_Ën
 -ð
tmp_dËn
;

1140 
dma_addr
 +ð
tmp_dËn
 + 1;

1141 
txd
++;

1143 
dma_Ën
 > 0) {

1144 
dma_Ën
 -= 1;

1145 
dËn_ty³
 = 
	`FIELD_PREP
(
NFDK_DESC_TX_DMA_LEN
, 
dma_Ën
);

1146 
txd
->
dma_Ën_ty³
 = 
	`ýu_to_Ë16
(
dËn_ty³
);

1147 
	`nå_desc_£t_dma_addr_48b
(
txd
, 
dma_addr
);

1149 
dËn_ty³
 &ð
NFDK_DESC_TX_DMA_LEN
;

1150 
dma_Ën
 -ð
dËn_ty³
;

1151 
dma_addr
 +ð
dËn_ty³
 + 1;

1152 
txd
++;

1155 (
txd
 - 1)->
dma_Ën_ty³
 = 
	`ýu_to_Ë16
(
dËn_ty³
 | 
NFDK_DESC_TX_EOP
);

1158 
txd
->
¿w
 = 
	`ýu_to_Ë64
(
m‘ad©a
);

1159 
txd
++;

1161 
út
 = 
txd
 - 
tx_ršg
->
ktxds
 - 
wr_idx
;

1162 ià(
	`uÆik–y
(
	`round_down
(
wr_idx
, 
NFDK_TX_DESC_BLOCK_CNT
) !=

1163 
	`round_down
(
wr_idx
 + 
út
 - 1, 
NFDK_TX_DESC_BLOCK_CNT
)))

1164 
”r_w¬n_ov”æow
;

1166 
tx_ršg
->
wr_p
 +ð
út
;

1167 ià(
tx_ršg
->
wr_p
 % 
NFDK_TX_DESC_BLOCK_CNT
)

1168 
tx_ršg
->
d©a_³ndšg
 +ð
skb
->
Ën
;

1170 
tx_ršg
->
d©a_³ndšg
 = 0;

1172 
tx_ršg
->
wr_±r_add
 +ð
út
;

1173 
	`nå_Ãt_tx_xm™_mÜe_æush
(
tx_ršg
);

1175  
NETDEV_TX_OK
;

1177 
”r_w¬n_ov”æow
:

1178 
	`WARN_ONCE
(1, "unableo fit…acket into‡ descriptor wr_idx:%d head:%d frags:%d cnt:%d",

1179 
wr_idx
, 
	`skb_h—dËn
(
skb
), 0, 
út
);

1180 
txbuf
--;

1181 
	`dma_unm­_sšgË
(
dp
->
dev
, 
txbuf
->
dma_addr
,

1182 
	`skb_h—dËn
(
skb
), 
DMA_TO_DEVICE
);

1183 
txbuf
->
¿w
 = 0;

1184 
”r_w¬n_dma
:

1185 
	`Â_dp_w¬n
(
dp
, "Failedo map DMA TX buffer\n");

1186 
”r_ä“
:

1187 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
tx_sync
);

1188 
r_vec
->
tx_”rÜs
++;

1189 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
tx_sync
);

1190 
	`dev_kä“_skb_ªy
(
skb
);

1191  
NETDEV_TX_OK
;

1192 
	}
}

1194 
boÞ
 
	$__nå_nfdk_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
)

1196 
nå_Ãt_r_veùÜ
 *
r_vec
 = &
Â
->
r_vecs
[0];

1198  
	`nå_ù¾_tx_Úe
(
Â
, 
r_vec
, 
skb
, 
çl£
);

1199 
	}
}

1201 
boÞ
 
	$nå_nfdk_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
)

1203 
nå_Ãt_r_veùÜ
 *
r_vec
 = &
Â
->
r_vecs
[0];

1204 
boÞ
 
»t
;

1206 
	`¥š_lock_bh
(&
r_vec
->
lock
);

1207 
»t
 = 
	`nå_ù¾_tx_Úe
(
Â
, 
r_vec
, 
skb
, 
çl£
);

1208 
	`¥š_uÆock_bh
(&
r_vec
->
lock
);

1210  
»t
;

1211 
	}
}

1213 
	$__nå_ù¾_tx_queued
(
nå_Ãt_r_veùÜ
 *
r_vec
)

1215 
sk_buff
 *
skb
;

1217 (
skb
 = 
	`__skb_dequeue
(&
r_vec
->
queue
)))

1218 ià(
	`nå_ù¾_tx_Úe
(
r_vec
->
nå_Ãt
,„_vec, 
skb
, 
Œue
))

1220 
	}
}

1222 
boÞ


1223 
	$nå_ù¾_m‘a_ok
(
nå_Ãt
 *
Â
, *
d©a
, 
m‘a_Ën
)

1225 
u32
 
m‘a_ty³
, 
m‘a_g
;

1227 ià(!
	`nå_­p_ù¾_has_m‘a
(
Â
->
­p
))

1228  !
m‘a_Ën
;

1230 ià(
m‘a_Ën
 != 8)

1231  
çl£
;

1233 
m‘a_ty³
 = 
	`g‘_uÇligÃd_be32
(
d©a
);

1234 
m‘a_g
 = 
	`g‘_uÇligÃd_be32
(
d©a
 + 4);

1236  (
m‘a_ty³
 =ð
NFP_NET_META_PORTID
 &&

1237 
m‘a_g
 =ð
NFP_META_PORT_ID_CTRL
);

1238 
	}
}

1240 
boÞ


1241 
	$nå_ù¾_rx_Úe
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
,

1242 
nå_Ãt_r_veùÜ
 *
r_vec
, 
nå_Ãt_rx_ršg
 *
rx_ršg
)

1244 
m‘a_Ën
, 
d©a_Ën
, 
m‘a_off
, 
pkt_Ën
, 
pkt_off
;

1245 
nå_Ãt_rx_buf
 *
rxbuf
;

1246 
nå_Ãt_rx_desc
 *
rxd
;

1247 
dma_addr_t
 
Ãw_dma_addr
;

1248 
sk_buff
 *
skb
;

1249 *
Ãw_äag
;

1250 
idx
;

1252 
idx
 = 
	`D_IDX
(
rx_ršg
,„x_ršg->
rd_p
);

1254 
rxd
 = &
rx_ršg
->
rxds
[
idx
];

1255 ià(!(
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_DD
))

1256  
çl£
;

1261 
	`dma_rmb
();

1263 
rx_ršg
->
rd_p
++;

1265 
rxbuf
 = &
rx_ršg
->
rxbufs
[
idx
];

1266 
m‘a_Ën
 = 
rxd
->rxd.
m‘a_Ën_dd
 & 
PCIE_DESC_RX_META_LEN_MASK
;

1267 
d©a_Ën
 = 
	`Ë16_to_ýu
(
rxd
->rxd.data_len);

1268 
pkt_Ën
 = 
d©a_Ën
 - 
m‘a_Ën
;

1270 
pkt_off
 = 
NFP_NET_RX_BUF_HEADROOM
 + 
dp
->
rx_dma_off
;

1271 ià(
dp
->
rx_off£t
 =ð
NFP_NET_CFG_RX_OFFSET_DYNAMIC
)

1272 
pkt_off
 +ð
m‘a_Ën
;

1274 
pkt_off
 +ð
dp
->
rx_off£t
;

1275 
m‘a_off
 = 
pkt_off
 - 
m‘a_Ën
;

1278 
	`u64_¡©s_upd©e_begš
(&
r_vec
->
rx_sync
);

1279 
r_vec
->
rx_pkts
++;

1280 
r_vec
->
rx_by‹s
 +ð
pkt_Ën
;

1281 
	`u64_¡©s_upd©e_’d
(&
r_vec
->
rx_sync
);

1283 
	`nå_Ãt_dma_sync_ýu_rx
(
dp
, 
rxbuf
->
dma_addr
 + 
m‘a_off
, 
d©a_Ën
);

1285 ià(
	`uÆik–y
(!
	`nå_ù¾_m‘a_ok
(
Â
, 
rxbuf
->
äag
 + 
m‘a_off
, 
m‘a_Ën
))) {

1286 
	`Â_dp_w¬n
(
dp
, "incorrect metadata for ctrl…acket (%d)\n",

1287 
m‘a_Ën
);

1288 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

1289  
Œue
;

1292 
skb
 = 
	`bužd_skb
(
rxbuf
->
äag
, 
dp
->
æ_bufsz
);

1293 ià(
	`uÆik–y
(!
skb
)) {

1294 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
NULL
);

1295  
Œue
;

1297 
Ãw_äag
 = 
	`nå_nfdk_Çpi_®loc_Úe
(
dp
, &
Ãw_dma_addr
);

1298 ià(
	`uÆik–y
(!
Ãw_äag
)) {

1299 
	`nå_nfdk_rx_drÝ
(
dp
, 
r_vec
, 
rx_ršg
, 
rxbuf
, 
skb
);

1300  
Œue
;

1303 
	`nå_Ãt_dma_unm­_rx
(
dp
, 
rxbuf
->
dma_addr
);

1305 
	`nå_nfdk_rx_give_Úe
(
dp
, 
rx_ršg
, 
Ãw_äag
, 
Ãw_dma_addr
);

1307 
	`skb_»£rve
(
skb
, 
pkt_off
);

1308 
	`skb_put
(
skb
, 
pkt_Ën
);

1310 
	`nå_­p_ù¾_rx
(
Â
->
­p
, 
skb
);

1312  
Œue
;

1313 
	}
}

1315 
boÞ
 
	$nå_ù¾_rx
(
nå_Ãt_r_veùÜ
 *
r_vec
)

1317 
nå_Ãt_rx_ršg
 *
rx_ršg
 = 
r_vec
->rx_ring;

1318 
nå_Ãt
 *
Â
 = 
r_vec
->nfp_net;

1319 
nå_Ãt_dp
 *
dp
 = &
Â
->dp;

1320 
budg‘
 = 512;

1322 
	`nå_ù¾_rx_Úe
(
Â
, 
dp
, 
r_vec
, 
rx_ršg
è&& 
budg‘
--)

1325  
budg‘
;

1326 
	}
}

1329 
	$nå_nfdk_ù¾_pÞl
(
¬g
)

1331 #ifdeà
CONFIG_NFP_NET_PF


1332 
nå_Ãt_r_veùÜ
 *
r_vec
 = (*)
¬g
;

1334 
	`¥š_lock
(&
r_vec
->
lock
);

1335 
	`nå_nfdk_tx_com¶‘e
(
r_vec
->
tx_ršg
, 0);

1336 
	`__nå_ù¾_tx_queued
(
r_vec
);

1337 
	`¥š_uÆock
(&
r_vec
->
lock
);

1339 ià(
	`nå_ù¾_rx
(
r_vec
)) {

1340 
	`nå_Ãt_œq_unmask
(
r_vec
->
nå_Ãt
,„_vec->
œq_’Œy
);

1342 
	`skËt_scheduË
(&
r_vec
->
skËt
);

1343 
	`Â_dp_w¬n
(&
r_vec
->
nå_Ãt
->
dp
,

1347 
	}
}

	@src/nfdk/nfdk.h

4 #iâdeà
_NFP_DP_NFDK_H_


5 
	#_NFP_DP_NFDK_H_


	)

7 
	~<lšux/b™Ýs.h
>

8 
	~<lšux/ty³s.h
>

10 
	#NFDK_TX_DESC_PER_SIMPLE_PKT
 2

	)

12 
	#NFDK_TX_MAX_DATA_PER_HEAD
 
SZ_4K


	)

13 
	#NFDK_TX_MAX_DATA_PER_DESC
 
SZ_16K


	)

14 
	#NFDK_TX_DESC_BLOCK_SZ
 256

	)

15 
	#NFDK_TX_DESC_BLOCK_CNT
 (
NFDK_TX_DESC_BLOCK_SZ
 / \

16 (
nå_nfdk_tx_desc
))

	)

17 
	#NFDK_TX_DESC_STOP_CNT
 (
NFDK_TX_DESC_BLOCK_CNT
 * \

18 
NFDK_TX_DESC_PER_SIMPLE_PKT
)

	)

19 
	#NFDK_TX_MAX_DATA_PER_BLOCK
 
SZ_64K


	)

20 
	#NFDK_TX_DESC_GATHER_MAX
 17

	)

24 
	#NFDK_DESC_TX_MSS_MASK
 
	`GENMASK
(13, 0)

	)

26 
	#NFDK_DESC_TX_CHAIN_META
 
	`BIT
(3)

	)

27 
	#NFDK_DESC_TX_ENCAP
 
	`BIT
(2)

	)

28 
	#NFDK_DESC_TX_L4_CSUM
 
	`BIT
(1)

	)

29 
	#NFDK_DESC_TX_L3_CSUM
 
	`BIT
(0)

	)

31 
	#NFDK_DESC_TX_DMA_LEN_HEAD
 
	`GENMASK
(11, 0)

	)

32 
	#NFDK_DESC_TX_TYPE_HEAD
 
	`GENMASK
(15, 12)

	)

33 
	#NFDK_DESC_TX_DMA_LEN
 
	`GENMASK
(13, 0)

	)

34 
	#NFDK_DESC_TX_TYPE_NOP
 0

	)

35 
	#NFDK_DESC_TX_TYPE_GATHER
 1

	)

36 
	#NFDK_DESC_TX_TYPE_TSO
 2

	)

37 
	#NFDK_DESC_TX_TYPE_SIMPLE
 8

	)

38 
	#NFDK_DESC_TX_EOP
 
	`BIT
(14)

	)

40 
	#NFDK_META_LEN
 
	`GENMASK
(7, 0)

	)

41 
	#NFDK_META_FIELDS
 
	`GENMASK
(31, 8)

	)

43 
	#D_BLOCK_CPL
(
idx
è(
NFDK_TX_DESC_BLOCK_CNT
 - \

44 (
idx
è% 
NFDK_TX_DESC_BLOCK_CNT
)

	)

46 
	snå_nfdk_tx_desc
 {

49 
__Ë16
 
	mdma_addr_hi
;

50 
__Ë16
 
	mdma_Ën_ty³
;

51 
__Ë32
 
	mdma_addr_lo
;

55 
__Ë16
 
	mmss
;

56 
u8
 
	mlso_hd¾’
;

57 
u8
 
	mlso_tÙ£gs
;

58 
u8
 
	ml3_off£t
;

59 
u8
 
	ml4_off£t
;

60 
__Ë16
 
	mlso_m‘a_»s
;

64 
u8
 
	mæags
;

65 
u8
 
	m»£rved
[7];

68 
__Ë32
 
	mv®s
[2];

69 
__Ë64
 
	m¿w
;

73 
	snå_nfdk_tx_buf
 {

77 
sk_buff
 *
	mskb
;

78 *
	mäag
;

82 
dma_addr_t
 
	mdma_addr
;

86 
u32
 
	mpkt_út
;

87 
u32
 
	m»®_Ën
;

90 
u64
 
	m¿w
;

94 
šlše
 
	$nå_nfdk_h—dËn_to_£gs
(
h—dËn
)

97  
	`DIV_ROUND_UP
(
h—dËn
 +

98 
NFDK_TX_MAX_DATA_PER_DESC
 -

99 
NFDK_TX_MAX_DATA_PER_HEAD
,

100 
NFDK_TX_MAX_DATA_PER_DESC
);

101 
	}
}

103 
nå_nfdk_pÞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
);

104 
nå_nfdk_ù¾_pÞl
(
¬g
);

105 
nå_nfdk_rx_ršg_fžl_ä“li¡
(
nå_Ãt_dp
 *
dp
,

106 
nå_Ãt_rx_ršg
 *
rx_ršg
);

	@src/nfdk/rings.c

4 
	~"../nå_Ãt_com·t.h
"

6 
	~<lšux/£q_fže.h
>

8 
	~"../nå_Ãt.h
"

9 
	~"../nå_Ãt_dp.h
"

10 
	~"nfdk.h
"

13 
	$nå_nfdk_tx_ršg_»£t
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_tx_ršg
 *
tx_ršg
)

15 
deviû
 *
dev
 = 
dp
->dev;

16 
Ãtdev_queue
 *
nd_q
;

18 !
tx_ršg
->
is_xdp
 &&x_ršg->
rd_p
 !ðtx_ršg->
wr_p
) {

19 cÚ¡ 
skb_äag_¡ruù
 *
äag
, *
ãnd
;

20 
size
, 
n_descs
 = 1;

21 
nå_nfdk_tx_buf
 *
txbuf
;

22 
Ä_äags
, 
rd_idx
;

23 
sk_buff
 *
skb
;

25 
rd_idx
 = 
	`D_IDX
(
tx_ršg
,x_ršg->
rd_p
);

26 
txbuf
 = &
tx_ršg
->
ktxbufs
[
rd_idx
];

28 
skb
 = 
txbuf
->skb;

29 ià(!
skb
) {

30 
n_descs
 = 
	`D_BLOCK_CPL
(
tx_ršg
->
rd_p
);

31 
Ãxt
;

34 
Ä_äags
 = 
	`skb_shšfo
(
skb
)->nr_frags;

35 
txbuf
++;

38 
size
 = 
	`skb_h—dËn
(
skb
);

39 
	`dma_unm­_sšgË
(
dev
, 
txbuf
->
dma_addr
, 
size
, 
DMA_TO_DEVICE
);

40 
n_descs
 +ð
	`nå_nfdk_h—dËn_to_£gs
(
size
);

41 
txbuf
++;

43 
äag
 = 
	`skb_shšfo
(
skb
)->
äags
;

44 
ãnd
 = 
äag
 + 
Ä_äags
;

45 ; 
äag
 < 
ãnd
; frag++) {

46 
size
 = 
	`skb_äag_size
(
äag
);

47 
	`dma_unm­_·ge
(
dev
, 
txbuf
->
dma_addr
,

48 
	`skb_äag_size
(
äag
), 
DMA_TO_DEVICE
);

49 
n_descs
 +ð
	`DIV_ROUND_UP
(
size
,

50 
NFDK_TX_MAX_DATA_PER_DESC
);

51 
txbuf
++;

54 ià(
	`skb_is_gso
(
skb
))

55 
n_descs
++;

57 
	`dev_kä“_skb_ªy
(
skb
);

58 
Ãxt
:

59 
tx_ršg
->
rd_p
 +ð
n_descs
;

62 
	`mem£t
(
tx_ršg
->
txds
, 0,x_ršg->
size
);

63 
tx_ršg
->
d©a_³ndšg
 = 0;

64 
tx_ršg
->
wr_p
 = 0;

65 
tx_ršg
->
rd_p
 = 0;

66 
tx_ršg
->
qý_rd_p
 = 0;

67 
tx_ršg
->
wr_±r_add
 = 0;

69 ià(
tx_ršg
->
is_xdp
 || !
dp
->
Ãtdev
)

72 
nd_q
 = 
	`Ãtdev_g‘_tx_queue
(
dp
->
Ãtdev
, 
tx_ršg
->
idx
);

73 
	`Ãtdev_tx_»£t_queue
(
nd_q
);

74 
	}
}

76 
	$nå_nfdk_tx_ršg_ä“
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

78 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
tx_ršg
->r_vec;

79 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

81 
	`kvä“
(
tx_ršg
->
ktxbufs
);

83 ià(
tx_ršg
->
ktxds
)

84 
	`dma_ä“_coh”’t
(
dp
->
dev
, 
tx_ršg
->
size
,

85 
tx_ršg
->
ktxds
,x_ršg->
dma
);

87 
tx_ršg
->
út
 = 0;

88 
tx_ršg
->
txbufs
 = 
NULL
;

89 
tx_ršg
->
txds
 = 
NULL
;

90 
tx_ršg
->
dma
 = 0;

91 
tx_ršg
->
size
 = 0;

92 
	}
}

95 
	$nå_nfdk_tx_ršg_®loc
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_tx_ršg
 *
tx_ršg
)

97 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
tx_ršg
->r_vec;

99 
tx_ršg
->
út
 = 
dp
->
txd_út
 * 
NFDK_TX_DESC_PER_SIMPLE_PKT
;

100 
tx_ršg
->
size
 = 
	`¬¿y_size
Ñx_ršg->
út
, (*tx_ršg->
ktxds
));

101 
tx_ršg
->
ktxds
 = 
	`dma_z®loc_coh”’t
(
dp
->
dev
,x_ršg->
size
,

102 &
tx_ršg
->
dma
,

103 
GFP_KERNEL
 | 
__GFP_NOWARN
);

104 ià(!
tx_ršg
->
ktxds
) {

105 
	`Ãtdev_w¬n
(
dp
->
Ãtdev
, "failedo‡llocate TX descriptor„ing memory,„equested descriptor count: %d, consider†owering descriptor count\n",

106 
tx_ršg
->
út
);

107 
”r_®loc
;

110 
tx_ršg
->
txbufs
 = 
	`kvÿÎoc
Ñx_ršg->
út
, (*tx_ršg->
ktxbufs
),

111 
GFP_KERNEL
);

112 ià(!
tx_ršg
->
ktxbufs
)

113 
”r_®loc
;

115 ià(!
tx_ršg
->
is_xdp
 && 
dp
->
Ãtdev
)

116 
	`Ãtif_£t_xps_queue
(
dp
->
Ãtdev
, &
r_vec
->
affš™y_mask
,

117 
tx_ršg
->
idx
);

121 
”r_®loc
:

122 
	`nå_nfdk_tx_ršg_ä“
(
tx_ršg
);

123  -
ENOMEM
;

124 
	}
}

127 
	$nå_nfdk_tx_ršg_bufs_ä“
(
nå_Ãt_dp
 *
dp
,

128 
nå_Ãt_tx_ršg
 *
tx_ršg
)

130 
	}
}

133 
	$nå_nfdk_tx_ršg_bufs_®loc
(
nå_Ãt_dp
 *
dp
,

134 
nå_Ãt_tx_ršg
 *
tx_ršg
)

136  
tx_ršg
->
is_xdp
 ? -
ENOMEM
 : 0;

137 
	}
}

140 
	$nå_nfdk_´št_tx_descs
(
£q_fže
 *
fže
,

141 
nå_Ãt_r_veùÜ
 *
r_vec
,

142 
nå_Ãt_tx_ršg
 *
tx_ršg
,

143 
u32
 
d_rd_p
, u32 
d_wr_p
)

145 
nå_nfdk_tx_desc
 *
txd
;

146 
u32
 
txd_út
 = 
tx_ršg
->
út
;

147 
i
;

149 
i
 = 0; i < 
txd_út
; i++) {

150 
txd
 = &
tx_ršg
->
ktxds
[
i
];

152 
	`£q_´štf
(
fže
, "%04d: 0x%08x 0x%08x 0x%016Îx", 
i
,

153 
txd
->
v®s
[0],xd->v®s[1], 
tx_ršg
->
ktxbufs
[
i
].
¿w
);

155 ià(
i
 =ð
tx_ršg
->
rd_p
 % 
txd_út
)

156 
	`£q_puts
(
fže
, " H_RD");

157 ià(
i
 =ð
tx_ršg
->
wr_p
 % 
txd_út
)

158 
	`£q_puts
(
fže
, " H_WR");

159 ià(
i
 =ð
d_rd_p
 % 
txd_út
)

160 
	`£q_puts
(
fže
, " D_RD");

161 ià(
i
 =ð
d_wr_p
 % 
txd_út
)

162 
	`£q_puts
(
fže
, " D_WR");

164 
	`£q_putc
(
fže
, '\n');

166 
	}
}

168 
	#NFP_NFDK_CFG_CTRL_SUPPORTED
 \

169 (
NFP_NET_CFG_CTRL_ENABLE
 | 
NFP_NET_CFG_CTRL_PROMISC
 | \

170 
NFP_NET_CFG_CTRL_L2BC
 | 
NFP_NET_CFG_CTRL_L2MC
 | \

171 
NFP_NET_CFG_CTRL_RXCSUM
 | 
NFP_NET_CFG_CTRL_TXCSUM
 | \

172 
NFP_NET_CFG_CTRL_RXVLAN
 | \

173 
NFP_NET_CFG_CTRL_GATHER
 | 
NFP_NET_CFG_CTRL_LSO
 | \

174 
NFP_NET_CFG_CTRL_CTAG_FILTER
 | 
NFP_NET_CFG_CTRL_CMSG_DATA
 | \

175 
NFP_NET_CFG_CTRL_RINGCFG
 | 
NFP_NET_CFG_CTRL_IRQMOD
 | \

176 
NFP_NET_CFG_CTRL_TXRWB
 | \

177 
NFP_NET_CFG_CTRL_VXLAN
 | 
NFP_NET_CFG_CTRL_NVGRE
 | \

178 
NFP_NET_CFG_CTRL_BPF
 | 
NFP_NET_CFG_CTRL_LSO2
 | \

179 
NFP_NET_CFG_CTRL_RSS2
 | 
NFP_NET_CFG_CTRL_CSUM_COMPLETE
 | \

180 
NFP_NET_CFG_CTRL_LIVE_ADDR
)

	)

182 cÚ¡ 
nå_dp_Ýs
 
	gnå_nfdk_Ýs
 = {

183 .
v”siÚ
 = 
NFP_NFD_VER_NFDK
,

184 .
	gtx_mš_desc_³r_pkt
 = 
NFDK_TX_DESC_PER_SIMPLE_PKT
,

185 .
	gÿp_mask
 = 
NFP_NFDK_CFG_CTRL_SUPPORTED
,

186 .
	gpÞl
 = 
nå_nfdk_pÞl
,

187 .
	gù¾_pÞl
 = 
nå_nfdk_ù¾_pÞl
,

188 .
	grx_ršg_fžl_ä“li¡
 = 
nå_nfdk_rx_ršg_fžl_ä“li¡
,

189 .
	gtx_ršg_®loc
 = 
nå_nfdk_tx_ršg_®loc
,

190 .
	gtx_ršg_»£t
 = 
nå_nfdk_tx_ršg_»£t
,

191 .
	gtx_ršg_ä“
 = 
nå_nfdk_tx_ršg_ä“
,

192 .
	gtx_ršg_bufs_®loc
 = 
nå_nfdk_tx_ršg_bufs_®loc
,

193 .
	gtx_ršg_bufs_ä“
 = 
nå_nfdk_tx_ršg_bufs_ä“
,

194 .
	g´št_tx_descs
 = 
nå_nfdk_´št_tx_descs


	@src/nfp.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

6 
MODULE_INFO
(
Çme
, 
KBUILD_MODNAME
);

8 
__visibË
 
moduË
 
__this_moduË


9 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

10 .
Çme
 = 
KBUILD_MODNAME
,

11 .
	gš™
 = 
š™_moduË
,

12 #ifdeà
CONFIG_MODULE_UNLOAD


13 .
	gex™
 = 
þ—nup_moduË
,

15 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

18 #ifdeà
RETPOLINE


19 
MODULE_INFO
(
»Þše
, "Y");

22 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

23 
__u£d


24 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

338 cÚ¡ 
	g__moduË_d•’ds
[]

339 
__u£d


340 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

343 
MODULE_ALIAS
("pci:v000019EEd00003800sv000019EEsd*bc*sc*i*");

344 
MODULE_ALIAS
("pci:v000019EEd00004000sv000019EEsd*bc*sc*i*");

345 
MODULE_ALIAS
("pci:v000019EEd00005000sv000019EEsd*bc*sc*i*");

346 
MODULE_ALIAS
("pci:v000019EEd00006000sv000019EEsd*bc*sc*i*");

347 
MODULE_ALIAS
("pci:v000019EEd00003803sv000019EEsd*bc*sc*i*");

348 
MODULE_ALIAS
("pci:v000019EEd00006003sv000019EEsd*bc*sc*i*");

350 
MODULE_INFO
(
¤cv”siÚ
, "8D36663F0E3271ACFEC2C40");

	@src/nfp_abi.h

4 #iâdeà
__NFP_ABI__


5 
	#__NFP_ABI__
 1

	)

7 
	~<lšux/ty³s.h
>

9 
	#NFP_MBOX_SYM_NAME
 "_abi_nfd_pf%u_mbox"

	)

10 
	#NFP_MBOX_SYM_MIN_SIZE
 16

	)

12 
	#NFP_MBOX_CMD
 0x00

	)

13 
	#NFP_MBOX_RET
 0x04

	)

14 
	#NFP_MBOX_DATA_LEN
 0x08

	)

15 
	#NFP_MBOX_RESERVED
 0x0c

	)

16 
	#NFP_MBOX_DATA
 0x10

	)

43 
	enå_mbox_cmd
 {

44 
	mNFP_MBOX_NO_CMD
 = 0x00,

46 
	mNFP_MBOX_POOL_GET
 = 0x01,

47 
	mNFP_MBOX_POOL_SET
 = 0x02,

49 
	mNFP_MBOX_PCIE_ABM_ENABLE
 = 0x03,

50 
	mNFP_MBOX_PCIE_ABM_DISABLE
 = 0x04,

53 
	#NFP_SHARED_BUF_COUNT_SYM_NAME
 "_abi_nfd_pf%u_sb_út"

	)

54 
	#NFP_SHARED_BUF_TABLE_SYM_NAME
 "_abi_nfd_pf%u_sb_tbl"

	)

67 
	snå_sh¬ed_buf
 {

68 
__Ë32
 
	mid
;

69 
__Ë32
 
	msize
;

70 
__Ë16
 
	mšg»ss_poÞs_couÁ
;

71 
__Ë16
 
	meg»ss_poÞs_couÁ
;

72 
__Ë16
 
	mšg»ss_tc_couÁ
;

73 
__Ë16
 
	meg»ss_tc_couÁ
;

75 
__Ë32
 
	mpoÞ_size_un™
;

83 
	snå_sh¬ed_buf_poÞ_id
 {

84 
__Ë32
 
	msh¬ed_buf
;

85 
__Ë32
 
	mpoÞ
;

94 
	snå_sh¬ed_buf_poÞ_šfo_g‘
 {

95 
__Ë32
 
	mpoÞ_ty³
;

96 
__Ë32
 
	msize
;

97 
__Ë32
 
	mth»shÞd_ty³
;

106 
	snå_sh¬ed_buf_poÞ_šfo_£t
 {

107 
nå_sh¬ed_buf_poÞ_id
 
	mid
;

108 
__Ë32
 
	msize
;

109 
__Ë32
 
	mth»shÞd_ty³
;

	@src/nfp_app.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/bug.h
>

7 
	~<lšux/lockd•.h
>

8 
	~<lšux/rcupd©e.h
>

9 
	~<lšux/skbuff.h
>

10 
	~<lšux/¦ab.h
>

12 
	~"nåcÜe/nå_ýp.h
"

13 
	~"nåcÜe/nå_nffw.h
"

14 
	~"nå_­p.h
"

15 
	~"nå_maš.h
"

16 
	~"nå_Ãt.h
"

17 
	~"nå_Ãt_»´.h
"

18 
	~"nå_pÜt.h
"

20 cÚ¡ 
nå_­p_ty³
 *
	g­ps
[] = {

21 #ifdeà
CONFIG_NFP_NET_PF


22 [
NFP_APP_CORE_NIC
] = &
­p_nic
,

23 [8] = &
­p_nic
,

24 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 18, 0) && \

25 
defšed
(
CONFIG_BPF_SYSCALL
)

26 [
NFP_APP_BPF_NIC
] = &
­p_bpf
,

28 [
NFP_APP_BPF_NIC
] = &
­p_nic
,

30 #ifdeà
CONFIG_NFP_APP_FLOWER


31 [
NFP_APP_FLOWER_NIC
] = &
­p_æow”
,

33 #ifdeà
CONFIG_NFP_APP_ABM_NIC


34 [
NFP_APP_ACTIVE_BUFFER_MGMT_NIC
] = &
­p_abm
,

37 
	gNULL
,

41 
	$nå_check_rhashbË_em±y
(*
±r
, *
¬g
)

43 
	`WARN_ON_ONCE
(1);

44 
	}
}

46 
nå_­p
 *
	$nå_­p_äom_Ãtdev
(
Ãt_deviû
 *
Ãtdev
)

48 ià(
	`nå_Ãtdev_is_nå_Ãt
(
Ãtdev
)) {

49 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

51  
Â
->
­p
;

54 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
)) {

55 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

57  
»´
->
­p
;

60 
	`WARN
(1, "Unknown‚etdevype for‚fp_app\n");

62  
NULL
;

63 
	}
}

65 cÚ¡ *
	$nå_­p_m_Çme
(
nå_­p
 *
­p
)

67 ià(!
­p
 || !­p->
pf
->
m
)

69  
	`nå_m_Çme
(
­p
->
pf
->
m
);

70 
	}
}

72 
	$nå_­p_ndo_š™
(
Ãt_deviû
 *
Ãtdev
)

74 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

76 ià(!
­p
 || !­p->
ty³
->
ndo_š™
)

78  
­p
->
ty³
->
	`ndo_š™
×µ, 
Ãtdev
);

79 
	}
}

81 
	$nå_­p_ndo_unš™
(
Ãt_deviû
 *
Ãtdev
)

83 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

85 ià(
­p
 &&‡µ->
ty³
->
ndo_unš™
)

86 
­p
->
ty³
->
	`ndo_unš™
×µ, 
Ãtdev
);

87 
	}
}

89 
u64
 *
	$nå_­p_pÜt_g‘_¡©s
(
nå_pÜt
 *
pÜt
, 
u64
 *
d©a
)

91 ià(!
pÜt
 || !pÜt->
­p
 || !pÜt->­p->
ty³
->
pÜt_g‘_¡©s
)

92  
d©a
;

93  
pÜt
->
­p
->
ty³
->
	`pÜt_g‘_¡©s
ÕÜt->­p,…Üt, 
d©a
);

94 
	}
}

96 
	$nå_­p_pÜt_g‘_¡©s_couÁ
(
nå_pÜt
 *
pÜt
)

98 ià(!
pÜt
 || !pÜt->
­p
 || !pÜt->­p->
ty³
->
pÜt_g‘_¡©s_couÁ
)

100  
pÜt
->
­p
->
ty³
->
	`pÜt_g‘_¡©s_couÁ
(port->app,…ort);

101 
	}
}

103 
u8
 *
	$nå_­p_pÜt_g‘_¡©s_¡ršgs
(
nå_pÜt
 *
pÜt
, 
u8
 *
d©a
)

105 ià(!
pÜt
 || !pÜt->
­p
 || !pÜt->­p->
ty³
->
pÜt_g‘_¡©s_¡ršgs
)

106  
d©a
;

107  
pÜt
->
­p
->
ty³
->
	`pÜt_g‘_¡©s_¡ršgs
ÕÜt->­p,…Üt, 
d©a
);

108 
	}
}

110 
sk_buff
 *

111 
	$nå_­p_ù¾_msg_®loc
(
nå_­p
 *
­p
, 
size
, 
gå_t
 
´iÜ™y
)

113 
sk_buff
 *
skb
;

115 ià(
	`nå_­p_ù¾_has_m‘a
(
­p
))

116 
size
 += 8;

118 
skb
 = 
	`®loc_skb
(
size
, 
´iÜ™y
);

119 ià(!
skb
)

120  
NULL
;

122 ià(
	`nå_­p_ù¾_has_m‘a
(
­p
))

123 
	`skb_»£rve
(
skb
, 8);

125  
skb
;

126 
	}
}

128 
nå_»´s
 *

129 
	$nå_»´s_g‘_locked
(
nå_­p
 *
­p
, 
nå_»´_ty³
 
ty³
)

131  
	`rcu_d”eã»nû_´Ùeùed
(
­p
->
»´s
[
ty³
],

132 
	`lockd•_is_h–d
(&
­p
->
pf
->
lock
));

133 
	}
}

135 
nå_»´s
 *

136 
	$nå_­p_»´s_£t
(
nå_­p
 *
­p
, 
nå_»´_ty³
 
ty³
,

137 
nå_»´s
 *
»´s
)

139 
nå_»´s
 *
Þd
;

141 
Þd
 = 
	`nå_»´s_g‘_locked
(
­p
, 
ty³
);

142 
	`¹Æ_lock
();

143 
	`rcu_assign_poš‹r
(
­p
->
»´s
[
ty³
],„eprs);

144 
	`¹Æ_uÆock
();

146  
Þd
;

147 
	}
}

150 
	$nå_­p_Ãtdev_ã©_chªge
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

152 
nå_Ãt
 *
Â
;

153 
ty³
;

155 ià(!
	`nå_Ãtdev_is_nå_Ãt
(
Ãtdev
))

157 
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

158 ià(
Â
->
­p
 !=‡pp)

161 
ty³
 = 0;y³ < 
__NFP_REPR_TYPE_MAX
;ype++) {

162 
nå_»´s
 *
»´s
;

163 
i
;

165 
»´s
 = 
	`¹Æ_d”eã»nû
(
­p
->»´s[
ty³
]);

166 ià(!
»´s
)

169 
i
 = 0; i < 
»´s
->
num_»´s
; i++) {

170 
Ãt_deviû
 *
»´
;

172 
»´
 = 
	`¹Æ_d”eã»nû
(
»´s
->»´s[
i
]);

173 ià(!
»´
)

176 
	`nå_»´_Œªsãr_ã©u»s
(
»´
, 
Ãtdev
);

179 
	}
}

182 
	$nå_­p_Ãtdev_ev’t
(
nÙif›r_block
 *
nb
, 
ev’t
, *
±r
)

184 
Ãt_deviû
 *
Ãtdev
;

185 
nå_­p
 *
­p
;

187 
Ãtdev
 = 
	`Ãtdev_nÙif›r_šfo_to_dev
(
±r
);

188 
­p
 = 
	`cÚš”_of
(
nb
, 
nå_­p
, 
Ãtdev_nb
);

191 
ev’t
) {

192 
NETDEV_FEAT_CHANGE
:

193 
	`nå_­p_Ãtdev_ã©_chªge
(
­p
, 
Ãtdev
);

198 ià(
­p
->
ty³
->
Ãtdev_ev’t
)

199  
­p
->
ty³
->
	`Ãtdev_ev’t
×µ, 
Ãtdev
, 
ev’t
, 
±r
);

200  
NOTIFY_DONE
;

201 
	}
}

203 
	$nå_­p_¡¬t
(
nå_­p
 *
­p
, 
nå_Ãt
 *
ù¾
)

205 
”r
;

207 
­p
->
ù¾
 = ctrl;

209 ià(
­p
->
ty³
->
¡¬t
) {

210 
”r
 = 
­p
->
ty³
->
	`¡¬t
(app);

211 ià(
”r
)

212  
”r
;

215 
­p
->
Ãtdev_nb
.
nÙif›r_ÿÎ
 = 
nå_­p_Ãtdev_ev’t
;

216 
”r
 = 
	`»gi¡”_Ãtdeviû_nÙif›r
(&
­p
->
Ãtdev_nb
);

217 ià(
”r
)

218 
”r_­p_¡Ý
;

222 
”r_­p_¡Ý
:

223 ià(
­p
->
ty³
->
¡Ý
)

224 
­p
->
ty³
->
	`¡Ý
(app);

225  
”r
;

226 
	}
}

228 
	$nå_­p_¡Ý
(
nå_­p
 *
­p
)

230 
	`uÄegi¡”_Ãtdeviû_nÙif›r
(&
­p
->
Ãtdev_nb
);

232 ià(
­p
->
ty³
->
¡Ý
)

233 
­p
->
ty³
->
	`¡Ý
(app);

234 
	}
}

236 
nå_­p
 *
	$nå_­p_®loc
(
nå_pf
 *
pf
, 
nå_­p_id
 
id
)

238 
nå_­p
 *
­p
;

240 ià(
id
 >ð
	`ARRAY_SIZE
(
­ps
) || !apps[id]) {

241 
	`nå_”r
(
pf
->
ýp
, "unknowÀFW‡µ ID 0x%02hhx, driv”oØÞd o¸suµÜˆfÜ FW‚Ù bužˆš\n", 
id
);

242  
	`ERR_PTR
(-
EINVAL
);

245 ià(
	`WARN_ON
(!
­ps
[
id
]->
Çme
 || !­ps[id]->
vnic_®loc
))

246  
	`ERR_PTR
(-
EINVAL
);

247 ià(
	`WARN_ON
(!
­ps
[
id
]->
ù¾_msg_rx
 &&‡µs[id]->
ù¾_msg_rx_¿w
))

248  
	`ERR_PTR
(-
EINVAL
);

250 
­p
 = 
	`kz®loc
((*­p), 
GFP_KERNEL
);

251 ià(!
­p
)

252  
	`ERR_PTR
(-
ENOMEM
);

254 
­p
->
pf
 =…f;

255 
­p
->
ýp
 = 
pf
->cpp;

256 
­p
->
pdev
 = 
pf
->pdev;

257 
­p
->
ty³
 = 
­ps
[
id
];

259  
­p
;

260 
	}
}

262 
	$nå_­p_ä“
(
nå_­p
 *
­p
)

264 
	`kä“
(
­p
);

265 
	}
}

	@src/nfp_app.h

4 #iâdeà
_NFP_APP_H


5 
	#_NFP_APP_H
 1

	)

7 
	~"nå_Ãt_com·t.h
"

9 #ià
COMPAT__HAS_DEVLINK


10 
	~<Ãt/devlšk.h
>

13 #ià
VER_NON_RHEL_GE
(4, 8è|| 
VER_RHEL_GE
(7, 5)

14 
	~<Œaû/ev’ts/devlšk.h
>

17 
	~"nå_Ãt_»´.h
"

19 
	#NFP_APP_CTRL_MTU_MAX
 
U32_MAX


	)

21 
	gbpf_´og
;

22 
	gÃt_deviû
;

23 
	gÃtdev_bpf
;

24 
	gÃŽšk_ext_ack
;

25 
	gpci_dev
;

26 
	gsk_buff
;

27 
	gsk_buff
;

28 
	gnå_­p
;

29 
	gnå_ýp
;

30 
	gnå_pf
;

31 
	gnå_»´
;

32 
	gnå_Ãt
;

34 
	enå_­p_id
 {

35 
	mNFP_APP_CORE_NIC
 = 0x1,

36 
	mNFP_APP_BPF_NIC
 = 0x2,

37 
	mNFP_APP_FLOWER_NIC
 = 0x3,

38 
	mNFP_APP_ACTIVE_BUFFER_MGMT_NIC
 = 0x4,

41 cÚ¡ 
nå_­p_ty³
 
­p_nic
;

42 cÚ¡ 
nå_­p_ty³
 
­p_bpf
;

43 cÚ¡ 
nå_­p_ty³
 
­p_æow”
;

44 cÚ¡ 
nå_­p_ty³
 
­p_abm
;

90 
	snå_­p_ty³
 {

91 
nå_­p_id
 
	mid
;

92 cÚ¡ *
	mÇme
;

94 
u32
 
	mù¾_ÿp_mask
;

95 
boÞ
 
	mù¾_has_m‘a
;

97 (*
	mš™
)(
nå_­p
 *
	m­p
);

98 (*
	mþ—n
)(
nå_­p
 *
	m­p
);

100 cÚ¡ *(*
	mexŒa_ÿp
)(
nå_­p
 *
	m­p
, 
nå_Ãt
 *
	mÂ
);

102 (*
	mndo_š™
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
);

103 (*
	mndo_unš™
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
);

105 (*
	mvnic_®loc
)(
nå_­p
 *
	m­p
, 
nå_Ãt
 *
	mÂ
,

106 
	mid
);

107 (*
	mvnic_ä“
)(
nå_­p
 *
	m­p
, 
nå_Ãt
 *
	mÂ
);

108 (*
	mvnic_š™
)(
nå_­p
 *
	m­p
, 
nå_Ãt
 *
	mÂ
);

109 (*
	mvnic_þ—n
)(
nå_­p
 *
	m­p
, 
nå_Ãt
 *
	mÂ
);

111 (*
	m»´_š™
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
);

112 (*
	m»´_´eþ—n
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
);

113 (*
	m»´_þ—n
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
);

115 (*
	m»´_Ý’
)(
nå_­p
 *
	m­p
, 
nå_»´
 *
	m»´
);

116 (*
	m»´_¡Ý
)(
nå_­p
 *
	m­p
, 
nå_»´
 *
	m»´
);

118 (*
	mcheck_mtu
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
,

119 
	mÃw_mtu
);

120 (*
	m»´_chªge_mtu
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
,

121 
	mÃw_mtu
);

123 
	mu64
 *(*
	mpÜt_g‘_¡©s
)(
nå_­p
 *
	m­p
,

124 
nå_pÜt
 *
	mpÜt
, 
u64
 *
	md©a
);

125 (*
	mpÜt_g‘_¡©s_couÁ
)(
nå_­p
 *
	m­p
, 
nå_pÜt
 *
	mpÜt
);

126 
	mu8
 *(*
	mpÜt_g‘_¡©s_¡ršgs
)(
nå_­p
 *
	m­p
,

127 
nå_pÜt
 *
	mpÜt
, 
u8
 *
	md©a
);

129 (*
	m¡¬t
)(
nå_­p
 *
	m­p
);

130 (*
	m¡Ý
)(
nå_­p
 *
	m­p
);

132 (*
	mÃtdev_ev’t
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
,

133 
	mev’t
, *
	m±r
);

135 (*
	mù¾_msg_rx
)(
nå_­p
 *
	m­p
, 
sk_buff
 *
	mskb
);

136 (*
	mù¾_msg_rx_¿w
)(
nå_­p
 *
	m­p
, cÚ¡ *
	md©a
,

137 
	mËn
);

139 (*
	m£tup_tc
)(
nå_­p
 *
	m­p
, 
Ãt_deviû
 *
	mÃtdev
,

140 
tc_£tup_ty³
 
	mty³
, *
	mty³_d©a
);

141 (*
	mbpf
)(
nå_­p
 *
	m­p
, 
nå_Ãt
 *
	mÂ
,

142 
Ãtdev_bpf
 *
	mxdp
);

143 (*
	mxdp_ofæßd
)(
nå_­p
 *
	m­p
, 
nå_Ãt
 *
	mÂ
,

144 
bpf_´og
 *
	m´og
,

145 
ÃŽšk_ext_ack
 *
	mexck
);

147 (*
	m¤iov_’abË
)(
nå_­p
 *
	m­p
, 
	mnum_vfs
);

148 (*
	m¤iov_di§bË
)(
nå_­p
 *
	m­p
);

150 
devlšk_esw™ch_mode
 (*
esw™ch_mode_g‘
)(
nå_­p
 *
	m­p
);

151 (*
	mesw™ch_mode_£t
)(
nå_­p
 *
	m­p
, 
u16
 
	mmode
);

152 
	mÃt_deviû
 *(*
	m»´_g‘
)(
nå_­p
 *
	m­p
, 
u32
 
	mid
);

167 
	snå_­p
 {

168 
pci_dev
 *
	mpdev
;

169 
nå_pf
 *
	mpf
;

170 
nå_ýp
 *
	mýp
;

172 
nå_Ãt
 *
	mù¾
;

173 
nå_»´s
 
__rcu
 *
	m»´s
[
NFP_REPR_TYPE_MAX
 + 1];

175 cÚ¡ 
nå_­p_ty³
 *
	mty³
;

176 
	mù¾_mtu
;

178 
nÙif›r_block
 
	mÃtdev_nb
;

180 *
	m´iv
;

183 
nå_check_rhashbË_em±y
(*
±r
, *
¬g
);

184 
boÞ
 
__nå_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
);

185 
boÞ
 
nå_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
);

186 
nå_ù¾_debug_rx
(
nå_pf
 *
pf
, 
sk_buff
 *
skb
);

187 
nå_ù¾_debug_d–iv”_tx
(
nå_pf
 *
pf
, 
sk_buff
 *
skb
);

189 
šlše
 
	$nå_­p_š™
(
nå_­p
 *
­p
)

191 ià(!
­p
->
ty³
->
š™
)

193  
­p
->
ty³
->
	`š™
(app);

194 
	}
}

196 
šlše
 
	$nå_­p_þ—n
(
nå_­p
 *
­p
)

198 ià(
­p
->
ty³
->
þ—n
)

199 
­p
->
ty³
->
	`þ—n
(app);

200 
	}
}

202 
nå_­p_ndo_š™
(
Ãt_deviû
 *
Ãtdev
);

203 
nå_­p_ndo_unš™
(
Ãt_deviû
 *
Ãtdev
);

205 
šlše
 
	$nå_­p_vnic_®loc
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

206 
id
)

208  
­p
->
ty³
->
	`vnic_®loc
×µ, 
Â
, 
id
);

209 
	}
}

211 
šlše
 
	$nå_­p_vnic_ä“
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

213 ià(
­p
->
ty³
->
vnic_ä“
)

214 
­p
->
ty³
->
	`vnic_ä“
×µ, 
Â
);

215 
	}
}

217 
šlše
 
	$nå_­p_vnic_š™
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

219 ià(!
­p
->
ty³
->
vnic_š™
)

221  
­p
->
ty³
->
	`vnic_š™
×µ, 
Â
);

222 
	}
}

224 
šlše
 
	$nå_­p_vnic_þ—n
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
)

226 ià(
­p
->
ty³
->
vnic_þ—n
)

227 
­p
->
ty³
->
	`vnic_þ—n
×µ, 
Â
);

228 
	}
}

230 
šlše
 
	$nå_­p_»´_Ý’
(
nå_­p
 *
­p
, 
nå_»´
 *
»´
)

232 ià(!
­p
->
ty³
->
»´_Ý’
)

233  -
EINVAL
;

234  
­p
->
ty³
->
	`»´_Ý’
×µ, 
»´
);

235 
	}
}

237 
šlše
 
	$nå_­p_»´_¡Ý
(
nå_­p
 *
­p
, 
nå_»´
 *
»´
)

239 ià(!
­p
->
ty³
->
»´_¡Ý
)

240  -
EINVAL
;

241  
­p
->
ty³
->
	`»´_¡Ý
×µ, 
»´
);

242 
	}
}

244 
šlše
 

245 
	$nå_­p_»´_š™
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

247 ià(!
­p
->
ty³
->
»´_š™
)

249  
­p
->
ty³
->
	`»´_š™
×µ, 
Ãtdev
);

250 
	}
}

252 
šlše
 

253 
	$nå_­p_»´_´eþ—n
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

255 ià(
­p
->
ty³
->
»´_´eþ—n
)

256 
­p
->
ty³
->
	`»´_´eþ—n
×µ, 
Ãtdev
);

257 
	}
}

259 
šlše
 

260 
	$nå_­p_»´_þ—n
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
)

262 ià(
­p
->
ty³
->
»´_þ—n
)

263 
­p
->
ty³
->
	`»´_þ—n
×µ, 
Ãtdev
);

264 
	}
}

266 
šlše
 

267 
	$nå_­p_check_mtu
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
, 
Ãw_mtu
)

269 ià(!
­p
 || !­p->
ty³
->
check_mtu
)

271  
­p
->
ty³
->
	`check_mtu
×µ, 
Ãtdev
, 
Ãw_mtu
);

272 
	}
}

274 
šlše
 

275 
	$nå_­p_»´_chªge_mtu
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

276 
Ãw_mtu
)

278 ià(!
­p
 || !­p->
ty³
->
»´_chªge_mtu
)

280  
­p
->
ty³
->
	`»´_chªge_mtu
×µ, 
Ãtdev
, 
Ãw_mtu
);

281 
	}
}

283 
šlše
 cÚ¡ *
	$nå_­p_Çme
(
nå_­p
 *
­p
)

285 ià(!
­p
)

287  
­p
->
ty³
->
Çme
;

288 
	}
}

290 
šlše
 
boÞ
 
	$nå_­p_Ãeds_ù¾_vnic
(
nå_­p
 *
­p
)

292  
­p
 &&‡µ->
ty³
->
ù¾_msg_rx
;

293 
	}
}

295 
šlše
 
boÞ
 
	$nå_­p_ù¾_has_m‘a
(
nå_­p
 *
­p
)

297  
­p
->
ty³
->
ù¾_has_m‘a
;

298 
	}
}

300 
šlše
 
boÞ
 
	$nå_­p_ù¾_u£s_d©a_vnics
(
nå_­p
 *
­p
)

302  
­p
 &&‡µ->
ty³
->
ù¾_msg_rx_¿w
;

303 
	}
}

305 
šlše
 cÚ¡ *
	$nå_­p_exŒa_ÿp
(
nå_­p
 *
­p
,

306 
nå_Ãt
 *
Â
)

308 ià(!
­p
 || !­p->
ty³
->
exŒa_ÿp
)

310  
­p
->
ty³
->
	`exŒa_ÿp
×µ, 
Â
);

311 
	}
}

313 
šlše
 
boÞ
 
	$nå_­p_has_tc
(
nå_­p
 *
­p
)

315  
­p
 &&‡µ->
ty³
->
£tup_tc
;

316 
	}
}

318 
šlše
 
	$nå_­p_£tup_tc
(
nå_­p
 *
­p
,

319 
Ãt_deviû
 *
Ãtdev
,

320 
tc_£tup_ty³
 
ty³
, *
ty³_d©a
)

322 ià(!
­p
 || !­p->
ty³
->
£tup_tc
)

323  -
EOPNOTSUPP
;

324  
­p
->
ty³
->
	`£tup_tc
×µ, 
Ãtdev
,y³, 
ty³_d©a
);

325 
	}
}

327 
šlše
 
	$nå_­p_bpf
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

328 
Ãtdev_bpf
 *
bpf
)

330 ià(!
­p
 || !­p->
ty³
->
bpf
)

331  -
EINVAL
;

332  
­p
->
ty³
->
	`bpf
×µ, 
Â
, 
bpf
);

333 
	}
}

335 
šlše
 
	$nå_­p_xdp_ofæßd
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

336 
bpf_´og
 *
´og
,

337 
ÃŽšk_ext_ack
 *
exck
)

339 ià(!
­p
 || !­p->
ty³
->
xdp_ofæßd
)

340  -
EOPNOTSUPP
;

341  
­p
->
ty³
->
	`xdp_ofæßd
×µ, 
Â
, 
´og
, 
exck
);

342 
	}
}

344 
šlše
 
boÞ
 
	$__nå_­p_ù¾_tx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

346 
	`Œaû_devlšk_hwmsg
(
	`´iv_to_devlšk
(
­p
->
pf
), 
çl£
, 0,

347 
skb
->
d©a
, skb->
Ën
);

349  
	`__nå_ù¾_tx
(
­p
->
ù¾
, 
skb
);

350 
	}
}

352 
šlše
 
boÞ
 
	$nå_­p_ù¾_tx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

354 
	`nå_ù¾_debug_d–iv”_tx
(
­p
->
pf
, 
skb
);

355 
	`Œaû_devlšk_hwmsg
(
	`´iv_to_devlšk
(
­p
->
pf
), 
çl£
, 0,

356 
skb
->
d©a
, skb->
Ën
);

358  
	`nå_ù¾_tx
(
­p
->
ù¾
, 
skb
);

359 
	}
}

361 
šlše
 
	$nå_­p_ù¾_rx
(
nå_­p
 *
­p
, 
sk_buff
 *
skb
)

363 
	`nå_ù¾_debug_rx
(
­p
->
pf
, 
skb
);

364 
	`Œaû_devlšk_hwmsg
(
	`´iv_to_devlšk
(
­p
->
pf
), 
Œue
, 0,

365 
skb
->
d©a
, skb->
Ën
);

367 
­p
->
ty³
->
	`ù¾_msg_rx
×µ, 
skb
);

368 
	}
}

370 
šlše
 

371 
	$nå_­p_ù¾_rx_¿w
(
nå_­p
 *
­p
, cÚ¡ *
d©a
, 
Ën
)

373 ià(!
­p
 || !­p->
ty³
->
ù¾_msg_rx_¿w
)

376 
	`Œaû_devlšk_hwmsg
(
	`´iv_to_devlšk
(
­p
->
pf
), 
Œue
, 0, 
d©a
, 
Ën
);

377 
­p
->
ty³
->
	`ù¾_msg_rx_¿w
×µ, 
d©a
, 
Ën
);

378 
	}
}

380 
šlše
 
	$nå_­p_esw™ch_mode_g‘
(
nå_­p
 *
­p
, 
u16
 *
mode
)

382 ià(!
­p
->
ty³
->
esw™ch_mode_g‘
)

383  -
EOPNOTSUPP
;

385 *
mode
 = 
­p
->
ty³
->
	`esw™ch_mode_g‘
(app);

388 
	}
}

390 
šlše
 
	$nå_­p_esw™ch_mode_£t
(
nå_­p
 *
­p
, 
u16
 
mode
)

392 ià(!
­p
->
ty³
->
esw™ch_mode_£t
)

393  -
EOPNOTSUPP
;

394  
­p
->
ty³
->
	`esw™ch_mode_£t
×µ, 
mode
);

395 
	}
}

397 
šlše
 
	$nå_­p_¤iov_’abË
(
nå_­p
 *
­p
, 
num_vfs
)

399 ià(!
­p
 || !­p->
ty³
->
¤iov_’abË
)

400  -
EOPNOTSUPP
;

401  
­p
->
ty³
->
	`¤iov_’abË
×µ, 
num_vfs
);

402 
	}
}

404 
šlše
 
	$nå_­p_¤iov_di§bË
(
nå_­p
 *
­p
)

406 ià(
­p
 &&‡µ->
ty³
->
¤iov_di§bË
)

407 
­p
->
ty³
->
	`¤iov_di§bË
(app);

408 
	}
}

410 
šlše
 
Ãt_deviû
 *
	$nå_­p_»´_g‘
(
nå_­p
 *
­p
, 
u32
 
id
)

412 ià(
	`uÆik–y
(!
­p
 || !­p->
ty³
->
»´_g‘
))

413  
NULL
;

415  
­p
->
ty³
->
	`»´_g‘
×µ, 
id
);

416 
	}
}

418 
nå_­p
 *
nå_­p_äom_Ãtdev
(
Ãt_deviû
 *
Ãtdev
);

420 
u64
 *
nå_­p_pÜt_g‘_¡©s
(
nå_pÜt
 *
pÜt
, u64 *
d©a
);

421 
nå_­p_pÜt_g‘_¡©s_couÁ
(
nå_pÜt
 *
pÜt
);

422 
u8
 *
nå_­p_pÜt_g‘_¡©s_¡ršgs
(
nå_pÜt
 *
pÜt
, u8 *
d©a
);

424 
nå_»´s
 *

425 
nå_»´s_g‘_locked
(
nå_­p
 *
­p
, 
nå_»´_ty³
 
ty³
);

426 
nå_»´s
 *

427 
nå_­p_»´s_£t
(
nå_­p
 *
­p
, 
nå_»´_ty³
 
ty³
,

428 
nå_»´s
 *
»´s
);

430 cÚ¡ *
nå_­p_m_Çme
(
nå_­p
 *
­p
);

431 
sk_buff
 *

432 
nå_­p_ù¾_msg_®loc
(
nå_­p
 *
­p
, 
size
, 
gå_t
 
´iÜ™y
);

434 
nå_­p
 *
nå_­p_®loc
(
nå_pf
 *
pf
, 
nå_­p_id
 
id
);

435 
nå_­p_ä“
(
nå_­p
 *
­p
);

436 
nå_­p_¡¬t
(
nå_­p
 *
­p
, 
nå_Ãt
 *
ù¾
);

437 
nå_­p_¡Ý
(
nå_­p
 *
­p
);

441 
nå_­p_nic_vnic_®loc
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

442 
id
);

443 
nå_­p_nic_vnic_š™_phy_pÜt
(
nå_pf
 *
pf
, 
nå_­p
 *
­p
,

444 
nå_Ãt
 *
Â
, 
id
);

446 
devlšk
 *
nå_devlšk_g‘_devlšk
(
Ãt_deviû
 *
Ãtdev
);

447 
devlšk_pÜt
 *
nå_devlšk_g‘_devlšk_pÜt
(
Ãt_deviû
 *
Ãtdev
);

	@src/nfp_app_nic.c

4 
	~"nåcÜe/nå_ýp.h
"

5 
	~"nåcÜe/nå_n¥.h
"

6 
	~"nå_­p.h
"

7 
	~"nå_maš.h
"

8 
	~"nå_Ãt.h
"

9 
	~"nå_pÜt.h
"

11 
	$nå_­p_nic_vnic_š™_phy_pÜt
(
nå_pf
 *
pf
, 
nå_­p
 *
­p
,

12 
nå_Ãt
 *
Â
, 
id
)

14 
”r
;

16 ià(!
pf
->
‘h_tbl
)

19 
Â
->
pÜt
 = 
	`nå_pÜt_®loc
(
­p
, 
NFP_PORT_PHYS_PORT
,‚n->
dp
.
Ãtdev
);

20 ià(
	`IS_ERR
(
Â
->
pÜt
))

21  
	`PTR_ERR
(
Â
->
pÜt
);

23 
”r
 = 
	`nå_pÜt_š™_phy_pÜt
(
pf
, 
­p
, 
Â
->
pÜt
, 
id
);

24 ià(
”r
) {

25 
	`nå_pÜt_ä“
(
Â
->
pÜt
);

26  
”r
;

29  
Â
->
pÜt
->
ty³
 =ð
NFP_PORT_INVALID
;

30 
	}
}

32 
	$nå_­p_nic_vnic_®loc
(
nå_­p
 *
­p
, 
nå_Ãt
 *
Â
,

33 
id
)

35 
”r
;

37 
”r
 = 
	`nå_­p_nic_vnic_š™_phy_pÜt
(
­p
->
pf
,‡µ, 
Â
, 
id
);

38 ià(
”r
)

39  
”r
 < 0 ?ƒrr : 0;

41 
	`nå_Ãt_g‘_mac_addr
(
­p
->
pf
, 
Â
->
dp
.
Ãtdev
,‚n->
pÜt
);

44 
	}
}

	@src/nfp_asm.c

4 
	~<lšux/b™Ýs.h
>

5 
	~<lšux/”ºo.h
>

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/ty³s.h
>

10 
	~"nå_asm.h
"

12 cÚ¡ 
cmd_tgt_aù
 
	gcmd_tgt_aù
[
__CMD_TGT_MAP_SIZE
] = {

13 [
CMD_TGT_WRITE8_SWAP
] = { 0x02, 0x42 },

14 [
CMD_TGT_WRITE32_SWAP
] = { 0x02, 0x5f },

15 [
CMD_TGT_READ8
] = { 0x01, 0x43 },

16 [
CMD_TGT_READ32
] = { 0x00, 0x5c },

17 [
CMD_TGT_READ32_LE
] = { 0x01, 0x5c },

18 [
CMD_TGT_READ32_SWAP
] = { 0x02, 0x5c },

19 [
CMD_TGT_READ_LE
] = { 0x01, 0x40 },

20 [
CMD_TGT_READ_SWAP_LE
] = { 0x03, 0x40 },

21 [
CMD_TGT_ADD
] = { 0x00, 0x47 },

22 [
CMD_TGT_ADD_IMM
] = { 0x02, 0x47 },

25 
boÞ
 
	$uÄeg_is_imm
(
u16
 
»g
)

27  (
»g
 & 
UR_REG_IMM
) == UR_REG_IMM;

28 
	}
}

30 
u16
 
	$br_g‘_off£t
(
u64
 
š¡r
)

32 
u16
 
addr_lo
, 
addr_hi
;

34 
addr_lo
 = 
	`FIELD_GET
(
OP_BR_ADDR_LO
, 
š¡r
);

35 
addr_hi
 = 
	`FIELD_GET
(
OP_BR_ADDR_HI
, 
š¡r
);

37  (
addr_hi
 * ((
OP_BR_ADDR_LO
 >> 
	`__bf_shf
(OP_BR_ADDR_LO)) + 1)) |

38 
addr_lo
;

39 
	}
}

41 
	$br_£t_off£t
(
u64
 *
š¡r
, 
u16
 
off£t
)

43 
u16
 
addr_lo
, 
addr_hi
;

45 
addr_lo
 = 
off£t
 & (
OP_BR_ADDR_LO
 >> 
	`__bf_shf
(OP_BR_ADDR_LO));

46 
addr_hi
 = 
off£t
 !ð
addr_lo
;

47 *
š¡r
 &ð~(
OP_BR_ADDR_HI
 | 
OP_BR_ADDR_LO
);

48 *
š¡r
 |ð
	`FIELD_PREP
(
OP_BR_ADDR_HI
, 
addr_hi
);

49 *
š¡r
 |ð
	`FIELD_PREP
(
OP_BR_ADDR_LO
, 
addr_lo
);

50 
	}
}

52 
	$br_add_off£t
(
u64
 *
š¡r
, 
u16
 
off£t
)

54 
u16
 
addr
;

56 
addr
 = 
	`br_g‘_off£t
(*
š¡r
);

57 
	`br_£t_off£t
(
š¡r
, 
addr
 + 
off£t
);

58 
	}
}

60 
boÞ
 
	$immed_ÿn_modify
(
u64
 
š¡r
)

62 ià(
	`FIELD_GET
(
OP_IMMED_INV
, 
š¡r
) ||

63 
	`FIELD_GET
(
OP_IMMED_SHIFT
, 
š¡r
) ||

64 
	`FIELD_GET
(
OP_IMMED_WIDTH
, 
š¡r
è!ð
IMMED_WIDTH_ALL
) {

65 
	`´_”r
("Can't decode/encode immed!\n");

66  
çl£
;

68  
Œue
;

69 
	}
}

71 
u16
 
	$immed_g‘_v®ue
(
u64
 
š¡r
)

73 
u16
 
»g
;

75 ià(!
	`immed_ÿn_modify
(
š¡r
))

78 
»g
 = 
	`FIELD_GET
(
OP_IMMED_A_SRC
, 
š¡r
);

79 ià(!
	`uÄeg_is_imm
(
»g
))

80 
»g
 = 
	`FIELD_GET
(
OP_IMMED_B_SRC
, 
š¡r
);

82  (
»g
 & 0xffè| 
	`FIELD_GET
(
OP_IMMED_IMM
, 
š¡r
) << 8;

83 
	}
}

85 
	$immed_£t_v®ue
(
u64
 *
š¡r
, 
u16
 
immed
)

87 ià(!
	`immed_ÿn_modify
(*
š¡r
))

90 ià(
	`uÄeg_is_imm
(
	`FIELD_GET
(
OP_IMMED_A_SRC
, *
š¡r
))) {

91 *
š¡r
 &ð~
	`FIELD_PREP
(
OP_IMMED_A_SRC
, 0xff);

92 *
š¡r
 |ð
	`FIELD_PREP
(
OP_IMMED_A_SRC
, 
immed
 & 0xff);

94 *
š¡r
 &ð~
	`FIELD_PREP
(
OP_IMMED_B_SRC
, 0xff);

95 *
š¡r
 |ð
	`FIELD_PREP
(
OP_IMMED_B_SRC
, 
immed
 & 0xff);

98 *
š¡r
 &ð~
OP_IMMED_IMM
;

99 *
š¡r
 |ð
	`FIELD_PREP
(
OP_IMMED_IMM
, 
immed
 >> 8);

100 
	}
}

102 
	$immed_add_v®ue
(
u64
 *
š¡r
, 
u16
 
off£t
)

104 
u16
 
v®
;

106 ià(!
	`immed_ÿn_modify
(*
š¡r
))

109 
v®
 = 
	`immed_g‘_v®ue
(*
š¡r
);

110 
	`immed_£t_v®ue
(
š¡r
, 
v®
 + 
off£t
);

111 
	}
}

113 
u16
 
	$nå_sw»g_to_uÄeg
(
sw»g
 
»g
, 
boÞ
 
is_d¡
)

115 
boÞ
 
lm_id
, 
lm_dec
 = 
çl£
;

116 
u16
 
v®
 = 
	`sw»g_v®ue
(
»g
);

118 
	`sw»g_ty³
(
»g
)) {

119 
NN_REG_GPR_A
:

120 
NN_REG_GPR_B
:

121 
NN_REG_GPR_BOTH
:

122  
v®
;

123 
NN_REG_NNR
:

124  
UR_REG_NN
 | 
v®
;

125 
NN_REG_XFER
:

126  
UR_REG_XFR
 | 
v®
;

127 
NN_REG_LMEM
:

128 
lm_id
 = 
	`sw»g_lm_idx
(
»g
);

130 
	`sw»g_lm_mode
(
»g
)) {

131 
NN_LM_MOD_NONE
:

132 ià(
v®
 & ~
UR_REG_LM_IDX_MAX
) {

133 
	`´_”r
("LM offsetoo†arge\n");

136  
UR_REG_LM
 | 
	`FIELD_PREP
(
UR_REG_LM_IDX
, 
lm_id
) |

137 
v®
;

138 
NN_LM_MOD_DEC
:

139 
lm_dec
 = 
Œue
;

141 
NN_LM_MOD_INC
:

142 ià(
v®
) {

143 
	`´_”r
("LM offset in inc/dev mode\n");

146  
UR_REG_LM
 | 
UR_REG_LM_POST_MOD
 |

147 
	`FIELD_PREP
(
UR_REG_LM_IDX
, 
lm_id
) |

148 
	`FIELD_PREP
(
UR_REG_LM_POST_MOD_DEC
, 
lm_dec
);

150 
	`´_”r
("bad LM mode for unrestricted operands %d\n",

151 
	`sw»g_lm_mode
(
»g
));

154 
NN_REG_IMM
:

155 ià(
v®
 & ~0xff) {

156 
	`´_”r
("immediateoo†arge\n");

159  
	`UR_REG_IMM_’code
(
v®
);

160 
NN_REG_NONE
:

161  
is_d¡
 ? 
UR_REG_NO_DST
 : 
REG_NONE
;

164 
	`´_”r
("uÄecognized„egƒncodšg %08x\n", 
»g
);

166 
	}
}

168 
	$sw»g_to_uÄe¡riùed
(
sw»g
 
d¡
, sw»g 
Ìeg
, sw»g 
¼eg
,

169 
nå_š¢_ur_»gs
 *
»g
)

171 
	`mem£t
(
»g
, 0, (*reg));

174 ià(
	`sw»g_ty³
(
d¡
è=ð
NN_REG_IMM
)

175  -
EFAULT
;

177 ià(
	`sw»g_ty³
(
d¡
è=ð
NN_REG_GPR_B
)

178 
»g
->
d¡_ab
 = 
ALU_DST_B
;

179 ià(
	`sw»g_ty³
(
d¡
è=ð
NN_REG_GPR_BOTH
)

180 
»g
->
wr_bÙh
 = 
Œue
;

181 
»g
->
d¡
 = 
	`nå_sw»g_to_uÄeg
(d¡, 
Œue
);

184 ià(
	`sw»g_ty³
(
Ìeg
è=ðsw»g_ty³(
¼eg
) &&

185 
	`sw»g_ty³
(
Ìeg
è!ð
NN_REG_NONE
)

186  -
EFAULT
;

188 ià(
	`sw»g_ty³
(
Ìeg
è=ð
NN_REG_GPR_B
 ||

189 
	`sw»g_ty³
(
¼eg
è=ð
NN_REG_GPR_A
) {

190 
»g
->
¬eg
 = 
	`nå_sw»g_to_uÄeg
(
¼eg
, 
çl£
);

191 
»g
->
b»g
 = 
	`nå_sw»g_to_uÄeg
(
Ìeg
, 
çl£
);

192 
»g
->
sw­
 = 
Œue
;

194 
»g
->
¬eg
 = 
	`nå_sw»g_to_uÄeg
(
Ìeg
, 
çl£
);

195 
»g
->
b»g
 = 
	`nå_sw»g_to_uÄeg
(
¼eg
, 
çl£
);

198 
»g
->
d¡_lmexŠ
 = 
	`sw»g_lmexŠ
(
d¡
);

199 
»g
->
¤c_lmexŠ
 = 
	`sw»g_lmexŠ
(
Ìeg
è| sw»g_lmexŠ(
¼eg
);

202 
	}
}

204 
u16
 
	$nå_sw»g_to_»»g
(
sw»g
 
»g
, 
boÞ
 
is_d¡
, boÞ 
has_imm8
, boÞ *
i8
)

206 
u16
 
v®
 = 
	`sw»g_v®ue
(
»g
);

207 
boÞ
 
lm_id
;

209 
	`sw»g_ty³
(
»g
)) {

210 
NN_REG_GPR_A
:

211 
NN_REG_GPR_B
:

212 
NN_REG_GPR_BOTH
:

213  
v®
;

214 
NN_REG_XFER
:

215  
RE_REG_XFR
 | 
v®
;

216 
NN_REG_LMEM
:

217 
lm_id
 = 
	`sw»g_lm_idx
(
»g
);

219 ià(
	`sw»g_lm_mode
(
»g
è!ð
NN_LM_MOD_NONE
) {

220 
	`´_”r
("bad LM mode for„estricted operands %d\n",

221 
	`sw»g_lm_mode
(
»g
));

225 ià(
v®
 & ~
RE_REG_LM_IDX_MAX
) {

226 
	`´_”r
("LM offsetoo†arge\n");

230  
RE_REG_LM
 | 
	`FIELD_PREP
(
RE_REG_LM_IDX
, 
lm_id
è| 
v®
;

231 
NN_REG_IMM
:

232 ià(
v®
 & ~(0x7à| 
has_imm8
 << 7)) {

233 
	`´_”r
("immediateoo†arge\n");

236 *
i8
 = 
v®
 & 0x80;

237  
	`RE_REG_IMM_’code
(
v®
 & 0x7f);

238 
NN_REG_NONE
:

239  
is_d¡
 ? 
RE_REG_NO_DST
 : 
REG_NONE
;

240 
NN_REG_NNR
:

241 
	`´_”r
("NNRs used with„estrictedƒncoding\n");

245 
	`´_”r
("unrecognized„egƒncoding\n");

247 
	}
}

249 
	$sw»g_to_»¡riùed
(
sw»g
 
d¡
, sw»g 
Ìeg
, sw»g 
¼eg
,

250 
nå_š¢_»_»gs
 *
»g
, 
boÞ
 
has_imm8
)

252 
	`mem£t
(
»g
, 0, (*reg));

255 ià(
	`sw»g_ty³
(
d¡
è=ð
NN_REG_IMM
)

256  -
EFAULT
;

258 ià(
	`sw»g_ty³
(
d¡
è=ð
NN_REG_GPR_B
)

259 
»g
->
d¡_ab
 = 
ALU_DST_B
;

260 ià(
	`sw»g_ty³
(
d¡
è=ð
NN_REG_GPR_BOTH
)

261 
»g
->
wr_bÙh
 = 
Œue
;

262 
»g
->
d¡
 = 
	`nå_sw»g_to_»»g
(d¡, 
Œue
, 
çl£
, 
NULL
);

265 ià(
	`sw»g_ty³
(
Ìeg
è=ðsw»g_ty³(
¼eg
) &&

266 
	`sw»g_ty³
(
Ìeg
è!ð
NN_REG_NONE
)

267  -
EFAULT
;

269 ià(
	`sw»g_ty³
(
Ìeg
è=ð
NN_REG_GPR_B
 ||

270 
	`sw»g_ty³
(
¼eg
è=ð
NN_REG_GPR_A
) {

271 
»g
->
¬eg
 = 
	`nå_sw»g_to_»»g
(
¼eg
, 
çl£
, 
has_imm8
, &»g->
i8
);

272 
»g
->
b»g
 = 
	`nå_sw»g_to_»»g
(
Ìeg
, 
çl£
, 
has_imm8
, &»g->
i8
);

273 
»g
->
sw­
 = 
Œue
;

275 
»g
->
¬eg
 = 
	`nå_sw»g_to_»»g
(
Ìeg
, 
çl£
, 
has_imm8
, &»g->
i8
);

276 
»g
->
b»g
 = 
	`nå_sw»g_to_»»g
(
¼eg
, 
çl£
, 
has_imm8
, &»g->
i8
);

279 
»g
->
d¡_lmexŠ
 = 
	`sw»g_lmexŠ
(
d¡
);

280 
»g
->
¤c_lmexŠ
 = 
	`sw»g_lmexŠ
(
Ìeg
è| sw»g_lmexŠ(
¼eg
);

283 
	}
}

285 
	#NFP_USTORE_ECC_POLY_WORDS
 7

	)

286 
	#NFP_USTORE_OP_BITS
 45

	)

288 cÚ¡ 
u64
 
	gnå_u¡Üe_ecc_pÞynomŸls
[
NFP_USTORE_ECC_POLY_WORDS
] = {

298 
boÞ
 
	$·r™y
(
u64
 
v®ue
)

300  
	`hweight64
(
v®ue
) & 1;

301 
	}
}

303 
	$nå_u¡Üe_check_v®id_no_ecc
(
u64
 
š¢
)

305 ià(
š¢
 & ~
	`GENMASK_ULL
(
NFP_USTORE_OP_BITS
, 0))

306  -
EINVAL
;

309 
	}
}

311 
u64
 
	$nå_u¡Üe_ÿlc_ecc_š¢
(
u64
 
š¢
)

313 
u8
 
ecc
 = 0;

314 
i
;

316 
i
 = 0; i < 
NFP_USTORE_ECC_POLY_WORDS
; i++)

317 
ecc
 |ð
	`·r™y
(
nå_u¡Üe_ecc_pÞynomŸls
[
i
] & 
š¢
) << i;

319  
š¢
 | (
u64
)
ecc
 << 
NFP_USTORE_OP_BITS
;

320 
	}
}

	@src/nfp_asm.h

4 #iâdeà
__NFP_ASM_H__


5 
	#__NFP_ASM_H__
 1

	)

7 
	~"nåcÜe/kcom·t.h
"

9 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

10 
	~<lšux/b™f›ld.h
>

12 
	~<lšux/bug.h
>

13 
	~<lšux/ty³s.h
>

15 
	#REG_NONE
 0

	)

16 
	#REG_WIDTH
 4

	)

18 
	#RE_REG_NO_DST
 0x020

	)

19 
	#RE_REG_IMM
 0x020

	)

20 
	#RE_REG_IMM_’code
(
x
) \

21 (
RE_REG_IMM
 | ((
x
è& 0x1fè| (((xè& 0x60è<< 1))

	)

22 
	#RE_REG_IMM_MAX
 0x07fULL

	)

23 
	#RE_REG_LM
 0x050

	)

24 
	#RE_REG_LM_IDX
 0x008

	)

25 
	#RE_REG_LM_IDX_MAX
 0x7

	)

26 
	#RE_REG_XFR
 0x080

	)

28 
	#UR_REG_XFR
 0x180

	)

29 
	#UR_REG_LM
 0x200

	)

30 
	#UR_REG_LM_IDX
 0x020

	)

31 
	#UR_REG_LM_POST_MOD
 0x010

	)

32 
	#UR_REG_LM_POST_MOD_DEC
 0x001

	)

33 
	#UR_REG_LM_IDX_MAX
 0xf

	)

34 
	#UR_REG_NN
 0x280

	)

35 
	#UR_REG_NO_DST
 0x300

	)

36 
	#UR_REG_IMM
 
UR_REG_NO_DST


	)

37 
	#UR_REG_IMM_’code
(
x
è(
UR_REG_IMM
 | (x))

	)

38 
	#UR_REG_IMM_MAX
 0x0ffULL

	)

40 
	#OP_BR_BASE
 0x0d800000020ULL

	)

41 
	#OP_BR_BASE_MASK
 0x0f8000c3û0ULL

	)

42 
	#OP_BR_MASK
 0x0000000001fULL

	)

43 
	#OP_BR_EV_PIP
 0x00000000300ULL

	)

44 
	#OP_BR_CSS
 0x0000003c000ULL

	)

45 
	#OP_BR_DEFBR
 0x00000300000ULL

	)

46 
	#OP_BR_ADDR_LO
 0x007ffc00000ULL

	)

47 
	#OP_BR_ADDR_HI
 0x10000000000ULL

	)

49 
	#OP_BR_BIT_BASE
 0x0d000000000ULL

	)

50 
	#OP_BR_BIT_BASE_MASK
 0x0f800080300ULL

	)

51 
	#OP_BR_BIT_A_SRC
 0x000000000ffULL

	)

52 
	#OP_BR_BIT_B_SRC
 0x0000003fc00ULL

	)

53 
	#OP_BR_BIT_BV
 0x00000040000ULL

	)

54 
	#OP_BR_BIT_SRC_LMEXTN
 0x40000000000ULL

	)

55 
	#OP_BR_BIT_DEFBR
 
OP_BR_DEFBR


	)

56 
	#OP_BR_BIT_ADDR_LO
 
OP_BR_ADDR_LO


	)

57 
	#OP_BR_BIT_ADDR_HI
 
OP_BR_ADDR_HI


	)

59 
	#OP_BR_ALU_BASE
 0x0e800000000ULL

	)

60 
	#OP_BR_ALU_BASE_MASK
 0x0ff80000000ULL

	)

61 
	#OP_BR_ALU_A_SRC
 0x000000003ffULL

	)

62 
	#OP_BR_ALU_B_SRC
 0x000000ffc00ULL

	)

63 
	#OP_BR_ALU_DEFBR
 0x00000300000ULL

	)

64 
	#OP_BR_ALU_IMM_HI
 0x0007fc00000ULL

	)

65 
	#OP_BR_ALU_SRC_LMEXTN
 0x40000000000ULL

	)

66 
	#OP_BR_ALU_DST_LMEXTN
 0x80000000000ULL

	)

68 
šlše
 
boÞ
 
	$nå_is_br
(
u64
 
š¢
)

70  (
š¢
 & 
OP_BR_BASE_MASK
è=ð
OP_BR_BASE
 ||

71 (
š¢
 & 
OP_BR_BIT_BASE_MASK
è=ð
OP_BR_BIT_BASE
;

72 
	}
}

74 
	ebr_mask
 {

75 
	mBR_BEQ
 = 0x00,

76 
	mBR_BNE
 = 0x01,

77 
	mBR_BMI
 = 0x02,

78 
	mBR_BHS
 = 0x04,

79 
	mBR_BCC
 = 0x05,

80 
	mBR_BLO
 = 0x05,

81 
	mBR_BGE
 = 0x08,

82 
	mBR_BLT
 = 0x09,

83 
	mBR_UNC
 = 0x18,

86 
	ebr_ev_p
 {

87 
	mBR_EV_PIP_UNCOND
 = 0,

88 
	mBR_EV_PIP_COND
 = 1,

91 
	ebr_ùx_sigÇl_¡©e
 {

92 
	mBR_CSS_NONE
 = 2,

95 
u16
 
br_g‘_off£t
(
u64
 
š¡r
);

96 
br_£t_off£t
(
u64
 *
š¡r
, 
u16
 
off£t
);

97 
br_add_off£t
(
u64
 *
š¡r
, 
u16
 
off£t
);

99 
	#OP_BBYTE_BASE
 0x0c800000000ULL

	)

100 
	#OP_BB_A_SRC
 0x000000000ffULL

	)

101 
	#OP_BB_BYTE
 0x00000000300ULL

	)

102 
	#OP_BB_B_SRC
 0x0000003fc00ULL

	)

103 
	#OP_BB_I8
 0x00000040000ULL

	)

104 
	#OP_BB_EQ
 0x00000080000ULL

	)

105 
	#OP_BB_DEFBR
 0x00000300000ULL

	)

106 
	#OP_BB_ADDR_LO
 0x007ffc00000ULL

	)

107 
	#OP_BB_ADDR_HI
 0x10000000000ULL

	)

108 
	#OP_BB_SRC_LMEXTN
 0x40000000000ULL

	)

110 
	#OP_BALU_BASE
 0x0e800000000ULL

	)

111 
	#OP_BA_A_SRC
 0x000000003ffULL

	)

112 
	#OP_BA_B_SRC
 0x000000ffc00ULL

	)

113 
	#OP_BA_DEFBR
 0x00000300000ULL

	)

114 
	#OP_BA_ADDR_HI
 0x0007fc00000ULL

	)

116 
	#OP_IMMED_A_SRC
 0x000000003ffULL

	)

117 
	#OP_IMMED_B_SRC
 0x000000ffc00ULL

	)

118 
	#OP_IMMED_IMM
 0x0000ff00000ULL

	)

119 
	#OP_IMMED_WIDTH
 0x00060000000ULL

	)

120 
	#OP_IMMED_INV
 0x00080000000ULL

	)

121 
	#OP_IMMED_SHIFT
 0x00600000000ULL

	)

122 
	#OP_IMMED_BASE
 0x0f000000000ULL

	)

123 
	#OP_IMMED_WR_AB
 0x20000000000ULL

	)

124 
	#OP_IMMED_SRC_LMEXTN
 0x40000000000ULL

	)

125 
	#OP_IMMED_DST_LMEXTN
 0x80000000000ULL

	)

127 
	eimmed_width
 {

128 
	mIMMED_WIDTH_ALL
 = 0,

129 
	mIMMED_WIDTH_BYTE
 = 1,

130 
	mIMMED_WIDTH_WORD
 = 2,

133 
	eimmed_shiá
 {

134 
	mIMMED_SHIFT_0B
 = 0,

135 
	mIMMED_SHIFT_1B
 = 1,

136 
	mIMMED_SHIFT_2B
 = 2,

139 
u16
 
immed_g‘_v®ue
(
u64
 
š¡r
);

140 
immed_£t_v®ue
(
u64
 *
š¡r
, 
u16
 
immed
);

141 
immed_add_v®ue
(
u64
 *
š¡r
, 
u16
 
off£t
);

143 
	#OP_SHF_BASE
 0x08000000000ULL

	)

144 
	#OP_SHF_A_SRC
 0x000000000ffULL

	)

145 
	#OP_SHF_SC
 0x00000000300ULL

	)

146 
	#OP_SHF_B_SRC
 0x0000003fc00ULL

	)

147 
	#OP_SHF_I8
 0x00000040000ULL

	)

148 
	#OP_SHF_SW
 0x00000080000ULL

	)

149 
	#OP_SHF_DST
 0x0000ff00000ULL

	)

150 
	#OP_SHF_SHIFT
 0x001f0000000ULL

	)

151 
	#OP_SHF_OP
 0x00e00000000ULL

	)

152 
	#OP_SHF_DST_AB
 0x01000000000ULL

	)

153 
	#OP_SHF_WR_AB
 0x20000000000ULL

	)

154 
	#OP_SHF_SRC_LMEXTN
 0x40000000000ULL

	)

155 
	#OP_SHF_DST_LMEXTN
 0x80000000000ULL

	)

157 
	eshf_Ý
 {

158 
	mSHF_OP_NONE
 = 0,

159 
	mSHF_OP_AND
 = 2,

160 
	mSHF_OP_OR
 = 5,

161 
	mSHF_OP_ASHR
 = 6,

164 
	eshf_sc
 {

165 
	mSHF_SC_R_ROT
 = 0,

166 
	mSHF_SC_NONE
 = 
SHF_SC_R_ROT
,

167 
	mSHF_SC_R_SHF
 = 1,

168 
	mSHF_SC_L_SHF
 = 2,

169 
	mSHF_SC_R_DSHF
 = 3,

172 
	#OP_ALU_A_SRC
 0x000000003ffULL

	)

173 
	#OP_ALU_B_SRC
 0x000000ffc00ULL

	)

174 
	#OP_ALU_DST
 0x0003ff00000ULL

	)

175 
	#OP_ALU_SW
 0x00040000000ULL

	)

176 
	#OP_ALU_OP
 0x00f80000000ULL

	)

177 
	#OP_ALU_DST_AB
 0x01000000000ULL

	)

178 
	#OP_ALU_BASE
 0x0a000000000ULL

	)

179 
	#OP_ALU_WR_AB
 0x20000000000ULL

	)

180 
	#OP_ALU_SRC_LMEXTN
 0x40000000000ULL

	)

181 
	#OP_ALU_DST_LMEXTN
 0x80000000000ULL

	)

183 
	e®u_Ý
 {

184 
	mALU_OP_NONE
 = 0x00,

185 
	mALU_OP_ADD
 = 0x01,

186 
	mALU_OP_NOT
 = 0x04,

187 
	mALU_OP_ADD_2B
 = 0x05,

188 
	mALU_OP_AND
 = 0x08,

189 
	mALU_OP_AND_NOT_A
 = 0x0c,

190 
	mALU_OP_SUB_C
 = 0x0d,

191 
	mALU_OP_AND_NOT_B
 = 0x10,

192 
	mALU_OP_ADD_C
 = 0x11,

193 
	mALU_OP_OR
 = 0x14,

194 
	mALU_OP_SUB
 = 0x15,

195 
	mALU_OP_XOR
 = 0x18,

198 
	e®u_d¡_ab
 {

199 
	mALU_DST_A
 = 0,

200 
	mALU_DST_B
 = 1,

203 
	#OP_LDF_BASE
 0x0c000000000ULL

	)

204 
	#OP_LDF_A_SRC
 0x000000000ffULL

	)

205 
	#OP_LDF_SC
 0x00000000300ULL

	)

206 
	#OP_LDF_B_SRC
 0x0000003fc00ULL

	)

207 
	#OP_LDF_I8
 0x00000040000ULL

	)

208 
	#OP_LDF_SW
 0x00000080000ULL

	)

209 
	#OP_LDF_ZF
 0x00000100000ULL

	)

210 
	#OP_LDF_BMASK
 0x0000f000000ULL

	)

211 
	#OP_LDF_SHF
 0x001f0000000ULL

	)

212 
	#OP_LDF_WR_AB
 0x20000000000ULL

	)

213 
	#OP_LDF_SRC_LMEXTN
 0x40000000000ULL

	)

214 
	#OP_LDF_DST_LMEXTN
 0x80000000000ULL

	)

216 
	#OP_CMD_A_SRC
 0x000000000ffULL

	)

217 
	#OP_CMD_CTX
 0x00000000300ULL

	)

218 
	#OP_CMD_B_SRC
 0x0000003fc00ULL

	)

219 
	#OP_CMD_TOKEN
 0x000000c0000ULL

	)

220 
	#OP_CMD_XFER
 0x00001f00000ULL

	)

221 
	#OP_CMD_CNT
 0x0000e000000ULL

	)

222 
	#OP_CMD_SIG
 0x000f0000000ULL

	)

223 
	#OP_CMD_TGT_CMD
 0x07f00000000ULL

	)

224 
	#OP_CMD_INDIR
 0x20000000000ULL

	)

225 
	#OP_CMD_MODE
 0x1c0000000000ULL

	)

227 
	scmd_tgt_aù
 {

228 
u8
 
	mtok’
;

229 
u8
 
	mtgt_cmd
;

232 
	ecmd_tgt_m­
 {

233 
	mCMD_TGT_READ8
,

234 
	mCMD_TGT_WRITE8_SWAP
,

235 
	mCMD_TGT_WRITE32_SWAP
,

236 
	mCMD_TGT_READ32
,

237 
	mCMD_TGT_READ32_LE
,

238 
	mCMD_TGT_READ32_SWAP
,

239 
	mCMD_TGT_READ_LE
,

240 
	mCMD_TGT_READ_SWAP_LE
,

241 
	mCMD_TGT_ADD
,

242 
	mCMD_TGT_ADD_IMM
,

243 
	m__CMD_TGT_MAP_SIZE
,

246 cÚ¡ 
cmd_tgt_aù
 cmd_tgt_aù[
__CMD_TGT_MAP_SIZE
];

248 
	ecmd_mode
 {

249 
	mCMD_MODE_40b_AB
 = 0,

250 
	mCMD_MODE_40b_BA
 = 1,

251 
	mCMD_MODE_32b
 = 4,

254 
	ecmd_ùx_sw­
 {

255 
	mCMD_CTX_SWAP
 = 0,

256 
	mCMD_CTX_SWAP_DEFER1
 = 1,

257 
	mCMD_CTX_SWAP_DEFER2
 = 2,

258 
	mCMD_CTX_NO_SWAP
 = 3,

261 
	#CMD_OVE_DATA
 
	`GENMASK
(5, 3)

	)

262 
	#CMD_OVE_LEN
 
	`BIT
(7)

	)

263 
	#CMD_OV_LEN
 
	`GENMASK
(12, 8)

	)

265 
	#OP_LCSR_BASE
 0x0fc00000000ULL

	)

266 
	#OP_LCSR_A_SRC
 0x000000003ffULL

	)

267 
	#OP_LCSR_B_SRC
 0x000000ffc00ULL

	)

268 
	#OP_LCSR_WRITE
 0x00000200000ULL

	)

269 
	#OP_LCSR_ADDR
 0x001ffc00000ULL

	)

270 
	#OP_LCSR_SRC_LMEXTN
 0x40000000000ULL

	)

271 
	#OP_LCSR_DST_LMEXTN
 0x80000000000ULL

	)

273 
	elc¤_wr_¤c
 {

274 
	mLCSR_WR_AREG
,

275 
	mLCSR_WR_BREG
,

276 
	mLCSR_WR_IMM
,

279 
	#OP_CARB_BASE
 0x0e000000000ULL

	)

280 
	#OP_CARB_OR
 0x00000010000ULL

	)

282 
	#NFP_CSR_CTX_PTR
 0x20

	)

283 
	#NFP_CSR_ACT_LM_ADDR0
 0x64

	)

284 
	#NFP_CSR_ACT_LM_ADDR1
 0x6c

	)

285 
	#NFP_CSR_ACT_LM_ADDR2
 0x94

	)

286 
	#NFP_CSR_ACT_LM_ADDR3
 0x9c

	)

287 
	#NFP_CSR_PSEUDO_RND_NUM
 0x148

	)

290 
	#NN_REG_TYPE
 
	`GENMASK
(31, 24)

	)

291 
	#NN_REG_LM_IDX
 
	`GENMASK
(23, 22)

	)

292 
	#NN_REG_LM_IDX_HI
 
	`BIT
(23)

	)

293 
	#NN_REG_LM_IDX_LO
 
	`BIT
(22)

	)

294 
	#NN_REG_LM_MOD
 
	`GENMASK
(21, 20)

	)

295 
	#NN_REG_VAL
 
	`GENMASK
(7, 0)

	)

297 
	enå_bpf_»g_ty³
 {

298 
	mNN_REG_GPR_A
 = 
BIT
(0),

299 
	mNN_REG_GPR_B
 = 
BIT
(1),

300 
	mNN_REG_GPR_BOTH
 = 
NN_REG_GPR_A
 | 
NN_REG_GPR_B
,

301 
	mNN_REG_NNR
 = 
BIT
(2),

302 
	mNN_REG_XFER
 = 
BIT
(3),

303 
	mNN_REG_IMM
 = 
BIT
(4),

304 
	mNN_REG_NONE
 = 
BIT
(5),

305 
	mNN_REG_LMEM
 = 
BIT
(6),

308 
	enå_bpf_lm_mode
 {

309 
	mNN_LM_MOD_NONE
 = 0,

310 
	mNN_LM_MOD_INC
,

311 
	mNN_LM_MOD_DEC
,

314 
	#»g_bÙh
(
x
è
	`__’c_sw»g
((x), 
NN_REG_GPR_BOTH
)

	)

315 
	#»g_a
(
x
è
	`__’c_sw»g
((x), 
NN_REG_GPR_A
)

	)

316 
	#»g_b
(
x
è
	`__’c_sw»g
((x), 
NN_REG_GPR_B
)

	)

317 
	#»g_Âr
(
x
è
	`__’c_sw»g
((x), 
NN_REG_NNR
)

	)

318 
	#»g_xãr
(
x
è
	`__’c_sw»g
((x), 
NN_REG_XFER
)

	)

319 
	#»g_imm
(
x
è
	`__’c_sw»g
((x), 
NN_REG_IMM
)

	)

320 
	#»g_nÚe
(è
	`__’c_sw»g
(0, 
NN_REG_NONE
)

	)

321 
	#»g_lm
(
x
, 
off
è
	`__’c_sw»g_lm
((x), 
NN_LM_MOD_NONE
, (off))

	)

322 
	#»g_lm_šc
(
x
è
	`__’c_sw»g_lm
((x), 
NN_LM_MOD_INC
, 0)

	)

323 
	#»g_lm_dec
(
x
è
	`__’c_sw»g_lm
((x), 
NN_LM_MOD_DEC
, 0)

	)

324 
	#__»g_lm
(
x
, 
mod
, 
off
è
	`__’c_sw»g_lm
((x), (mod), (off))

	)

326 
__u32
 
	t__b™wi£
 
	tsw»g
;

328 
šlše
 
sw»g
 
	$__’c_sw»g
(
u16
 
id
, 
u8
 
ty³
)

330  (
__fÜû
 
sw»g
)(
id
 | 
	`FIELD_PREP
(
NN_REG_TYPE
, 
ty³
));

331 
	}
}

333 
šlše
 
sw»g
 
	$__’c_sw»g_lm
(
u8
 
id
, 
nå_bpf_lm_mode
 
mode
, u8 
off
)

335 
	`WARN_ON
(
id
 > 3 || (
off
 && 
mode
 !ð
NN_LM_MOD_NONE
));

337  (
__fÜû
 
sw»g
)(
	`FIELD_PREP
(
NN_REG_TYPE
, 
NN_REG_LMEM
) |

338 
	`FIELD_PREP
(
NN_REG_LM_IDX
, 
id
) |

339 
	`FIELD_PREP
(
NN_REG_LM_MOD
, 
mode
) |

340 
off
);

341 
	}
}

343 
šlše
 
u32
 
	$sw»g_¿w
(
sw»g
 
»g
)

345  (
__fÜû
 
u32
)
»g
;

346 
	}
}

348 
šlše
 
nå_bpf_»g_ty³
 
	$sw»g_ty³
(
sw»g
 
»g
)

350  
	`FIELD_GET
(
NN_REG_TYPE
, 
	`sw»g_¿w
(
»g
));

351 
	}
}

353 
šlše
 
u16
 
	$sw»g_v®ue
(
sw»g
 
»g
)

355  
	`FIELD_GET
(
NN_REG_VAL
, 
	`sw»g_¿w
(
»g
));

356 
	}
}

358 
šlše
 
boÞ
 
	$sw»g_lm_idx
(
sw»g
 
»g
)

360  
	`FIELD_GET
(
NN_REG_LM_IDX_LO
, 
	`sw»g_¿w
(
»g
));

361 
	}
}

363 
šlše
 
boÞ
 
	$sw»g_lmexŠ
(
sw»g
 
»g
)

365  
	`FIELD_GET
(
NN_REG_LM_IDX_HI
, 
	`sw»g_¿w
(
»g
));

366 
	}
}

368 
šlše
 
nå_bpf_lm_mode
 
	$sw»g_lm_mode
(
sw»g
 
»g
)

370  
	`FIELD_GET
(
NN_REG_LM_MOD
, 
	`sw»g_¿w
(
»g
));

371 
	}
}

373 
	snå_š¢_ur_»gs
 {

374 
®u_d¡_ab
 
	md¡_ab
;

375 
u16
 
	md¡
;

376 
u16
 
	m¬eg
, 
	mb»g
;

377 
boÞ
 
	msw­
;

378 
boÞ
 
	mwr_bÙh
;

379 
boÞ
 
	md¡_lmexŠ
;

380 
boÞ
 
	m¤c_lmexŠ
;

383 
	snå_š¢_»_»gs
 {

384 
®u_d¡_ab
 
	md¡_ab
;

385 
u8
 
	md¡
;

386 
u8
 
	m¬eg
, 
	mb»g
;

387 
boÞ
 
	msw­
;

388 
boÞ
 
	mwr_bÙh
;

389 
boÞ
 
	mi8
;

390 
boÞ
 
	md¡_lmexŠ
;

391 
boÞ
 
	m¤c_lmexŠ
;

394 
sw»g_to_uÄe¡riùed
(
sw»g
 
d¡
, sw»g 
Ìeg
, sw»g 
¼eg
,

395 
nå_š¢_ur_»gs
 *
»g
);

396 
sw»g_to_»¡riùed
(
sw»g
 
d¡
, sw»g 
Ìeg
, sw»g 
¼eg
,

397 
nå_š¢_»_»gs
 *
»g
, 
boÞ
 
has_imm8
);

399 
	#NFP_USTORE_PREFETCH_WINDOW
 8

	)

401 
nå_u¡Üe_check_v®id_no_ecc
(
u64
 
š¢
);

402 
u64
 
nå_u¡Üe_ÿlc_ecc_š¢
(u64 
š¢
);

404 
	#NFP_IND_ME_REFL_WR_SIG_INIT
 3

	)

405 
	#NFP_IND_ME_CTX_PTR_BASE_MASK
 
	`GENMASK
(9, 0)

	)

406 
	#NFP_IND_NUM_CONTEXTS
 8

	)

408 
šlše
 
u32
 
	$nå_g‘_šd_c¤_ùx_±r_offs
(
u32
 
»ad_off£t
)

410  (
»ad_off£t
 & ~
NFP_IND_ME_CTX_PTR_BASE_MASK
è| 
NFP_CSR_CTX_PTR
;

411 
	}
}

413 
	emul_ty³
 {

414 
	mMUL_TYPE_START
 = 0x00,

415 
	mMUL_TYPE_STEP_24x8
 = 0x01,

416 
	mMUL_TYPE_STEP_16x16
 = 0x02,

417 
	mMUL_TYPE_STEP_32x32
 = 0x03,

420 
	emul_¡•
 {

421 
	mMUL_STEP_1
 = 0x00,

422 
	mMUL_STEP_NONE
 = 
MUL_STEP_1
,

423 
	mMUL_STEP_2
 = 0x01,

424 
	mMUL_STEP_3
 = 0x02,

425 
	mMUL_STEP_4
 = 0x03,

426 
	mMUL_LAST
 = 0x04,

427 
	mMUL_LAST_2
 = 0x05,

430 
	#OP_MUL_BASE
 0x0f800000000ULL

	)

431 
	#OP_MUL_A_SRC
 0x000000003ffULL

	)

432 
	#OP_MUL_B_SRC
 0x000000ffc00ULL

	)

433 
	#OP_MUL_STEP
 0x00000700000ULL

	)

434 
	#OP_MUL_DST_AB
 0x00000800000ULL

	)

435 
	#OP_MUL_SW
 0x00040000000ULL

	)

436 
	#OP_MUL_TYPE
 0x00180000000ULL

	)

437 
	#OP_MUL_WR_AB
 0x20000000000ULL

	)

438 
	#OP_MUL_SRC_LMEXTN
 0x40000000000ULL

	)

439 
	#OP_MUL_DST_LMEXTN
 0x80000000000ULL

	)

	@src/nfp_build_info.h

2 
	#NFP_SRC_VERSION
 "no-¤c-v” (o-o-t)"

	)

3 
	#NFP_BUILD_USER_ID
 "roÙ"

	)

4 
	#NFP_BUILD_USER
 "roÙ"

	)

5 
	#NFP_BUILD_HOST
 "cÚ"

	)

6 
	#NFP_BUILD_PATH
 "/home/cÜigše/xf/nå-drv-kmods-´iv©e/¤c"

	)

7 
	#NFP_SRC_PATH
 "/home/cÜigše/xf/nå-drv-kmods-´iv©e/¤c/"

	)

	@src/nfp_ctrl.c

4 
	~"nåcÜe/kcom·t.h
"

6 
	~<lšux/bÙtom_h®f.h
>

7 
	~<lšux/if_¬p.h
>

8 
	~<lšux/moduË.h
>

9 
	~<lšux/Ãtdeviû.h
>

10 
	~<lšux/rcupd©e.h
>

12 
	~"nå_­p.h
"

13 
	~"nå_maš.h
"

15 
boÞ
 
	gnå_ù¾_debug
;

16 #ià
defšed
(
CONFIG_NFP_NET_PF
è&& defšed(
CONFIG_NFP_USER_SPACE_CPP
)

17 
moduË_·¿m
(
nå_ù¾_debug
, 
boÞ
, 0444);

18 
MODULE_PARM_DESC
(
nå_ù¾_debug
, "Create debug‚etdev for sniffing‡nd injecting FW control messages (default = false)");

21 
	snå_ù¾_debug_Ãtdev
 {

22 
nå_­p
 *
	m­p
;

25 
	$nå_ù¾_debug_Ãtdev_Ý’
(
Ãt_deviû
 *
Ãtdev
)

28 
	}
}

30 
	$nå_ù¾_debug_Ãtdev_þo£
(
Ãt_deviû
 *
Ãtdev
)

33 
	}
}

35 
	$nå_ù¾_debug_rx
(
nå_pf
 *
pf
, 
sk_buff
 *
skb
)

37 
Ãt_deviû
 *
Ãtdev
;

39 ià(!
nå_ù¾_debug
)

42 
	`rcu_»ad_lock
();

43 
Ãtdev
 = 
	`rcu_d”eã»nû
(
pf
->
debug_ù¾_Ãtdev
);

44 ià(!
Ãtdev
 || !
	`Ãtif_ruÂšg
(netdev))

45 
ex™_uÆock_rcu
;

47 
skb
 = 
	`skb_þÚe
(skb, 
GFP_ATOMIC
);

48 ià(
skb
) {

49 
skb
->
dev
 = 
Ãtdev
;

50 
	`Ãtif_rx
(
skb
);

51 
Ãtdev
->
¡©s
.
rx_·ck‘s
++;

52 
Ãtdev
->
¡©s
.
rx_by‹s
 +ð
skb
->
Ën
;

54 
Ãtdev
->
¡©s
.
rx_drÝ³d
++;

57 
ex™_uÆock_rcu
:

58 
	`rcu_»ad_uÆock
();

59 
	}
}

61 
	$nå_ù¾_debug_d–iv”_tx
(
nå_pf
 *
pf
, 
sk_buff
 *
skb
)

63 
Ãt_deviû
 *
Ãtdev
;

65 ià(!
nå_ù¾_debug
)

68 
	`rcu_»ad_lock
();

69 
Ãtdev
 = 
	`rcu_d”eã»nû
(
pf
->
debug_ù¾_Ãtdev
);

70 ià(!
Ãtdev
 || !
	`Ãtif_ruÂšg
(netdev))

71 
ex™_uÆock_rcu
;

73 
skb
->
dev
 = 
Ãtdev
;

74 
skb
->
skb_iif
 = 
Ãtdev
->
ifšdex
;

76 
	`loÿl_bh_di§bË
();

77 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 7, 0)

78 
	`dev_queue_xm™_n™
(
skb
, 
Ãtdev
);

83 
skb
->
m¬k
 = ~0;

84 
	`dev_queue_xm™
(
skb
);

86 
	`loÿl_bh_’abË
();

87 
ex™_uÆock_rcu
:

88 
	`rcu_»ad_uÆock
();

89 
	}
}

91 
	$nå_ù¾_debug_tx
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
)

93 
nå_ù¾_debug_Ãtdev
 *
ncd
 = 
	`Ãtdev_´iv
(
Ãtdev
);

95 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 7, 0)

96 ià(
skb
->
m¬k
 == ~0) {

97 
	`dev_kä“_skb_ªy
(
skb
);

98  
NETDEV_TX_OK
;

101 
	`Œaû_devlšk_hwmsg
(
	`´iv_to_devlšk
(
ncd
->
­p
->
pf
), 
çl£
, 0,

102 
skb
->
d©a
, skb->
Ën
);

103 
	`nå_ù¾_tx
(
ncd
->
­p
->
ù¾
, 
skb
);

105 
Ãtdev
->
¡©s
.
tx_·ck‘s
++;

106 
Ãtdev
->
¡©s
.
tx_by‹s
 +ð
skb
->
Ën
;

108  
NETDEV_TX_OK
;

109 
	}
}

111 cÚ¡ 
Ãt_deviû_Ýs
 
	gnå_ù¾_debug_Ãtdev_Ýs
 = {

112 .
ndo_Ý’
 = 
nå_ù¾_debug_Ãtdev_Ý’
,

113 .
	gndo_¡Ý
 = 
nå_ù¾_debug_Ãtdev_þo£
,

114 .
	gndo_¡¬t_xm™
 = 
nå_ù¾_debug_tx
,

117 
	$nå_ù¾_debug_£tup
(
Ãt_deviû
 *
dev
)

119 
dev
->
ty³
 = 
ARPHRD_NONE
;

120 
dev
->
h¬d_h—d”_Ën
 = 0;

121 
dev
->
h—d”_Ýs
 = 
NULL
;

122 
dev
->
addr_Ën
 = 0;

123 
dev
->
tx_queue_Ën
 = 16;

124 
dev
->
mtu
 = 1024;

125 
dev
->
æags
 = 
IFF_POINTOPOINT
 | 
IFF_NOARP
;

127 
dev
->
Ãtdev_Ýs
 = &
nå_ù¾_debug_Ãtdev_Ýs
;

128 
	}
}

130 
	$nå_ù¾_debug_¡¬t
(
nå_pf
 *
pf
)

132 
nå_ù¾_debug_Ãtdev
 *
ncd
;

133 
Ãt_deviû
 *
Ãtdev
;

134 
”r
;

136 ià(!
nå_ù¾_debug
)

139 
Ãtdev
 = 
	`®loc_Ãtdev
((
nå_ù¾_debug_Ãtdev
),

140 "ncd%d", 
NET_NAME_UNKNOWN
, 
nå_ù¾_debug_£tup
);

141 ià(!
Ãtdev
)

142  -
ENOMEM
;

144 
ncd
 = 
	`Ãtdev_´iv
(
Ãtdev
);

145 
ncd
->
­p
 = 
pf
->app;

147 
”r
 = 
	`»gi¡”_Ãtdev
(
Ãtdev
);

148 ià(
”r
)

149 
”r_ä“
;

151 
	`rcu_assign_poš‹r
(
pf
->
debug_ù¾_Ãtdev
, 
Ãtdev
);

155 
”r_ä“
:

156 
	`ä“_Ãtdev
(
Ãtdev
);

157  
”r
;

158 
	}
}

160 
	$nå_ù¾_debug_¡Ý
(
nå_pf
 *
pf
)

162 
Ãt_deviû
 *
Ãtdev
;

164 ià(!
nå_ù¾_debug
)

167 
Ãtdev
 = 
	`rcu_d”eã»nû_´Ùeùed
(
pf
->
debug_ù¾_Ãtdev
, 
Œue
);

168 
	`rcu_assign_poš‹r
(
pf
->
debug_ù¾_Ãtdev
, 
NULL
);

170 
	`synchrÚize_rcu
();

171 
	`uÄegi¡”_Ãtdev
(
Ãtdev
);

172 
	`ä“_Ãtdev
(
Ãtdev
);

173 
	}
}

	@src/nfp_dev_cpp.c

11 
	~"nåcÜe/kcom·t.h
"

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/mm.h
>

16 
	~<lšux/uacûss.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/deviû.h
>

19 
	~<lšux/cdev.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/sched.h
>

22 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 11, 0)

23 
	~<lšux/sched/sigÇl.h
>

25 
	~<lšux/š‹¼u±.h
>

26 
	~<lšux/fœmw¬e.h
>

27 
	~<lšux/¶©fÜm_deviû.h
>

28 
	~<lšux/wa™.h
>

30 
	~"nåcÜe/nå.h
"

31 
	~"nåcÜe/nå_¬m.h
"

32 
	~"nåcÜe/nå_ýp.h
"

33 
	~"nåcÜe/nå_n¥.h
"

35 
	~"nå_ioùl.h
"

36 
	~"nå_maš.h
"

38 
	#NFP_DEV_CPP_MAX
 128

	)

39 
	#NFP_DEV_CPP_DEBUG
 0

	)

41 
	gnå_dev_ýp_majÜ
;

42 
þass
 *
	gnå_dev_ýp_þass
;

43 
	gnå_dev_ýp_¬—
;

49 
	#NFP_CPP_MEMIO_BOUNDARY
 (1 << 20)

	)

52 
	#NFP_DEV_CPP_CHANNELS
 256

	)

54 
	snå_dev_ýp
 {

55 
cdev
 
	mcdev
;

56 
deviû
 *
	mdev
;

57 
nå_ýp
 *
	mýp
;

58 
wa™_queue_h—d_t
 
	mchªÃl_wa™
;

59 
	mchªÃl_b™m­
[
BITS_TO_LONGS
(
NFP_DEV_CPP_CHANNELS
)];

61 
li¡_h—d
 
	mli¡
;

62 
mu‹x
 
	mlock
;

63 } 
	mev’t
;

66 
li¡_h—d
 
	mli¡
;

67 
mu‹x
 
	mlock
;

68 } 
	m¬—
;

71 
li¡_h—d
 
	mli¡
;

72 
mu‹x
 
	mlock
;

73 } 
	m»q
;

74 
	mfœmw¬e
[
NFP_FIRMWARE_MAX
];

77 
	snå_dev_ýp_chªÃl
 {

78 
nå_dev_ýp
 *
	mcdev
;

79 
u16
 
	mš‹rçû
;

83 
	snå_dev_ýp_vma
 {

84 
nå_dev_ýp_¬—
 *
	m¬—
;

85 
vm_¬—_¡ruù
 *
	mvma
;

86 
li¡_h—d
 
	mvma_li¡
;

87 
sk_¡ruù
 *
	msk
;

91 
	snå_dev_ýp_¬—
 {

92 
nå_dev_ýp
 *
	mcdev
;

93 
u16
 
	mš‹rçû
;

94 
nå_ýp_¬—_»que¡
 
	m»q
;

95 
li¡_h—d
 
	m»q_li¡
;

96 
nå_ýp_¬—
 *
	m¬—
;

97 
li¡_h—d
 
	m¬—_li¡
;

99 
li¡_h—d
 
	mli¡
;

100 } 
	mvma
;

104 
	snå_dev_ýp_ev’t
 {

105 
u16
 
	mš‹rçû
;

106 
nå_ýp_ev’t_»que¡
 
	m»q
;

107 
nå_ýp_ev’t
 *
	mýp_ev’t
;

108 
sk_¡ruù
 *
	msk
;

109 
	msigÇl
;

110 
li¡_h—d
 
	mli¡
;

113 
	$Œaû_cdev_vma
(
nå_dev_ýp_vma
 *
cvma
, 
loff_t
 
off£t
, 
c
)

115 #ià
NFP_DEV_CPP_DEBUG


116 
nå_dev_ýp_¬—
 *
¬—
 = 
cvma
->area;

117 
deviû
 *
dev
 = 
¬—
->
cdev
->dev;

119 
	`dev_”r
(
dev
, "%p: %c %p:%p @0x%lx(0x%lx)+0x%08llx %d:0x%llx\n",

120 
cu¼’t
->
mm
, 
c
, 
cvma
->
vma
->
vm_mm
, cvma,

121 ()
cvma
->
vma
->
vm_¡¬t
,

122 ()(
cvma
->
vma
->
vm_’d
 -

123 
vma
->vma->
vm_¡¬t
),

124 ()
off£t
,

125 
	`NFP_CPP_ID_TARGET_of
(
¬—
->
»q
.
ýp_id
),

126 ()
¬—
->
»q
.
ýp_addr
);

128 
	}
}

130 
	$nå_dev_ýp_ev’t_cb
(*
Ýaque
)

132 
nå_dev_ýp_ev’t
 *
ev
 = 
Ýaque
;

133 
k”Ãl_sigšfo_t
 
šfo
 = {

134 .
si_signo
 = 
ev
->
sigÇl
,

135 .
si_”ºo
 = 0,

136 .
si_code
 = 
SI_KERNEL
,

139 
	`£nd_sig_šfo
(
ev
->
sigÇl
, &
šfo
,ƒv->
sk
);

140 
	}
}

142 
	$nå_dev_ýp_¬—_®loc
(
nå_dev_ýp
 *
cdev
, 
u16
 
š‹rçû
,

143 
nå_ýp_¬—_»que¡
 *
¬—_»q
)

145 
nå_dev_ýp_¬—
 *
¬—
;

146 
nå_ýp_¬—
 *
ýp_¬—
;

147 
buff
[64];

149 
¬—
 = 
	`kz®loc
((*¬—), 
GFP_KERNEL
);

150 ià(!
¬—
)

151  -
ENOMEM
;

154 
	`¢´štf
(
buff
, (buff), "cdev@0x%lx", 
¬—_»q
->
off£t
);

155 
ýp_¬—
 = 
	`nå_ýp_¬—_®loc_w™h_Çme
(

156 
cdev
->
ýp
, 
¬—_»q
->
ýp_id
, 
buff
,

157 
¬—_»q
->
ýp_addr
,‡»a_»q->
size
);

158 ià(!
ýp_¬—
) {

159 
	`kä“
(
¬—
);

160  -
EINVAL
;

163 
¬—
->
cdev
 = cdev;

164 
¬—
->
š‹rçû
 = interface;

165 
¬—
->¬— = 
ýp_¬—
;

166 
¬—
->
»q
 = *
¬—_»q
;

167 
	`li¡_add_ž
(&
¬—
->
»q_li¡
, &
cdev
->
»q
.
li¡
);

169 
	`INIT_LIST_HEAD
(&
¬—
->
vma
.
li¡
);

172 
	`INIT_LIST_HEAD
(&
¬—
->
¬—_li¡
);

173 
	`li¡_d–
(&
¬—
->
¬—_li¡
);

176 
	}
}

178 
	$nå_dev_ýp_¬—_ä“
(
nå_dev_ýp_¬—
 *
¬—
)

180 
	`BUG_ON
(!
	`li¡_em±y
(&
¬—
->
vma
.
li¡
));

181 
	`li¡_d–
(&
¬—
->
»q_li¡
);

182 
	`nå_ýp_¬—_ä“
(
¬—
->area);

183 
	`kä“
(
¬—
);

184 
	}
}

194 
	$nå_dev_ýp_vma_acquœe
(
nå_dev_ýp_vma
 *
cvma
)

196 
nå_dev_ýp_¬—
 *
¬—
 = 
cvma
->area;

197 
nå_dev_ýp
 *
cdev
 = 
¬—
->cdev;

198 
”r
;

200 ià(!
	`li¡_em±y
(&
cvma
->
vma_li¡
))

203 ià(
	`li¡_em±y
(&
¬—
->
vma
.
li¡
)) {

204 
”r
 = 
	`nå_ýp_¬—_acquœe_nÚblockšg
(
¬—
->area);

205 ià(
”r
 < 0)

206  
”r
;

209 
	`li¡_add_ž
(&
¬—
->
¬—_li¡
, &
cdev
->¬—.
li¡
);

212 
	`li¡_add_ž
(&
cvma
->
vma_li¡
, &
¬—
->
vma
.
li¡
);

215 
	}
}

224 
	$nå_dev_ýp_vma_»Ëa£
(
nå_dev_ýp_vma
 *
cvma
)

226 
nå_dev_ýp_¬—
 *
¬—
 = 
cvma
->area;

228 ià(
	`li¡_em±y
(&
cvma
->
vma_li¡
))

232 
	`li¡_d–
(&
cvma
->
vma_li¡
);

234 
	`INIT_LIST_HEAD
(&
cvma
->
vma_li¡
);

239 ià(
	`li¡_em±y
(&
¬—
->
vma
.
li¡
)) {

241 
	`li¡_d–
(&
¬—
->
¬—_li¡
);

243 
	`nå_ýp_¬—_»Ëa£
(
¬—
->area);

245 
	}
}

250 
	$nå_dev_ýp_vma_eviù
(
nå_dev_ýp
 *
cdev
,

251 cÚ¡ 
nå_dev_ýp_vma
 *
this_cvma
)

253 
nå_dev_ýp_¬—
 *
a
, *
tmp
;

254 
”r
 = -
EAGAIN
;

257 
	`li¡_fÜ_—ch_’Œy_§ã
(
a
, 
tmp
, &
cdev
->
¬—
.
li¡
, 
¬—_li¡
) {

258 ià(
	`li¡_em±y
(&
a
->
vma
.
li¡
))

260 ià(!
this_cvma
 ||his_cvma->
¬—
 !ð
a
) {

261 !
	`li¡_em±y
(&
a
->
vma
.
li¡
)) {

262 
nå_dev_ýp_vma
 *
ùmp
;

264 
ùmp
 = 
	`li¡_fœ¡_’Œy
(&
a
->
vma
.
li¡
,

265 
nå_dev_ýp_vma
,

266 
vma_li¡
);

267 
	`BUG_ON
(
ùmp
 =ð
this_cvma
);

268 
	`Œaû_cdev_vma
(
ùmp
, 0,

269 !
this_cvma
 ? 'E' : 'e');

271 
	`z­_vma_±es
(
ùmp
->
vma
, ctmp->vma->
vm_¡¬t
,

272 
ùmp
->
vma
->
vm_’d
 -

273 
ùmp
->
vma
->
vm_¡¬t
);

274 
	`nå_dev_ýp_vma_»Ëa£
(
ùmp
);

276 
”r
 = 0;

277 ià(
this_cvma
)

282  
”r
;

283 
	}
}

285 
	$nå_dev_ýp_Ý’
(
šode
 *šode, 
fže
 *file)

287 
nå_dev_ýp
 *
cdev
 = 
	`cÚš”_of
(

288 
šode
->
i_cdev
, 
nå_dev_ýp
, 
cdev
);

289 
nå_dev_ýp_chªÃl
 *
chª
;

290 
u16
 
š‹rçû
;

291 
chªÃl
;

293 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
cdev
->
ýp
);

295 ià(
	`NFP_CPP_INTERFACE_CHANNEL_of
(
š‹rçû
) !=

296 
NFP_CPP_INTERFACE_CHANNEL_PEROPENER
) {

298 
chªÃl
 = 
	`NFP_CPP_INTERFACE_CHANNEL_of
(
š‹rçû
);

300 ià(
chªÃl
 >ð
NFP_DEV_CPP_CHANNELS
)

301  -
ENODEV
;

304 ià(
	`‹¡_ªd_£t_b™
(
chªÃl
, 
cdev
->
chªÃl_b™m­
))

305  -
EBUSY
;

309 
chªÃl
 = 0; chªÃÈ< 
NFP_DEV_CPP_CHANNELS
; channel++) {

310 ià(
	`‹¡_ªd_£t_b™
(
chªÃl
,

311 
cdev
->
chªÃl_b™m­
) == 0)

315 ià(
chªÃl
 =ð
NFP_DEV_CPP_CHANNELS
)

316  -
EBUSY
;

318 
š‹rçû
 = 
	`NFP_CPP_INTERFACE
(

319 
	`NFP_CPP_INTERFACE_TYPE_of
(
š‹rçû
),

320 
	`NFP_CPP_INTERFACE_UNIT_of
(
š‹rçû
),

321 
chªÃl
);

324 
chª
 = 
	`km®loc
((*chª), 
GFP_KERNEL
);

325 ià(!
chª
) {

326 
	`þ—r_b™
(
chªÃl
, 
cdev
->
chªÃl_b™m­
);

327 
	`wake_up
(&
cdev
->
chªÃl_wa™
);

328  -
ENOMEM
;

331 
chª
->
š‹rçû
 = interface;

332 
chª
->
cdev
 = cdev;

334 
fže
->
´iv©e_d©a
 = 
chª
;

337 
	}
}

339 
	$nå_dev_ýp_»Ëa£
(
šode
 *šode, 
fže
 *file)

341 
nå_dev_ýp_chªÃl
 *
chª
 = 
fže
->
´iv©e_d©a
;

342 
nå_dev_ýp
 *
cdev
 = 
chª
->cdev;

343 
u16
 
š‹rçû
 = 
chª
->interface;

344 
nå_dev_ýp_¬—
 *
»q
, *
¹mp
;

345 
nå_dev_ýp_ev’t
 *
ev
, *
‘mp
;

347 
	`mu‹x_lock
(&
cdev
->
ev’t
.
lock
);

348 
	`li¡_fÜ_—ch_’Œy_§ã
(
ev
, 
‘mp
, &
cdev
->
ev’t
.
li¡
,†ist) {

349 ià(
ev
->
š‹rçû
 == interface) {

350 
	`nå_ýp_ev’t_ä“
(
ev
->
ýp_ev’t
);

351 
	`li¡_d–
(&
ev
->
li¡
);

352 
	`kä“
(
ev
);

355 
	`mu‹x_uÆock
(&
cdev
->
ev’t
.
lock
);

357 
	`mu‹x_lock
(&
cdev
->
»q
.
lock
);

358 
	`li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
¹mp
, &
cdev
->»q.
li¡
, 
»q_li¡
) {

359 ià(
»q
->
š‹rçû
 == interface) {

360 
	`BUG_ON
(!
	`li¡_em±y
(&
»q
->
vma
.
li¡
));

361 
	`nå_dev_ýp_¬—_ä“
(
»q
);

364 
	`mu‹x_uÆock
(&
cdev
->
»q
.
lock
);

366 
	`þ—r_b™
(
	`NFP_CPP_INTERFACE_CHANNEL_of
(
š‹rçû
),

367 
cdev
->
chªÃl_b™m­
);

369 
	`kä“
(
fže
->
´iv©e_d©a
);

370 
fže
->
´iv©e_d©a
 = 
NULL
;

372 
	`wake_up
(&
cdev
->
chªÃl_wa™
);

374 
	}
}

376 
ssize_t
 
	$nå_dev_ýp_Ý
(
fže
 *file,

377 
u32
 
ýp_id
, 
__u£r
 *
buff
,

378 
size_t
 
couÁ
, 
loff_t
 *
ofå
, 
wr™e
)

380 
nå_dev_ýp_chªÃl
 *
chª
 = 
fže
->
´iv©e_d©a
;

381 
nå_dev_ýp
 *
cdev
 = 
chª
->cdev;

382 
nå_ýp
 *
ýp
 = 
cdev
->cpp;

383 
nå_ýp_¬—
 *
¬—
;

384 
u32
 
__u£r
 *
ud©a
;

385 
u32
 
tmpbuf
[16];

386 
u32
 
pos
, 
Ën
;

387 
”r
 = 0;

388 
size_t
 
cu¾’
 = 
couÁ
, 
tÙËn
 = 0;

390 ià(((*
ofå
 + 
couÁ
 - 1è& ~(
NFP_CPP_MEMIO_BOUNDARY
 - 1)) !=

391 (*
ofå
 & ~(
NFP_CPP_MEMIO_BOUNDARY
 - 1))) {

392 
cu¾’
 = 
NFP_CPP_MEMIO_BOUNDARY
 -

393 (*
ofå
 & (
NFP_CPP_MEMIO_BOUNDARY
 - 1));

396 
couÁ
 > 0) {

397 
¬—
 = 
	`nå_ýp_¬—_®loc_w™h_Çme
(

398 
ýp
, 
ýp_id
, "nå.cdev", *
ofå
, 
cu¾’
);

399 ià(!
¬—
)

400  -
EIO
;

402 
”r
 = 
	`nå_ýp_¬—_acquœe_nÚblockšg
(
¬—
);

403 ià(
”r
 =ð-
EAGAIN
) {

405 
	`mu‹x_lock
(&
cdev
->
¬—
.
lock
);

406 
	`nå_dev_ýp_vma_eviù
(
cdev
, 
NULL
);

407 
	`mu‹x_uÆock
(&
cdev
->
¬—
.
lock
);

409 
”r
 = 
	`nå_ýp_¬—_acquœe
(
¬—
);

411 ià(
”r
 < 0) {

412 
	`nå_ýp_¬—_ä“
(
¬—
);

413  
”r
;

416 
pos
 = 0;…o < 
cu¾’
;…o +ð
Ën
) {

417 
Ën
 = 
cu¾’
 - 
pos
;

418 ià(
Ën
 > (
tmpbuf
))

419 
Ën
 = (
tmpbuf
);

420 
ud©a
 = (
u32
 
__u£r
 *)(
buff
 + 
pos
);

422 ià(
wr™e
) {

423 ià(
	`cÝy_äom_u£r
(
tmpbuf
, 
ud©a
, 
Ën
)) {

424 
”r
 = -
EFAULT
;

427 
”r
 = 
	`nå_ýp_¬—_wr™e
(

428 
¬—
, 
pos
, 
tmpbuf
, 
Ën
);

429 ià(
”r
 < 0)

432 
”r
 = 
	`nå_ýp_¬—_»ad
(
¬—
, 
pos
, 
tmpbuf
, 
Ën
);

433 ià(
”r
 < 0)

435 ià(
	`cÝy_to_u£r
(
ud©a
, 
tmpbuf
, 
Ën
)) {

436 
”r
 = -
EFAULT
;

442 *
ofå
 +ð
pos
;

443 
tÙËn
 +ð
pos
;

444 
buff
 +ð
pos
;

445 
	`nå_ýp_¬—_»Ëa£
(
¬—
);

446 
	`nå_ýp_¬—_ä“
(
¬—
);

448 ià(
”r
 < 0)

449  
”r
;

451 
couÁ
 -ð
pos
;

452 
cu¾’
 = (
couÁ
 > 
NFP_CPP_MEMIO_BOUNDARY
) ?

453 
NFP_CPP_MEMIO_BOUNDARY
 : 
couÁ
;

456  
tÙËn
;

457 
	}
}

459 
ssize_t
 
	$nå_dev_ýp_»ad
(
fže
 *fže, 
__u£r
 *
buff
,

460 
size_t
 
couÁ
, 
loff_t
 *
ofå
)

462 
u32
 
ýp_id
 = (*
ofå
 >> 40) << 8;

463 
loff_t
 
off£t
 = *
ofå
 & ((1ull << 40) - 1);

464 
r
;

466 
r
 = 
	`nå_dev_ýp_Ý
(
fže
, 
ýp_id
, 
buff
, 
couÁ
, &
off£t
, 0);

467 *
ofå
 = ((
loff_t
)(
ýp_id
 >> 8è<< 40è| 
off£t
;

468  
r
;

469 
	}
}

471 
ssize_t
 
	$nå_dev_ýp_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buff
,

472 
size_t
 
couÁ
, 
loff_t
 *
ofå
)

474 
u32
 
ýp_id
 = (*
ofå
 >> 40) << 8;

475 
loff_t
 
off£t
 = *
ofå
 & ((1ull << 40) - 1);

476 
r
;

478 
r
 = 
	`nå_dev_ýp_Ý
(
fže
, 
ýp_id
,

479 (
__u£r
 *)
buff
, 
couÁ
, &
off£t
, 1);

480 *
ofå
 = ((
loff_t
)(
ýp_id
 >> 8è<< 40è| 
off£t
;

481  
r
;

482 
	}
}

484 
	$nå_dev_ýp_¿nge_check
(
li¡_h—d
 *
»q_li¡
,

485 
nå_ýp_¬—_»que¡
 *
¬—_»q
)

487 
nå_dev_ýp_¬—
 *
¬—
;

490 
	`li¡_fÜ_—ch_’Œy
(
¬—
, 
»q_li¡
,„eq_list) {

491 ià(
¬—_»q
->
off£t
 < (
¬—
->
»q
.off£ˆ+‡»a->»q.
size
) &&

492 (
¬—_»q
->
off£t
 +‡»a_»q->
size
è> 
¬—
->
»q
.offset) {

493  -
ETXTBSY
;

498 
	}
}

503 
	$ex¶ic™_c¤_to_cmd
(
nå_ýp_ex¶ic™
 *
ex¶
,

504 cÚ¡ *
c¤
)

506 
nå_ýp_ex¶ic™_sigÇl_mode
 
siga_mode
, 
sigb_mode
;

507 
sigÇl_ma¡”
, 
sigÇl_»f
;

508 
d©a_ma¡”
, 
d©a_»f
;

509 
u32
 
ex¶1
, 
ex¶2
, 
po¡
;

510 
u32
 
ýp_id
;

511 
”r
;

513 
po¡
 = 
c¤
[
NFP_IOCTL_CPP_EXPL_POST
];

514 
ex¶1
 = 
c¤
[
NFP_IOCTL_CPP_EXPL1_BAR
];

515 
ex¶2
 = 
c¤
[
NFP_IOCTL_CPP_EXPL2_BAR
];

517 
ýp_id
 = 
	`NFP_CPP_ID
(
	`NFP_ARM_GCSR_EXPL2_BAR_TGT_of
(
ex¶2
),

518 
	`NFP_ARM_GCSR_EXPL2_BAR_ACT_of
(
ex¶2
),

519 
	`NFP_ARM_GCSR_EXPL2_BAR_TOK_of
(
ex¶2
));

521 
”r
 = 
	`nå_ýp_ex¶ic™_£t_rg‘
(
ex¶
, 
ýp_id
,

522 
	`NFP_ARM_GCSR_EXPL2_BAR_LEN_of
(
ex¶2
),

523 
	`NFP_ARM_GCSR_EXPL2_BAR_BYTE_MASK_of
(
ex¶2
));

524 ià(
”r
 < 0)

525  
”r
;

527 
d©a_ma¡”
 = 
	`NFP_ARM_GCSR_EXPL1_BAR_DATA_MASTER_of
(
ex¶1
);

528 
d©a_»f
 = 
	`NFP_ARM_GCSR_EXPL1_BAR_DATA_REF_of
(
ex¶1
);

530 ià(
d©a_ma¡”
 || 
d©a_»f
) {

531 
”r
 = 
	`nå_ýp_ex¶ic™_£t_d©a
(
ex¶
, 
d©a_ma¡”
, 
d©a_»f
);

532 ià(
”r
 < 0)

533  
”r
;

536 
sigÇl_ma¡”
 = 
	`NFP_ARM_GCSR_EXPL2_BAR_SIGNAL_MASTER_of
(
ex¶2
);

537 
sigÇl_»f
 = 
	`NFP_ARM_GCSR_EXPL1_BAR_SIGNAL_REF_of
(
ex¶1
);

539 ià(
sigÇl_ma¡”
 || 
sigÇl_»f
) {

540 
”r
 = 
	`nå_ýp_ex¶ic™_£t_sigÇl
(
ex¶
, 
sigÇl_ma¡”
,

541 
sigÇl_»f
);

542 ià(
”r
 < 0)

543  
”r
;

546 
siga_mode
 = 
NFP_SIGNAL_NONE
;

547 ià(
po¡
 & 
NFP_ARM_GCSR_EXPL_POST_SIG_A_VALID
) {

548 
po¡
 & (
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS
 | (1 << 2))) {

549 
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PUSH
:

550 
siga_mode
 = 
NFP_SIGNAL_PUSH_OPTIONAL
;

552 
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PUSH
 | (1 << 2):

553 
siga_mode
 = 
NFP_SIGNAL_PUSH
;

555 
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PULL
:

556 
siga_mode
 = 
NFP_SIGNAL_PULL_OPTIONAL
;

558 
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PULL
 | (1 << 2):

559 
siga_mode
 = 
NFP_SIGNAL_PULL
;

564 
sigb_mode
 = 
NFP_SIGNAL_NONE
;

565 ià(
po¡
 & 
NFP_ARM_GCSR_EXPL_POST_SIG_B_VALID
) {

566 
po¡
 & (
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS
 | (1 << 3))) {

567 
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PUSH
:

568 
sigb_mode
 = 
NFP_SIGNAL_PUSH_OPTIONAL
;

570 
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PUSH
 | (1 << 3):

571 
sigb_mode
 = 
NFP_SIGNAL_PUSH
;

573 
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PULL
:

574 
sigb_mode
 = 
NFP_SIGNAL_PULL_OPTIONAL
;

576 
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PULL
 | (1 << 3):

577 
sigb_mode
 = 
NFP_SIGNAL_PULL
;

582 
”r
 = 
	`nå_ýp_ex¶ic™_£t_po¡ed
(
ex¶
,

583 (
ex¶1
 &

584 
NFP_ARM_GCSR_EXPL1_BAR_POSTED
) ?

586 
	`NFP_ARM_GCSR_EXPL_POST_SIG_A_of
(
po¡
), 
siga_mode
,

587 
	`NFP_ARM_GCSR_EXPL_POST_SIG_B_of
(
po¡
), 
sigb_mode
);

588 ià(
”r
 < 0)

589  
”r
;

592 
	}
}

594 
	$do_ýp_ev’t_acquœe
(
nå_dev_ýp
 *
cdev
, 
u16
 
š‹rçû
,

595 
nå_ýp_ev’t_»que¡
 *
ev’t_»q
)

597 
nå_dev_ýp_ev’t
 *
ev’t
;

598 
”r
;

600 ià(
ev’t_»q
->
sigÇl
 <ð0 ||ƒv’t_»q->sigÇÈ>ð
_NSIG
)

601  -
EINVAL
;

603 
ev’t
 = 
	`km®loc
((*ev’t), 
GFP_KERNEL
);

604 ià(!
ev’t
)

605  -
ENOMEM
;

607 
ev’t
->
sigÇl
 = 
ev’t_»q
->signal;

608 
ev’t
->
ýp_ev’t
 = 
	`nå_ýp_ev’t_®loc
(
cdev
->
ýp
,

609 
ev’t_»q
->
m©ch
,ƒv’t_»q->
mask
,ƒv’t_»q->
ty³
);

610 ià(
	`IS_ERR
(
ev’t
->
ýp_ev’t
)) {

611 
”r
 = 
	`PTR_ERR
(
ev’t
->
ýp_ev’t
);

612 
	`kä“
(
ev’t
);

613  
”r
;

616 
”r
 = 
	`nå_ýp_ev’t_as_ÿÎback
(
ev’t
->
ýp_ev’t
,

617 
nå_dev_ýp_ev’t_cb
, 
ev’t
);

618 ià(
”r
 < 0) {

619 
	`nå_ýp_ev’t_ä“
(
ev’t
->
ýp_ev’t
);

620 
	`kä“
(
ev’t
);

621  
”r
;

624 
ev’t
->
š‹rçû
 = interface;

625 
ev’t
->
sk
 = 
cu¼’t
;

626 
ev’t
->
»q
 = *
ev’t_»q
;

627 
	`mu‹x_lock
(&
cdev
->
ev’t
.
lock
);

628 
	`li¡_add_ž
(&
ev’t
->
li¡
, &
cdev
->event.list);

629 
	`mu‹x_uÆock
(&
cdev
->
ev’t
.
lock
);

632 
	}
}

634 
	$do_ýp_ev’t_»Ëa£
(
nå_dev_ýp
 *
cdev
, 
u16
 
š‹rçû
,

635 
nå_ýp_ev’t_»que¡
 *
ev’t_»q
)

637 
nå_dev_ýp_ev’t
 *
ev’t
, *
‘mp
;

639 
	`mu‹x_lock
(&
cdev
->
ev’t
.
lock
);

640 
	`li¡_fÜ_—ch_’Œy_§ã
(
ev’t
, 
‘mp
,

641 &
cdev
->
ev’t
.
li¡
,†ist) {

643 ià(
ev’t
->
š‹rçû
 != interface)

646 ià(
	`memcmp
(&
ev’t_»q
, &
ev’t
->
»q
,

647 (
ev’t_»q
)) == 0) {

648 
	`nå_ýp_ev’t_ä“
(
ev’t
->
ýp_ev’t
);

649 
	`li¡_d–
(&
ev’t
->
li¡
);

650 
	`kä“
(
ev’t
);

653 
	`mu‹x_uÆock
(&
cdev
->
ev’t
.
lock
);

656 
	}
}

658 
	$do_ýp_ex¶_»que¡
(
nå_dev_ýp_chªÃl
 *
chª
,

659 
nå_ýp_ex¶ic™_»que¡
 *
ex¶ic™_»q
)

661 
”r
, 
»t
 = -
EINVAL
;

662 
nå_ýp_ex¶ic™
 *
ex¶
;

664 
ex¶
 = 
	`nå_ýp_ex¶ic™_acquœe
(
chª
->
cdev
->
ýp
);

665 ià(!
ex¶
)

666  -
ENOMEM
;

668 
”r
 = 
	`ex¶ic™_c¤_to_cmd
(
ex¶
, &
ex¶ic™_»q
->
c¤
[0]);

669 ià(
”r
 < 0)

670 
ex™
;

672 
”r
 = 
	`nå_ýp_ex¶ic™_put
(
ex¶
, &
ex¶ic™_»q
->
d©a
[0],

673 
ex¶ic™_»q
->
š
);

674 ià(
”r
 < 0)

675 
ex™
;

677 
”r
 = 
	`nå_ýp_ex¶ic™_do
(
ex¶
, 
ex¶ic™_»q
->
add»ss
);

678 
»t
 = 
”r
;

679 ià(
”r
 < 0)

680 
ex™
;

682 
”r
 = 
	`nå_ýp_ex¶ic™_g‘
(
ex¶
, &
ex¶ic™_»q
->
d©a
[0],

683 
ex¶ic™_»q
->
out
);

684 ià(
”r
 < 0)

685 
ex™
;

687 
”r
 = 
»t
;

689 
ex™
:

690 
	`nå_ýp_ex¶ic™_»Ëa£
(
ex¶
);

692  
”r
;

693 
	}
}

695 
	$do_ýp_id’tifiÿtiÚ
(
nå_dev_ýp_chªÃl
 *
chª
,

696 
nå_ýp_id’tifiÿtiÚ
 *
id’t
)

698 
tÙ®
;

700 
tÙ®
 = 
	`off£tof
(
nå_ýp_id’tifiÿtiÚ
, 
size
)

701 + (
id’t
->
size
);

703 ià(
id’t
->
size
 >ð
	`off£tof
(
nå_ýp_id’tifiÿtiÚ
, 
mod–
)

704 + (
id’t
->
mod–
)) {

705 
id’t
->
mod–
 = 
	`nå_ýp_mod–
(
chª
->
cdev
->
ýp
);

706 
tÙ®
 = 
	`off£tof
(
nå_ýp_id’tifiÿtiÚ
, 
mod–
)

707 + (
id’t
->
mod–
);

709 ià(
id’t
->
size
 >ð
	`off£tof
(
nå_ýp_id’tifiÿtiÚ
, 
š‹rçû
)

710 + (
id’t
->
š‹rçû
)) {

711 
id’t
->
š‹rçû
 = 
chª
->interface;

712 
tÙ®
 = 
	`off£tof
(
nå_ýp_id’tifiÿtiÚ
, 
š‹rçû
)

713 + (
id’t
->
š‹rçû
);

715 ià(
id’t
->
size
 >ð
	`off£tof
(
nå_ýp_id’tifiÿtiÚ
, 
£rŸl_hi
)

716 + (
id’t
->
£rŸl_hi
)) {

717 cÚ¡ 
u8
 *
£rŸl
;

719 
	`nå_ýp_£rŸl
(
chª
->
cdev
->
ýp
, &
£rŸl
);

720 
id’t
->
£rŸl_hi
 = (
£rŸl
[0] << 8) |

721 (
£rŸl
[1] << 0);

722 
id’t
->
£rŸl_lo
 = (
£rŸl
[2] << 24) |

723 (
£rŸl
[3] << 16) |

724 (
£rŸl
[4] << 8) |

725 (
£rŸl
[5] << 0);

726 
tÙ®
 = 
	`off£tof
(
nå_ýp_id’tifiÿtiÚ
, 
£rŸl_hi
)

727 + (
id’t
->
£rŸl_hi
);

731 
id’t
->
size
 = 
tÙ®
;

732 
	}
}

734 
	$do_fw_lßd
(
nå_dev_ýp
 *
cdev
)

736 cÚ¡ 
fœmw¬e
 *
fw
;

737 
nå_n¥
 *
n¥
;

738 
”r
;

740 
”r
 = 
	`»que¡_fœmw¬e
(&
fw
, 
cdev
->
fœmw¬e
, cdev->
dev
);

741 ià(
”r
 < 0)

742  
”r
;

744 
n¥
 = 
	`nå_n¥_Ý’
(
cdev
->
ýp
);

745 ià(
	`IS_ERR
(
n¥
)) {

746 
”r
 = 
	`PTR_ERR
(
n¥
);

747 
ex™_»Ëa£_fw
;

750 
”r
 = 
	`nå_n¥_lßd_fw
(
n¥
, 
fw
);

751 
	`nå_n¥_þo£
(
n¥
);

753 
ex™_»Ëa£_fw
:

754 
	`»Ëa£_fœmw¬e
(
fw
);

756  
”r
;

757 
	}
}

759 
	$do_ýp_¬—_»que¡
(
nå_dev_ýp
 *
cdev
, 
u16
 
š‹rçû
,

760 
nå_ýp_¬—_»que¡
 *
¬—_»q
)

762 
”r
 = 0;

764 ià((
¬—_»q
->
size
 & ~
PAGE_MASK
) != 0)

765  -
EINVAL
;

767 ià(
¬—_»q
->
off£t
 !ð~0 && (¬—_»q->off£ˆ& ~
PAGE_MASK
) != 0)

768  -
EINVAL
;

770 
	`mu‹x_lock
(&
cdev
->
»q
.
lock
);

772 ià(
¬—_»q
->
off£t
 == ~0) {

774 
¬—_»q
->
off£t
 = 0;

775 
”r
 = 
	`nå_dev_ýp_¿nge_check
(&
cdev
->
»q
.
li¡
, 
¬—_»q
);

776 ià(
”r
 < 0) {

777 
nå_dev_ýp_¬—
 *
¬—
;

779 
	`li¡_fÜ_—ch_’Œy
(
¬—
, &
cdev
->
»q
.
li¡
, 
»q_li¡
) {

780 
¬—_»q
->
off£t
 = 
¬—
->
»q
.offset +

781 
¬—
->
»q
.
size
;

782 
”r
 = 
	`nå_dev_ýp_¿nge_check
(&
cdev
->
»q
.
li¡
,

783 
¬—_»q
);

784 ià(
”r
 == 0)

790 ià(
”r
 >= 0) {

792 
”r
 = 
	`nå_dev_ýp_¿nge_check
(&
cdev
->
»q
.
li¡
, 
¬—_»q
);

793 ià(
”r
 >= 0)

794 
”r
 = 
	`nå_dev_ýp_¬—_®loc
(
cdev
, 
š‹rçû
, 
¬—_»q
);

797 
	`mu‹x_uÆock
(&
cdev
->
»q
.
lock
);

799  
”r
;

800 
	}
}

802 
	$do_ýp_¬—_»Ëa£
(
nå_dev_ýp
 *
cdev
, 
u16
 
š‹rçû
,

803 
nå_ýp_¬—_»que¡
 *
¬—_»q
)

805 
nå_dev_ýp_¬—
 *
¬—
, *
©mp
;

806 
”r
 = -
ENOENT
;

808 
	`mu‹x_lock
(&
cdev
->
»q
.
lock
);

810 
	`li¡_fÜ_—ch_’Œy_§ã
(
¬—
, 
©mp
,

811 &
cdev
->
»q
.
li¡
, 
»q_li¡
) {

812 ià(
¬—
->
»q
.
off£t
 =ð
¬—_»q
->offset) {

813 
	`mu‹x_lock
(&
cdev
->
¬—
.
lock
);

814 
”r
 = 
	`li¡_em±y
(&
¬—
->
vma
.
li¡
è? 0 : -
EBUSY
;

815 
	`mu‹x_uÆock
(&
cdev
->
¬—
.
lock
);

816 ià(
”r
 == 0)

817 
	`nå_dev_ýp_¬—_ä“
(
¬—
);

822 
	`mu‹x_uÆock
(&
cdev
->
»q
.
lock
);

824  
”r
;

825 
	}
}

829 #ifdeà
HAVE_UNLOCKED_IOCTL


830 
	$nå_dev_ýp_ioùl
(
fže
 *
fžp
, 
cmd
,

831 
¬g
)

833 
	$nå_dev_ýp_ioùl
(
šode
 *šode, 
fže
 *
fžp
,

834 
cmd
, 
¬g
)

837 
nå_dev_ýp_chªÃl
 *
chª
 = 
fžp
->
´iv©e_d©a
;

838 
nå_dev_ýp
 *
cdev
 = 
chª
->cdev;

839 
nå_ýp_¬—_»que¡
 
¬—_»q
;

840 
nå_ýp_ev’t_»que¡
 
ev’t_»q
;

841 
nå_ýp_ex¶ic™_»que¡
 
ex¶ic™_»q
;

842 
nå_ýp_id’tifiÿtiÚ
 
id’t
;

843 
__u£r
 *
d©a
 = (__u£¸*)
¬g
;

844 
”r
;

846 
cmd
) {

847 
NFP_IOCTL_CPP_IDENTIFICATION
:

849 ià(!
¬g
)

850  (
id’t
);

852 ià(
	`cÝy_äom_u£r
(&
id’t
.
size
, 
d©a
, (ident.size)))

853  -
EFAULT
;

855 
	`do_ýp_id’tifiÿtiÚ
(
chª
, &
id’t
);

858 ià(
	`cÝy_to_u£r
(
d©a
, &
id’t
, id’t.
size
))

859  -
EFAULT
;

861  (
id’t
);

863 
NFP_IOCTL_FIRMWARE_LOAD
:

864 ià(
	`cÝy_äom_u£r
(
cdev
->
fœmw¬e
, 
d©a
,

865 (
cdev
->
fœmw¬e
)))

866  -
EFAULT
;

868 
cdev
->
fœmw¬e
[(cdev->firmware) - 1] = 0;

870  
	`do_fw_lßd
(
cdev
);

872 
NFP_IOCTL_FIRMWARE_LAST
:

873 ià(
	`cÝy_to_u£r
(
d©a
, 
cdev
->
fœmw¬e
, (cdev->firmware)))

874  -
EFAULT
;

878 
NFP_IOCTL_CPP_AREA_REQUEST
:

879 ià(
	`cÝy_äom_u£r
(&
¬—_»q
, 
d©a
, (area_req)))

880  -
EFAULT
;

882 
”r
 = 
	`do_ýp_¬—_»que¡
(
chª
->
cdev
, chª->
š‹rçû
,

883 &
¬—_»q
);

884 ià(
”r
 < 0)

885  
”r
;

888 ià(
	`cÝy_to_u£r
(
d©a
, &
¬—_»q
, (area_req)))

889  -
EFAULT
;

893 
NFP_IOCTL_CPP_AREA_RELEASE
:

894 
NFP_IOCTL_CPP_AREA_RELEASE_OBSOLETE
:

895 ià(
cmd
 =ð
NFP_IOCTL_CPP_AREA_RELEASE
) {

896 
”r
 = 
	`cÝy_äom_u£r
(&
¬—_»q
, 
d©a
, (area_req));

899 
”r
 = 
	`cÝy_äom_u£r
(&
¬—_»q
.
off£t
, 
d©a
,

900 (
¬—_»q
.
off£t
));

902 ià(
”r
)

903  -
EFAULT
;

905  
	`do_ýp_¬—_»Ëa£
(
cdev
, 
chª
->
š‹rçû
, &
¬—_»q
);

907 
NFP_IOCTL_CPP_EXPL_REQUEST
:

908 ià(
	`cÝy_äom_u£r
(&
ex¶ic™_»q
, 
d©a
, (explicit_req)))

909  -
EFAULT
;

911 
”r
 = 
	`do_ýp_ex¶_»que¡
(
chª
, &
ex¶ic™_»q
);

912 ià(
”r
 < 0)

913  
”r
;

915 ià(
	`cÝy_to_u£r
(
d©a
, &
ex¶ic™_»q
, (explicit_req)))

916  -
EFAULT
;

920 
NFP_IOCTL_CPP_EVENT_ACQUIRE
:

921 ià(
	`cÝy_äom_u£r
(&
ev’t_»q
, 
d©a
, (event_req)))

922  -
EFAULT
;

924  
	`do_ýp_ev’t_acquœe
(
chª
->
cdev
, chª->
š‹rçû
,

925 &
ev’t_»q
);

927 
NFP_IOCTL_CPP_EVENT_RELEASE
:

928 ià(
	`cÝy_äom_u£r
(&
ev’t_»q
, 
d©a
, (event_req)))

929  -
EFAULT
;

931  
	`do_ýp_ev’t_»Ëa£
(
chª
->
cdev
, chª->
š‹rçû
,

932 &
ev’t_»q
);

934  -
EINVAL
;

936 
	}
}

938 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 20, 0)

939 
vm_çuÉ_t
 
	$nå_ýp_mm­_çuÉ
(
vm_çuÉ
 *
vmf
)

941 
vm_¬—_¡ruù
 *
vma
 = 
vmf
->vma;

942 #–ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 11, 0)

943 
	$nå_ýp_mm­_çuÉ
(
vm_çuÉ
 *
vmf
)

945 
vm_¬—_¡ruù
 *
vma
 = 
vmf
->vma;

947 
	$nå_ýp_mm­_çuÉ
(
vm_¬—_¡ruù
 *
vma
, 
vm_çuÉ
 *
vmf
)

950 
nå_dev_ýp_vma
 *
cvma
 = 
vma
->
vm_´iv©e_d©a
;

951 
nå_dev_ýp_¬—
 *
¬—
;

952 
nå_dev_ýp
 *
cdev
;

953 
off_t
 
off£t
;

954 
”r
;

956 ià(!
cvma
)

957  
VM_FAULT_SIGBUS
;

959 
¬—
 = 
cvma
->area;

960 
cdev
 = 
¬—
->cdev;

963 
off£t
 = 
	`com·t_vmf_g‘_addr
(
vmf
è- 
vma
->
vm_¡¬t
;

964 ià(
off£t
 >ð
¬—
->
»q
.
size
)

965  
VM_FAULT_SIGBUS
;

967 
	`mu‹x_lock
(&
cdev
->
¬—
.
lock
);

968 ià(!
	`li¡_em±y
(&
cvma
->
vma_li¡
)) {

972 
”r
 = 1;

974 
”r
 = 
	`nå_dev_ýp_vma_acquœe
(
cvma
);

975 ià(
”r
 < 0) {

976 
”r
 = 
	`nå_dev_ýp_vma_eviù
(
cdev
, 
cvma
);

977 ià(
”r
 == 0)

978 
”r
 = 
	`nå_dev_ýp_vma_acquœe
(
cvma
);

981 
	`mu‹x_uÆock
(&
cdev
->
¬—
.
lock
);

983 ià(
”r
 < 0)

985 
	`scheduË
();

987 
	`Œaû_cdev_vma
(
cvma
, 
off£t
,

988 (
”r
 < 0) ?

989 '!' : ((
”r
 == 0) ?

992 ià(
”r
 >= 0) {

993 
phys_addr_t
 
io
;

998 
io
 = 
	`nå_ýp_¬—_phys
(
¬—
->¬—è+ 
off£t
;

999 
	`BUG_ON
(
io
 == 0);

1000 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 20, 0)

1001 
	`vm_š£¹_pâ
(
vma
, 
	`com·t_vmf_g‘_addr
(
vmf
), 
io
 >> 
PAGE_SHIFT
);

1002 
”r
 = 0;

1004  
	`vmf_š£¹_pâ
(
vma
, 
	`com·t_vmf_g‘_addr
(
vmf
),

1005 
io
 >> 
PAGE_SHIFT
);

1009 
”r
) {

1011 -
ERESTARTSYS
:

1012 -
EAGAIN
:

1013  
VM_FAULT_NOPAGE
;

1014 -
ENOMEM
:

1015  
VM_FAULT_OOM
;

1017  
VM_FAULT_SIGBUS
;

1019 
	}
}

1021 
	$nå_ýp_mm­_Ý’
(
vm_¬—_¡ruù
 *
vma
)

1023 
nå_dev_ýp_vma
 *
cvma
;

1024 
nå_dev_ýp_¬—
 *
¬—
 =

1025 ((
nå_dev_ýp_vma
 *)
vma
->
vm_´iv©e_d©a
)->
¬—
;

1027 
cvma
 = 
	`km®loc
((*cvma), 
GFP_KERNEL
);

1028 ià(
cvma
) {

1029 
cvma
->
¬—
 =‡rea;

1030 
cvma
->
vma
 = vma;

1031 
	`INIT_LIST_HEAD
(&
cvma
->
vma_li¡
);

1034 
	`z­_vma_±es
(
cvma
->
vma
, cvma->vma->
vm_¡¬t
,

1035 
cvma
->
vma
->
vm_’d
 - cvma->vma->
vm_¡¬t
);

1036 
	`Œaû_cdev_vma
(
cvma
, 0, 'o');

1039 
vma
->
vm_´iv©e_d©a
 = 
cvma
;

1040 
	}
}

1042 
	$nå_ýp_mm­_þo£
(
vm_¬—_¡ruù
 *
vma
)

1044 
nå_dev_ýp_vma
 *
cvma
 = 
vma
->
vm_´iv©e_d©a
;

1046 ià(
cvma
) {

1047 
nå_dev_ýp
 *
cdev
 = 
cvma
->
¬—
->cdev;

1049 
	`mu‹x_lock
(&
cdev
->
¬—
.
lock
);

1050 
	`Œaû_cdev_vma
(
cvma
, 0, 'c');

1051 
	`nå_dev_ýp_vma_»Ëa£
(
cvma
);

1052 
	`mu‹x_uÆock
(&
cdev
->
¬—
.
lock
);

1054 
	`kä“
(
cvma
);

1056 
	}
}

1058 #ià(
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 31))

1059 
vm_Ý”©iÚs_¡ruù
 
	gnå_ýp_mm­_Ýs
 = {

1061 cÚ¡ 
vm_Ý”©iÚs_¡ruù
 
nå_ýp_mm­_Ýs
 = {

1063 .
çuÉ
 = 
nå_ýp_mm­_çuÉ
,

1064 .
	gÝ’
 = 
nå_ýp_mm­_Ý’
,

1065 .
	gþo£
 = 
nå_ýp_mm­_þo£
,

1068 
	$nå_dev_ýp_mm­
(
fže
 *
fžp
, 
vm_¬—_¡ruù
 *
vma
)

1070 
nå_dev_ýp_chªÃl
 *
chª
 = 
fžp
->
´iv©e_d©a
;

1071 
nå_dev_ýp
 *
cdev
 = 
chª
->cdev;

1072 
nå_dev_ýp_vma
 *
cvma
;

1073 
nå_dev_ýp_¬—
 *
¬—
;

1074 
off£t
;

1075 
size
;

1076 
”r
;

1078 
off£t
 = 
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

1079 
size
 = 
vma
->
vm_’d
 - vma->
vm_¡¬t
;

1082 
”r
 = -
EINVAL
;

1083 
	`mu‹x_lock
(&
cdev
->
»q
.
lock
);

1084 
	`li¡_fÜ_—ch_’Œy
(
¬—
, &
cdev
->
»q
.
li¡
, 
»q_li¡
) {

1085 ià((
¬—
->
»q
.
off£t
 <= offset) &&

1086 (
¬—
->
»q
.
off£t
 +‡»a->»q.
size
) >= (offset + size)) {

1087 
”r
 = 0;

1091 
	`mu‹x_uÆock
(&
cdev
->
»q
.
lock
);

1092 ià(
”r
 < 0)

1093  
”r
;

1095 
cvma
 = 
	`km®loc
((*cvma), 
GFP_KERNEL
);

1096 ià(!
cvma
)

1097  -
ENOMEM
;

1099 
cvma
->
¬—
 =‡rea;

1100 
cvma
->
vma
 = vma;

1101 
	`INIT_LIST_HEAD
(&
cvma
->
vma_li¡
);

1103 #iâdeà
VM_RESERVED


1104 
	#VM_RESERVED
 0

	)

1106 #iâdeà
VM_DONTDUMP


1107 
	#VM_DONTDUMP
 0

	)

1110 
vma
->
vm_æags
 |ð
VM_RESERVED
 | 
VM_IO
 | 
VM_PFNMAP


1111 | 
VM_DONTEXPAND
 | 
VM_DONTDUMP
 | 
VM_SHARED
;

1112 
vma
->
vm_Ýs
 = &
nå_ýp_mm­_Ýs
;

1113 
vma
->
vm_·ge_´Ù
 = 
	`pg´Ù_nÚÿched
(vma->vm_page_prot);

1114 
vma
->
vm_´iv©e_d©a
 = 
cvma
;

1116 
	`Œaû_cdev_vma
(
cvma
, 0, 'm');

1119 
	}
}

1121 cÚ¡ 
fže_Ý”©iÚs
 
	gnå_ýp_fÝs
 = {

1122 .
owÃr
 = 
THIS_MODULE
,

1123 .
	gÝ’
 = 
nå_dev_ýp_Ý’
,

1124 .
	g»Ëa£
 = 
nå_dev_ýp_»Ëa£
,

1125 .
	gmm­
 = 
nå_dev_ýp_mm­
,

1126 .
	g»ad
 = 
nå_dev_ýp_»ad
,

1127 .
	gwr™e
 = 
nå_dev_ýp_wr™e
,

1128 #ifdeà
HAVE_UNLOCKED_IOCTL


1129 .
	guÆocked_ioùl
 = 
nå_dev_ýp_ioùl
,

1131 .
	gioùl
 = 
nå_dev_ýp_ioùl
,

1135 
ssize_t
 
	$show_fœmw¬e
(
deviû
 *
dev
,

1136 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1138 
nå_dev_ýp
 *
cdev
 = 
	`dev_g‘_drvd©a
(
dev
);

1140  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s\n", &
cdev
->
fœmw¬e
[0]);

1141 
	}
}

1143 
ssize_t
 
	$¡Üe_fœmw¬e
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

1144 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1146 
nå_dev_ýp
 *
cdev
 = 
	`dev_g‘_drvd©a
(
dev
);

1147 cÚ¡ *
ý
;

1148 
”r
;

1150 
ý
 = 
	`¡ºchr
(
buf
, 
couÁ
, '\n');

1151 ià(!
ý
)

1152 
ý
 = 
buf
 + 
couÁ
;

1154 ià((
ý
 - 
buf
è> ((
cdev
->
fœmw¬e
) - 1))

1155  -
EINVAL
;

1157 
	`memýy
(&
cdev
->
fœmw¬e
[0], 
buf
, (
ý
 - buf));

1158 
cdev
->
fœmw¬e
[
ý
 - 
buf
] = 0;

1160 
”r
 = 
	`do_fw_lßd
(
cdev
);

1162  (
”r
 < 0è?ƒ¼ : 
couÁ
;

1163 
	}
}

1165 
DEVICE_ATTR
(
fœmw¬e
, 
S_IRUGO
 | 
S_IWUSR
, 
show_fœmw¬e
, 
¡Üe_fœmw¬e
);

1169 
	$nå_dev_ýp_´obe
(
¶©fÜm_deviû
 *
pdev
)

1171 
nå_¶©fÜm_d©a
 *
pd©a
;

1172 
nå_dev_ýp
 *
cdev
;

1173 
nå_ýp
 *
ýp
;

1174 
”r
 = -
EINVAL
;

1175 
id
;

1177 
pd©a
 = 
	`nå_¶©fÜm_deviû_d©a
(
pdev
);

1178 
	`BUG_ON
(!
pd©a
);

1180 
id
 = 
pd©a
->
nå
;

1182 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
id
);

1184 
	`BUG_ON
(!
ýp
);

1186 
cdev
 = 
	`kz®loc
((*cdev), 
GFP_KERNEL
);

1187 ià(!
cdev
) {

1188 
	`nå_ýp_ä“
(
ýp
);

1189  -
ENOMEM
;

1192 
cdev
->
ýp
 = cpp;

1193 
	`INIT_LIST_HEAD
(&
cdev
->
ev’t
.
li¡
);

1194 
	`mu‹x_š™
(&
cdev
->
ev’t
.
lock
);

1196 
	`INIT_LIST_HEAD
(&
cdev
->
¬—
.
li¡
);

1197 
	`mu‹x_š™
(&
cdev
->
¬—
.
lock
);

1199 
	`INIT_LIST_HEAD
(&
cdev
->
»q
.
li¡
);

1200 
	`mu‹x_š™
(&
cdev
->
»q
.
lock
);

1202 
	`š™_wa™queue_h—d
(&
cdev
->
chªÃl_wa™
);

1204 
	`cdev_š™
(&
cdev
->cdev, &
nå_ýp_fÝs
);

1205 
cdev
->cdev.
owÃr
 = 
THIS_MODULE
;

1206 
”r
 = 
	`cdev_add
(&
cdev
->cdev, 
	`MKDEV
(
nå_dev_ýp_majÜ
, 
id
), 1);

1207 ià(
”r
)

1208 
”r_ýp
;

1210 
cdev
->
dev
 = 
	`deviû_ü—‹
(
nå_dev_ýp_þass
, 
	`nå_ýp_deviû
(
ýp
),

1211 
	`MKDEV
(
nå_dev_ýp_majÜ
, 
id
),

1212 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 26)

1213 
NULL
,

1215 "nå-ýp-%d", 
id
);

1216 ià(
	`IS_ERR
(
cdev
->
dev
)) {

1217 
”r
 = 
	`PTR_ERR
(
cdev
->
dev
);

1218 
”r_ýp_dev
;

1221 
	`dev_£t_drvd©a
(
cdev
->
dev
, cdev);

1222 
”r
 = 
	`deviû_ü—‹_fže
(
cdev
->
dev
, &
dev_©Œ_fœmw¬e
);

1223 ià(
”r
 < 0)

1224 
”r_©Œib
;

1226 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
cdev
);

1230 
”r_©Œib
:

1231 
	`deviû_de¡roy
(
nå_dev_ýp_þass
, 
	`MKDEV
(
nå_dev_ýp_majÜ
, 
id
));

1232 
”r_ýp_dev
:

1233 
	`cdev_d–
(&
cdev
->cdev);

1234 
”r_ýp
:

1235 
	`nå_ýp_ä“
(
cdev
->
ýp
);

1236 
	`kä“
(
cdev
);

1237  
”r
;

1238 
	}
}

1243 
	$nå_dev_ýp_»move
(
¶©fÜm_deviû
 *
pdev
)

1245 
nå_dev_ýp
 *
cdev
 = 
	`¶©fÜm_g‘_drvd©a
(
pdev
);

1246 
mšÜ
 = 
	`MINOR
(
cdev
->cdev.
dev
);

1248 ià(!
	`b™m­_em±y
(
cdev
->
chªÃl_b™m­
, 
NFP_DEV_CPP_CHANNELS
)) {

1249 
	`dev_”r
(&
pdev
->
dev
, "Unexpected device„emoval while busy - waiting...\n");

1250 
	`wa™_ev’t
(
cdev
->
chªÃl_wa™
,

1251 
	`b™m­_em±y
(
cdev
->
chªÃl_b™m­
,

1252 
NFP_DEV_CPP_CHANNELS
));

1255 
	`BUG_ON
(!
	`li¡_em±y
(&
cdev
->
ev’t
.
li¡
));

1256 
	`BUG_ON
(!
	`li¡_em±y
(&
cdev
->
¬—
.
li¡
));

1257 
	`BUG_ON
(!
	`li¡_em±y
(&
cdev
->
»q
.
li¡
));

1259 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
NULL
);

1261 
	`deviû_»move_fže
(
cdev
->
dev
, &
dev_©Œ_fœmw¬e
);

1263 
	`deviû_de¡roy
(
nå_dev_ýp_þass
, 
	`MKDEV
(
nå_dev_ýp_majÜ
, 
mšÜ
));

1265 
	`cdev_d–
(&
cdev
->cdev);

1267 
	`nå_ýp_ä“
(
cdev
->
ýp
);

1268 
	`kä“
(
cdev
);

1270 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
NULL
);

1273 
	}
}

1275 
¶©fÜm_driv”
 
	gnå_dev_ýp_driv”
 = {

1276 .
´obe
 = 
nå_dev_ýp_´obe
,

1277 .
	g»move
 = 
nå_dev_ýp_»move
,

1278 .
	gdriv”
 = {

1279 .
Çme
 = "nfp-dev-cpp",

1288 
	$nå_dev_ýp_š™
()

1290 
dev_t
 
dev_id
;

1291 
”r
 = -
EINVAL
;

1293 
nå_dev_ýp_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, "nfp-dev-cpp");

1294 ià(
	`IS_ERR
(
nå_dev_ýp_þass
))

1295  
	`PTR_ERR
(
nå_dev_ýp_þass
);

1297 
”r
 = 
	`®loc_chrdev_»giÚ
(&
dev_id
, 0, 
NFP_DEV_CPP_MAX
, "nfp-dev-cpp");

1298 ià(
”r
)

1299 
”r_ýp
;

1300 
nå_dev_ýp_majÜ
 = 
	`MAJOR
(
dev_id
);

1302 
”r
 = 
	`¶©fÜm_driv”_»gi¡”
(&
nå_dev_ýp_driv”
);

1303 ià(
”r
)

1304 
”r_¶©
;

1308 
”r_¶©
:

1309 
	`uÄegi¡”_chrdev_»giÚ
(
	`MKDEV
(
nå_dev_ýp_majÜ
, 0), 
NFP_DEV_CPP_MAX
);

1310 
”r_ýp
:

1311 
	`þass_de¡roy
(
nå_dev_ýp_þass
);

1312  
”r
;

1313 
	}
}

1318 
	$nå_dev_ýp_ex™
()

1320 
	`¶©fÜm_driv”_uÄegi¡”
(&
nå_dev_ýp_driv”
);

1321 
	`þass_de¡roy
(
nå_dev_ýp_þass
);

1322 
	`uÄegi¡”_chrdev_»giÚ
(
	`MKDEV
(
nå_dev_ýp_majÜ
, 0), 
NFP_DEV_CPP_MAX
);

1323 
	}
}

	@src/nfp_devlink.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/fœmw¬e.h
>

7 
	~<lšux/¹ÃŽšk.h
>

8 
	~<Ãt/devlšk.h
>

10 
	~"nåcÜe/nå.h
"

11 
	~"nåcÜe/nå_n¥.h
"

12 
	~"nå_­p.h
"

13 
	~"nå_maš.h
"

14 
	~"nå_pÜt.h
"

17 
	$nå_devlšk_fžl_‘h_pÜt
(
nå_pÜt
 *
pÜt
,

18 
nå_‘h_bË_pÜt
 *
cÝy
)

20 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

22 
‘h_pÜt
 = 
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

23 ià(!
‘h_pÜt
)

24  -
EINVAL
;

26 
	`memýy
(
cÝy
, 
‘h_pÜt
, (*eth_port));

29 
	}
}

32 
	$nå_devlšk_fžl_‘h_pÜt_äom_id
(
nå_pf
 *
pf
, 
pÜt_šdex
,

33 
nå_‘h_bË_pÜt
 *
cÝy
)

35 
nå_pÜt
 *
pÜt
;

37 
pÜt
 = 
	`nå_pÜt_äom_id
(
pf
, 
NFP_PORT_PHYS_PORT
, 
pÜt_šdex
);

39  
	`nå_devlšk_fžl_‘h_pÜt
(
pÜt
, 
cÝy
);

40 
	}
}

43 
	$nå_devlšk_£t_ÏÃs
(
nå_pf
 *
pf
, 
idx
, 
ÏÃs
)

45 
nå_n¥
 *
n¥
;

46 
»t
;

48 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
pf
->
ýp
, 
idx
);

49 ià(
	`IS_ERR
(
n¥
))

50  
	`PTR_ERR
(
n¥
);

52 
»t
 = 
	`__nå_‘h_£t_¥l™
(
n¥
, 
ÏÃs
);

53 ià(
»t
) {

54 
	`nå_‘h_cÚfig_þ—nup_’d
(
n¥
);

55  
»t
;

58 
»t
 = 
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

59 ià(
»t
 < 0)

60  
»t
;

61 ià(
»t
)

64  
	`nå_Ãt_»äesh_pÜt_bË_sync
(
pf
);

65 
	}
}

68 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 18, 0)

69 
	$nå_devlšk_pÜt_¥l™
(
devlšk
 *devlšk, 
pÜt_šdex
,

70 
couÁ
)

72 
	$nå_devlšk_pÜt_¥l™
(
devlšk
 *devlšk, 
pÜt_šdex
,

73 
couÁ
, 
ÃŽšk_ext_ack
 *
exck
)

76 
nå_pf
 *
pf
 = 
	`devlšk_´iv
(
devlšk
);

77 
nå_‘h_bË_pÜt
 
‘h_pÜt
;

78 
ÏÃs
;

79 
»t
;

81 ià(
couÁ
 < 2)

82  -
EINVAL
;

84 
	`mu‹x_lock
(&
pf
->
lock
);

86 
	`¹Æ_lock
();

87 
»t
 = 
	`nå_devlšk_fžl_‘h_pÜt_äom_id
(
pf
, 
pÜt_šdex
, &
‘h_pÜt
);

88 
	`¹Æ_uÆock
();

89 ià(
»t
)

90 
out
;

92 ià(
‘h_pÜt
.
is_¥l™
 ||ƒth_pÜt.
pÜt_ÏÃs
 % 
couÁ
) {

93 
»t
 = -
EINVAL
;

94 
out
;

98 
ÏÃs
 = 
‘h_pÜt
.
pÜt_ÏÃs
 / 
couÁ
;

99 ià(
‘h_pÜt
.
ÏÃs
 =ð10 && 
couÁ
 == 2)

100 
ÏÃs
 = 8 / 
couÁ
;

102 
»t
 = 
	`nå_devlšk_£t_ÏÃs
(
pf
, 
‘h_pÜt
.
šdex
, 
ÏÃs
);

103 
out
:

104 
	`mu‹x_uÆock
(&
pf
->
lock
);

106  
»t
;

107 
	}
}

110 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 18, 0)

111 
	$nå_devlšk_pÜt_un¥l™
(
devlšk
 *devlšk, 
pÜt_šdex
)

113 
	$nå_devlšk_pÜt_un¥l™
(
devlšk
 *devlšk, 
pÜt_šdex
,

114 
ÃŽšk_ext_ack
 *
exck
)

117 
nå_pf
 *
pf
 = 
	`devlšk_´iv
(
devlšk
);

118 
nå_‘h_bË_pÜt
 
‘h_pÜt
;

119 
ÏÃs
;

120 
»t
;

122 
	`mu‹x_lock
(&
pf
->
lock
);

124 
	`¹Æ_lock
();

125 
»t
 = 
	`nå_devlšk_fžl_‘h_pÜt_äom_id
(
pf
, 
pÜt_šdex
, &
‘h_pÜt
);

126 
	`¹Æ_uÆock
();

127 ià(
»t
)

128 
out
;

130 ià(!
‘h_pÜt
.
is_¥l™
) {

131 
»t
 = -
EINVAL
;

132 
out
;

136 
ÏÃs
 = 
‘h_pÜt
.
pÜt_ÏÃs
;

137 ià(
‘h_pÜt
.
pÜt_ÏÃs
 == 8)

138 
ÏÃs
 = 10;

140 
»t
 = 
	`nå_devlšk_£t_ÏÃs
(
pf
, 
‘h_pÜt
.
šdex
, 
ÏÃs
);

141 
out
:

142 
	`mu‹x_uÆock
(&
pf
->
lock
);

144  
»t
;

145 
	}
}

147 #ià
COMPAT__HAS_DEVLINK_SB


149 
	$nå_devlšk_sb_poÞ_g‘
(
devlšk
 *devlšk, 
sb_šdex
,

150 
u16
 
poÞ_šdex
, 
devlšk_sb_poÞ_šfo
 *
poÞ_šfo
)

152 
nå_pf
 *
pf
 = 
	`devlšk_´iv
(
devlšk
);

154  
	`nå_sh¬ed_buf_poÞ_g‘
(
pf
, 
sb_šdex
, 
poÞ_šdex
, 
poÞ_šfo
);

155 
	}
}

158 
	$nå_devlšk_sb_poÞ_£t
(
devlšk
 *devlšk, 
sb_šdex
,

159 
u16
 
poÞ_šdex
,

160 
u32
 
size
, 
devlšk_sb_th»shÞd_ty³
 
th»shÞd_ty³
)

162 
nå_pf
 *
pf
 = 
	`devlšk_´iv
(
devlšk
);

164  
	`nå_sh¬ed_buf_poÞ_£t
(
pf
, 
sb_šdex
, 
poÞ_šdex
,

165 
size
, 
th»shÞd_ty³
);

166 
	}
}

169 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 8, 0)

170 
	$nå_devlšk_esw™ch_mode_g‘
(
devlšk
 *devlšk, 
u16
 *
mode
)

172 
nå_pf
 *
pf
 = 
	`devlšk_´iv
(
devlšk
);

174  
	`nå_­p_esw™ch_mode_g‘
(
pf
->
­p
, 
mode
);

175 
	}
}

177 #ià
VER_NON_RHEL_LT
(4, 20è|| 
VER_RHEL_LT
(8, 0)

178 
	$nå_devlšk_esw™ch_mode_£t
(
devlšk
 *devlšk, 
u16
 
mode
)

180 
	$nå_devlšk_esw™ch_mode_£t
(
devlšk
 *devlšk, 
u16
 
mode
,

181 
ÃŽšk_ext_ack
 *
exck
)

184 
nå_pf
 *
pf
 = 
	`devlšk_´iv
(
devlšk
);

185 
»t
;

187 
	`mu‹x_lock
(&
pf
->
lock
);

188 
»t
 = 
	`nå_­p_esw™ch_mode_£t
(
pf
->
­p
, 
mode
);

189 
	`mu‹x_uÆock
(&
pf
->
lock
);

191  
»t
;

192 
	}
}

195 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

196 cÚ¡ 
	snå_devlšk_v”siÚs_sim¶e
 {

197 cÚ¡ *
	mkey
;

198 cÚ¡ *
	mhwšfo
;

199 } 
	gnå_devlšk_v”siÚs_hwšfo
[] = {

200 { 
DEVLINK_INFO_VERSION_GENERIC_BOARD_ID
, "assembly.partno", },

201 { 
DEVLINK_INFO_VERSION_GENERIC_BOARD_REV
, "assembly.revision", },

202 { 
DEVLINK_INFO_VERSION_GENERIC_BOARD_MANUFACTURE
, "assembly.vendor", },

207 
	$nå_devlšk_v”siÚs_g‘_hwšfo
(
nå_pf
 *
pf
, 
devlšk_šfo_»q
 *
»q
)

209 
i
;

210 
”r
;

212 
i
 = 0; i < 
	`ARRAY_SIZE
(
nå_devlšk_v”siÚs_hwšfo
); i++) {

213 cÚ¡ 
nå_devlšk_v”siÚs_sim¶e
 *
šfo
;

214 cÚ¡ *
v®
;

216 
šfo
 = &
nå_devlšk_v”siÚs_hwšfo
[
i
];

218 
v®
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, 
šfo
->hwinfo);

219 ià(!
v®
)

222 
”r
 = 
	`devlšk_šfo_v”siÚ_fixed_put
(
»q
, 
šfo
->
key
, 
v®
);

223 ià(
”r
)

224  
”r
;

228 
	}
}

230 cÚ¡ 
	snå_devlšk_v”siÚs
 {

231 
nå_n¥_v”siÚs
 
	mid
;

232 cÚ¡ *
	mkey
;

233 } 
	gnå_devlšk_v”siÚs_n¥
[] = {

234 { 
NFP_VERSIONS_BUNDLE
, "fw.bundle_id", },

235 { 
NFP_VERSIONS_BSP
, 
DEVLINK_INFO_VERSION_GENERIC_FW_MGMT
, },

236 { 
NFP_VERSIONS_CPLD
, "fw.cpld", },

237 { 
NFP_VERSIONS_APP
, 
DEVLINK_INFO_VERSION_GENERIC_FW_APP
, },

238 { 
NFP_VERSIONS_UNDI
, 
DEVLINK_INFO_VERSION_GENERIC_FW_UNDI
, },

239 { 
NFP_VERSIONS_NCSI
, 
DEVLINK_INFO_VERSION_GENERIC_FW_NCSI
, },

240 { 
NFP_VERSIONS_CFGR
, "chip.init", },

244 
	$nå_devlšk_v”siÚs_g‘_n¥
(
devlšk_šfo_»q
 *
»q
, 
boÞ
 
æash
,

245 cÚ¡ 
u8
 *
buf
, 
size
)

247 
i
;

248 
”r
;

250 
i
 = 0; i < 
	`ARRAY_SIZE
(
nå_devlšk_v”siÚs_n¥
); i++) {

251 cÚ¡ 
nå_devlšk_v”siÚs
 *
šfo
;

252 cÚ¡ *
v”siÚ
;

254 
šfo
 = &
nå_devlšk_v”siÚs_n¥
[
i
];

256 
v”siÚ
 = 
	`nå_n¥_v”siÚs_g‘
(
šfo
->
id
, 
æash
, 
buf
, 
size
);

257 ià(
	`IS_ERR
(
v”siÚ
)) {

258 ià(
	`PTR_ERR
(
v”siÚ
è=ð-
ENOENT
)

261  
	`PTR_ERR
(
v”siÚ
);

264 ià(
æash
)

265 
”r
 = 
	`devlšk_šfo_v”siÚ_¡Üed_put
(
»q
, 
šfo
->
key
,

266 
v”siÚ
);

268 
”r
 = 
	`devlšk_šfo_v”siÚ_ruÂšg_put
(
»q
, 
šfo
->
key
,

269 
v”siÚ
);

270 ià(
”r
)

271  
”r
;

275 
	}
}

278 
	$nå_devlšk_šfo_g‘
(
devlšk
 *devlšk, 
devlšk_šfo_»q
 *
»q
,

279 
ÃŽšk_ext_ack
 *
exck
)

281 
nå_pf
 *
pf
 = 
	`devlšk_´iv
(
devlšk
);

282 cÚ¡ *
¢
, *
v’dÜ
, *
·¹
;

283 
nå_n¥
 *
n¥
;

284 *
buf
 = 
NULL
;

285 
”r
;

287 
”r
 = 
	`devlšk_šfo_driv”_Çme_put
(
»q
, "nfp");

288 ià(
”r
)

289  
”r
;

291 
v’dÜ
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.vendor");

292 
·¹
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.partno");

293 
¢
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.serial");

294 ià(
v’dÜ
 && 
·¹
 && 
¢
) {

295 *
buf
;

297 
buf
 = 
	`km®loc
(
	`¡¾’
(
v’dÜ
è+ sŒËn(
·¹
è+ sŒËn(
¢
) + 1,

298 
GFP_KERNEL
);

299 ià(!
buf
)

300  -
ENOMEM
;

302 
buf
[0] = '\0';

303 
	`¡rÿt
(
buf
, 
v’dÜ
);

304 
	`¡rÿt
(
buf
, 
·¹
);

305 
	`¡rÿt
(
buf
, 
¢
);

307 
”r
 = 
	`devlšk_šfo_£rŸl_numb”_put
(
»q
, 
buf
);

308 
	`kä“
(
buf
);

309 ià(
”r
)

310  
”r
;

313 
n¥
 = 
	`nå_n¥_Ý’
(
pf
->
ýp
);

314 ià(
	`IS_ERR
(
n¥
)) {

315 
	`NL_SET_ERR_MSG_MOD
(
exck
, "can't‡ccess NSP");

316  
	`PTR_ERR
(
n¥
);

319 ià(
	`nå_n¥_has_v”siÚs
(
n¥
)) {

320 
buf
 = 
	`kz®loc
(
NFP_NSP_VERSION_BUFSZ
, 
GFP_KERNEL
);

321 ià(!
buf
) {

322 
”r
 = -
ENOMEM
;

323 
”r_þo£_n¥
;

326 
”r
 = 
	`nå_n¥_v”siÚs
(
n¥
, 
buf
, 
NFP_NSP_VERSION_BUFSZ
);

327 ià(
”r
)

328 
”r_ä“_buf
;

330 
”r
 = 
	`nå_devlšk_v”siÚs_g‘_n¥
(
»q
, 
çl£
,

331 
buf
, 
NFP_NSP_VERSION_BUFSZ
);

332 ià(
”r
)

333 
”r_ä“_buf
;

335 
”r
 = 
	`nå_devlšk_v”siÚs_g‘_n¥
(
»q
, 
Œue
,

336 
buf
, 
NFP_NSP_VERSION_BUFSZ
);

337 ià(
”r
)

338 
”r_ä“_buf
;

340 
	`kä“
(
buf
);

343 
	`nå_n¥_þo£
(
n¥
);

345  
	`nå_devlšk_v”siÚs_g‘_hwšfo
(
pf
, 
»q
);

347 
”r_ä“_buf
:

348 
	`kä“
(
buf
);

349 
”r_þo£_n¥
:

350 
	`nå_n¥_þo£
(
n¥
);

351  
”r
;

352 
	}
}

355 
	$nå_devlšk_æash_upd©e
(
devlšk
 *devlšk, cÚ¡ *
·th
,

356 cÚ¡ *
compÚ’t
, 
ÃŽšk_ext_ack
 *
exck
)

358 ià(
compÚ’t
)

359  -
EOPNOTSUPP
;

360  
	`nå_æash_upd©e_commÚ
(
	`devlšk_´iv
(
devlšk
), 
·th
, 
exck
);

361 
	}
}

364 cÚ¡ 
devlšk_Ýs
 
	gnå_devlšk_Ýs
 = {

365 .
pÜt_¥l™
 = 
nå_devlšk_pÜt_¥l™
,

366 .
	gpÜt_un¥l™
 = 
nå_devlšk_pÜt_un¥l™
,

367 #ià
COMPAT__HAS_DEVLINK_SB


368 .
	gsb_poÞ_g‘
 = 
nå_devlšk_sb_poÞ_g‘
,

369 .
	gsb_poÞ_£t
 = 
nå_devlšk_sb_poÞ_£t
,

371 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 8, 0)

372 .
	gesw™ch_mode_g‘
 = 
nå_devlšk_esw™ch_mode_g‘
,

373 .
	gesw™ch_mode_£t
 = 
nå_devlšk_esw™ch_mode_£t
,

375 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

376 .
	gšfo_g‘
 = 
nå_devlšk_šfo_g‘
,

377 .
	gæash_upd©e
 = 
nå_devlšk_æash_upd©e
,

381 
	$nå_devlšk_pÜt_»gi¡”
(
nå_­p
 *
­p
, 
nå_pÜt
 *
pÜt
)

383 
nå_‘h_bË_pÜt
 
‘h_pÜt
;

384 
devlšk
 *devlink;

385 
»t
;

387 
	`¹Æ_lock
();

388 
»t
 = 
	`nå_devlšk_fžl_‘h_pÜt
(
pÜt
, &
‘h_pÜt
);

389 
	`¹Æ_uÆock
();

390 ià(
»t
)

391  
»t
;

393 
	`devlšk_pÜt_©Œs_£t
(&
pÜt
->
dl_pÜt
, 
DEVLINK_PORT_FLAVOUR_PHYSICAL
,

394 
‘h_pÜt
.
Ïb–_pÜt
,ƒth_pÜt.
is_¥l™
,

395 
‘h_pÜt
.
Ïb–_subpÜt
);

397 
devlšk
 = 
	`´iv_to_devlšk
(
­p
->
pf
);

399  
	`devlšk_pÜt_»gi¡”
(
devlšk
, &
pÜt
->
dl_pÜt
,…Üt->
‘h_id
);

400 
	}
}

402 
	$nå_devlšk_pÜt_uÄegi¡”
(
nå_pÜt
 *
pÜt
)

404 
	`devlšk_pÜt_uÄegi¡”
(&
pÜt
->
dl_pÜt
);

405 
	}
}

407 
	$nå_devlšk_pÜt_ty³_‘h_£t
(
nå_pÜt
 *
pÜt
)

409 
	`devlšk_pÜt_ty³_‘h_£t
(&
pÜt
->
dl_pÜt
,…Üt->
Ãtdev
);

410 
	}
}

412 
	$nå_devlšk_pÜt_ty³_þ—r
(
nå_pÜt
 *
pÜt
)

414 
	`devlšk_pÜt_ty³_þ—r
(&
pÜt
->
dl_pÜt
);

415 
	}
}

417 
devlšk
 *
	$nå_devlšk_g‘_devlšk
(
Ãt_deviû
 *
Ãtdev
)

419 
nå_­p
 *
­p
;

421 
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

422 ià(!
­p
)

423  
NULL
;

425  
	`´iv_to_devlšk
(
­p
->
pf
);

426 
	}
}

428 
devlšk_pÜt
 *
	$nå_devlšk_g‘_devlšk_pÜt
(
Ãt_deviû
 *
Ãtdev
)

430 
nå_pÜt
 *
pÜt
;

432 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

433 ià(!
pÜt
)

434  
NULL
;

436  &
pÜt
->
dl_pÜt
;

437 
	}
}

	@src/nfp_hwmon.c

4 
	~<lšux/k”Ãl.h
>

5 
	~<lšux/b™Ýs.h
>

6 
	~<lšux/hwmÚ.h
>

8 
	~"nåcÜe/nå_ýp.h
"

9 
	~"nåcÜe/nå_n¥.h
"

10 
	~"nå_maš.h
"

12 
	#NFP_TEMP_MAX
 (95 * 1000)

	)

13 
	#NFP_TEMP_CRIT
 (105 * 1000)

	)

15 
	#NFP_POWER_MAX
 (25 * 1000 * 1000)

	)

17 
	$nå_hwmÚ_£nsÜ_id
(
hwmÚ_£nsÜ_ty³s
 
ty³
, 
chªÃl
)

19 ià(
ty³
 =ð
hwmÚ_‹mp
)

20  
NFP_SENSOR_CHIP_TEMPERATURE
;

21 ià(
ty³
 =ð
hwmÚ_pow”
)

22  
NFP_SENSOR_ASSEMBLY_POWER
 + 
chªÃl
;

23  -
EINVAL
;

24 
	}
}

27 
	$nå_hwmÚ_»ad
(
deviû
 *
dev
, 
hwmÚ_£nsÜ_ty³s
 
ty³
, 
u32
 
©Œ
,

28 
chªÃl
, *
v®
)

31 
hwmÚ_£nsÜ_ty³s
 
ty³
;

32 
u32
 
©Œ
;

33 
v®
;

34 } 
cÚ¡_v®s
[] = {

35 { 
hwmÚ_‹mp
, 
hwmÚ_‹mp_max
, 
NFP_TEMP_MAX
 },

36 { 
hwmÚ_‹mp
, 
hwmÚ_‹mp_ü™
, 
NFP_TEMP_CRIT
 },

37 { 
hwmÚ_pow”
, 
hwmÚ_pow”_max
, 
NFP_POWER_MAX
 },

39 
nå_pf
 *
pf
 = 
	`dev_g‘_drvd©a
(
dev
);

40 
nå_n¥_£nsÜ_id
 
id
;

41 
”r
, 
i
;

43 
i
 = 0; i < 
	`ARRAY_SIZE
(
cÚ¡_v®s
); i++)

44 ià(
cÚ¡_v®s
[
i
].
ty³
 =ðty³ && cÚ¡_v®s[i].
©Œ
 ==‡ttr) {

45 *
v®
 = 
cÚ¡_v®s
[
i
].val;

49 
”r
 = 
	`nå_hwmÚ_£nsÜ_id
(
ty³
, 
chªÃl
);

50 ià(
”r
 < 0)

51  
”r
;

52 
id
 = 
”r
;

54 ià(!(
pf
->
n¥i
->
£nsÜ_mask
 & 
	`BIT
(
id
)))

55  -
EOPNOTSUPP
;

57 ià(
ty³
 =ð
hwmÚ_‹mp
 && 
©Œ
 =ð
hwmÚ_‹mp_šput
)

58  
	`nå_hwmÚ_»ad_£nsÜ
(
pf
->
ýp
, 
id
, 
v®
);

59 ià(
ty³
 =ð
hwmÚ_pow”
 && 
©Œ
 =ð
hwmÚ_pow”_šput
)

60  
	`nå_hwmÚ_»ad_£nsÜ
(
pf
->
ýp
, 
id
, 
v®
);

62  -
EINVAL
;

63 
	}
}

65 
umode_t


66 
	$nå_hwmÚ_is_visibË
(cÚ¡ *
d©a
, 
hwmÚ_£nsÜ_ty³s
 
ty³
, 
u32
 
©Œ
,

67 
chªÃl
)

69 ià(
ty³
 =ð
hwmÚ_‹mp
) {

70 
©Œ
) {

71 
hwmÚ_‹mp_šput
:

72 
hwmÚ_‹mp_ü™
:

73 
hwmÚ_‹mp_max
:

76 } ià(
ty³
 =ð
hwmÚ_pow”
) {

77 
©Œ
) {

78 
hwmÚ_pow”_šput
:

79 
hwmÚ_pow”_max
:

84 
	}
}

86 
u32
 
	gnå_ch_cÚfig
[] = {

87 
HWMON_C_REGISTER_TZ
,

91 cÚ¡ 
hwmÚ_chªÃl_šfo
 
	gnå_ch
 = {

92 .
ty³
 = 
hwmÚ_ch
,

93 .
	gcÚfig
 = 
nå_ch_cÚfig
,

96 
u32
 
	gnå_‹mp_cÚfig
[] = {

97 
HWMON_T_INPUT
 | 
HWMON_T_MAX
 | 
HWMON_T_CRIT
,

101 cÚ¡ 
hwmÚ_chªÃl_šfo
 
	gnå_‹mp
 = {

102 .
ty³
 = 
hwmÚ_‹mp
,

103 .
	gcÚfig
 = 
nå_‹mp_cÚfig
,

106 
u32
 
	gnå_pow”_cÚfig
[] = {

107 
HWMON_P_INPUT
 | 
HWMON_P_MAX
,

108 
HWMON_P_INPUT
,

109 
HWMON_P_INPUT
,

113 cÚ¡ 
hwmÚ_chªÃl_šfo
 
	gnå_pow”
 = {

114 .
ty³
 = 
hwmÚ_pow”
,

115 .
	gcÚfig
 = 
nå_pow”_cÚfig
,

118 cÚ¡ 
hwmÚ_chªÃl_šfo
 *
	gnå_hwmÚ_šfo
[] = {

119 &
nå_ch
,

120 &
nå_‹mp
,

121 &
nå_pow”
,

122 
NULL


125 cÚ¡ 
hwmÚ_Ýs
 
	gnå_hwmÚ_Ýs
 = {

126 .
is_visibË
 = 
nå_hwmÚ_is_visibË
,

127 .
	g»ad
 = 
nå_hwmÚ_»ad
,

130 cÚ¡ 
hwmÚ_ch_šfo
 
	gnå_ch_šfo
 = {

131 .
Ýs
 = &
nå_hwmÚ_Ýs
,

132 .
	gšfo
 = 
nå_hwmÚ_šfo
,

135 
	$nå_hwmÚ_»gi¡”
(
nå_pf
 *
pf
)

137 ià(!
	`IS_REACHABLE
(
CONFIG_HWMON
))

140 ià(!
pf
->
n¥i
) {

141 
	`nå_w¬n
(
pf
->
ýp
, "not„egistering HWMON (no NSP info)\n");

144 ià(!
pf
->
n¥i
->
£nsÜ_mask
) {

145 
	`nå_šfo
(
pf
->
ýp
,

150 
pf
->
hwmÚ_dev
 = 
	`hwmÚ_deviû_»gi¡”_w™h_šfo
(&pf->
pdev
->
dev
, "nfp",

151 
pf
, &
nå_ch_šfo
,

152 
NULL
);

153  
	`PTR_ERR_OR_ZERO
(
pf
->
hwmÚ_dev
);

154 
	}
}

156 
	$nå_hwmÚ_uÄegi¡”
(
nå_pf
 *
pf
)

158 ià(!
	`IS_REACHABLE
(
CONFIG_HWMON
è|| !
pf
->
hwmÚ_dev
)

161 
	`hwmÚ_deviû_uÄegi¡”
(
pf
->
hwmÚ_dev
);

162 
	}
}

	@src/nfp_hwmon_legacy.c

4 
	~<lšux/k”Ãl.h
>

5 
	~<lšux/b™Ýs.h
>

6 
	~<lšux/hwmÚ.h
>

7 
	~<lšux/hwmÚ-sysfs.h
>

9 
	~"nåcÜe/nå.h
"

10 
	~"nåcÜe/nå_n¥.h
"

11 
	~"nå_maš.h
"

13 
	#NFP_TEMP_MAX
 (95 * 1000)

	)

14 
	#NFP_TEMP_CRIT
 (105 * 1000)

	)

16 
	#NFP_POWER_MAX
 (25 * 1000 * 1000)

	)

18 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 13, 0)

19 
ssize_t


20 
	$nå_hwmÚ_show_šput
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
dev_©Œ
,

21 *
buf
)

23 
£nsÜ_deviû_©Œibu‹
 *
©Œ
 = 
	`to_£nsÜ_dev_©Œ
(
dev_©Œ
);

24 
nå_pf
 *
pf
 = 
	`dev_g‘_drvd©a
(
dev
);

25 
v®
;

26 
»t
;

28 ià(!(
pf
->
n¥i
->
£nsÜ_mask
 & 
	`BIT
(
©Œ
->
šdex
)))

29  -
EINVAL
;

30 
»t
 = 
	`nå_hwmÚ_»ad_£nsÜ
(
pf
->
ýp
, 
©Œ
->
šdex
, &
v®
);

31 ià(
»t
 < 0)

32  
»t
;

34  
	`¥rštf
(
buf
, "%ld\n", 
v®
);

35 
	}
}

37 
ssize_t


38 
	$nå_hwmÚ_show_max
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
dev_©Œ
,

39 *
buf
)

41 
£nsÜ_deviû_©Œibu‹
 *
©Œ
 = 
	`to_£nsÜ_dev_©Œ
(
dev_©Œ
);

43 
©Œ
->
šdex
) {

44 
NFP_SENSOR_CHIP_TEMPERATURE
:

45  
	`¥rštf
(
buf
, "%d\n", 
NFP_TEMP_MAX
);

46 
NFP_SENSOR_ASSEMBLY_POWER
:

47  
	`¥rštf
(
buf
, "%d\n", 
NFP_POWER_MAX
);

49  -
EINVAL
;

50 
	}
}

52 
ssize_t


53 
	$nå_hwmÚ_show_ü™
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
dev_©Œ
,

54 *
buf
)

56 
£nsÜ_deviû_©Œibu‹
 *
©Œ
 = 
	`to_£nsÜ_dev_©Œ
(
dev_©Œ
);

58 ià(
©Œ
->
šdex
 =ð
NFP_SENSOR_CHIP_TEMPERATURE
)

59  
	`¥rštf
(
buf
, "%d\n", 
NFP_TEMP_CRIT
);

60  -
EINVAL
;

61 
	}
}

63 
SENSOR_DEVICE_ATTR
(
‹mp1_šput
, 0444, 
nå_hwmÚ_show_šput
, 
NULL
,

64 
NFP_SENSOR_CHIP_TEMPERATURE
);

65 
SENSOR_DEVICE_ATTR
(
‹mp1_max
, 0444, 
nå_hwmÚ_show_max
, 
NULL
,

66 
NFP_SENSOR_CHIP_TEMPERATURE
);

67 
SENSOR_DEVICE_ATTR
(
‹mp1_ü™
, 0444, 
nå_hwmÚ_show_ü™
, 
NULL
,

68 
NFP_SENSOR_CHIP_TEMPERATURE
);

69 
SENSOR_DEVICE_ATTR
(
pow”1_šput
, 0444, 
nå_hwmÚ_show_šput
, 
NULL
,

70 
NFP_SENSOR_ASSEMBLY_POWER
);

71 
SENSOR_DEVICE_ATTR
(
pow”1_max
, 0444, 
nå_hwmÚ_show_max
, 
NULL
,

72 
NFP_SENSOR_ASSEMBLY_POWER
);

73 
SENSOR_DEVICE_ATTR
(
pow”2_šput
, 0444, 
nå_hwmÚ_show_šput
, 
NULL
,

74 
NFP_SENSOR_ASSEMBLY_12V_POWER
);

75 
SENSOR_DEVICE_ATTR
(
pow”3_šput
, 0444, 
nå_hwmÚ_show_šput
, 
NULL
,

76 
NFP_SENSOR_ASSEMBLY_3V3_POWER
);

78 
©Œibu‹
 *
	gnå_©Œs
[] = {

79 &
£nsÜ_dev_©Œ_‹mp1_šput
.
dev_©Œ
.
©Œ
,

80 &
£nsÜ_dev_©Œ_‹mp1_max
.
dev_©Œ
.
©Œ
,

81 &
£nsÜ_dev_©Œ_‹mp1_ü™
.
dev_©Œ
.
©Œ
,

82 &
£nsÜ_dev_©Œ_pow”1_šput
.
dev_©Œ
.
©Œ
,

83 &
£nsÜ_dev_©Œ_pow”1_max
.
dev_©Œ
.
©Œ
,

84 &
£nsÜ_dev_©Œ_pow”2_šput
.
dev_©Œ
.
©Œ
,

85 &
£nsÜ_dev_©Œ_pow”3_šput
.
dev_©Œ
.
©Œ
,

86 
NULL


89 
ATTRIBUTE_GROUPS
(
nå
);

91 
	$nå_hwmÚ_»gi¡”
(
nå_pf
 *
pf
)

93 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 1, 0)

94 ià(!
	`IS_REACHABLE
(
CONFIG_HWMON
))

96 ià(!
	`IS_ENABLED
(
CONFIG_HWMON
))

100 ià(!
pf
->
n¥i
) {

101 
	`nå_w¬n
(
pf
->
ýp
, "not„egistering HWMON (no NSP info)\n");

104 ià(!
pf
->
n¥i
->
£nsÜ_mask
) {

105 
	`nå_šfo
(
pf
->
ýp
,

110 
pf
->
hwmÚ_dev
 = 
	`hwmÚ_deviû_»gi¡”_w™h_groups
(&pf->
pdev
->
dev
, "nfp",

111 
pf
, 
nå_groups
);

112  
	`PTR_ERR_OR_ZERO
(
pf
->
hwmÚ_dev
);

113 
	}
}

115 
	$nå_hwmÚ_uÄegi¡”
(
nå_pf
 *
pf
)

117 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 1, 0)

118 ià(!
	`IS_REACHABLE
(
CONFIG_HWMON
))

120 ià(!
	`IS_ENABLED
(
CONFIG_HWMON
))

124 ià(
pf
->
hwmÚ_dev
)

125 
	`hwmÚ_deviû_uÄegi¡”
(
pf
->
hwmÚ_dev
);

126 
	}
}

128 
	$nå_hwmÚ_»gi¡”
(
nå_pf
 *
pf
)

131 
	}
}

133 
	$nå_hwmÚ_uÄegi¡”
(
nå_pf
 *
pf
)

135 
	}
}

	@src/nfp_ioctl.h

9 #iâdeà
NFP_IOCTL_H


10 
	#NFP_IOCTL_H


	)

13 
	#NFP_IOCTL
 'n'

	)

15 
	snå_ýp_¬—_»que¡
 {

16 
	moff£t
;

17 
	mýp_id
;

18 
	mýp_addr
;

19 
	msize
;

28 
	#NFP_IOCTL_CPP_AREA_REQUEST
 \

29 
	`_IOWR
(
NFP_IOCTL
, 0x80, 
nå_ýp_¬—_»que¡
)

	)

37 
	#NFP_IOCTL_CPP_AREA_RELEASE
 \

38 
	`_IOW
(
NFP_IOCTL
, 0x81, 
nå_ýp_¬—_»que¡
)

	)

47 
	#NFP_IOCTL_CPP_AREA_RELEASE_OBSOLETE
 \

48 
	`_IOW
(
NFP_IOCTL
, 0x81, )

	)

50 
	#NFP_IOCTL_CPP_EXPL_POST
 0

	)

51 
	#NFP_IOCTL_CPP_EXPL1_BAR
 1

	)

52 
	#NFP_IOCTL_CPP_EXPL2_BAR
 2

	)

58 
	snå_ýp_ex¶ic™_»que¡
 {

59 
	mc¤
[3];

60 
	mš
, 
	mout
;

61 
u32
 
	md©a
[32];

62 
u64
 
	madd»ss
;

71 
	#NFP_IOCTL_CPP_EXPL_REQUEST
 \

72 
	`_IOW
(
NFP_IOCTL
, 0x82, 
nå_ýp_ex¶ic™_»que¡
)

	)

77 
	snå_ýp_id’tifiÿtiÚ
 {

78 
u32
 
	msize
;

79 
u32
 
	mmod–
;

80 
u32
 
	mš‹rçû
;

81 
u32
 
	m£rŸl_lo
;

82 
u32
 
	m£rŸl_hi
;

86 
	snå_ýp_ev’t_»que¡
 {

87 
	msigÇl
;

88 
	mty³
;

89 
	mm©ch
;

90 
	mmask
;

96 
	#NFP_IOCTL_CPP_EVENT_ACQUIRE
 \

97 
	`_IOW
(
NFP_IOCTL
, 0x83, 
nå_ýp_ev’t_»que¡
)

	)

102 
	#NFP_IOCTL_CPP_EVENT_RELEASE
 \

103 
	`_IOW
(
NFP_IOCTL
, 0x84, 
nå_ýp_ev’t_»que¡
)

	)

105 
	#NFP_FIRMWARE_MAX
 256

	)

110 
	#NFP_IOCTL_FIRMWARE_LOAD
 \

111 
	`_IOW
(
NFP_IOCTL
, 0x8d, [
NFP_FIRMWARE_MAX
])

	)

116 
	#NFP_IOCTL_FIRMWARE_LAST
 \

117 
	`_IOR
(
NFP_IOCTL
, 0x8e, [
NFP_FIRMWARE_MAX
])

	)

129 
	#NFP_IOCTL_CPP_IDENTIFICATION
 \

130 
	`_IOW
(
NFP_IOCTL
, 0x8f, 
u32
)

	)

	@src/nfp_main.c

11 
	~"nåcÜe/kcom·t.h
"

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/moduË.h
>

15 
	~<lšux/mu‹x.h
>

16 
	~<lšux/pci.h
>

17 
	~<lšux/fœmw¬e.h
>

18 
	~<lšux/vm®loc.h
>

19 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 6, 0)

20 
	~<Ãt/devlšk.h
>

23 
	~"nå_modšfo.h
"

25 
	~"nåcÜe/nå.h
"

26 
	~"nåcÜe/nå_ýp.h
"

27 
	~"nåcÜe/nå_dev.h
"

28 
	~"nåcÜe/nå_nffw.h
"

29 
	~"nåcÜe/nå_n¥.h
"

31 
	~"nåcÜe/nå6000_pc›.h
"

33 
	~"nåcÜe/nå_Ãt_vnic.h
"

35 
	~"nå_abi.h
"

36 
	~"nå_­p.h
"

37 
	~"nå_maš.h
"

38 
	~"nå_Ãt.h
"

40 #ifdeà
CONFIG_NFP_NET_PF


41 
boÞ
 
	gnå_pf_Ãtdev
 = 
Œue
;

42 #ifdeà
CONFIG_NFP_USER_SPACE_CPP


43 
moduË_·¿m
(
nå_pf_Ãtdev
, 
boÞ
, 0444);

44 
MODULE_PARM_DESC
(
nå_pf_Ãtdev
, "Create‚etdevs on PF (requires‡ppropriate firmware) (default =rue)");

47 cÚ¡ 
boÞ
 
	gnå_pf_Ãtdev
;

48 cÚ¡ 
devlšk_Ýs
 
	gnå_devlšk_Ýs
;

51 
	gnå_çÎback
 = -1;

52 #ià
defšed
(
CONFIG_NFP_NET_PF
è&& defšed(
CONFIG_NFP_USER_SPACE_CPP
)

53 
moduË_·¿m
(
nå_çÎback
, 
bšt
, 0444);

54 
MODULE_PARM_DESC
(
nå_çÎback
, "(netdev mode) Stay boundo device with user space‡ccess only (no‚etdevs) if‚o suitable FW is…resent (default =‚fp_dev_cpp)");

57 #ifdeà
CONFIG_NFP_USER_SPACE_CPP


58 
	gnå_dev_ýp
 = -1;

59 
moduË_·¿m
(
nå_dev_ýp
, 
bšt
, 0444);

60 
MODULE_PARM_DESC
(
nå_dev_ýp
,

63 
	gnå_dev_ýp
;

66 
boÞ
 
	gnå_Ãt_vnic
;

67 
moduË_·¿m
(
nå_Ãt_vnic
, 
boÞ
, 0444);

68 
MODULE_PARM_DESC
(
nå_Ãt_vnic
, "vNIC‚et devices (default = false)");

70 
	gnå_mÚ_ev’t
 = -1;

71 
moduË_·¿m
(
nå_mÚ_ev’t
, 
bšt
, 0444);

72 
MODULE_PARM_DESC
(
nå_mÚ_ev’t
, "(non-netdev mode) Event monitor support (default = !nfp_pf_netdev)");

74 
boÞ
 
	gfw_lßd_»quœed
;

75 
moduË_·¿m
(
fw_lßd_»quœed
, 
boÞ
, 0444);

76 
MODULE_PARM_DESC
(
fw_lßd_»quœed
,

79 cÚ¡ 
	gnå_driv”_Çme
[] = "nfp";

80 cÚ¡ 
	gnå_driv”_v”siÚ
[] = 
NFP_SRC_VERSION
;

82 cÚ¡ 
pci_deviû_id
 
	gnå_pci_deviû_ids
[] = {

83 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP3800
,

84 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

85 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP3800
,

87 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP4000
,

88 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

89 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000
,

91 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP5000
,

92 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

93 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000
,

95 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP6000
,

96 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

97 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000
,

101 #ià
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


102 
MODULE_DEVICE_TABLE
(
pci
, 
nå_pci_deviû_ids
);

105 
	$nå_pf_¹sym_»ad_ÝtiÚ®
(
nå_pf
 *
pf
, cÚ¡ *
fÜm©
,

106 
deçuÉ_v®
)

108 
Çme
[256];

109 
”r
 = 0;

110 
u64
 
v®
;

112 
	`¢´štf
(
Çme
, Òame), 
fÜm©
, 
	`nå_ýpcÜe_pc›_un™
(
pf
->
ýp
));

114 
v®
 = 
	`nå_¹sym_»ad_Ë
(
pf
->
¹bl
, 
Çme
, &
”r
);

115 ià(
”r
) {

116 ià(
”r
 =ð-
ENOENT
)

117  
deçuÉ_v®
;

118 
	`nå_”r
(
pf
->
ýp
, "UÇbËØ»ad symbÞ %s\n", 
Çme
);

119  
”r
;

122  
v®
;

123 
	}
}

125 
u8
 
__iomem
 *

126 
	$nå_pf_m­_¹sym
(
nå_pf
 *
pf
, cÚ¡ *
Çme
, cÚ¡ *
sym_fmt
,

127 
mš_size
, 
nå_ýp_¬—
 **
¬—
)

129 
pf_symbÞ
[256];

131 
	`¢´štf
(
pf_symbÞ
, Õf_symbÞ), 
sym_fmt
,

132 
	`nå_ýpcÜe_pc›_un™
(
pf
->
ýp
));

134  
	`nå_¹sym_m­
(
pf
->
¹bl
, 
pf_symbÞ
, 
Çme
, 
mš_size
, 
¬—
);

135 
	}
}

138 
	$nå_mbox_cmd
(
nå_pf
 *
pf
, 
u32
 
cmd
, *
š_d©a
, 
u64
 
š_Ëngth
,

139 *
out_d©a
, 
u64
 
out_Ëngth
)

141 
”r_©
;

142 
u64
 
max_d©a_sz
;

143 
u32
 
v®
 = 0;

144 
n
, 
”r
;

146 ià(!
pf
->
mbox
)

147  -
EOPNOTSUPP
;

149 
max_d©a_sz
 = 
	`nå_¹sym_size
(
pf
->
mbox
è- 
NFP_MBOX_SYM_MIN_SIZE
;

152 
”r
 = 
	`nå_¹sym_»adl
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_CMD
, &
v®
);

153 ià(
”r
 || 
v®
) {

154 
	`nå_w¬n
(
pf
->
ýp
, "failedo issue command (%u): %u,ƒrr: %d\n",

155 
cmd
, 
v®
, 
”r
);

156  
”r
 ?: -
EBUSY
;

159 
š_Ëngth
 = 
	`mš
(š_Ëngth, 
max_d©a_sz
);

160 
n
 = 
	`nå_¹sym_wr™e
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_DATA
, 
š_d©a
,

161 
š_Ëngth
);

162 ià(
n
 !ð
š_Ëngth
)

163  -
EIO
;

165 
”r
 = 
	`nå_¹sym_wr™eq
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_DATA_LEN
, 
š_Ëngth
);

166 ià(
”r
)

167  
”r
;

170 
”r
 = 
	`nå_¹sym_»adl
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_DATA_LEN
, &
v®
);

171 ià(
”r
)

172  
”r
;

175 
”r
 = 
	`nå_¹sym_wr™eq
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_CMD
, 
cmd
);

176 ià(
”r
)

177  
”r
;

179 
”r_©
 = 
jiff›s
 + 5 * 
HZ
;

180 
Œue
) {

182 
”r
 = 
	`nå_¹sym_»adl
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_CMD
, &
v®
);

183 ià(
”r
)

184  
”r
;

185 ià(!
v®
)

188 ià(
	`time_is_befÜe_eq_jiff›s
(
”r_©
))

189  -
ETIMEDOUT
;

191 
	`m¦“p
(5);

195 
”r
 = 
	`nå_¹sym_»adl
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_DATA_LEN
, &
v®
);

196 ià(
”r
)

197  
”r
;

199 
out_Ëngth
 = 
	`mš_t
(
u32
, 
v®
, 
	`mš
(out_Ëngth, 
max_d©a_sz
));

200 
n
 = 
	`nå_¹sym_»ad
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_DATA
,

201 
out_d©a
, 
out_Ëngth
);

202 ià(
n
 !ð
out_Ëngth
)

203  -
EIO
;

206 
”r
 = 
	`nå_¹sym_»adl
(
pf
->
ýp
,…f->
mbox
, 
NFP_MBOX_RET
, &
v®
);

207 ià(
”r
)

208  
”r
;

209 ià(
v®
)

210  -
v®
;

212  
out_Ëngth
;

213 
	}
}

215 
boÞ
 
	$nå_bßrd_»ady
(
nå_pf
 *
pf
)

217 cÚ¡ *
ý
;

218 
¡©e
;

219 
”r
;

221 
ý
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "board.state");

222 ià(!
ý
)

223  
çl£
;

225 
”r
 = 
	`k¡¹Þ
(
ý
, 0, &
¡©e
);

226 ià(
”r
 < 0)

227  
çl£
;

229  
¡©e
 == 15;

230 
	}
}

232 
	$nå_pf_bßrd_¡©e_wa™
(
nå_pf
 *
pf
)

234 cÚ¡ 
wa™_uÁž
 = 
jiff›s
 + 10 * 
HZ
;

236 !
	`nå_bßrd_»ady
(
pf
)) {

237 ià(
	`time_is_befÜe_eq_jiff›s
(
wa™_uÁž
)) {

238 
	`nå_”r
(
pf
->
ýp
, "NFP board initializationimeout\n");

239  -
EINVAL
;

242 
	`nå_šfo
(
pf
->
ýp
, "waiting for board initialization\n");

243 ià(
	`m¦“p_š‹¼u±ibË
(500))

244  -
ERESTARTSYS
;

247 
	`kä“
(
pf
->
hwšfo
);

248 
pf
->
hwšfo
 = 
	`nå_hwšfo_»ad
Õf->
ýp
);

252 
	}
}

254 
	$nå_pc›_¤iov_»ad_nfd_lim™
(
nå_pf
 *
pf
)

256 
”r
;

258 
pf
->
lim™_vfs
 = 
	`nå_¹sym_»ad_Ë
Õf->
¹bl
, "nfd_vf_cfg_max_vfs", &
”r
);

259 ià(
”r
) {

261 
pf
->
lim™_vfs
 = ~0;

262 
	`com·t_pci_¤iov_»£t_tÙ®vfs
(
pf
->
pdev
);

263 ià(
”r
 =ð-
ENOENT
)

266 
	`nå_w¬n
(
pf
->
ýp
, "W¬nšg: VF†im™„—d fažed: %d\n", 
”r
);

267  
”r
;

270 
”r
 = 
	`pci_¤iov_£t_tÙ®vfs
(
pf
->
pdev
,…f->
lim™_vfs
);

271 ià(
”r
)

272 
	`nå_w¬n
(
pf
->
ýp
, "FažedØ£ˆVF couÁ iÀsysfs: %d\n", 
”r
);

274 
	}
}

276 
	$nå_pc›_¤iov_’abË
(
pci_dev
 *
pdev
, 
num_vfs
)

278 #ifdeà
CONFIG_PCI_IOV


279 
nå_pf
 *
pf
 = 
	`pci_g‘_drvd©a
(
pdev
);

280 
”r
;

282 ià(
num_vfs
 > 
pf
->
lim™_vfs
) {

283 
	`nå_šfo
(
pf
->
ýp
, "Firmware†imits‚umber of VFso %u\n",

284 
pf
->
lim™_vfs
);

285  -
EINVAL
;

288 
”r
 = 
	`pci_’abË_¤iov
(
pdev
, 
num_vfs
);

289 ià(
”r
) {

290 
	`dev_w¬n
(&
pdev
->
dev
, "FažedØ’abË PCI SR-IOV: %d\n", 
”r
);

291  
”r
;

294 
	`mu‹x_lock
(&
pf
->
lock
);

296 
”r
 = 
nå_pf_Ãtdev
 ? 
	`nå_­p_¤iov_’abË
(
pf
->
­p
, 
num_vfs
) : 0;

297 ià(
”r
) {

298 
	`dev_w¬n
(&
pdev
->
dev
,

300 
”r
);

301 
”r_¤iov_di§bË
;

304 
pf
->
num_vfs
 =‚um_vfs;

306 
	`dev_dbg
(&
pdev
->
dev
, "C»©ed %d VFs.\n", 
pf
->
num_vfs
);

308 
	`mu‹x_uÆock
(&
pf
->
lock
);

309  
num_vfs
;

311 
”r_¤iov_di§bË
:

312 
	`mu‹x_uÆock
(&
pf
->
lock
);

313 
	`pci_di§bË_¤iov
(
pdev
);

314  
”r
;

317 
	}
}

319 
	$nå_pc›_¤iov_di§bË
(
pci_dev
 *
pdev
)

321 #ifdeà
CONFIG_PCI_IOV


322 
nå_pf
 *
pf
 = 
	`pci_g‘_drvd©a
(
pdev
);

324 
	`mu‹x_lock
(&
pf
->
lock
);

330 ià(
	`pci_vfs_assigÃd
(
pdev
)) {

331 
	`dev_w¬n
(&
pdev
->
dev
, "Disabling while VFs‡ssigned - VFs will‚ot be deallocated\n");

332 
	`mu‹x_uÆock
(&
pf
->
lock
);

333  -
EPERM
;

336 
	`nå_­p_¤iov_di§bË
(
pf
->
­p
);

338 
pf
->
num_vfs
 = 0;

340 
	`mu‹x_uÆock
(&
pf
->
lock
);

342 
	`pci_di§bË_¤iov
(
pdev
);

343 
	`dev_dbg
(&
pdev
->
dev
, "Removed VFs.\n");

346 
	}
}

348 
	$nå_pc›_¤iov_cÚfigu»
(
pci_dev
 *
pdev
, 
num_vfs
)

350 ià(
num_vfs
 == 0)

351  
	`nå_pc›_¤iov_di§bË
(
pdev
);

353  
	`nå_pc›_¤iov_’abË
(
pdev
, 
num_vfs
);

354 
	}
}

356 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 8, 0))

357 #ifdeà
CONFIG_PCI_IOV


361 
ssize_t
 
	$show_¤iov_tÙ®vfs
(
deviû
 *
dev
,

362 
deviû_©Œibu‹
 *
©Œ
,

363 *
buf
)

365 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

367  
	`¥rštf
(
buf
, "%u\n", 
	`pci_¤iov_g‘_tÙ®vfs
(
pdev
));

368 
	}
}

370 
ssize_t
 
	$show_¤iov_numvfs
(
deviû
 *
dev
,

371 
deviû_©Œibu‹
 *
©Œ
,

372 *
buf
)

374 
nå_pf
 *
pf
 = 
	`pci_g‘_drvd©a
(
	`to_pci_dev
(
dev
));

376  
	`¥rštf
(
buf
, "%u\n", 
pf
->
num_vfs
);

377 
	}
}

386 
ssize_t
 
	$¡Üe_¤iov_numvfs
(
deviû
 *
dev
,

387 
deviû_©Œibu‹
 *
©Œ
,

388 cÚ¡ *
buf
, 
size_t
 
couÁ
)

390 
nå_pf
 *
pf
 = 
	`pci_g‘_drvd©a
(
	`to_pci_dev
(
dev
));

391 
num_vfs
;

392 
»t
;

394 
»t
 = 
	`k¡¹oul
(
buf
, 0, &
num_vfs
);

395 ià(
»t
 < 0)

396  
»t
;

398 ià(
num_vfs
 > 
	`pci_¤iov_g‘_tÙ®vfs
(
pdev
))

399  -
ERANGE
;

401 ià(
num_vfs
 =ð
pf
->num_vfs)

402  
couÁ
;

404 ià(
num_vfs
 == 0) {

406 
»t
 = 
	`nå_pc›_¤iov_cÚfigu»
(
pdev
, 0);

407 ià(
»t
 < 0)

408  
»t
;

409  
couÁ
;

413 ià(
pf
->
num_vfs
) {

414 
	`dev_w¬n
(&
pdev
->
dev
, "%d VFs‡lreadyƒnabled. Disable beforeƒnabling %d VFs\n",

415 
pf
->
num_vfs
, ()num_vfs);

416  -
EBUSY
;

419 
»t
 = 
	`nå_pc›_¤iov_cÚfigu»
(
pdev
, 
num_vfs
);

420 ià(
»t
 < 0)

421  
»t
;

423 ià(
»t
 !ð
num_vfs
)

424 
	`dev_w¬n
(&
pdev
->
dev
, "%d VFs„equested; only %dƒnabled\n",

425 ()
num_vfs
, 
»t
);

427  
couÁ
;

428 
	}
}

430 
DEVICE_ATTR
(
¤iov_tÙ®vfs
, 
S_IRUGO
, 
show_¤iov_tÙ®vfs
, 
NULL
);

431 
DEVICE_ATTR
(
¤iov_numvfs
, 
S_IRUGO
 | 
S_IWUSR
 | 
S_IWGRP
,

432 
show_¤iov_numvfs
, 
¡Üe_¤iov_numvfs
);

434 
	$nå_¤iov_©Œ_add
(
deviû
 *
dev
)

436 
”r
 = 0;

438 
”r
 = 
	`deviû_ü—‹_fže
(
dev
, &
dev_©Œ_¤iov_tÙ®vfs
);

439 ià(
”r
)

440  
”r
;

442  
	`deviû_ü—‹_fže
(
dev
, &
dev_©Œ_¤iov_numvfs
);

443 
	}
}

445 
	$nå_¤iov_©Œ_»move
(
deviû
 *
dev
)

447 
	`deviû_»move_fže
(
dev
, &
dev_©Œ_¤iov_tÙ®vfs
);

448 
	`deviû_»move_fže
(
dev
, &
dev_©Œ_¤iov_numvfs
);

449 
	}
}

453 
	$nå_æash_upd©e_commÚ
(
nå_pf
 *
pf
, cÚ¡ *
·th
,

454 
ÃŽšk_ext_ack
 *
exck
)

456 
deviû
 *
dev
 = &
pf
->
pdev
->dev;

457 cÚ¡ 
fœmw¬e
 *
fw
;

458 
nå_n¥
 *
n¥
;

459 
”r
;

461 
n¥
 = 
	`nå_n¥_Ý’
(
pf
->
ýp
);

462 ià(
	`IS_ERR
(
n¥
)) {

463 
”r
 = 
	`PTR_ERR
(
n¥
);

464 ià(
exck
)

465 
	`NL_SET_ERR_MSG_MOD
(
exck
, "can't‡ccess NSP");

467 
	`dev_”r
(
dev
, "FažedØacûs thNSP: %d\n", 
”r
);

468  
”r
;

471 
”r
 = 
	`»que¡_fœmw¬e_dœeù
(&
fw
, 
·th
, 
dev
);

472 ià(
”r
) {

473 
	`NL_SET_ERR_MSG_MOD
(
exck
,

475 
ex™_þo£_n¥
;

478 
	`dev_šfo
(
dev
, "Please be…atient while writing flash image: %s\n",

479 
·th
);

481 
”r
 = 
	`nå_n¥_wr™e_æash
(
n¥
, 
fw
);

482 ià(
”r
 < 0)

483 
ex™_»Ëa£_fw
;

484 
	`dev_šfo
(
dev
, "Finished writing flash image\n");

485 
”r
 = 0;

487 
ex™_»Ëa£_fw
:

488 
	`»Ëa£_fœmw¬e
(
fw
);

489 
ex™_þo£_n¥
:

490 
	`nå_n¥_þo£
(
n¥
);

491  
”r
;

492 
	}
}

494 cÚ¡ 
fœmw¬e
 *

495 
	$nå_Ãt_fw_»que¡
(
pci_dev
 *
pdev
, 
nå_pf
 *
pf
, cÚ¡ *
Çme
)

497 cÚ¡ 
fœmw¬e
 *
fw
 = 
NULL
;

498 
”r
;

500 
”r
 = 
	`»que¡_fœmw¬e_dœeù
(&
fw
, 
Çme
, &
pdev
->
dev
);

501 
	`nå_šfo
(
pf
->
ýp
, " %s: %s\n",

502 
Çme
, 
”r
 ? "not found" : "found,†oading...");

503 ià(
”r
)

504  
NULL
;

506  
fw
;

507 
	}
}

516 cÚ¡ 
fœmw¬e
 *

517 
	$nå_Ãt_fw_fšd
(
pci_dev
 *
pdev
, 
nå_pf
 *
pf
)

519 
nå_‘h_bË_pÜt
 *
pÜt
;

520 cÚ¡ 
fœmw¬e
 *
fw
;

521 cÚ¡ *
fw_mod–
;

522 
fw_Çme
[256];

523 cÚ¡ 
u8
 *
£rŸl
;

524 
u16
 
š‹rçû
;

525 
¥c
, 
i
, 
j
;

527 
	`nå_šfo
(
pf
->
ýp
, "Looking for firmware file in order of…riority:\n");

530 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
pf
->
ýp
);

531 
	`nå_ýp_£rŸl
(
pf
->
ýp
, &
£rŸl
);

532 
	`¥rštf
(
fw_Çme
, "netronome/serial-%pMF-%02hhx-%02hhx.nffw",

533 
£rŸl
, 
š‹rçû
 >> 8, interface & 0xff);

534 
fw
 = 
	`nå_Ãt_fw_»que¡
(
pdev
, 
pf
, 
fw_Çme
);

535 ià(
fw
)

536  
fw
;

539 
	`¥rštf
(
fw_Çme
, "ÃŒÚome/pci-%s.nffw", 
	`pci_Çme
(
pdev
));

540 
fw
 = 
	`nå_Ãt_fw_»que¡
(
pdev
, 
pf
, 
fw_Çme
);

541 ià(
fw
)

542  
fw
;

545 ià(!
pf
->
‘h_tbl
) {

546 
	`dev_”r
(&
pdev
->
dev
, "Error: can't identify media config\n");

547  
NULL
;

550 
fw_mod–
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.partno");

551 ià(!
fw_mod–
) {

552 
	`dev_”r
(&
pdev
->
dev
, "Error: can't„ead…art‚umber\n");

553  
NULL
;

556 
¥c
 = 
	`ARRAY_SIZE
(
fw_Çme
);

557 
¥c
 -ð
	`¢´štf
(
fw_Çme
, spc, "ÃŒÚome/nic_%s", 
fw_mod–
);

559 
i
 = 0; 
¥c
 > 0 && i < 
pf
->
‘h_tbl
->
couÁ
; i +ð
j
) {

560 
pÜt
 = &
pf
->
‘h_tbl
->
pÜts
[
i
];

561 
j
 = 1;

562 
i
 + 
j
 < 
pf
->
‘h_tbl
->
couÁ
 &&

563 
pÜt
->
¥“d
 =ðpÜt[
j
].speed)

564 
j
++;

566 
¥c
 -ð
	`¢´štf
(&
fw_Çme
[
	`ARRAY_SIZE
(fw_name) - spc], spc,

567 "_%dx%d", 
j
, 
pÜt
->
¥“d
 / 1000);

570 ià(
¥c
 <= 0)

571  
NULL
;

573 
¥c
 -ð
	`¢´štf
(&
fw_Çme
[
	`ARRAY_SIZE
(fw_name) - spc], spc, ".nffw");

574 ià(
¥c
 <= 0)

575  
NULL
;

577  
	`nå_Ãt_fw_»que¡
(
pdev
, 
pf
, 
fw_Çme
);

578 
	}
}

589 
	$nå_fw_lßd
(
pci_dev
 *
pdev
, 
nå_pf
 *
pf
, 
nå_n¥
 *
n¥
)

591 cÚ¡ 
fœmw¬e
 *
fw
;

592 
u16
 
š‹rçû
;

593 
”r
;

595 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
pf
->
ýp
);

596 ià(
	`NFP_CPP_INTERFACE_UNIT_of
(
š‹rçû
) != 0) {

598 
	`dev_šfo
(&
pdev
->
dev
, "Firmware will be†oaded by…artner\n");

602 
fw
 = 
	`nå_Ãt_fw_fšd
(
pdev
, 
pf
);

603 ià(!
fw
) {

604 ià(
	`nå_n¥_has_¡Üed_fw_lßd
(
n¥
) &&

605 !
	`nå_n¥_lßd_¡Üed_fw
(
n¥
))

607  
fw_lßd_»quœed
 ? -
ENOENT
 : 0;

610 
	`dev_šfo
(&
pdev
->
dev
, "Soft-reset,†oading FW image\n");

611 
”r
 = 
	`nå_n¥_deviû_soá_»£t
(
n¥
);

612 ià(
”r
 < 0) {

613 
	`dev_”r
(&
pdev
->
dev
, "Failedo soft„esethe NFP: %d\n",

614 
”r
);

615 
ex™_»Ëa£_fw
;

618 
”r
 = 
	`nå_n¥_lßd_fw
(
n¥
, 
fw
);

619 ià(
”r
 < 0) {

620 
	`dev_”r
(&
pdev
->
dev
, "FW†ßdšg fažed: %d\n", 
”r
);

621 
ex™_»Ëa£_fw
;

624 
	`dev_šfo
(&
pdev
->
dev
, "Finished†oading FW image\n");

626 
ex™_»Ëa£_fw
:

627 
	`»Ëa£_fœmw¬e
(
fw
);

629  
”r
 < 0 ?ƒrr : 1;

630 
	}
}

633 
	$nå_n¥_š™_pÜts
(
pci_dev
 *
pdev
, 
nå_pf
 *
pf
,

634 
nå_n¥
 *
n¥
)

636 
boÞ
 
Ãeds_»š™
 = 
çl£
;

637 
i
;

639 
pf
->
‘h_tbl
 = 
	`__nå_‘h_»ad_pÜts
Õf->
ýp
, 
n¥
);

640 ià(!
pf
->
‘h_tbl
)

643 ià(!
	`nå_n¥_has_mac_»š™
(
n¥
))

646 
i
 = 0; i < 
pf
->
‘h_tbl
->
couÁ
; i++)

647 
Ãeds_»š™
 |ð
pf
->
‘h_tbl
->
pÜts
[
i
].
ov”ride_chªged
;

648 ià(!
Ãeds_»š™
)

651 
	`kä“
(
pf
->
‘h_tbl
);

652 ià(
	`nå_n¥_mac_»š™
(
n¥
))

653 
	`dev_w¬n
(&
pdev
->
dev
, "MAC„einit failed\n");

655 
pf
->
‘h_tbl
 = 
	`__nå_‘h_»ad_pÜts
Õf->
ýp
, 
n¥
);

656 
	}
}

658 
	$nå_n¥_š™
(
pci_dev
 *
pdev
, 
nå_pf
 *
pf
)

660 
nå_n¥
 *
n¥
;

661 
”r
;

663 ià(!
nå_pf_Ãtdev
)

666 
”r
 = 
	`nå_»sourû_wa™
(
pf
->
ýp
, 
NFP_RESOURCE_NSP
, 30);

667 ià(
”r
)

668  
”r
;

670 
n¥
 = 
	`nå_n¥_Ý’
(
pf
->
ýp
);

671 ià(
	`IS_ERR
(
n¥
)) {

672 
”r
 = 
	`PTR_ERR
(
n¥
);

673 
	`dev_”r
(&
pdev
->
dev
, "FažedØacûs thNSP: %d\n", 
”r
);

674  
”r
;

677 
”r
 = 
	`nå_n¥_wa™
(
n¥
);

678 ià(
”r
 < 0)

679 
ex™_þo£_n¥
;

681 
	`nå_n¥_š™_pÜts
(
pdev
, 
pf
, 
n¥
);

683 
pf
->
n¥i
 = 
	`__nå_n¥_id’tify
(
n¥
);

684 ià(
pf
->
n¥i
)

685 
	`dev_šfo
(&
pdev
->
dev
, "BSP: %s\n", 
pf
->
n¥i
->
v”siÚ
);

687 
”r
 = 
	`nå_fw_lßd
(
pdev
, 
pf
, 
n¥
);

688 ià(
”r
 < 0) {

689 
	`kä“
(
pf
->
n¥i
);

690 
	`kä“
(
pf
->
‘h_tbl
);

691 
	`dev_”r
(&
pdev
->
dev
, "Failedo†oad FW\n");

692 
ex™_þo£_n¥
;

695 
pf
->
fw_lßded
 = !!
”r
;

696 
”r
 = 0;

698 
ex™_þo£_n¥
:

699 
	`nå_n¥_þo£
(
n¥
);

701  
”r
;

702 
	}
}

704 
	$nå_fw_uÆßd
(
nå_pf
 *
pf
)

706 
nå_n¥
 *
n¥
;

707 
”r
;

709 
n¥
 = 
	`nå_n¥_Ý’
(
pf
->
ýp
);

710 ià(
	`IS_ERR
(
n¥
)) {

711 
	`nå_”r
(
pf
->
ýp
, "Reset failed, can't open NSP\n");

715 
”r
 = 
	`nå_n¥_deviû_soá_»£t
(
n¥
);

716 ià(
”r
 < 0)

717 
	`dev_w¬n
(&
pf
->
pdev
->
dev
, "Couldn'ˆuÆßd fœmw¬e: %d\n", 
”r
);

719 
	`dev_šfo
(&
pf
->
pdev
->
dev
, "Firmware safely unloaded\n");

721 
	`nå_n¥_þo£
(
n¥
);

722 
	}
}

724 
	$nå_pf_fšd_¹syms
(
nå_pf
 *
pf
)

726 
pf_symbÞ
[256];

727 
pf_id
;

729 
pf_id
 = 
	`nå_ýpcÜe_pc›_un™
(
pf
->
ýp
);

732 
	`¢´štf
(
pf_symbÞ
, Õf_symbÞ), 
NFP_MBOX_SYM_NAME
, 
pf_id
);

733 
pf
->
mbox
 = 
	`nå_¹sym_lookup
Õf->
¹bl
, 
pf_symbÞ
);

734 ià(
pf
->
mbox
 && 
	`nå_¹sym_size
Õf->mboxè< 
NFP_MBOX_SYM_MIN_SIZE
) {

735 
	`nå_”r
(
pf
->
ýp
, "PF mailbox symboloo small: %llu < %d\n",

736 
	`nå_¹sym_size
(
pf
->
mbox
), 
NFP_MBOX_SYM_MIN_SIZE
);

737  -
EINVAL
;

741 
	}
}

743 
	$nå_»gi¡”_vnic
(
nå_pf
 *
pf
)

745 
pc›_un™
;

747 
pc›_un™
 = 
	`nå_ýpcÜe_pc›_un™
(
pf
->
ýp
);

749 ià(!
nå_Ãt_vnic
)

752 
pf
->
nå_Ãt_vnic
 =

753 
	`nå_¶©fÜm_deviû_»gi¡”_un™
(
pf
->
ýp
, 
NFP_NET_VNIC_TYPE
,

754 
pc›_un™
,

755 
NFP_NET_VNIC_UNITS
);

756 
	}
}

758 
	$nå_pci_´obe
(
pci_dev
 *
pdev
,

759 cÚ¡ 
pci_deviû_id
 *
pci_id
)

761 cÚ¡ 
nå_dev_šfo
 *
dev_šfo
;

762 
devlšk
 *devlink;

763 
nå_pf
 *
pf
;

764 
”r
, 
œq
;

766 
dev_šfo
 = &
nå_dev_šfo
[
pci_id
->
driv”_d©a
];

768 
”r
 = 
	`pci_’abË_deviû
(
pdev
);

769 ià(
”r
 < 0)

770  
”r
;

772 
	`pci_£t_ma¡”
(
pdev
);

774 
”r
 = 
	`dma_£t_mask_ªd_coh”’t
(&
pdev
->
dev
, 
dev_šfo
->
dma_mask
);

775 ià(
”r
)

776 
”r_pci_di§bË
;

778 
”r
 = 
	`pci_»que¡_»giÚs
(
pdev
, 
nå_driv”_Çme
);

779 ià(
”r
 < 0) {

780 
	`dev_”r
(&
pdev
->
dev
, "Unableo„eserve…ci„esources.\n");

781 
”r_pci_di§bË
;

784 
devlšk
 = 
	`devlšk_®loc
(&
nå_devlšk_Ýs
, (*
pf
));

785 ià(!
devlšk
) {

786 
”r
 = -
ENOMEM
;

787 
”r_»l_»giÚs
;

789 
pf
 = 
	`devlšk_´iv
(
devlšk
);

790 
	`INIT_LIST_HEAD
(&
pf
->
vnics
);

791 
	`INIT_LIST_HEAD
(&
pf
->
pÜts
);

792 
	`mu‹x_š™
(&
pf
->
lock
);

793 
	`pci_£t_drvd©a
(
pdev
, 
pf
);

794 
pf
->
pdev
 =…dev;

795 
pf
->
dev_šfo
 = dev_info;

797 
pf
->
wq
 = 
	`®loc_wÜkqueue
("nå-%s", 0, 2, 
	`pci_Çme
(
pdev
));

798 ià(!
pf
->
wq
) {

799 
”r
 = -
ENOMEM
;

800 
”r_pci_´iv_un£t
;

803 ià(
nå_mÚ_ev’t
) {

805 
”r
 = 
	`pci_’abË_msix
(
pdev
, &
pf
->
msix
, 1);

806 ià(!
”r
)

807 
œq
 = 
pf
->
msix
.
veùÜ
;

809 
œq
 = 
pdev
->irq;

811 
œq
 = -1;

814 
pf
->
ýp
 = 
	`nå_ýp_äom_nå6000_pc›
(
pdev
, 
dev_šfo
, 
œq
);

815 ià(
	`IS_ERR_OR_NULL
(
pf
->
ýp
)) {

816 
”r
 = 
	`PTR_ERR
(
pf
->
ýp
);

817 ià(
”r
 >= 0)

818 
”r
 = -
ENOMEM
;

819 
”r_di§bË_msix
;

822 
”r
 = 
	`nå_»sourû_bË_š™
(
pf
->
ýp
);

823 ià(
”r
)

824 
”r_ýp_ä“
;

826 
pf
->
hwšfo
 = 
	`nå_hwšfo_»ad
Õf->
ýp
);

828 
	`dev_šfo
(&
pdev
->
dev
, "Assembly: %s%s%s-%s CPLD: %s\n",

829 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.vendor"),

830 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.partno"),

831 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.serial"),

832 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "assembly.revision"),

833 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, "cpld.version"));

835 
”r
 = 
	`nå_pf_bßrd_¡©e_wa™
(
pf
);

836 ià(
”r
 && 
nå_pf_Ãtdev
)

837 
”r_hwšfo_ä“
;

839 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 8, 0)è&& 
	`defšed
(
CONFIG_PCI_IOV
)

840 
”r
 = 
	`nå_¤iov_©Œ_add
(&
pdev
->
dev
);

841 ià(
”r
 < 0)

842 
”r_hwšfo_ä“
;

844 
”r
 = 
	`nå_n¥_š™
(
pdev
, 
pf
);

845 ià(
”r
)

846 
”r_¤iov_»move
;

848 
pf
->
m
 = 
	`nå_m_Ý’
Õf->
ýp
);

849 
pf
->
¹bl
 = 
	`__nå_¹sym_bË_»ad
Õf->
ýp
,…f->
m
);

851 
”r
 = 
	`nå_pf_fšd_¹syms
(
pf
);

852 ià(
”r
)

853 
”r_fw_uÆßd
;

855 
pf
->
dump_æag
 = 
NFP_DUMP_NSP_DIAG
;

856 
pf
->
dump¥ec
 = 
	`nå_Ãt_dump_lßd_dump¥ec
Õf->
ýp
,…f->
¹bl
);

858 
”r
 = 
	`nå_pc›_¤iov_»ad_nfd_lim™
(
pf
);

859 ià(
”r
)

860 
”r_fw_uÆßd
;

862 
pf
->
num_vfs
 = 
	`pci_num_vf
(
pdev
);

863 ià(
pf
->
num_vfs
 >…f->
lim™_vfs
) {

864 
	`dev_”r
(&
pdev
->
dev
,

866 
pf
->
num_vfs
,…f->
lim™_vfs
);

867 
”r
 = -
EINVAL
;

868 
”r_fw_uÆßd
;

871 ià(
nå_dev_ýp
) {

872 
pf
->
nå_dev_ýp
 =

873 
	`nå_¶©fÜm_deviû_»gi¡”
(
pf
->
ýp
, 
NFP_DEV_CPP_TYPE
);

874 ià(!
pf
->
nå_dev_ýp
)

875 
	`dev_”r
(&
pdev
->
dev
, "Failedoƒnable user space‡ccess. Ignoring.\n");

878 ià(
nå_pf_Ãtdev
) {

879 
”r
 = 
	`nå_Ãt_pci_´obe
(
pf
);

880 ià(
nå_çÎback
 && 
”r
 == 1) {

881 
	`dev_šfo
(&
pdev
->
dev
, "Netronome NFP Fallback driver\n");

882 } ià(
”r
) {

883 
”r
 =ƒ¼ < 0 ?ƒ¼ : -
EINVAL
;

884 
”r_dev_ýp_uÄeg
;

887 
	`nå_»gi¡”_vnic
(
pf
);

890 
”r
 = 
	`nå_hwmÚ_»gi¡”
(
pf
);

891 ià(
”r
) {

892 
	`dev_”r
(&
pdev
->
dev
, "Failedo„egister hwmon info\n");

893 
”r_Ãt_»move
;

898 
”r_Ãt_»move
:

899 ià(
pf
->
nå_Ãt_vnic
)

900 
	`nå_¶©fÜm_deviû_uÄegi¡”
(
pf
->
nå_Ãt_vnic
);

901 ià(
nå_pf_Ãtdev
)

902 
	`nå_Ãt_pci_»move
(
pf
);

903 
”r_dev_ýp_uÄeg
:

904 ià(
pf
->
nå_dev_ýp
)

905 
	`nå_¶©fÜm_deviû_uÄegi¡”
(
pf
->
nå_dev_ýp
);

906 
	`com·t_pci_¤iov_»£t_tÙ®vfs
(
pf
->
pdev
);

907 
”r_fw_uÆßd
:

908 
	`kä“
(
pf
->
¹bl
);

909 
	`nå_m_þo£
(
pf
->
m
);

910 ià(
pf
->
fw_lßded
)

911 
	`nå_fw_uÆßd
(
pf
);

912 
	`kä“
(
pf
->
‘h_tbl
);

913 
	`kä“
(
pf
->
n¥i
);

914 
	`vä“
(
pf
->
dump¥ec
);

915 
”r_¤iov_»move
:

916 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 8, 0)è&& 
	`defšed
(
CONFIG_PCI_IOV
)

917 
	`nå_¤iov_©Œ_»move
(&
pdev
->
dev
);

919 
”r_hwšfo_ä“
:

920 
	`kä“
(
pf
->
hwšfo
);

921 
”r_ýp_ä“
:

922 
	`nå_ýp_ä“
(
pf
->
ýp
);

923 
”r_di§bË_msix
:

924 ià(
pdev
->
msix_’abËd
)

925 
	`pci_di§bË_msix
(
pdev
);

926 
	`de¡roy_wÜkqueue
(
pf
->
wq
);

927 
”r_pci_´iv_un£t
:

928 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

929 
	`mu‹x_de¡roy
(&
pf
->
lock
);

930 
	`devlšk_ä“
(
devlšk
);

931 
”r_»l_»giÚs
:

932 
	`pci_»Ëa£_»giÚs
(
pdev
);

933 
”r_pci_di§bË
:

934 
	`pci_di§bË_deviû
(
pdev
);

936  
”r
;

937 
	}
}

939 
	$nå_pci_»move
(
pci_dev
 *
pdev
)

941 
nå_pf
 *
pf
 = 
	`pci_g‘_drvd©a
(
pdev
);

943 
	`nå_hwmÚ_uÄegi¡”
(
pf
);

945 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 8, 0è&& 
	`defšed
(
CONFIG_PCI_IOV
)

946 
	`nå_¤iov_©Œ_»move
(&
pdev
->
dev
);

948 
	`nå_pc›_¤iov_di§bË
(
pdev
);

949 
	`com·t_pci_¤iov_»£t_tÙ®vfs
(
pf
->
pdev
);

951 ià(
nå_pf_Ãtdev
 && 
pf
->
­p
)

952 
	`nå_Ãt_pci_»move
(
pf
);

954 ià(
pf
->
nå_Ãt_vnic
)

955 
	`nå_¶©fÜm_deviû_uÄegi¡”
(
pf
->
nå_Ãt_vnic
);

957 
	`vä“
(
pf
->
dump¥ec
);

958 
	`kä“
(
pf
->
¹bl
);

959 
	`nå_m_þo£
(
pf
->
m
);

960 ià(
pf
->
fw_lßded
)

961 
	`nå_fw_uÆßd
(
pf
);

963 ià(
pf
->
nå_dev_ýp
)

964 
	`nå_¶©fÜm_deviû_uÄegi¡”
(
pf
->
nå_dev_ýp
);

966 
	`de¡roy_wÜkqueue
(
pf
->
wq
);

967 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

968 
	`kä“
(
pf
->
hwšfo
);

969 
	`nå_ýp_ä“
(
pf
->
ýp
);

971 ià(
nå_mÚ_ev’t
)

972 
	`pci_di§bË_msix
(
pdev
);

974 
	`kä“
(
pf
->
‘h_tbl
);

975 
	`kä“
(
pf
->
n¥i
);

976 
	`mu‹x_de¡roy
(&
pf
->
lock
);

977 
	`devlšk_ä“
(
	`´iv_to_devlšk
(
pf
));

978 
	`pci_»Ëa£_»giÚs
(
pdev
);

979 
	`pci_di§bË_deviû
(
pdev
);

980 
	}
}

982 
pci_driv”
 
	gnå_pci_driv”
 = {

983 .
Çme
 = 
nå_driv”_Çme
,

984 .
	gid_bË
 = 
nå_pci_deviû_ids
,

985 .
	g´obe
 = 
nå_pci_´obe
,

986 .
	g»move
 = 
nå_pci_»move
,

987 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 8, 0))

988 .
	g¤iov_cÚfigu»
 = 
nå_pc›_¤iov_cÚfigu»
,

992 #ià!
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


993 cÚ¡ 
pci_deviû_id
 
	gcom·t_nå_deviû_ids
[] = {

994 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP3800
,

995 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

996 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP3800
,

998 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP4000
,

999 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

1000 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000
,

1002 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP5000
,

1003 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

1004 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000
,

1006 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP6000
,

1007 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

1008 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000
,

1010 #ifdeà
CONFIG_NFP_NET_VF


1011 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP3800_VF
,

1012 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

1013 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP3800_VF
,

1015 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP6000_VF
,

1016 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

1017 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000_VF
,

1022 
MODULE_DEVICE_TABLE
(
pci
, 
com·t_nå_deviû_ids
);

1024 
	$com·t_nå_´obe
(
pci_dev
 *
pdev
,

1025 cÚ¡ 
pci_deviû_id
 *
pci_id
)

1027 #ifdeà
CONFIG_NFP_NET_VF


1028 ià(
pdev
->
deviû
 =ð
PCI_DEVICE_ID_NETRONOME_NFP3800_VF
 ||

1029 
pdev
->
deviû
 =ð
PCI_DEVICE_ID_NETRONOME_NFP6000_VF
)

1030  
nå_Ãtvf_pci_driv”
.
	`´obe
(
pdev
, 
pci_id
);

1032  
nå_pci_driv”
.
	`´obe
(
pdev
, 
pci_id
);

1033 
	}
}

1035 
	$com·t_nå_»move
(
pci_dev
 *
pdev
)

1037 #ifdeà
CONFIG_NFP_NET_VF


1038 ià(
pdev
->
deviû
 =ð
PCI_DEVICE_ID_NETRONOME_NFP3800_VF
 ||

1039 
pdev
->
deviû
 =ð
PCI_DEVICE_ID_NETRONOME_NFP6000_VF
) {

1040 
nå_Ãtvf_pci_driv”
.
	`»move
(
pdev
);

1044 
nå_pci_driv”
.
	`»move
(
pdev
);

1045 
	}
}

1047 
pci_driv”
 
	gcom·t_nå_driv”
 = {

1048 .
Çme
 = 
nå_driv”_Çme
,

1049 .
	gid_bË
 = 
com·t_nå_deviû_ids
,

1050 .
	g´obe
 = 
com·t_nå_´obe
,

1051 .
	g»move
 = 
com·t_nå_»move
,

1052 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 8, 0))

1053 .
	g¤iov_cÚfigu»
 = 
nå_pc›_¤iov_cÚfigu»
,

1058 
	$nå_Ãt_vf_»gi¡”
()

1060 #ià
	`defšed
(
CONFIG_NFP_NET_VF
è&& 
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


1061  
	`pci_»gi¡”_driv”
(&
nå_Ãtvf_pci_driv”
);

1064 
	}
}

1066 
	$nå_Ãt_vf_uÄegi¡”
()

1068 #ià
	`defšed
(
CONFIG_NFP_NET_VF
è&& 
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


1069 
	`pci_uÄegi¡”_driv”
(&
nå_Ãtvf_pci_driv”
);

1071 
	}
}

1073 
boÞ
 
__š™
 
	$nå_»sÞve_·¿ms
()

1075 ià(
nå_pf_Ãtdev
 && 
nå_mÚ_ev’t
 == 1) {

1076 
	`´_”r
("nfp_mon_event cannot be used in‚etdev mode\n");

1077  
çl£
;

1079 ià(!
nå_pf_Ãtdev
 && 
nå_çÎback
 == 1)

1080 
	`´_w¬n
("nfp_fallback is ignored in‚on-netdev mode\n");

1081 ià(
nå_çÎback
 =ð1 && 
nå_dev_ýp
 == 0) {

1082 
	`´_”r
("nfp_fallback cannot be used without‚fp_dev_cpp\n");

1083  
çl£
;

1086 #ifdeà
CONFIG_NFP_USER_SPACE_CPP


1087 ià(
nå_dev_ýp
 == -1)

1088 
nå_dev_ýp
 = !
nå_pf_Ãtdev
;

1090 ià(
nå_mÚ_ev’t
 == -1)

1091 
nå_mÚ_ev’t
 = !
nå_pf_Ãtdev
;

1092 ià(
nå_çÎback
 == -1)

1093 
nå_çÎback
 = 
nå_pf_Ãtdev
 && 
nå_dev_ýp
;

1095  
Œue
;

1096 
	}
}

1098 
__š™
 
	$nå_maš_š™
()

1100 
”r
;

1102 
	`´_šfo
("%s: NFP PCIe Driver, Copyright (C) 2014-2017 Netronome Systems\n",

1103 
nå_driv”_Çme
);

1104 
	`´_šfo
(
	`NFP_BUILD_DESCRIPTION
(
nå
));

1106 ià(!
	`nå_»sÞve_·¿ms
())

1107  -
EINVAL
;

1109 
”r
 = 
	`nå_ýpcÜe_š™
();

1110 ià(
”r
 < 0)

1111  
”r
;

1113 
”r
 = 
	`nå_dev_ýp_š™
();

1114 ià(
”r
 < 0)

1115 
”r_ex™_ýpcÜe
;

1117 
”r
 = 
	`nå_Ãt_vnic_š™
();

1118 ià(
”r
 < 0)

1119 
”r_ex™_dev_ýp
;

1121 
	`nå_Ãt_debugfs_ü—‹
();

1123 #ià
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


1124 
”r
 = 
	`pci_»gi¡”_driv”
(&
nå_pci_driv”
);

1126 
”r
 = 
	`pci_»gi¡”_driv”
(&
com·t_nå_driv”
);

1128 ià(
”r
 < 0)

1129 
”r_de¡roy_debugfs
;

1131 
”r
 = 
	`nå_Ãt_vf_»gi¡”
();

1132 ià(
”r
)

1133 
”r_uÄeg_pf
;

1135  
”r
;

1137 
”r_uÄeg_pf
:

1138 #ià
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


1139 
	`pci_uÄegi¡”_driv”
(&
nå_pci_driv”
);

1141 
	`pci_uÄegi¡”_driv”
(&
com·t_nå_driv”
);

1143 
”r_de¡roy_debugfs
:

1144 
	`nå_Ãt_debugfs_de¡roy
();

1145 
	`nå_Ãt_vnic_ex™
();

1146 
”r_ex™_dev_ýp
:

1147 
	`nå_dev_ýp_ex™
();

1148 
”r_ex™_ýpcÜe
:

1149 
	`nå_ýpcÜe_ex™
();

1150  
”r
;

1151 
	}
}

1153 
__ex™
 
	$nå_maš_ex™
()

1155 
	`nå_Ãt_vf_uÄegi¡”
();

1156 #ià
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


1157 
	`pci_uÄegi¡”_driv”
(&
nå_pci_driv”
);

1159 
	`pci_uÄegi¡”_driv”
(&
com·t_nå_driv”
);

1161 
	`nå_Ãt_debugfs_de¡roy
();

1162 
	`nå_Ãt_vnic_ex™
();

1163 
	`nå_dev_ýp_ex™
();

1164 
	`nå_ýpcÜe_ex™
();

1165 
	}
}

1167 
moduË_š™
(
nå_maš_š™
);

1168 
moduË_ex™
(
nå_maš_ex™
);

1170 
MODULE_FIRMWARE
("netronome/nic_AMDA0081-0001_1x40.nffw");

1171 
MODULE_FIRMWARE
("netronome/nic_AMDA0081-0001_4x10.nffw");

1172 
MODULE_FIRMWARE
("netronome/nic_AMDA0096-0001_2x10.nffw");

1173 
MODULE_FIRMWARE
("netronome/nic_AMDA0097-0001_2x40.nffw");

1174 
MODULE_FIRMWARE
("netronome/nic_AMDA0097-0001_4x10_1x40.nffw");

1175 
MODULE_FIRMWARE
("netronome/nic_AMDA0097-0001_8x10.nffw");

1176 
MODULE_FIRMWARE
("netronome/nic_AMDA0099-0001_2x10.nffw");

1177 
MODULE_FIRMWARE
("netronome/nic_AMDA0099-0001_2x25.nffw");

1178 
MODULE_FIRMWARE
("netronome/nic_AMDA0099-0001_1x10_1x25.nffw");

1180 
MODULE_AUTHOR
("Netronome Systems <oss-drivers@netronome.com>");

1181 
MODULE_LICENSE
("GPL");

1182 
MODULE_DESCRIPTION
("The Netronome Flow Processor (NFP) driver.");

1183 
MODULE_VERSION
("5.2.0");

1184 
MODULE_INFO_NFP
();

	@src/nfp_main.h

9 #iâdeà
NFP_MAIN_H


10 
	#NFP_MAIN_H


	)

12 
	~"nåcÜe/kcom·t.h
"

14 
	~<lšux/‘htoÞ.h
>

15 
	~<lšux/li¡.h
>

16 
	~<lšux/ty³s.h
>

17 
	~<lšux/msi.h
>

18 
	~<lšux/mu‹x.h
>

19 
	~<lšux/pci.h
>

20 
	~<lšux/wÜkqueue.h
>

21 #ià
COMPAT__HAS_DEVLINK


22 
	~<Ãt/devlšk.h
>

25 
	gd’Œy
;

26 
	gdeviû
;

27 
	gpci_dev
;

28 
	g¶©fÜm_deviû
;

30 
	gnå_ýp
;

31 
	gnå_ýp_¬—
;

32 
	gnå_‘h_bË
;

33 
	gnå_hwšfo
;

34 
	gnå_m
;

35 
	gnå_Ãt
;

36 
	gnå_n¥_id’tify
;

37 
	gnå_pÜt
;

38 
	gnå_¹sym
;

39 
	gnå_¹sym_bË
;

40 
	gnå_sh¬ed_buf
;

48 
	snå_dump¥ec
 {

49 
u32
 
	msize
;

50 
u8
 
	md©a
[0];

98 
	snå_pf
 {

99 
pci_dev
 *
	mpdev
;

100 cÚ¡ 
nå_dev_šfo
 *
	mdev_šfo
;

102 
nå_ýp
 *
	mýp
;

104 
nå_­p
 *
	m­p
;

106 
¶©fÜm_deviû
 *
	mnå_dev_ýp
;

107 
¶©fÜm_deviû
 *
	mnå_Ãt_vnic
;

109 
nå_ýp_¬—
 *
	md©a_vnic_b¬
;

110 
nå_ýp_¬—
 *
	mù¾_vnic_b¬
;

111 
nå_ýp_¬—
 *
	mqc_¬—
;

112 
nå_ýp_¬—
 *
	mmac_¡©s_b¬
;

113 
u8
 
__iomem
 *
	mmac_¡©s_mem
;

114 
nå_ýp_¬—
 *
	mvf_cfg_b¬
;

115 
u8
 
__iomem
 *
	mvf_cfg_mem
;

116 
nå_ýp_¬—
 *
	mvfcfg_tbl2_¬—
;

117 
u8
 
__iomem
 *
	mvfcfg_tbl2
;

119 cÚ¡ 
nå_¹sym
 *
	mmbox
;

121 
msix_’Œy
 *
	mœq_’Œ›s
;

123 
msix_’Œy
 
	mmsix
;

125 
	mlim™_vfs
;

126 
	mnum_vfs
;

128 
boÞ
 
	mfw_lßded
;

130 
nå_Ãt
 *
	mù¾_vnic
;

131 
Ãt_deviû
 
__rcu
 *
	mdebug_ù¾_Ãtdev
;

133 cÚ¡ 
nå_m
 *
	mm
;

134 
nå_¹sym_bË
 *
	m¹bl
;

135 
nå_hwšfo
 *
	mhwšfo
;

136 
nå_dump¥ec
 *
	mdump¥ec
;

137 
u32
 
	mdump_æag
;

138 
u32
 
	mdump_Ën
;

139 
nå_‘h_bË
 *
	m‘h_tbl
;

140 
nå_n¥_id’tify
 *
	mn¥i
;

142 
deviû
 *
	mhwmÚ_dev
;

144 
d’Œy
 *
	mddœ
;

146 
	mmax_d©a_vnics
;

147 
	mnum_vnics
;

149 
li¡_h—d
 
	mvnics
;

150 
li¡_h—d
 
	mpÜts
;

152 
wÜkqueue_¡ruù
 *
	mwq
;

153 
wÜk_¡ruù
 
	mpÜt_»äesh_wÜk
;

155 
nå_sh¬ed_buf
 *
	msh¬ed_bufs
;

156 
	mnum_sh¬ed_bufs
;

158 
mu‹x
 
	mlock
;

161 
nå_dev_ýp
;

162 
boÞ
 
nå_Ãt_vnic
;

164 
pci_driv”
 
nå_Ãtvf_pci_driv”
;

166 cÚ¡ 
devlšk_Ýs
 
nå_devlšk_Ýs
;

168 #ifdeà
CONFIG_NFP_NET_PF


169 
nå_Ãt_pci_´obe
(
nå_pf
 *
pf
);

170 
nå_Ãt_pci_»move
(
nå_pf
 *
pf
);

172 
šlše
 
	$nå_Ãt_pci_´obe
(
nå_pf
 *
pf
)

174  -
ENODEV
;

175 
	}
}

177 
šlše
 
	$nå_Ãt_pci_»move
(
nå_pf
 *
pf
)

179 
	}
}

182 
nå_hwmÚ_»gi¡”
(
nå_pf
 *
pf
);

183 
nå_hwmÚ_uÄegi¡”
(
nå_pf
 *
pf
);

186 
nå_Ãt_g‘_mac_addr
(
nå_pf
 *
pf
, 
Ãt_deviû
 *
Ãtdev
,

187 
nå_pÜt
 *
pÜt
);

189 
boÞ
 
nå_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
);

191 
nå_ù¾_debug_¡¬t
(
nå_pf
 *
pf
);

192 
nå_ù¾_debug_¡Ý
(
nå_pf
 *
pf
);

194 
	#NFP_DEV_CPP_TYPE
 "nå-dev-ýp"

	)

196 #ifdeà
CONFIG_NFP_USER_SPACE_CPP


197 
nå_dev_ýp_š™
();

198 
nå_dev_ýp_ex™
();

200 
šlše
 
	$nå_dev_ýp_š™
()

202  -
ENODEV
;

203 
	}
}

205 
šlše
 
	$nå_dev_ýp_ex™
()

207 
	}
}

210 
nå_pf_¹sym_»ad_ÝtiÚ®
(
nå_pf
 *
pf
, cÚ¡ *
fÜm©
,

211 
deçuÉ_v®
);

212 
u8
 
__iomem
 *

213 
nå_pf_m­_¹sym
(
nå_pf
 *
pf
, cÚ¡ *
Çme
, cÚ¡ *
sym_fmt
,

214 
mš_size
, 
nå_ýp_¬—
 **
¬—
);

215 
nå_mbox_cmd
(
nå_pf
 *
pf
, 
u32
 
cmd
, *
š_d©a
, 
u64
 
š_Ëngth
,

216 *
out_d©a
, 
u64
 
out_Ëngth
);

217 
nå_æash_upd©e_commÚ
(
nå_pf
 *
pf
, cÚ¡ *
·th
,

218 
ÃŽšk_ext_ack
 *
exck
);

220 
	enå_dump_dŸg
 {

221 
	mNFP_DUMP_NSP_DIAG
 = 0,

224 
nå_dump¥ec
 *

225 
nå_Ãt_dump_lßd_dump¥ec
(
nå_ýp
 *
ýp
, 
nå_¹sym_bË
 *
¹bl
);

226 
s64
 
nå_Ãt_dump_ÿlcuÏ‹_size
(
nå_pf
 *
pf
, 
nå_dump¥ec
 *
¥ec
,

227 
u32
 
æag
);

228 
nå_Ãt_dump_pÝuÏ‹_bufãr
(
nå_pf
 *
pf
, 
nå_dump¥ec
 *
¥ec
,

229 
‘htoÞ_dump
 *
dump_·¿m
, *
de¡
);

231 #ià
COMPAT__HAS_DEVLINK_SB


232 
nå_sh¬ed_buf_»gi¡”
(
nå_pf
 *
pf
);

233 
nå_sh¬ed_buf_uÄegi¡”
(
nå_pf
 *
pf
);

234 
nå_sh¬ed_buf_poÞ_g‘
(
nå_pf
 *
pf
, 
sb
, 
u16
 
poÞ_šdex
,

235 
devlšk_sb_poÞ_šfo
 *
poÞ_šfo
);

236 
nå_sh¬ed_buf_poÞ_£t
(
nå_pf
 *
pf
, 
sb
,

237 
u16
 
poÞ_šdex
, 
u32
 
size
,

238 
devlšk_sb_th»shÞd_ty³
 
th»shÞd_ty³
);

240 
šlše
 
	$nå_sh¬ed_buf_»gi¡”
(
nå_pf
 *
pf
)

243 
	}
}

245 
šlše
 
	$nå_sh¬ed_buf_uÄegi¡”
(
nå_pf
 *
pf
)

247 
	}
}

	@src/nfp_modinfo.h

10 #iâdeà
__KERNEL__NFP_MODINFO_H__


11 
	#__KERNEL__NFP_MODINFO_H__


	)

13 
	~"nå_bužd_šfo.h
"

15 
	#MODULE_INFO_NFP
() \

16 
	`MODULE_INFO
(
nå_¤c_v”siÚ
, 
NFP_SRC_VERSION
); \

17 
	`MODULE_INFO
(
nå_¤c_·th
, 
NFP_SRC_PATH
); \

18 
	`MODULE_INFO
(
nå_bužd_u£r_id
, 
NFP_BUILD_USER_ID
); \

19 
	`MODULE_INFO
(
nå_bužd_u£r
, 
NFP_BUILD_USER
); \

20 
	`MODULE_INFO
(
nå_bužd_ho¡
, 
NFP_BUILD_HOST
); \

21 
	`MODULE_INFO
(
nå_bužd_·th
, 
NFP_BUILD_PATH
)

	)

23 
	#NFP_BUILD_DESCRIPTION
(
drvÇme
) \

24 #drvÇm" srøv”siÚ: " 
NFP_SRC_VERSION
 "\n" \

25 #drvÇm" srø·th: " 
NFP_SRC_PATH
 "\n" \

26 #drvÇm" bužd u£¸id: " 
NFP_BUILD_USER_ID
 "\n" \

27 #drvÇm" bužd u£r: " 
NFP_BUILD_USER
 "\n" \

28 #drvÇm" bužd ho¡: " 
NFP_BUILD_HOST
 "\n" \

29 #drvÇm" bužd…©h: " 
NFP_BUILD_PATH
 "\n"

	)

	@src/nfp_net.h

12 #iâdeà
_NFP_NET_H_


13 
	#_NFP_NET_H_


	)

15 
	~"nåcÜe/kcom·t.h
"

17 
	~<lšux/š‹¼u±.h
>

18 
	~<lšux/li¡.h
>

19 
	~<lšux/Ãtdeviû.h
>

20 
	~<lšux/pci.h
>

22 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 5, 0)

23 
	~<asm-g’”ic/io-64-nÚ©omic-hi-lo.h
>

25 
	~<lšux/io-64-nÚ©omic-hi-lo.h
>

27 #ià
VER_NON_RHEL_GE
(4, 16è|| 
VER_RHEL_GE
(7, 6)

28 
	~<Ãt/xdp.h
>

31 
	~"nå_Ãt_ù¾.h
"

33 
	#Â_´
(
Â
, 
lvl
, 
fmt
, 
¬gs
...) \

35 
nå_Ãt
 *
__Â
 = (
Â
); \

37 ià(
__Â
->
dp
.
Ãtdev
) \

38 
	`Ãtdev_´štk
(
lvl
, 
__Â
->
dp
.
Ãtdev
, 
fmt
, ## 
¬gs
); \

40 
	`dev_´štk
(
lvl
, 
__Â
->
dp
.
dev
, "ù¾: " 
fmt
, ## 
¬gs
); \

41 })

	)

43 
	#Â_dp_w¬n
(
dp
, 
fmt
, 
¬gs
...) \

45 
nå_Ãt_dp
 *
__dp
 = (
dp
); \

47 ià(
	`uÆik–y
(
	`Ãt_¿‹lim™
())) { \

48 ià(
__dp
->
Ãtdev
) \

49 
	`Ãtdev_w¬n
(
__dp
->
Ãtdev
, 
fmt
, ## 
¬gs
); \

51 
	`dev_w¬n
(
__dp
->
dev
, 
fmt
, ## 
¬gs
); \

53 })

	)

55 
	#Â_”r
(
Â
, 
fmt
, 
¬gs
...è
	`Â_´
Òn, 
KERN_ERR
, fmt, ##‡rgs)

	)

56 
	#Â_w¬n
(
Â
, 
fmt
, 
¬gs
...è
	`Â_´
Òn, 
KERN_WARNING
, fmt, ##‡rgs)

	)

57 
	#Â_šfo
(
Â
, 
fmt
, 
¬gs
...è
	`Â_´
Òn, 
KERN_INFO
, fmt, ##‡rgs)

	)

58 
	#Â_dbg
(
Â
, 
fmt
, 
¬gs
...è
	`Â_´
Òn, 
KERN_DEBUG
, fmt, ##‡rgs)

	)

61 
	#NFP_NET_POLL_TIMEOUT
 5

	)

64 
	#NFP_NET_STAT_POLL_IVL
 
	`m£cs_to_jiff›s
(100)

	)

67 
	#NFP_NET_CTRL_BAR
 0

	)

68 
	#NFP_NET_Q0_BAR
 2

	)

69 
	#NFP_NET_Q1_BAR
 4

	)

72 
	#NFP_NET_DEFAULT_MTU
 1500

	)

75 
	#NFP_NET_MAX_PREPEND
 64

	)

78 
	#NFP_NET_NON_Q_VECTORS
 2

	)

79 
	#NFP_NET_IRQ_LSC_IDX
 0

	)

80 
	#NFP_NET_IRQ_EXN_IDX
 1

	)

81 
	#NFP_NET_MIN_VNIC_IRQS
 (
NFP_NET_NON_Q_VECTORS
 + 1)

	)

84 
	#NFP_NET_MAX_TX_RINGS
 64

	)

85 
	#NFP_NET_MAX_RX_RINGS
 64

	)

86 
	#NFP_NET_MAX_R_VECS
 (
NFP_NET_MAX_TX_RINGS
 > 
NFP_NET_MAX_RX_RINGS
 ? \

87 
NFP_NET_MAX_TX_RINGS
 : 
NFP_NET_MAX_RX_RINGS
)

	)

88 
	#NFP_NET_MAX_IRQS
 (
NFP_NET_NON_Q_VECTORS
 + 
NFP_NET_MAX_R_VECS
)

	)

90 
	#NFP_NET_TX_DESCS_DEFAULT
 4096

	)

91 
	#NFP_NET_RX_DESCS_DEFAULT
 4096

	)

93 
	#NFP_NET_FL_BATCH
 16

	)

94 
	#NFP_NET_XDP_MAX_COMPLETE
 2048

	)

97 
	#NFP_NET_N_VXLAN_PORTS
 (
NFP_NET_CFG_VXLAN_SZ
 / (
__be16
))

	)

99 
	#NFP_NET_RX_BUF_HEADROOM
 (
NET_SKB_PAD
 + 
NET_IP_ALIGN
)

	)

100 
	#NFP_NET_RX_BUF_NON_DATA
 (
NFP_NET_RX_BUF_HEADROOM
 + \

101 
	`SKB_DATA_ALIGN
((
skb_sh¬ed_šfo
)))

	)

104 
	gnå_ýp
;

105 
	gnå_dev_šfo
;

106 
	gnå_dp_Ýs
;

107 
	gnå_‘h_bË_pÜt
;

108 
	gnå_Ãt
;

109 
	gnå_Ãt_r_veùÜ
;

110 
	gnå_pÜt
;

112 
	gnå_nfd3_tx_desc
;

113 
	gnå_nfd3_tx_buf
;

115 
	gnå_nfdk_tx_desc
;

116 
	gnå_nfdk_tx_buf
;

119 
	#D_IDX
(
ršg
, 
idx
è((idxè& (Ôšg)->
út
 - 1))

	)

122 
	#nå_desc_£t_dma_addr_40b
(
desc
, 
dma_addr
) \

124 
dma_addr_t
 
__addr
 = (
dma_addr
); \

125 
	`__ty³of
(
desc
è
__d
 = (desc); \

127 
__d
->
dma_addr_lo
 = 
	`ýu_to_Ë32
(
	`low”_32_b™s
(
__addr
)); \

128 
__d
->
dma_addr_hi
 = 
	`uµ”_32_b™s
(
__addr
) & 0xff; \

129 } 0)

	)

131 
	#nå_desc_£t_dma_addr_48b
(
desc
, 
dma_addr
) \

133 
dma_addr_t
 
__addr
 = (
dma_addr
); \

134 
	`__ty³of
(
desc
è
__d
 = (desc); \

136 
__d
->
dma_addr_hi
 = 
	`ýu_to_Ë16
(
	`uµ”_32_b™s
(
__addr
)); \

137 
__d
->
dma_addr_lo
 = 
	`ýu_to_Ë32
(
	`low”_32_b™s
(
__addr
)); \

138 } 0)

	)

163 
	snå_Ãt_tx_ršg
 {

164 
nå_Ãt_r_veùÜ
 *
	mr_vec
;

166 
u16
 
	midx
;

167 
u16
 
	md©a_³ndšg
;

168 
u8
 
__iomem
 *
	mqý_q
;

169 
u64
 *
	mtxrwb
;

171 
u32
 
	mút
;

172 
u32
 
	mwr_p
;

173 
u32
 
	mrd_p
;

174 
u32
 
	mqý_rd_p
;

176 
u32
 
	mwr_±r_add
;

179 
nå_nfd3_tx_buf
 *
	mtxbufs
;

180 
nå_nfdk_tx_buf
 *
	mktxbufs
;

183 
nå_nfd3_tx_desc
 *
	mtxds
;

184 
nå_nfdk_tx_desc
 *
	mktxds
;

188 
	mqcidx
;

190 
dma_addr_t
 
	mdma
;

191 
size_t
 
	msize
;

192 
boÞ
 
	mis_xdp
;

193 } 
	g____ÿch–še_®igÃd
;

197 
	#PCIE_DESC_RX_DD
 
	`BIT
(7)

	)

198 
	#PCIE_DESC_RX_META_LEN_MASK
 
	`GENMASK
(6, 0)

	)

201 
	#PCIE_DESC_RX_RSS
 
	`ýu_to_Ë16
(
	`BIT
(15))

	)

202 
	#PCIE_DESC_RX_I_IP4_CSUM
 
	`ýu_to_Ë16
(
	`BIT
(14))

	)

203 
	#PCIE_DESC_RX_I_IP4_CSUM_OK
 
	`ýu_to_Ë16
(
	`BIT
(13))

	)

204 
	#PCIE_DESC_RX_I_TCP_CSUM
 
	`ýu_to_Ë16
(
	`BIT
(12))

	)

205 
	#PCIE_DESC_RX_I_TCP_CSUM_OK
 
	`ýu_to_Ë16
(
	`BIT
(11))

	)

206 
	#PCIE_DESC_RX_I_UDP_CSUM
 
	`ýu_to_Ë16
(
	`BIT
(10))

	)

207 
	#PCIE_DESC_RX_I_UDP_CSUM_OK
 
	`ýu_to_Ë16
(
	`BIT
(9))

	)

208 
	#PCIE_DESC_RX_BPF
 
	`ýu_to_Ë16
(
	`BIT
(8))

	)

209 
	#PCIE_DESC_RX_EOP
 
	`ýu_to_Ë16
(
	`BIT
(7))

	)

210 
	#PCIE_DESC_RX_IP4_CSUM
 
	`ýu_to_Ë16
(
	`BIT
(6))

	)

211 
	#PCIE_DESC_RX_IP4_CSUM_OK
 
	`ýu_to_Ë16
(
	`BIT
(5))

	)

212 
	#PCIE_DESC_RX_TCP_CSUM
 
	`ýu_to_Ë16
(
	`BIT
(4))

	)

213 
	#PCIE_DESC_RX_TCP_CSUM_OK
 
	`ýu_to_Ë16
(
	`BIT
(3))

	)

214 
	#PCIE_DESC_RX_UDP_CSUM
 
	`ýu_to_Ë16
(
	`BIT
(2))

	)

215 
	#PCIE_DESC_RX_UDP_CSUM_OK
 
	`ýu_to_Ë16
(
	`BIT
(1))

	)

216 
	#PCIE_DESC_RX_VLAN
 
	`ýu_to_Ë16
(
	`BIT
(0))

	)

218 
	#PCIE_DESC_RX_CSUM_ALL
 (
PCIE_DESC_RX_IP4_CSUM
 | \

219 
PCIE_DESC_RX_TCP_CSUM
 | \

220 
PCIE_DESC_RX_UDP_CSUM
 | \

221 
PCIE_DESC_RX_I_IP4_CSUM
 | \

222 
PCIE_DESC_RX_I_TCP_CSUM
 | \

223 
PCIE_DESC_RX_I_UDP_CSUM
)

	)

224 
	#PCIE_DESC_RX_CSUM_OK_SHIFT
 1

	)

225 
	#__PCIE_DESC_RX_CSUM_ALL
 
	`Ë16_to_ýu
(
PCIE_DESC_RX_CSUM_ALL
)

	)

226 
	#__PCIE_DESC_RX_CSUM_ALL_OK
 (
__PCIE_DESC_RX_CSUM_ALL
 >> \

227 
PCIE_DESC_RX_CSUM_OK_SHIFT
)

	)

229 
	snå_Ãt_rx_desc
 {

232 
__Ë16
 
	mdma_addr_hi
;

233 
u8
 
	m»£rved
;

234 
u8
 
	mm‘a_Ën_dd
;

236 
__Ë32
 
	mdma_addr_lo
;

237 } 
__·cked
 
	mæd
;

240 
__Ë16
 
	md©a_Ën
;

241 
u8
 
	m»£rved
;

242 
u8
 
	mm‘a_Ën_dd
;

246 
__Ë16
 
	mæags
;

247 
__Ë16
 
	mvÏn
;

248 } 
__·cked
 
	mrxd
;

250 
__Ë32
 
	mv®s
[2];

254 
	#NFP_NET_META_FIELD_MASK
 
	`GENMASK
(
NFP_NET_META_FIELD_SIZE
 - 1, 0)

	)

256 
	snå_m‘a_·r£d
 {

257 
u8
 
	mhash_ty³
;

258 
u8
 
	mcsum_ty³
;

259 
u32
 
	mhash
;

260 
u32
 
	mm¬k
;

261 
u32
 
	mpÜtid
;

262 
__wsum
 
	mcsum
;

265 
	snå_Ãt_rx_hash
 {

266 
__be32
 
	mhash_ty³
;

267 
__be32
 
	mhash
;

275 
	snå_Ãt_rx_buf
 {

276 *
	mäag
;

277 
dma_addr_t
 
	mdma_addr
;

295 
	snå_Ãt_rx_ršg
 {

296 
nå_Ãt_r_veùÜ
 *
	mr_vec
;

298 
u32
 
	mút
;

299 
u32
 
	mwr_p
;

300 
u32
 
	mrd_p
;

302 
u32
 
	midx
;

304 
	mæ_qcidx
;

305 
u8
 
__iomem
 *
	mqý_æ
;

307 
nå_Ãt_rx_buf
 *
	mrxbufs
;

308 
nå_Ãt_rx_desc
 *
	mrxds
;

310 
xdp_rxq_šfo
 
	mxdp_rxq
;

312 
dma_addr_t
 
	mdma
;

313 
size_t
 
	msize
;

314 } 
	g____ÿch–še_®igÃd
;

355 
	snå_Ãt_r_veùÜ
 {

356 
nå_Ãt
 *
	mnå_Ãt
;

358 
Çpi_¡ruù
 
	mÇpi
;

360 
skËt_¡ruù
 
	mskËt
;

361 
sk_buff_h—d
 
	mqueue
;

362 
¥šlock
 
	mlock
;

366 
nå_Ãt_tx_ršg
 *
	mtx_ršg
;

367 
nå_Ãt_rx_ršg
 *
	mrx_ršg
;

369 
u16
 
	mœq_’Œy
;

371 
u64_¡©s_sync
 
	mrx_sync
;

372 
u64
 
	mrx_pkts
;

373 
u64
 
	mrx_by‹s
;

374 
u64
 
	mrx_drÝs
;

375 
u64
 
	mhw_csum_rx_ok
;

376 
u64
 
	mhw_csum_rx_šÃr_ok
;

377 
u64
 
	mhw_csum_rx_com¶‘e
;

379 
nå_Ãt_tx_ršg
 *
	mxdp_ršg
;

381 
u64_¡©s_sync
 
	mtx_sync
;

382 
u64
 
	mtx_pkts
;

383 
u64
 
	mtx_by‹s
;

384 
u64
 
	mhw_csum_tx
;

385 
u64
 
	mhw_csum_tx_šÃr
;

386 
u64
 
	mtx_g©h”
;

387 
u64
 
	mtx_lso
;

389 
u64
 
	mhw_csum_rx_”rÜ
;

390 
u64
 
	mrx_»¶aû_buf_®loc_çž
;

391 
u64
 
	mtx_”rÜs
;

392 
u64
 
	mtx_busy
;

394 
u32
 
	mœq_veùÜ
;

395 
œq_hªdËr_t
 
	mhªdËr
;

396 
	mÇme
[
IFNAMSIZ
 + 8];

397 
ýumask_t
 
	maffš™y_mask
;

398 } 
	g____ÿch–še_®igÃd
;

401 
	snå_Ãt_fw_v”siÚ
 {

402 
u8
 
	mmšÜ
;

403 
u8
 
	mmajÜ
;

404 
u8
 
	mþass
;

405 
u8
 
	mdp_»sv
;

406 } 
	g__·cked
;

408 
šlše
 
boÞ
 
	$nå_Ãt_fw_v”_eq
(
nå_Ãt_fw_v”siÚ
 *
fw_v”
,

409 
u8
 
dp_»sv
, u8 
þass
, u8 
majÜ
, u8 
mšÜ
)

411  
fw_v”
->
dp_»sv
 == dp_resv &&

412 
fw_v”
->
þass
 == class &&

413 
fw_v”
->
majÜ
 == major &&

414 
fw_v”
->
mšÜ
 == minor;

415 
	}
}

417 
	snå_¡©_·œ
 {

418 
u64
 
	mpkts
;

419 
u64
 
	mby‹s
;

449 
	snå_Ãt_dp
 {

450 
deviû
 *
	mdev
;

451 
Ãt_deviû
 *
	mÃtdev
;

453 
u8
 
	mis_vf
:1;

454 
u8
 
	mchašed_m‘ad©a_fÜm©
:1;

456 
u8
 
	mrx_dma_dœ
;

457 
u8
 
	mrx_off£t
;

459 
u32
 
	mrx_dma_off
;

461 
u32
 
	mù¾
;

462 
u32
 
	mæ_bufsz
;

464 
bpf_´og
 *
	mxdp_´og
;

466 
nå_Ãt_tx_ršg
 *
	mtx_ršgs
;

467 
nå_Ãt_rx_ršg
 *
	mrx_ršgs
;

469 
u8
 
__iomem
 *
	mù¾_b¬
;

473 cÚ¡ 
nå_dp_Ýs
 *
	mÝs
;

475 
u64
 *
	mtxrwb
;

476 
dma_addr_t
 
	mtxrwb_dma
;

478 
	mtxd_út
;

479 
	mrxd_út
;

481 
	mnum_r_vecs
;

483 
	mnum_tx_ršgs
;

484 
	mnum_¡ack_tx_ršgs
;

485 
	mnum_rx_ršgs
;

487 
	mmtu
;

545 
	snå_Ãt
 {

546 
nå_Ãt_dp
 
	mdp
;

548 cÚ¡ 
nå_dev_šfo
 *
	mdev_šfo
;

549 
nå_Ãt_fw_v”siÚ
 
	mfw_v”
;

551 
u32
 
	mid
;

553 
u32
 
	mÿp
;

554 
u32
 
	mmax_mtu
;

556 
u8
 
	mrss_hfunc
;

557 
u32
 
	mrss_cfg
;

558 
u8
 
	mrss_key
[
NFP_NET_CFG_RSS_KEY_SZ
];

559 
u8
 
	mrss_™bl
[
NFP_NET_CFG_RSS_ITBL_SZ
];

561 
xdp_©chm’t_šfo
 
	mxdp
;

562 
xdp_©chm’t_šfo
 
	mxdp_hw
;

564 
	mmax_tx_ršgs
;

565 
	mmax_rx_ršgs
;

567 
	m¡ride_tx
;

568 
	m¡ride_rx
;

570 
	mmax_r_vecs
;

571 
nå_Ãt_r_veùÜ
 
	mr_vecs
[
NFP_NET_MAX_R_VECS
];

572 
msix_’Œy
 
	mœq_’Œ›s
[
NFP_NET_MAX_IRQS
];

574 
œq_hªdËr_t
 
	mlsc_hªdËr
;

575 
	mlsc_Çme
[
IFNAMSIZ
 + 8];

577 
œq_hªdËr_t
 
	mexn_hªdËr
;

578 
	mexn_Çme
[
IFNAMSIZ
 + 8];

580 
œq_hªdËr_t
 
	msh¬ed_hªdËr
;

581 
	msh¬ed_Çme
[
IFNAMSIZ
 + 8];

583 
u32
 
	mme_äeq_mhz
;

585 
boÞ
 
	mlšk_up
;

586 
¥šlock_t
 
	mlšk_¡©us_lock
;

588 
¥šlock_t
 
	m»cÚfig_lock
;

589 
u32
 
	m»cÚfig_po¡ed
;

590 
boÞ
 
	m»cÚfig_tim”_aùive
;

591 
boÞ
 
	m»cÚfig_sync_´e£Á
;

592 
tim”_li¡
 
	m»cÚfig_tim”
;

593 
u32
 
	m»cÚfig_š_´og»ss_upd©e
;

595 
u32
 
	mrx_cßËsû_u£cs
;

596 
u32
 
	mrx_cßËsû_max_äames
;

597 
u32
 
	mtx_cßËsû_u£cs
;

598 
u32
 
	mtx_cßËsû_max_äames
;

600 
__be16
 
	mvxÏn_pÜts
[
NFP_NET_N_VXLAN_PORTS
];

601 
u8
 
	mvxÏn_u£út
[
NFP_NET_N_VXLAN_PORTS
];

603 
u8
 
__iomem
 *
	mqý_cfg
;

605 
u8
 
__iomem
 *
	mtx_b¬
;

606 
u8
 
__iomem
 *
	mrx_b¬
;

608 
nå_Ãt_Žv_ÿps
 
	mŽv_ÿps
;

610 
d’Œy
 *
	mdebugfs_dœ
;

612 
li¡_h—d
 
	mvnic_li¡
;

614 
pci_dev
 *
	mpdev
;

615 
nå_­p
 *
	m­p
;

617 
boÞ
 
	mvnic_no_Çme
;

619 
nå_pÜt
 *
	mpÜt
;

621 *
	m­p_´iv
;

627 
šlše
 
u16
 
	$Â_»adb
(
nå_Ãt
 *
Â
, 
off
)

629  
	`»adb
(
Â
->
dp
.
ù¾_b¬
 + 
off
);

630 
	}
}

632 
šlše
 
	$Â_wr™eb
(
nå_Ãt
 *
Â
, 
off
, 
u8
 
v®
)

634 
	`wr™eb
(
v®
, 
Â
->
dp
.
ù¾_b¬
 + 
off
);

635 
	}
}

637 
šlše
 
u16
 
	$Â_»adw
(
nå_Ãt
 *
Â
, 
off
)

639  
	`»adw
(
Â
->
dp
.
ù¾_b¬
 + 
off
);

640 
	}
}

642 
šlše
 
	$Â_wr™ew
(
nå_Ãt
 *
Â
, 
off
, 
u16
 
v®
)

644 
	`wr™ew
(
v®
, 
Â
->
dp
.
ù¾_b¬
 + 
off
);

645 
	}
}

647 
šlše
 
u32
 
	$Â_»adl
(
nå_Ãt
 *
Â
, 
off
)

649  
	`»adl
(
Â
->
dp
.
ù¾_b¬
 + 
off
);

650 
	}
}

652 
šlše
 
	$Â_wr™–
(
nå_Ãt
 *
Â
, 
off
, 
u32
 
v®
)

654 
	`wr™–
(
v®
, 
Â
->
dp
.
ù¾_b¬
 + 
off
);

655 
	}
}

657 
šlše
 
u64
 
	$Â_»adq
(
nå_Ãt
 *
Â
, 
off
)

659  
	`»adq
(
Â
->
dp
.
ù¾_b¬
 + 
off
);

660 
	}
}

662 
šlše
 
	$Â_wr™eq
(
nå_Ãt
 *
Â
, 
off
, 
u64
 
v®
)

664 
	`wr™eq
(
v®
, 
Â
->
dp
.
ù¾_b¬
 + 
off
);

665 
	}
}

668 
šlše
 
	$Â_pci_æush
(
nå_Ãt
 *
Â
)

670 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_VERSION
);

671 
	}
}

682 
	#NFP_QCP_QUEUE_ADDR_SZ
 0x800

	)

683 
	#NFP_QCP_QUEUE_OFF
(
_x
è((_xè* 
NFP_QCP_QUEUE_ADDR_SZ
)

	)

684 
	#NFP_QCP_QUEUE_ADD_RPTR
 0x0000

	)

685 
	#NFP_QCP_QUEUE_ADD_WPTR
 0x0004

	)

686 
	#NFP_QCP_QUEUE_STS_LO
 0x0008

	)

687 
	#NFP_QCP_QUEUE_STS_LO_READPTR_mask
 0x3ffff

	)

688 
	#NFP_QCP_QUEUE_STS_HI
 0x000c

	)

689 
	#NFP_QCP_QUEUE_STS_HI_WRITEPTR_mask
 0x3ffff

	)

692 
	enå_qý_±r
 {

693 
	mNFP_QCP_READ_PTR
 = 0,

694 
	mNFP_QCP_WRITE_PTR


703 
šlše
 
	$nå_qý_rd_±r_add
(
u8
 
__iomem
 *
q
, 
u32
 
v®
)

705 
	`wr™–
(
v®
, 
q
 + 
NFP_QCP_QUEUE_ADD_RPTR
);

706 
	}
}

714 
šlše
 
	$nå_qý_wr_±r_add
(
u8
 
__iomem
 *
q
, 
u32
 
v®
)

716 
	`wr™–
(
v®
, 
q
 + 
NFP_QCP_QUEUE_ADD_WPTR
);

717 
	}
}

719 
šlše
 
u32
 
	$_nå_qý_»ad
(
u8
 
__iomem
 *
q
, 
nå_qý_±r
 
±r
)

721 
u32
 
off
;

722 
u32
 
v®
;

724 ià(
±r
 =ð
NFP_QCP_READ_PTR
)

725 
off
 = 
NFP_QCP_QUEUE_STS_LO
;

727 
off
 = 
NFP_QCP_QUEUE_STS_HI
;

729 
v®
 = 
	`»adl
(
q
 + 
off
);

731 ià(
±r
 =ð
NFP_QCP_READ_PTR
)

732  
v®
 & 
NFP_QCP_QUEUE_STS_LO_READPTR_mask
;

734  
v®
 & 
NFP_QCP_QUEUE_STS_HI_WRITEPTR_mask
;

735 
	}
}

743 
šlše
 
u32
 
	$nå_qý_rd_±r_»ad
(
u8
 
__iomem
 *
q
)

745  
	`_nå_qý_»ad
(
q
, 
NFP_QCP_READ_PTR
);

746 
	}
}

754 
šlše
 
u32
 
	$nå_qý_wr_±r_»ad
(
u8
 
__iomem
 *
q
)

756  
	`_nå_qý_»ad
(
q
, 
NFP_QCP_WRITE_PTR
);

757 
	}
}

759 
u32
 
nå_qý_queue_off£t
(cÚ¡ 
nå_dev_šfo
 *
dev_šfo
, 
u16
 
queue
);

761 
šlše
 
boÞ
 
	$nå_Ãt_is_d©a_vnic
(
nå_Ãt
 *
Â
)

763 
	`WARN_ON_ONCE
(!
Â
->
dp
.
Ãtdev
 &&‚n->
pÜt
);

764  !!
Â
->
dp
.
Ãtdev
;

765 
	}
}

767 
šlše
 
boÞ
 
	$nå_Ãt_ruÂšg
(
nå_Ãt
 *
Â
)

769  
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_ENABLE
;

770 
	}
}

772 
šlše
 cÚ¡ *
	$nå_Ãt_Çme
(
nå_Ãt
 *
Â
)

774  
Â
->
dp
.
Ãtdev
 ?‚n->dp.Ãtdev->
Çme
 : "ctrl";

775 
	}
}

777 
šlše
 
	$nå_ù¾_lock
(
nå_Ãt
 *
Â
)

778 
	`__acquœes
(&
Â
->
r_vecs
[0].
lock
)

780 
	`¥š_lock_bh
(&
Â
->
r_vecs
[0].
lock
);

781 
	}
}

783 
šlše
 
	$nå_ù¾_uÆock
(
nå_Ãt
 *
Â
)

784 
	`__»Ëa£s
(&
Â
->
r_vecs
[0].
lock
)

786 
	`¥š_uÆock_bh
(&
Â
->
r_vecs
[0].
lock
);

787 
	}
}

790 cÚ¡ 
nå_driv”_v”siÚ
[];

792 cÚ¡ 
Ãt_deviû_Ýs
 
nå_nfd3_Ãtdev_Ýs
;

793 cÚ¡ 
Ãt_deviû_Ýs
 
nå_nfdk_Ãtdev_Ýs
;

795 
šlše
 
boÞ
 
	$nå_Ãtdev_is_nå_Ãt
(
Ãt_deviû
 *
Ãtdev
)

797  
Ãtdev
->
Ãtdev_Ýs
 =ð&
nå_nfd3_Ãtdev_Ýs
 ||

798 
Ãtdev
->
Ãtdev_Ýs
 =ð&
nå_nfdk_Ãtdev_Ýs
;

799 
	}
}

802 
nå_Ãt_g‘_fw_v”siÚ
(
nå_Ãt_fw_v”siÚ
 *
fw_v”
,

803 
__iomem
 *
ù¾_b¬
);

805 
nå_Ãt
 *

806 
nå_Ãt_®loc
(
pci_dev
 *
pdev
, cÚ¡ 
nå_dev_šfo
 *
dev_šfo
,

807 
__iomem
 *
ù¾_b¬
, 
boÞ
 
Ãeds_Ãtdev
,

808 
max_tx_ršgs
, 
max_rx_ršgs
);

809 
nå_Ãt_ä“
(
nå_Ãt
 *
Â
);

811 
nå_Ãt_š™
(
nå_Ãt
 *
Â
);

812 
nå_Ãt_þ—n
(
nå_Ãt
 *
Â
);

814 
nå_ù¾_Ý’
(
nå_Ãt
 *
Â
);

815 
nå_ù¾_þo£
(
nå_Ãt
 *
Â
);

817 
nå_Ãt_£t_‘htoÞ_Ýs
(
Ãt_deviû
 *
Ãtdev
);

818 
nå_Ãt_šfo
(
nå_Ãt
 *
Â
);

819 
nå_Ãt_»cÚfig
(
nå_Ãt
 *
Â
, 
u32
 
upd©e
);

820 
nå_Ãt_rss_key_sz
(
nå_Ãt
 *
Â
);

821 
nå_Ãt_rss_wr™e_™bl
(
nå_Ãt
 *
Â
);

822 
nå_Ãt_rss_wr™e_key
(
nå_Ãt
 *
Â
);

823 
nå_Ãt_cßËsû_wr™e_cfg
(
nå_Ãt
 *
Â
);

824 
nå_Ãt_»cÚfig_mbox
(
nå_Ãt
 *
Â
, 
u32
 
mbox_cmd
);

827 
nå_Ãt_œqs_®loc
(
pci_dev
 *
pdev
, 
msix_’Œy
 *
œq_’Œ›s
,

828 
mš_œqs
, 
wªt_œqs
);

829 
nå_Ãt_œqs_di§bË
(
pci_dev
 *
pdev
);

831 
nå_Ãt_œqs_assign
(
nå_Ãt
 *
Â
, 
msix_’Œy
 *
œq_’Œ›s
,

832 
n
);

834 
nå_Ãt_dp
 *
nå_Ãt_þÚe_dp
(
nå_Ãt
 *
Â
);

835 
nå_Ãt_ršg_»cÚfig
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
Ãw
,

836 
ÃŽšk_ext_ack
 *
exck
);

838 #ifdeà
CONFIG_NFP_DEBUG


839 
nå_Ãt_debugfs_ü—‹
();

840 
nå_Ãt_debugfs_de¡roy
();

841 
d’Œy
 *
nå_Ãt_debugfs_deviû_add
(
pci_dev
 *
pdev
);

842 
nå_Ãt_debugfs_vnic_add
(
nå_Ãt
 *
Â
, 
d’Œy
 *
ddœ
);

843 
nå_Ãt_debugfs_dœ_þ—n
(
d’Œy
 **
dœ
);

845 
šlše
 
	$nå_Ãt_debugfs_ü—‹
()

847 
	}
}

849 
šlše
 
	$nå_Ãt_debugfs_de¡roy
()

851 
	}
}

853 
šlše
 
d’Œy
 *
	$nå_Ãt_debugfs_deviû_add
(
pci_dev
 *
pdev
)

855  
NULL
;

856 
	}
}

858 
šlše
 

859 
	$nå_Ãt_debugfs_vnic_add
(
nå_Ãt
 *
Â
, 
d’Œy
 *
ddœ
)

861 
	}
}

863 
šlše
 
	$nå_Ãt_debugfs_dœ_þ—n
(
d’Œy
 **
dœ
)

865 
	}
}

	@src/nfp_net_common.c

13 
	~"nå_Ãt_com·t.h
"

15 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

16 
	~<lšux/b™f›ld.h
>

18 #ià
COMPAT__HAVE_XDP


19 
	~<lšux/bpf.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/š™.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/Ãtdeviû.h
>

26 
	~<lšux/‘h”deviû.h
>

27 
	~<lšux/š‹¼u±.h
>

28 
	~<lšux/.h
>

29 
	~<lšux/v6.h
>

30 
	~<lšux/mm.h
>

31 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 18, 0)

32 
	~<lšux/ov”æow.h
>

34 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 6, 0)

35 
	~<lšux/·ge_»f.h
>

37 
	~<lšux/pci.h
>

38 
	~<lšux/pci_»gs.h
>

39 
	~<lšux/msi.h
>

40 
	~<lšux/‘htoÞ.h
>

41 
	~<lšux/log2.h
>

42 
	~<lšux/if_vÏn.h
>

43 
	~<lšux/¿ndom.h
>

44 
	~<lšux/vm®loc.h
>

45 
	~<lšux/ktime.h
>

47 #ià
COMPAT__HAVE_VXLAN_OFFLOAD


48 
	~<Ãt/vxÏn.h
>

51 
	~"nåcÜe/nå_dev.h
"

52 
	~"nåcÜe/nå_n¥.h
"

53 
	~"nå_­p.h
"

54 
	~"nå_Ãt_ù¾.h
"

55 
	~"nå_Ãt.h
"

56 
	~"nå_Ãt_dp.h
"

57 
	~"nå_Ãt_¤iov.h
"

58 
	~"nå_pÜt.h
"

65 
	$nå_Ãt_g‘_fw_v”siÚ
(
nå_Ãt_fw_v”siÚ
 *
fw_v”
,

66 
__iomem
 *
ù¾_b¬
)

68 
u32
 
»g
;

70 
»g
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_VERSION
);

71 
	`put_uÇligÃd_Ë32
(
»g
, 
fw_v”
);

72 
	}
}

74 
u32
 
	$nå_qý_queue_off£t
(cÚ¡ 
nå_dev_šfo
 *
dev_šfo
, 
u16
 
queue
)

76 
queue
 &ð
dev_šfo
->
qc_idx_mask
;

77  
dev_šfo
->
qc_addr_off£t
 + 
NFP_QCP_QUEUE_ADDR_SZ
 * 
queue
;

78 
	}
}

86 
	$nå_Ãt_»cÚfig_¡¬t
(
nå_Ãt
 *
Â
, 
u32
 
upd©e
)

88 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_UPDATE
, 
upd©e
);

90 
	`Â_pci_æush
(
Â
);

91 
	`nå_qý_wr_±r_add
(
Â
->
qý_cfg
, 1);

92 
Â
->
»cÚfig_š_´og»ss_upd©e
 = 
upd©e
;

93 
	}
}

96 
	$nå_Ãt_»cÚfig_¡¬t_async
(
nå_Ãt
 *
Â
, 
u32
 
upd©e
)

98 
upd©e
 |ð
Â
->
»cÚfig_po¡ed
;

99 
Â
->
»cÚfig_po¡ed
 = 0;

101 
	`nå_Ãt_»cÚfig_¡¬t
(
Â
, 
upd©e
);

103 
Â
->
»cÚfig_tim”_aùive
 = 
Œue
;

104 
	`mod_tim”
(&
Â
->
»cÚfig_tim”
, 
jiff›s
 + 
NFP_NET_POLL_TIMEOUT
 * 
HZ
);

105 
	}
}

107 
boÞ
 
	$nå_Ãt_»cÚfig_check_dÚe
(
nå_Ãt
 *
Â
, 
boÞ
 
Ï¡_check
)

109 
u32
 
»g
;

111 
»g
 = 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_UPDATE
);

112 ià(
»g
 == 0)

113  
Œue
;

114 ià(
»g
 & 
NFP_NET_CFG_UPDATE_ERR
) {

115 
	`Â_”r
(
Â
, "Reconfigƒrror (status: 0x%08x update: 0x%08x ctrl: 0x%08x)\n",

116 
»g
, 
Â
->
»cÚfig_š_´og»ss_upd©e
,

117 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_CTRL
));

118  
Œue
;

119 } ià(
Ï¡_check
) {

120 
	`Â_”r
(
Â
, "Reconfigimeout (status: 0x%08x update: 0x%08x ctrl: 0x%08x)\n",

121 
»g
, 
Â
->
»cÚfig_š_´og»ss_upd©e
,

122 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_CTRL
));

123  
Œue
;

126  
çl£
;

127 
	}
}

129 
	$nå_Ãt_»cÚfig_wa™
(
nå_Ãt
 *
Â
, 
d—dlše
)

131 
boÞ
 
timed_out
 = 
çl£
;

134 !
	`nå_Ãt_»cÚfig_check_dÚe
(
Â
, 
timed_out
)) {

135 
	`m¦“p
(1);

136 
timed_out
 = 
	`time_is_befÜe_eq_jiff›s
(
d—dlše
);

139 ià(
	`Â_»adl
(
Â
, 
NFP_NET_CFG_UPDATE
è& 
NFP_NET_CFG_UPDATE_ERR
)

140  -
EIO
;

142  
timed_out
 ? -
EIO
 : 0;

143 
	}
}

145 #ià
VER_NON_RHEL_LT
(4, 14è|| 
VER_RHEL_LT
(7, 6)

146 
	$nå_Ãt_»cÚfig_tim”
(
t
)

148 
	$nå_Ãt_»cÚfig_tim”
(
tim”_li¡
 *
t
)

151 
nå_Ãt
 *
Â
 = 
	`äom_tim”
Òn, 
t
, 
»cÚfig_tim”
);

153 
	`¥š_lock_bh
(&
Â
->
»cÚfig_lock
);

155 
Â
->
»cÚfig_tim”_aùive
 = 
çl£
;

158 ià(
Â
->
»cÚfig_sync_´e£Á
)

159 
dÚe
;

162 
	`nå_Ãt_»cÚfig_check_dÚe
(
Â
, 
Œue
);

164 ià(
Â
->
»cÚfig_po¡ed
)

165 
	`nå_Ãt_»cÚfig_¡¬t_async
(
Â
, 0);

166 
dÚe
:

167 
	`¥š_uÆock_bh
(&
Â
->
»cÚfig_lock
);

168 
	}
}

179 
	$nå_Ãt_»cÚfig_po¡
(
nå_Ãt
 *
Â
, 
u32
 
upd©e
)

181 
	`¥š_lock_bh
(&
Â
->
»cÚfig_lock
);

184 ià(
Â
->
»cÚfig_sync_´e£Á
) {

185 
Â
->
»cÚfig_po¡ed
 |ð
upd©e
;

186 
dÚe
;

190 ià(!
Â
->
»cÚfig_tim”_aùive
 ||

191 
	`nå_Ãt_»cÚfig_check_dÚe
(
Â
, 
çl£
))

192 
	`nå_Ãt_»cÚfig_¡¬t_async
(
Â
, 
upd©e
);

194 
Â
->
»cÚfig_po¡ed
 |ð
upd©e
;

195 
dÚe
:

196 
	`¥š_uÆock_bh
(&
Â
->
»cÚfig_lock
);

197 
	}
}

199 
	$nå_Ãt_»cÚfig_sync_’‹r
(
nå_Ãt
 *
Â
)

201 
boÞ
 
ÿnûÎed_tim”
 = 
çl£
;

202 
u32
 
´e_po¡ed_»que¡s
;

204 
	`¥š_lock_bh
(&
Â
->
»cÚfig_lock
);

206 
Â
->
»cÚfig_sync_´e£Á
 = 
Œue
;

208 ià(
Â
->
»cÚfig_tim”_aùive
) {

209 
Â
->
»cÚfig_tim”_aùive
 = 
çl£
;

210 
ÿnûÎed_tim”
 = 
Œue
;

212 
´e_po¡ed_»que¡s
 = 
Â
->
»cÚfig_po¡ed
;

213 
Â
->
»cÚfig_po¡ed
 = 0;

215 
	`¥š_uÆock_bh
(&
Â
->
»cÚfig_lock
);

217 ià(
ÿnûÎed_tim”
) {

218 
	`d–_tim”_sync
(&
Â
->
»cÚfig_tim”
);

219 
	`nå_Ãt_»cÚfig_wa™
(
Â
,‚n->
»cÚfig_tim”
.
expœes
);

223 ià(
´e_po¡ed_»que¡s
) {

224 
	`nå_Ãt_»cÚfig_¡¬t
(
Â
, 
´e_po¡ed_»que¡s
);

225 
	`nå_Ãt_»cÚfig_wa™
(
Â
, 
jiff›s
 + 
HZ
 * 
NFP_NET_POLL_TIMEOUT
);

227 
	}
}

229 
	$nå_Ãt_»cÚfig_wa™_po¡ed
(
nå_Ãt
 *
Â
)

231 
	`nå_Ãt_»cÚfig_sync_’‹r
(
Â
);

233 
	`¥š_lock_bh
(&
Â
->
»cÚfig_lock
);

234 
Â
->
»cÚfig_sync_´e£Á
 = 
çl£
;

235 
	`¥š_uÆock_bh
(&
Â
->
»cÚfig_lock
);

236 
	}
}

249 
	$nå_Ãt_»cÚfig
(
nå_Ãt
 *
Â
, 
u32
 
upd©e
)

251 
»t
;

253 
	`nå_Ãt_»cÚfig_sync_’‹r
(
Â
);

255 
	`nå_Ãt_»cÚfig_¡¬t
(
Â
, 
upd©e
);

256 
»t
 = 
	`nå_Ãt_»cÚfig_wa™
(
Â
, 
jiff›s
 + 
HZ
 * 
NFP_NET_POLL_TIMEOUT
);

258 
	`¥š_lock_bh
(&
Â
->
»cÚfig_lock
);

260 ià(
Â
->
»cÚfig_po¡ed
)

261 
	`nå_Ãt_»cÚfig_¡¬t_async
(
Â
, 0);

263 
Â
->
»cÚfig_sync_´e£Á
 = 
çl£
;

265 
	`¥š_uÆock_bh
(&
Â
->
»cÚfig_lock
);

267  
»t
;

268 
	}
}

279 
	$nå_Ãt_»cÚfig_mbox
(
nå_Ãt
 *
Â
, 
u32
 
mbox_cmd
)

281 
u32
 
mbox
 = 
Â
->
Žv_ÿps
.
mbox_off
;

282 
»t
;

284 ià(!
	`nå_Ãt_has_mbox
(&
Â
->
Žv_ÿps
)) {

285 
	`Â_”r
(
Â
, "nØmažbox…»£Á, commªd: %u\n", 
mbox_cmd
);

286  -
EIO
;

289 
	`Â_wr™eq
(
Â
, 
mbox
 + 
NFP_NET_CFG_MBOX_SIMPLE_CMD
, 
mbox_cmd
);

291 
»t
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_MBOX
);

292 ià(
»t
) {

293 
	`Â_”r
(
Â
, "Mailbox updateƒrror\n");

294  
»t
;

297  -
	`Â_»adl
(
Â
, 
mbox
 + 
NFP_NET_CFG_MBOX_SIMPLE_RET
);

298 
	}
}

313 
	$nå_Ãt_œqs_®loc
(
pci_dev
 *
pdev
, 
msix_’Œy
 *
œq_’Œ›s
,

314 
mš_œqs
, 
wª‹d_œqs
)

316 
i
;

317 
gÙ_œqs
;

319 
i
 = 0; i < 
wª‹d_œqs
; i++)

320 
œq_’Œ›s
[
i
].
’Œy
 = i;

322 
gÙ_œqs
 = 
	`pci_’abË_msix_¿nge
(
pdev
, 
œq_’Œ›s
,

323 
mš_œqs
, 
wª‹d_œqs
);

324 ià(
gÙ_œqs
 < 0) {

325 
	`dev_”r
(&
pdev
->
dev
, "Failedoƒnable %d-%d MSI-X (err=%d)\n",

326 
mš_œqs
, 
wª‹d_œqs
, 
gÙ_œqs
);

330 ià(
gÙ_œqs
 < 
wª‹d_œqs
)

331 
	`dev_w¬n
(&
pdev
->
dev
, "Unableo‡llocate %d IRQs got only %d\n",

332 
wª‹d_œqs
, 
gÙ_œqs
);

334  
gÙ_œqs
;

335 
	}
}

347 
	$nå_Ãt_œqs_assign
(
nå_Ãt
 *
Â
, 
msix_’Œy
 *
œq_’Œ›s
,

348 
n
)

350 
nå_Ãt_dp
 *
dp
 = &
Â
->dp;

352 
Â
->
max_r_vecs
 = 
n
 - 
NFP_NET_NON_Q_VECTORS
;

353 
dp
->
num_r_vecs
 = 
Â
->
max_r_vecs
;

355 
	`memýy
(
Â
->
œq_’Œ›s
, irq_’Œ›s, (*œq_’Œ›sè* 
n
);

357 ià(
dp
->
num_rx_ršgs
 > dp->
num_r_vecs
 ||

358 
dp
->
num_tx_ršgs
 > dp->
num_r_vecs
)

359 
	`dev_w¬n
(
Â
->
dp
.
dev
, "More„ings (%d,%d)han vectors (%d).\n",

360 
dp
->
num_rx_ršgs
, dp->
num_tx_ršgs
,

361 
dp
->
num_r_vecs
);

363 
dp
->
num_rx_ršgs
 = 
	`mš
(dp->
num_r_vecs
, dp->num_rx_rings);

364 
dp
->
num_tx_ršgs
 = 
	`mš
(dp->
num_r_vecs
, dp->num_tx_rings);

365 
dp
->
num_¡ack_tx_ršgs
 = dp->
num_tx_ršgs
;

366 
	}
}

374 
	$nå_Ãt_œqs_di§bË
(
pci_dev
 *
pdev
)

376 
	`pci_di§bË_msix
(
pdev
);

377 
	}
}

386 
œq»tuº_t
 
	$nå_Ãt_œq_rxtx
(
œq
, *
d©a
)

388 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
d©a
;

390 
	`Çpi_scheduË_œqoff
(&
r_vec
->
Çpi
);

396  
IRQ_HANDLED
;

397 
	}
}

399 
œq»tuº_t
 
	$nå_ù¾_œq_rxtx
(
œq
, *
d©a
)

401 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
d©a
;

403 
	`skËt_scheduË
(&
r_vec
->
skËt
);

405  
IRQ_HANDLED
;

406 
	}
}

412 
	$nå_Ãt_»ad_lšk_¡©us
(
nå_Ãt
 *
Â
)

414 
æags
;

415 
boÞ
 
lšk_up
;

416 
u32
 
¡s
;

418 
	`¥š_lock_œq§ve
(&
Â
->
lšk_¡©us_lock
, 
æags
);

420 
¡s
 = 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_STS
);

421 
lšk_up
 = !!(
¡s
 & 
NFP_NET_CFG_STS_LINK
);

423 ià(
Â
->
lšk_up
 ==†ink_up)

424 
out
;

426 
Â
->
lšk_up
 =†ink_up;

427 ià(
Â
->
pÜt
)

428 
	`£t_b™
(
NFP_PORT_CHANGED
, &
Â
->
pÜt
->
æags
);

430 ià(
Â
->
lšk_up
) {

431 
	`Ãtif_ÿ¼›r_Ú
(
Â
->
dp
.
Ãtdev
);

432 
	`Ãtdev_šfo
(
Â
->
dp
.
Ãtdev
, "NIC Link is Up\n");

434 
	`Ãtif_ÿ¼›r_off
(
Â
->
dp
.
Ãtdev
);

435 
	`Ãtdev_šfo
(
Â
->
dp
.
Ãtdev
, "NIC Link is Down\n");

437 
out
:

438 
	`¥š_uÆock_œq»¡Üe
(&
Â
->
lšk_¡©us_lock
, 
æags
);

439 
	}
}

448 
œq»tuº_t
 
	$nå_Ãt_œq_lsc
(
œq
, *
d©a
)

450 
nå_Ãt
 *
Â
 = 
d©a
;

451 
msix_’Œy
 *
’Œy
;

453 
’Œy
 = &
Â
->
œq_’Œ›s
[
NFP_NET_IRQ_LSC_IDX
];

455 
	`nå_Ãt_»ad_lšk_¡©us
(
Â
);

457 
	`nå_Ãt_œq_unmask
(
Â
, 
’Œy
->entry);

459  
IRQ_HANDLED
;

460 
	}
}

469 
œq»tuº_t
 
	$nå_Ãt_œq_exn
(
œq
, *
d©a
)

471 
nå_Ãt
 *
Â
 = 
d©a
;

473 
	`Â_”r
(
Â
, "%s: UNIMPLEMENTED.\n", 
__func__
);

475  
IRQ_HANDLED
;

476 
	}
}

489 
	$nå_Ãt_aux_œq_»que¡
(
nå_Ãt
 *
Â
, 
u32
 
ù¾_off£t
,

490 cÚ¡ *
fÜm©
, *
Çme
, 
size_t
 
Çme_sz
,

491 
veùÜ_idx
, 
œq_hªdËr_t
 
hªdËr
)

493 
msix_’Œy
 *
’Œy
;

494 
”r
;

496 
’Œy
 = &
Â
->
œq_’Œ›s
[
veùÜ_idx
];

498 
	`¢´štf
(
Çme
, 
Çme_sz
, 
fÜm©
, 
	`nå_Ãt_Çme
(
Â
));

499 
”r
 = 
	`»que¡_œq
(
’Œy
->
veùÜ
, 
hªdËr
, 0, 
Çme
, 
Â
);

500 ià(
”r
) {

501 
	`Â_”r
(
Â
, "Failedo„equest IRQ %d (err=%d).\n",

502 
’Œy
->
veùÜ
, 
”r
);

503  
”r
;

505 
	`Â_wr™eb
(
Â
, 
ù¾_off£t
, 
’Œy
->entry);

506 
	`nå_Ãt_œq_unmask
(
Â
, 
’Œy
->entry);

509 
	}
}

517 
	$nå_Ãt_aux_œq_ä“
(
nå_Ãt
 *
Â
, 
u32
 
ù¾_off£t
,

518 
veùÜ_idx
)

520 
	`Â_wr™eb
(
Â
, 
ù¾_off£t
, 0xff);

521 
	`Â_pci_æush
(
Â
);

522 
	`ä“_œq
(
Â
->
œq_’Œ›s
[
veùÜ_idx
].
veùÜ
,‚n);

523 
	}
}

528 
	$nå_Ãt_tx_timeout
(
Ãt_deviû
 *
Ãtdev
)

530 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

531 
i
;

533 
i
 = 0; i < 
Â
->
dp
.
Ãtdev
->
»®_num_tx_queues
; i++) {

534 ià(!
	`Ãtif_tx_queue_¡Ý³d
(
	`Ãtdev_g‘_tx_queue
(
Ãtdev
, 
i
)))

536 
	`Â_w¬n
(
Â
, "TXimeouˆÚ„šg: %d\n", 
i
);

538 
	`Â_w¬n
(
Â
, "TX watchdogimeout\n");

539 
	}
}

544 
	$nå_Ãt_ÿlc_æ_bufsz
(
nå_Ãt_dp
 *
dp
)

546 
æ_bufsz
;

548 
æ_bufsz
 = 
NFP_NET_RX_BUF_HEADROOM
;

549 
æ_bufsz
 +ð
dp
->
rx_dma_off
;

550 ià(
dp
->
rx_off£t
 =ð
NFP_NET_CFG_RX_OFFSET_DYNAMIC
)

551 
æ_bufsz
 +ð
NFP_NET_MAX_PREPEND
;

553 
æ_bufsz
 +ð
dp
->
rx_off£t
;

554 
æ_bufsz
 +ð
ETH_HLEN
 + 
VLAN_HLEN
 * 2 + 
dp
->
mtu
;

556 
æ_bufsz
 = 
	`SKB_DATA_ALIGN
(fl_bufsz);

557 
æ_bufsz
 +ð
	`SKB_DATA_ALIGN
((
skb_sh¬ed_šfo
));

559  
æ_bufsz
;

560 
	}
}

569 
	$nå_Ãt_vecs_š™
(
nå_Ãt
 *
Â
)

571 
nå_Ãt_r_veùÜ
 *
r_vec
;

572 
r
;

574 
Â
->
lsc_hªdËr
 = 
nå_Ãt_œq_lsc
;

575 
Â
->
exn_hªdËr
 = 
nå_Ãt_œq_exn
;

577 
r
 = 0;„ < 
Â
->
max_r_vecs
;„++) {

578 
msix_’Œy
 *
’Œy
;

580 
’Œy
 = &
Â
->
œq_’Œ›s
[
NFP_NET_NON_Q_VECTORS
 + 
r
];

582 
r_vec
 = &
Â
->
r_vecs
[
r
];

583 
r_vec
->
nå_Ãt
 = 
Â
;

584 
r_vec
->
œq_’Œy
 = 
’Œy
->entry;

585 
r_vec
->
œq_veùÜ
 = 
’Œy
->
veùÜ
;

587 ià(
Â
->
dp
.
Ãtdev
) {

588 
r_vec
->
hªdËr
 = 
nå_Ãt_œq_rxtx
;

590 
r_vec
->
hªdËr
 = 
nå_ù¾_œq_rxtx
;

592 
	`__skb_queue_h—d_š™
(&
r_vec
->
queue
);

593 
	`¥š_lock_š™
(&
r_vec
->
lock
);

594 
	`skËt_š™
(&
r_vec
->
skËt
, 
Â
->
dp
.
Ýs
->
ù¾_pÞl
,

595 ()
r_vec
);

596 
	`skËt_di§bË
(&
r_vec
->
skËt
);

599 
	`ýumask_£t_ýu
(
r
, &
r_vec
->
affš™y_mask
);

601 
	}
}

604 
	$nå_Ãt_Çpi_add
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
)

606 ià(
dp
->
Ãtdev
)

607 
	`Ãtif_Çpi_add
(
dp
->
Ãtdev
, &
r_vec
->
Çpi
,

608 
dp
->
Ýs
->
pÞl
, 
NAPI_POLL_WEIGHT
);

610 
	`skËt_’abË
(&
r_vec
->
skËt
);

611 
	}
}

614 
	$nå_Ãt_Çpi_d–
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_r_veùÜ
 *
r_vec
)

616 ià(
dp
->
Ãtdev
)

617 
	`Ãtif_Çpi_d–
(&
r_vec
->
Çpi
);

619 
	`skËt_di§bË
(&
r_vec
->
skËt
);

620 
	}
}

623 
	$nå_Ãt_veùÜ_assign_ršgs
(
nå_Ãt_dp
 *
dp
,

624 
nå_Ãt_r_veùÜ
 *
r_vec
, 
idx
)

626 
r_vec
->
rx_ršg
 = 
idx
 < 
dp
->
num_rx_ršgs
 ? &dp->
rx_ršgs
[idx] : 
NULL
;

627 
r_vec
->
tx_ršg
 =

628 
idx
 < 
dp
->
num_¡ack_tx_ršgs
 ? &dp->
tx_ršgs
[idx] : 
NULL
;

630 
r_vec
->
xdp_ršg
 = 
idx
 < 
dp
->
num_tx_ršgs
 - dp->
num_¡ack_tx_ršgs
 ?

631 &
dp
->
tx_ršgs
[dp->
num_¡ack_tx_ršgs
 + 
idx
] : 
NULL
;

632 
	}
}

635 
	$nå_Ãt_´•¬e_veùÜ
(
nå_Ãt
 *
Â
, 
nå_Ãt_r_veùÜ
 *
r_vec
,

636 
idx
)

638 
”r
;

640 
	`nå_Ãt_Çpi_add
(&
Â
->
dp
, 
r_vec
);

642 
	`¢´štf
(
r_vec
->
Çme
, (r_vec->name),

643 "%s-rxtx-%d", 
	`nå_Ãt_Çme
(
Â
), 
idx
);

644 
”r
 = 
	`»que¡_œq
(
r_vec
->
œq_veùÜ
,„_vec->
hªdËr
, 0,„_vec->
Çme
,

645 
r_vec
);

646 ià(
”r
) {

647 
	`nå_Ãt_Çpi_d–
(&
Â
->
dp
, 
r_vec
);

648 
	`Â_”r
(
Â
, "E¼Ü„eque¡šg IRQ %d\n", 
r_vec
->
œq_veùÜ
);

649  
”r
;

651 
	`di§bË_œq
(
r_vec
->
œq_veùÜ
);

653 
	`œq_£t_affš™y_hšt
(
r_vec
->
œq_veùÜ
, &r_vec->
affš™y_mask
);

655 
	`Â_dbg
(
Â
, "RV%02d: irq=%03d/%03d\n", 
idx
, 
r_vec
->
œq_veùÜ
,

656 
r_vec
->
œq_’Œy
);

659 
	}
}

662 
	$nå_Ãt_þ—nup_veùÜ
(
nå_Ãt
 *
Â
, 
nå_Ãt_r_veùÜ
 *
r_vec
)

664 
	`œq_£t_affš™y_hšt
(
r_vec
->
œq_veùÜ
, 
NULL
);

665 
	`nå_Ãt_Çpi_d–
(&
Â
->
dp
, 
r_vec
);

666 
	`ä“_œq
(
r_vec
->
œq_veùÜ
,„_vec);

667 
	}
}

673 
	$nå_Ãt_rss_wr™e_™bl
(
nå_Ãt
 *
Â
)

675 
i
;

677 
i
 = 0; i < 
NFP_NET_CFG_RSS_ITBL_SZ
; i += 4)

678 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_RSS_ITBL
 + 
i
,

679 
	`g‘_uÇligÃd_Ë32
(
Â
->
rss_™bl
 + 
i
));

680 
	}
}

686 
	$nå_Ãt_rss_wr™e_key
(
nå_Ãt
 *
Â
)

688 
i
;

690 
i
 = 0; i < 
	`nå_Ãt_rss_key_sz
(
Â
); i += 4)

691 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_RSS_KEY
 + 
i
,

692 
	`g‘_uÇligÃd_Ë32
(
Â
->
rss_key
 + 
i
));

693 
	}
}

699 
	$nå_Ãt_cßËsû_wr™e_cfg
(
nå_Ãt
 *
Â
)

701 
u8
 
i
;

702 
u32
 
çùÜ
;

703 
u32
 
v®ue
;

709 
çùÜ
 = 
Â
->
Žv_ÿps
.
me_äeq_mhz
 / 16;

712 
v®ue
 = (
Â
->
rx_cßËsû_max_äames
 << 16) |

713 (
çùÜ
 * 
Â
->
rx_cßËsû_u£cs
);

714 
i
 = 0; i < 
Â
->
dp
.
num_rx_ršgs
; i++)

715 
	`Â_wr™–
(
Â
, 
	`NFP_NET_CFG_RXR_IRQ_MOD
(
i
), 
v®ue
);

718 
v®ue
 = (
Â
->
tx_cßËsû_max_äames
 << 16) |

719 (
çùÜ
 * 
Â
->
tx_cßËsû_u£cs
);

720 
i
 = 0; i < 
Â
->
dp
.
num_tx_ršgs
; i++)

721 
	`Â_wr™–
(
Â
, 
	`NFP_NET_CFG_TXR_IRQ_MOD
(
i
), 
v®ue
);

722 
	}
}

733 
	$nå_Ãt_wr™e_mac_addr
(
nå_Ãt
 *
Â
, cÚ¡ 
u8
 *
addr
)

735 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_MACADDR
 + 0, 
	`g‘_uÇligÃd_be32
(
addr
));

736 
	`Â_wr™ew
(
Â
, 
NFP_NET_CFG_MACADDR
 + 6, 
	`g‘_uÇligÃd_be16
(
addr
 + 4));

737 
	}
}

745 
	$nå_Ãt_þ—r_cÚfig_ªd_di§bË
(
nå_Ãt
 *
Â
)

747 
u32
 
Ãw_ù¾
, 
upd©e
;

748 
r
;

749 
”r
;

751 
Ãw_ù¾
 = 
Â
->
dp
.
ù¾
;

752 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_ENABLE
;

753 
upd©e
 = 
NFP_NET_CFG_UPDATE_GEN
;

754 
upd©e
 |ð
NFP_NET_CFG_UPDATE_MSIX
;

755 
upd©e
 |ð
NFP_NET_CFG_UPDATE_RING
;

757 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RINGCFG
)

758 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_RINGCFG
;

760 
	`Â_wr™eq
(
Â
, 
NFP_NET_CFG_TXRS_ENABLE
, 0);

761 
	`Â_wr™eq
(
Â
, 
NFP_NET_CFG_RXRS_ENABLE
, 0);

763 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_CTRL
, 
Ãw_ù¾
);

764 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
upd©e
);

765 ià(
”r
)

766 
	`Â_”r
(
Â
, "Could‚Ù di§bË deviû: %d\n", 
”r
);

768 
r
 = 0;„ < 
Â
->
dp
.
num_rx_ršgs
;„++)

769 
	`nå_Ãt_rx_ršg_»£t
(&
Â
->
dp
.
rx_ršgs
[
r
]);

770 
r
 = 0;„ < 
Â
->
dp
.
num_tx_ršgs
;„++)

771 
	`nå_Ãt_tx_ršg_»£t
(&
Â
->
dp
, &Â->dp.
tx_ršgs
[
r
]);

772 
r
 = 0;„ < 
Â
->
dp
.
num_r_vecs
;„++)

773 
	`nå_Ãt_vec_þ—r_ršg_d©a
(
Â
, 
r
);

775 
Â
->
dp
.
ù¾
 = 
Ãw_ù¾
;

776 
	}
}

782 
	$nå_Ãt_£t_cÚfig_ªd_’abË
(
nå_Ãt
 *
Â
)

784 
u32
 
bufsz
, 
Ãw_ù¾
, 
upd©e
 = 0;

785 
r
;

786 
”r
;

788 
Ãw_ù¾
 = 
Â
->
dp
.
ù¾
;

790 ià(
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_RSS_ANY
) {

791 
	`nå_Ãt_rss_wr™e_key
(
Â
);

792 
	`nå_Ãt_rss_wr™e_™bl
(
Â
);

793 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_RSS_CTRL
,‚n->
rss_cfg
);

794 
upd©e
 |ð
NFP_NET_CFG_UPDATE_RSS
;

797 ià(
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_IRQMOD
) {

798 
	`nå_Ãt_cßËsû_wr™e_cfg
(
Â
);

799 
upd©e
 |ð
NFP_NET_CFG_UPDATE_IRQMOD
;

802 
r
 = 0;„ < 
Â
->
dp
.
num_tx_ršgs
;„++)

803 
	`nå_Ãt_tx_ršg_hw_cfg_wr™e
(
Â
, &Â->
dp
.
tx_ršgs
[
r
],„);

804 
r
 = 0;„ < 
Â
->
dp
.
num_rx_ršgs
;„++)

805 
	`nå_Ãt_rx_ršg_hw_cfg_wr™e
(
Â
, &Â->
dp
.
rx_ršgs
[
r
],„);

807 
	`Â_wr™eq
(
Â
, 
NFP_NET_CFG_TXRS_ENABLE
,

808 
U64_MAX
 >> (64 - 
Â
->
dp
.
num_tx_ršgs
));

810 
	`Â_wr™eq
(
Â
, 
NFP_NET_CFG_RXRS_ENABLE
,

811 
U64_MAX
 >> (64 - 
Â
->
dp
.
num_rx_ršgs
));

813 ià(
Â
->
dp
.
Ãtdev
)

814 
	`nå_Ãt_wr™e_mac_addr
(
Â
,‚n->
dp
.
Ãtdev
->
dev_addr
);

816 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_MTU
,‚n->
dp
.
mtu
);

818 
bufsz
 = 
Â
->
dp
.
æ_bufsz
 -‚n->dp.
rx_dma_off
 - 
NFP_NET_RX_BUF_NON_DATA
;

819 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_FLBUFSZ
, 
bufsz
);

822 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_ENABLE
;

823 
upd©e
 |ð
NFP_NET_CFG_UPDATE_GEN
;

824 
upd©e
 |ð
NFP_NET_CFG_UPDATE_MSIX
;

825 
upd©e
 |ð
NFP_NET_CFG_UPDATE_RING
;

826 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RINGCFG
)

827 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_RINGCFG
;

829 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_CTRL
, 
Ãw_ù¾
);

830 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
upd©e
);

831 ià(
”r
) {

832 
	`nå_Ãt_þ—r_cÚfig_ªd_di§bË
(
Â
);

833  
”r
;

836 
Â
->
dp
.
ù¾
 = 
Ãw_ù¾
;

838 
r
 = 0;„ < 
Â
->
dp
.
num_rx_ršgs
;„++)

839 
	`nå_Ãt_rx_ršg_fžl_ä“li¡
(&
Â
->
dp
, &Â->dp.
rx_ršgs
[
r
]);

841 #ià
COMPAT__HAVE_VXLAN_OFFLOAD


845 ià(
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_VXLAN
) {

846 
	`mem£t
(&
Â
->
vxÏn_pÜts
, 0, (nn->vxlan_ports));

847 
	`mem£t
(&
Â
->
vxÏn_u£út
, 0, (nn->vxlan_usecnt));

848 
	`udp_tuÂ–_g‘_rx_šfo
(
Â
->
dp
.
Ãtdev
);

853 
	}
}

859 
	$nå_Ãt_þo£_¡ack
(
nå_Ãt
 *
Â
)

861 
r
;

863 
	`di§bË_œq
(
Â
->
œq_’Œ›s
[
NFP_NET_IRQ_LSC_IDX
].
veùÜ
);

864 
	`Ãtif_ÿ¼›r_off
(
Â
->
dp
.
Ãtdev
);

865 
Â
->
lšk_up
 = 
çl£
;

867 
r
 = 0;„ < 
Â
->
dp
.
num_r_vecs
;„++) {

868 
	`di§bË_œq
(
Â
->
r_vecs
[
r
].
œq_veùÜ
);

869 
	`Çpi_di§bË
(&
Â
->
r_vecs
[
r
].
Çpi
);

872 
	`Ãtif_tx_di§bË
(
Â
->
dp
.
Ãtdev
);

873 
	}
}

879 
	$nå_Ãt_þo£_ä“_®l
(
nå_Ãt
 *
Â
)

881 
r
;

883 
	`nå_Ãt_tx_ršgs_ä“
(&
Â
->
dp
);

884 
	`nå_Ãt_rx_ršgs_ä“
(&
Â
->
dp
);

886 
r
 = 0;„ < 
Â
->
dp
.
num_r_vecs
;„++)

887 
	`nå_Ãt_þ—nup_veùÜ
(
Â
, &Â->
r_vecs
[
r
]);

889 
	`nå_Ãt_aux_œq_ä“
(
Â
, 
NFP_NET_CFG_LSC
, 
NFP_NET_IRQ_LSC_IDX
);

890 
	`nå_Ãt_aux_œq_ä“
(
Â
, 
NFP_NET_CFG_EXN
, 
NFP_NET_IRQ_EXN_IDX
);

891 
	}
}

897 
	$nå_Ãt_Ãtdev_þo£
(
Ãt_deviû
 *
Ãtdev
)

899 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

903 
	`nå_Ãt_þo£_¡ack
(
Â
);

907 
	`nå_Ãt_þ—r_cÚfig_ªd_di§bË
(
Â
);

908 
	`nå_pÜt_cÚfigu»
(
Ãtdev
, 
çl£
);

912 
	`nå_Ãt_þo£_ä“_®l
(
Â
);

914 
	`Â_dbg
(
Â
, "% down", 
Ãtdev
->
Çme
);

916 
	}
}

918 
	$nå_ù¾_þo£
(
nå_Ãt
 *
Â
)

920 
r
;

922 
	`¹Æ_lock
();

924 
r
 = 0;„ < 
Â
->
dp
.
num_r_vecs
;„++) {

925 
	`di§bË_œq
(
Â
->
r_vecs
[
r
].
œq_veùÜ
);

926 
	`skËt_di§bË
(&
Â
->
r_vecs
[
r
].
skËt
);

929 
	`nå_Ãt_þ—r_cÚfig_ªd_di§bË
(
Â
);

931 
	`nå_Ãt_þo£_ä“_®l
(
Â
);

933 
	`¹Æ_uÆock
();

934 
	}
}

940 
	$nå_Ãt_Ý’_¡ack
(
nå_Ãt
 *
Â
)

942 
r
;

944 
r
 = 0;„ < 
Â
->
dp
.
num_r_vecs
;„++) {

945 
	`Çpi_’abË
(&
Â
->
r_vecs
[
r
].
Çpi
);

946 
	`’abË_œq
(
Â
->
r_vecs
[
r
].
œq_veùÜ
);

949 
	`Ãtif_tx_wake_®l_queues
(
Â
->
dp
.
Ãtdev
);

951 
	`’abË_œq
(
Â
->
œq_’Œ›s
[
NFP_NET_IRQ_LSC_IDX
].
veùÜ
);

952 
	`nå_Ãt_»ad_lšk_¡©us
(
Â
);

953 
	}
}

955 
	$nå_Ãt_Ý’_®loc_®l
(
nå_Ãt
 *
Â
)

957 
”r
, 
r
;

959 
”r
 = 
	`nå_Ãt_aux_œq_»que¡
(
Â
, 
NFP_NET_CFG_EXN
, "%s-exn",

960 
Â
->
exn_Çme
, (nn->exn_name),

961 
NFP_NET_IRQ_EXN_IDX
, 
Â
->
exn_hªdËr
);

962 ià(
”r
)

963  
”r
;

964 
”r
 = 
	`nå_Ãt_aux_œq_»que¡
(
Â
, 
NFP_NET_CFG_LSC
, "%s-lsc",

965 
Â
->
lsc_Çme
, (nn->lsc_name),

966 
NFP_NET_IRQ_LSC_IDX
, 
Â
->
lsc_hªdËr
);

967 ià(
”r
)

968 
”r_ä“_exn
;

969 
	`di§bË_œq
(
Â
->
œq_’Œ›s
[
NFP_NET_IRQ_LSC_IDX
].
veùÜ
);

971 
r
 = 0;„ < 
Â
->
dp
.
num_r_vecs
;„++) {

972 
”r
 = 
	`nå_Ãt_´•¬e_veùÜ
(
Â
, &Â->
r_vecs
[
r
],„);

973 ià(
”r
)

974 
”r_þ—nup_vec_p
;

977 
”r
 = 
	`nå_Ãt_rx_ršgs_´•¬e
(
Â
, &Â->
dp
);

978 ià(
”r
)

979 
”r_þ—nup_vec
;

981 
”r
 = 
	`nå_Ãt_tx_ršgs_´•¬e
(
Â
, &Â->
dp
);

982 ià(
”r
)

983 
”r_ä“_rx_ršgs
;

985 
r
 = 0;„ < 
Â
->
max_r_vecs
;„++)

986 
	`nå_Ãt_veùÜ_assign_ršgs
(&
Â
->
dp
, &Â->
r_vecs
[
r
],„);

990 
”r_ä“_rx_ršgs
:

991 
	`nå_Ãt_rx_ršgs_ä“
(&
Â
->
dp
);

992 
”r_þ—nup_vec
:

993 
r
 = 
Â
->
dp
.
num_r_vecs
;

994 
”r_þ—nup_vec_p
:

995 
r
--)

996 
	`nå_Ãt_þ—nup_veùÜ
(
Â
, &Â->
r_vecs
[
r
]);

997 
	`nå_Ãt_aux_œq_ä“
(
Â
, 
NFP_NET_CFG_LSC
, 
NFP_NET_IRQ_LSC_IDX
);

998 
”r_ä“_exn
:

999 
	`nå_Ãt_aux_œq_ä“
(
Â
, 
NFP_NET_CFG_EXN
, 
NFP_NET_IRQ_EXN_IDX
);

1000  
”r
;

1001 
	}
}

1003 
	$nå_Ãt_Ãtdev_Ý’
(
Ãt_deviû
 *
Ãtdev
)

1005 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1006 
”r
;

1013 
”r
 = 
	`nå_Ãt_Ý’_®loc_®l
(
Â
);

1014 ià(
”r
)

1015  
”r
;

1017 
”r
 = 
	`Ãtif_£t_»®_num_tx_queues
(
Ãtdev
, 
Â
->
dp
.
num_¡ack_tx_ršgs
);

1018 ià(
”r
)

1019 
”r_ä“_®l
;

1021 
”r
 = 
	`Ãtif_£t_»®_num_rx_queues
(
Ãtdev
, 
Â
->
dp
.
num_rx_ršgs
);

1022 ià(
”r
)

1023 
”r_ä“_®l
;

1033 
”r
 = 
	`nå_pÜt_cÚfigu»
(
Ãtdev
, 
Œue
);

1034 ià(
”r
)

1035 
”r_ä“_®l
;

1037 
”r
 = 
	`nå_Ãt_£t_cÚfig_ªd_’abË
(
Â
);

1038 ià(
”r
)

1039 
”r_pÜt_di§bË
;

1047 
	`nå_Ãt_Ý’_¡ack
(
Â
);

1051 
”r_pÜt_di§bË
:

1052 
	`nå_pÜt_cÚfigu»
(
Ãtdev
, 
çl£
);

1053 
”r_ä“_®l
:

1054 
	`nå_Ãt_þo£_ä“_®l
(
Â
);

1055  
”r
;

1056 
	}
}

1058 
	$nå_ù¾_Ý’
(
nå_Ãt
 *
Â
)

1060 
”r
, 
r
;

1063 
	`¹Æ_lock
();

1065 
”r
 = 
	`nå_Ãt_Ý’_®loc_®l
(
Â
);

1066 ià(
”r
)

1067 
”r_uÆock
;

1069 
”r
 = 
	`nå_Ãt_£t_cÚfig_ªd_’abË
(
Â
);

1070 ià(
”r
)

1071 
”r_ä“_®l
;

1073 
r
 = 0;„ < 
Â
->
dp
.
num_r_vecs
;„++)

1074 
	`’abË_œq
(
Â
->
r_vecs
[
r
].
œq_veùÜ
);

1076 
	`¹Æ_uÆock
();

1080 
”r_ä“_®l
:

1081 
	`nå_Ãt_þo£_ä“_®l
(
Â
);

1082 
”r_uÆock
:

1083 
	`¹Æ_uÆock
();

1084  
”r
;

1085 
	}
}

1087 
	$nå_Ãt_£t_rx_mode
(
Ãt_deviû
 *
Ãtdev
)

1089 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1090 
u32
 
Ãw_ù¾
;

1092 
Ãw_ù¾
 = 
Â
->
dp
.
ù¾
;

1094 ià(!
	`Ãtdev_mc_em±y
(
Ãtdev
è||‚‘dev->
æags
 & 
IFF_ALLMULTI
)

1095 
Ãw_ù¾
 |ð
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_L2MC
;

1097 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_L2MC
;

1099 ià(
Ãtdev
->
æags
 & 
IFF_PROMISC
) {

1100 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_PROMISC
)

1101 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_PROMISC
;

1103 
	`Â_w¬n
(
Â
, "FW does‚ot support…romiscuous mode\n");

1105 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_PROMISC
;

1108 ià(
Ãw_ù¾
 =ð
Â
->
dp
.
ù¾
)

1111 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_CTRL
, 
Ãw_ù¾
);

1112 
	`nå_Ãt_»cÚfig_po¡
(
Â
, 
NFP_NET_CFG_UPDATE_GEN
);

1114 
Â
->
dp
.
ù¾
 = 
Ãw_ù¾
;

1115 
	}
}

1117 
	$nå_Ãt_rss_š™_™bl
(
nå_Ãt
 *
Â
)

1119 
i
;

1121 
i
 = 0; i < (
Â
->
rss_™bl
); i++)

1122 
Â
->
rss_™bl
[
i
] =

1123 
	`‘htoÞ_rxfh_šdœ_deçuÉ
(
i
, 
Â
->
dp
.
num_rx_ršgs
);

1124 
	}
}

1126 
	$nå_Ãt_dp_sw­
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
)

1128 
nå_Ãt_dp
 
Ãw_dp
 = *
dp
;

1130 *
dp
 = 
Â
->dp;

1131 
Â
->
dp
 = 
Ãw_dp
;

1133 
Â
->
dp
.
Ãtdev
->
mtu
 = 
Ãw_dp
.mtu;

1135 ià(!
	`Ãtif_is_rxfh_cÚfigu»d
(
Â
->
dp
.
Ãtdev
))

1136 
	`nå_Ãt_rss_š™_™bl
(
Â
);

1137 
	}
}

1139 
	$nå_Ãt_dp_sw­_’abË
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
)

1141 
r
;

1142 
”r
;

1144 
	`nå_Ãt_dp_sw­
(
Â
, 
dp
);

1146 
r
 = 0;„ < 
Â
->
max_r_vecs
;„++)

1147 
	`nå_Ãt_veùÜ_assign_ršgs
(&
Â
->
dp
, &Â->
r_vecs
[
r
],„);

1149 
”r
 = 
	`Ãtif_£t_»®_num_rx_queues
(
Â
->
dp
.
Ãtdev
,‚n->dp.
num_rx_ršgs
);

1150 ià(
”r
)

1151  
”r
;

1153 ià(
Â
->
dp
.
Ãtdev
->
»®_num_tx_queues
 !ðÂ->dp.
num_¡ack_tx_ršgs
) {

1154 
”r
 = 
	`Ãtif_£t_»®_num_tx_queues
(
Â
->
dp
.
Ãtdev
,

1155 
Â
->
dp
.
num_¡ack_tx_ršgs
);

1156 ià(
”r
)

1157  
”r
;

1160  
	`nå_Ãt_£t_cÚfig_ªd_’abË
(
Â
);

1161 
	}
}

1163 
nå_Ãt_dp
 *
	$nå_Ãt_þÚe_dp
(
nå_Ãt
 *
Â
)

1165 
nå_Ãt_dp
 *
Ãw
;

1167 
Ãw
 = 
	`km®loc
((*Ãw), 
GFP_KERNEL
);

1168 ià(!
Ãw
)

1169  
NULL
;

1171 *
Ãw
 = 
Â
->
dp
;

1174 
Ãw
->
æ_bufsz
 = 0;

1175 
Ãw
->
tx_ršgs
 = 
NULL
;

1176 
Ãw
->
rx_ršgs
 = 
NULL
;

1177 
Ãw
->
num_r_vecs
 = 0;

1178 
Ãw
->
num_¡ack_tx_ršgs
 = 0;

1179 
Ãw
->
txrwb
 = 
NULL
;

1180 
Ãw
->
txrwb_dma
 = 0;

1182  
Ãw
;

1183 
	}
}

1186 
	$nå_Ãt_check_cÚfig
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
,

1187 
ÃŽšk_ext_ack
 *
exck
)

1190 ià(!
dp
->
xdp_´og
)

1192 ià(
dp
->
æ_bufsz
 > 
PAGE_SIZE
) {

1193 
	`NL_SET_ERR_MSG_MOD
(
exck
, "MTUoo†arge w/ XDPƒnabled");

1194  -
EINVAL
;

1196 ià(
dp
->
num_tx_ršgs
 > 
Â
->
max_tx_ršgs
) {

1197 
	`NL_SET_ERR_MSG_MOD
(
exck
, "Insufficient‚umber of TX„ings w/ XDPƒnabled");

1198  -
EINVAL
;

1202 
	}
}

1204 
	$nå_Ãt_ršg_»cÚfig
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
,

1205 
ÃŽšk_ext_ack
 *
exck
)

1207 
r
, 
”r
;

1209 
dp
->
æ_bufsz
 = 
	`nå_Ãt_ÿlc_æ_bufsz
(dp);

1211 
dp
->
num_¡ack_tx_ršgs
 = dp->
num_tx_ršgs
;

1212 ià(
dp
->
xdp_´og
)

1213 
dp
->
num_¡ack_tx_ršgs
 -ðdp->
num_rx_ršgs
;

1215 
dp
->
num_r_vecs
 = 
	`max
(dp->
num_rx_ršgs
, dp->
num_¡ack_tx_ršgs
);

1217 
”r
 = 
	`nå_Ãt_check_cÚfig
(
Â
, 
dp
, 
exck
);

1218 ià(
”r
)

1219 
ex™_ä“_dp
;

1221 ià(!
	`Ãtif_ruÂšg
(
dp
->
Ãtdev
)) {

1222 
	`nå_Ãt_dp_sw­
(
Â
, 
dp
);

1223 
”r
 = 0;

1224 
ex™_ä“_dp
;

1228 
r
 = 
Â
->
dp
.
num_r_vecs
;„ < dp->num_r_vecs;„++) {

1229 
”r
 = 
	`nå_Ãt_´•¬e_veùÜ
(
Â
, &Â->
r_vecs
[
r
],„);

1230 ià(
”r
) {

1231 
dp
->
num_r_vecs
 = 
r
;

1232 
”r_þ—nup_vecs
;

1236 
”r
 = 
	`nå_Ãt_rx_ršgs_´•¬e
(
Â
, 
dp
);

1237 ià(
”r
)

1238 
”r_þ—nup_vecs
;

1240 
”r
 = 
	`nå_Ãt_tx_ršgs_´•¬e
(
Â
, 
dp
);

1241 ià(
”r
)

1242 
”r_ä“_rx
;

1245 
	`nå_Ãt_þo£_¡ack
(
Â
);

1246 
	`nå_Ãt_þ—r_cÚfig_ªd_di§bË
(
Â
);

1248 
”r
 = 
	`nå_Ãt_dp_sw­_’abË
(
Â
, 
dp
);

1249 ià(
”r
) {

1250 
”r2
;

1252 
	`nå_Ãt_þ—r_cÚfig_ªd_di§bË
(
Â
);

1255 
”r2
 = 
	`nå_Ãt_dp_sw­_’abË
(
Â
, 
dp
);

1256 ià(
”r2
)

1257 
	`Â_”r
(
Â
, "Can't„estore„ing config - FW communication failed (%d,%d)\n",

1258 
”r
, 
”r2
);

1260 
r
 = 
dp
->
num_r_vecs
 - 1;„ >ð
Â
->dp.num_r_vecs;„--)

1261 
	`nå_Ãt_þ—nup_veùÜ
(
Â
, &Â->
r_vecs
[
r
]);

1263 
	`nå_Ãt_rx_ršgs_ä“
(
dp
);

1264 
	`nå_Ãt_tx_ršgs_ä“
(
dp
);

1266 
	`nå_Ãt_Ý’_¡ack
(
Â
);

1267 
ex™_ä“_dp
:

1268 
	`kä“
(
dp
);

1270  
”r
;

1272 
”r_ä“_rx
:

1273 
	`nå_Ãt_rx_ršgs_ä“
(
dp
);

1274 
”r_þ—nup_vecs
:

1275 
r
 = 
dp
->
num_r_vecs
 - 1;„ >ð
Â
->dp.num_r_vecs;„--)

1276 
	`nå_Ãt_þ—nup_veùÜ
(
Â
, &Â->
r_vecs
[
r
]);

1277 
	`kä“
(
dp
);

1278  
”r
;

1279 
	}
}

1281 
	$nå_Ãt_chªge_mtu
(
Ãt_deviû
 *
Ãtdev
, 
Ãw_mtu
)

1283 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1284 
nå_Ãt_dp
 *
dp
;

1285 
”r
;

1287 ià(
Ãw_mtu
 < 68 ||‚ew_mtu > 
Â
->
max_mtu
) {

1288 
	`Â_”r
(
Â
, "New MTU (%dèi nÙ v®id\n", 
Ãw_mtu
);

1289  -
EINVAL
;

1292 
”r
 = 
	`nå_­p_check_mtu
(
Â
->
­p
, 
Ãtdev
, 
Ãw_mtu
);

1293 ià(
”r
)

1294  
”r
;

1296 
dp
 = 
	`nå_Ãt_þÚe_dp
(
Â
);

1297 ià(!
dp
)

1298  -
ENOMEM
;

1300 
dp
->
mtu
 = 
Ãw_mtu
;

1302  
	`nå_Ãt_ršg_»cÚfig
(
Â
, 
dp
, 
NULL
);

1303 
	}
}

1306 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 10, 0)

1307 
	$nå_Ãt_vÏn_rx_add_vid
(
Ãt_deviû
 *
Ãtdev
, 
u16
 
vid
)

1309 
	$nå_Ãt_vÏn_rx_add_vid
(
Ãt_deviû
 *
Ãtdev
, 
__be16
 
´Ùo
, 
u16
 
vid
)

1312 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1317 ià(!
vid
)

1320 
	`Â_wr™ew
(
Â
,‚n->
Žv_ÿps
.
mbox_off
 + 
NFP_NET_CFG_VLAN_FILTER_VID
, 
vid
);

1321 
	`Â_wr™ew
(
Â
,‚n->
Žv_ÿps
.
mbox_off
 + 
NFP_NET_CFG_VLAN_FILTER_PROTO
,

1322 
ETH_P_8021Q
);

1324  
	`nå_Ãt_»cÚfig_mbox
(
Â
, 
NFP_NET_CFG_MBOX_CMD_CTAG_FILTER_ADD
);

1325 
	}
}

1328 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 10, 0)

1329 
	$nå_Ãt_vÏn_rx_kžl_vid
(
Ãt_deviû
 *
Ãtdev
, 
u16
 
vid
)

1331 
	$nå_Ãt_vÏn_rx_kžl_vid
(
Ãt_deviû
 *
Ãtdev
, 
__be16
 
´Ùo
, 
u16
 
vid
)

1334 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1339 ià(!
vid
)

1342 
	`Â_wr™ew
(
Â
,‚n->
Žv_ÿps
.
mbox_off
 + 
NFP_NET_CFG_VLAN_FILTER_VID
, 
vid
);

1343 
	`Â_wr™ew
(
Â
,‚n->
Žv_ÿps
.
mbox_off
 + 
NFP_NET_CFG_VLAN_FILTER_PROTO
,

1344 
ETH_P_8021Q
);

1346  
	`nå_Ãt_»cÚfig_mbox
(
Â
, 
NFP_NET_CFG_MBOX_CMD_CTAG_FILTER_KILL
);

1347 
	}
}

1349 #ià
COMPAT__NEED_NDO_POLL_CONTROLLER


1350 
	$nå_Ãt_ÃÞl
(
Ãt_deviû
 *
Ãtdev
)

1352 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1353 
i
;

1359 
i
 = 0; i < 
Â
->
dp
.
num_¡ack_tx_ršgs
; i++)

1360 
	`Çpi_scheduË_œqoff
(&
Â
->
r_vecs
[
i
].
Çpi
);

1361 
	}
}

1364 
com·t__¡©64_»t_t
 
	$nå_Ãt_¡©64
(
Ãt_deviû
 *
Ãtdev
,

1365 
¹Æ_lšk_¡©s64
 *
¡©s
)

1367 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1368 
r
;

1371 
r
 = 0;„ < 
Â
->
max_r_vecs
;„++) {

1372 
nå_Ãt_r_veùÜ
 *
r_vec
 = &
Â
->
r_vecs
[
r
];

1373 
u64
 
d©a
[3];

1374 
¡¬t
;

1377 
¡¬t
 = 
	`u64_¡©s_ãtch_begš
(&
r_vec
->
rx_sync
);

1378 
d©a
[0] = 
r_vec
->
rx_pkts
;

1379 
d©a
[1] = 
r_vec
->
rx_by‹s
;

1380 
d©a
[2] = 
r_vec
->
rx_drÝs
;

1381 } 
	`u64_¡©s_ãtch_»Œy
(&
r_vec
->
rx_sync
, 
¡¬t
));

1382 
¡©s
->
rx_·ck‘s
 +ð
d©a
[0];

1383 
¡©s
->
rx_by‹s
 +ð
d©a
[1];

1384 
¡©s
->
rx_drÝ³d
 +ð
d©a
[2];

1387 
¡¬t
 = 
	`u64_¡©s_ãtch_begš
(&
r_vec
->
tx_sync
);

1388 
d©a
[0] = 
r_vec
->
tx_pkts
;

1389 
d©a
[1] = 
r_vec
->
tx_by‹s
;

1390 
d©a
[2] = 
r_vec
->
tx_”rÜs
;

1391 } 
	`u64_¡©s_ãtch_»Œy
(&
r_vec
->
tx_sync
, 
¡¬t
));

1392 
¡©s
->
tx_·ck‘s
 +ð
d©a
[0];

1393 
¡©s
->
tx_by‹s
 +ð
d©a
[1];

1394 
¡©s
->
tx_”rÜs
 +ð
d©a
[2];

1398 
¡©s
->
muÉiÿ¡
 +ð
	`Â_»adq
(
Â
, 
NFP_NET_CFG_STATS_RX_MC_FRAMES
);

1399 
¡©s
->
rx_drÝ³d
 +ð
	`Â_»adq
(
Â
, 
NFP_NET_CFG_STATS_RX_DISCARDS
);

1400 
¡©s
->
rx_”rÜs
 +ð
	`Â_»adq
(
Â
, 
NFP_NET_CFG_STATS_RX_ERRORS
);

1402 
¡©s
->
tx_drÝ³d
 +ð
	`Â_»adq
(
Â
, 
NFP_NET_CFG_STATS_TX_DISCARDS
);

1403 
¡©s
->
tx_”rÜs
 +ð
	`Â_»adq
(
Â
, 
NFP_NET_CFG_STATS_TX_ERRORS
);

1405 #ià
	`VER_NON_RHEL_LT
(4, 11è|| 
	`VER_RHEL_LT
(7, 5)

1406  
¡©s
;

1408 
	}
}

1410 
	$nå_Ãt_£t_ã©u»s
(
Ãt_deviû
 *
Ãtdev
,

1411 
Ãtdev_ã©u»s_t
 
ã©u»s
)

1413 
Ãtdev_ã©u»s_t
 
chªged
 = 
Ãtdev
->
ã©u»s
 ^ features;

1414 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1415 
u32
 
Ãw_ù¾
;

1416 
”r
;

1420 
Ãw_ù¾
 = 
Â
->
dp
.
ù¾
;

1422 ià(
chªged
 & 
NETIF_F_RXCSUM
) {

1423 ià(
ã©u»s
 & 
NETIF_F_RXCSUM
)

1424 
Ãw_ù¾
 |ð
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RXCSUM_ANY
;

1426 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_RXCSUM_ANY
;

1429 ià(
chªged
 & (
NETIF_F_IP_CSUM
 | 
NETIF_F_IPV6_CSUM
)) {

1430 ià(
ã©u»s
 & (
NETIF_F_IP_CSUM
 | 
NETIF_F_IPV6_CSUM
))

1431 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_TXCSUM
;

1433 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_TXCSUM
;

1436 ià(
chªged
 & (
NETIF_F_TSO
 | 
NETIF_F_TSO6
)) {

1437 ià(
ã©u»s
 & (
NETIF_F_TSO
 | 
NETIF_F_TSO6
))

1438 
Ãw_ù¾
 |ð
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO2
 ?:

1439 
NFP_NET_CFG_CTRL_LSO
;

1441 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_LSO_ANY
;

1444 ià(
chªged
 & 
NETIF_F_HW_VLAN_CTAG_RX
) {

1445 ià(
ã©u»s
 & 
NETIF_F_HW_VLAN_CTAG_RX
)

1446 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_RXVLAN
;

1448 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_RXVLAN
;

1451 ià(
chªged
 & 
NETIF_F_HW_VLAN_CTAG_TX
) {

1452 ià(
ã©u»s
 & 
NETIF_F_HW_VLAN_CTAG_TX
)

1453 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_TXVLAN
;

1455 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_TXVLAN
;

1458 ià(
chªged
 & 
NETIF_F_HW_VLAN_CTAG_FILTER
) {

1459 ià(
ã©u»s
 & 
NETIF_F_HW_VLAN_CTAG_FILTER
)

1460 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_CTAG_FILTER
;

1462 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_CTAG_FILTER
;

1465 ià(
chªged
 & 
NETIF_F_SG
) {

1466 ià(
ã©u»s
 & 
NETIF_F_SG
)

1467 
Ãw_ù¾
 |ð
NFP_NET_CFG_CTRL_GATHER
;

1469 
Ãw_ù¾
 &ð~
NFP_NET_CFG_CTRL_GATHER
;

1472 
”r
 = 
	`nå_pÜt_£t_ã©u»s
(
Ãtdev
, 
ã©u»s
);

1473 ià(
”r
)

1474  
”r
;

1476 
	`Â_dbg
(
Â
, "Feature change 0x%llx -> 0x%llx (changed=0x%llx)\n",

1477 
Ãtdev
->
ã©u»s
, f—tu»s, 
chªged
);

1479 ià(
Ãw_ù¾
 =ð
Â
->
dp
.
ù¾
)

1482 
	`Â_dbg
(
Â
, "NIC cŒl: 0x%x -> 0x%x\n",‚n->
dp
.
ù¾
, 
Ãw_ù¾
);

1483 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_CTRL
, 
Ãw_ù¾
);

1484 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_GEN
);

1485 ià(
”r
)

1486  
”r
;

1488 
Â
->
dp
.
ù¾
 = 
Ãw_ù¾
;

1491 
	}
}

1493 #ià
COMPAT__HAVE_NDO_FEATURES_CHECK


1494 
Ãtdev_ã©u»s_t


1495 
	$nå_Ãt_ã©u»s_check
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
dev
,

1496 
Ãtdev_ã©u»s_t
 
ã©u»s
)

1498 
u8
 
l4_hdr
;

1501 
ã©u»s
 &ð
	`vÏn_ã©u»s_check
(
skb
, features);

1503 ià(!
skb
->
’ÿpsuÏtiÚ
)

1504  
ã©u»s
;

1507 ià(
	`skb_is_gso
(
skb
)) {

1508 
u32
 
hd¾’
;

1510 
hd¾’
 = 
	`skb_šÃr_Œª¥Üt_h—d”
(
skb
è- skb->
d©a
 +

1511 
	`šÃr_tý_hd¾’
(
skb
);

1516 ià(
	`uÆik–y
(
hd¾’
 > 
NFP_NET_LSO_MAX_HDR_SZ
 - 8))

1517 
ã©u»s
 &ð~
NETIF_F_GSO_MASK
;

1521 
	`vÏn_g‘_´ÙocÞ
(
skb
)) {

1522 
	`htÚs
(
ETH_P_IP
):

1523 
l4_hdr
 = 
	`_hdr
(
skb
)->
´ÙocÞ
;

1525 
	`htÚs
(
ETH_P_IPV6
):

1526 
l4_hdr
 = 
	`v6_hdr
(
skb
)->
Ãxthdr
;

1529  
ã©u»s
 & ~(
NETIF_F_CSUM_MASK
 | 
NETIF_F_GSO_MASK
);

1532 ià(
skb
->
šÃr_´ÙocÞ_ty³
 !ð
ENCAP_TYPE_ETHER
 ||

1533 
skb
->
šÃr_´ÙocÞ
 !ð
	`htÚs
(
ETH_P_TEB
) ||

1534 (
l4_hdr
 !ð
IPPROTO_UDP
 &&†4_hd¸!ð
IPPROTO_GRE
) ||

1535 (
l4_hdr
 =ð
IPPROTO_UDP
 &&

1536 (
	`skb_šÃr_mac_h—d”
(
skb
è- 
	`skb_Œª¥Üt_h—d”
(skb) !=

1537 (
udphdr
è+ (
vxÏnhdr
))))

1538  
ã©u»s
 & ~(
NETIF_F_CSUM_MASK
 | 
NETIF_F_GSO_MASK
);

1540  
ã©u»s
;

1541 
	}
}

1544 #ià
VER_NON_RHEL_GE
(4, 1è|| 
VER_RHEL_GE
(7, 4)

1546 
	$nå_Ãt_g‘_phys_pÜt_Çme
(
Ãt_deviû
 *
Ãtdev
, *
Çme
, 
size_t
 
Ën
)

1548 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1549 
n
;

1554 ià(
Â
->
pÜt
)

1555 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 2, 0)

1556  -
EOPNOTSUPP
;

1558  
	`nå_pÜt_g‘_phys_pÜt_Çme
(
Ãtdev
, 
Çme
, 
Ën
);

1561 ià(
Â
->
dp
.
is_vf
 ||‚n->
vnic_no_Çme
)

1562  -
EOPNOTSUPP
;

1564 
n
 = 
	`¢´štf
(
Çme
, 
Ën
, "n%d", 
Â
->
id
);

1565 ià(
n
 >ð
Ën
)

1566  -
EINVAL
;

1569 
	}
}

1572 #ià
COMPAT__HAVE_VXLAN_OFFLOAD


1579 
	$nå_Ãt_£t_vxÏn_pÜt
(
nå_Ãt
 *
Â
, 
idx
, 
__be16
 
pÜt
)

1581 
i
;

1583 
Â
->
vxÏn_pÜts
[
idx
] = 
pÜt
;

1585 ià(!(
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_VXLAN
))

1588 
	`BUILD_BUG_ON
(
NFP_NET_N_VXLAN_PORTS
 & 1);

1589 
i
 = 0; i < 
NFP_NET_N_VXLAN_PORTS
; i += 2)

1590 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_VXLAN_PORT
 + 
i
 * (
pÜt
),

1591 
	`be16_to_ýu
(
Â
->
vxÏn_pÜts
[
i
 + 1]) << 16 |

1592 
	`be16_to_ýu
(
Â
->
vxÏn_pÜts
[
i
]));

1594 
	`nå_Ãt_»cÚfig_po¡
(
Â
, 
NFP_NET_CFG_UPDATE_VXLAN
);

1595 
	}
}

1606 
	$nå_Ãt_fšd_vxÏn_idx
(
nå_Ãt
 *
Â
, 
__be16
 
pÜt
)

1608 
i
, 
ä“_idx
 = -
ENOSPC
;

1610 
i
 = 0; i < 
NFP_NET_N_VXLAN_PORTS
; i++) {

1611 ià(
Â
->
vxÏn_pÜts
[
i
] =ð
pÜt
)

1612  
i
;

1613 ià(!
Â
->
vxÏn_u£út
[
i
])

1614 
ä“_idx
 = 
i
;

1617  
ä“_idx
;

1618 
	}
}

1620 
nå_Ãt_add_vxÏn_pÜt
(
Ãt_deviû
 *
Ãtdev
,

1621 #ià
COMPAT__HAVE_UDP_OFFLOAD


1622 
udp_tuÂ–_šfo
 *
ti
)

1625 
§_çmžy_t
 
	g§_çmžy
, 
__be16
 
	gpÜt
)

1627 
udp_tuÂ–_šfo
 
	g__ti
 = { 
UDP_TUNNEL_TYPE_VXLAN
, 
pÜt
 };

1628 
udp_tuÂ–_šfo
 *
	gti
 = &
__ti
;

1630 
nå_Ãt
 *
	gÂ
 = 
Ãtdev_´iv
(
Ãtdev
);

1631 
	gidx
;

1633 ià(
	gti
->
	gty³
 !ð
UDP_TUNNEL_TYPE_VXLAN
)

1636 
	gidx
 = 
nå_Ãt_fšd_vxÏn_idx
(
Â
, 
ti
->
pÜt
);

1637 ià(
	gidx
 =ð-
ENOSPC
)

1640 ià(!
	gÂ
->
	gvxÏn_u£út
[
idx
]++)

1641 
nå_Ãt_£t_vxÏn_pÜt
(
Â
, 
idx
, 
ti
->
pÜt
);

1644 
nå_Ãt_d–_vxÏn_pÜt
(
Ãt_deviû
 *
Ãtdev
,

1645 #ià
COMPAT__HAVE_UDP_OFFLOAD


1646 
udp_tuÂ–_šfo
 *
ti
)

1649 
§_çmžy_t
 
	g§_çmžy
, 
__be16
 
	gpÜt
)

1651 
udp_tuÂ–_šfo
 
	g__ti
 = { 
UDP_TUNNEL_TYPE_VXLAN
, 
pÜt
 };

1652 
udp_tuÂ–_šfo
 *
	gti
 = &
__ti
;

1654 
nå_Ãt
 *
	gÂ
 = 
Ãtdev_´iv
(
Ãtdev
);

1655 
	gidx
;

1657 ià(
	gti
->
	gty³
 !ð
UDP_TUNNEL_TYPE_VXLAN
)

1660 
	gidx
 = 
nå_Ãt_fšd_vxÏn_idx
(
Â
, 
ti
->
pÜt
);

1661 ià(
	gidx
 =ð-
ENOSPC
 || !
Â
->
vxÏn_u£út
[
idx
])

1664 ià(!--
	gÂ
->
	gvxÏn_u£út
[
idx
])

1665 
nå_Ãt_£t_vxÏn_pÜt
(
Â
, 
idx
, 0);

1669 #ià
COMPAT__HAVE_XDP


1670 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 15, 0)

1671 
	$nå_Ãt_xdp_£tup_drv
(
nå_Ãt
 *
Â
, 
Ãtdev_xdp
 *
bpf
)

1673 
	$nå_Ãt_xdp_£tup_drv
(
nå_Ãt
 *
Â
, 
Ãtdev_bpf
 *
bpf
)

1676 
bpf_´og
 *
´og
 = 
bpf
->prog;

1677 
nå_Ãt_dp
 *
dp
;

1678 
”r
;

1680 ià(!
	`xdp_©chm’t_æags_ok
(&
Â
->
xdp
, 
bpf
))

1681  -
EBUSY
;

1683 ià(!
´og
 =ð!
Â
->
dp
.
xdp_´og
) {

1684 
	`WRITE_ONCE
(
Â
->
dp
.
xdp_´og
, 
´og
);

1685 
	`xdp_©chm’t_£tup
(&
Â
->
xdp
, 
bpf
);

1689 
dp
 = 
	`nå_Ãt_þÚe_dp
(
Â
);

1690 ià(!
dp
)

1691  -
ENOMEM
;

1693 
dp
->
xdp_´og
 = 
´og
;

1694 
dp
->
num_tx_ršgs
 +ð
´og
 ? 
Â
->dp.
num_rx_ršgs
 : -nn->dp.num_rx_rings;

1695 
dp
->
rx_dma_dœ
 = 
´og
 ? 
DMA_BIDIRECTIONAL
 : 
DMA_FROM_DEVICE
;

1696 
dp
->
rx_dma_off
 = 
´og
 ? 
XDP_PACKET_HEADROOM
 - 
Â
->dp.
rx_off£t
 : 0;

1699 
”r
 = 
	`nå_Ãt_ršg_»cÚfig
(
Â
, 
dp
, 
	`com·t__xdp_exù
(
bpf
));

1700 ià(
”r
)

1701  
”r
;

1703 
	`xdp_©chm’t_£tup
(&
Â
->
xdp
, 
bpf
);

1705 
	}
}

1707 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 18, 0)

1708 
	$nå_Ãt_xdp_£tup_hw
(
nå_Ãt
 *
Â
, 
Ãtdev_bpf
 *
bpf
)

1710 
”r
;

1712 ià(!
	`xdp_©chm’t_æags_ok
(&
Â
->
xdp_hw
, 
bpf
))

1713  -
EBUSY
;

1715 
”r
 = 
	`nå_­p_xdp_ofæßd
(
Â
->
­p
,‚n, 
bpf
->
´og
, bpf->
exck
);

1716 ià(
”r
)

1717  
”r
;

1719 
	`xdp_©chm’t_£tup
(&
Â
->
xdp_hw
, 
bpf
);

1721 
	}
}

1724 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 15, 0)

1725 
	$nå_Ãt_xdp
(
Ãt_deviû
 *
Ãtdev
, 
Ãtdev_xdp
 *
xdp
)

1727 
	$nå_Ãt_xdp
(
Ãt_deviû
 *
Ãtdev
, 
Ãtdev_bpf
 *
xdp
)

1730 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1732 
xdp
->
commªd
) {

1733 
XDP_SETUP_PROG
:

1734  
	`nå_Ãt_xdp_£tup_drv
(
Â
, 
xdp
);

1735 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 18, 0)

1736 
XDP_SETUP_PROG_HW
:

1737  
	`nå_Ãt_xdp_£tup_hw
(
Â
, 
xdp
);

1739 
XDP_QUERY_PROG
:

1740 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 19, 0)

1741 ià(
Â
->
xdp
.
´og
)

1742  
	`xdp_©chm’t_qu”y
(&
Â
->
xdp
, xdp);

1744  
	`xdp_©chm’t_qu”y
(&
Â
->
xdp
, xdp);

1745 
XDP_QUERY_PROG_HW
:

1747  
	`xdp_©chm’t_qu”y
(&
Â
->
xdp_hw
, 
xdp
);

1749 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 16, 0)

1750  
	`nå_­p_bpf
(
Â
->
­p
,‚n, 
xdp
);

1752  -
EINVAL
;

1755 
	}
}

1758 
	$nå_Ãt_£t_mac_add»ss
(
Ãt_deviû
 *
Ãtdev
, *
addr
)

1760 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1761 
sockaddr
 *
§ddr
 = 
addr
;

1762 
”r
;

1764 
”r
 = 
	`‘h_´•¬e_mac_addr_chªge
(
Ãtdev
, 
addr
);

1765 ià(
”r
)

1766  
”r
;

1768 
	`nå_Ãt_wr™e_mac_addr
(
Â
, 
§ddr
->
§_d©a
);

1770 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_MACADDR
);

1771 ià(
”r
)

1772  
”r
;

1774 
	`‘h_comm™_mac_addr_chªge
(
Ãtdev
, 
addr
);

1777 
	}
}

1779 cÚ¡ 
Ãt_deviû_Ýs
 
	gnå_nfd3_Ãtdev_Ýs
 = {

1780 .
ndo_š™
 = 
nå_­p_ndo_š™
,

1781 .
	gndo_unš™
 = 
nå_­p_ndo_unš™
,

1782 .
	gndo_Ý’
 = 
nå_Ãt_Ãtdev_Ý’
,

1783 .
	gndo_¡Ý
 = 
nå_Ãt_Ãtdev_þo£
,

1784 .
	gndo_¡¬t_xm™
 = 
nå_nfd3_tx
,

1785 .
	gndo_g‘_¡©s64
 = 
nå_Ãt_¡©64
,

1786 .
	gndo_vÏn_rx_add_vid
 = 
nå_Ãt_vÏn_rx_add_vid
,

1787 .
	gndo_vÏn_rx_kžl_vid
 = 
nå_Ãt_vÏn_rx_kžl_vid
,

1788 #ià
COMPAT__NEED_NDO_POLL_CONTROLLER


1789 .
	gndo_pÞl_cÚŒÞËr
 = 
nå_Ãt_ÃÞl
,

1791 .
	gndo_£t_vf_mac
 = 
nå_­p_£t_vf_mac
,

1792 #ià
VER_IS_NON_RHEL
 || 
VER_RHEL_LT
(7, 4è|| 
VER_RHEL_GE
(8, 0)

1793 .
	gndo_£t_vf_vÏn
 = 
nå_­p_£t_vf_vÏn
,

1795 .
	gndo_£t_vf_¥oofchk
 = 
nå_­p_£t_vf_¥oofchk
,

1796 .
	gndo_g‘_vf_cÚfig
 = 
nå_­p_g‘_vf_cÚfig
,

1797 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 11, 0)

1798 .
	gndo_£t_vf_lšk_¡©e
 = 
nå_­p_£t_vf_lšk_¡©e
,

1800 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 13, 0)

1801 .
	gndo_£tup_tc
 = 
nå_pÜt_£tup_tc
,

1803 .
	gndo_tx_timeout
 = 
nå_Ãt_tx_timeout
,

1804 .
	gndo_£t_rx_mode
 = 
nå_Ãt_£t_rx_mode
,

1805 #ià
VER_IS_NON_RHEL
 || 
VER_RHEL_LT
(7, 5è|| 
VER_RHEL_GE
(8, 0)

1806 .
	gndo_chªge_mtu
 = 
nå_Ãt_chªge_mtu
,

1807 #–ià
VER_RHEL_GE
(7, 5)

1808 .
	gndo_chªge_mtu_rh74
 = 
nå_Ãt_chªge_mtu
,

1810 .
	gndo_£t_mac_add»ss
 = 
nå_Ãt_£t_mac_add»ss
,

1811 .
	gndo_£t_ã©u»s
 = 
nå_Ãt_£t_ã©u»s
,

1812 #ià
COMPAT__HAVE_NDO_FEATURES_CHECK


1813 .
	gndo_ã©u»s_check
 = 
nå_Ãt_ã©u»s_check
,

1815 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 1, 0)

1816 .
	gndo_g‘_phys_pÜt_Çme
 = 
nå_Ãt_g‘_phys_pÜt_Çme
,

1818 #ià(
VER_IS_NON_RHEL
 || 
VER_RHEL_GE
(8, 0)è&& 
COMPAT__HAVE_UDP_OFFLOAD


1819 .
	gndo_udp_tuÂ–_add
 = 
nå_Ãt_add_vxÏn_pÜt
,

1820 .
	gndo_udp_tuÂ–_d–
 = 
nå_Ãt_d–_vxÏn_pÜt
,

1821 #–ià
VER_IS_NON_RHEL
 && 
COMPAT__HAVE_VXLAN_OFFLOAD


1822 .
	gndo_add_vxÏn_pÜt
 = 
nå_Ãt_add_vxÏn_pÜt
,

1823 .
	gndo_d–_vxÏn_pÜt
 = 
nå_Ãt_d–_vxÏn_pÜt
,

1825 #ià
COMPAT__HAVE_XDP


1826 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 15, 0)

1827 .
	gndo_bpf
 = 
nå_Ãt_xdp
,

1829 .
	gndo_xdp
 = 
nå_Ãt_xdp
,

1831 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

1832 .
	gndo_g‘_pÜt_·»Á_id
 = 
nå_pÜt_g‘_pÜt_·»Á_id
,

1833 #ifdeà
CONFIG_NFP_NET_PF


1834 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 2, 0)

1835 .
	gndo_g‘_devlšk
 = 
nå_devlšk_g‘_devlšk
,

1837 .
	gndo_g‘_devlšk_pÜt
 = 
nå_devlšk_g‘_devlšk_pÜt
,

1842 #ià
VER_RHEL_GE
(7, 3è&& 
VER_RHEL_LT
(8, 0)

1843 .
	gndo_size
 = (
nå_nfd3_Ãtdev_Ýs
),

1844 .
	gex‹nded
 = {

1845 #ià
VER_RHEL_GE
(7, 4)

1846 .
ndo_£t_vf_vÏn
 = 
nå_­p_£t_vf_vÏn
,

1847 .
	gndo_g‘_phys_pÜt_Çme
 = 
nå_Ãt_g‘_phys_pÜt_Çme
,

1848 .
	gndo_udp_tuÂ–_add
 = 
nå_Ãt_add_vxÏn_pÜt
,

1849 .
	gndo_udp_tuÂ–_d–
 = 
nå_Ãt_d–_vxÏn_pÜt
,

1855 cÚ¡ 
Ãt_deviû_Ýs
 
	gnå_nfdk_Ãtdev_Ýs
 = {

1856 .
ndo_š™
 = 
nå_­p_ndo_š™
,

1857 .
	gndo_unš™
 = 
nå_­p_ndo_unš™
,

1858 .
	gndo_Ý’
 = 
nå_Ãt_Ãtdev_Ý’
,

1859 .
	gndo_¡Ý
 = 
nå_Ãt_Ãtdev_þo£
,

1860 .
	gndo_¡¬t_xm™
 = 
nå_nfdk_tx
,

1861 .
	gndo_g‘_¡©s64
 = 
nå_Ãt_¡©64
,

1862 .
	gndo_vÏn_rx_add_vid
 = 
nå_Ãt_vÏn_rx_add_vid
,

1863 .
	gndo_vÏn_rx_kžl_vid
 = 
nå_Ãt_vÏn_rx_kžl_vid
,

1864 #ià
COMPAT__NEED_NDO_POLL_CONTROLLER


1865 .
	gndo_pÞl_cÚŒÞËr
 = 
nå_Ãt_ÃÞl
,

1867 .
	gndo_£t_vf_mac
 = 
nå_­p_£t_vf_mac
,

1868 #ià
VER_IS_NON_RHEL
 || 
VER_RHEL_LT
(7, 4)

1869 .
	gndo_£t_vf_vÏn
 = 
nå_­p_£t_vf_vÏn
,

1871 .
	gndo_£t_vf_¥oofchk
 = 
nå_­p_£t_vf_¥oofchk
,

1872 .
	gndo_g‘_vf_cÚfig
 = 
nå_­p_g‘_vf_cÚfig
,

1873 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 11, 0)

1874 .
	gndo_£t_vf_lšk_¡©e
 = 
nå_­p_£t_vf_lšk_¡©e
,

1876 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 13, 0)

1877 .
	gndo_£tup_tc
 = 
nå_pÜt_£tup_tc
,

1879 .
	gndo_tx_timeout
 = 
nå_Ãt_tx_timeout
,

1880 .
	gndo_£t_rx_mode
 = 
nå_Ãt_£t_rx_mode
,

1881 #ià
VER_IS_NON_RHEL
 || 
VER_RHEL_LT
(7, 5è|| 
VER_RHEL_GE
(8, 0)

1882 .
	gndo_chªge_mtu
 = 
nå_Ãt_chªge_mtu
,

1883 #–ià
VER_RHEL_GE
(7, 5)

1884 .
	gndo_chªge_mtu_rh74
 = 
nå_Ãt_chªge_mtu
,

1886 .
	gndo_£t_mac_add»ss
 = 
nå_Ãt_£t_mac_add»ss
,

1887 .
	gndo_£t_ã©u»s
 = 
nå_Ãt_£t_ã©u»s
,

1888 #ià
COMPAT__HAVE_NDO_FEATURES_CHECK


1889 .
	gndo_ã©u»s_check
 = 
nå_Ãt_ã©u»s_check
,

1891 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 1, 0)

1892 .
	gndo_g‘_phys_pÜt_Çme
 = 
nå_Ãt_g‘_phys_pÜt_Çme
,

1894 #ià(
VER_IS_NON_RHEL
 || 
VER_RHEL_GE
(8, 0)è&& 
COMPAT__HAVE_UDP_OFFLOAD


1895 .
	gndo_udp_tuÂ–_add
 = 
nå_Ãt_add_vxÏn_pÜt
,

1896 .
	gndo_udp_tuÂ–_d–
 = 
nå_Ãt_d–_vxÏn_pÜt
,

1897 #–ià
VER_IS_NON_RHEL
 && 
COMPAT__HAVE_VXLAN_OFFLOAD


1898 .
	gndo_add_vxÏn_pÜt
 = 
nå_Ãt_add_vxÏn_pÜt
,

1899 .
	gndo_d–_vxÏn_pÜt
 = 
nå_Ãt_d–_vxÏn_pÜt
,

1901 #ià
COMPAT__HAVE_XDP


1902 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 15, 0)

1903 .
	gndo_bpf
 = 
nå_Ãt_xdp
,

1905 .
	gndo_xdp
 = 
nå_Ãt_xdp
,

1907 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

1908 .
	gndo_g‘_pÜt_·»Á_id
 = 
nå_pÜt_g‘_pÜt_·»Á_id
,

1909 #ifdeà
CONFIG_NFP_NET_PF


1910 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 2, 0)

1911 .
	gndo_g‘_devlšk
 = 
nå_devlšk_g‘_devlšk
,

1913 .
	gndo_g‘_devlšk_pÜt
 = 
nå_devlšk_g‘_devlšk_pÜt
,

1918 #ià
VER_RHEL_GE
(7, 3è&& 
VER_RHEL_LT
(8, 0)

1919 .
	gndo_size
 = (
nå_nfdk_Ãtdev_Ýs
),

1920 .
	gex‹nded
 = {

1921 #ià
VER_RHEL_GE
(7, 4)

1922 .
ndo_£t_vf_vÏn
 = 
nå_­p_£t_vf_vÏn
,

1923 .
	gndo_g‘_phys_pÜt_Çme
 = 
nå_Ãt_g‘_phys_pÜt_Çme
,

1924 .
	gndo_udp_tuÂ–_add
 = 
nå_Ãt_add_vxÏn_pÜt
,

1925 .
	gndo_udp_tuÂ–_d–
 = 
nå_Ãt_d–_vxÏn_pÜt
,

1935 
	$nå_Ãt_šfo
(
nå_Ãt
 *
Â
)

1937 
	`Â_šfo
(
Â
, "Netronome NFP-6xxx %sNetdev: TxQs=%d/%d RxQs=%d/%d\n",

1938 
Â
->
dp
.
is_vf
 ? "VF " : "",

1939 
Â
->
dp
.
num_tx_ršgs
,‚n->
max_tx_ršgs
,

1940 
Â
->
dp
.
num_rx_ršgs
,‚n->
max_rx_ršgs
);

1941 
	`Â_šfo
(
Â
, "VER: %d.%d.%d.%d, Maximum supported MTU: %d\n",

1942 
Â
->
fw_v”
.
dp_»sv
,‚n->fw_v”.
þass
,

1943 
Â
->
fw_v”
.
majÜ
,‚n->fw_v”.
mšÜ
,

1944 
Â
->
max_mtu
);

1945 
	`Â_šfo
(
Â
, "CAP: %#x %s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",

1946 
Â
->
ÿp
,

1947 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_PROMISC
 ? "PROMISC " : "",

1948 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_L2BC
 ? "L2BCFILT " : "",

1949 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_L2MC
 ? "L2MCFILT " : "",

1950 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RXCSUM
 ? "RXCSUM " : "",

1951 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_TXCSUM
 ? "TXCSUM " : "",

1952 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RXVLAN
 ? "RXVLAN " : "",

1953 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_TXVLAN
 ? "TXVLAN " : "",

1954 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_SCATTER
 ? "SCATTER " : "",

1955 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_GATHER
 ? "GATHER " : "",

1956 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO
 ? "TSO1 " : "",

1957 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO2
 ? "TSO2 " : "",

1958 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS
 ? "RSS1 " : "",

1959 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS2
 ? "RSS2 " : "",

1960 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_CTAG_FILTER
 ? "CTAG_FILTER " : "",

1961 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_MSIXAUTO
 ? "AUTOMASK " : "",

1962 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_IRQMOD
 ? "IRQMOD " : "",

1963 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_TXRWB
 ? "TXRWB " : "",

1964 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_VXLAN
 ? "VXLAN " : "",

1965 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_NVGRE
 ? "NVGRE " : "",

1966 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_CSUM_COMPLETE
 ?

1968 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LIVE_ADDR
 ? "LIVE_ADDR " : "",

1969 
	`nå_­p_exŒa_ÿp
(
Â
->
­p
,‚n));

1970 
	}
}

1987 
nå_Ãt
 *

1988 
	$nå_Ãt_®loc
(
pci_dev
 *
pdev
, cÚ¡ 
nå_dev_šfo
 *
dev_šfo
,

1989 
__iomem
 *
ù¾_b¬
, 
boÞ
 
Ãeds_Ãtdev
,

1990 
max_tx_ršgs
, 
max_rx_ršgs
)

1992 
nå_Ãt
 *
Â
;

1993 
”r
;

1995 ià(
Ãeds_Ãtdev
) {

1996 
Ãt_deviû
 *
Ãtdev
;

1998 
Ãtdev
 = 
	`®loc_‘h”dev_mqs
((
nå_Ãt
),

1999 
max_tx_ršgs
, 
max_rx_ršgs
);

2000 ià(!
Ãtdev
)

2001  
	`ERR_PTR
(-
ENOMEM
);

2003 
	`SET_NETDEV_DEV
(
Ãtdev
, &
pdev
->
dev
);

2004 
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

2005 
Â
->
dp
.
Ãtdev
 =‚etdev;

2007 
Â
 = 
	`vz®loc
((*nn));

2008 ià(!
Â
)

2009  
	`ERR_PTR
(-
ENOMEM
);

2012 
Â
->
dp
.
dev
 = &
pdev
->dev;

2013 
Â
->
dp
.
ù¾_b¬
 = ctrl_bar;

2014 
Â
->
dev_šfo
 = dev_info;

2015 
Â
->
pdev
 =…dev;

2016 
	`nå_Ãt_g‘_fw_v”siÚ
(&
Â
->
fw_v”
, 
ù¾_b¬
);

2018 
	`FIELD_GET
(
NFP_NET_CFG_VERSION_DP
, 
Â
->
fw_v”
.
dp_»sv
)) {

2019 
NFP_NET_CFG_VERSION_DP_NFD3
:

2020 
Â
->
dp
.
Ýs
 = &
nå_nfd3_Ýs
;

2022 
NFP_NET_CFG_VERSION_DP_NFDK
:

2023 ià(
Â
->
fw_v”
.
majÜ
 < 5) {

2024 
	`dev_”r
(&
pdev
->
dev
,

2026 
Â
->
fw_v”
.
majÜ
);

2027 
”r
 = -
EINVAL
;

2028 
”r_ä“_Â
;

2030 
Â
->
dp
.
Ýs
 = &
nå_nfdk_Ýs
;

2033 
”r
 = -
EINVAL
;

2034 
”r_ä“_Â
;

2037 
Â
->
max_tx_ršgs
 = max_tx_rings;

2038 
Â
->
max_rx_ršgs
 = max_rx_rings;

2040 
Â
->
dp
.
num_tx_ršgs
 = 
	`mš_t
(,

2041 
max_tx_ršgs
, 
	`num_Úlše_ýus
());

2042 
Â
->
dp
.
num_rx_ršgs
 = 
	`mš_t
(, 
max_rx_ršgs
,

2043 
	`Ãtif_g‘_num_deçuÉ_rss_queues
());

2045 
Â
->
dp
.
num_r_vecs
 = 
	`max
Òn->dp.
num_tx_ršgs
,‚n->dp.
num_rx_ršgs
);

2046 
Â
->
dp
.
num_r_vecs
 = 
	`mš_t
(,

2047 
Â
->
dp
.
num_r_vecs
, 
	`num_Úlše_ýus
());

2049 
Â
->
dp
.
txd_út
 = 
NFP_NET_TX_DESCS_DEFAULT
;

2050 
Â
->
dp
.
rxd_út
 = 
NFP_NET_RX_DESCS_DEFAULT
;

2052 
	`¥š_lock_š™
(&
Â
->
»cÚfig_lock
);

2053 
	`¥š_lock_š™
(&
Â
->
lšk_¡©us_lock
);

2055 
	`tim”_£tup
(&
Â
->
»cÚfig_tim”
, 
nå_Ãt_»cÚfig_tim”
, 0);

2057 
”r
 = 
	`nå_Ãt_Žv_ÿps_·r£
(&
Â
->
pdev
->
dev
,‚n->
dp
.
ù¾_b¬
,

2058 &
Â
->
Žv_ÿps
);

2059 ià(
”r
)

2060 
”r_ä“_Â
;

2062  
Â
;

2064 
”r_ä“_Â
:

2065 ià(
Â
->
dp
.
Ãtdev
)

2066 
	`ä“_Ãtdev
(
Â
->
dp
.
Ãtdev
);

2068 
	`vä“
(
Â
);

2069  
	`ERR_PTR
(
”r
);

2070 
	}
}

2076 
	$nå_Ãt_ä“
(
nå_Ãt
 *
Â
)

2078 
	`WARN_ON
(
	`tim”_³ndšg
(&
Â
->
»cÚfig_tim”
è||‚n->
»cÚfig_po¡ed
);

2079 #ià
COMPAT__HAVE_XDP
 && 
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 16, 0)

2080 ià(
Â
->
xdp
.
´og
)

2081 
	`bpf_´og_put
(
Â
->
xdp
.
´og
);

2084 ià(
Â
->
dp
.
Ãtdev
)

2085 
	`ä“_Ãtdev
(
Â
->
dp
.
Ãtdev
);

2087 
	`vä“
(
Â
);

2088 
	}
}

2096 
	$nå_Ãt_rss_key_sz
(
nå_Ãt
 *
Â
)

2098 
Â
->
rss_hfunc
) {

2099 
ETH_RSS_HASH_TOP
:

2100  
NFP_NET_CFG_RSS_KEY_SZ
;

2101 
ETH_RSS_HASH_XOR
:

2103 
ETH_RSS_HASH_CRC32
:

2107 
	`Â_w¬n
(
Â
, "UnknowÀhash funùiÚ: %u\n",‚n->
rss_hfunc
);

2109 
	}
}

2115 
	$nå_Ãt_rss_š™
(
nå_Ãt
 *
Â
)

2117 
func_b™
, 
rss_ÿp_hfunc
;

2118 
u32
 
»g
;

2121 
»g
 = 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_RSS_CAP
);

2122 
rss_ÿp_hfunc
 = 
	`FIELD_GET
(
NFP_NET_CFG_RSS_CAP_HFUNC
, 
»g
);

2123 ià(!
rss_ÿp_hfunc
)

2124 
rss_ÿp_hfunc
 = 
	`FIELD_GET
(
NFP_NET_CFG_RSS_CAP_HFUNC
,

2125 
NFP_NET_CFG_RSS_TOEPLITZ
);

2127 
func_b™
 = 
	`fšd_fœ¡_b™
(&
rss_ÿp_hfunc
, 
NFP_NET_CFG_RSS_HFUNCS
);

2128 ià(
func_b™
 =ð
NFP_NET_CFG_RSS_HFUNCS
) {

2129 
	`dev_w¬n
(
Â
->
dp
.
dev
,

2131 
func_b™
 = 
ETH_RSS_HASH_TOP_BIT
;

2133 
Â
->
rss_hfunc
 = 1 << 
func_b™
;

2135 
	`Ãtdev_rss_key_fžl
(
Â
->
rss_key
, 
	`nå_Ãt_rss_key_sz
(nn));

2137 
	`nå_Ãt_rss_š™_™bl
(
Â
);

2140 
Â
->
rss_cfg
 = 
NFP_NET_CFG_RSS_IPV4_TCP
 |

2141 
NFP_NET_CFG_RSS_IPV6_TCP
 |

2142 
	`FIELD_PREP
(
NFP_NET_CFG_RSS_HFUNC
, 
Â
->
rss_hfunc
) |

2143 
NFP_NET_CFG_RSS_MASK
;

2144 
	}
}

2150 
	$nå_Ãt_œqmod_š™
(
nå_Ãt
 *
Â
)

2152 
Â
->
rx_cßËsû_u£cs
 = 50;

2153 
Â
->
rx_cßËsû_max_äames
 = 64;

2154 
Â
->
tx_cßËsû_u£cs
 = 50;

2155 
Â
->
tx_cßËsû_max_äames
 = 64;

2156 
	}
}

2158 
	$nå_Ãt_Ãtdev_š™
(
nå_Ãt
 *
Â
)

2160 
Ãt_deviû
 *
Ãtdev
 = 
Â
->
dp
.netdev;

2162 
	`nå_Ãt_wr™e_mac_addr
(
Â
,‚n->
dp
.
Ãtdev
->
dev_addr
);

2164 
Ãtdev
->
mtu
 = 
Â
->
dp
.mtu;

2172 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LIVE_ADDR
)

2173 
Ãtdev
->
´iv_æags
 |ð
IFF_LIVE_ADDR_CHANGE
;

2175 
Ãtdev
->
hw_ã©u»s
 = 
NETIF_F_HIGHDMA
;

2176 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RXCSUM_ANY
) {

2177 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_RXCSUM
;

2178 
Â
->
dp
.
ù¾
 |ðÂ->
ÿp
 & 
NFP_NET_CFG_CTRL_RXCSUM_ANY
;

2180 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_TXCSUM
) {

2181 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_IP_CSUM
 | 
NETIF_F_IPV6_CSUM
;

2182 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_TXCSUM
;

2184 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_GATHER
) {

2185 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_SG
;

2186 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_GATHER
;

2188 ià((
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO
 &&‚n->
fw_v”
.
majÜ
 > 2) ||

2189 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO2
) {

2190 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_TSO
 | 
NETIF_F_TSO6
;

2191 
Â
->
dp
.
ù¾
 |ðÂ->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO2
 ?:

2192 
NFP_NET_CFG_CTRL_LSO
;

2194 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
)

2195 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_RXHASH
;

2196 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_VXLAN
) {

2197 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO
)

2198 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_GSO_UDP_TUNNEL
;

2199 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_VXLAN
;

2201 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_NVGRE
) {

2202 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO
)

2203 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_GSO_GRE
;

2204 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_NVGRE
;

2206 ià(
Â
->
ÿp
 & (
NFP_NET_CFG_CTRL_VXLAN
 | 
NFP_NET_CFG_CTRL_NVGRE
))

2207 
Ãtdev
->
hw_’c_ã©u»s
 =‚‘dev->
hw_ã©u»s
;

2209 
Ãtdev
->
vÏn_ã©u»s
 =‚‘dev->
hw_ã©u»s
;

2211 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RXVLAN
) {

2212 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_VLAN_CTAG_RX
;

2213 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_RXVLAN
;

2215 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_TXVLAN
) {

2216 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_LSO2
) {

2217 
	`Â_w¬n
(
Â
, "Device‡dvertises both TSO2‡nd TXVLAN. Refusingoƒnable TXVLAN.\n");

2219 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_VLAN_CTAG_TX
;

2220 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_TXVLAN
;

2223 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_CTAG_FILTER
) {

2224 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_VLAN_CTAG_FILTER
;

2225 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_CTAG_FILTER
;

2228 
Ãtdev
->
ã©u»s
 =‚‘dev->
hw_ã©u»s
;

2230 ià(
	`nå_­p_has_tc
(
Â
->
­p
è&&‚n->
pÜt
)

2231 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_TC
;

2234 
Ãtdev
->
ã©u»s
 &ð~(
NETIF_F_TSO
 | 
NETIF_F_TSO6
);

2235 
Â
->
dp
.
ù¾
 &ð~
NFP_NET_CFG_CTRL_LSO_ANY
;

2238 
Â
->
dp
.
Ýs
->
v”siÚ
) {

2239 
NFP_NFD_VER_NFD3
:

2240 
Ãtdev
->
Ãtdev_Ýs
 = &
nå_nfd3_Ãtdev_Ýs
;

2242 
NFP_NFD_VER_NFDK
:

2243 
Ãtdev
->
Ãtdev_Ýs
 = &
nå_nfdk_Ãtdev_Ýs
;

2247 
Ãtdev
->
w©chdog_timeo
 = 
	`m£cs_to_jiff›s
(5 * 1000);

2249 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

2250 
	`SWITCHDEV_SET_OPS
(
Ãtdev
, &
nå_pÜt_sw™chdev_Ýs
);

2252 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 10, 0)

2254 
Ãtdev
->
mš_mtu
 = 
ETH_MIN_MTU
;

2255 
Ãtdev
->
max_mtu
 = 
Â
->max_mtu;

2258 
Ãtdev
->
gso_max_£gs
 = 
NFP_NET_LSO_MAX_SEGS
;

2260 
	`Ãtif_ÿ¼›r_off
(
Ãtdev
);

2262 
	`nå_Ãt_£t_‘htoÞ_Ýs
(
Ãtdev
);

2263 
	}
}

2265 
	$nå_Ãt_»ad_ÿps
(
nå_Ãt
 *
Â
)

2268 
Â
->
ÿp
 = 
	`Â_»adl
Òn, 
NFP_NET_CFG_CAP
);

2269 
Â
->
max_mtu
 = 
	`Â_»adl
Òn, 
NFP_NET_CFG_MAX_MTU
);

2275 
Â
->
dp
.
chašed_m‘ad©a_fÜm©
 =‚n->
fw_v”
.
majÜ
 == 4 ||

2276 !
Â
->
dp
.
Ãtdev
 ||

2277 !(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS
) ||

2278 
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_CHAIN_META
;

2282 ià(
Â
->
dp
.
chašed_m‘ad©a_fÜm©
 &&‚n->
fw_v”
.
majÜ
 != 4)

2283 
Â
->
ÿp
 &ð~
NFP_NET_CFG_CTRL_RSS
;

2286 ià(
Â
->
fw_v”
.
majÜ
 >= 2) {

2287 
u32
 
»g
;

2289 
»g
 = 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_RX_OFFSET
);

2290 ià(
»g
 > 
NFP_NET_MAX_PREPEND
) {

2291 
	`Â_”r
(
Â
, "Inv®id„x off£t: %d\n", 
»g
);

2292  -
EINVAL
;

2294 
Â
->
dp
.
rx_off£t
 = 
»g
;

2296 
Â
->
dp
.
rx_off£t
 = 
NFP_NET_RX_OFFSET
;

2300 
Â
->
ÿp
 &ðÂ->
dp
.
Ýs
->
ÿp_mask
;

2303 ià(!
Â
->
dp
.
Ãtdev
)

2304 
Â
->
ÿp
 &ðÂ->
­p
->
ty³
->
ù¾_ÿp_mask
;

2307 
	}
}

2315 
	$nå_Ãt_š™
(
nå_Ãt
 *
Â
)

2317 
”r
;

2319 
Â
->
dp
.
rx_dma_dœ
 = 
DMA_FROM_DEVICE
;

2321 
”r
 = 
	`nå_Ãt_»ad_ÿps
(
Â
);

2322 ià(
”r
)

2323  
”r
;

2326 ià(!
	`nå_Ãt_is_d©a_vnic
(
Â
è&&‚n->
­p
->
ù¾_mtu
) {

2327 ià(
Â
->
­p
->
ù¾_mtu
 <ðÂ->
max_mtu
) {

2328 
Â
->
dp
.
mtu
 =‚n->
­p
->
ù¾_mtu
;

2330 ià(
Â
->
­p
->
ù¾_mtu
 !ð
NFP_APP_CTRL_MTU_MAX
)

2331 
	`Â_w¬n
(
Â
, "app„equested MTU‡bove max supported %u > %u\n",

2332 
Â
->
­p
->
ù¾_mtu
,‚n->
max_mtu
);

2333 
Â
->
dp
.
mtu
 =‚n->
max_mtu
;

2335 } ià(
Â
->
max_mtu
 < 
NFP_NET_DEFAULT_MTU
) {

2336 
Â
->
dp
.
mtu
 =‚n->
max_mtu
;

2338 
Â
->
dp
.
mtu
 = 
NFP_NET_DEFAULT_MTU
;

2340 
Â
->
dp
.
æ_bufsz
 = 
	`nå_Ãt_ÿlc_æ_bufsz
(&nn->dp);

2342 ià(
	`nå_­p_ù¾_u£s_d©a_vnics
(
Â
->
­p
))

2343 
Â
->
dp
.
ù¾
 |ðÂ->
ÿp
 & 
NFP_NET_CFG_CTRL_CMSG_DATA
;

2345 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
) {

2346 
	`nå_Ãt_rss_š™
(
Â
);

2347 
Â
->
dp
.
ù¾
 |ðÂ->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS2
 ?:

2348 
NFP_NET_CFG_CTRL_RSS
;

2352 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_L2BC
)

2353 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_L2BC
;

2356 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_IRQMOD
) {

2357 
	`nå_Ãt_œqmod_š™
(
Â
);

2358 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_IRQMOD
;

2362 ià(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_TXRWB
)

2363 
Â
->
dp
.
ù¾
 |ð
NFP_NET_CFG_CTRL_TXRWB
;

2365 ià(
Â
->
dp
.
Ãtdev
)

2366 
	`nå_Ãt_Ãtdev_š™
(
Â
);

2369 
Â
->
qý_cfg
 =‚n->
tx_b¬
 + 
NFP_QCP_QUEUE_ADDR_SZ
;

2372 
	`Â_wr™–
(
Â
, 
NFP_NET_CFG_CTRL
, 0);

2373 
	`Â_wr™eq
(
Â
, 
NFP_NET_CFG_TXRS_ENABLE
, 0);

2374 
	`Â_wr™eq
(
Â
, 
NFP_NET_CFG_RXRS_ENABLE
, 0);

2375 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_RING
 |

2376 
NFP_NET_CFG_UPDATE_GEN
);

2377 ià(
”r
)

2378  
”r
;

2380 
	`nå_Ãt_vecs_š™
(
Â
);

2382 ià(!
Â
->
dp
.
Ãtdev
)

2384  
	`»gi¡”_Ãtdev
(
Â
->
dp
.
Ãtdev
);

2385 
	}
}

2391 
	$nå_Ãt_þ—n
(
nå_Ãt
 *
Â
)

2393 ià(!
Â
->
dp
.
Ãtdev
)

2396 
	`uÄegi¡”_Ãtdev
(
Â
->
dp
.
Ãtdev
);

2397 
	`nå_Ãt_»cÚfig_wa™_po¡ed
(
Â
);

2398 
	}
}

	@src/nfp_net_compat.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/‘htoÞ.h
>

8 
	~"nå_­p.h
"

9 
	~"nå_maš.h
"

11 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 1, 0)

12 
	$com·t__nå_Ãt_æash_deviû
(
Ãt_deviû
 *
Ãtdev
,

13 
‘htoÞ_æash
 *
æash
)

15 
nå_­p
 *
­p
;

16 
»t
;

18 ià(
æash
->
»giÚ
 !ð
ETHTOOL_FLASH_ALL_REGIONS
)

19  -
EOPNOTSUPP
;

21 
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

22 ià(!
­p
)

23  -
EOPNOTSUPP
;

25 
	`dev_hÞd
(
Ãtdev
);

26 
	`¹Æ_uÆock
();

27 
»t
 = 
	`nå_æash_upd©e_commÚ
(
­p
->
pf
, 
æash
->
d©a
, 
NULL
);

28 
	`¹Æ_lock
();

29 
	`dev_put
(
Ãtdev
);

31  
»t
;

32 
	}
}

	@src/nfp_net_compat.h

12 #iâdeà
_NFP_NET_COMPAT_H_


13 
	#_NFP_NET_COMPAT_H_


	)

15 
	~"nåcÜe/kcom·t.h
"

17 
	~<asm/b¬r›r.h
>

18 
	~<lšux/b™Ýs.h
>

19 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 18, 0)

20 
	~<lšux/bpf.h
>

22 
	~<lšux/‘htoÞ.h
>

23 
	~<lšux/compž”.h
>

24 
	~<lšux/if_vÏn.h
>

25 
	~<lšux/š‹¼u±.h
>

26 
	~<lšux/.h
>

27 
	~<lšux/v6.h
>

28 
	~<lšux/msi.h
>

29 
	~<lšux/Ãtdev_ã©u»s.h
>

30 
	~<lšux/Ãtdeviû.h
>

31 
	~<lšux/pci.h
>

32 
	~<lšux/skbuff.h
>

33 
	~<lšux/udp.h
>

35 
	~<Ãt/aù_­i.h
>

36 
	~<Ãt/pkt_þs.h
>

37 #ià
COMPAT__HAS_DEVLINK


38 
	~<Ãt/devlšk.h
>

40 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 0, 0)

41 
	~<Ãt/sw™chdev.h
>

45 #ifdeà
ETHTOOL_PHY_FAST_LINK_DOWN_ON


46 #undeà
LINUX_VERSION_CODE


47 
	#LINUX_VERSION_CODE
 
	`KERNEL_VERSION
(5, 2, 0)

	)

50 #ià(
defšed
(
COMPAT__HAVE_METADATA_IP_TUNNEL
) || \

51 
	gLINUX_VERSION_CODE
 >ð
	$KERNEL_VERSION
(5, 1, 0))

52 
	~<Ãt/tc_aù/tc_mœ»d.h
>

53 
	~<Ãt/tc_aù/tc_gaù.h
>

54 
	~<Ãt/tc_aù/tc_vÏn.h
>

55 
	~<Ãt/tc_aù/tc_tuÂ–_key.h
>

56 
	~<Ãt/tc_aù/tc_³d™.h
>

57 
	~<Ãt/tc_aù/tc_csum.h
>

60 
	~"nå_Ãt.h
"

62 
	#COMPAT__HAVE_VXLAN_OFFLOAD
 \

63 (
	`VER_NON_RHEL_GE
(3, 12è|| 
	`VER_RHEL_GE
(7, 4))

	)

64 
	#COMPAT__HAVE_NDO_FEATURES_CHECK
 \

65 (
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 19, 0))

	)

66 
	#COMPAT__HAVE_UDP_OFFLOAD
 \

67 (
	`VER_NON_RHEL_GE
(4, 8è|| 
	`VER_RHEL_GE
(7, 4))

	)

68 
	#COMPAT__HAVE_XDP
 \

69 (
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 8, 0))

	)

70 
	#COMPAT__HAVE_XDP_ADJUST_HEAD
 \

71 (
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 10, 0))

	)

72 
	#COMPAT__HAVE_XDP_METADATA
 \

73 (
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 15, 0))

	)

75 
	#COMPAT__HAVE_SWITCHDEV_ATTRS
 \

76 (
	`VER_NON_RHEL_GE
(4, 5è|| 
	`VER_RHEL_GE
(7, 5))

	)

78 #ifdeà
CONFIG_NET_POLL_CONTROLLER


79 
	#COMPAT__NEED_NDO_POLL_CONTROLLER
 \

80 (
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 20, 0))

	)

82 
	#COMPAT__NEED_NDO_POLL_CONTROLLER
 0

	)

85 #iâdeà
NETIF_F_HW_VLAN_CTAG_RX


86 
	#NETIF_F_HW_VLAN_CTAG_RX
 
NETIF_F_HW_VLAN_RX


	)

88 #iâdeà
NETIF_F_HW_VLAN_CTAG_TX


89 
	#NETIF_F_HW_VLAN_CTAG_TX
 
NETIF_F_HW_VLAN_TX


	)

91 #iâdeà
NETIF_F_HW_VLAN_CTAG_FILTER


92 
	#NETIF_F_HW_VLAN_CTAG_FILTER
 
NETIF_F_HW_VLAN_FILTER


	)

94 #iâdeà
NETIF_F_HW_TC


95 
	#NETIF_F_HW_TC
 
NETDEV_FEATURE_COUNT


	)

97 #iâdeà
ETH_RSS_HASH_NO_CHANGE


98 
	#ETH_RSS_HASH_NO_CHANGE
 0

	)

100 #iâdeà
ETH_RSS_HASH_UNKNOWN


101 
	#ETH_RSS_HASH_UNKNOWN
 0

	)

103 #iâdeà
ETH_RSS_HASH_TOP


104 
	#ETH_RSS_HASH_TOP_BIT
 0

	)

105 
	#ETH_RSS_HASH_TOP
 (1 << 
ETH_RSS_HASH_TOP_BIT
)

	)

107 #iâdeà
ETH_RSS_HASH_XOR


108 
	#ETH_RSS_HASH_FUNCS_COUNT
 1

	)

109 
	#ETH_RSS_HASH_XOR
 2

	)

111 #iâdeà
ETH_RSS_HASH_CRC32


112 
	#ETH_RSS_HASH_CRC32
 4

	)

115 #iâdeà
NETIF_F_CSUM_MASK


116 
	#NETIF_F_CSUM_MASK
 
NETIF_F_ALL_CSUM


	)

119 #iâdeà
SPEED_5000


120 
	#SPEED_5000
 5000

	)

122 #iâdeà
SPEED_25000


123 
	#SPEED_25000
 25000

	)

125 #iâdeà
SPEED_40000


126 
	#SPEED_40000
 40000

	)

128 #iâdeà
SPEED_50000


129 
	#SPEED_50000
 50000

	)

131 #iâdeà
SPEED_100000


132 
	#SPEED_100000
 100000

	)

135 #iâdeà
ETH_MODULE_SFF_8636


136 
	#ETH_MODULE_SFF_8636
 0x3

	)

138 #iâdeà
ETH_MODULE_SFF_8636_LEN


139 
	#ETH_MODULE_SFF_8636_LEN
 256

	)

141 #iâdeà
ETH_MODULE_SFF_8436


142 
	#ETH_MODULE_SFF_8436
 0x4

	)

144 #iâdeà
ETH_MODULE_SFF_8436_LEN


145 
	#ETH_MODULE_SFF_8436_LEN
 256

	)

148 #iâdeà
IANA_VXLAN_UDP_PORT


149 
	#IANA_VXLAN_UDP_PORT
 4789

	)

151 #iâdeà
GENEVE_UDP_PORT


152 
	#GENEVE_UDP_PORT
 6081

	)

155 #iâdeà
XDP_PACKET_HEADROOM


156 
	#XDP_PACKET_HEADROOM
 256

	)

159 #iâdeà
XDP_FLAGS_DRV_MODE


160 
	#XDP_FLAGS_DRV_MODE
 (1 << 2)

	)

162 #iâdeà
XDP_FLAGS_HW_MODE


163 
	#XDP_FLAGS_HW_MODE
 (1 << 3)

	)

166 #iâdeà
XDP_FLAGS_MODES


167 
	#XDP_FLAGS_MODES
 (
XDP_FLAGS_DRV_MODE
 | 
XDP_FLAGS_HW_MODE
)

	)

170 #iâdeà
SWITCHDEV_SET_OPS


171 #ià
COMPAT__HAVE_SWITCHDEV_ATTRS
 && 
	`defšed
(
CONFIG_NET_SWITCHDEV
)

172 
	#SWITCHDEV_SET_OPS
(
Ãtdev
, 
Ýs
è(Ò‘dev)->
sw™chdev_Ýs
 = (Ýs))

	)

174 
	#SWITCHDEV_SET_OPS
(
Ãtdev
, 
Ýs
èdØ{
	}
} 0)

	)

178 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 10, 0)

179 
	#NAPI_POLL_WEIGHT
 64

	)

180 
	#NETIF_F_GSO_GRE
 0

	)

181 
	#NETIF_F_GSO_UDP_TUNNEL
 0

	)

184 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 3, 0)

185 
u32
 
	tÃtdev_ã©u»s_t
;

187 
šlše
 
u32
 
	$‘htoÞ_rxfh_šdœ_deçuÉ
(
u32
 
šdex
, u32 
n_rx_ršgs
)

189  
šdex
 % 
n_rx_ršgs
;

190 
	}
}

193 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

194 
šlše
 
	$‘h_hw_addr_¿ndom
(
Ãt_deviû
 *
dev
)

196 
dev
->
addr_assign_ty³
 |ð
NET_ADDR_RANDOM
;

197 
	`¿ndom_‘h”_addr
(
dev
->
dev_addr
);

198 
	}
}

201 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 7, 0)

202 
šlše
 
	$Ãtif_g‘_num_deçuÉ_rss_queues
()

204  
	`mš_t
(, 8, 
	`num_Úlše_ýus
());

205 
	}
}

208 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 9, 0)

209 
šlše
 

210 
	$Ãtif_£t_xps_queue
(
Ãt_deviû
 *
d
, cÚ¡ 
ýumask
 *
m
, 
u16
 
i
)

213 
	}
}

215 
šlše
 
	$‘h_´•¬e_mac_addr_chªge
(
Ãt_deviû
 *
dev
, *
p
)

217 
sockaddr
 *
addr
 = 
p
;

219 ià(!(
dev
->
´iv_æags
 & 
IFF_LIVE_ADDR_CHANGE
è&& 
	`Ãtif_ruÂšg
(dev))

220  -
EBUSY
;

221 ià(!
	`is_v®id_‘h”_addr
(
addr
->
§_d©a
))

222  -
EADDRNOTAVAIL
;

225 
	}
}

227 
šlše
 
	$‘h_comm™_mac_addr_chªge
(
Ãt_deviû
 *
dev
, *
p
)

229 
sockaddr
 *
addr
 = 
p
;

231 
	`memýy
(
dev
->
dev_addr
, 
addr
->
§_d©a
, 
ETH_ALEN
);

232 
	}
}

235 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 10, 0)

236 
šlše
 
sk_buff
 *

237 
	$ns___vÏn_hwacûl_put_g
(
sk_buff
 *
skb
, 
__be16
 
vÏn_´Ùo
,

238 
u16
 
vÏn_tci
)

240  
	`__vÏn_hwacûl_put_g
(
skb
, 
vÏn_tci
);

241 
	}
}

243 
	#__vÏn_hwacûl_put_g
 
ns___vÏn_hwacûl_put_g


	)

246 #ià
VER_NON_RHEL_LT
(3, 11è|| 
VER_RHEL_LT
(7, 0)

248 
	mIFLA_VF_LINK_STATE_AUTO
,

249 
	mIFLA_VF_LINK_STATE_ENABLE
,

250 
	mIFLA_VF_LINK_STATE_DISABLE
,

251 
	m__IFLA_VF_LINK_STATE_MAX
,

255 #ià
VER_NON_RHEL_LT
(3, 11è|| 
VER_RHEL_LT
(7, 3)

256 
šlše
 
Ãt_deviû
 *
	$Ãtdev_nÙif›r_šfo_to_dev
(*
±r
)

258  
±r
;

259 
	}
}

262 #ià
VER_NON_RHEL_LT
(3, 13è|| 
VER_RHEL_LT
(7, 1)

263 
šlše
 
	$u64_¡©s_š™
(
u64_¡©s_sync
 *
syný
)

265 #ià
BITS_PER_LONG
 =ð32 && 
	`defšed
(
CONFIG_SMP
)

266 
	`£qcouÁ_š™
(&
syný
->
£q
);

268 
	}
}

271 #ià
VER_NON_RHEL_LT
(3, 14)

272 
	ecom·t_pkt_hash_ty³s
 {

273 
	mcom·t_PKT_HASH_TYPE_NONE
,

274 
	mcom·t_PKT_HASH_TYPE_L2
,

275 
	mcom·t_PKT_HASH_TYPE_L3
,

276 
	mcom·t_PKT_HASH_TYPE_L4
,

280 
	#PKT_HASH_TYPE_NONE
 
com·t_PKT_HASH_TYPE_NONE


	)

281 
	#PKT_HASH_TYPE_L2
 
com·t_PKT_HASH_TYPE_L2


	)

282 
	#PKT_HASH_TYPE_L3
 
com·t_PKT_HASH_TYPE_L3


	)

283 
	#PKT_HASH_TYPE_L4
 
com·t_PKT_HASH_TYPE_L4


	)

285 
šlše
 
	$com·t_skb_£t_hash
(
sk_buff
 *
skb
, 
__u32
 
hash
,

286 
com·t_pkt_hash_ty³s
 
ty³
)

288 
skb
->
l4_rxhash
 = (
ty³
 =ð
PKT_HASH_TYPE_L4
);

289 
skb
->
rxhash
 = 
hash
;

290 
	}
}

292 
	#skb_£t_hash
(
s
, 
h
, 
t
è
	`com·t_skb_£t_hash
(s, h,)

	)

295 #ià
VER_NON_RHEL_LT
(3, 14è|| 
VER_RHEL_LT
(7, 2)

296 
šlše
 
	$dev_cÚsume_skb_ªy
(
sk_buff
 *
skb
)

298 
	`dev_kä“_skb_ªy
(
skb
);

299 
	}
}

302 
šlše
 
	$skb_xm™_mÜe
(
sk_buff
 *
skb
)

304 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 18, 0)

305  
çl£
;

306 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 2, 0)

307  
skb
->
xm™_mÜe
;

309  
	`Ãtdev_xm™_mÜe
();

311 
	}
}

313 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 18, 0)

314 
šlše
 
	$pci_msi_unmask_œq
(
œq_d©a
 *
d©a
)

316 
	`unmask_msi_œq
(
d©a
);

317 
	}
}

320 
šlše
 

321 
	$com·t_šü_checksum_uÂeûs§ry
(
sk_buff
 *
skb
, 
boÞ
 
’ÿp
)

323 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 18, 0)

324 
skb
->
_summed
 = 
CHECKSUM_UNNECESSARY
;

325 
skb
->
’ÿpsuÏtiÚ
 = 
’ÿp
;

327 
	`__skb_šü_checksum_uÂeûs§ry
(
skb
);

329 
	}
}

331 #ià
VER_NON_RHEL_LT
(3, 19è|| 
VER_RHEL_LT
(7, 2)

332 
šlše
 
	$Ãtdev_rss_key_fžl
(*
bufãr
, 
size_t
 
Ën
)

334 
	`g‘_¿ndom_by‹s
(
bufãr
, 
Ën
);

335 
	}
}

337 
šlše
 
	$Çpi_scheduË_œqoff
(
Çpi_¡ruù
 *
n
)

339 
	`Çpi_scheduË
(
n
);

340 
	}
}

342 
šlše
 
	$Çpi_com¶‘e_dÚe
(
Çpi_¡ruù
 *
n
, 
wÜk_dÚe
)

344 
	`Çpi_com¶‘e
(
n
);

345 
	}
}

347 
šlše
 
·ge
 *
	$dev_®loc_·ge
()

349  
	`®loc_·ge
(
GFP_ATOMIC
 | 
__GFP_COLD
 | 
__GFP_NOWARN
);

350 
	}
}

353 #ià
VER_NON_RHEL_LT
(3, 19è|| 
VER_RHEL_LT
(7, 2)

354 
šlše
 
	$skb_put_·dto
(
sk_buff
 *
skb
, 
Ën
)

356 
size
 = 
skb
->
Ën
;

358 ià(
	`uÆik–y
(
size
 < 
Ën
)) {

359 
Ën
 -ð
size
;

360 ià(
	`skb_·d
(
skb
, 
Ën
))

361  -
ENOMEM
;

362 
	`__skb_put
(
skb
, 
Ën
);

365 
	}
}

368 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 19, 0)

369 
	#Çpi_®loc_äag
(
x
è
	`Ãtdev_®loc_äag
(x)

	)

372 #ià
VER_NON_RHEL_LT
(3, 19è|| 
VER_RHEL_LT
(7, 3)

373 
	sÃtdev_phys_™em_id
 {

374 
	mid
[32];

375 
	mid_Ën
;

379 #ià
VER_NON_RHEL_LT
(4, 0è|| 
VER_RHEL_LT
(7, 2)

380 
	#skb_vÏn_g_´e£Á
(
skb
è
	`vÏn_tx_g_´e£Á
(skb)

	)

381 
	#skb_vÏn_g_g‘
(
skb
è
	`vÏn_tx_g_g‘
(skb)

	)

384 #ià
VER_NON_RHEL_LT
(4, 1)

385 
šlše
 
Ãtdev_ã©u»s_t
 
	$vÏn_ã©u»s_check
(cÚ¡ 
sk_buff
 *
skb
,

386 
Ãtdev_ã©u»s_t
 
ã©u»s
)

388  
ã©u»s
;

389 
	}
}

392 #ià!
COMPAT__HAVE_NDO_FEATURES_CHECK


393 
šlše
 
boÞ
 
	$com·t_is_vxÏn
(
sk_buff
 *
skb
, 
u8
 
l4_hdr
)

397 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 18, 0)

398 
skb
->
šÃr_´ÙocÞ
 !ð
	`htÚs
(
ETH_P_TEB
) ||

399 
skb
->
šÃr_´ÙocÞ_ty³
 !ð
ENCAP_TYPE_ETHER
 ||

401 
l4_hdr
 !ð
IPPROTO_UDP
 ||

402 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 10, 0)

403 
	`skb_šÃr_mac_h—d”
(
skb
è- 
	`skb_Œª¥Üt_h—d”
(skb) !=

404 (
udphdr
) + 8 ||

407  
çl£
;

408  
Œue
;

409 
	}
}

411 
šlše
 
boÞ
 
	$com·t_is_g»p
(
sk_buff
 *
skb
, 
u8
 
l4_hdr
)

414 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 11, 0)

415 
skb
->
šÃr_´ÙocÞ
 !ð
	`htÚs
(
ETH_P_TEB
) ||

417 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 18, 0)

418 
skb
->
šÃr_´ÙocÞ_ty³
 !ð
ENCAP_TYPE_ETHER
 ||

420 
l4_hdr
 !ð
IPPROTO_GRE
)

421  
çl£
;

422  
Œue
;

423 
	}
}

426 #ià
VER_NON_RHEL_LT
(4, 2è|| 
VER_RHEL_LT
(7, 3)

427 
šlše
 
	$skb_ä“_äag
(*
addr
)

429 
	`put_·ge
(
	`vœt_to_h—d_·ge
(
addr
));

430 
	}
}

433 #ià
VER_NON_RHEL_LT
(4, 2è|| 
VER_RHEL_LT
(7, 5)

434 
	esw™chdev_©Œ_id
 {

435 
	mSWITCHDEV_ATTR_ID_UNDEFINED
,

436 
	mSWITCHDEV_ATTR_ID_PORT_PARENT_ID
,

439 
	ssw™chdev_©Œ
 {

440 
sw™chdev_©Œ_id
 
	mid
;

442 
Ãtdev_phys_™em_id
 
	mµid
;

443 } 
	mu
;

446 
	ssw™chdev_Ýs
 {

447 (*
	msw™chdev_pÜt_©Œ_g‘
)(
Ãt_deviû
 *
	mdev
,

448 
sw™chdev_©Œ
 *
	m©Œ
);

450 #–ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 4, 0)

451 
	#SWITCHDEV_ATTR_ID_PORT_PARENT_ID
 
SWITCHDEV_ATTR_PORT_PARENT_ID


	)

454 
šlše
 

455 
	$com·t_ndo_ã©u»s_check
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
)

457 #ià!
COMPAT__HAVE_NDO_FEATURES_CHECK


458 
u8
 
l4_hdr
;

460 ià(!
skb
->
’ÿpsuÏtiÚ
)

464 ià(
	`skb_is_gso
(
skb
)) {

465 
u32
 
hd¾’
;

467 
hd¾’
 = 
	`skb_šÃr_Œª¥Üt_h—d”
(
skb
è- skb->
d©a
 +

468 
	`šÃr_tý_hd¾’
(
skb
);

470 ià(
	`uÆik–y
(
hd¾’
 > 
NFP_NET_LSO_MAX_HDR_SZ
)) {

471 
	`Â_dp_w¬n
(&
Â
->
dp
, "L4 offsetoo†arge for TSO!\n");

477 ià(!(
Â
->
dp
.
ù¾
 & 
NFP_NET_CFG_CTRL_TXCSUM
) ||

478 
skb
->
_summed
 !ð
CHECKSUM_PARTIAL
)

481 
	`vÏn_g‘_´ÙocÞ
(
skb
)) {

482 
	`htÚs
(
ETH_P_IP
):

483 
l4_hdr
 = 
	`_hdr
(
skb
)->
´ÙocÞ
;

485 
	`htÚs
(
ETH_P_IPV6
):

486 
l4_hdr
 = 
	`v6_hdr
(
skb
)->
Ãxthdr
;

489 
	`Â_dp_w¬n
(&
Â
->
dp
, "non-IP…acket for checksumming!\n");

493 ià(!
	`com·t_is_vxÏn
(
skb
, 
l4_hdr
è&& !
	`com·t_is_g»p
(skb,†4_hdr)) {

494 
	`Â_dp_w¬n
(&
Â
->
dp
, "checksum on unsupportedunnelype!\n");

500 
	}
}

502 #ià
COMPAT__HAVE_VXLAN_OFFLOAD
 && !
COMPAT__HAVE_UDP_OFFLOAD


503 
	~<Ãt/vxÏn.h
>

505 
	eudp_·r§bË_tuÂ–_ty³
 {

506 
	mUDP_TUNNEL_TYPE_VXLAN
,

509 
	sudp_tuÂ–_šfo
 {

510 
	mty³
;

511 
__be16
 
	mpÜt
;

514 
šlše
 
	$udp_tuÂ–_g‘_rx_šfo
(
Ãt_deviû
 *
Ãtdev
)

516 
	`vxÏn_g‘_rx_pÜt
(
Ãtdev
);

517 
	}
}

520 #ià
VER_NON_RHEL_LT
(4, 5è|| 
VER_RHEL_LT
(7, 3)

521 
šlše
 
	$skb_šÃr_Œª¥Üt_off£t
(cÚ¡ 
sk_buff
 *
skb
)

523  
	`skb_šÃr_Œª¥Üt_h—d”
(
skb
è- skb->
d©a
;

524 
	}
}

527 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 6, 0)

528 
	scom·t__‘htoÞ_lšk_k£‰šgs
 {

529 
‘htoÞ_cmd
 
	mba£
;

532 
	#‘htoÞ_lšk_k£‰šgs
 
com·t__‘htoÞ_lšk_k£‰šgs


	)

534 
šlše
 
u32


535 
	$com·t__‘htoÞ_cmd_¥“d_g‘
(cÚ¡ 
‘htoÞ_lšk_k£‰šgs
 *
cmd
)

537  
	`‘htoÞ_cmd_¥“d
(&
cmd
->
ba£
);

538 
	}
}

540 
šlše
 

541 
	$com·t__‘htoÞ_cmd_¥“d_£t
(
‘htoÞ_lšk_k£‰šgs
 *
cmd
, 
u32
 
¥“d
)

543 
	`‘htoÞ_cmd_¥“d_£t
(&
cmd
->
ba£
, 
¥“d
);

544 
	}
}

546 #undeà
‘htoÞ_lšk_k£‰šgs_add_lšk_mode


547 
	#‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
cmd
, 
memb
, 
ty³
) \

548 (
cmd
)->
ba£
.
memb
 |ð
SUPPORTED_
 ## 
ty³


	)

550 
šlše
 
u32


551 
	$com·t__‘htoÞ_cmd_¥“d_g‘
(cÚ¡ 
‘htoÞ_lšk_k£‰šgs
 *
cmd
)

553  
cmd
->
ba£
.
¥“d
;

554 
	}
}

556 
šlše
 

557 
	$com·t__‘htoÞ_cmd_¥“d_£t
(
‘htoÞ_lšk_k£‰šgs
 *
cmd
, 
u32
 
¥“d
)

559 
cmd
->
ba£
.
¥“d
 = speed;

560 
	}
}

563 #iâdeà
IFF_RXFH_CONFIGURED


564 
šlše
 
boÞ
 
	$Ãtif_is_rxfh_cÚfigu»d
(cÚ¡ 
Ãt_deviû
 *
Ãtdev
)

566  
çl£
;

567 
	}
}

570 #ià
VER_NON_RHEL_LT
(4, 6è|| 
VER_RHEL_LT
(7, 3)

571 
šlše
 
	$·ge_»f_šc
(
·ge
 *page)

573 
	`©omic_šc
(&
·ge
->
_couÁ
);

574 
	}
}

577 #ià
VER_VANILLA_LT
(4, 6è|| 
VER_UBUNTU_LT
(4, 4, 21è|| 
VER_RHEL_LT
(7, 3)

578 
šlše
 
	$Çpi_cÚsume_skb
(
sk_buff
 *
skb
, 
budg‘
)

580 
	`dev_cÚsume_skb_ªy
(
skb
);

581 
	}
}

584 #ià
VER_NON_RHEL_LT
(4, 8è|| 
VER_RHEL_LT
(7, 5)

585 
šlše
 
	$Œaû_devlšk_hwmsg
(*
devlšk
,

586 
boÞ
 
šcomšg
, 
ty³
,

587 cÚ¡ 
u8
 *
buf
, 
size_t
 
Ën
)

589 
	}
}

592 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 9, 0)

593 
šlše
 
	$nå_Ãt_xdp_ofæßd
(
nå_Ãt
 *
Â
, 
bpf_´og
 *
´og
)

595  -
EINVAL
;

596 
	}
}

599 #ià
VER_NON_RHEL_LT
(4, 10è|| 
VER_RHEL_LT
(7, 5)

600 
	#is_tcf_mœ»d_eg»ss_»dœeù
 
is_tcf_mœ»d_»dœeù


	)

602 
šlše
 

603 
	$com·t__Çpi_com¶‘e_dÚe
(
Çpi_¡ruù
 *
n
, 
wÜk_dÚe
)

605 
	`Çpi_com¶‘e_dÚe
(
n
, 
wÜk_dÚe
);

606  
Œue
;

607 
	}
}

608 
	#Çpi_com¶‘e_dÚe
 
com·t__Çpi_com¶‘e_dÚe


	)

611 #ià
VER_NON_RHEL_GE
(4, 11è|| 
VER_RHEL_GE
(7, 5)

612 
	tcom·t__¡©64_»t_t
;

614 
¹Æ_lšk_¡©s64
 *
	tcom·t__¡©64_»t_t
;

616 
šlše
 

617 
	$Œaû_xdp_exû±iÚ
(cÚ¡ 
Ãt_deviû
 *
Ãtdev
,

618 cÚ¡ 
bpf_´og
 *
´og
, 
u32
 
aù
)

620 
	}
}

623 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 12, 0)

624 
	gÃtdev_xdp
;

626 
	#NL_SET_ERR_MSG_MOD
(
—
, 
msg
è
	`´_w¬n
(
KBUILD_MODNAME
 ": " msg)

	)

628 
šlše
 
ÃŽšk_ext_ack
 *
	$com·t__xdp_exù
(
Ãtdev_xdp
 *
xdp
)

630  
NULL
;

631 
	}
}

633 
	#com·t__xdp_exù
(
xdp
è(xdp)->
exck


	)

636 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 13, 0)

637 
	#com·t__xdp_æags
(
xdp
è(xdp)->
æags


	)

639 
šlše
 
u32
 
	$com·t__xdp_æags
(
Ãtdev_xdp
 *
xdp
)

642 
	}
}

645 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 9, 0) && \

646 
	gLINUX_VERSION_CODE
 < 
	$KERNEL_VERSION
(4, 13, 0)

647 
šlše
 

648 
	$tcf_exts_¡©s_upd©e
(cÚ¡ 
tcf_exts
 *
exts
,

649 
u64
 
by‹s
, u64 
·ck‘s
, u64 
Ï¡u£
)

651 #ifdeà
CONFIG_NET_CLS_ACT


652 
i
;

654 
	`´“m±_di§bË
();

656 
i
 = 0; i < 
exts
->
Ä_aùiÚs
; i++) {

657 
tc_aùiÚ
 *
a
 = 
exts
->
aùiÚs
[
i
];

659 
	`tcf_aùiÚ_¡©s_upd©e
(
a
, 
by‹s
, 
·ck‘s
, 
Ï¡u£
);

662 
	`´“m±_’abË
();

664 
	}
}

667 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 14, 0)

668 
	#SFP_SFF8472_COMPLIANCE
 0x5e

	)

671 #ià
VER_NON_RHEL_LT
(4, 14è|| 
VER_RHEL_LT
(7, 5)

672 
	gtc_to_Ãtdev
;

674 
	etc_£tup_ty³
 {

675 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 13, 0)

676 
	m__COMPAT_TC_SETUP_CLSFLOWER
 = 
TC_SETUP_CLSFLOWER
,

677 
	#TC_SETUP_CLSFLOWER
 
__COMPAT_TC_SETUP_CLSFLOWER


	)

679 
	m__COMPAT_tc_£tup_ty³_NONE
,

683 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 15, 0)

684 
šlše
 
	$skb_m‘ad©a_£t
(cÚ¡ 
sk_buff
 *
skb
, 
u8
 
v®ue
)

686 
	}
}

689 #ià
VER_NON_RHEL_LT
(4, 15è|| 
VER_RHEL_LT
(7, 6)

690 
	ttc_£tup_cb_t
(
	ttc_£tup_ty³
 
	tty³
, *
	tty³_d©a
,

691 *
	tcb_´iv
);

693 
šlše
 

694 
	$tc_£tup_cb_egdev_»gi¡”
(cÚ¡ 
Ãt_deviû
 *
dev
, 
tc_£tup_cb_t
 *
cb
,

695 *
cb_´iv
)

698 
	}
}

700 
šlše
 

701 
	$tc_£tup_cb_egdev_uÄegi¡”
(cÚ¡ 
Ãt_deviû
 *
dev
, 
tc_£tup_cb_t
 *
cb
,

702 *
cb_´iv
)

705 
	}
}

708 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 16, 0)

709 
	#DEFINE_SHOW_ATTRIBUTE
(
__Çme
) \

710 
__Çme
 ## 
	`_Ý’
(
šode
 *šode, 
fže
 *file) \

712  
	`sšgË_Ý’
(
fže
, 
__Çme
 ## 
_show
, 
šode
->
i_´iv©e
); \

715 cÚ¡ 
fže_Ý”©iÚs
 
__Çme
 ## 
_fÝs
 = { \

716 .
owÃr
 = 
THIS_MODULE
, \

717 .
Ý’
 = 
__Çme
 ## 
_Ý’
, \

718 .
»ad
 = 
£q_»ad
, \

719 .
Î£ek
 = 
£q_l£ek
, \

720 .
»Ëa£
 = 
sšgË_»Ëa£
, \

721 }

	)

724 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 15, 0) && \

725 
	gLINUX_VERSION_CODE
 < 
	$KERNEL_VERSION
(4, 16, 0)

726 
šlše
 
boÞ


727 
	$tc_þs_ÿn_ofæßd_ªd_chaš0
(cÚ¡ 
Ãt_deviû
 *
dev
,

728 
tc_þs_commÚ_ofæßd
 *
commÚ
)

730  !
commÚ
->
chaš_šdex
;

731 
	}
}

734 #ifdeà
COMPAT__HAVE_METADATA_IP_TUNNEL


735 #ià
VER_NON_RHEL_LT
(4, 16è|| 
VER_RHEL_LT
(7, 6)

736 
šlše
 
Ãt_deviû
 *
	$tcf_mœ»d_dev
(cÚ¡ 
tc_aùiÚ
 *
aùiÚ
)

738 
ifšdex
;

740 
ifšdex
 = 
	`tcf_mœ»d_ifšdex
(
aùiÚ
);

741  
	`__dev_g‘_by_šdex
(
cu¼’t
->
n¥roxy
->
Ãt_ns
, 
ifšdex
);

742 
	}
}

746 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 16, 0è|| !
defšed
(
CONFIG_NET_CLS
)

747 
	#tcf_block_sh¬ed
(
b
è
çl£


	)

750 #ià
VER_NON_RHEL_LT
(4, 16è|| 
VER_RHEL_LT
(7, 6)

751 
šlše
 
	$xdp_rxq_šfo_uÄeg
(
xdp_rxq_šfo
 *
xdp_rxq
)

753 
	}
}

755 
šlše
 

756 
	$xdp_rxq_šfo_»g
(
xdp_rxq_šfo
 *
xdp_rxq
, 
Ãt_deviû
 *
dev
, 
u32
 
q
)

759 
	}
}

762 #ià
COMPAT__HAS_DEVLINK
 && 
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 18, 0)

763 
	edevlšk_pÜt_æavour
 {

764 
	mDEVLINK_PORT_FLAVOUR_PHYSICAL
,

765 
	mDEVLINK_PORT_FLAVOUR_CPU
,

766 
	mDEVLINK_PORT_FLAVOUR_DSA
,

769 
šlše
 

770 
	$devlšk_pÜt_©Œs_£t
(
devlšk_pÜt
 *devlink_port,

771 
devlšk_pÜt_æavour
 
æavour
,

772 
u32
 
pÜt_numb”
, 
boÞ
 
¥l™
, u32 
¥l™_subpÜt_numb”
)

774 ià(
¥l™
)

775 
	`devlšk_pÜt_¥l™_£t
(
devlšk_pÜt
, 
pÜt_numb”
);

776 
	}
}

779 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 19, 0)

780 
	sbpf_ofæßd_dev
 {

781 
u32
 
	mem±y
;

784 
šlše
 

785 
	$bpf_ofæßd_dev_Ãtdev_»gi¡”
(
bpf_ofæßd_dev
 *
bpf_dev
,

786 
Ãt_deviû
 *
dev
)

789 
	}
}

791 
šlše
 

792 
	$bpf_ofæßd_dev_Ãtdev_uÄegi¡”
(
bpf_ofæßd_dev
 *
bpf_dev
,

793 
Ãt_deviû
 *
dev
)

795 
	}
}

797 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

798 
šlše
 
bpf_ofæßd_dev
 *
	$bpf_ofæßd_dev_ü—‹
()

800 
šlše
 
bpf_ofæßd_dev
 *

801 
	$bpf_ofæßd_dev_ü—‹
(
bpf_´og_ofæßd_Ýs
 *
dev_Ýs
)

804  
NULL
;

805 
	}
}

807 
šlše
 
	$bpf_ofæßd_dev_de¡roy
(
bpf_ofæßd_dev
 *
bpf_dev
)

809 
	}
}

811 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 18, 0)

812 
šlše
 
boÞ


813 
	$com·t_bpf_ofæßd_dev_m©ch
(
bpf_´og
 *
´og
, 
Ãt_deviû
 *
dev
)

815 
bpf_´og_ofæßd
 *
ofæßd
 = 
´og
->
aux
->offload;

817 ià(!
ofæßd
)

818  
çl£
;

819 ià(
ofæßd
->
Ãtdev
 !ð
dev
)

820  
çl£
;

821  
Œue
;

822 
	}
}

823 
	#bpf_ofæßd_dev_m©ch
(
´og
, 
dev
è
	`com·t_bpf_ofæßd_dev_m©ch
Õrog, dev)

	)

826 
	#FLOW_DISSECTOR_KEY_ENC_IP
 22

	)

827 
	#FLOW_DISSECTOR_KEY_ENC_OPTS
 23

	)

829 
	#FLOW_DIS_TUN_OPTS_MAX
 255

	)

832 #ià
VER_NON_RHEL_LT
(4, 19è|| 
VER_RHEL_LT
(8, 0)

833 
	sæow_dis£ùÜ_key_’c_Ýts
 {

834 
u8
 
	md©a
[
FLOW_DIS_TUN_OPTS_MAX
];

835 
u8
 
	mËn
;

836 
__be16
 
	md¡_Ýt_ty³
;

839 
	#tcf_block_cb_»gi¡”
(
block
, 
cb
, 
id’t
, 
´iv
, 
—
) \

840 
	`tcf_block_cb_»gi¡”
(
block
, 
cb
, 
id’t
, 
´iv
)

	)

842 #ià
COMPAT__HAVE_XDP


843 
šlše
 

844 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 15, 0)

845 
	$xdp_©chm’t_qu”y
(
xdp_©chm’t_šfo
 *
šfo
, 
Ãtdev_xdp
 *
bpf
)

847 
	$xdp_©chm’t_qu”y
(
xdp_©chm’t_šfo
 *
šfo
, 
Ãtdev_bpf
 *
bpf
)

850 
bpf
->
´og_©ched
 = !!
šfo
->
´og
;

851 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 13, 0)

852 ià(
bpf
->
´og_©ched
 && 
šfo
->
æags
 & 
XDP_FLAGS_HW_MODE
)

853 
bpf
->
´og_©ched
 = 
XDP_ATTACHED_HW
;

854 
bpf
->
´og_id
 = 
šfo
->
´og
 ? info->´og->
aux
->
id
 : 0;

856 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 16, 0)

857 
bpf
->
´og_æags
 = 
šfo
->
´og
 ? info->
æags
 : 0;

860 
	}
}

862 
šlše
 
boÞ
 
xdp_©chm’t_æags_ok
(
xdp_©chm’t_šfo
 *
šfo
,

863 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 15, 0)

864 
Ãtdev_xdp
 *
bpf
)

866 
Ãtdev_bpf
 *
	gbpf
)

869 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 13, 0)

870 ià(
	gšfo
->
	g´og
 && (
	gbpf
->
	gæags
 ^ info->æagsè& 
	gXDP_FLAGS_MODES
) {

871 
NL_SET_ERR_MSG
(
bpf
->
exck
,

873  
	gçl£
;

876  
	gŒue
;

879 
šlše
 

880 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 15, 0)

881 
	$xdp_©chm’t_£tup
(
xdp_©chm’t_šfo
 *
šfo
, 
Ãtdev_xdp
 *
bpf
)

883 
	$xdp_©chm’t_£tup
(
xdp_©chm’t_šfo
 *
šfo
, 
Ãtdev_bpf
 *
bpf
)

886 ià(
šfo
->
´og
)

887 
	`bpf_´og_put
(
šfo
->
´og
);

888 
šfo
->
´og
 = 
bpf
->prog;

889 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 13, 0)

890 
šfo
->
æags
 = 
bpf
->flags;

892 
	}
}

896 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 20, 0)

897 
šlše
 
boÞ
 
	$Ãtif_is_vxÏn
(cÚ¡ 
Ãt_deviû
 *
dev
)

899  
dev
->
¹Æ_lšk_Ýs
 &&

900 !
	`¡rcmp
(
dev
->
¹Æ_lšk_Ýs
->
kšd
, "vxlan");

901 
	}
}

903 
šlše
 
boÞ


904 
	$__Ãtdev_tx_£Á_queue
(
Ãtdev_queue
 *
nd_q
, 
u32
 
Ën
, 
boÞ
 
xm™_mÜe
)

906 
	`Ãtdev_tx_£Á_queue
(
nd_q
, 
Ën
);

908  !
xm™_mÜe
 || 
	`Ãtif_xm™_¡Ý³d
(
nd_q
);

909 
	}
}

912 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 0, 0)

913 #undeà
CONFIG_NFP_APP_ABM_NIC


915 
šlše
 
boÞ
 
	$Ãtif_is_g’eve
(cÚ¡ 
Ãt_deviû
 *
dev
)

917  
dev
->
¹Æ_lšk_Ýs
 &&

918 !
	`¡rcmp
(
dev
->
¹Æ_lšk_Ýs
->
kšd
, "geneve");

919 
	}
}

922 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 0, 0)

923 
	#dma_z®loc_coh”’t
 
dma_®loc_coh”’t


	)

926 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 1, 0)

927 
	#BPF_JMP32
 0x06

	)

929 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 18, 0)

930 
šlše
 
nå_Ãt
 *
	$com·t__bpf_´og_g‘_Â
(
bpf_´og
 *
´og
)

932  
	`Ãtdev_´iv
(
´og
->
aux
->
ofæßd
->
Ãtdev
);

933 
	}
}

936 #ifdeà
COMPAT__HAVE_METADATA_IP_TUNNEL


937 
	eæow_aùiÚ_id
 {

938 
	mFLOW_ACTION_ACCEPT
,

939 
	mFLOW_ACTION_DROP
,

940 
	mFLOW_ACTION_TRAP
,

941 
	mFLOW_ACTION_GOTO
,

942 
	mFLOW_ACTION_REDIRECT
,

943 
	mFLOW_ACTION_MIRRED
,

944 
	mFLOW_ACTION_VLAN_PUSH
,

945 
	mFLOW_ACTION_VLAN_POP
,

946 
	mFLOW_ACTION_VLAN_MANGLE
,

947 
	mFLOW_ACTION_TUNNEL_ENCAP
,

948 
	mFLOW_ACTION_TUNNEL_DECAP
,

949 
	mFLOW_ACTION_MANGLE
,

950 
	mFLOW_ACTION_ADD
,

951 
	mFLOW_ACTION_CSUM
,

952 
	mFLOW_ACTION_MARK
,

953 
	mFLOW_ACTION_WAKE
,

954 
	mFLOW_ACTION_QUEUE
,

955 
	mFLOW_ACTION_UNKNOWN
 = 10000,

958 
šlše
 
	$com·t__tÿ_to_æow_aù_id
(cÚ¡ 
tc_aùiÚ
 *
aù
)

960 ià(
	`is_tcf_gaù_shÙ
(
aù
))

961  
FLOW_ACTION_DROP
;

962 ià(
	`is_tcf_mœ»d_eg»ss_»dœeù
(
aù
))

963  
FLOW_ACTION_REDIRECT
;

964 ià(
	`is_tcf_mœ»d_eg»ss_mœrÜ
(
aù
))

965  
FLOW_ACTION_MIRRED
;

966 ià(
	`is_tcf_vÏn
(
aù
è&& 
	`tcf_vÏn_aùiÚ
×ùè=ð
TCA_VLAN_ACT_POP
)

967  
FLOW_ACTION_VLAN_POP
;

968 ià(
	`is_tcf_vÏn
(
aù
è&& 
	`tcf_vÏn_aùiÚ
×ùè=ð
TCA_VLAN_ACT_PUSH
)

969  
FLOW_ACTION_VLAN_PUSH
;

970 ià(
	`is_tcf_tuÂ–_£t
(
aù
))

971  
FLOW_ACTION_TUNNEL_ENCAP
;

972 ià(
	`is_tcf_tuÂ–_»Ëa£
(
aù
))

973  
FLOW_ACTION_TUNNEL_DECAP
;

974 ià(
	`is_tcf_³d™
(
aù
))

975  
FLOW_ACTION_MANGLE
;

976 ià(
	`is_tcf_csum
(
aù
))

977  
FLOW_ACTION_CSUM
;

978  
FLOW_ACTION_UNKNOWN
;

979 
	}
}

981 
šlše
 *
	$com·t__tÿ_tun_šfo
(cÚ¡ 
tc_aùiÚ
 *
aù
)

983  
	`tcf_tuÂ–_šfo
(
aù
);

984 
	}
}

986 
šlše
 
u32
 
	$com·t__tÿ_csum_upd©e_æags
(cÚ¡ 
tc_aùiÚ
 *
aù
)

988  
	`tcf_csum_upd©e_æags
(
aù
);

989 
	}
}

991 
šlše
 
__be16
 
	$com·t__tÿ_vÏn_push_´Ùo
(cÚ¡ 
tc_aùiÚ
 *
aù
)

993  
	`tcf_vÏn_push_´Ùo
(
aù
);

994 
	}
}

996 
šlše
 
u8
 
	$com·t__tÿ_vÏn_push_´io
(cÚ¡ 
tc_aùiÚ
 *
aù
)

998  
	`tcf_vÏn_push_´io
(
aù
);

999 
	}
}

1001 
šlše
 
u16
 
	$com·t__tÿ_vÏn_push_vid
(cÚ¡ 
tc_aùiÚ
 *
aù
)

1003  
	`tcf_vÏn_push_vid
(
aù
);

1004 
	}
}

1006 
šlše
 
Ãt_deviû
 *

1007 
	$com·t__tÿ_mœ»d_dev
(cÚ¡ 
tc_aùiÚ
 *
aù
)

1009  
	`tcf_mœ»d_dev
(
aù
);

1010 
	}
}

1012 
šlše
 
	$com·t__tÿ_³d™_nkeys
(cÚ¡ 
tc_aùiÚ
 *
aù
)

1014  
	`tcf_³d™_nkeys
(
aù
);

1015 
	}
}

1017 
šlše
 
u32
 
	$com·t__tÿ_³d™_v®
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
)

1019  
	`tcf_³d™_v®
(
aù
, 
idx
);

1020 
	}
}

1022 
šlše
 
u32
 
	$com·t__tÿ_³d™_mask
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
)

1024  
	`tcf_³d™_mask
(
aù
, 
idx
);

1025 
	}
}

1027 
šlše
 
u32
 
	$com·t__tÿ_³d™_cmd
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
)

1029  
	`tcf_³d™_cmd
(
aù
, 
idx
);

1030 
	}
}

1032 
šlše
 
	$com·t__tÿ_³d™_hty³
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
)

1034  
	`tcf_³d™_hty³
(
aù
, 
idx
);

1035 
	}
}

1037 
šlše
 
u32
 
	$com·t__tÿ_³d™_off£t
(cÚ¡ 
tc_aùiÚ
 *
aù
, 
idx
)

1039  
	`tcf_³d™_off£t
(
aù
, 
idx
);

1040 
	}
}

1042 
šlše
 
boÞ


1043 
	$Ãtdev_pÜt_§me_·»Á_id
(
Ãt_deviû
 *
a
, Ãt_deviû *
b
)

1045  
	`sw™chdev_pÜt_§me_·»Á_id
(
a
, 
b
);

1046 
	}
}

1050 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

1051 
šlše
 

1052 
	$com·t__tÿ_to_æow_aù_id
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1054  
aù
->
id
;

1055 
	}
}

1057 
šlše
 *
	$com·t__tÿ_tun_šfo
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1059  (*)
aù
->
tuÂ–
;

1060 
	}
}

1062 
šlše
 
u32


1063 
	$com·t__tÿ_csum_upd©e_æags
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1065  
aù
->
csum_æags
;

1066 
	}
}

1068 
šlše
 
__be16


1069 
	$com·t__tÿ_vÏn_push_´Ùo
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1071  
aù
->
vÏn
.
´Ùo
;

1072 
	}
}

1074 
šlše
 
u8


1075 
	$com·t__tÿ_vÏn_push_´io
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1077  
aù
->
vÏn
.
´io
;

1078 
	}
}

1080 
šlše
 
u16


1081 
	$com·t__tÿ_vÏn_push_vid
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1083  
aù
->
vÏn
.
vid
;

1084 
	}
}

1086 
šlše
 
Ãt_deviû
 *

1087 
	$com·t__tÿ_mœ»d_dev
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1089  
aù
->
dev
;

1090 
	}
}

1092 
šlše
 
	$com·t__tÿ_³d™_nkeys
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
)

1095 
	}
}

1097 
šlše
 
u32


1098 
	$com·t__tÿ_³d™_v®
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
)

1100  
aù
->
mªgË
.
v®
;

1101 
	}
}

1103 
šlše
 
u32


1104 
	$com·t__tÿ_³d™_mask
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
)

1106  
aù
->
mªgË
.
mask
;

1107 
	}
}

1109 
šlše
 
u32


1110 
	$com·t__tÿ_³d™_cmd
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
)

1112  
TCA_PEDIT_KEY_EX_CMD_SET
;

1113 
	}
}

1115 
šlše
 

1116 
	$com·t__tÿ_³d™_hty³
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
)

1118  
aù
->
mªgË
.
hty³
;

1119 
	}
}

1121 
šlše
 
u32


1122 
	$com·t__tÿ_³d™_off£t
(cÚ¡ 
æow_aùiÚ_’Œy
 *
aù
, 
idx
)

1124  
aù
->
mªgË
.
off£t
;

1125 
	}
}

1128 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 1, 0)

1129 
com·t__nå_Ãt_æash_deviû
(
Ãt_deviû
 *
Ãtdev
,

1130 
‘htoÞ_æash
 *
æash
);

1132 
	#com·t__nå_Ãt_æash_deviû
 
NULL


	)

	@src/nfp_net_ctrl.c

4 
	~"nåcÜe/kcom·t.h
"

6 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

7 
	~<lšux/b™f›ld.h
>

9 
	~<lšux/deviû.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/ty³s.h
>

13 
	~"nå_Ãt_ù¾.h
"

14 
	~"nå_Ãt.h
"

16 
	$nå_Ãt_Žv_ÿps_»£t
(
nå_Ãt_Žv_ÿps
 *
ÿps
)

18 
	`mem£t
(
ÿps
, 0, (*caps));

19 
ÿps
->
me_äeq_mhz
 = 1200;

20 
ÿps
->
mbox_off
 = 
NFP_NET_CFG_MBOX_BASE
;

21 
ÿps
->
mbox_Ën
 = 
NFP_NET_CFG_MBOX_VAL_MAX_SZ
;

22 
	}
}

24 
	$nå_Ãt_Žv_ÿps_·r£
(
deviû
 *
dev
, 
u8
 
__iomem
 *
ù¾_mem
,

25 
nå_Ãt_Žv_ÿps
 *
ÿps
)

27 
u8
 
__iomem
 *
d©a
 = 
ù¾_mem
 + 
NFP_NET_CFG_TLV_BASE
;

28 
u8
 
__iomem
 *
’d
 = 
ù¾_mem
 + 
NFP_NET_CFG_BAR_SZ
;

29 
u32
 
hdr
;

31 
	`nå_Ãt_Žv_ÿps_»£t
(
ÿps
);

33 
hdr
 = 
	`»adl
(
d©a
);

34 ià(!
hdr
)

37 
Œue
) {

38 
Ëngth
, 
off£t
;

39 
u32
 
hdr
 = 
	`»adl
(
d©a
);

41 
Ëngth
 = 
	`FIELD_GET
(
NFP_NET_CFG_TLV_HEADER_LENGTH
, 
hdr
);

42 
off£t
 = 
d©a
 - 
ù¾_mem
;

45 
d©a
 += 4;

47 ià(
Ëngth
 % 
NFP_NET_CFG_TLV_LENGTH_INC
) {

48 
	`dev_”r
(
dev
, "TLV size‚ot multiple of %u offset:%u†en:%u\n",

49 
NFP_NET_CFG_TLV_LENGTH_INC
, 
off£t
, 
Ëngth
);

50  -
EINVAL
;

52 ià(
d©a
 + 
Ëngth
 > 
’d
) {

53 
	`dev_”r
(
dev
, "oversized TLV offset:%u†en:%u\n",

54 
off£t
, 
Ëngth
);

55  -
EINVAL
;

58 
	`FIELD_GET
(
NFP_NET_CFG_TLV_HEADER_TYPE
, 
hdr
)) {

59 
NFP_NET_CFG_TLV_TYPE_UNKNOWN
:

60 
	`dev_”r
(
dev
, "NULL TLV‡ˆoff£t:%u\n", 
off£t
);

61  -
EINVAL
;

62 
NFP_NET_CFG_TLV_TYPE_RESERVED
:

64 
NFP_NET_CFG_TLV_TYPE_END
:

65 ià(!
Ëngth
)

68 
	`dev_”r
(
dev
, "END TLV should beƒmpty, has offset:%u†en:%d\n",

69 
off£t
, 
Ëngth
);

70  -
EINVAL
;

71 
NFP_NET_CFG_TLV_TYPE_ME_FREQ
:

72 ià(
Ëngth
 != 4) {

73 
	`dev_”r
(
dev
,

75 
Ëngth
, 
off£t
);

76  -
EINVAL
;

79 
ÿps
->
me_äeq_mhz
 = 
	`»adl
(
d©a
);

81 
NFP_NET_CFG_TLV_TYPE_MBOX
:

82 ià(!
Ëngth
) {

83 
ÿps
->
mbox_off
 = 0;

84 
ÿps
->
mbox_Ën
 = 0;

86 
ÿps
->
mbox_off
 = 
d©a
 - 
ù¾_mem
;

87 
ÿps
->
mbox_Ën
 = 
Ëngth
;

90 
NFP_NET_CFG_TLV_TYPE_EXPERIMENTAL0
:

91 
NFP_NET_CFG_TLV_TYPE_EXPERIMENTAL1
:

92 
	`dev_w¬n
(
dev
,

94 
	`FIELD_GET
(
NFP_NET_CFG_TLV_HEADER_TYPE
, 
hdr
),

95 
off£t
, 
Ëngth
);

97 
NFP_NET_CFG_TLV_TYPE_REPR_CAP
:

98 ià(
Ëngth
 < 4) {

99 
	`dev_”r
(
dev
, "REPR CAP TLV short %dB < 4B offset:%u\n",

100 
Ëngth
, 
off£t
);

101  -
EINVAL
;

104 
ÿps
->
»´_ÿp
 = 
	`»adl
(
d©a
);

107 ià(!
	`FIELD_GET
(
NFP_NET_CFG_TLV_HEADER_REQUIRED
, 
hdr
))

110 
	`dev_”r
(
dev
, "unknown TLVype:%u offset:%u†en:%u\n",

111 
	`FIELD_GET
(
NFP_NET_CFG_TLV_HEADER_TYPE
, 
hdr
),

112 
off£t
, 
Ëngth
);

113  -
EINVAL
;

116 
d©a
 +ð
Ëngth
;

117 ià(
d©a
 + 4 > 
’d
) {

118 
	`dev_”r
(
dev
, "reachedƒnd of BAR without END TLV\n");

119  -
EINVAL
;

124  -
EINVAL
;

125 
	}
}

	@src/nfp_net_ctrl.h

13 #iâdeà
_NFP_NET_CTRL_H_


14 
	#_NFP_NET_CTRL_H_


	)

16 
	~<lšux/ty³s.h
>

24 
	#NFP_NET_CFG_BAR_SZ
 (32 * 1024)

	)

29 
	#NFP_NET_RX_OFFSET
 32

	)

36 
	#NFP_NET_LSO_MAX_HDR_SZ
 255

	)

37 
	#NFP_NET_LSO_MAX_SEGS
 64

	)

42 
	#NFP_NET_META_FIELD_SIZE
 4

	)

43 
	#NFP_NET_META_HASH
 1

	)

44 
	#NFP_NET_META_MARK
 2

	)

45 
	#NFP_NET_META_PORTID
 5

	)

46 
	#NFP_NET_META_CSUM
 6

	)

48 
	#NFP_META_PORT_ID_CTRL
 ~0U

	)

53 
	#NFP_NET_RSS_NONE
 0

	)

54 
	#NFP_NET_RSS_IPV4
 1

	)

55 
	#NFP_NET_RSS_IPV6
 2

	)

56 
	#NFP_NET_RSS_IPV6_EX
 3

	)

57 
	#NFP_NET_RSS_IPV4_TCP
 4

	)

58 
	#NFP_NET_RSS_IPV6_TCP
 5

	)

59 
	#NFP_NET_RSS_IPV6_EX_TCP
 6

	)

60 
	#NFP_NET_RSS_IPV4_UDP
 7

	)

61 
	#NFP_NET_RSS_IPV6_UDP
 8

	)

62 
	#NFP_NET_RSS_IPV6_EX_UDP
 9

	)

69 
	#NFP_NET_TXR_MAX
 64

	)

70 
	#NFP_NET_RXR_MAX
 64

	)

87 
	#NFP_NET_CFG_CTRL
 0x0000

	)

88 
	#NFP_NET_CFG_CTRL_ENABLE
 (0x1 << 0è

	)

89 
	#NFP_NET_CFG_CTRL_PROMISC
 (0x1 << 1è

	)

90 
	#NFP_NET_CFG_CTRL_L2BC
 (0x1 << 2è

	)

91 
	#NFP_NET_CFG_CTRL_L2MC
 (0x1 << 3è

	)

92 
	#NFP_NET_CFG_CTRL_RXCSUM
 (0x1 << 4è

	)

93 
	#NFP_NET_CFG_CTRL_TXCSUM
 (0x1 << 5è

	)

94 
	#NFP_NET_CFG_CTRL_RXVLAN
 (0x1 << 6è

	)

95 
	#NFP_NET_CFG_CTRL_TXVLAN
 (0x1 << 7è

	)

96 
	#NFP_NET_CFG_CTRL_SCATTER
 (0x1 << 8è

	)

97 
	#NFP_NET_CFG_CTRL_GATHER
 (0x1 << 9è

	)

98 
	#NFP_NET_CFG_CTRL_LSO
 (0x1 << 10è

	)

99 
	#NFP_NET_CFG_CTRL_CTAG_FILTER
 (0x1 << 11è

	)

100 
	#NFP_NET_CFG_CTRL_CMSG_DATA
 (0x1 << 12è

	)

101 
	#NFP_NET_CFG_CTRL_RINGCFG
 (0x1 << 16è

	)

102 
	#NFP_NET_CFG_CTRL_RSS
 (0x1 << 17è

	)

103 
	#NFP_NET_CFG_CTRL_IRQMOD
 (0x1 << 18è

	)

104 
	#NFP_NET_CFG_CTRL_MSIXAUTO
 (0x1 << 20è

	)

105 
	#NFP_NET_CFG_CTRL_TXRWB
 (0x1 << 21è

	)

106 
	#NFP_NET_CFG_CTRL_VXLAN
 (0x1 << 24è

	)

107 
	#NFP_NET_CFG_CTRL_NVGRE
 (0x1 << 25è

	)

108 
	#NFP_NET_CFG_CTRL_BPF
 (0x1 << 27è

	)

109 
	#NFP_NET_CFG_CTRL_LSO2
 (0x1 << 28è

	)

110 
	#NFP_NET_CFG_CTRL_RSS2
 (0x1 << 29è

	)

111 
	#NFP_NET_CFG_CTRL_CSUM_COMPLETE
 (0x1 << 30è

	)

112 
	#NFP_NET_CFG_CTRL_LIVE_ADDR
 (0x1 << 31è

	)

114 
	#NFP_NET_CFG_CTRL_LSO_ANY
 (
NFP_NET_CFG_CTRL_LSO
 | \

115 
NFP_NET_CFG_CTRL_LSO2
)

	)

116 
	#NFP_NET_CFG_CTRL_RSS_ANY
 (
NFP_NET_CFG_CTRL_RSS
 | \

117 
NFP_NET_CFG_CTRL_RSS2
)

	)

118 
	#NFP_NET_CFG_CTRL_RXCSUM_ANY
 (
NFP_NET_CFG_CTRL_RXCSUM
 | \

119 
NFP_NET_CFG_CTRL_CSUM_COMPLETE
)

	)

120 
	#NFP_NET_CFG_CTRL_CHAIN_META
 (
NFP_NET_CFG_CTRL_RSS2
 | \

121 
NFP_NET_CFG_CTRL_CSUM_COMPLETE
)

	)

123 
	#NFP_NET_CFG_UPDATE
 0x0004

	)

124 
	#NFP_NET_CFG_UPDATE_GEN
 (0x1 << 0è

	)

125 
	#NFP_NET_CFG_UPDATE_RING
 (0x1 << 1è

	)

126 
	#NFP_NET_CFG_UPDATE_RSS
 (0x1 << 2è

	)

127 
	#NFP_NET_CFG_UPDATE_TXRPRIO
 (0x1 << 3è

	)

128 
	#NFP_NET_CFG_UPDATE_RXRPRIO
 (0x1 << 4è

	)

129 
	#NFP_NET_CFG_UPDATE_MSIX
 (0x1 << 5è

	)

130 
	#NFP_NET_CFG_UPDATE_RESET
 (0x1 << 7è

	)

131 
	#NFP_NET_CFG_UPDATE_IRQMOD
 (0x1 << 8è

	)

132 
	#NFP_NET_CFG_UPDATE_VXLAN
 (0x1 << 9è

	)

133 
	#NFP_NET_CFG_UPDATE_BPF
 (0x1 << 10è

	)

134 
	#NFP_NET_CFG_UPDATE_MACADDR
 (0x1 << 11è

	)

135 
	#NFP_NET_CFG_UPDATE_MBOX
 (0x1 << 12è

	)

136 
	#NFP_NET_CFG_UPDATE_VF
 (0x1 << 13è

	)

137 
	#NFP_NET_CFG_UPDATE_ERR
 (0x1 << 31è

	)

138 
	#NFP_NET_CFG_TXRS_ENABLE
 0x0008

	)

139 
	#NFP_NET_CFG_RXRS_ENABLE
 0x0010

	)

140 
	#NFP_NET_CFG_MTU
 0x0018

	)

141 
	#NFP_NET_CFG_FLBUFSZ
 0x001c

	)

142 
	#NFP_NET_CFG_EXN
 0x001f

	)

143 
	#NFP_NET_CFG_LSC
 0x0020

	)

144 
	#NFP_NET_CFG_MACADDR
 0x0024

	)

160 
	#NFP_NET_CFG_VERSION
 0x0030

	)

161 
	#NFP_NET_CFG_VERSION_RESERVED_MASK
 (0xã << 24)

	)

162 
	#NFP_NET_CFG_VERSION_DP_NFD3
 0

	)

163 
	#NFP_NET_CFG_VERSION_DP_NFDK
 1

	)

164 
	#NFP_NET_CFG_VERSION_DP
 1

	)

165 
	#NFP_NET_CFG_VERSION_CLASS_MASK
 (0xfà<< 16)

	)

166 
	#NFP_NET_CFG_VERSION_CLASS
(
x
è(((xè& 0xffè<< 16)

	)

167 
	#NFP_NET_CFG_VERSION_CLASS_GENERIC
 0

	)

168 
	#NFP_NET_CFG_VERSION_MAJOR_MASK
 (0xfà<< 8)

	)

169 
	#NFP_NET_CFG_VERSION_MAJOR
(
x
è(((xè& 0xffè<< 8)

	)

170 
	#NFP_NET_CFG_VERSION_MINOR_MASK
 (0xfà<< 0)

	)

171 
	#NFP_NET_CFG_VERSION_MINOR
(
x
è(((xè& 0xffè<< 0)

	)

172 
	#NFP_NET_CFG_STS
 0x0034

	)

173 
	#NFP_NET_CFG_STS_LINK
 (0x1 << 0è

	)

175 
	#NFP_NET_CFG_STS_LINK_RATE_SHIFT
 1

	)

176 
	#NFP_NET_CFG_STS_LINK_RATE_MASK
 0xF

	)

177 
	#NFP_NET_CFG_STS_LINK_RATE
 \

178 (
NFP_NET_CFG_STS_LINK_RATE_MASK
 << 
NFP_NET_CFG_STS_LINK_RATE_SHIFT
)

	)

179 
	#NFP_NET_CFG_STS_LINK_RATE_UNSUPPORTED
 0

	)

180 
	#NFP_NET_CFG_STS_LINK_RATE_UNKNOWN
 1

	)

181 
	#NFP_NET_CFG_STS_LINK_RATE_1G
 2

	)

182 
	#NFP_NET_CFG_STS_LINK_RATE_10G
 3

	)

183 
	#NFP_NET_CFG_STS_LINK_RATE_25G
 4

	)

184 
	#NFP_NET_CFG_STS_LINK_RATE_40G
 5

	)

185 
	#NFP_NET_CFG_STS_LINK_RATE_50G
 6

	)

186 
	#NFP_NET_CFG_STS_LINK_RATE_100G
 7

	)

187 
	#NFP_NET_CFG_CAP
 0x0038

	)

188 
	#NFP_NET_CFG_MAX_TXRINGS
 0x003c

	)

189 
	#NFP_NET_CFG_MAX_RXRINGS
 0x0040

	)

190 
	#NFP_NET_CFG_MAX_MTU
 0x0044

	)

192 
	#NFP_NET_CFG_START_TXQ
 0x0048

	)

193 
	#NFP_NET_CFG_START_RXQ
 0x004c

	)

198 
	#NFP_NET_CFG_RX_OFFSET
 0x0050

	)

199 
	#NFP_NET_CFG_RX_OFFSET_DYNAMIC
 0

	)

206 
	#NFP_NET_CFG_RSS_CAP
 0x0054

	)

207 
	#NFP_NET_CFG_RSS_CAP_HFUNC
 0xff000000

	)

213 
	#NFP_NET_CFG_TLV_BASE
 0x0058

	)

220 
	#NFP_NET_CFG_VXLAN_PORT
 0x0060

	)

221 
	#NFP_NET_CFG_VXLAN_SZ
 0x0008

	)

235 
	#NFP_NET_CFG_BPF_ABI
 0x0080

	)

236 
	#NFP_NET_CFG_BPF_CAP
 0x0081

	)

237 
	#NFP_NET_BPF_CAP_RELO
 (1 << 0è

	)

238 
	#NFP_NET_CFG_BPF_MAX_LEN
 0x0082

	)

239 
	#NFP_NET_CFG_BPF_START
 0x0084

	)

240 
	#NFP_NET_CFG_BPF_DONE
 0x0086

	)

241 
	#NFP_NET_CFG_BPF_STACK_SZ
 0x0088

	)

242 
	#NFP_NET_CFG_BPF_INL_MTU
 0x0089

	)

243 
	#NFP_NET_CFG_BPF_SIZE
 0x008e

	)

244 
	#NFP_NET_CFG_BPF_ADDR
 0x0090

	)

245 
	#NFP_NET_CFG_BPF_CFG_8CTX
 (1 << 0è

	)

246 
	#NFP_NET_CFG_BPF_CFG_MASK
 7ULL

	)

247 
	#NFP_NET_CFG_BPF_ADDR_MASK
 (~
NFP_NET_CFG_BPF_CFG_MASK
)

	)

252 
	#NFP_NET_CFG_RESERVED
 0x0098

	)

253 
	#NFP_NET_CFG_RESERVED_SZ
 0x0028

	)

262 
	#NFP_NET_CFG_RSS_BASE
 0x0100

	)

263 
	#NFP_NET_CFG_RSS_CTRL
 
NFP_NET_CFG_RSS_BASE


	)

264 
	#NFP_NET_CFG_RSS_MASK
 (0x7f)

	)

265 
	#NFP_NET_CFG_RSS_MASK_of
(
_x
è((_xè& 0x7f)

	)

266 
	#NFP_NET_CFG_RSS_IPV4
 (1 << 8è

	)

267 
	#NFP_NET_CFG_RSS_IPV6
 (1 << 9è

	)

268 
	#NFP_NET_CFG_RSS_IPV4_TCP
 (1 << 10è

	)

269 
	#NFP_NET_CFG_RSS_IPV4_UDP
 (1 << 11è

	)

270 
	#NFP_NET_CFG_RSS_IPV6_TCP
 (1 << 12è

	)

271 
	#NFP_NET_CFG_RSS_IPV6_UDP
 (1 << 13è

	)

272 
	#NFP_NET_CFG_RSS_HFUNC
 0xff000000

	)

273 
	#NFP_NET_CFG_RSS_TOEPLITZ
 (1 << 24è

	)

274 
	#NFP_NET_CFG_RSS_XOR
 (1 << 25è

	)

275 
	#NFP_NET_CFG_RSS_CRC32
 (1 << 26è

	)

276 
	#NFP_NET_CFG_RSS_HFUNCS
 3

	)

277 
	#NFP_NET_CFG_RSS_KEY
 (
NFP_NET_CFG_RSS_BASE
 + 0x4)

	)

278 
	#NFP_NET_CFG_RSS_KEY_SZ
 0x28

	)

279 
	#NFP_NET_CFG_RSS_ITBL
 (
NFP_NET_CFG_RSS_BASE
 + 0x4 + \

280 
NFP_NET_CFG_RSS_KEY_SZ
)

	)

281 
	#NFP_NET_CFG_RSS_ITBL_SZ
 0x80

	)

293 
	#NFP_NET_CFG_TXR_BASE
 0x0200

	)

294 
	#NFP_NET_CFG_TXR_ADDR
(
_x
è(
NFP_NET_CFG_TXR_BASE
 + ((_xè* 0x8))

	)

295 
	#NFP_NET_CFG_TXR_WB_ADDR
(
_x
è(
NFP_NET_CFG_TXR_BASE
 + 0x200 + \

296 ((
_x
è* 0x8))

	)

297 
	#NFP_NET_CFG_TXR_SZ
(
_x
è(
NFP_NET_CFG_TXR_BASE
 + 0x400 + (_x))

	)

298 
	#NFP_NET_CFG_TXR_VEC
(
_x
è(
NFP_NET_CFG_TXR_BASE
 + 0x440 + (_x))

	)

299 
	#NFP_NET_CFG_TXR_PRIO
(
_x
è(
NFP_NET_CFG_TXR_BASE
 + 0x480 + (_x))

	)

300 
	#NFP_NET_CFG_TXR_IRQ_MOD
(
_x
è(
NFP_NET_CFG_TXR_BASE
 + 0x500 + \

301 ((
_x
è* 0x4))

	)

312 
	#NFP_NET_CFG_RXR_BASE
 0x0800

	)

313 
	#NFP_NET_CFG_RXR_ADDR
(
_x
è(
NFP_NET_CFG_RXR_BASE
 + ((_xè* 0x8))

	)

314 
	#NFP_NET_CFG_RXR_SZ
(
_x
è(
NFP_NET_CFG_RXR_BASE
 + 0x200 + (_x))

	)

315 
	#NFP_NET_CFG_RXR_VEC
(
_x
è(
NFP_NET_CFG_RXR_BASE
 + 0x240 + (_x))

	)

316 
	#NFP_NET_CFG_RXR_PRIO
(
_x
è(
NFP_NET_CFG_RXR_BASE
 + 0x280 + (_x))

	)

317 
	#NFP_NET_CFG_RXR_IRQ_MOD
(
_x
è(
NFP_NET_CFG_RXR_BASE
 + 0x300 + \

318 ((
_x
è* 0x4))

	)

330 
	#NFP_NET_CFG_ICR_BASE
 0x0c00

	)

331 
	#NFP_NET_CFG_ICR
(
_x
è(
NFP_NET_CFG_ICR_BASE
 + (_x))

	)

332 
	#NFP_NET_CFG_ICR_UNMASKED
 0x0

	)

333 
	#NFP_NET_CFG_ICR_RXTX
 0x1

	)

334 
	#NFP_NET_CFG_ICR_LSC
 0x2

	)

340 
	#NFP_NET_CFG_STATS_BASE
 0x0d00

	)

341 
	#NFP_NET_CFG_STATS_RX_DISCARDS
 (
NFP_NET_CFG_STATS_BASE
 + 0x00)

	)

342 
	#NFP_NET_CFG_STATS_RX_ERRORS
 (
NFP_NET_CFG_STATS_BASE
 + 0x08)

	)

343 
	#NFP_NET_CFG_STATS_RX_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x10)

	)

344 
	#NFP_NET_CFG_STATS_RX_UC_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x18)

	)

345 
	#NFP_NET_CFG_STATS_RX_MC_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x20)

	)

346 
	#NFP_NET_CFG_STATS_RX_BC_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x28)

	)

347 
	#NFP_NET_CFG_STATS_RX_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0x30)

	)

348 
	#NFP_NET_CFG_STATS_RX_MC_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0x38)

	)

349 
	#NFP_NET_CFG_STATS_RX_BC_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0x40)

	)

351 
	#NFP_NET_CFG_STATS_TX_DISCARDS
 (
NFP_NET_CFG_STATS_BASE
 + 0x48)

	)

352 
	#NFP_NET_CFG_STATS_TX_ERRORS
 (
NFP_NET_CFG_STATS_BASE
 + 0x50)

	)

353 
	#NFP_NET_CFG_STATS_TX_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x58)

	)

354 
	#NFP_NET_CFG_STATS_TX_UC_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x60)

	)

355 
	#NFP_NET_CFG_STATS_TX_MC_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x68)

	)

356 
	#NFP_NET_CFG_STATS_TX_BC_OCTETS
 (
NFP_NET_CFG_STATS_BASE
 + 0x70)

	)

357 
	#NFP_NET_CFG_STATS_TX_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0x78)

	)

358 
	#NFP_NET_CFG_STATS_TX_MC_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0x80)

	)

359 
	#NFP_NET_CFG_STATS_TX_BC_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0x88)

	)

361 
	#NFP_NET_CFG_STATS_APP0_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0x90)

	)

362 
	#NFP_NET_CFG_STATS_APP0_BYTES
 (
NFP_NET_CFG_STATS_BASE
 + 0x98)

	)

363 
	#NFP_NET_CFG_STATS_APP1_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0xa0)

	)

364 
	#NFP_NET_CFG_STATS_APP1_BYTES
 (
NFP_NET_CFG_STATS_BASE
 + 0xa8)

	)

365 
	#NFP_NET_CFG_STATS_APP2_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0xb0)

	)

366 
	#NFP_NET_CFG_STATS_APP2_BYTES
 (
NFP_NET_CFG_STATS_BASE
 + 0xb8)

	)

367 
	#NFP_NET_CFG_STATS_APP3_FRAMES
 (
NFP_NET_CFG_STATS_BASE
 + 0xc0)

	)

368 
	#NFP_NET_CFG_STATS_APP3_BYTES
 (
NFP_NET_CFG_STATS_BASE
 + 0xc8)

	)

376 
	#NFP_NET_CFG_TXR_STATS_BASE
 0x1000

	)

377 
	#NFP_NET_CFG_TXR_STATS
(
_x
è(
NFP_NET_CFG_TXR_STATS_BASE
 + \

378 ((
_x
è* 0x10))

	)

379 
	#NFP_NET_CFG_RXR_STATS_BASE
 0x1400

	)

380 
	#NFP_NET_CFG_RXR_STATS
(
_x
è(
NFP_NET_CFG_RXR_STATS_BASE
 + \

381 ((
_x
è* 0x10))

	)

388 
	#NFP_NET_CFG_MBOX_BASE
 0x1800

	)

389 
	#NFP_NET_CFG_MBOX_VAL_MAX_SZ
 0x1F8

	)

391 
	#NFP_NET_CFG_MBOX_SIMPLE_CMD
 0x0

	)

392 
	#NFP_NET_CFG_MBOX_SIMPLE_RET
 0x4

	)

393 
	#NFP_NET_CFG_MBOX_SIMPLE_VAL
 0x8

	)

394 
	#NFP_NET_CFG_MBOX_SIMPLE_LEN
 12

	)

396 
	#NFP_NET_CFG_MBOX_CMD_CTAG_FILTER_ADD
 1

	)

397 
	#NFP_NET_CFG_MBOX_CMD_CTAG_FILTER_KILL
 2

	)

399 
	#NFP_NET_CFG_MBOX_CMD_PCI_DSCP_PRIOMAP_SET
 5

	)

408 
	#NFP_NET_CFG_VLAN_FILTER
 
NFP_NET_CFG_MBOX_SIMPLE_VAL


	)

409 
	#NFP_NET_CFG_VLAN_FILTER_VID
 
NFP_NET_CFG_VLAN_FILTER


	)

410 
	#NFP_NET_CFG_VLAN_FILTER_PROTO
 (
NFP_NET_CFG_VLAN_FILTER
 + 2)

	)

411 
	#NFP_NET_CFG_VLAN_FILTER_SZ
 0x0004

	)

430 
	#NFP_NET_CFG_TLV_TYPE
 0x00

	)

431 
	#NFP_NET_CFG_TLV_TYPE_REQUIRED
 0x8000

	)

432 
	#NFP_NET_CFG_TLV_LENGTH
 0x02

	)

433 
	#NFP_NET_CFG_TLV_LENGTH_INC
 4

	)

434 
	#NFP_NET_CFG_TLV_VALUE
 0x04

	)

436 
	#NFP_NET_CFG_TLV_HEADER_REQUIRED
 0x80000000

	)

437 
	#NFP_NET_CFG_TLV_HEADER_TYPE
 0x7fff0000

	)

438 
	#NFP_NET_CFG_TLV_HEADER_LENGTH
 0x0000ffff

	)

473 
	#NFP_NET_CFG_TLV_TYPE_UNKNOWN
 0

	)

474 
	#NFP_NET_CFG_TLV_TYPE_RESERVED
 1

	)

475 
	#NFP_NET_CFG_TLV_TYPE_END
 2

	)

476 
	#NFP_NET_CFG_TLV_TYPE_ME_FREQ
 3

	)

477 
	#NFP_NET_CFG_TLV_TYPE_MBOX
 4

	)

478 
	#NFP_NET_CFG_TLV_TYPE_EXPERIMENTAL0
 5

	)

479 
	#NFP_NET_CFG_TLV_TYPE_EXPERIMENTAL1
 6

	)

480 
	#NFP_NET_CFG_TLV_TYPE_REPR_CAP
 7

	)

482 
	gdeviû
;

491 
	snå_Ãt_Žv_ÿps
 {

492 
u32
 
	mme_äeq_mhz
;

493 
	mmbox_off
;

494 
	mmbox_Ën
;

495 
u32
 
	m»´_ÿp
;

498 
nå_Ãt_Žv_ÿps_·r£
(
deviû
 *
dev
, 
u8
 
__iomem
 *
ù¾_mem
,

499 
nå_Ãt_Žv_ÿps
 *
ÿps
);

501 
šlše
 
boÞ
 
	$nå_Ãt_has_mbox
(
nå_Ãt_Žv_ÿps
 *
ÿps
)

503  
ÿps
->
mbox_Ën
 >ð
NFP_NET_CFG_MBOX_SIMPLE_LEN
;

504 
	}
}

	@src/nfp_net_debugdump.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/‘htoÞ.h
>

7 
	~<lšux/vm®loc.h
>

9 
	~"nå_asm.h
"

10 
	~"nå_maš.h
"

11 
	~"nåcÜe/nå.h
"

12 
	~"nåcÜe/nå_nffw.h
"

13 
	~"nåcÜe/nå6000/nå6000.h
"

15 
	#NFP_DUMP_SPEC_RTSYM
 "_abi_dump_¥ec"

	)

17 
	#ALIGN8
(
x
è
	`ALIGN
(x, 8)

	)

19 
	enå_dump¥ec_ty³
 {

20 
	mNFP_DUMPSPEC_TYPE_CPP_CSR
 = 0,

21 
	mNFP_DUMPSPEC_TYPE_XPB_CSR
 = 1,

22 
	mNFP_DUMPSPEC_TYPE_ME_CSR
 = 2,

23 
	mNFP_DUMPSPEC_TYPE_INDIRECT_ME_CSR
 = 3,

24 
	mNFP_DUMPSPEC_TYPE_RTSYM
 = 4,

25 
	mNFP_DUMPSPEC_TYPE_HWINFO
 = 5,

26 
	mNFP_DUMPSPEC_TYPE_FWNAME
 = 6,

27 
	mNFP_DUMPSPEC_TYPE_HWINFO_FIELD
 = 7,

28 
	mNFP_DUMPSPEC_TYPE_PROLOG
 = 10000,

29 
	mNFP_DUMPSPEC_TYPE_ERROR
 = 10001,

38 
	snå_dump_Ž
 {

39 
__be32
 
	mty³
;

40 
__be32
 
	mËngth
;

41 
	md©a
[0];

45 
	snå_dump¥ec_ýp_i¦_id
 {

46 
u8
 
	mrg‘
;

47 
u8
 
	maùiÚ
;

48 
u8
 
	mtok’
;

49 
u8
 
	mi¦ªd
;

52 
	snå_dump_commÚ_ýp
 {

53 
nå_dump¥ec_ýp_i¦_id
 
	mýp_id
;

54 
__be32
 
	moff£t
;

55 
__be32
 
	mdump_Ëngth
;

59 
	snå_dump¥ec_c¤
 {

60 
nå_dump_Ž
 
	mŽ
;

61 
nå_dump_commÚ_ýp
 
	mýp
;

62 
__be32
 
	m»gi¡”_width
;

65 
	snå_dump¥ec_¹sym
 {

66 
nå_dump_Ž
 
	mŽ
;

67 
	m¹sym
[0];

71 
	snå_dump_c¤
 {

72 
nå_dump_Ž
 
	mŽ
;

73 
nå_dump_commÚ_ýp
 
	mýp
;

74 
__be32
 
	m»gi¡”_width
;

75 
__be32
 
	m”rÜ
;

76 
__be32
 
	m”rÜ_off£t
;

79 
	snå_dump_¹sym
 {

80 
nå_dump_Ž
 
	mŽ
;

81 
nå_dump_commÚ_ýp
 
	mýp
;

82 
__be32
 
	m”rÜ
;

83 
u8
 
	m·dded_Çme_Ëngth
;

84 
	m¹sym
[0];

88 
	snå_dump_´Þog
 {

89 
nå_dump_Ž
 
	mŽ
;

90 
__be32
 
	mdump_Ëv–
;

93 
	snå_dump_”rÜ
 {

94 
nå_dump_Ž
 
	mŽ
;

95 
__be32
 
	m”rÜ
;

96 
	m·ddšg
[4];

97 
	m¥ec
[0];

101 
	snå_Ëv–_size
 {

102 
__be32
 
	m»que¡ed_Ëv–
;

103 
u32
 
	mtÙ®_size
;

107 
	snå_dump_¡©e
 {

108 
__be32
 
	m»que¡ed_Ëv–
;

109 
u32
 
	mdum³d_size
;

110 
u32
 
	mbuf_size
;

111 *
	mp
;

114 (*
	tnå_Žv_vis™
)(
	tnå_pf
 *
	tpf
, 
	tnå_dump_Ž
 *
	tŽ
,

115 *
	t·¿m
);

118 
	$nå_Œav”£_Žvs
(
nå_pf
 *
pf
, *
d©a
, 
u32
 
d©a_Ëngth
, *
·¿m
,

119 
nå_Žv_vis™
 
Žv_vis™
)

121 
»maššg
 = 
d©a_Ëngth
;

122 
nå_dump_Ž
 *
Ž
;

123 
u32
 
tÙ®_Žv_size
;

124 *
p
 = 
d©a
;

125 
”r
;

127 
»maššg
 >ð(*
Ž
)) {

128 
Ž
 = 
p
;

129 ià(!
Ž
->
ty³
 && !Ž->
Ëngth
)

132 ià(
	`be32_to_ýu
(
Ž
->
Ëngth
è> 
»maššg
 - (*tl))

133  -
EINVAL
;

135 
tÙ®_Žv_size
 = (*
Ž
è+ 
	`be32_to_ýu
Ñl->
Ëngth
);

138 ià(
tÙ®_Žv_size
 % 4 != 0)

139  -
EINVAL
;

141 
p
 +ð
tÙ®_Žv_size
;

142 
»maššg
 -ð
tÙ®_Žv_size
;

143 
”r
 = 
	`Žv_vis™
(
pf
, 
Ž
, 
·¿m
);

144 ià(
”r
)

145  
”r
;

149 
	}
}

151 
u32
 
	$nå_g‘_num”ic_ýp_id
(
nå_dump¥ec_ýp_i¦_id
 *
ýp_id
)

153  
	`NFP_CPP_ISLAND_ID
(
ýp_id
->
rg‘
, cµ_id->
aùiÚ
, cµ_id->
tok’
,

154 
ýp_id
->
i¦ªd
);

155 
	}
}

157 
nå_dump¥ec
 *

158 
	$nå_Ãt_dump_lßd_dump¥ec
(
nå_ýp
 *
ýp
, 
nå_¹sym_bË
 *
¹bl
)

160 cÚ¡ 
nå_¹sym
 *
¥ecsym
;

161 
nå_dump¥ec
 *
dump¥ec
;

162 
by‹s_»ad
;

163 
u64
 
sym_size
;

165 
¥ecsym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
NFP_DUMP_SPEC_RTSYM
);

166 ià(!
¥ecsym
)

167  
NULL
;

168 
sym_size
 = 
	`nå_¹sym_size
(
¥ecsym
);

171 
dump¥ec
 = 
	`vm®loc
((*dump¥ecè+ 
sym_size
);

172 ià(!
dump¥ec
)

173  
NULL
;

174 
dump¥ec
->
size
 = 
sym_size
;

176 
by‹s_»ad
 = 
	`nå_¹sym_»ad
(
ýp
, 
¥ecsym
, 0, 
dump¥ec
->
d©a
, 
sym_size
);

177 ià(
by‹s_»ad
 !ð
sym_size
) {

178 
	`vä“
(
dump¥ec
);

179 
	`nå_w¬n
(
ýp
, "Debug dump specification„ead failed.\n");

180  
NULL
;

183  
dump¥ec
;

184 
	}
}

186 
	$nå_dump_”rÜ_Žv_size
(
nå_dump_Ž
 *
¥ec
)

188  
	`ALIGN8
((
nå_dump_”rÜ
è+ (*
¥ec
) +

189 
	`be32_to_ýu
(
¥ec
->
Ëngth
));

190 
	}
}

192 
	$nå_ÿlc_fwÇme_Žv_size
(
nå_pf
 *
pf
)

194 
u32
 
fwÇme_Ën
 = 
	`¡¾’
(
	`nå_m_Çme
(
pf
->
m
));

196  (
nå_dump_Ž
è+ 
	`ALIGN8
(
fwÇme_Ën
 + 1);

197 
	}
}

199 
	$nå_ÿlc_hwšfo_f›ld_sz
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
¥ec
)

201 
u32
 
Ž_Ën
, 
key_Ën
;

202 cÚ¡ *
v®ue
;

204 
Ž_Ën
 = 
	`be32_to_ýu
(
¥ec
->
Ëngth
);

205 
key_Ën
 = 
	`¡ºËn
(
¥ec
->
d©a
, 
Ž_Ën
);

206 ià(
key_Ën
 =ð
Ž_Ën
)

207  
	`nå_dump_”rÜ_Žv_size
(
¥ec
);

209 
v®ue
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, 
¥ec
->
d©a
);

210 ià(!
v®ue
)

211  
	`nå_dump_”rÜ_Žv_size
(
¥ec
);

213  (
nå_dump_Ž
è+ 
	`ALIGN8
(
key_Ën
 + 
	`¡¾’
(
v®ue
) + 2);

214 
	}
}

216 
boÞ
 
	$nå_c¤_¥ec_v®id
(
nå_dump¥ec_c¤
 *
¥ec_c¤
)

218 
u32
 
»quœed_»ad_sz
 = (*
¥ec_c¤
è- (¥ec_c¤->
Ž
);

219 
u32
 
avažabË_sz
 = 
	`be32_to_ýu
(
¥ec_c¤
->
Ž
.
Ëngth
);

220 
u32
 
»g_width
;

222 ià(
avažabË_sz
 < 
»quœed_»ad_sz
)

223  
çl£
;

225 
»g_width
 = 
	`be32_to_ýu
(
¥ec_c¤
->
»gi¡”_width
);

227  
»g_width
 == 32 ||„eg_width == 64;

228 
	}
}

231 
	$nå_ÿlc_¹sym_dump_sz
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
¥ec
)

233 
nå_¹sym_bË
 *
¹bl
 = 
pf
->rtbl;

234 
nå_dump¥ec_¹sym
 *
¥ec_¹sym
;

235 cÚ¡ 
nå_¹sym
 *
sym
;

236 
u32
 
Ž_Ën
, 
key_Ën
;

238 
¥ec_¹sym
 = (
nå_dump¥ec_¹sym
 *)
¥ec
;

239 
Ž_Ën
 = 
	`be32_to_ýu
(
¥ec
->
Ëngth
);

240 
key_Ën
 = 
	`¡ºËn
(
¥ec_¹sym
->
¹sym
, 
Ž_Ën
);

241 ià(
key_Ën
 =ð
Ž_Ën
)

242  
	`nå_dump_”rÜ_Žv_size
(
¥ec
);

244 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
¥ec_¹sym
->
¹sym
);

245 ià(!
sym
)

246  
	`nå_dump_”rÜ_Žv_size
(
¥ec
);

248  
	`ALIGN8
(
	`off£tof
(
nå_dump_¹sym
, 
¹sym
è+ 
key_Ën
 + 1) +

249 
	`ALIGN8
(
	`nå_¹sym_size
(
sym
));

250 
	}
}

253 
	$nå_add_Žv_size
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
Ž
, *
·¿m
)

255 
nå_dump¥ec_c¤
 *
¥ec_c¤
;

256 
u32
 *
size
 = 
·¿m
;

257 
u32
 
hwšfo_size
;

259 
	`be32_to_ýu
(
Ž
->
ty³
)) {

260 
NFP_DUMPSPEC_TYPE_FWNAME
:

261 *
size
 +ð
	`nå_ÿlc_fwÇme_Žv_size
(
pf
);

263 
NFP_DUMPSPEC_TYPE_CPP_CSR
:

264 
NFP_DUMPSPEC_TYPE_XPB_CSR
:

265 
NFP_DUMPSPEC_TYPE_ME_CSR
:

266 
¥ec_c¤
 = (
nå_dump¥ec_c¤
 *)
Ž
;

267 ià(!
	`nå_c¤_¥ec_v®id
(
¥ec_c¤
))

268 *
size
 +ð
	`nå_dump_”rÜ_Žv_size
(
Ž
);

270 *
size
 +ð
	`ALIGN8
((
nå_dump_c¤
)) +

271 
	`ALIGN8
(
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
dump_Ëngth
));

273 
NFP_DUMPSPEC_TYPE_INDIRECT_ME_CSR
:

274 
¥ec_c¤
 = (
nå_dump¥ec_c¤
 *)
Ž
;

275 ià(!
	`nå_c¤_¥ec_v®id
(
¥ec_c¤
))

276 *
size
 +ð
	`nå_dump_”rÜ_Žv_size
(
Ž
);

278 *
size
 +ð
	`ALIGN8
((
nå_dump_c¤
)) +

279 
	`ALIGN8
(
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
dump_Ëngth
) *

280 
NFP_IND_NUM_CONTEXTS
);

282 
NFP_DUMPSPEC_TYPE_RTSYM
:

283 *
size
 +ð
	`nå_ÿlc_¹sym_dump_sz
(
pf
, 
Ž
);

285 
NFP_DUMPSPEC_TYPE_HWINFO
:

286 
hwšfo_size
 = 
	`nå_hwšfo_g‘_·cked_¡r_size
(
pf
->
hwšfo
);

287 *
size
 +ð(
nå_dump_Ž
è+ 
	`ALIGN8
(
hwšfo_size
);

289 
NFP_DUMPSPEC_TYPE_HWINFO_FIELD
:

290 *
size
 +ð
	`nå_ÿlc_hwšfo_f›ld_sz
(
pf
, 
Ž
);

293 *
size
 +ð
	`nå_dump_”rÜ_Žv_size
(
Ž
);

298 
	}
}

301 
	$nå_ÿlc_¥ecific_Ëv–_size
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
dump_Ëv–
,

302 *
·¿m
)

304 
nå_Ëv–_size
 *
Ëv_sz
 = 
·¿m
;

306 ià(
dump_Ëv–
->
ty³
 !ð
Ëv_sz
->
»que¡ed_Ëv–
)

309  
	`nå_Œav”£_Žvs
(
pf
, 
dump_Ëv–
->
d©a
,

310 
	`be32_to_ýu
(
dump_Ëv–
->
Ëngth
),

311 &
Ëv_sz
->
tÙ®_size
, 
nå_add_Žv_size
);

312 
	}
}

314 
s64
 
	$nå_Ãt_dump_ÿlcuÏ‹_size
(
nå_pf
 *
pf
, 
nå_dump¥ec
 *
¥ec
,

315 
u32
 
æag
)

317 
nå_Ëv–_size
 
Ëv_sz
;

318 
”r
;

320 
Ëv_sz
.
»que¡ed_Ëv–
 = 
	`ýu_to_be32
(
æag
);

321 
Ëv_sz
.
tÙ®_size
 = 
	`ALIGN8
((
nå_dump_´Þog
));

323 
”r
 = 
	`nå_Œav”£_Žvs
(
pf
, 
¥ec
->
d©a
, s³c->
size
, &
Ëv_sz
,

324 
nå_ÿlc_¥ecific_Ëv–_size
);

325 ià(
”r
)

326  
”r
;

328  
Ëv_sz
.
tÙ®_size
;

329 
	}
}

331 
	$nå_add_Žv
(
u32
 
ty³
, u32 
tÙ®_Žv_sz
, 
nå_dump_¡©e
 *
dump
)

333 
nå_dump_Ž
 *
Ž
 = 
dump
->
p
;

335 ià(
tÙ®_Žv_sz
 > 
dump
->
buf_size
)

336  -
ENOSPC
;

338 ià(
dump
->
buf_size
 - 
tÙ®_Žv_sz
 < dump->
dum³d_size
)

339  -
ENOSPC
;

341 
Ž
->
ty³
 = 
	`ýu_to_be32
(type);

342 
Ž
->
Ëngth
 = 
	`ýu_to_be32
(
tÙ®_Žv_sz
 - (*tl));

344 
dump
->
dum³d_size
 +ð
tÙ®_Žv_sz
;

345 
dump
->
p
 +ð
tÙ®_Žv_sz
;

348 
	}
}

351 
	$nå_dump_”rÜ_Žv
(
nå_dump_Ž
 *
¥ec
, 
”rÜ
,

352 
nå_dump_¡©e
 *
dump
)

354 
nå_dump_”rÜ
 *
dump_h—d”
 = 
dump
->
p
;

355 
u32
 
tÙ®_¥ec_size
, 
tÙ®_size
;

356 
”r
;

358 
tÙ®_¥ec_size
 = (*
¥ec
è+ 
	`be32_to_ýu
(¥ec->
Ëngth
);

359 
tÙ®_size
 = 
	`ALIGN8
((*
dump_h—d”
è+ 
tÙ®_¥ec_size
);

361 
”r
 = 
	`nå_add_Žv
(
NFP_DUMPSPEC_TYPE_ERROR
, 
tÙ®_size
, 
dump
);

362 ià(
”r
)

363  
”r
;

365 
dump_h—d”
->
”rÜ
 = 
	`ýu_to_be32
(error);

366 
	`memýy
(
dump_h—d”
->
¥ec
, s³c, 
tÙ®_¥ec_size
);

369 
	}
}

371 
	$nå_dump_fwÇme
(
nå_pf
 *
pf
, 
nå_dump_¡©e
 *
dump
)

373 
nå_dump_Ž
 *
dump_h—d”
 = 
dump
->
p
;

374 
u32
 
fwÇme_Ën
, 
tÙ®_size
;

375 cÚ¡ *
fwÇme
;

376 
”r
;

378 
fwÇme
 = 
	`nå_m_Çme
(
pf
->
m
);

379 
fwÇme_Ën
 = 
	`¡¾’
(
fwÇme
);

380 
tÙ®_size
 = (*
dump_h—d”
è+ 
	`ALIGN8
(
fwÇme_Ën
 + 1);

382 
”r
 = 
	`nå_add_Žv
(
NFP_DUMPSPEC_TYPE_FWNAME
, 
tÙ®_size
, 
dump
);

383 ià(
”r
)

384  
”r
;

386 
	`memýy
(
dump_h—d”
->
d©a
, 
fwÇme
, 
fwÇme_Ën
);

389 
	}
}

392 
	$nå_dump_hwšfo
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
¥ec
,

393 
nå_dump_¡©e
 *
dump
)

395 
nå_dump_Ž
 *
dump_h—d”
 = 
dump
->
p
;

396 
u32
 
hwšfo_size
, 
tÙ®_size
;

397 *
hwšfo
;

398 
”r
;

400 
hwšfo
 = 
	`nå_hwšfo_g‘_·cked_¡ršgs
(
pf
->hwinfo);

401 
hwšfo_size
 = 
	`nå_hwšfo_g‘_·cked_¡r_size
(
pf
->
hwšfo
);

402 
tÙ®_size
 = (*
dump_h—d”
è+ 
	`ALIGN8
(
hwšfo_size
);

404 
”r
 = 
	`nå_add_Žv
(
NFP_DUMPSPEC_TYPE_HWINFO
, 
tÙ®_size
, 
dump
);

405 ià(
”r
)

406  
”r
;

408 
	`memýy
(
dump_h—d”
->
d©a
, 
hwšfo
, 
hwšfo_size
);

411 
	}
}

413 
	$nå_dump_hwšfo_f›ld
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
¥ec
,

414 
nå_dump_¡©e
 *
dump
)

416 
nå_dump_Ž
 *
dump_h—d”
 = 
dump
->
p
;

417 
u32
 
Ž_Ën
, 
key_Ën
, 
v®_Ën
;

418 cÚ¡ *
key
, *
v®ue
;

419 
u32
 
tÙ®_size
;

420 
”r
;

422 
Ž_Ën
 = 
	`be32_to_ýu
(
¥ec
->
Ëngth
);

423 
key_Ën
 = 
	`¡ºËn
(
¥ec
->
d©a
, 
Ž_Ën
);

424 ià(
key_Ën
 =ð
Ž_Ën
)

425  
	`nå_dump_”rÜ_Žv
(
¥ec
, -
EINVAL
, 
dump
);

427 
key
 = 
¥ec
->
d©a
;

428 
v®ue
 = 
	`nå_hwšfo_lookup
(
pf
->
hwšfo
, 
key
);

429 ià(!
v®ue
)

430  
	`nå_dump_”rÜ_Žv
(
¥ec
, -
ENOENT
, 
dump
);

432 
v®_Ën
 = 
	`¡¾’
(
v®ue
);

433 
tÙ®_size
 = (*
dump_h—d”
è+ 
	`ALIGN8
(
key_Ën
 + 
v®_Ën
 + 2);

434 
”r
 = 
	`nå_add_Žv
(
NFP_DUMPSPEC_TYPE_HWINFO_FIELD
, 
tÙ®_size
, 
dump
);

435 ià(
”r
)

436  
”r
;

438 
	`memýy
(
dump_h—d”
->
d©a
, 
key
, 
key_Ën
 + 1);

439 
	`memýy
(
dump_h—d”
->
d©a
 + 
key_Ën
 + 1, 
v®ue
, 
v®_Ën
 + 1);

442 
	}
}

444 
boÞ
 
	$is_xpb_»ad
(
nå_dump¥ec_ýp_i¦_id
 *
ýp_id
)

446  
ýp_id
->
rg‘
 =ð
NFP_CPP_TARGET_ISLAND_XPB
 &&

447 
ýp_id
->
aùiÚ
 =ð0 && cµ_id->
tok’
 == 0;

448 
	}
}

451 
	$nå_dump_c¤_¿nge
(
nå_pf
 *
pf
, 
nå_dump¥ec_c¤
 *
¥ec_c¤
,

452 
nå_dump_¡©e
 *
dump
)

454 
nå_dump_c¤
 *
dump_h—d”
 = 
dump
->
p
;

455 
u32
 
»g_sz
, 
h—d”_size
, 
tÙ®_size
;

456 
u32
 
ýp_rd_addr
, 
max_rd_addr
;

457 
by‹s_»ad
;

458 *
de¡
;

459 
u32
 
ýp_id
;

460 
”r
;

462 ià(!
	`nå_c¤_¥ec_v®id
(
¥ec_c¤
))

463  
	`nå_dump_”rÜ_Žv
(&
¥ec_c¤
->
Ž
, -
EINVAL
, 
dump
);

465 
»g_sz
 = 
	`be32_to_ýu
(
¥ec_c¤
->
»gi¡”_width
è/ 
BITS_PER_BYTE
;

466 
h—d”_size
 = 
	`ALIGN8
((*
dump_h—d”
));

467 
tÙ®_size
 = 
h—d”_size
 +

468 
	`ALIGN8
(
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
dump_Ëngth
));

469 
de¡
 = 
dump
->
p
 + 
h—d”_size
;

471 
”r
 = 
	`nå_add_Žv
(
	`be32_to_ýu
(
¥ec_c¤
->
Ž
.
ty³
), 
tÙ®_size
, 
dump
);

472 ià(
”r
)

473  
”r
;

475 
dump_h—d”
->
ýp
 = 
¥ec_c¤
->cpp;

476 
dump_h—d”
->
»gi¡”_width
 = 
¥ec_c¤
->register_width;

478 
ýp_id
 = 
	`nå_g‘_num”ic_ýp_id
(&
¥ec_c¤
->
ýp
.cpp_id);

479 
ýp_rd_addr
 = 
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
off£t
);

480 
max_rd_addr
 = 
ýp_rd_addr
 + 
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
dump_Ëngth
);

482 
ýp_rd_addr
 < 
max_rd_addr
) {

483 ià(
	`is_xpb_»ad
(&
¥ec_c¤
->
ýp
.
ýp_id
)) {

484 
”r
 = 
	`nå_xpb_»adl
(
pf
->
ýp
, 
ýp_rd_addr
, (
u32
 *)
de¡
);

486 
by‹s_»ad
 = 
	`nå_ýp_»ad
(
pf
->
ýp
, 
ýp_id
, 
ýp_rd_addr
,

487 
de¡
, 
»g_sz
);

488 
”r
 = 
by‹s_»ad
 =ð
»g_sz
 ? 0 : -
EIO
;

490 ià(
”r
) {

491 
dump_h—d”
->
”rÜ
 = 
	`ýu_to_be32
(
”r
);

492 
dump_h—d”
->
”rÜ_off£t
 = 
	`ýu_to_be32
(
ýp_rd_addr
);

495 
ýp_rd_addr
 +ð
»g_sz
;

496 
de¡
 +ð
»g_sz
;

500 
	}
}

506 
	$nå_»ad_šdœeù_c¤
(
nå_ýp
 *
ýp
,

507 
nå_dump¥ec_ýp_i¦_id
 
ýp_·¿ms
, 
u32
 
off£t
,

508 
u32
 
»g_sz
, u32 
cÚ‹xt
, *
de¡
)

510 
u32
 
c¤_ùx_±r_offs
;

511 
u32
 
ýp_id
;

512 
»suÉ
;

514 
c¤_ùx_±r_offs
 = 
	`nå_g‘_šd_c¤_ùx_±r_offs
(
off£t
);

515 
ýp_id
 = 
	`NFP_CPP_ISLAND_ID
(
ýp_·¿ms
.
rg‘
,

516 
NFP_IND_ME_REFL_WR_SIG_INIT
,

517 
ýp_·¿ms
.
tok’
, cµ_·¿ms.
i¦ªd
);

518 
»suÉ
 = 
	`nå_ýp_wr™–
(
ýp
, 
ýp_id
, 
c¤_ùx_±r_offs
, 
cÚ‹xt
);

519 ià(
»suÉ
)

520  
»suÉ
;

522 
ýp_id
 = 
	`nå_g‘_num”ic_ýp_id
(&
ýp_·¿ms
);

523 
»suÉ
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
c¤_ùx_±r_offs
, 
de¡
, 
»g_sz
);

524 ià(
»suÉ
 !ð
»g_sz
)

525  
»suÉ
 < 0 ?„esuÉ : -
EIO
;

527 
»suÉ
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
off£t
, 
de¡
, 
»g_sz
);

528 ià(
»suÉ
 !ð
»g_sz
)

529  
»suÉ
 < 0 ?„esuÉ : -
EIO
;

532 
	}
}

535 
	$nå_»ad_®l_šdœeù_c¤_ùx
(
nå_ýp
 *
ýp
,

536 
nå_dump¥ec_c¤
 *
¥ec_c¤
, 
u32
 
add»ss
,

537 
u32
 
»g_sz
, *
de¡
)

539 
u32
 
ùx
;

540 
”r
;

542 
ùx
 = 0; ctx < 
NFP_IND_NUM_CONTEXTS
; ctx++) {

543 
”r
 = 
	`nå_»ad_šdœeù_c¤
(
ýp
, 
¥ec_c¤
->ýp.
ýp_id
, 
add»ss
,

544 
»g_sz
, 
ùx
, 
de¡
 + ctx *„eg_sz);

545 ià(
”r
)

546  
”r
;

550 
	}
}

553 
	$nå_dump_šdœeù_c¤_¿nge
(
nå_pf
 *
pf
,

554 
nå_dump¥ec_c¤
 *
¥ec_c¤
,

555 
nå_dump_¡©e
 *
dump
)

557 
nå_dump_c¤
 *
dump_h—d”
 = 
dump
->
p
;

558 
u32
 
»g_sz
, 
h—d”_size
, 
tÙ®_size
;

559 
u32
 
ýp_rd_addr
, 
max_rd_addr
;

560 
u32
 
»g_d©a_Ëngth
;

561 *
de¡
;

562 
”r
;

564 ià(!
	`nå_c¤_¥ec_v®id
(
¥ec_c¤
))

565  
	`nå_dump_”rÜ_Žv
(&
¥ec_c¤
->
Ž
, -
EINVAL
, 
dump
);

567 
»g_sz
 = 
	`be32_to_ýu
(
¥ec_c¤
->
»gi¡”_width
è/ 
BITS_PER_BYTE
;

568 
h—d”_size
 = 
	`ALIGN8
((*
dump_h—d”
));

569 
»g_d©a_Ëngth
 = 
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
dump_Ëngth
) *

570 
NFP_IND_NUM_CONTEXTS
;

571 
tÙ®_size
 = 
h—d”_size
 + 
	`ALIGN8
(
»g_d©a_Ëngth
);

572 
de¡
 = 
dump
->
p
 + 
h—d”_size
;

574 
”r
 = 
	`nå_add_Žv
(
	`be32_to_ýu
(
¥ec_c¤
->
Ž
.
ty³
), 
tÙ®_size
, 
dump
);

575 ià(
”r
)

576  
”r
;

578 
dump_h—d”
->
ýp
 = 
¥ec_c¤
->cpp;

579 
dump_h—d”
->
»gi¡”_width
 = 
¥ec_c¤
->register_width;

581 
ýp_rd_addr
 = 
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
off£t
);

582 
max_rd_addr
 = 
ýp_rd_addr
 + 
	`be32_to_ýu
(
¥ec_c¤
->
ýp
.
dump_Ëngth
);

583 
ýp_rd_addr
 < 
max_rd_addr
) {

584 
”r
 = 
	`nå_»ad_®l_šdœeù_c¤_ùx
(
pf
->
ýp
, 
¥ec_c¤
,

585 
ýp_rd_addr
, 
»g_sz
, 
de¡
);

586 ià(
”r
) {

587 
dump_h—d”
->
”rÜ
 = 
	`ýu_to_be32
(
”r
);

588 
dump_h—d”
->
”rÜ_off£t
 = 
	`ýu_to_be32
(
ýp_rd_addr
);

591 
ýp_rd_addr
 +ð
»g_sz
;

592 
de¡
 +ð
»g_sz
 * 
NFP_IND_NUM_CONTEXTS
;

596 
	}
}

599 
	$nå_dump_sšgË_¹sym
(
nå_pf
 *
pf
, 
nå_dump¥ec_¹sym
 *
¥ec
,

600 
nå_dump_¡©e
 *
dump
)

602 
nå_dump_¹sym
 *
dump_h—d”
 = 
dump
->
p
;

603 
nå_dump¥ec_ýp_i¦_id
 
ýp_·¿ms
;

604 
nå_¹sym_bË
 *
¹bl
 = 
pf
->rtbl;

605 
u32
 
h—d”_size
, 
tÙ®_size
, 
sym_size
;

606 cÚ¡ 
nå_¹sym
 *
sym
;

607 
u32
 
Ž_Ën
, 
key_Ën
;

608 
by‹s_»ad
;

609 *
de¡
;

610 
”r
;

612 
Ž_Ën
 = 
	`be32_to_ýu
(
¥ec
->
Ž
.
Ëngth
);

613 
key_Ën
 = 
	`¡ºËn
(
¥ec
->
¹sym
, 
Ž_Ën
);

614 ià(
key_Ën
 =ð
Ž_Ën
)

615  
	`nå_dump_”rÜ_Žv
(&
¥ec
->
Ž
, -
EINVAL
, 
dump
);

617 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
¥ec
->
¹sym
);

618 ià(!
sym
)

619  
	`nå_dump_”rÜ_Žv
(&
¥ec
->
Ž
, -
ENOENT
, 
dump
);

621 
sym_size
 = 
	`nå_¹sym_size
(
sym
);

622 
h—d”_size
 =

623 
	`ALIGN8
(
	`off£tof
(
nå_dump_¹sym
, 
¹sym
è+ 
key_Ën
 + 1);

624 
tÙ®_size
 = 
h—d”_size
 + 
	`ALIGN8
(
sym_size
);

625 
de¡
 = 
dump
->
p
 + 
h—d”_size
;

627 
”r
 = 
	`nå_add_Žv
(
	`be32_to_ýu
(
¥ec
->
Ž
.
ty³
), 
tÙ®_size
, 
dump
);

628 ià(
”r
)

629  
”r
;

631 
dump_h—d”
->
·dded_Çme_Ëngth
 =

632 
h—d”_size
 - 
	`off£tof
(
nå_dump_¹sym
, 
¹sym
);

633 
	`memýy
(
dump_h—d”
->
¹sym
, 
¥ec
->¹sym, 
key_Ën
 + 1);

634 
dump_h—d”
->
ýp
.
dump_Ëngth
 = 
	`ýu_to_be32
(
sym_size
);

636 ià(
sym
->
ty³
 !ð
NFP_RTSYM_TYPE_ABS
) {

637 
ýp_·¿ms
.
rg‘
 = 
sym
->target;

638 
ýp_·¿ms
.
aùiÚ
 = 
NFP_CPP_ACTION_RW
;

639 
ýp_·¿ms
.
tok’
 = 0;

640 
ýp_·¿ms
.
i¦ªd
 = 
sym
->
domaš
;

641 
dump_h—d”
->
ýp
.
ýp_id
 = 
ýp_·¿ms
;

642 
dump_h—d”
->
ýp
.
off£t
 = 
	`ýu_to_be32
(
sym
->
addr
);

645 
by‹s_»ad
 = 
	`nå_¹sym_»ad
(
pf
->
ýp
, 
sym
, 0, 
de¡
, 
sym_size
);

646 ià(
by‹s_»ad
 !ð
sym_size
) {

647 ià(
by‹s_»ad
 >= 0)

648 
by‹s_»ad
 = -
EIO
;

649 
dump_h—d”
->
”rÜ
 = 
	`ýu_to_be32
(
by‹s_»ad
);

653 
	}
}

656 
	$nå_dump_fÜ_Žv
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
Ž
, *
·¿m
)

658 
nå_dump¥ec_¹sym
 *
¥ec_¹sym
;

659 
nå_dump_¡©e
 *
dump
 = 
·¿m
;

660 
nå_dump¥ec_c¤
 *
¥ec_c¤
;

661 
”r
;

663 
	`be32_to_ýu
(
Ž
->
ty³
)) {

664 
NFP_DUMPSPEC_TYPE_FWNAME
:

665 
”r
 = 
	`nå_dump_fwÇme
(
pf
, 
dump
);

666 ià(
”r
)

667  
”r
;

669 
NFP_DUMPSPEC_TYPE_CPP_CSR
:

670 
NFP_DUMPSPEC_TYPE_XPB_CSR
:

671 
NFP_DUMPSPEC_TYPE_ME_CSR
:

672 
¥ec_c¤
 = (
nå_dump¥ec_c¤
 *)
Ž
;

673 
”r
 = 
	`nå_dump_c¤_¿nge
(
pf
, 
¥ec_c¤
, 
dump
);

674 ià(
”r
)

675  
”r
;

677 
NFP_DUMPSPEC_TYPE_INDIRECT_ME_CSR
:

678 
¥ec_c¤
 = (
nå_dump¥ec_c¤
 *)
Ž
;

679 
”r
 = 
	`nå_dump_šdœeù_c¤_¿nge
(
pf
, 
¥ec_c¤
, 
dump
);

680 ià(
”r
)

681  
”r
;

683 
NFP_DUMPSPEC_TYPE_RTSYM
:

684 
¥ec_¹sym
 = (
nå_dump¥ec_¹sym
 *)
Ž
;

685 
”r
 = 
	`nå_dump_sšgË_¹sym
(
pf
, 
¥ec_¹sym
, 
dump
);

686 ià(
”r
)

687  
”r
;

689 
NFP_DUMPSPEC_TYPE_HWINFO
:

690 
”r
 = 
	`nå_dump_hwšfo
(
pf
, 
Ž
, 
dump
);

691 ià(
”r
)

692  
”r
;

694 
NFP_DUMPSPEC_TYPE_HWINFO_FIELD
:

695 
”r
 = 
	`nå_dump_hwšfo_f›ld
(
pf
, 
Ž
, 
dump
);

696 ià(
”r
)

697  
”r
;

700 
”r
 = 
	`nå_dump_”rÜ_Žv
(
Ž
, -
EOPNOTSUPP
, 
dump
);

701 ià(
”r
)

702  
”r
;

706 
	}
}

709 
	$nå_dump_¥ecific_Ëv–
(
nå_pf
 *
pf
, 
nå_dump_Ž
 *
dump_Ëv–
,

710 *
·¿m
)

712 
nå_dump_¡©e
 *
dump
 = 
·¿m
;

714 ià(
dump_Ëv–
->
ty³
 !ð
dump
->
»que¡ed_Ëv–
)

717  
	`nå_Œav”£_Žvs
(
pf
, 
dump_Ëv–
->
d©a
,

718 
	`be32_to_ýu
(
dump_Ëv–
->
Ëngth
), 
dump
,

719 
nå_dump_fÜ_Žv
);

720 
	}
}

722 
	$nå_dump_pÝuÏ‹_´Þog
(
nå_dump_¡©e
 *
dump
)

724 
nå_dump_´Þog
 *
´Þog
 = 
dump
->
p
;

725 
u32
 
tÙ®_size
;

726 
”r
;

728 
tÙ®_size
 = 
	`ALIGN8
((*
´Þog
));

730 
”r
 = 
	`nå_add_Žv
(
NFP_DUMPSPEC_TYPE_PROLOG
, 
tÙ®_size
, 
dump
);

731 ià(
”r
)

732  
”r
;

734 
´Þog
->
dump_Ëv–
 = 
dump
->
»que¡ed_Ëv–
;

737 
	}
}

739 
	$nå_Ãt_dump_pÝuÏ‹_bufãr
(
nå_pf
 *
pf
, 
nå_dump¥ec
 *
¥ec
,

740 
‘htoÞ_dump
 *
dump_·¿m
, *
de¡
)

742 
nå_dump_¡©e
 
dump
;

743 
”r
;

745 
dump
.
»que¡ed_Ëv–
 = 
	`ýu_to_be32
(
dump_·¿m
->
æag
);

746 
dump
.
dum³d_size
 = 0;

747 
dump
.
p
 = 
de¡
;

748 
dump
.
buf_size
 = 
dump_·¿m
->
Ën
;

750 
”r
 = 
	`nå_dump_pÝuÏ‹_´Þog
(&
dump
);

751 ià(
”r
)

752  
”r
;

754 
”r
 = 
	`nå_Œav”£_Žvs
(
pf
, 
¥ec
->
d©a
, s³c->
size
, &
dump
,

755 
nå_dump_¥ecific_Ëv–
);

756 ià(
”r
)

757  
”r
;

762 
dump_·¿m
->
Ën
 = 
dump
.
dum³d_size
;

765 
	}
}

	@src/nfp_net_debugfs.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/debugfs.h
>

7 
	~<lšux/moduË.h
>

8 
	~<lšux/¹ÃŽšk.h
>

10 
	~"nå_Ãt.h
"

11 
	~"nå_Ãt_dp.h
"

13 
d’Œy
 *
	gnå_dœ
;

15 
	$nå_rx_q_show
(
£q_fže
 *
fže
, *
d©a
)

17 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
fže
->
´iv©e
;

18 
nå_Ãt_rx_ršg
 *
rx_ršg
;

19 
æ_rd_p
, 
æ_wr_p
, 
rxd_út
;

20 
nå_Ãt_rx_desc
 *
rxd
;

21 
nå_Ãt
 *
Â
;

22 *
äag
;

23 
i
;

25 
	`¹Æ_lock
();

27 ià(!
r_vec
->
nå_Ãt
 || !r_vec->
rx_ršg
)

28 
out
;

29 
Â
 = 
r_vec
->
nå_Ãt
;

30 
rx_ršg
 = 
r_vec
->rx_ring;

31 ià(!
	`nå_Ãt_ruÂšg
(
Â
))

32 
out
;

34 
rxd_út
 = 
rx_ršg
->
út
;

36 
æ_rd_p
 = 
	`nå_qý_rd_±r_»ad
(
rx_ršg
->
qý_æ
);

37 
æ_wr_p
 = 
	`nå_qý_wr_±r_»ad
(
rx_ršg
->
qý_æ
);

39 
	`£q_´štf
(
fže
, "RX[%02d,%02d]: cnt=%u dma=%pad host=%p H_RD=%u H_WR=%u FL_RD=%u FL_WR=%u\n",

40 
rx_ršg
->
idx
,„x_ršg->
æ_qcidx
,

41 
rx_ršg
->
út
, &rx_ršg->
dma
,„x_ršg->
rxds
,

42 
rx_ršg
->
rd_p
,„x_ršg->
wr_p
, 
æ_rd_p
, 
æ_wr_p
);

44 
i
 = 0; i < 
rxd_út
; i++) {

45 
rxd
 = &
rx_ršg
->
rxds
[
i
];

46 
	`£q_´štf
(
fže
, "%04d: 0x%08x 0x%08x", 
i
,

47 
rxd
->
v®s
[0],„xd->vals[1]);

49 
äag
 = 
	`READ_ONCE
(
rx_ršg
->
rxbufs
[
i
].frag);

50 ià(
äag
)

51 
	`£q_´štf
(
fže
, " f¿g=%p", 
äag
);

53 ià(
rx_ršg
->
rxbufs
[
i
].
dma_addr
)

54 
	`£q_´štf
(
fže
, " dma_addr=%pad",

55 &
rx_ršg
->
rxbufs
[
i
].
dma_addr
);

57 ià(
i
 =ð
rx_ršg
->
rd_p
 % 
rxd_út
)

58 
	`£q_puts
(
fže
, " H_RD ");

59 ià(
i
 =ð
rx_ršg
->
wr_p
 % 
rxd_út
)

60 
	`£q_puts
(
fže
, " H_WR ");

61 ià(
i
 =ð
æ_rd_p
 % 
rxd_út
)

62 
	`£q_puts
(
fže
, " FL_RD");

63 ià(
i
 =ð
æ_wr_p
 % 
rxd_út
)

64 
	`£q_puts
(
fže
, " FL_WR");

66 
	`£q_putc
(
fže
, '\n');

68 
out
:

69 
	`¹Æ_uÆock
();

71 
	}
}

72 
DEFINE_SHOW_ATTRIBUTE
(
nå_rx_q
);

74 
nå_tx_q_show
(
£q_fže
 *
fže
, *
d©a
);

75 
DEFINE_SHOW_ATTRIBUTE
(
nå_tx_q
);

77 
	$nå_tx_q_show
(
£q_fže
 *
fže
, *
d©a
)

79 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
fže
->
´iv©e
;

80 
nå_Ãt_tx_ršg
 *
tx_ršg
;

81 
nå_Ãt
 *
Â
;

82 
d_rd_p
, 
d_wr_p
;

84 
	`¹Æ_lock
();

86 ià(
	`debugfs_»®_fÝs
(
fže
->fžeè=ð&
nå_tx_q_fÝs
)

87 
tx_ršg
 = 
r_vec
->tx_ring;

89 
tx_ršg
 = 
r_vec
->
xdp_ršg
;

90 ià(!
r_vec
->
nå_Ãt
 || !
tx_ršg
)

91 
out
;

92 
Â
 = 
r_vec
->
nå_Ãt
;

93 ià(!
	`nå_Ãt_ruÂšg
(
Â
))

94 
out
;

96 
d_rd_p
 = 
	`nå_qý_rd_±r_»ad
(
tx_ršg
->
qý_q
);

97 
d_wr_p
 = 
	`nå_qý_wr_±r_»ad
(
tx_ršg
->
qý_q
);

99 
	`£q_´štf
(
fže
, "TX[%02d,%02d%s]: cnt=%u dma=%pad host=%p H_RD=%u H_WR=%u D_RD=%u D_WR=%u",

100 
tx_ršg
->
idx
,x_ršg->
qcidx
,

101 
tx_ršg
 =ð
r_vec
->tx_ring ? "" : "xdp",

102 
tx_ršg
->
út
, &tx_ršg->
dma
,x_ršg->
txds
,

103 
tx_ršg
->
rd_p
,x_ršg->
wr_p
, 
d_rd_p
, 
d_wr_p
);

104 ià(
tx_ršg
->
txrwb
)

105 
	`£q_´štf
(
fže
, " TXRWB=%Îu", *
tx_ršg
->
txrwb
);

106 
	`£q_putc
(
fže
, '\n');

108 
	`nå_Ãt_debugfs_´št_tx_descs
(
fže
, &
Â
->
dp
, 
r_vec
, 
tx_ršg
,

109 
d_rd_p
, 
d_wr_p
);

110 
out
:

111 
	`¹Æ_uÆock
();

113 
	}
}

115 #ià
COMPAT__HAVE_XDP


116 
	$nå_xdp_q_show
(
£q_fže
 *
fže
, *
d©a
)

118  
	`nå_tx_q_show
(
fže
, 
d©a
);

119 
	}
}

120 
DEFINE_SHOW_ATTRIBUTE
(
nå_xdp_q
);

123 
	$nå_Ãt_debugfs_vnic_add
(
nå_Ãt
 *
Â
, 
d’Œy
 *
ddœ
)

125 
d’Œy
 *
queues
, *
tx
, *
rx
, *
xdp
;

126 
Çme
[20];

127 
i
;

129 ià(
	`IS_ERR_OR_NULL
(
nå_dœ
))

132 ià(
	`nå_Ãt_is_d©a_vnic
(
Â
))

133 
	`¥rštf
(
Çme
, "vnic%d", 
Â
->
id
);

135 
	`¡rýy
(
Çme
, "ctrl-vnic");

136 
Â
->
debugfs_dœ
 = 
	`debugfs_ü—‹_dœ
(
Çme
, 
ddœ
);

137 ià(
	`IS_ERR_OR_NULL
(
Â
->
debugfs_dœ
))

141 
queues
 = 
	`debugfs_ü—‹_dœ
("queue", 
Â
->
debugfs_dœ
);

142 ià(
	`IS_ERR_OR_NULL
(
queues
))

145 
rx
 = 
	`debugfs_ü—‹_dœ
("rx", 
queues
);

146 
tx
 = 
	`debugfs_ü—‹_dœ
("tx", 
queues
);

147 
xdp
 = 
	`debugfs_ü—‹_dœ
("xdp", 
queues
);

148 ià(
	`IS_ERR_OR_NULL
(
rx
è|| IS_ERR_OR_NULL(
tx
è|| IS_ERR_OR_NULL(
xdp
))

151 
i
 = 0; i < 
	`mš
(
Â
->
max_rx_ršgs
,‚n->
max_r_vecs
); i++) {

152 
	`¥rštf
(
Çme
, "%d", 
i
);

153 
	`debugfs_ü—‹_fže
(
Çme
, 0400, 
rx
,

154 &
Â
->
r_vecs
[
i
], &
nå_rx_q_fÝs
);

155 #ià
COMPAT__HAVE_XDP


156 
	`debugfs_ü—‹_fže
(
Çme
, 0400, 
xdp
,

157 &
Â
->
r_vecs
[
i
], &
nå_xdp_q_fÝs
);

161 
i
 = 0; i < 
	`mš
(
Â
->
max_tx_ršgs
,‚n->
max_r_vecs
); i++) {

162 
	`¥rštf
(
Çme
, "%d", 
i
);

163 
	`debugfs_ü—‹_fže
(
Çme
, 0400, 
tx
,

164 &
Â
->
r_vecs
[
i
], &
nå_tx_q_fÝs
);

166 
	}
}

168 
d’Œy
 *
	$nå_Ãt_debugfs_deviû_add
(
pci_dev
 *
pdev
)

170 
d’Œy
 *
dev_dœ
;

172 ià(
	`IS_ERR_OR_NULL
(
nå_dœ
))

173  
NULL
;

175 
dev_dœ
 = 
	`debugfs_ü—‹_dœ
(
	`pci_Çme
(
pdev
), 
nå_dœ
);

176 ià(
	`IS_ERR_OR_NULL
(
dev_dœ
))

177  
NULL
;

179  
dev_dœ
;

180 
	}
}

182 
	$nå_Ãt_debugfs_dœ_þ—n
(
d’Œy
 **
dœ
)

184 
	`debugfs_»move_»cursive
(*
dœ
);

185 *
dœ
 = 
NULL
;

186 
	}
}

188 
	$nå_Ãt_debugfs_ü—‹
()

190 
nå_dœ
 = 
	`debugfs_ü—‹_dœ
("nå_Ãt", 
NULL
);

191 
	}
}

193 
	$nå_Ãt_debugfs_de¡roy
()

195 
	`debugfs_»move_»cursive
(
nå_dœ
);

196 
nå_dœ
 = 
NULL
;

197 
	}
}

	@src/nfp_net_dp.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~"nå_­p.h
"

7 
	~"nå_Ãt_dp.h
"

18 *
	$nå_Ãt_rx_®loc_Úe
(
nå_Ãt_dp
 *
dp
, 
dma_addr_t
 *
dma_addr
)

20 *
äag
;

22 ià(!
dp
->
xdp_´og
) {

23 
äag
 = 
	`Ãtdev_®loc_äag
(
dp
->
æ_bufsz
);

25 
·ge
 *page;

27 
·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

28 
äag
 = 
·ge
 ? 
	`·ge_add»ss
Õageè: 
NULL
;

30 ià(!
äag
) {

31 
	`Â_dp_w¬n
(
dp
, "Failedo‡lloc„eceive…age frag\n");

32  
NULL
;

35 *
dma_addr
 = 
	`nå_Ãt_dma_m­_rx
(
dp
, 
äag
);

36 ià(
	`dma_m­pšg_”rÜ
(
dp
->
dev
, *
dma_addr
)) {

37 
	`nå_Ãt_ä“_äag
(
äag
, 
dp
->
xdp_´og
);

38 
	`Â_dp_w¬n
(
dp
, "Failedo map DMA RX buffer\n");

39  
NULL
;

42  
äag
;

43 
	}
}

54 
	$nå_Ãt_tx_ršg_š™
(
nå_Ãt_tx_ršg
 *
tx_ršg
, 
nå_Ãt_dp
 *
dp
,

55 
nå_Ãt_r_veùÜ
 *
r_vec
, 
idx
,

56 
boÞ
 
is_xdp
)

58 
nå_Ãt
 *
Â
 = 
r_vec
->nfp_net;

60 
tx_ršg
->
idx
 = idx;

61 
tx_ršg
->
r_vec
 =„_vec;

62 
tx_ršg
->
is_xdp
 = is_xdp;

63 
	`u64_¡©s_š™
(&
tx_ršg
->
r_vec
->
tx_sync
);

65 
tx_ršg
->
qcidx
 =x_ršg->
idx
 * 
Â
->
¡ride_tx
;

66 
tx_ršg
->
txrwb
 = 
dp
->txrwb ? &dp->txrwb[
idx
] : 
NULL
;

67 
tx_ršg
->
qý_q
 = 
Â
->
tx_b¬
 + 
	`NFP_QCP_QUEUE_OFF
Ñx_ršg->
qcidx
);

68 
	}
}

77 
	$nå_Ãt_rx_ršg_š™
(
nå_Ãt_rx_ršg
 *
rx_ršg
,

78 
nå_Ãt_r_veùÜ
 *
r_vec
, 
idx
)

80 
nå_Ãt
 *
Â
 = 
r_vec
->nfp_net;

82 
rx_ršg
->
idx
 = idx;

83 
rx_ršg
->
r_vec
 =„_vec;

84 
	`u64_¡©s_š™
(&
rx_ršg
->
r_vec
->
rx_sync
);

86 
rx_ršg
->
æ_qcidx
 =„x_ršg->
idx
 * 
Â
->
¡ride_rx
;

87 
rx_ršg
->
qý_æ
 = 
Â
->
rx_b¬
 + 
	`NFP_QCP_QUEUE_OFF
Ôx_ršg->
æ_qcidx
);

88 
	}
}

96 
	$nå_Ãt_rx_ršg_»£t
(
nå_Ãt_rx_ršg
 *
rx_ršg
)

98 
wr_idx
, 
Ï¡_idx
;

103 ià(
rx_ršg
->
wr_p
 =ð0 &&„x_ršg->
rd_p
 == 0)

107 
wr_idx
 = 
	`D_IDX
(
rx_ršg
,„x_ršg->
wr_p
);

108 
Ï¡_idx
 = 
rx_ršg
->
út
 - 1;

109 
rx_ršg
->
rxbufs
[
wr_idx
].
dma_addr
 =„x_ršg->rxbufs[
Ï¡_idx
].dma_addr;

110 
rx_ršg
->
rxbufs
[
wr_idx
].
äag
 =„x_ršg->rxbufs[
Ï¡_idx
].frag;

111 
rx_ršg
->
rxbufs
[
Ï¡_idx
].
dma_addr
 = 0;

112 
rx_ršg
->
rxbufs
[
Ï¡_idx
].
äag
 = 
NULL
;

114 
	`mem£t
(
rx_ršg
->
rxds
, 0,„x_ršg->
size
);

115 
rx_ršg
->
wr_p
 = 0;

116 
rx_ršg
->
rd_p
 = 0;

117 
	}
}

129 
	$nå_Ãt_rx_ršg_bufs_ä“
(
nå_Ãt_dp
 *
dp
,

130 
nå_Ãt_rx_ršg
 *
rx_ršg
)

132 
i
;

134 
i
 = 0; i < 
rx_ršg
->
út
 - 1; i++) {

139 ià(!
rx_ršg
->
rxbufs
[
i
].
äag
)

142 
	`nå_Ãt_dma_unm­_rx
(
dp
, 
rx_ršg
->
rxbufs
[
i
].
dma_addr
);

143 
	`nå_Ãt_ä“_äag
(
rx_ršg
->
rxbufs
[
i
].
äag
, 
dp
->
xdp_´og
);

144 
rx_ršg
->
rxbufs
[
i
].
dma_addr
 = 0;

145 
rx_ršg
->
rxbufs
[
i
].
äag
 = 
NULL
;

147 
	}
}

155 
	$nå_Ãt_rx_ršg_bufs_®loc
(
nå_Ãt_dp
 *
dp
,

156 
nå_Ãt_rx_ršg
 *
rx_ršg
)

158 
nå_Ãt_rx_buf
 *
rxbufs
;

159 
i
;

161 
rxbufs
 = 
rx_ršg
->rxbufs;

163 
i
 = 0; i < 
rx_ršg
->
út
 - 1; i++) {

164 
rxbufs
[
i
].
äag
 = 
	`nå_Ãt_rx_®loc_Úe
(
dp
, &rxbufs[i].
dma_addr
);

165 ià(!
rxbufs
[
i
].
äag
) {

166 
	`nå_Ãt_rx_ršg_bufs_ä“
(
dp
, 
rx_ršg
);

167  -
ENOMEM
;

172 
	}
}

174 
	$nå_Ãt_tx_ršgs_´•¬e
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
)

176 
r
;

178 
dp
->
tx_ršgs
 = 
	`kÿÎoc
(dp->
num_tx_ršgs
, (*dp->tx_rings),

179 
GFP_KERNEL
);

180 ià(!
dp
->
tx_ršgs
)

181  -
ENOMEM
;

183 ià(
dp
->
ù¾
 & 
NFP_NET_CFG_CTRL_TXRWB
) {

184 
dp
->
txrwb
 = 
	`dma_z®loc_coh”’t
(dp->
dev
,

185 
dp
->
num_tx_ršgs
 * (
u64
),

186 &
dp
->
txrwb_dma
, 
GFP_KERNEL
);

187 ià(!
dp
->
txrwb
)

188 
”r_ä“_ršgs
;

191 
r
 = 0;„ < 
dp
->
num_tx_ršgs
;„++) {

192 
bŸs
 = 0;

194 ià(
r
 >ð
dp
->
num_¡ack_tx_ršgs
)

195 
bŸs
 = 
dp
->
num_¡ack_tx_ršgs
;

197 
	`nå_Ãt_tx_ršg_š™
(&
dp
->
tx_ršgs
[
r
], dp,

198 &
Â
->
r_vecs
[
r
 - 
bŸs
],„, bias);

200 ià(
	`nå_Ãt_tx_ršg_®loc
(
dp
, &dp->
tx_ršgs
[
r
]))

201 
”r_ä“_´ev
;

203 ià(
	`nå_Ãt_tx_ršg_bufs_®loc
(
dp
, &dp->
tx_ršgs
[
r
]))

204 
”r_ä“_ršg
;

209 
”r_ä“_´ev
:

210 
r
--) {

211 
	`nå_Ãt_tx_ršg_bufs_ä“
(
dp
, &dp->
tx_ršgs
[
r
]);

212 
”r_ä“_ršg
:

213 
	`nå_Ãt_tx_ršg_ä“
(
dp
, &dp->
tx_ršgs
[
r
]);

215 
”r_ä“_ršgs
:

216 
	`kä“
(
dp
->
tx_ršgs
);

217  -
ENOMEM
;

218 
	}
}

220 
	$nå_Ãt_tx_ršgs_ä“
(
nå_Ãt_dp
 *
dp
)

222 
r
;

224 
r
 = 0;„ < 
dp
->
num_tx_ršgs
;„++) {

225 
	`nå_Ãt_tx_ršg_bufs_ä“
(
dp
, &dp->
tx_ršgs
[
r
]);

226 
	`nå_Ãt_tx_ršg_ä“
(
dp
, &dp->
tx_ršgs
[
r
]);

229 ià(
dp
->
txrwb
)

230 
	`dma_ä“_coh”’t
(
dp
->
dev
, dp->
num_tx_ršgs
 * (
u64
),

231 
dp
->
txrwb
, dp->
txrwb_dma
);

232 
	`kä“
(
dp
->
tx_ršgs
);

233 
	}
}

239 
	$nå_Ãt_rx_ršg_ä“
(
nå_Ãt_rx_ršg
 *
rx_ršg
)

241 
nå_Ãt_r_veùÜ
 *
r_vec
 = 
rx_ršg
->r_vec;

242 
nå_Ãt_dp
 *
dp
 = &
r_vec
->
nå_Ãt
->dp;

244 ià(
dp
->
Ãtdev
)

245 
	`xdp_rxq_šfo_uÄeg
(&
rx_ršg
->
xdp_rxq
);

246 
	`kvä“
(
rx_ršg
->
rxbufs
);

248 ià(
rx_ršg
->
rxds
)

249 
	`dma_ä“_coh”’t
(
dp
->
dev
, 
rx_ršg
->
size
,

250 
rx_ršg
->
rxds
,„x_ršg->
dma
);

252 
rx_ršg
->
út
 = 0;

253 
rx_ršg
->
rxbufs
 = 
NULL
;

254 
rx_ršg
->
rxds
 = 
NULL
;

255 
rx_ršg
->
dma
 = 0;

256 
rx_ršg
->
size
 = 0;

257 
	}
}

267 
	$nå_Ãt_rx_ršg_®loc
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_rx_ršg
 *
rx_ršg
)

269 
”r
;

271 ià(
dp
->
Ãtdev
) {

272 
”r
 = 
	`xdp_rxq_šfo_»g
(&
rx_ršg
->
xdp_rxq
, 
dp
->
Ãtdev
,

273 
rx_ršg
->
idx
);

274 ià(
”r
 < 0)

275  
”r
;

278 
rx_ršg
->
út
 = 
dp
->
rxd_út
;

279 
rx_ršg
->
size
 = 
	`¬¿y_size
Ôx_ršg->
út
, (*rx_ršg->
rxds
));

280 
rx_ršg
->
rxds
 = 
	`dma_z®loc_coh”’t
(
dp
->
dev
,„x_ršg->
size
,

281 &
rx_ršg
->
dma
,

282 
GFP_KERNEL
 | 
__GFP_NOWARN
);

283 ià(!
rx_ršg
->
rxds
) {

284 
	`Ãtdev_w¬n
(
dp
->
Ãtdev
, "failedo‡llocate RX descriptor„ing memory,„equested descriptor count: %d, consider†owering descriptor count\n",

285 
rx_ršg
->
út
);

286 
”r_®loc
;

289 
rx_ršg
->
rxbufs
 = 
	`kvÿÎoc
Ôx_ršg->
út
, (*rx_ring->rxbufs),

290 
GFP_KERNEL
);

291 ià(!
rx_ršg
->
rxbufs
)

292 
”r_®loc
;

296 
”r_®loc
:

297 
	`nå_Ãt_rx_ršg_ä“
(
rx_ršg
);

298  -
ENOMEM
;

299 
	}
}

301 
	$nå_Ãt_rx_ršgs_´•¬e
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
)

303 
r
;

305 
dp
->
rx_ršgs
 = 
	`kÿÎoc
(dp->
num_rx_ršgs
, (*dp->rx_rings),

306 
GFP_KERNEL
);

307 ià(!
dp
->
rx_ršgs
)

308  -
ENOMEM
;

310 
r
 = 0;„ < 
dp
->
num_rx_ršgs
;„++) {

311 
	`nå_Ãt_rx_ršg_š™
(&
dp
->
rx_ršgs
[
r
], &
Â
->
r_vecs
[r],„);

313 ià(
	`nå_Ãt_rx_ršg_®loc
(
dp
, &dp->
rx_ršgs
[
r
]))

314 
”r_ä“_´ev
;

316 ià(
	`nå_Ãt_rx_ršg_bufs_®loc
(
dp
, &dp->
rx_ršgs
[
r
]))

317 
”r_ä“_ršg
;

322 
”r_ä“_´ev
:

323 
r
--) {

324 
	`nå_Ãt_rx_ršg_bufs_ä“
(
dp
, &dp->
rx_ršgs
[
r
]);

325 
”r_ä“_ršg
:

326 
	`nå_Ãt_rx_ršg_ä“
(&
dp
->
rx_ršgs
[
r
]);

328 
	`kä“
(
dp
->
rx_ršgs
);

329  -
ENOMEM
;

330 
	}
}

332 
	$nå_Ãt_rx_ršgs_ä“
(
nå_Ãt_dp
 *
dp
)

334 
r
;

336 
r
 = 0;„ < 
dp
->
num_rx_ršgs
;„++) {

337 
	`nå_Ãt_rx_ršg_bufs_ä“
(
dp
, &dp->
rx_ršgs
[
r
]);

338 
	`nå_Ãt_rx_ršg_ä“
(&
dp
->
rx_ršgs
[
r
]);

341 
	`kä“
(
dp
->
rx_ršgs
);

342 
	}
}

345 
	$nå_Ãt_rx_ršg_hw_cfg_wr™e
(
nå_Ãt
 *
Â
,

346 
nå_Ãt_rx_ršg
 *
rx_ršg
, 
idx
)

349 
	`Â_wr™eq
(
Â
, 
	`NFP_NET_CFG_RXR_ADDR
(
idx
), 
rx_ršg
->
dma
);

350 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_RXR_SZ
(
idx
), 
	`žog2
(
rx_ršg
->
út
));

351 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_RXR_VEC
(
idx
), 
rx_ršg
->
r_vec
->
œq_’Œy
);

352 
	}
}

355 
	$nå_Ãt_tx_ršg_hw_cfg_wr™e
(
nå_Ãt
 *
Â
,

356 
nå_Ãt_tx_ršg
 *
tx_ršg
, 
idx
)

358 
	`Â_wr™eq
(
Â
, 
	`NFP_NET_CFG_TXR_ADDR
(
idx
), 
tx_ršg
->
dma
);

359 ià(
tx_ršg
->
txrwb
) {

360 *
tx_ršg
->
txrwb
 = 0;

361 
	`Â_wr™eq
(
Â
, 
	`NFP_NET_CFG_TXR_WB_ADDR
(
idx
),

362 
Â
->
dp
.
txrwb_dma
 + 
idx
 * (
u64
));

364 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_TXR_SZ
(
idx
), 
	`žog2
(
tx_ršg
->
út
));

365 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_TXR_VEC
(
idx
), 
tx_ršg
->
r_vec
->
œq_’Œy
);

366 
	}
}

368 
	$nå_Ãt_vec_þ—r_ršg_d©a
(
nå_Ãt
 *
Â
, 
idx
)

370 
	`Â_wr™eq
(
Â
, 
	`NFP_NET_CFG_RXR_ADDR
(
idx
), 0);

371 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_RXR_SZ
(
idx
), 0);

372 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_RXR_VEC
(
idx
), 0);

374 
	`Â_wr™eq
(
Â
, 
	`NFP_NET_CFG_TXR_ADDR
(
idx
), 0);

375 
	`Â_wr™eq
(
Â
, 
	`NFP_NET_CFG_TXR_WB_ADDR
(
idx
), 0);

376 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_TXR_SZ
(
idx
), 0);

377 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_TXR_VEC
(
idx
), 0);

378 
	}
}

380 
boÞ
 
	$__nå_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
)

382 
Â
->
dp
.
Ýs
->
v”siÚ
) {

383 #ifdeà
CONFIG_NFP_NET_PF


384 
NFP_NFD_VER_NFD3
:

385  
	`__nå_nfd3_ù¾_tx
(
Â
, 
skb
);

386 
NFP_NFD_VER_NFDK
:

387  
	`__nå_nfdk_ù¾_tx
(
Â
, 
skb
);

390 
	`WARN_ON
(1);

391  
çl£
;

393 
	}
}

395 
boÞ
 
	$nå_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
)

397 
Â
->
dp
.
Ýs
->
v”siÚ
) {

398 #ifdeà
CONFIG_NFP_NET_PF


399 
NFP_NFD_VER_NFD3
:

400  
	`nå_nfd3_ù¾_tx
(
Â
, 
skb
);

401 
NFP_NFD_VER_NFDK
:

402  
	`nå_nfdk_ù¾_tx
(
Â
, 
skb
);

405 
	`WARN_ON
(1);

406  
çl£
;

408 
	}
}

	@src/nfp_net_dp.h

4 #iâdeà
_NFP_NET_DP_


5 
	#_NFP_NET_DP_


	)

7 
	~"nå_Ãt.h
"

9 
šlše
 
dma_addr_t
 
	$nå_Ãt_dma_m­_rx
(
nå_Ãt_dp
 *
dp
, *
äag
)

11  
	`dma_m­_sšgË_©Œs
(
dp
->
dev
, 
äag
 + 
NFP_NET_RX_BUF_HEADROOM
,

12 
dp
->
æ_bufsz
 - 
NFP_NET_RX_BUF_NON_DATA
,

13 
dp
->
rx_dma_dœ
, 
DMA_ATTR_SKIP_CPU_SYNC
);

14 
	}
}

16 
šlše
 

17 
	$nå_Ãt_dma_sync_dev_rx
(cÚ¡ 
nå_Ãt_dp
 *
dp
, 
dma_addr_t
 
dma_addr
)

19 #ià
COMPAT__USE_DMA_SKIP_SYNC


20 
	`dma_sync_sšgË_fÜ_deviû
(
dp
->
dev
, 
dma_addr
,

21 
dp
->
æ_bufsz
 - 
NFP_NET_RX_BUF_NON_DATA
,

22 
dp
->
rx_dma_dœ
);

24 
	}
}

26 
šlše
 
	$nå_Ãt_dma_unm­_rx
(
nå_Ãt_dp
 *
dp
,

27 
dma_addr_t
 
dma_addr
)

29 
	`dma_unm­_sšgË_©Œs
(
dp
->
dev
, 
dma_addr
,

30 
dp
->
æ_bufsz
 - 
NFP_NET_RX_BUF_NON_DATA
,

31 
dp
->
rx_dma_dœ
, 
DMA_ATTR_SKIP_CPU_SYNC
);

32 
	}
}

34 
šlše
 
	$nå_Ãt_dma_sync_ýu_rx
(
nå_Ãt_dp
 *
dp
,

35 
dma_addr_t
 
dma_addr
,

36 
Ën
)

38 #ià
COMPAT__USE_DMA_SKIP_SYNC


39 
	`dma_sync_sšgË_fÜ_ýu
(
dp
->
dev
, 
dma_addr
 - 
NFP_NET_RX_BUF_HEADROOM
,

40 
Ën
, 
dp
->
rx_dma_dœ
);

42 
	`dma_sync_sšgË_fÜ_ýu
(
dp
->
dev
, 
dma_addr
 - 
NFP_NET_RX_BUF_HEADROOM
,

43 
dp
->
xdp_´og
 ? 
Ën
 : 64, dp->
rx_dma_dœ
);

45 
	}
}

58 
šlše
 
	$nå_Ãt_tx_fuÎ
(
nå_Ãt_tx_ršg
 *
tx_ršg
, 
dút
)

60  (
tx_ršg
->
wr_p
 -x_ršg->
rd_p
è>ðÑx_ršg->
út
 - 
dút
);

61 
	}
}

63 
šlše
 
	$nå_Ãt_tx_xm™_mÜe_æush
(
nå_Ãt_tx_ršg
 *
tx_ršg
)

65 
	`wmb
();

66 
	`nå_qý_wr_±r_add
(
tx_ršg
->
qý_q
,x_ršg->
wr_±r_add
);

67 
tx_ršg
->
wr_±r_add
 = 0;

68 
	}
}

70 
šlše
 
u32


71 
	$nå_Ãt_»ad_tx_cm¶
(
nå_Ãt_tx_ršg
 *
tx_ršg
, 
nå_Ãt_dp
 *
dp
)

73 ià(
tx_ršg
->
txrwb
)

74  *
tx_ršg
->
txrwb
;

75  
	`nå_qý_rd_±r_»ad
(
tx_ršg
->
qý_q
);

76 
	}
}

78 
šlše
 
	$nå_Ãt_ä“_äag
(*
äag
, 
boÞ
 
xdp
)

80 ià(!
xdp
)

81 
	`skb_ä“_äag
(
äag
);

83 
	`__ä“_·ge
(
	`vœt_to_·ge
(
äag
));

84 
	}
}

93 
šlše
 
	$nå_Ãt_œq_unmask
(
nå_Ãt
 *
Â
, 
’Œy_Ä
)

95 
	`Â_wr™eb
(
Â
, 
	`NFP_NET_CFG_ICR
(
’Œy_Ä
), 
NFP_NET_CFG_ICR_UNMASKED
);

96 
	`Â_pci_æush
(
Â
);

97 
	}
}

99 
	g£q_fže
;

103 
nå_Ãt_rx_ršg_hw_cfg_wr™e
(
nå_Ãt
 *
Â
,

104 
nå_Ãt_rx_ršg
 *
rx_ršg
, 
idx
);

106 
nå_Ãt_tx_ršg_hw_cfg_wr™e
(
nå_Ãt
 *
Â
,

107 
nå_Ãt_tx_ršg
 *
tx_ršg
, 
idx
);

108 
nå_Ãt_vec_þ—r_ršg_d©a
(
nå_Ãt
 *
Â
, 
idx
);

110 *
nå_Ãt_rx_®loc_Úe
(
nå_Ãt_dp
 *
dp
, 
dma_addr_t
 *
dma_addr
);

111 
nå_Ãt_rx_ršgs_´•¬e
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
);

112 
nå_Ãt_tx_ršgs_´•¬e
(
nå_Ãt
 *
Â
, 
nå_Ãt_dp
 *
dp
);

113 
nå_Ãt_rx_ršgs_ä“
(
nå_Ãt_dp
 *
dp
);

114 
nå_Ãt_tx_ršgs_ä“
(
nå_Ãt_dp
 *
dp
);

115 
nå_Ãt_rx_ršg_»£t
(
nå_Ãt_rx_ršg
 *
rx_ršg
);

117 
	enå_nfd_v”siÚ
 {

118 
	mNFP_NFD_VER_NFD3
,

119 
	mNFP_NFD_VER_NFDK
,

122 
	snå_dp_Ýs
 {

123 
nå_nfd_v”siÚ
 
	mv”siÚ
;

124 
	mtx_mš_desc_³r_pkt
;

125 
u32
 
	mÿp_mask
;

127 (*
	mpÞl
)(
Çpi_¡ruù
 *
	mÇpi
, 
	mbudg‘
);

128 (*
	mù¾_pÞl
)(
	m¬g
);

130 (*
	mrx_ršg_fžl_ä“li¡
)(
nå_Ãt_dp
 *
	mdp
,

131 
nå_Ãt_rx_ršg
 *
	mrx_ršg
);

132 (*
	mtx_ršg_®loc
)(
nå_Ãt_dp
 *
	mdp
,

133 
nå_Ãt_tx_ršg
 *
	mtx_ršg
);

134 (*
	mtx_ršg_»£t
)(
nå_Ãt_dp
 *
	mdp
,

135 
nå_Ãt_tx_ršg
 *
	mtx_ršg
);

136 (*
	mtx_ršg_ä“
)(
nå_Ãt_tx_ršg
 *
	mtx_ršg
);

137 (*
	mtx_ršg_bufs_®loc
)(
nå_Ãt_dp
 *
	mdp
,

138 
nå_Ãt_tx_ršg
 *
	mtx_ršg
);

139 (*
	mtx_ršg_bufs_ä“
)(
nå_Ãt_dp
 *
	mdp
,

140 
nå_Ãt_tx_ršg
 *
	mtx_ršg
);

142 (*
	m´št_tx_descs
)(
£q_fže
 *
	mfže
,

143 
nå_Ãt_r_veùÜ
 *
	mr_vec
,

144 
nå_Ãt_tx_ršg
 *
	mtx_ršg
,

145 
u32
 
	md_rd_p
, u32 
	md_wr_p
);

148 
šlše
 

149 
	$nå_Ãt_tx_ršg_»£t
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_tx_ršg
 *
tx_ršg
)

151  
dp
->
Ýs
->
	`tx_ršg_»£t
(dp, 
tx_ršg
);

152 
	}
}

154 
šlše
 

155 
	$nå_Ãt_rx_ršg_fžl_ä“li¡
(
nå_Ãt_dp
 *
dp
,

156 
nå_Ãt_rx_ršg
 *
rx_ršg
)

158 
dp
->
Ýs
->
	`rx_ršg_fžl_ä“li¡
(dp, 
rx_ršg
);

159 
	}
}

161 
šlše
 

162 
	$nå_Ãt_tx_ršg_®loc
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_tx_ršg
 *
tx_ršg
)

164  
dp
->
Ýs
->
	`tx_ršg_®loc
(dp, 
tx_ršg
);

165 
	}
}

167 
šlše
 

168 
	$nå_Ãt_tx_ršg_ä“
(
nå_Ãt_dp
 *
dp
, 
nå_Ãt_tx_ršg
 *
tx_ršg
)

170 
dp
->
Ýs
->
	`tx_ršg_ä“
(
tx_ršg
);

171 
	}
}

173 
šlše
 

174 
	$nå_Ãt_tx_ršg_bufs_®loc
(
nå_Ãt_dp
 *
dp
,

175 
nå_Ãt_tx_ršg
 *
tx_ršg
)

177  
dp
->
Ýs
->
	`tx_ršg_bufs_®loc
(dp, 
tx_ršg
);

178 
	}
}

180 
šlše
 

181 
	$nå_Ãt_tx_ršg_bufs_ä“
(
nå_Ãt_dp
 *
dp
,

182 
nå_Ãt_tx_ršg
 *
tx_ršg
)

184 
dp
->
Ýs
->
	`tx_ršg_bufs_ä“
(dp, 
tx_ršg
);

185 
	}
}

187 
šlše
 

188 
	$nå_Ãt_debugfs_´št_tx_descs
(
£q_fže
 *
fže
, 
nå_Ãt_dp
 *
dp
,

189 
nå_Ãt_r_veùÜ
 *
r_vec
,

190 
nå_Ãt_tx_ršg
 *
tx_ršg
,

191 
u32
 
d_rd_p
, u32 
d_wr_p
)

193 
dp
->
Ýs
->
	`´št_tx_descs
(
fže
, 
r_vec
, 
tx_ršg
, 
d_rd_p
, 
d_wr_p
);

194 
	}
}

196 cÚ¡ 
nå_dp_Ýs
 
nå_nfd3_Ýs
;

197 cÚ¡ 
nå_dp_Ýs
 
nå_nfdk_Ýs
;

199 
nå_nfd3_tx
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
);

200 
boÞ
 
nå_nfd3_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
);

201 
boÞ
 
__nå_nfd3_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
);

203 
nå_nfdk_tx
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
);

204 
boÞ
 
nå_nfdk_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
);

205 
boÞ
 
__nå_nfdk_ù¾_tx
(
nå_Ãt
 *
Â
, 
sk_buff
 *
skb
);

	@src/nfp_net_ethtool.c

12 
	~"nå_Ãt_com·t.h
"

14 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

15 
	~<lšux/b™f›ld.h
>

17 
	~<lšux/k”Ãl.h
>

18 
	~<lšux/Ãtdeviû.h
>

19 
	~<lšux/‘h”deviû.h
>

20 
	~<lšux/š‹¼u±.h
>

21 
	~<lšux/pci.h
>

22 
	~<lšux/‘htoÞ.h
>

23 
	~<lšux/fœmw¬e.h
>

24 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 14, 0)

25 
	~<lšux/så.h
>

28 
	~"nåcÜe/nå.h
"

29 
	~"nåcÜe/nå_dev.h
"

30 
	~"nåcÜe/nå_n¥.h
"

31 
	~"nå_­p.h
"

32 
	~"nå_maš.h
"

33 
	~"nå_Ãt_ù¾.h
"

34 
	~"nå_Ãt_dp.h
"

35 
	~"nå_Ãt.h
"

36 
	~"nå_pÜt.h
"

38 
	snå_‘_¡©
 {

39 
	mÇme
[
ETH_GSTRING_LEN
];

40 
	moff
;

43 cÚ¡ 
nå_‘_¡©
 
	gnå_Ãt_‘_¡©s
[] = {

45 { "dev_rx_disÿrds", 
NFP_NET_CFG_STATS_RX_DISCARDS
 },

46 { "dev_rx_”rÜs", 
NFP_NET_CFG_STATS_RX_ERRORS
 },

47 { "dev_rx_by‹s", 
NFP_NET_CFG_STATS_RX_OCTETS
 },

48 { "dev_rx_uc_by‹s", 
NFP_NET_CFG_STATS_RX_UC_OCTETS
 },

49 { "dev_rx_mc_by‹s", 
NFP_NET_CFG_STATS_RX_MC_OCTETS
 },

50 { "dev_rx_bc_by‹s", 
NFP_NET_CFG_STATS_RX_BC_OCTETS
 },

51 { "dev_rx_pkts", 
NFP_NET_CFG_STATS_RX_FRAMES
 },

52 { "dev_rx_mc_pkts", 
NFP_NET_CFG_STATS_RX_MC_FRAMES
 },

53 { "dev_rx_bc_pkts", 
NFP_NET_CFG_STATS_RX_BC_FRAMES
 },

55 { "dev_tx_disÿrds", 
NFP_NET_CFG_STATS_TX_DISCARDS
 },

56 { "dev_tx_”rÜs", 
NFP_NET_CFG_STATS_TX_ERRORS
 },

57 { "dev_tx_by‹s", 
NFP_NET_CFG_STATS_TX_OCTETS
 },

58 { "dev_tx_uc_by‹s", 
NFP_NET_CFG_STATS_TX_UC_OCTETS
 },

59 { "dev_tx_mc_by‹s", 
NFP_NET_CFG_STATS_TX_MC_OCTETS
 },

60 { "dev_tx_bc_by‹s", 
NFP_NET_CFG_STATS_TX_BC_OCTETS
 },

61 { "dev_tx_pkts", 
NFP_NET_CFG_STATS_TX_FRAMES
 },

62 { "dev_tx_mc_pkts", 
NFP_NET_CFG_STATS_TX_MC_FRAMES
 },

63 { "dev_tx_bc_pkts", 
NFP_NET_CFG_STATS_TX_BC_FRAMES
 },

65 { "bpf_·ss_pkts", 
NFP_NET_CFG_STATS_APP0_FRAMES
 },

66 { "bpf_·ss_by‹s", 
NFP_NET_CFG_STATS_APP0_BYTES
 },

70 { "bpf_­p1_pkts", 
NFP_NET_CFG_STATS_APP1_FRAMES
 },

71 { "bpf_­p1_by‹s", 
NFP_NET_CFG_STATS_APP1_BYTES
 },

72 { "bpf_­p2_pkts", 
NFP_NET_CFG_STATS_APP2_FRAMES
 },

73 { "bpf_­p2_by‹s", 
NFP_NET_CFG_STATS_APP2_BYTES
 },

74 { "bpf_­p3_pkts", 
NFP_NET_CFG_STATS_APP3_FRAMES
 },

75 { "bpf_­p3_by‹s", 
NFP_NET_CFG_STATS_APP3_BYTES
 },

78 cÚ¡ 
nå_‘_¡©
 
	gnå_mac_‘_¡©s
[] = {

79 { "rx_où‘s", 
NFP_MAC_STATS_RX_IN_OCTETS
, },

81 
NFP_MAC_STATS_RX_FRAME_TOO_LONG_ERRORS
, },

82 { "rx_¿nge_Ëngth_”rÜs", 
NFP_MAC_STATS_RX_RANGE_LENGTH_ERRORS
, },

83 { "rx_vÏn_»ûived_ok", 
NFP_MAC_STATS_RX_VLAN_RECEIVED_OK
, },

84 { "rx_”rÜs", 
NFP_MAC_STATS_RX_IN_ERRORS
, },

85 { "rx_brßdÿ¡_pkts", 
NFP_MAC_STATS_RX_IN_BROADCAST_PKTS
, },

86 { "rx_drÝ_ev’ts", 
NFP_MAC_STATS_RX_DROP_EVENTS
, },

87 { "rx_®ignm’t_”rÜs", 
NFP_MAC_STATS_RX_ALIGNMENT_ERRORS
, },

89 
NFP_MAC_STATS_RX_PAUSE_MAC_CTRL_FRAMES
, },

90 { "rx_äames_»ûived_ok", 
NFP_MAC_STATS_RX_FRAMES_RECEIVED_OK
, },

92 
NFP_MAC_STATS_RX_FRAME_CHECK_SEQUENCE_ERRORS
, },

93 { "rx_uniÿ¡_pkts", 
NFP_MAC_STATS_RX_UNICAST_PKTS
, },

94 { "rx_muÉiÿ¡_pkts", 
NFP_MAC_STATS_RX_MULTICAST_PKTS
, },

95 { "rx_pkts", 
NFP_MAC_STATS_RX_PKTS
, },

96 { "rx_und”size_pkts", 
NFP_MAC_STATS_RX_UNDERSIZE_PKTS
, },

97 { "rx_pkts_64_où‘s", 
NFP_MAC_STATS_RX_PKTS_64_OCTETS
, },

99 
NFP_MAC_STATS_RX_PKTS_65_TO_127_OCTETS
, },

101 
NFP_MAC_STATS_RX_PKTS_128_TO_255_OCTETS
, },

103 
NFP_MAC_STATS_RX_PKTS_256_TO_511_OCTETS
, },

105 
NFP_MAC_STATS_RX_PKTS_512_TO_1023_OCTETS
, },

107 
NFP_MAC_STATS_RX_PKTS_1024_TO_1518_OCTETS
, },

109 
NFP_MAC_STATS_RX_PKTS_1519_TO_MAX_OCTETS
, },

110 { "rx_jabb”s", 
NFP_MAC_STATS_RX_JABBERS
, },

111 { "rx_äagm’ts", 
NFP_MAC_STATS_RX_FRAGMENTS
, },

112 { "rx_ov”size_pkts", 
NFP_MAC_STATS_RX_OVERSIZE_PKTS
, },

113 { "rx_·u£_äames_þass0", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS0
, },

114 { "rx_·u£_äames_þass1", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS1
, },

115 { "rx_·u£_äames_þass2", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS2
, },

116 { "rx_·u£_äames_þass3", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS3
, },

117 { "rx_·u£_äames_þass4", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS4
, },

118 { "rx_·u£_äames_þass5", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS5
, },

119 { "rx_·u£_äames_þass6", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS6
, },

120 { "rx_·u£_äames_þass7", 
NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS7
, },

122 
NFP_MAC_STATS_RX_MAC_CTRL_FRAMES_RECEIVED
, },

123 { "rx_mac_h—d_drÝ", 
NFP_MAC_STATS_RX_MAC_HEAD_DROP
, },

124 { "tx_queue_drÝ", 
NFP_MAC_STATS_TX_QUEUE_DROP
, },

125 { "tx_où‘s", 
NFP_MAC_STATS_TX_OUT_OCTETS
, },

126 { "tx_vÏn_Œªsm™‹d_ok", 
NFP_MAC_STATS_TX_VLAN_TRANSMITTED_OK
, },

127 { "tx_”rÜs", 
NFP_MAC_STATS_TX_OUT_ERRORS
, },

128 { "tx_brßdÿ¡_pkts", 
NFP_MAC_STATS_TX_BROADCAST_PKTS
, },

130 
NFP_MAC_STATS_TX_PAUSE_MAC_CTRL_FRAMES
, },

132 
NFP_MAC_STATS_TX_FRAMES_TRANSMITTED_OK
, },

133 { "tx_uniÿ¡_pkts", 
NFP_MAC_STATS_TX_UNICAST_PKTS
, },

134 { "tx_muÉiÿ¡_pkts", 
NFP_MAC_STATS_TX_MULTICAST_PKTS
, },

135 { "tx_pkts_64_où‘s", 
NFP_MAC_STATS_TX_PKTS_64_OCTETS
, },

137 
NFP_MAC_STATS_TX_PKTS_65_TO_127_OCTETS
, },

139 
NFP_MAC_STATS_TX_PKTS_128_TO_255_OCTETS
, },

141 
NFP_MAC_STATS_TX_PKTS_256_TO_511_OCTETS
, },

143 
NFP_MAC_STATS_TX_PKTS_512_TO_1023_OCTETS
, },

145 
NFP_MAC_STATS_TX_PKTS_1024_TO_1518_OCTETS
, },

147 
NFP_MAC_STATS_TX_PKTS_1519_TO_MAX_OCTETS
, },

148 { "tx_·u£_äames_þass0", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS0
, },

149 { "tx_·u£_äames_þass1", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS1
, },

150 { "tx_·u£_äames_þass2", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS2
, },

151 { "tx_·u£_äames_þass3", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS3
, },

152 { "tx_·u£_äames_þass4", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS4
, },

153 { "tx_·u£_äames_þass5", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS5
, },

154 { "tx_·u£_äames_þass6", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS6
, },

155 { "tx_·u£_äames_þass7", 
NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS7
, },

158 
	#NN_ET_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
nå_Ãt_‘_¡©s
)

	)

159 
	#NN_ET_SWITCH_STATS_LEN
 9

	)

160 
	#NN_RVEC_GATHER_STATS
 9

	)

161 
	#NN_RVEC_PER_Q_STATS
 3

	)

163 
	#SFP_SFF_REV_COMPLIANCE
 1

	)

165 
	$nå_Ãt_g‘_n¥šfo
(
nå_­p
 *
­p
, *
v”siÚ
)

167 
nå_n¥
 *
n¥
;

169 ià(!
­p
)

172 
n¥
 = 
	`nå_n¥_Ý’
(
­p
->
ýp
);

173 ià(
	`IS_ERR
(
n¥
))

176 
	`¢´štf
(
v”siÚ
, 
ETHTOOL_FWVERS_LEN
, "%hu.%hu",

177 
	`nå_n¥_g‘_abi_v”_majÜ
(
n¥
),

178 
	`nå_n¥_g‘_abi_v”_mšÜ
(
n¥
));

180 
	`nå_n¥_þo£
(
n¥
);

181 
	}
}

184 
	$nå_g‘_drvšfo
(
nå_­p
 *
­p
, 
pci_dev
 *
pdev
,

185 cÚ¡ *
vnic_v”siÚ
, 
‘htoÞ_drvšfo
 *
drvšfo
)

187 
n¥_v”siÚ
[
ETHTOOL_FWVERS_LEN
] = {};

189 
	`¡¾ýy
(
drvšfo
->
driv”
, 
pdev
->driv”->
Çme
, (drvinfo->driver));

190 
	`¡¾ýy
(
drvšfo
->
v”siÚ
, 
nå_driv”_v”siÚ
, (drvinfo->version));

192 
	`nå_Ãt_g‘_n¥šfo
(
­p
, 
n¥_v”siÚ
);

193 
	`¢´štf
(
drvšfo
->
fw_v”siÚ
, (drvinfo->fw_version),

194 "% % % %s", 
vnic_v”siÚ
, 
n¥_v”siÚ
,

195 
	`nå_­p_m_Çme
(
­p
), 
	`nå_­p_Çme
(app));

196 
	}
}

199 
	$nå_Ãt_g‘_drvšfo
(
Ãt_deviû
 *
Ãtdev
, 
‘htoÞ_drvšfo
 *
drvšfo
)

201 
vnic_v”siÚ
[
ETHTOOL_FWVERS_LEN
] = {};

202 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

204 
	`¢´štf
(
vnic_v”siÚ
, (vnic_version), "%d.%d.%d.%d",

205 
Â
->
fw_v”
.
dp_»sv
,‚n->fw_v”.
þass
,

206 
Â
->
fw_v”
.
majÜ
,‚n->fw_v”.
mšÜ
);

207 
	`¡¾ýy
(
drvšfo
->
bus_šfo
, 
	`pci_Çme
(
Â
->
pdev
),

208 (
drvšfo
->
bus_šfo
));

210 
	`nå_g‘_drvšfo
(
Â
->
­p
,‚n->
pdev
, 
vnic_v”siÚ
, 
drvšfo
);

211 
	}
}

214 
	$nå_­p_g‘_drvšfo
(
Ãt_deviû
 *
Ãtdev
, 
‘htoÞ_drvšfo
 *
drvšfo
)

216 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

218 
	`¡¾ýy
(
drvšfo
->
bus_šfo
, 
	`pci_Çme
(
­p
->
pdev
),

219 (
drvšfo
->
bus_šfo
));

220 
	`nå_g‘_drvšfo
(
­p
,‡µ->
pdev
, "*", 
drvšfo
);

221 
	}
}

224 
	$nå_Ãt_£t_ãc_lšk_mode
(
nå_‘h_bË_pÜt
 *
‘h_pÜt
,

225 
‘htoÞ_lšk_k£‰šgs
 *
c
)

227 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 14, 0)

228 
modes
;

230 
	`‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
c
, 
suµÜ‹d
, 
FEC_NONE
);

231 ià(!
	`nå_‘h_ÿn_suµÜt_ãc
(
‘h_pÜt
)) {

232 
	`‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
c
, 
adv”tisšg
, 
FEC_NONE
);

236 
modes
 = 
	`nå_‘h_suµÜ‹d_ãc_modes
(
‘h_pÜt
);

237 ià(
modes
 & 
NFP_FEC_BASER
) {

238 
	`‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
c
, 
suµÜ‹d
, 
FEC_BASER
);

239 
	`‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
c
, 
adv”tisšg
, 
FEC_BASER
);

242 ià(
modes
 & 
NFP_FEC_REED_SOLOMON
) {

243 
	`‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
c
, 
suµÜ‹d
, 
FEC_RS
);

244 
	`‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
c
, 
adv”tisšg
, 
FEC_RS
);

247 
	}
}

257 
	$nå_Ãt_g‘_lšk_k£‰šgs
(
Ãt_deviû
 *
Ãtdev
,

258 
‘htoÞ_lšk_k£‰šgs
 *
cmd
)

260 cÚ¡ 
u32
 
ls_to_‘htoÞ
[] = {

261 [
NFP_NET_CFG_STS_LINK_RATE_UNSUPPORTED
] = 0,

262 [
NFP_NET_CFG_STS_LINK_RATE_UNKNOWN
] = 
SPEED_UNKNOWN
,

263 [
NFP_NET_CFG_STS_LINK_RATE_1G
] = 
SPEED_1000
,

264 [
NFP_NET_CFG_STS_LINK_RATE_10G
] = 
SPEED_10000
,

265 [
NFP_NET_CFG_STS_LINK_RATE_25G
] = 
SPEED_25000
,

266 [
NFP_NET_CFG_STS_LINK_RATE_40G
] = 
SPEED_40000
,

267 [
NFP_NET_CFG_STS_LINK_RATE_50G
] = 
SPEED_50000
,

268 [
NFP_NET_CFG_STS_LINK_RATE_100G
] = 
SPEED_100000
,

270 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

271 
nå_pÜt
 *
pÜt
;

272 
nå_Ãt
 *
Â
;

273 
u32
 
¡s
, 
ls
;

276 
	`‘htoÞ_lšk_k£‰šgs_add_lšk_mode
(
cmd
, 
suµÜ‹d
, 
FIBRE
);

277 
cmd
->
ba£
.
pÜt
 = 
PORT_OTHER
;

278 
	`com·t__‘htoÞ_cmd_¥“d_£t
(
cmd
, 
SPEED_UNKNOWN
);

279 
cmd
->
ba£
.
du¶ex
 = 
DUPLEX_UNKNOWN
;

281 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

282 
‘h_pÜt
 = 
	`nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

283 ià(
‘h_pÜt
) {

284 
cmd
->
ba£
.
autÚeg
 = 
‘h_pÜt
->
ªeg
 !ð
NFP_ANEG_DISABLED
 ?

285 
AUTONEG_ENABLE
 : 
AUTONEG_DISABLE
;

286 
	`nå_Ãt_£t_ãc_lšk_mode
(
‘h_pÜt
, 
cmd
);

289 ià(!
	`Ãtif_ÿ¼›r_ok
(
Ãtdev
))

293 ià(
‘h_pÜt
) {

294 
cmd
->
ba£
.
pÜt
 = 
‘h_pÜt
->
pÜt_ty³
;

295 
	`com·t__‘htoÞ_cmd_¥“d_£t
(
cmd
, 
‘h_pÜt
->
¥“d
);

296 
cmd
->
ba£
.
du¶ex
 = 
DUPLEX_FULL
;

300 ià(!
	`nå_Ãtdev_is_nå_Ãt
(
Ãtdev
))

301  -
EOPNOTSUPP
;

302 
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

304 
¡s
 = 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_STS
);

306 
ls
 = 
	`FIELD_GET
(
NFP_NET_CFG_STS_LINK_RATE
, 
¡s
);

307 ià(
ls
 =ð
NFP_NET_CFG_STS_LINK_RATE_UNSUPPORTED
)

308  -
EOPNOTSUPP
;

310 ià(
ls
 =ð
NFP_NET_CFG_STS_LINK_RATE_UNKNOWN
 ||

311 
ls
 >ð
	`ARRAY_SIZE
(
ls_to_‘htoÞ
))

314 
	`com·t__‘htoÞ_cmd_¥“d_£t
(
cmd
, 
ls_to_‘htoÞ
[
ls
]);

315 
cmd
->
ba£
.
du¶ex
 = 
DUPLEX_FULL
;

318 
	}
}

321 
	$nå_Ãt_£t_lšk_k£‰šgs
(
Ãt_deviû
 *
Ãtdev
,

322 cÚ¡ 
‘htoÞ_lšk_k£‰šgs
 *
cmd
)

324 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

325 
nå_pÜt
 *
pÜt
;

326 
nå_n¥
 *
n¥
;

327 
”r
;

329 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

330 
‘h_pÜt
 = 
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

331 ià(!
‘h_pÜt
)

332  -
EOPNOTSUPP
;

334 ià(
	`Ãtif_ruÂšg
(
Ãtdev
)) {

335 
	`Ãtdev_w¬n
(
Ãtdev
, "Changing settings‚ot‡llowed on‡n‡ctive interface. It may causehe…orto be disabled until driver„eload.\n");

336  -
EBUSY
;

339 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
pÜt
->
­p
->
ýp
, 
‘h_pÜt
->
šdex
);

340 ià(
	`IS_ERR
(
n¥
))

341  
	`PTR_ERR
(
n¥
);

343 
”r
 = 
	`__nå_‘h_£t_ªeg
(
n¥
, 
cmd
->
ba£
.
autÚeg
 =ð
AUTONEG_ENABLE
 ?

344 
NFP_ANEG_AUTO
 : 
NFP_ANEG_DISABLED
);

345 ià(
”r
)

346 
”r_bad_£t
;

347 ià(
	`com·t__‘htoÞ_cmd_¥“d_g‘
(
cmd
è!ð
SPEED_UNKNOWN
) {

348 
u32
 
¥“d
 = 
	`com·t__‘htoÞ_cmd_¥“d_g‘
(
cmd
) /

349 
‘h_pÜt
->
ÏÃs
;

351 
”r
 = 
	`__nå_‘h_£t_¥“d
(
n¥
, 
¥“d
);

352 ià(
”r
)

353 
”r_bad_£t
;

356 
”r
 = 
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

357 ià(
”r
 > 0)

360 
	`nå_Ãt_»äesh_pÜt_bË
(
pÜt
);

362  
”r
;

364 
”r_bad_£t
:

365 
	`nå_‘h_cÚfig_þ—nup_’d
(
n¥
);

366  
”r
;

367 
	}
}

369 
	$nå_Ãt_g‘_ršg·¿m
(
Ãt_deviû
 *
Ãtdev
,

370 
‘htoÞ_ršg·¿m
 *
ršg
)

372 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

373 
u32
 
qc_max
 = 
Â
->
dev_šfo
->
max_qc_size
;

375 
ršg
->
rx_max_³ndšg
 = 
qc_max
;

376 
ršg
->
tx_max_³ndšg
 = 
qc_max
 / 
Â
->
dp
.
Ýs
->
tx_mš_desc_³r_pkt
;

377 
ršg
->
rx_³ndšg
 = 
Â
->
dp
.
rxd_út
;

378 
ršg
->
tx_³ndšg
 = 
Â
->
dp
.
txd_út
;

379 
	}
}

381 
	$nå_Ãt_£t_ršg_size
(
nå_Ãt
 *
Â
, 
u32
 
rxd_út
, u32 
txd_út
)

383 
nå_Ãt_dp
 *
dp
;

385 
dp
 = 
	`nå_Ãt_þÚe_dp
(
Â
);

386 ià(!
dp
)

387  -
ENOMEM
;

389 
dp
->
rxd_út
 =„xd_cnt;

390 
dp
->
txd_út
 =xd_cnt;

392  
	`nå_Ãt_ršg_»cÚfig
(
Â
, 
dp
, 
NULL
);

393 
	}
}

395 
	$nå_Ãt_£t_ršg·¿m
(
Ãt_deviû
 *
Ãtdev
,

396 
‘htoÞ_ršg·¿m
 *
ršg
)

398 
u32
 
tx_dµ
, 
qc_mš
, 
qc_max
, 
rxd_út
, 
txd_út
;

399 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

402 ià(
ršg
->
rx_mši_³ndšg
 ||„šg->
rx_jumbo_³ndšg
)

403  -
EINVAL
;

405 
qc_mš
 = 
Â
->
dev_šfo
->
mš_qc_size
;

406 
qc_max
 = 
Â
->
dev_šfo
->
max_qc_size
;

407 
tx_dµ
 = 
Â
->
dp
.
Ýs
->
tx_mš_desc_³r_pkt
;

409 
rxd_út
 = 
	`roundup_pow_of_two
(
ršg
->
rx_³ndšg
);

410 
txd_út
 = 
	`roundup_pow_of_two
(
ršg
->
tx_³ndšg
);

412 ià(
rxd_út
 < 
qc_mš
 ||„xd_úˆ> 
qc_max
 ||

413 
txd_út
 < 
qc_mš
 / 
tx_dµ
 ||xd_úˆ> 
qc_max
 /x_dpp)

414  -
EINVAL
;

416 ià(
Â
->
dp
.
rxd_út
 =ðrxd_úˆ&&‚n->dp.
txd_út
 ==xd_cnt)

419 
	`Â_dbg
(
Â
, "Change„ing size: RxQ %u->%u, TxQ %u->%u\n",

420 
Â
->
dp
.
rxd_út
,„xd_út,‚n->dp.
txd_út
,xd_cnt);

422  
	`nå_Ãt_£t_ršg_size
(
Â
, 
rxd_út
, 
txd_út
);

423 
	}
}

425 
	$__´štf
(2, 3è
u8
 *
	$nå_´_‘
(
u8
 *
d©a
, cÚ¡ *
fmt
, ...)

427 
va_li¡
 
¬gs
;

429 
	`va_¡¬t
(
¬gs
, 
fmt
);

430 
	`v¢´štf
(
d©a
, 
ETH_GSTRING_LEN
, 
fmt
, 
¬gs
);

431 
	`va_’d
(
¬gs
);

433  
d©a
 + 
ETH_GSTRING_LEN
;

434 
	}
}

436 
	$nå_vnic_g‘_sw_¡©s_couÁ
(
Ãt_deviû
 *
Ãtdev
)

438 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

440  
NN_RVEC_GATHER_STATS
 + 
Â
->
max_r_vecs
 * 
NN_RVEC_PER_Q_STATS
;

441 
	}
}

443 
u8
 *
	$nå_vnic_g‘_sw_¡©s_¡ršgs
(
Ãt_deviû
 *
Ãtdev
, 
u8
 *
d©a
)

445 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

446 
i
;

448 
i
 = 0; i < 
Â
->
max_r_vecs
; i++) {

449 
d©a
 = 
	`nå_´_‘
(d©a, "rvec_%u_rx_pkts", 
i
);

450 
d©a
 = 
	`nå_´_‘
(d©a, "rvec_%u_tx_pkts", 
i
);

451 
d©a
 = 
	`nå_´_‘
(d©a, "rvec_%u_tx_busy", 
i
);

454 
d©a
 = 
	`nå_´_‘
(data, "hw_rx_csum_ok");

455 
d©a
 = 
	`nå_´_‘
(data, "hw_rx_csum_inner_ok");

456 
d©a
 = 
	`nå_´_‘
(data, "hw_rx_csum_complete");

457 
d©a
 = 
	`nå_´_‘
(data, "hw_rx_csum_err");

458 
d©a
 = 
	`nå_´_‘
(data, "rx_replace_buf_alloc_fail");

459 
d©a
 = 
	`nå_´_‘
(data, "hw_tx_csum");

460 
d©a
 = 
	`nå_´_‘
(data, "hw_tx_inner_csum");

461 
d©a
 = 
	`nå_´_‘
(data, "tx_gather");

462 
d©a
 = 
	`nå_´_‘
(data, "tx_lso");

464  
d©a
;

465 
	}
}

467 
u64
 *
	$nå_vnic_g‘_sw_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
u64
 *
d©a
)

469 
u64
 
g©h”ed_¡©s
[
NN_RVEC_GATHER_STATS
] = {};

470 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

471 
u64
 
tmp
[
NN_RVEC_GATHER_STATS
];

472 
i
, 
j
;

474 
i
 = 0; i < 
Â
->
max_r_vecs
; i++) {

475 
¡¬t
;

478 
¡¬t
 = 
	`u64_¡©s_ãtch_begš
(&
Â
->
r_vecs
[
i
].
rx_sync
);

479 
d©a
[0] = 
Â
->
r_vecs
[
i
].
rx_pkts
;

480 
tmp
[0] = 
Â
->
r_vecs
[
i
].
hw_csum_rx_ok
;

481 
tmp
[1] = 
Â
->
r_vecs
[
i
].
hw_csum_rx_šÃr_ok
;

482 
tmp
[2] = 
Â
->
r_vecs
[
i
].
hw_csum_rx_com¶‘e
;

483 
tmp
[3] = 
Â
->
r_vecs
[
i
].
hw_csum_rx_”rÜ
;

484 
tmp
[4] = 
Â
->
r_vecs
[
i
].
rx_»¶aû_buf_®loc_çž
;

485 } 
	`u64_¡©s_ãtch_»Œy
(&
Â
->
r_vecs
[
i
].
rx_sync
, 
¡¬t
));

488 
¡¬t
 = 
	`u64_¡©s_ãtch_begš
(&
Â
->
r_vecs
[
i
].
tx_sync
);

489 
d©a
[1] = 
Â
->
r_vecs
[
i
].
tx_pkts
;

490 
d©a
[2] = 
Â
->
r_vecs
[
i
].
tx_busy
;

491 
tmp
[5] = 
Â
->
r_vecs
[
i
].
hw_csum_tx
;

492 
tmp
[6] = 
Â
->
r_vecs
[
i
].
hw_csum_tx_šÃr
;

493 
tmp
[7] = 
Â
->
r_vecs
[
i
].
tx_g©h”
;

494 
tmp
[8] = 
Â
->
r_vecs
[
i
].
tx_lso
;

495 } 
	`u64_¡©s_ãtch_»Œy
(&
Â
->
r_vecs
[
i
].
tx_sync
, 
¡¬t
));

497 
d©a
 +ð
NN_RVEC_PER_Q_STATS
;

499 
j
 = 0; j < 
NN_RVEC_GATHER_STATS
; j++)

500 
g©h”ed_¡©s
[
j
] +ð
tmp
[j];

503 
j
 = 0; j < 
NN_RVEC_GATHER_STATS
; j++)

504 *
d©a
++ = 
g©h”ed_¡©s
[
j
];

506  
d©a
;

507 
	}
}

509 
	$nå_vnic_g‘_hw_¡©s_couÁ
(
num_vecs
)

511  
NN_ET_GLOBAL_STATS_LEN
 + 
num_vecs
 * 4;

512 
	}
}

514 
u8
 *

515 
	$nå_vnic_g‘_hw_¡©s_¡ršgs
(
u8
 *
d©a
, 
num_vecs
, 
boÞ
 
»´
)

517 
sw­_off
, 
i
;

519 
	`BUILD_BUG_ON
(
NN_ET_GLOBAL_STATS_LEN
 < 
NN_ET_SWITCH_STATS_LEN
 * 2);

524 
sw­_off
 = 
»´
 * 
NN_ET_SWITCH_STATS_LEN
;

526 
i
 = 0; i < 
NN_ET_SWITCH_STATS_LEN
; i++)

527 
d©a
 = 
	`nå_´_‘
(d©a, 
nå_Ãt_‘_¡©s
[
i
 + 
sw­_off
].
Çme
);

529 
i
 = 
NN_ET_SWITCH_STATS_LEN
; i < NN_ET_SWITCH_STATS_LEN * 2; i++)

530 
d©a
 = 
	`nå_´_‘
(d©a, 
nå_Ãt_‘_¡©s
[
i
 - 
sw­_off
].
Çme
);

532 
i
 = 
NN_ET_SWITCH_STATS_LEN
 * 2; i < 
NN_ET_GLOBAL_STATS_LEN
; i++)

533 
d©a
 = 
	`nå_´_‘
(d©a, 
nå_Ãt_‘_¡©s
[
i
].
Çme
);

535 
i
 = 0; i < 
num_vecs
; i++) {

536 
d©a
 = 
	`nå_´_‘
(d©a, "rxq_%u_pkts", 
i
);

537 
d©a
 = 
	`nå_´_‘
(d©a, "rxq_%u_by‹s", 
i
);

538 
d©a
 = 
	`nå_´_‘
(d©a, "txq_%u_pkts", 
i
);

539 
d©a
 = 
	`nå_´_‘
(d©a, "txq_%u_by‹s", 
i
);

542  
d©a
;

543 
	}
}

545 
u64
 *

546 
	$nå_vnic_g‘_hw_¡©s
(
u64
 *
d©a
, 
u8
 
__iomem
 *
mem
, 
num_vecs
)

548 
i
;

550 
i
 = 0; i < 
NN_ET_GLOBAL_STATS_LEN
; i++)

551 *
d©a
++ = 
	`»adq
(
mem
 + 
nå_Ãt_‘_¡©s
[
i
].
off
);

553 
i
 = 0; i < 
num_vecs
; i++) {

554 *
d©a
++ = 
	`»adq
(
mem
 + 
	`NFP_NET_CFG_RXR_STATS
(
i
));

555 *
d©a
++ = 
	`»adq
(
mem
 + 
	`NFP_NET_CFG_RXR_STATS
(
i
) + 8);

556 *
d©a
++ = 
	`»adq
(
mem
 + 
	`NFP_NET_CFG_TXR_STATS
(
i
));

557 *
d©a
++ = 
	`»adq
(
mem
 + 
	`NFP_NET_CFG_TXR_STATS
(
i
) + 8);

560  
d©a
;

561 
	}
}

563 
	$nå_mac_g‘_¡©s_couÁ
(
Ãt_deviû
 *
Ãtdev
)

565 
nå_pÜt
 *
pÜt
;

567 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

568 ià(!
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
è|| !pÜt->
‘h_¡©s
)

571  
	`ARRAY_SIZE
(
nå_mac_‘_¡©s
);

572 
	}
}

574 
u8
 *
	$nå_mac_g‘_¡©s_¡ršgs
(
Ãt_deviû
 *
Ãtdev
, 
u8
 *
d©a
)

576 
nå_pÜt
 *
pÜt
;

577 
i
;

579 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

580 ià(!
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
è|| !pÜt->
‘h_¡©s
)

581  
d©a
;

583 
i
 = 0; i < 
	`ARRAY_SIZE
(
nå_mac_‘_¡©s
); i++)

584 
d©a
 = 
	`nå_´_‘
(d©a, "mac.%s", 
nå_mac_‘_¡©s
[
i
].
Çme
);

586  
d©a
;

587 
	}
}

589 
u64
 *
	$nå_mac_g‘_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
u64
 *
d©a
)

591 
nå_pÜt
 *
pÜt
;

592 
i
;

594 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

595 ià(!
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
è|| !pÜt->
‘h_¡©s
)

596  
d©a
;

598 
i
 = 0; i < 
	`ARRAY_SIZE
(
nå_mac_‘_¡©s
); i++)

599 *
d©a
++ = 
	`»adq
(
pÜt
->
‘h_¡©s
 + 
nå_mac_‘_¡©s
[
i
].
off
);

601  
d©a
;

602 
	}
}

604 
	$nå_Ãt_g‘_¡ršgs
(
Ãt_deviû
 *
Ãtdev
,

605 
u32
 
¡ršg£t
, 
u8
 *
d©a
)

607 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

609 
¡ršg£t
) {

610 
ETH_SS_STATS
:

611 
d©a
 = 
	`nå_vnic_g‘_sw_¡©s_¡ršgs
(
Ãtdev
, data);

612 
d©a
 = 
	`nå_vnic_g‘_hw_¡©s_¡ršgs
(d©a, 
Â
->
max_r_vecs
,

613 
çl£
);

614 
d©a
 = 
	`nå_mac_g‘_¡©s_¡ršgs
(
Ãtdev
, data);

615 
d©a
 = 
	`nå_­p_pÜt_g‘_¡©s_¡ršgs
(
Â
->
pÜt
, data);

618 
	}
}

621 
	$nå_Ãt_g‘_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
‘htoÞ_¡©s
 *
¡©s
,

622 
u64
 *
d©a
)

624 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

626 
d©a
 = 
	`nå_vnic_g‘_sw_¡©s
(
Ãtdev
, data);

627 
d©a
 = 
	`nå_vnic_g‘_hw_¡©s
(d©a, 
Â
->
dp
.
ù¾_b¬
,‚n->
max_r_vecs
);

628 
d©a
 = 
	`nå_mac_g‘_¡©s
(
Ãtdev
, data);

629 
d©a
 = 
	`nå_­p_pÜt_g‘_¡©s
(
Â
->
pÜt
, data);

630 
	}
}

632 
	$nå_Ãt_g‘_s£t_couÁ
(
Ãt_deviû
 *
Ãtdev
, 
s£t
)

634 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

636 
s£t
) {

637 
ETH_SS_STATS
:

638  
	`nå_vnic_g‘_sw_¡©s_couÁ
(
Ãtdev
) +

639 
	`nå_vnic_g‘_hw_¡©s_couÁ
(
Â
->
max_r_vecs
) +

640 
	`nå_mac_g‘_¡©s_couÁ
(
Ãtdev
) +

641 
	`nå_­p_pÜt_g‘_¡©s_couÁ
(
Â
->
pÜt
);

643  -
EOPNOTSUPP
;

645 
	}
}

647 
	$nå_pÜt_g‘_¡ršgs
(
Ãt_deviû
 *
Ãtdev
,

648 
u32
 
¡ršg£t
, 
u8
 *
d©a
)

650 
nå_pÜt
 *
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

652 
¡ršg£t
) {

653 
ETH_SS_STATS
:

654 ià(
	`nå_pÜt_is_vnic
(
pÜt
))

655 
d©a
 = 
	`nå_vnic_g‘_hw_¡©s_¡ršgs
(d©a, 0, 
Œue
);

657 
d©a
 = 
	`nå_mac_g‘_¡©s_¡ršgs
(
Ãtdev
, data);

658 
d©a
 = 
	`nå_­p_pÜt_g‘_¡©s_¡ršgs
(
pÜt
, data);

661 
	}
}

664 
	$nå_pÜt_g‘_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
‘htoÞ_¡©s
 *
¡©s
,

665 
u64
 *
d©a
)

667 
nå_pÜt
 *
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

669 ià(
	`nå_pÜt_is_vnic
(
pÜt
))

670 
d©a
 = 
	`nå_vnic_g‘_hw_¡©s
(d©a, 
pÜt
->
vnic
, 0);

672 
d©a
 = 
	`nå_mac_g‘_¡©s
(
Ãtdev
, data);

673 
d©a
 = 
	`nå_­p_pÜt_g‘_¡©s
(
pÜt
, data);

674 
	}
}

676 
	$nå_pÜt_g‘_s£t_couÁ
(
Ãt_deviû
 *
Ãtdev
, 
s£t
)

678 
nå_pÜt
 *
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

679 
couÁ
;

681 
s£t
) {

682 
ETH_SS_STATS
:

683 ià(
	`nå_pÜt_is_vnic
(
pÜt
))

684 
couÁ
 = 
	`nå_vnic_g‘_hw_¡©s_couÁ
(0);

686 
couÁ
 = 
	`nå_mac_g‘_¡©s_couÁ
(
Ãtdev
);

687 
couÁ
 +ð
	`nå_­p_pÜt_g‘_¡©s_couÁ
(
pÜt
);

688  
couÁ
;

690  -
EOPNOTSUPP
;

692 
	}
}

694 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 14, 0)

695 
	$nå_pÜt_ãc_‘htoÞ_to_n¥
(
u32
 
ãc
)

697 
ãc
) {

698 
ETHTOOL_FEC_AUTO
:

699  
NFP_FEC_AUTO_BIT
;

700 
ETHTOOL_FEC_OFF
:

701  
NFP_FEC_DISABLED_BIT
;

702 
ETHTOOL_FEC_RS
:

703  
NFP_FEC_REED_SOLOMON_BIT
;

704 
ETHTOOL_FEC_BASER
:

705  
NFP_FEC_BASER_BIT
;

708  -
EOPNOTSUPP
;

710 
	}
}

712 
u32
 
	$nå_pÜt_ãc_n¥_to_‘htoÞ
(
u32
 
ãc
)

714 
u32
 
»suÉ
 = 0;

716 ià(
ãc
 & 
NFP_FEC_AUTO
)

717 
»suÉ
 |ð
ETHTOOL_FEC_AUTO
;

718 ià(
ãc
 & 
NFP_FEC_BASER
)

719 
»suÉ
 |ð
ETHTOOL_FEC_BASER
;

720 ià(
ãc
 & 
NFP_FEC_REED_SOLOMON
)

721 
»suÉ
 |ð
ETHTOOL_FEC_RS
;

722 ià(
ãc
 & 
NFP_FEC_DISABLED
)

723 
»suÉ
 |ð
ETHTOOL_FEC_OFF
;

725  
»suÉ
 ?: 
ETHTOOL_FEC_NONE
;

726 
	}
}

729 
	$nå_pÜt_g‘_ãý¬am
(
Ãt_deviû
 *
Ãtdev
,

730 
‘htoÞ_ãý¬am
 *
·¿m
)

732 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

733 
nå_pÜt
 *
pÜt
;

735 
·¿m
->
aùive_ãc
 = 
ETHTOOL_FEC_NONE_BIT
;

736 
·¿m
->
ãc
 = 
ETHTOOL_FEC_NONE_BIT
;

738 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

739 
‘h_pÜt
 = 
	`nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

740 ià(!
‘h_pÜt
)

741  -
EOPNOTSUPP
;

743 ià(!
	`nå_‘h_ÿn_suµÜt_ãc
(
‘h_pÜt
))

746 
·¿m
->
ãc
 = 
	`nå_pÜt_ãc_n¥_to_‘htoÞ
(
‘h_pÜt
->
ãc_modes_suµÜ‹d
);

747 
·¿m
->
aùive_ãc
 = 
	`nå_pÜt_ãc_n¥_to_‘htoÞ
(
‘h_pÜt
->
ãc
);

750 
	}
}

753 
	$nå_pÜt_£t_ãý¬am
(
Ãt_deviû
 *
Ãtdev
,

754 
‘htoÞ_ãý¬am
 *
·¿m
)

756 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

757 
nå_pÜt
 *
pÜt
;

758 
”r
, 
ãc
;

760 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

761 
‘h_pÜt
 = 
	`nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

762 ià(!
‘h_pÜt
)

763  -
EOPNOTSUPP
;

765 ià(!
	`nå_‘h_ÿn_suµÜt_ãc
(
‘h_pÜt
))

766  -
EOPNOTSUPP
;

768 
ãc
 = 
	`nå_pÜt_ãc_‘htoÞ_to_n¥
(
·¿m
->fec);

769 ià(
ãc
 < 0)

770  
ãc
;

772 
”r
 = 
	`nå_‘h_£t_ãc
(
pÜt
->
­p
->
ýp
, 
‘h_pÜt
->
šdex
, 
ãc
);

773 ià(!
”r
)

775 
	`nå_Ãt_»äesh_pÜt_bË
(
pÜt
);

777  
”r
 < 0 ?ƒrr : 0;

778 
	}
}

783 
u32
 
	$‘htoÞ_æow_to_nå_æag
(
u32
 
æow_ty³
)

785 cÚ¡ 
u32
 
xÏ‹_‘htoÞ_to_nå
[
IPV6_FLOW
 + 1] = {

786 [
TCP_V4_FLOW
] = 
NFP_NET_CFG_RSS_IPV4_TCP
,

787 [
TCP_V6_FLOW
] = 
NFP_NET_CFG_RSS_IPV6_TCP
,

788 [
UDP_V4_FLOW
] = 
NFP_NET_CFG_RSS_IPV4_UDP
,

789 [
UDP_V6_FLOW
] = 
NFP_NET_CFG_RSS_IPV6_UDP
,

790 [
IPV4_FLOW
] = 
NFP_NET_CFG_RSS_IPV4
,

791 [
IPV6_FLOW
] = 
NFP_NET_CFG_RSS_IPV6
,

794 ià(
æow_ty³
 >ð
	`ARRAY_SIZE
(
xÏ‹_‘htoÞ_to_nå
))

797  
xÏ‹_‘htoÞ_to_nå
[
æow_ty³
];

798 
	}
}

800 
	$nå_Ãt_g‘_rss_hash_Ýts
(
nå_Ãt
 *
Â
,

801 
‘htoÞ_rxnfc
 *
cmd
)

803 
u32
 
nå_rss_æag
;

805 
cmd
->
d©a
 = 0;

807 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
))

808  -
EOPNOTSUPP
;

810 
nå_rss_æag
 = 
	`‘htoÞ_æow_to_nå_æag
(
cmd
->
æow_ty³
);

811 ià(!
nå_rss_æag
)

812  -
EINVAL
;

814 
cmd
->
d©a
 |ð
RXH_IP_SRC
 | 
RXH_IP_DST
;

815 ià(
Â
->
rss_cfg
 & 
nå_rss_æag
)

816 
cmd
->
d©a
 |ð
RXH_L4_B_0_1
 | 
RXH_L4_B_2_3
;

819 
	}
}

821 
	$nå_Ãt_g‘_rxnfc
(
Ãt_deviû
 *
Ãtdev
,

822 
‘htoÞ_rxnfc
 *
cmd
, 
u32
 *
ruË_locs
)

824 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

826 
cmd
->cmd) {

827 
ETHTOOL_GRXRINGS
:

828 
cmd
->
d©a
 = 
Â
->
dp
.
num_rx_ršgs
;

830 
ETHTOOL_GRXFH
:

831  
	`nå_Ãt_g‘_rss_hash_Ýts
(
Â
, 
cmd
);

833  -
EOPNOTSUPP
;

835 
	}
}

837 
	$nå_Ãt_£t_rss_hash_Ýt
(
nå_Ãt
 *
Â
,

838 
‘htoÞ_rxnfc
 *
nfc
)

840 
u32
 
Ãw_rss_cfg
 = 
Â
->
rss_cfg
;

841 
u32
 
nå_rss_æag
;

842 
”r
;

844 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
))

845  -
EOPNOTSUPP
;

848 ià(
nfc
->
d©a
 & ~(
RXH_IP_SRC
 | 
RXH_IP_DST
 |

849 
RXH_L4_B_0_1
 | 
RXH_L4_B_2_3
))

850  -
EINVAL
;

853 ià(!(
nfc
->
d©a
 & 
RXH_IP_SRC
) ||

854 !(
nfc
->
d©a
 & 
RXH_IP_DST
))

855  -
EINVAL
;

857 
nå_rss_æag
 = 
	`‘htoÞ_æow_to_nå_æag
(
nfc
->
æow_ty³
);

858 ià(!
nå_rss_æag
)

859  -
EINVAL
;

861 
nfc
->
d©a
 & (
RXH_L4_B_0_1
 | 
RXH_L4_B_2_3
)) {

863 
Ãw_rss_cfg
 &ð~
nå_rss_æag
;

865 (
RXH_L4_B_0_1
 | 
RXH_L4_B_2_3
):

866 
Ãw_rss_cfg
 |ð
nå_rss_æag
;

869  -
EINVAL
;

872 
Ãw_rss_cfg
 |ð
	`FIELD_PREP
(
NFP_NET_CFG_RSS_HFUNC
, 
Â
->
rss_hfunc
);

873 
Ãw_rss_cfg
 |ð
NFP_NET_CFG_RSS_MASK
;

875 ià(
Ãw_rss_cfg
 =ð
Â
->
rss_cfg
)

878 
	`wr™–
(
Ãw_rss_cfg
, 
Â
->
dp
.
ù¾_b¬
 + 
NFP_NET_CFG_RSS_CTRL
);

879 
”r
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_RSS
);

880 ià(
”r
)

881  
”r
;

883 
Â
->
rss_cfg
 = 
Ãw_rss_cfg
;

885 
	`Â_dbg
(
Â
, "Chªged RSS cÚfigØ0x%x\n",‚n->
rss_cfg
);

887 
	}
}

889 
	$nå_Ãt_£t_rxnfc
(
Ãt_deviû
 *
Ãtdev
,

890 
‘htoÞ_rxnfc
 *
cmd
)

892 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

894 
cmd
->cmd) {

895 
ETHTOOL_SRXFH
:

896  
	`nå_Ãt_£t_rss_hash_Ýt
(
Â
, 
cmd
);

898  -
EOPNOTSUPP
;

900 
	}
}

902 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 3, 0))

903 
u32
 
	$nå_Ãt_g‘_rxfh_šdœ_size
(
Ãt_deviû
 *
Ãtdev
)

905 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

907 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
))

910  
	`ARRAY_SIZE
(
Â
->
rss_™bl
);

911 
	}
}

914 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 16, 0))

915 
u32
 
	$nå_Ãt_g‘_rxfh_key_size
(
Ãt_deviû
 *
Ãtdev
)

917 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

919 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
))

920  -
EOPNOTSUPP
;

922  
	`nå_Ãt_rss_key_sz
(
Â
);

923 
	}
}

926 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 3, 0))

927 
	$nå_Ãt_g‘_rxfh_šdœ
(
Ãt_deviû
 *
Ãtdev
,

928 
‘htoÞ_rxfh_šdœ
 *
šdœ
)

930 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

931 
size_t
 
cÝy_size
 =

932 
	`mš_t
(
size_t
, 
šdœ
->
size
, 
	`ARRAY_SIZE
(
Â
->
rss_™bl
));

933 
i
;

935 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
))

936  -
EOPNOTSUPP
;

938 
šdœ
->
size
 = 
	`ARRAY_SIZE
(
Â
->
rss_™bl
);

940 
i
 = 0; i < 
cÝy_size
; i++)

941 
šdœ
->
ršg_šdex
[
i
] = 
Â
->
rss_™bl
[i];

943 
	}
}

945 
	$nå_Ãt_£t_rxfh_šdœ
(
Ãt_deviû
 *
Ãtdev
,

946 cÚ¡ 
‘htoÞ_rxfh_šdœ
 *
šdœ
)

948 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

949 
i
;

951 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
))

952  -
EOPNOTSUPP
;

954 ià(
šdœ
->
size
 !ð
	`ARRAY_SIZE
(
Â
->
rss_™bl
))

955  -
EINVAL
;

957 
i
 = 0; i < 
	`ARRAY_SIZE
(
Â
->
rss_™bl
); i++)

958 
Â
->
rss_™bl
[
i
] = 
šdœ
->
ršg_šdex
[i];

960 
	`nå_Ãt_rss_wr™e_™bl
(
Â
);

961  
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_RSS
);

962 
	}
}

964 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 19, 0))

965 
	$nå_Ãt_g‘_rxfh
(
Ãt_deviû
 *
Ãtdev
, 
u32
 *
šdœ
, 
u8
 *
key
,

966 
u8
 *
hfunc
)

969 
	$nå_Ãt_g‘_rxfh
(
Ãt_deviû
 *
Ãtdev
, 
u32
 *
šdœ
, 
u8
 *
key
)

971 
u8
 *
hfunc
 = 
NULL
;

973 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

974 
i
;

976 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
))

977  -
EOPNOTSUPP
;

979 ià(
šdœ
)

980 
i
 = 0; i < 
	`ARRAY_SIZE
(
Â
->
rss_™bl
); i++)

981 
šdœ
[
i
] = 
Â
->
rss_™bl
[i];

982 ià(
key
)

983 
	`memýy
(
key
, 
Â
->
rss_key
, 
	`nå_Ãt_rss_key_sz
(nn));

984 ià(
hfunc
) {

985 *
hfunc
 = 
Â
->
rss_hfunc
;

986 ià(*
hfunc
 >ð1 << 
ETH_RSS_HASH_FUNCS_COUNT
)

987 *
hfunc
 = 
ETH_RSS_HASH_UNKNOWN
;

991 
	}
}

993 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 19, 0))

994 
	$nå_Ãt_£t_rxfh
(
Ãt_deviû
 *
Ãtdev
,

995 cÚ¡ 
u32
 *
šdœ
, cÚ¡ 
u8
 *
key
,

996 cÚ¡ 
u8
 
hfunc
)

999 
	$nå_Ãt_£t_rxfh
(
Ãt_deviû
 *
Ãtdev
,

1000 cÚ¡ 
u32
 *
šdœ
, cÚ¡ 
u8
 *
key
)

1002 cÚ¡ 
u8
 
hfunc
 = 0;

1004 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1005 
i
;

1007 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
) ||

1008 !(
hfunc
 =ð
ETH_RSS_HASH_NO_CHANGE
 || hfunø=ð
Â
->
rss_hfunc
))

1009  -
EOPNOTSUPP
;

1011 ià(!
key
 && !
šdœ
)

1014 ià(
key
) {

1015 
	`memýy
(
Â
->
rss_key
, 
key
, 
	`nå_Ãt_rss_key_sz
(nn));

1016 
	`nå_Ãt_rss_wr™e_key
(
Â
);

1018 ià(
šdœ
) {

1019 
i
 = 0; i < 
	`ARRAY_SIZE
(
Â
->
rss_™bl
); i++)

1020 
Â
->
rss_™bl
[
i
] = 
šdœ
[i];

1022 
	`nå_Ãt_rss_wr™e_™bl
(
Â
);

1025  
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_RSS
);

1026 
	}
}

1029 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 3, 0)) && \

1030 (
	gLINUX_VERSION_CODE
 < 
	$KERNEL_VERSION
(3, 16, 0))

1031 
	$nå_Ãt_g‘_rxfh_šdœ
(
Ãt_deviû
 *
Ãtdev
, 
u32
 *
šdœ
)

1033  
	`nå_Ãt_g‘_rxfh
(
Ãtdev
, 
šdœ
, 
NULL
);

1034 
	}
}

1036 
	$nå_Ãt_£t_rxfh_šdœ
(
Ãt_deviû
 *
Ãtdev
, cÚ¡ 
u32
 *
šdœ
)

1038  
	`nå_Ãt_£t_rxfh
(
Ãtdev
, 
šdœ
, 
NULL
);

1039 
	}
}

1044 
	$nå_Ãt_g‘_»gs_Ën
(
Ãt_deviû
 *
Ãtdev
)

1046  
NFP_NET_CFG_BAR_SZ
;

1047 
	}
}

1049 
	$nå_Ãt_g‘_»gs
(
Ãt_deviû
 *
Ãtdev
,

1050 
‘htoÞ_»gs
 *
»gs
, *
p
)

1052 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1053 
u32
 *
»gs_buf
 = 
p
;

1054 
i
;

1056 
»gs
->
v”siÚ
 = 
	`Â_»adl
(
Â
, 
NFP_NET_CFG_VERSION
);

1058 
i
 = 0; i < 
NFP_NET_CFG_BAR_SZ
 / (
u32
); i++)

1059 
»gs_buf
[
i
] = 
	`»adl
(
Â
->
dp
.
ù¾_b¬
 + (˜* (
u32
)));

1060 
	}
}

1062 
	$nå_Ãt_g‘_cßËsû
(
Ãt_deviû
 *
Ãtdev
,

1063 
‘htoÞ_cßËsû
 *
ec
)

1065 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1067 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_IRQMOD
))

1068  -
EINVAL
;

1070 
ec
->
rx_cßËsû_u£cs
 = 
Â
->rx_coalesce_usecs;

1071 
ec
->
rx_max_cßËsûd_äames
 = 
Â
->
rx_cßËsû_max_äames
;

1072 
ec
->
tx_cßËsû_u£cs
 = 
Â
->tx_coalesce_usecs;

1073 
ec
->
tx_max_cßËsûd_äames
 = 
Â
->
tx_cßËsû_max_äames
;

1076 
	}
}

1081 
	$nå_dump_n¥_dŸg
(
nå_­p
 *
­p
, 
‘htoÞ_dump
 *
dump
, *
bufãr
)

1083 
nå_»sourû
 *
»s
;

1084 
»t
;

1086 ià(!
­p
)

1087  -
EOPNOTSUPP
;

1089 
dump
->
v”siÚ
 = 1;

1090 
dump
->
æag
 = 
NFP_DUMP_NSP_DIAG
;

1092 
»s
 = 
	`nå_»sourû_acquœe
(
­p
->
ýp
, 
NFP_RESOURCE_NSP_DIAG
);

1093 ià(
	`IS_ERR
(
»s
))

1094  
	`PTR_ERR
(
»s
);

1096 ià(
bufãr
) {

1097 ià(
dump
->
Ën
 !ð
	`nå_»sourû_size
(
»s
)) {

1098 
»t
 = -
EINVAL
;

1099 
ex™_»Ëa£
;

1102 
»t
 = 
	`nå_ýp_»ad
(
­p
->
ýp
, 
	`nå_»sourû_ýp_id
(
»s
),

1103 
	`nå_»sourû_add»ss
(
»s
),

1104 
bufãr
, 
dump
->
Ën
);

1105 ià(
»t
 !ð
dump
->
Ën
)

1106 
»t
 =„‘ < 0 ?„‘ : -
EIO
;

1108 
»t
 = 0;

1110 
dump
->
Ën
 = 
	`nå_»sourû_size
(
»s
);

1111 
»t
 = 0;

1113 
ex™_»Ëa£
:

1114 
	`nå_»sourû_»Ëa£
(
»s
);

1116  
»t
;

1117 
	}
}

1124 
	$nå_­p_£t_dump
(
Ãt_deviû
 *
Ãtdev
, 
‘htoÞ_dump
 *
v®
)

1126 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

1127 
s64
 
Ën
;

1129 ià(!
­p
)

1130  -
EOPNOTSUPP
;

1132 ià(
v®
->
æag
 =ð
NFP_DUMP_NSP_DIAG
) {

1133 
­p
->
pf
->
dump_æag
 = 
v®
->
æag
;

1137 ià(!
­p
->
pf
->
dump¥ec
)

1138  -
EOPNOTSUPP
;

1140 
Ën
 = 
	`nå_Ãt_dump_ÿlcuÏ‹_size
(
­p
->
pf
,‡µ->pf->
dump¥ec
,

1141 
v®
->
æag
);

1142 ià(
Ën
 < 0)

1143  
Ën
;

1145 
­p
->
pf
->
dump_æag
 = 
v®
->
æag
;

1146 
­p
->
pf
->
dump_Ën
 = 
Ën
;

1149 
	}
}

1152 
	$nå_­p_g‘_dump_æag
(
Ãt_deviû
 *
Ãtdev
, 
‘htoÞ_dump
 *
dump
)

1154 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

1156 ià(!
­p
)

1157  -
EOPNOTSUPP
;

1159 ià(
­p
->
pf
->
dump_æag
 =ð
NFP_DUMP_NSP_DIAG
)

1160  
	`nå_dump_n¥_dŸg
(
­p
, 
dump
, 
NULL
);

1162 
dump
->
æag
 = 
­p
->
pf
->
dump_æag
;

1163 
dump
->
Ën
 = 
­p
->
pf
->
dump_Ën
;

1166 
	}
}

1169 
	$nå_­p_g‘_dump_d©a
(
Ãt_deviû
 *
Ãtdev
, 
‘htoÞ_dump
 *
dump
,

1170 *
bufãr
)

1172 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

1174 ià(!
­p
)

1175  -
EOPNOTSUPP
;

1177 ià(
­p
->
pf
->
dump_æag
 =ð
NFP_DUMP_NSP_DIAG
)

1178  
	`nå_dump_n¥_dŸg
(
­p
, 
dump
, 
bufãr
);

1180 
dump
->
æag
 = 
­p
->
pf
->
dump_æag
;

1181 
dump
->
Ën
 = 
­p
->
pf
->
dump_Ën
;

1183  
	`nå_Ãt_dump_pÝuÏ‹_bufãr
(
­p
->
pf
,‡µ->pf->
dump¥ec
, 
dump
,

1184 
bufãr
);

1185 
	}
}

1188 
	$nå_pÜt_g‘_moduË_šfo
(
Ãt_deviû
 *
Ãtdev
,

1189 
‘htoÞ_modšfo
 *
modšfo
)

1191 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

1192 
nå_pÜt
 *
pÜt
;

1193 
»ad_Ën
;

1194 
nå_n¥
 *
n¥
;

1195 
”r
 = 0;

1196 
u8
 
d©a
;

1198 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

1199 
‘h_pÜt
 = 
	`nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

1200 ià(!
‘h_pÜt
)

1201  -
EOPNOTSUPP
;

1203 
n¥
 = 
	`nå_n¥_Ý’
(
pÜt
->
­p
->
ýp
);

1204 ià(
	`IS_ERR
(
n¥
)) {

1205 
”r
 = 
	`PTR_ERR
(
n¥
);

1206 
	`Ãtdev_”r
(
Ãtdev
, "FažedØacûs thNSP: %d\n", 
”r
);

1207  
”r
;

1210 ià(!
	`nå_n¥_has_»ad_moduË_“´om
(
n¥
)) {

1211 
	`Ãtdev_šfo
(
Ãtdev
, "reading module EEPROM‚ot supported. Please update flash\n");

1212 
”r
 = -
EOPNOTSUPP
;

1213 
ex™_þo£_n¥
;

1216 
‘h_pÜt
->
š‹rçû
) {

1217 
NFP_INTERFACE_SFP
:

1218 
NFP_INTERFACE_SFP28
:

1219 
”r
 = 
	`nå_n¥_»ad_moduË_“´om
(
n¥
, 
‘h_pÜt
->
‘h_šdex
,

1220 
SFP_SFF8472_COMPLIANCE
, &
d©a
,

1221 1, &
»ad_Ën
);

1222 ià(
”r
 < 0)

1223 
ex™_þo£_n¥
;

1225 ià(!
d©a
) {

1226 
modšfo
->
ty³
 = 
ETH_MODULE_SFF_8079
;

1227 
modšfo
->
“´om_Ën
 = 
ETH_MODULE_SFF_8079_LEN
;

1229 
modšfo
->
ty³
 = 
ETH_MODULE_SFF_8472
;

1230 
modšfo
->
“´om_Ën
 = 
ETH_MODULE_SFF_8472_LEN
;

1233 
NFP_INTERFACE_QSFP
:

1234 
”r
 = 
	`nå_n¥_»ad_moduË_“´om
(
n¥
, 
‘h_pÜt
->
‘h_šdex
,

1235 
SFP_SFF_REV_COMPLIANCE
, &
d©a
,

1236 1, &
»ad_Ën
);

1237 ià(
”r
 < 0)

1238 
ex™_þo£_n¥
;

1240 ià(
d©a
 < 0x3) {

1241 
modšfo
->
ty³
 = 
ETH_MODULE_SFF_8436
;

1242 
modšfo
->
“´om_Ën
 = 
ETH_MODULE_SFF_8436_LEN
;

1244 
modšfo
->
ty³
 = 
ETH_MODULE_SFF_8636
;

1245 
modšfo
->
“´om_Ën
 = 
ETH_MODULE_SFF_8636_LEN
;

1248 
NFP_INTERFACE_QSFP28
:

1249 
modšfo
->
ty³
 = 
ETH_MODULE_SFF_8636
;

1250 
modšfo
->
“´om_Ën
 = 
ETH_MODULE_SFF_8636_LEN
;

1253 
	`Ãtdev_”r
(
Ãtdev
, "Unsupported module 0x%x detected\n",

1254 
‘h_pÜt
->
š‹rçû
);

1255 
”r
 = -
EINVAL
;

1258 
ex™_þo£_n¥
:

1259 
	`nå_n¥_þo£
(
n¥
);

1260  
”r
;

1261 
	}
}

1264 
	$nå_pÜt_g‘_moduË_“´om
(
Ãt_deviû
 *
Ãtdev
,

1265 
‘htoÞ_“´om
 *
“´om
, 
u8
 *
d©a
)

1267 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

1268 
nå_pÜt
 *
pÜt
;

1269 
nå_n¥
 *
n¥
;

1270 
”r
;

1272 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

1273 
‘h_pÜt
 = 
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

1274 ià(!
‘h_pÜt
)

1275  -
EOPNOTSUPP
;

1277 
n¥
 = 
	`nå_n¥_Ý’
(
pÜt
->
­p
->
ýp
);

1278 ià(
	`IS_ERR
(
n¥
)) {

1279 
”r
 = 
	`PTR_ERR
(
n¥
);

1280 
	`Ãtdev_”r
(
Ãtdev
, "FažedØacûs thNSP: %d\n", 
”r
);

1281  
”r
;

1284 ià(!
	`nå_n¥_has_»ad_moduË_“´om
(
n¥
)) {

1285 
	`Ãtdev_šfo
(
Ãtdev
, "reading module EEPROM‚ot supported. Please update flash\n");

1286 
”r
 = -
EOPNOTSUPP
;

1287 
ex™_þo£_n¥
;

1290 
”r
 = 
	`nå_n¥_»ad_moduË_“´om
(
n¥
, 
‘h_pÜt
->
‘h_šdex
,

1291 
“´om
->
off£t
, 
d©a
,ƒ•rom->
Ën
,

1292 &
“´om
->
Ën
);

1293 ià(
”r
 < 0) {

1294 ià(
“´om
->
Ën
) {

1295 
	`Ãtdev_w¬n
(
Ãtdev
,

1297 
”r
);

1298 
”r
 = 0;

1300 
	`Ãtdev_”r
(
Ãtdev
,

1302 
”r
);

1306 
ex™_þo£_n¥
:

1307 
	`nå_n¥_þo£
(
n¥
);

1308  
”r
;

1309 
	}
}

1311 
	$nå_Ãt_£t_cßËsû
(
Ãt_deviû
 *
Ãtdev
,

1312 
‘htoÞ_cßËsû
 *
ec
)

1314 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1315 
çùÜ
;

1317 ià(
ec
->
rx_cßËsû_u£cs_œq
 ||

1318 
ec
->
rx_max_cßËsûd_äames_œq
 ||

1319 
ec
->
tx_cßËsû_u£cs_œq
 ||

1320 
ec
->
tx_max_cßËsûd_äames_œq
 ||

1321 
ec
->
¡©s_block_cßËsû_u£cs
 ||

1322 
ec
->
u£_ad­tive_rx_cßËsû
 ||

1323 
ec
->
u£_ad­tive_tx_cßËsû
 ||

1324 
ec
->
pkt_¿‹_low
 ||

1325 
ec
->
rx_cßËsû_u£cs_low
 ||

1326 
ec
->
rx_max_cßËsûd_äames_low
 ||

1327 
ec
->
tx_cßËsû_u£cs_low
 ||

1328 
ec
->
tx_max_cßËsûd_äames_low
 ||

1329 
ec
->
pkt_¿‹_high
 ||

1330 
ec
->
rx_cßËsû_u£cs_high
 ||

1331 
ec
->
rx_max_cßËsûd_äames_high
 ||

1332 
ec
->
tx_cßËsû_u£cs_high
 ||

1333 
ec
->
tx_max_cßËsûd_äames_high
 ||

1334 
ec
->
¿‹_§m¶e_š‹rv®
)

1335  -
EOPNOTSUPP
;

1341 
çùÜ
 = 
Â
->
me_äeq_mhz
 / 16;

1356 ià(!(
Â
->
ÿp
 & 
NFP_NET_CFG_CTRL_IRQMOD
))

1357  -
EINVAL
;

1360 ià(!
ec
->
rx_cßËsû_u£cs
 && !ec->
rx_max_cßËsûd_äames
)

1361  -
EINVAL
;

1363 ià(!
ec
->
tx_cßËsû_u£cs
 && !ec->
tx_max_cßËsûd_äames
)

1364  -
EINVAL
;

1366 ià(
ec
->
rx_cßËsû_u£cs
 * 
çùÜ
 >= ((1 << 16) - 1))

1367  -
EINVAL
;

1369 ià(
ec
->
tx_cßËsû_u£cs
 * 
çùÜ
 >= ((1 << 16) - 1))

1370  -
EINVAL
;

1372 ià(
ec
->
rx_max_cßËsûd_äames
 >= ((1 << 16) - 1))

1373  -
EINVAL
;

1375 ià(
ec
->
tx_max_cßËsûd_äames
 >= ((1 << 16) - 1))

1376  -
EINVAL
;

1379 
Â
->
rx_cßËsû_u£cs
 = 
ec
->rx_coalesce_usecs;

1380 
Â
->
rx_cßËsû_max_äames
 = 
ec
->
rx_max_cßËsûd_äames
;

1381 
Â
->
tx_cßËsû_u£cs
 = 
ec
->tx_coalesce_usecs;

1382 
Â
->
tx_cßËsû_max_äames
 = 
ec
->
tx_max_cßËsûd_äames
;

1385 
	`nå_Ãt_cßËsû_wr™e_cfg
(
Â
);

1386  
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_IRQMOD
);

1387 
	}
}

1389 
	$nå_Ãt_g‘_chªÃls
(
Ãt_deviû
 *
Ãtdev
,

1390 
‘htoÞ_chªÃls
 *
chªÃl
)

1392 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1393 
num_tx_ršgs
;

1395 
num_tx_ršgs
 = 
Â
->
dp
.num_tx_rings;

1396 ià(
Â
->
dp
.
xdp_´og
)

1397 
num_tx_ršgs
 -ð
Â
->
dp
.
num_rx_ršgs
;

1399 
chªÃl
->
max_rx
 = 
	`mš
(
Â
->
max_rx_ršgs
,‚n->
max_r_vecs
);

1400 
chªÃl
->
max_tx
 = 
	`mš
(
Â
->
max_tx_ršgs
,‚n->
max_r_vecs
);

1401 
chªÃl
->
max_combšed
 = 
	`mš
(chªÃl->
max_rx
, chªÃl->
max_tx
);

1402 
chªÃl
->
max_Ùh”
 = 
NFP_NET_NON_Q_VECTORS
;

1403 
chªÃl
->
combšed_couÁ
 = 
	`mš
(
Â
->
dp
.
num_rx_ršgs
, 
num_tx_ršgs
);

1404 
chªÃl
->
rx_couÁ
 = 
Â
->
dp
.
num_rx_ršgs
 - chªÃl->
combšed_couÁ
;

1405 
chªÃl
->
tx_couÁ
 = 
num_tx_ršgs
 - chªÃl->
combšed_couÁ
;

1406 
chªÃl
->
Ùh”_couÁ
 = 
NFP_NET_NON_Q_VECTORS
;

1407 
	}
}

1409 
	$nå_Ãt_£t_num_ršgs
(
nå_Ãt
 *
Â
, 
tÙ®_rx
,

1410 
tÙ®_tx
)

1412 
nå_Ãt_dp
 *
dp
;

1414 
dp
 = 
	`nå_Ãt_þÚe_dp
(
Â
);

1415 ià(!
dp
)

1416  -
ENOMEM
;

1418 
dp
->
num_rx_ršgs
 = 
tÙ®_rx
;

1419 
dp
->
num_tx_ršgs
 = 
tÙ®_tx
;

1421 ià(
dp
->
xdp_´og
)

1422 
dp
->
num_tx_ršgs
 +ð
tÙ®_rx
;

1424  
	`nå_Ãt_ršg_»cÚfig
(
Â
, 
dp
, 
NULL
);

1425 
	}
}

1427 
	$nå_Ãt_£t_chªÃls
(
Ãt_deviû
 *
Ãtdev
,

1428 
‘htoÞ_chªÃls
 *
chªÃl
)

1430 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

1431 
tÙ®_rx
, 
tÙ®_tx
;

1434 ià(!
chªÃl
->
combšed_couÁ
 ||

1435 
chªÃl
->
Ùh”_couÁ
 !ð
NFP_NET_NON_Q_VECTORS
 ||

1436 (
chªÃl
->
rx_couÁ
 && chªÃl->
tx_couÁ
))

1437  -
EINVAL
;

1439 
tÙ®_rx
 = 
chªÃl
->
combšed_couÁ
 + chªÃl->
rx_couÁ
;

1440 
tÙ®_tx
 = 
chªÃl
->
combšed_couÁ
 + chªÃl->
tx_couÁ
;

1442 ià(
tÙ®_rx
 > 
	`mš
(
Â
->
max_rx_ršgs
,‚n->
max_r_vecs
) ||

1443 
tÙ®_tx
 > 
	`mš
(
Â
->
max_tx_ršgs
,‚n->
max_r_vecs
))

1444  -
EINVAL
;

1446  
	`nå_Ãt_£t_num_ršgs
(
Â
, 
tÙ®_rx
, 
tÙ®_tx
);

1447 
	}
}

1449 cÚ¡ 
‘htoÞ_Ýs
 
	gnå_Ãt_‘htoÞ_Ýs
 = {

1450 .
g‘_drvšfo
 = 
nå_Ãt_g‘_drvšfo
,

1451 .
	gg‘_lšk
 = 
‘htoÞ_Ý_g‘_lšk
,

1452 .
	gg‘_ršg·¿m
 = 
nå_Ãt_g‘_ršg·¿m
,

1453 .
	g£t_ršg·¿m
 = 
nå_Ãt_£t_ršg·¿m
,

1454 .
	gg‘_¡ršgs
 = 
nå_Ãt_g‘_¡ršgs
,

1455 .
	gg‘_‘htoÞ_¡©s
 = 
nå_Ãt_g‘_¡©s
,

1456 .
	gg‘_s£t_couÁ
 = 
nå_Ãt_g‘_s£t_couÁ
,

1457 .
	gg‘_rxnfc
 = 
nå_Ãt_g‘_rxnfc
,

1458 .
	g£t_rxnfc
 = 
nå_Ãt_£t_rxnfc
,

1459 .
	gæash_deviû
 = 
com·t__nå_Ãt_æash_deviû
,

1460 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 3, 0))

1461 .
	gg‘_rxfh_šdœ_size
 = 
nå_Ãt_g‘_rxfh_šdœ_size
,

1463 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 16, 0))

1464 .
	gg‘_rxfh_key_size
 = 
nå_Ãt_g‘_rxfh_key_size
,

1465 .
	gg‘_rxfh
 = 
nå_Ãt_g‘_rxfh
,

1466 .
	g£t_rxfh
 = 
nå_Ãt_£t_rxfh
,

1468 .
	gg‘_rxfh_šdœ
 = 
nå_Ãt_g‘_rxfh_šdœ
,

1469 .
	g£t_rxfh_šdœ
 = 
nå_Ãt_£t_rxfh_šdœ
,

1471 .
	gg‘_»gs_Ën
 = 
nå_Ãt_g‘_»gs_Ën
,

1472 .
	gg‘_»gs
 = 
nå_Ãt_g‘_»gs
,

1473 .
	g£t_dump
 = 
nå_­p_£t_dump
,

1474 .
	gg‘_dump_æag
 = 
nå_­p_g‘_dump_æag
,

1475 .
	gg‘_dump_d©a
 = 
nå_­p_g‘_dump_d©a
,

1476 .
	gg‘_moduË_šfo
 = 
nå_pÜt_g‘_moduË_šfo
,

1477 .
	gg‘_moduË_“´om
 = 
nå_pÜt_g‘_moduË_“´om
,

1478 .
	gg‘_cßËsû
 = 
nå_Ãt_g‘_cßËsû
,

1479 .
	g£t_cßËsû
 = 
nå_Ãt_£t_cßËsû
,

1480 .
	gg‘_chªÃls
 = 
nå_Ãt_g‘_chªÃls
,

1481 .
	g£t_chªÃls
 = 
nå_Ãt_£t_chªÃls
,

1482 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 6, 0)

1483 .
	gg‘_£‰šgs
 = (*)
nå_Ãt_g‘_lšk_k£‰šgs
,

1484 .
	g£t_£‰šgs
 = (*)
nå_Ãt_£t_lšk_k£‰šgs
,

1486 .
	gg‘_lšk_k£‰šgs
 = 
nå_Ãt_g‘_lšk_k£‰šgs
,

1487 .
	g£t_lšk_k£‰šgs
 = 
nå_Ãt_£t_lšk_k£‰šgs
,

1489 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 14, 0)

1490 .
	gg‘_ãý¬am
 = 
nå_pÜt_g‘_ãý¬am
,

1491 .
	g£t_ãý¬am
 = 
nå_pÜt_£t_ãý¬am
,

1495 cÚ¡ 
‘htoÞ_Ýs
 
	gnå_pÜt_‘htoÞ_Ýs
 = {

1496 .
g‘_drvšfo
 = 
nå_­p_g‘_drvšfo
,

1497 .
	gg‘_lšk
 = 
‘htoÞ_Ý_g‘_lšk
,

1498 .
	gg‘_¡ršgs
 = 
nå_pÜt_g‘_¡ršgs
,

1499 .
	gg‘_‘htoÞ_¡©s
 = 
nå_pÜt_g‘_¡©s
,

1500 .
	gg‘_s£t_couÁ
 = 
nå_pÜt_g‘_s£t_couÁ
,

1501 .
	gæash_deviû
 = 
com·t__nå_Ãt_æash_deviû
,

1502 .
	g£t_dump
 = 
nå_­p_£t_dump
,

1503 .
	gg‘_dump_æag
 = 
nå_­p_g‘_dump_æag
,

1504 .
	gg‘_dump_d©a
 = 
nå_­p_g‘_dump_d©a
,

1505 .
	gg‘_moduË_šfo
 = 
nå_pÜt_g‘_moduË_šfo
,

1506 .
	gg‘_moduË_“´om
 = 
nå_pÜt_g‘_moduË_“´om
,

1507 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 6, 0)

1508 .
	gg‘_£‰šgs
 = (*)
nå_Ãt_g‘_lšk_k£‰šgs
,

1509 .
	g£t_£‰šgs
 = (*)
nå_Ãt_£t_lšk_k£‰šgs
,

1511 .
	gg‘_lšk_k£‰šgs
 = 
nå_Ãt_g‘_lšk_k£‰šgs
,

1512 .
	g£t_lšk_k£‰šgs
 = 
nå_Ãt_£t_lšk_k£‰šgs
,

1514 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 14, 0)

1515 .
	gg‘_ãý¬am
 = 
nå_pÜt_g‘_ãý¬am
,

1516 .
	g£t_ãý¬am
 = 
nå_pÜt_£t_ãý¬am
,

1520 
	$nå_Ãt_£t_‘htoÞ_Ýs
(
Ãt_deviû
 *
Ãtdev
)

1522 
Ãtdev
->
‘htoÞ_Ýs
 = &
nå_Ãt_‘htoÞ_Ýs
;

1523 
	}
}

	@src/nfp_net_main.c

12 
	~"nå_Ãt_com·t.h
"

14 
	~<lšux/‘h”deviû.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/lockd•.h
>

18 
	~<lšux/pci.h
>

19 
	~<lšux/pci_»gs.h
>

20 
	~<lšux/msi.h
>

21 
	~<lšux/¿ndom.h
>

22 
	~<lšux/¹ÃŽšk.h
>

24 
	~"nåcÜe/nå.h
"

25 
	~"nåcÜe/nå_ýp.h
"

26 
	~"nåcÜe/nå_dev.h
"

27 
	~"nåcÜe/nå_nffw.h
"

28 
	~"nåcÜe/nå_n¥.h
"

29 
	~"nåcÜe/nå6000_pc›.h
"

30 
	~"nå_­p.h
"

31 
	~"nå_Ãt_ù¾.h
"

32 
	~"nå_Ãt_¤iov.h
"

33 
	~"nå_Ãt.h
"

34 
	~"nå_maš.h
"

35 
	~"nå_pÜt.h
"

37 
	#NFP_PF_CSR_SLICE_SIZE
 (32 * 1024)

	)

49 
	$nå_Ãt_g‘_mac_addr
(
nå_pf
 *
pf
, 
Ãt_deviû
 *
Ãtdev
,

50 
nå_pÜt
 *
pÜt
)

52 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

54 
‘h_pÜt
 = 
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

55 ià(!
‘h_pÜt
) {

56 
	`‘h_hw_addr_¿ndom
(
Ãtdev
);

60 
	`‘h”_addr_cÝy
(
Ãtdev
->
dev_addr
, 
‘h_pÜt
->
mac_addr
);

61 
	`‘h”_addr_cÝy
(
Ãtdev
->
³rm_addr
, 
‘h_pÜt
->
mac_addr
);

62 
	}
}

64 
nå_‘h_bË_pÜt
 *

65 
	$nå_Ãt_fšd_pÜt
(
nå_‘h_bË
 *
‘h_tbl
, 
šdex
)

67 
i
;

69 
i
 = 0; 
‘h_tbl
 && i <ƒth_tbl->
couÁ
; i++)

70 ià(
‘h_tbl
->
pÜts
[
i
].
šdex
 == index)

71  &
‘h_tbl
->
pÜts
[
i
];

73  
NULL
;

74 
	}
}

76 
	$nå_Ãt_pf_g‘_num_pÜts
(
nå_pf
 *
pf
)

78  
	`nå_pf_¹sym_»ad_ÝtiÚ®
(
pf
, "nfd_cfg_pf%u_num_ports", 1);

79 
	}
}

81 
	$nå_Ãt_pf_g‘_­p_id
(
nå_pf
 *
pf
)

83  
	`nå_pf_¹sym_»ad_ÝtiÚ®
(
pf
, "_pf%u_net_app_id",

84 
NFP_APP_CORE_NIC
);

85 
	}
}

87 
	$nå_Ãt_pf_ä“_vnic
(
nå_pf
 *
pf
, 
nå_Ãt
 *
Â
)

89 ià(
	`nå_Ãt_is_d©a_vnic
(
Â
))

90 
	`nå_­p_vnic_ä“
(
pf
->
­p
, 
Â
);

91 
	`nå_pÜt_ä“
(
Â
->
pÜt
);

92 
	`li¡_d–
(&
Â
->
vnic_li¡
);

93 
pf
->
num_vnics
--;

94 
	`nå_Ãt_ä“
(
Â
);

95 
	}
}

97 
	$nå_Ãt_pf_ä“_vnics
(
nå_pf
 *
pf
)

99 
nå_Ãt
 *
Â
, *
Ãxt
;

101 
	`li¡_fÜ_—ch_’Œy_§ã
(
Â
, 
Ãxt
, &
pf
->
vnics
, 
vnic_li¡
)

102 ià(
	`nå_Ãt_is_d©a_vnic
(
Â
))

103 
	`nå_Ãt_pf_ä“_vnic
(
pf
, 
Â
);

104 
	}
}

106 
nå_Ãt
 *

107 
	$nå_Ãt_pf_®loc_vnic
(
nå_pf
 *
pf
, 
boÞ
 
Ãeds_Ãtdev
,

108 
__iomem
 *
ù¾_b¬
, __iomem *
qc_b¬
,

109 
¡ride
, 
id
)

111 
u32
 
tx_ba£
, 
rx_ba£
, 
n_tx_ršgs
, 
n_rx_ršgs
;

112 
nå_Ãt
 *
Â
;

113 
”r
;

115 
tx_ba£
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_START_TXQ
);

116 
rx_ba£
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_START_RXQ
);

117 
n_tx_ršgs
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_MAX_TXRINGS
);

118 
n_rx_ršgs
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_MAX_RXRINGS
);

121 
Â
 = 
	`nå_Ãt_®loc
(
pf
->
pdev
,…f->
dev_šfo
, 
ù¾_b¬
, 
Ãeds_Ãtdev
,

122 
n_tx_ršgs
, 
n_rx_ršgs
);

123 ià(
	`IS_ERR
(
Â
))

124  
Â
;

126 
Â
->
­p
 = 
pf
->app;

127 
Â
->
tx_b¬
 = 
qc_b¬
 + 
tx_ba£
 * 
NFP_QCP_QUEUE_ADDR_SZ
;

128 
Â
->
rx_b¬
 = 
qc_b¬
 + 
rx_ba£
 * 
NFP_QCP_QUEUE_ADDR_SZ
;

129 
Â
->
dp
.
is_vf
 = 0;

130 
Â
->
¡ride_rx
 = 
¡ride
;

131 
Â
->
¡ride_tx
 = 
¡ride
;

133 ià(
Ãeds_Ãtdev
) {

134 
”r
 = 
	`nå_­p_vnic_®loc
(
pf
->
­p
, 
Â
, 
id
);

135 ià(
”r
) {

136 
	`nå_Ãt_ä“
(
Â
);

137  
	`ERR_PTR
(
”r
);

141 
pf
->
num_vnics
++;

142 
	`li¡_add_ž
(&
Â
->
vnic_li¡
, &
pf
->
vnics
);

144  
Â
;

145 
	}
}

148 
	$nå_Ãt_pf_š™_vnic
(
nå_pf
 *
pf
, 
nå_Ãt
 *
Â
, 
id
)

150 
”r
;

152 
Â
->
id
 = id;

154 ià(
Â
->
pÜt
) {

155 
”r
 = 
	`nå_devlšk_pÜt_»gi¡”
(
pf
->
­p
, 
Â
->
pÜt
);

156 ià(
”r
)

157  
”r
;

160 
”r
 = 
	`nå_Ãt_š™
(
Â
);

161 ià(
”r
)

162 
”r_devlšk_pÜt_þ—n
;

164 
	`nå_Ãt_debugfs_vnic_add
(
Â
, 
pf
->
ddœ
);

166 ià(
Â
->
pÜt
)

167 
	`nå_devlšk_pÜt_ty³_‘h_£t
(
Â
->
pÜt
);

169 
	`nå_Ãt_šfo
(
Â
);

171 ià(
	`nå_Ãt_is_d©a_vnic
(
Â
)) {

172 
”r
 = 
	`nå_­p_vnic_š™
(
pf
->
­p
, 
Â
);

173 ià(
”r
)

174 
”r_devlšk_pÜt_ty³_þ—n
;

179 
”r_devlšk_pÜt_ty³_þ—n
:

180 ià(
Â
->
pÜt
)

181 
	`nå_devlšk_pÜt_ty³_þ—r
(
Â
->
pÜt
);

182 
	`nå_Ãt_debugfs_dœ_þ—n
(&
Â
->
debugfs_dœ
);

183 
	`nå_Ãt_þ—n
(
Â
);

184 
”r_devlšk_pÜt_þ—n
:

185 ià(
Â
->
pÜt
)

186 
	`nå_devlšk_pÜt_uÄegi¡”
(
Â
->
pÜt
);

187  
”r
;

188 
	}
}

191 
	$nå_Ãt_pf_®loc_vnics
(
nå_pf
 *
pf
, 
__iomem
 *
ù¾_b¬
,

192 
__iomem
 *
qc_b¬
, 
¡ride
)

194 
nå_Ãt
 *
Â
;

195 
i
;

196 
”r
;

198 
i
 = 0; i < 
pf
->
max_d©a_vnics
; i++) {

199 
Â
 = 
	`nå_Ãt_pf_®loc_vnic
(
pf
, 
Œue
, 
ù¾_b¬
, 
qc_b¬
,

200 
¡ride
, 
i
);

201 ià(
	`IS_ERR
(
Â
)) {

202 
”r
 = 
	`PTR_ERR
(
Â
);

203 
”r_ä“_´ev
;

206 
ù¾_b¬
 +ð
NFP_PF_CSR_SLICE_SIZE
;

209 ià(
Â
->
pÜt
 &&‚n->pÜt->
ty³
 =ð
NFP_PORT_INVALID
) {

210 
	`nå_Ãt_pf_ä“_vnic
(
pf
, 
Â
);

215 ià(
	`li¡_em±y
(&
pf
->
vnics
))

216  -
ENODEV
;

220 
”r_ä“_´ev
:

221 
	`nå_Ãt_pf_ä“_vnics
(
pf
);

222  
”r
;

223 
	}
}

225 
	$nå_Ãt_pf_þ—n_vnic
(
nå_pf
 *
pf
, 
nå_Ãt
 *
Â
)

227 ià(
	`nå_Ãt_is_d©a_vnic
(
Â
))

228 
	`nå_­p_vnic_þ—n
(
pf
->
­p
, 
Â
);

229 ià(
Â
->
pÜt
)

230 
	`nå_devlšk_pÜt_ty³_þ—r
(
Â
->
pÜt
);

231 
	`nå_Ãt_debugfs_dœ_þ—n
(&
Â
->
debugfs_dœ
);

232 
	`nå_Ãt_þ—n
(
Â
);

233 ià(
Â
->
pÜt
)

234 
	`nå_devlšk_pÜt_uÄegi¡”
(
Â
->
pÜt
);

235 
	}
}

237 
	$nå_Ãt_pf_®loc_œqs
(
nå_pf
 *
pf
)

239 
wª‹d_œqs
, 
num_œqs
, 
vnics_Ëá
, 
œqs_Ëá
;

240 
nå_Ãt
 *
Â
;

243 
wª‹d_œqs
 = 0;

244 
	`li¡_fÜ_—ch_’Œy
(
Â
, &
pf
->
vnics
, 
vnic_li¡
)

245 
wª‹d_œqs
 +ð
NFP_NET_NON_Q_VECTORS
 + 
Â
->
dp
.
num_r_vecs
;

246 
pf
->
œq_’Œ›s
 = 
	`kÿÎoc
(
wª‹d_œqs
, (*pf->irq_entries),

247 
GFP_KERNEL
);

248 ià(!
pf
->
œq_’Œ›s
)

249  -
ENOMEM
;

251 
num_œqs
 = 
	`nå_Ãt_œqs_®loc
(
pf
->
pdev
,…f->
œq_’Œ›s
,

252 
NFP_NET_MIN_VNIC_IRQS
 * 
pf
->
num_vnics
,

253 
wª‹d_œqs
);

254 ià(!
num_œqs
) {

255 
	`nå_w¬n
(
pf
->
ýp
, "Unableo‡llocate MSI-X vectors\n");

256 
	`kä“
(
pf
->
œq_’Œ›s
);

257  -
ENOMEM
;

261 
œqs_Ëá
 = 
num_œqs
;

262 
vnics_Ëá
 = 
pf
->
num_vnics
;

263 
	`li¡_fÜ_—ch_’Œy
(
Â
, &
pf
->
vnics
, 
vnic_li¡
) {

264 
n
;

266 
n
 = 
	`mš
(
NFP_NET_NON_Q_VECTORS
 + 
Â
->
dp
.
num_r_vecs
,

267 
	`DIV_ROUND_UP
(
œqs_Ëá
, 
vnics_Ëá
));

268 
	`nå_Ãt_œqs_assign
(
Â
, &
pf
->
œq_’Œ›s
[
num_œqs
 - 
œqs_Ëá
],

269 
n
);

270 
œqs_Ëá
 -ð
n
;

271 
vnics_Ëá
--;

275 
	}
}

277 
	$nå_Ãt_pf_ä“_œqs
(
nå_pf
 *
pf
)

279 
	`nå_Ãt_œqs_di§bË
(
pf
->
pdev
);

280 
	`kä“
(
pf
->
œq_’Œ›s
);

281 
	}
}

283 
	$nå_Ãt_pf_š™_vnics
(
nå_pf
 *
pf
)

285 
nå_Ãt
 *
Â
;

286 
id
;

287 
”r
;

290 
id
 = 0;

291 
	`li¡_fÜ_—ch_’Œy
(
Â
, &
pf
->
vnics
, 
vnic_li¡
) {

292 ià(!
	`nå_Ãt_is_d©a_vnic
(
Â
))

294 
”r
 = 
	`nå_Ãt_pf_š™_vnic
(
pf
, 
Â
, 
id
);

295 ià(
”r
)

296 
”r_´ev_deš™
;

298 
id
++;

303 
”r_´ev_deš™
:

304 
	`li¡_fÜ_—ch_’Œy_cÚtšue_»v”£
(
Â
, &
pf
->
vnics
, 
vnic_li¡
)

305 ià(
	`nå_Ãt_is_d©a_vnic
(
Â
))

306 
	`nå_Ãt_pf_þ—n_vnic
(
pf
, 
Â
);

307  
”r
;

308 
	}
}

311 
	$nå_Ãt_pf_­p_š™
(
nå_pf
 *
pf
, 
u8
 
__iomem
 *
qc_b¬
, 
¡ride
)

313 
u8
 
__iomem
 *
ù¾_b¬
;

314 
”r
;

316 
pf
->
­p
 = 
	`nå_­p_®loc
Õf, 
	`nå_Ãt_pf_g‘_­p_id
(pf));

317 ià(
	`IS_ERR
(
pf
->
­p
))

318  
	`PTR_ERR
(
pf
->
­p
);

320 
	`mu‹x_lock
(&
pf
->
lock
);

321 
”r
 = 
	`nå_­p_š™
(
pf
->
­p
);

322 
	`mu‹x_uÆock
(&
pf
->
lock
);

323 ià(
”r
)

324 
”r_ä“
;

326 ià(!
	`nå_­p_Ãeds_ù¾_vnic
(
pf
->
­p
))

329 
ù¾_b¬
 = 
	`nå_pf_m­_¹sym
(
pf
, "net.ctrl", "_pf%u_net_ctrl_bar",

330 
NFP_PF_CSR_SLICE_SIZE
, &
pf
->
ù¾_vnic_b¬
);

331 ià(
	`IS_ERR
(
ù¾_b¬
)) {

332 
	`nå_”r
(
pf
->
ýp
, "Failedo find ctrl vNIC memory symbol\n");

333 
”r
 = 
	`PTR_ERR
(
ù¾_b¬
);

334 
”r_­p_þ—n
;

337 
pf
->
ù¾_vnic
 = 
	`nå_Ãt_pf_®loc_vnic
Õf, 
çl£
, 
ù¾_b¬
, 
qc_b¬
,

338 
¡ride
, 0);

339 ià(
	`IS_ERR
(
pf
->
ù¾_vnic
)) {

340 
”r
 = 
	`PTR_ERR
(
pf
->
ù¾_vnic
);

341 
”r_unm­
;

346 
”r_unm­
:

347 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
ù¾_vnic_b¬
);

348 
”r_­p_þ—n
:

349 
	`mu‹x_lock
(&
pf
->
lock
);

350 
	`nå_­p_þ—n
(
pf
->
­p
);

351 
	`mu‹x_uÆock
(&
pf
->
lock
);

352 
”r_ä“
:

353 
	`nå_­p_ä“
(
pf
->
­p
);

354 
pf
->
­p
 = 
NULL
;

355  
”r
;

356 
	}
}

358 
	$nå_Ãt_pf_­p_þ—n
(
nå_pf
 *
pf
)

360 ià(
pf
->
ù¾_vnic
) {

361 
	`nå_Ãt_pf_ä“_vnic
(
pf
,…f->
ù¾_vnic
);

362 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
ù¾_vnic_b¬
);

365 
	`mu‹x_lock
(&
pf
->
lock
);

366 
	`nå_­p_þ—n
(
pf
->
­p
);

367 
	`mu‹x_uÆock
(&
pf
->
lock
);

369 
	`nå_­p_ä“
(
pf
->
­p
);

370 
pf
->
­p
 = 
NULL
;

371 
	}
}

373 
	$nå_Ãt_pf_­p_¡¬t_ù¾
(
nå_pf
 *
pf
)

375 
”r
;

377 ià(!
pf
->
ù¾_vnic
)

379 
”r
 = 
	`nå_Ãt_pf_š™_vnic
(
pf
,…f->
ù¾_vnic
, 0);

380 ià(
”r
)

381  
”r
;

383 
”r
 = 
	`nå_ù¾_Ý’
(
pf
->
ù¾_vnic
);

384 ià(
”r
)

385 
”r_þ—n_ù¾
;

387 
”r
 = 
	`nå_ù¾_debug_¡¬t
(
pf
);

388 ià(
”r
)

389 
”r_þo£_ù¾
;

393 
”r_þo£_ù¾
:

394 
	`nå_ù¾_þo£
(
pf
->
ù¾_vnic
);

395 
”r_þ—n_ù¾
:

396 
	`nå_Ãt_pf_þ—n_vnic
(
pf
,…f->
ù¾_vnic
);

397  
”r
;

398 
	}
}

400 
	$nå_Ãt_pf_­p_¡Ý_ù¾
(
nå_pf
 *
pf
)

402 ià(!
pf
->
ù¾_vnic
)

404 
	`nå_ù¾_debug_¡Ý
(
pf
);

405 
	`nå_ù¾_þo£
(
pf
->
ù¾_vnic
);

406 
	`nå_Ãt_pf_þ—n_vnic
(
pf
,…f->
ù¾_vnic
);

407 
	}
}

409 
	$nå_Ãt_pf_­p_¡¬t
(
nå_pf
 *
pf
)

411 
”r
;

413 
”r
 = 
	`nå_Ãt_pf_­p_¡¬t_ù¾
(
pf
);

414 ià(
”r
)

415  
”r
;

417 
”r
 = 
	`nå_­p_¡¬t
(
pf
->
­p
,…f->
ù¾_vnic
);

418 ià(
”r
)

419 
”r_ù¾_¡Ý
;

421 ià(
pf
->
num_vfs
) {

422 
”r
 = 
	`nå_­p_¤iov_’abË
(
pf
->
­p
,…f->
num_vfs
);

423 ià(
”r
)

424 
”r_­p_¡Ý
;

429 
”r_­p_¡Ý
:

430 
	`nå_­p_¡Ý
(
pf
->
­p
);

431 
”r_ù¾_¡Ý
:

432 
	`nå_Ãt_pf_­p_¡Ý_ù¾
(
pf
);

433  
”r
;

434 
	}
}

436 
	$nå_Ãt_pf_­p_¡Ý
(
nå_pf
 *
pf
)

438 ià(
pf
->
num_vfs
)

439 
	`nå_­p_¤iov_di§bË
(
pf
->
­p
);

440 
	`nå_­p_¡Ý
(
pf
->
­p
);

441 
	`nå_Ãt_pf_­p_¡Ý_ù¾
(
pf
);

442 
	}
}

444 
	$nå_Ãt_pci_unm­_mem
(
nå_pf
 *
pf
)

446 ià(
pf
->
vfcfg_tbl2_¬—
)

447 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
vfcfg_tbl2_¬—
);

448 ià(
pf
->
vf_cfg_b¬
)

449 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
vf_cfg_b¬
);

450 ià(
pf
->
mac_¡©s_b¬
)

451 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
mac_¡©s_b¬
);

452 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
qc_¬—
);

453 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
d©a_vnic_b¬
);

454 
	}
}

456 
	$nå_Ãt_pci_m­_mem
(
nå_pf
 *
pf
)

458 
u32
 
mš_size
, 
ýp_id
;

459 
u8
 
__iomem
 *
mem
;

460 
”r
;

462 
mš_size
 = 
pf
->
max_d©a_vnics
 * 
NFP_PF_CSR_SLICE_SIZE
;

463 
mem
 = 
	`nå_pf_m­_¹sym
(
pf
, "net.bar0", "_pf%d_net_bar0",

464 
mš_size
, &
pf
->
d©a_vnic_b¬
);

465 ià(
	`IS_ERR
(
mem
)) {

466 
	`nå_”r
(
pf
->
ýp
, "Failedo find data vNIC memory symbol\n");

467  
pf
->
fw_lßded
 ? 
	`PTR_ERR
(
mem
) : 1;

470 ià(
pf
->
‘h_tbl
) {

471 
mš_size
 = 
NFP_MAC_STATS_SIZE
 * (
pf
->
‘h_tbl
->
max_šdex
 + 1);

472 
pf
->
mac_¡©s_mem
 = 
	`nå_¹sym_m­
Õf->
¹bl
, "_mac_stats",

473 "Ãt.mac¡©s", 
mš_size
,

474 &
pf
->
mac_¡©s_b¬
);

475 ià(
	`IS_ERR
(
pf
->
mac_¡©s_mem
)) {

476 ià(
	`PTR_ERR
(
pf
->
mac_¡©s_mem
è!ð-
ENOENT
) {

477 
”r
 = 
	`PTR_ERR
(
pf
->
mac_¡©s_mem
);

478 
”r_unm­_ù¾
;

480 
pf
->
mac_¡©s_mem
 = 
NULL
;

484 
pf
->
vf_cfg_mem
 = 
	`nå_pf_m­_¹sym
(pf, "net.vfcfg", "_pf%d_net_vf_bar",

485 
NFP_NET_CFG_BAR_SZ
 * 
pf
->
lim™_vfs
,

486 &
pf
->
vf_cfg_b¬
);

487 ià(
	`IS_ERR
(
pf
->
vf_cfg_mem
)) {

488 ià(
	`PTR_ERR
(
pf
->
vf_cfg_mem
è!ð-
ENOENT
) {

489 
”r
 = 
	`PTR_ERR
(
pf
->
vf_cfg_mem
);

490 
”r_unm­_mac_¡©s
;

492 
pf
->
vf_cfg_mem
 = 
NULL
;

495 
mš_size
 = 
NFP_NET_VF_CFG_SZ
 * 
pf
->
lim™_vfs
 + 
NFP_NET_VF_CFG_MB_SZ
;

496 
pf
->
vfcfg_tbl2
 = 
	`nå_pf_m­_¹sym
(pf, "net.vfcfg_tbl2",

498 
mš_size
, &
pf
->
vfcfg_tbl2_¬—
);

499 ià(
	`IS_ERR
(
pf
->
vfcfg_tbl2
)) {

500 ià(
	`PTR_ERR
(
pf
->
vfcfg_tbl2
è!ð-
ENOENT
) {

501 
”r
 = 
	`PTR_ERR
(
pf
->
vfcfg_tbl2
);

502 
”r_unm­_vf_cfg
;

504 
pf
->
vfcfg_tbl2
 = 
NULL
;

507 
ýp_id
 = 
	`NFP_CPP_ISLAND_ID
(0, 
NFP_CPP_ACTION_RW
, 0, 0);

508 
mem
 = 
	`nå_ýp_m­_¬—
(
pf
->
ýp
, "Ãt.qc", 
ýp_id
,

509 
	`nå_qý_queue_off£t
(
pf
->
dev_šfo
, 0),

510 
pf
->
dev_šfo
->
qc_¬—_sz
, &pf->
qc_¬—
);

511 ià(
	`IS_ERR
(
mem
)) {

512 
	`nå_”r
(
pf
->
ýp
, "Failedo map Queue Controller‡rea.\n");

513 
”r
 = 
	`PTR_ERR
(
mem
);

514 
”r_unm­_vfcfg_tbl2
;

519 
”r_unm­_vfcfg_tbl2
:

520 ià(
pf
->
vfcfg_tbl2_¬—
)

521 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
vfcfg_tbl2_¬—
);

522 
”r_unm­_vf_cfg
:

523 ià(
pf
->
vf_cfg_b¬
)

524 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
vf_cfg_b¬
);

525 
”r_unm­_mac_¡©s
:

526 ià(
pf
->
mac_¡©s_b¬
)

527 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
mac_¡©s_b¬
);

528 
”r_unm­_ù¾
:

529 
	`nå_ýp_¬—_»Ëa£_ä“
(
pf
->
d©a_vnic_b¬
);

530  
”r
;

531 
	}
}

534 
	$nå_Ãt_‘h_pÜt_upd©e
(
nå_ýp
 *
ýp
, 
nå_pÜt
 *
pÜt
,

535 
nå_‘h_bË
 *
‘h_bË
)

537 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

539 
	`ASSERT_RTNL
();

541 
‘h_pÜt
 = 
	`nå_Ãt_fšd_pÜt
(
‘h_bË
, 
pÜt
->
‘h_id
);

542 ià(!
‘h_pÜt
) {

543 
	`£t_b™
(
NFP_PORT_CHANGED
, &
pÜt
->
æags
);

544 
	`nå_w¬n
(
ýp
, "Warning:…ort #%d‚ot…resent‡fter„econfig\n",

545 
pÜt
->
‘h_id
);

546  -
EIO
;

548 ià(
‘h_pÜt
->
ov”ride_chªged
) {

549 
	`nå_w¬n
(
ýp
, "PÜˆ#%d cÚfig chªged, uÄegi¡”šg. Driv”„–ßd„equœed befÜpÜˆwžÈbÝ”©iÚ®‡gaš.\n", 
pÜt
->
‘h_id
);

550 
pÜt
->
ty³
 = 
NFP_PORT_INVALID
;

553 
	`memýy
(
pÜt
->
‘h_pÜt
,ƒth_port, (*eth_port));

556 
	}
}

558 
	$nå_Ãt_»äesh_pÜt_bË_sync
(
nå_pf
 *
pf
)

560 
nå_‘h_bË
 *
‘h_bË
;

561 
nå_Ãt
 *
Â
, *
Ãxt
;

562 
nå_pÜt
 *
pÜt
;

563 
”r
;

565 
	`lockd•_as£¹_h–d
(&
pf
->
lock
);

568 ià(
	`li¡_em±y
(&
pf
->
vnics
))

572 
	`¹Æ_lock
();

573 
	`li¡_fÜ_—ch_’Œy
(
pÜt
, &
pf
->
pÜts
, 
pÜt_li¡
)

574 
	`þ—r_b™
(
NFP_PORT_CHANGED
, &
pÜt
->
æags
);

576 
‘h_bË
 = 
	`nå_‘h_»ad_pÜts
(
pf
->
ýp
);

577 ià(!
‘h_bË
) {

578 
	`li¡_fÜ_—ch_’Œy
(
pÜt
, &
pf
->
pÜts
, 
pÜt_li¡
)

579 ià(
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
))

580 
	`£t_b™
(
NFP_PORT_CHANGED
, &
pÜt
->
æags
);

581 
	`¹Æ_uÆock
();

582 
	`nå_”r
(
pf
->
ýp
, "Error„efreshing…ort config!\n");

583  -
EIO
;

586 
	`li¡_fÜ_—ch_’Œy
(
pÜt
, &
pf
->
pÜts
, 
pÜt_li¡
)

587 ià(
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
))

588 
	`nå_Ãt_‘h_pÜt_upd©e
(
pf
->
ýp
, 
pÜt
, 
‘h_bË
);

589 
	`¹Æ_uÆock
();

591 
	`kä“
(
‘h_bË
);

594 
”r
 = 
	`nå_»´s_»sync_phys_pÜts
(
pf
->
­p
);

595 ià(
”r
)

596  
”r
;

599 
	`li¡_fÜ_—ch_’Œy_§ã
(
Â
, 
Ãxt
, &
pf
->
vnics
, 
vnic_li¡
) {

600 ià(!
Â
->
pÜt
 ||‚n->pÜt->
ty³
 !ð
NFP_PORT_INVALID
)

603 
	`nå_Ãt_pf_þ—n_vnic
(
pf
, 
Â
);

604 
	`nå_Ãt_pf_ä“_vnic
(
pf
, 
Â
);

608 
	}
}

610 
	$nå_Ãt_»äesh_vnics
(
wÜk_¡ruù
 *
wÜk
)

612 
nå_pf
 *
pf
 = 
	`cÚš”_of
(
wÜk
, nfp_pf,

613 
pÜt_»äesh_wÜk
);

615 
	`mu‹x_lock
(&
pf
->
lock
);

616 
	`nå_Ãt_»äesh_pÜt_bË_sync
(
pf
);

617 
	`mu‹x_uÆock
(&
pf
->
lock
);

618 
	}
}

620 
	$nå_Ãt_»äesh_pÜt_bË
(
nå_pÜt
 *
pÜt
)

622 
nå_pf
 *
pf
 = 
pÜt
->
­p
->pf;

624 
	`£t_b™
(
NFP_PORT_CHANGED
, &
pÜt
->
æags
);

626 
	`queue_wÜk
(
pf
->
wq
, &pf->
pÜt_»äesh_wÜk
);

627 
	}
}

629 
	$nå_Ãt_»äesh_‘h_pÜt
(
nå_pÜt
 *
pÜt
)

631 
nå_ýp
 *
ýp
 = 
pÜt
->
­p
->cpp;

632 
nå_‘h_bË
 *
‘h_bË
;

633 
»t
;

635 
	`þ—r_b™
(
NFP_PORT_CHANGED
, &
pÜt
->
æags
);

637 
‘h_bË
 = 
	`nå_‘h_»ad_pÜts
(
ýp
);

638 ià(!
‘h_bË
) {

639 
	`£t_b™
(
NFP_PORT_CHANGED
, &
pÜt
->
æags
);

640 
	`nå_”r
(
ýp
, "Error„efreshing…ort stateable!\n");

641  -
EIO
;

644 
»t
 = 
	`nå_Ãt_‘h_pÜt_upd©e
(
ýp
, 
pÜt
, 
‘h_bË
);

646 
	`kä“
(
‘h_bË
);

648  
»t
;

649 
	}
}

654 
	$nå_Ãt_pci_´obe
(
nå_pf
 *
pf
)

656 
devlšk
 *devlšk = 
	`´iv_to_devlšk
(
pf
);

657 
nå_Ãt_fw_v”siÚ
 
fw_v”
;

658 
u8
 
__iomem
 *
ù¾_b¬
, *
qc_b¬
;

659 
¡ride
;

660 
”r
;

662 
	`INIT_WORK
(&
pf
->
pÜt_»äesh_wÜk
, 
nå_Ãt_»äesh_vnics
);

664 ià(!
pf
->
¹bl
) {

665 
	`nå_”r
(
pf
->
ýp
, "No %s, giving up.\n",

666 
pf
->
fw_lßded
 ? "symbolable" : "firmware found");

670 
pf
->
max_d©a_vnics
 = 
	`nå_Ãt_pf_g‘_num_pÜts
(pf);

671 ià(()
pf
->
max_d©a_vnics
 < 0)

672  
pf
->
max_d©a_vnics
;

674 
”r
 = 
	`nå_Ãt_pci_m­_mem
(
pf
);

675 ià(
”r
)

676  
”r
;

678 
ù¾_b¬
 = 
	`nå_ýp_¬—_iomem
(
pf
->
d©a_vnic_b¬
);

679 
qc_b¬
 = 
	`nå_ýp_¬—_iomem
(
pf
->
qc_¬—
);

680 ià(!
ù¾_b¬
 || !
qc_b¬
) {

681 
”r
 = -
EIO
;

682 
”r_unm­
;

685 
	`nå_Ãt_g‘_fw_v”siÚ
(&
fw_v”
, 
ù¾_b¬
);

686 ià(
fw_v”
.
dp_»sv
 & 
NFP_NET_CFG_VERSION_RESERVED_MASK
 ||

687 
fw_v”
.
þass
 !ð
NFP_NET_CFG_VERSION_CLASS_GENERIC
) {

688 
	`nå_”r
(
pf
->
ýp
, "Unknown Firmware ABI %d.%d.%d.%d\n",

689 
fw_v”
.
dp_»sv
, fw_v”.
þass
,

690 
fw_v”
.
majÜ
, fw_v”.
mšÜ
);

691 
”r
 = -
EINVAL
;

692 
”r_unm­
;

696 ià(
	`nå_Ãt_fw_v”_eq
(&
fw_v”
, 0, 0, 0, 1)) {

697 
¡ride
 = 2;

698 
	`nå_w¬n
(
pf
->
ýp
, "OBSOLETE Firmware detected - VF isolation‚ot‡vailable\n");

700 
fw_v”
.
majÜ
) {

702 
¡ride
 = 4;

705 
	`nå_”r
(
pf
->
ýp
, "Unsupported Firmware ABI %d.%d.%d.%d\n",

706 
fw_v”
.
dp_»sv
, fw_v”.
þass
,

707 
fw_v”
.
majÜ
, fw_v”.
mšÜ
);

708 
”r
 = -
EINVAL
;

709 
”r_unm­
;

713 
”r
 = 
	`nå_Ãt_pf_­p_š™
(
pf
, 
qc_b¬
, 
¡ride
);

714 ià(
”r
)

715 
”r_unm­
;

717 
”r
 = 
	`devlšk_»gi¡”
(
devlšk
, &
pf
->
pdev
->
dev
);

718 ià(
”r
)

719 
”r_­p_þ—n
;

721 
”r
 = 
	`nå_sh¬ed_buf_»gi¡”
(
pf
);

722 ià(
”r
)

723 
”r_devlšk_uÄeg
;

725 
	`mu‹x_lock
(&
pf
->
lock
);

726 
pf
->
ddœ
 = 
	`nå_Ãt_debugfs_deviû_add
Õf->
pdev
);

729 
”r
 = 
	`nå_Ãt_pf_®loc_vnics
(
pf
, 
ù¾_b¬
, 
qc_b¬
, 
¡ride
);

730 ià(
”r
)

731 
”r_þ—n_ddœ
;

733 
”r
 = 
	`nå_Ãt_pf_®loc_œqs
(
pf
);

734 ià(
”r
)

735 
”r_ä“_vnics
;

737 
”r
 = 
	`nå_Ãt_pf_­p_¡¬t
(
pf
);

738 ià(
”r
)

739 
”r_ä“_œqs
;

741 
”r
 = 
	`nå_Ãt_pf_š™_vnics
(
pf
);

742 ià(
”r
)

743 
”r_¡Ý_­p
;

745 
	`mu‹x_uÆock
(&
pf
->
lock
);

749 
”r_¡Ý_­p
:

750 
	`nå_Ãt_pf_­p_¡Ý
(
pf
);

751 
”r_ä“_œqs
:

752 
	`nå_Ãt_pf_ä“_œqs
(
pf
);

753 
”r_ä“_vnics
:

754 
	`nå_Ãt_pf_ä“_vnics
(
pf
);

755 
”r_þ—n_ddœ
:

756 
	`nå_Ãt_debugfs_dœ_þ—n
(&
pf
->
ddœ
);

757 
	`mu‹x_uÆock
(&
pf
->
lock
);

758 
	`nå_sh¬ed_buf_uÄegi¡”
(
pf
);

759 
”r_devlšk_uÄeg
:

760 
	`ÿnûl_wÜk_sync
(&
pf
->
pÜt_»äesh_wÜk
);

761 
	`devlšk_uÄegi¡”
(
devlšk
);

762 
”r_­p_þ—n
:

763 
	`nå_Ãt_pf_­p_þ—n
(
pf
);

764 
”r_unm­
:

765 
	`nå_Ãt_pci_unm­_mem
(
pf
);

766  
”r
;

767 
	}
}

769 
	$nå_Ãt_pci_»move
(
nå_pf
 *
pf
)

771 
nå_Ãt
 *
Â
, *
Ãxt
;

773 
	`mu‹x_lock
(&
pf
->
lock
);

774 
	`li¡_fÜ_—ch_’Œy_§ã
(
Â
, 
Ãxt
, &
pf
->
vnics
, 
vnic_li¡
) {

775 ià(!
	`nå_Ãt_is_d©a_vnic
(
Â
))

777 
	`nå_Ãt_pf_þ—n_vnic
(
pf
, 
Â
);

778 
	`nå_Ãt_pf_ä“_vnic
(
pf
, 
Â
);

781 
	`nå_Ãt_pf_­p_¡Ý
(
pf
);

783 
	`nå_Ãt_debugfs_dœ_þ—n
(&
pf
->
ddœ
);

785 
	`mu‹x_uÆock
(&
pf
->
lock
);

787 
	`nå_sh¬ed_buf_uÄegi¡”
(
pf
);

788 
	`devlšk_uÄegi¡”
(
	`´iv_to_devlšk
(
pf
));

790 
	`nå_Ãt_pf_ä“_œqs
(
pf
);

791 
	`nå_Ãt_pf_­p_þ—n
(
pf
);

792 
	`nå_Ãt_pci_unm­_mem
(
pf
);

794 
	`ÿnûl_wÜk_sync
(&
pf
->
pÜt_»äesh_wÜk
);

795 
	}
}

	@src/nfp_net_repr.c

4 
	~"nåcÜe/kcom·t.h
"

6 
	~<lšux/‘h”deviû.h
>

7 
	~<lšux/io-64-nÚ©omic-hi-lo.h
>

8 
	~<lšux/lockd•.h
>

9 
	~<Ãt/d¡_m‘ad©a.h
>

11 
	~"nåcÜe/nå_ýp.h
"

12 
	~"nåcÜe/nå_n¥.h
"

13 
	~"nå_­p.h
"

14 
	~"nå_maš.h
"

15 
	~"nå_Ãt.h
"

16 
	~"nå_Ãt_ù¾.h
"

17 
	~"nå_Ãt_»´.h
"

18 
	~"nå_Ãt_¤iov.h
"

19 
	~"nå_pÜt.h
"

21 
Ãt_deviû
 *

22 
	$nå_»´_g‘_locked
(
nå_­p
 *
­p
, 
nå_»´s
 *
£t
, 
id
)

24  
	`rcu_d”eã»nû_´Ùeùed
(
£t
->
»´s
[
id
],

25 
	`lockd•_is_h–d
(&
­p
->
pf
->
lock
));

26 
	}
}

29 
	$nå_»´_šc_tx_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
Ën
,

30 
tx_¡©us
)

32 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

33 
nå_»´_pýu_¡©s
 *
¡©s
;

35 ià(
	`uÆik–y
(
tx_¡©us
 !ð
NET_XMIT_SUCCESS
 &&

36 
tx_¡©us
 !ð
NET_XMIT_CN
)) {

37 
	`this_ýu_šc
(
»´
->
¡©s
->
tx_drÝs
);

41 
¡©s
 = 
	`this_ýu_±r
(
»´
->stats);

42 
	`u64_¡©s_upd©e_begš
(&
¡©s
->
syný
);

43 
¡©s
->
tx_·ck‘s
++;

44 
¡©s
->
tx_by‹s
 +ð
Ën
;

45 
	`u64_¡©s_upd©e_’d
(&
¡©s
->
syný
);

46 
	}
}

48 
	$nå_»´_šc_rx_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
Ën
)

50 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

51 
nå_»´_pýu_¡©s
 *
¡©s
;

53 
¡©s
 = 
	`this_ýu_±r
(
»´
->stats);

54 
	`u64_¡©s_upd©e_begš
(&
¡©s
->
syný
);

55 
¡©s
->
rx_·ck‘s
++;

56 
¡©s
->
rx_by‹s
 +ð
Ën
;

57 
	`u64_¡©s_upd©e_’d
(&
¡©s
->
syný
);

58 
	}
}

61 
	$nå_»´_phy_pÜt_g‘_¡©s64
(
nå_pÜt
 *
pÜt
,

62 
¹Æ_lšk_¡©s64
 *
¡©s
)

64 
u8
 
__iomem
 *
mem
 = 
pÜt
->
‘h_¡©s
;

66 
¡©s
->
tx_·ck‘s
 = 
	`»adq
(
mem
 + 
NFP_MAC_STATS_TX_FRAMES_TRANSMITTED_OK
);

67 
¡©s
->
tx_by‹s
 = 
	`»adq
(
mem
 + 
NFP_MAC_STATS_TX_OUT_OCTETS
);

68 
¡©s
->
tx_drÝ³d
 = 
	`»adq
(
mem
 + 
NFP_MAC_STATS_TX_OUT_ERRORS
);

70 
¡©s
->
rx_·ck‘s
 = 
	`»adq
(
mem
 + 
NFP_MAC_STATS_RX_FRAMES_RECEIVED_OK
);

71 
¡©s
->
rx_by‹s
 = 
	`»adq
(
mem
 + 
NFP_MAC_STATS_RX_IN_OCTETS
);

72 
¡©s
->
rx_drÝ³d
 = 
	`»adq
(
mem
 + 
NFP_MAC_STATS_RX_IN_ERRORS
);

73 
	}
}

76 
	$nå_»´_vnic_g‘_¡©s64
(
nå_pÜt
 *
pÜt
,

77 
¹Æ_lšk_¡©s64
 *
¡©s
)

82 
¡©s
->
tx_·ck‘s
 = 
	`»adq
(
pÜt
->
vnic
 + 
NFP_NET_CFG_STATS_RX_FRAMES
);

83 
¡©s
->
tx_by‹s
 = 
	`»adq
(
pÜt
->
vnic
 + 
NFP_NET_CFG_STATS_RX_OCTETS
);

84 
¡©s
->
tx_drÝ³d
 = 
	`»adq
(
pÜt
->
vnic
 + 
NFP_NET_CFG_STATS_RX_DISCARDS
);

86 
¡©s
->
rx_·ck‘s
 = 
	`»adq
(
pÜt
->
vnic
 + 
NFP_NET_CFG_STATS_TX_FRAMES
);

87 
¡©s
->
rx_by‹s
 = 
	`»adq
(
pÜt
->
vnic
 + 
NFP_NET_CFG_STATS_TX_OCTETS
);

88 
¡©s
->
rx_drÝ³d
 = 
	`»adq
(
pÜt
->
vnic
 + 
NFP_NET_CFG_STATS_TX_DISCARDS
);

89 
	}
}

91 
com·t__¡©64_»t_t


92 
	$nå_»´_g‘_¡©s64
(
Ãt_deviû
 *
Ãtdev
, 
¹Æ_lšk_¡©s64
 *
¡©s
)

94 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

96 ià(
	`WARN_ON
(!
»´
->
pÜt
))

97 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 11, 0)

98  
¡©s
;

103 
»´
->
pÜt
->
ty³
) {

104 
NFP_PORT_PHYS_PORT
:

105 ià(!
	`__nå_pÜt_g‘_‘h_pÜt
(
»´
->
pÜt
))

107 
	`nå_»´_phy_pÜt_g‘_¡©s64
(
»´
->
pÜt
, 
¡©s
);

109 
NFP_PORT_PF_PORT
:

110 
NFP_PORT_VF_PORT
:

111 
	`nå_»´_vnic_g‘_¡©s64
(
»´
->
pÜt
, 
¡©s
);

116 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 11, 0)

117  
¡©s
;

119 
	}
}

121 
boÞ


122 
	$nå_»´_has_ofæßd_¡©s
(cÚ¡ 
Ãt_deviû
 *
dev
, 
©Œ_id
)

124 
©Œ_id
) {

125 
IFLA_OFFLOAD_XSTATS_CPU_HIT
:

126  
Œue
;

129  
çl£
;

130 
	}
}

133 
	$nå_»´_g‘_ho¡_¡©s64
(cÚ¡ 
Ãt_deviû
 *
Ãtdev
,

134 
¹Æ_lšk_¡©s64
 *
¡©s
)

136 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

137 
i
;

139 
	`fÜ_—ch_possibË_ýu
(
i
) {

140 
u64
 
tby‹s
, 
kts
, 
tdrÝs
, 
rby‹s
, 
½kts
;

141 
nå_»´_pýu_¡©s
 *
»´_¡©s
;

142 
¡¬t
;

144 
»´_¡©s
 = 
	`³r_ýu_±r
(
»´
->
¡©s
, 
i
);

146 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&
»´_¡©s
->
syný
);

147 
tby‹s
 = 
»´_¡©s
->
tx_by‹s
;

148 
kts
 = 
»´_¡©s
->
tx_·ck‘s
;

149 
tdrÝs
 = 
»´_¡©s
->
tx_drÝs
;

150 
rby‹s
 = 
»´_¡©s
->
rx_by‹s
;

151 
½kts
 = 
»´_¡©s
->
rx_·ck‘s
;

152 } 
	`u64_¡©s_ãtch_»Œy_œq
(&
»´_¡©s
->
syný
, 
¡¬t
));

154 
¡©s
->
tx_by‹s
 +ð
tby‹s
;

155 
¡©s
->
tx_·ck‘s
 +ð
kts
;

156 
¡©s
->
tx_drÝ³d
 +ð
tdrÝs
;

157 
¡©s
->
rx_by‹s
 +ð
rby‹s
;

158 
¡©s
->
rx_·ck‘s
 +ð
½kts
;

162 
	}
}

165 
	$nå_»´_g‘_ofæßd_¡©s
(
©Œ_id
, cÚ¡ 
Ãt_deviû
 *
dev
,

166 *
¡©s
)

168 
©Œ_id
) {

169 
IFLA_OFFLOAD_XSTATS_CPU_HIT
:

170  
	`nå_»´_g‘_ho¡_¡©s64
(
dev
, 
¡©s
);

173  -
EINVAL
;

174 
	}
}

176 
	$nå_»´_chªge_mtu
(
Ãt_deviû
 *
Ãtdev
, 
Ãw_mtu
)

178 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

179 
”r
;

181 
”r
 = 
	`nå_­p_check_mtu
(
»´
->
­p
, 
Ãtdev
, 
Ãw_mtu
);

182 ià(
”r
)

183  
”r
;

185 
”r
 = 
	`nå_­p_»´_chªge_mtu
(
»´
->
­p
, 
Ãtdev
, 
Ãw_mtu
);

186 ià(
”r
)

187  
”r
;

189 
Ãtdev
->
mtu
 = 
Ãw_mtu
;

192 
	}
}

194 
Ãtdev_tx_t
 
	$nå_»´_xm™
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
)

196 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

197 
Ën
 = 
skb
->len;

198 
»t
;

200 
	`skb_d¡_drÝ
(
skb
);

201 
	`d¡_hÞd
((
d¡_’Œy
 *)
»´
->
d¡
);

202 
	`skb_d¡_£t
(
skb
, (
d¡_’Œy
 *)
»´
->
d¡
);

203 
skb
->
dev
 = 
»´
->
d¡
->
u
.
pÜt_šfo
.
low”_dev
;

205 
»t
 = 
	`dev_queue_xm™
(
skb
);

206 
	`nå_»´_šc_tx_¡©s
(
Ãtdev
, 
Ën
, 
»t
);

208  
NETDEV_TX_OK
;

209 
	}
}

211 
	$nå_»´_¡Ý
(
Ãt_deviû
 *
Ãtdev
)

213 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

214 
”r
;

216 
”r
 = 
	`nå_­p_»´_¡Ý
(
»´
->
­p
,„epr);

217 ià(
”r
)

218  
”r
;

220 
	`nå_pÜt_cÚfigu»
(
Ãtdev
, 
çl£
);

222 
	}
}

224 
	$nå_»´_Ý’
(
Ãt_deviû
 *
Ãtdev
)

226 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

227 
”r
;

229 
”r
 = 
	`nå_pÜt_cÚfigu»
(
Ãtdev
, 
Œue
);

230 ià(
”r
)

231  
”r
;

233 
”r
 = 
	`nå_­p_»´_Ý’
(
»´
->
­p
,„epr);

234 ià(
”r
)

235 
”r_pÜt_di§bË
;

239 
”r_pÜt_di§bË
:

240 
	`nå_pÜt_cÚfigu»
(
Ãtdev
, 
çl£
);

241  
”r
;

242 
	}
}

244 
Ãtdev_ã©u»s_t


245 
	$nå_»´_fix_ã©u»s
(
Ãt_deviû
 *
Ãtdev
, 
Ãtdev_ã©u»s_t
 
ã©u»s
)

247 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

248 
Ãtdev_ã©u»s_t
 
Þd_ã©u»s
 = 
ã©u»s
;

249 
Ãtdev_ã©u»s_t
 
low”_ã©u»s
;

250 
Ãt_deviû
 *
low”_dev
;

252 
low”_dev
 = 
»´
->
d¡
->
u
.
pÜt_šfo
.lower_dev;

254 
low”_ã©u»s
 = 
low”_dev
->
ã©u»s
;

255 ià(
low”_ã©u»s
 & (
NETIF_F_IP_CSUM
 | 
NETIF_F_IPV6_CSUM
))

256 
low”_ã©u»s
 |ð
NETIF_F_HW_CSUM
;

258 
ã©u»s
 = 
	`Ãtdev_š‹r£ù_ã©u»s
(ã©u»s, 
low”_ã©u»s
);

259 
ã©u»s
 |ð
Þd_ã©u»s
 & (
NETIF_F_SOFT_FEATURES
 | 
NETIF_F_HW_TC
);

260 
ã©u»s
 |ð
NETIF_F_LLTX
;

262  
ã©u»s
;

263 
	}
}

265 cÚ¡ 
Ãt_deviû_Ýs
 
	gnå_»´_Ãtdev_Ýs
 = {

266 .
ndo_š™
 = 
nå_­p_ndo_š™
,

267 .
	gndo_unš™
 = 
nå_­p_ndo_unš™
,

268 .
	gndo_Ý’
 = 
nå_»´_Ý’
,

269 .
	gndo_¡Ý
 = 
nå_»´_¡Ý
,

270 .
	gndo_¡¬t_xm™
 = 
nå_»´_xm™
,

271 .
	gndo_chªge_mtu
 = 
nå_»´_chªge_mtu
,

272 .
	gndo_g‘_¡©s64
 = 
nå_»´_g‘_¡©s64
,

273 .
	gndo_has_ofæßd_¡©s
 = 
nå_»´_has_ofæßd_¡©s
,

274 .
	gndo_g‘_ofæßd_¡©s
 = 
nå_»´_g‘_ofæßd_¡©s
,

275 .
	gndo_g‘_phys_pÜt_Çme
 = 
nå_pÜt_g‘_phys_pÜt_Çme
,

276 .
	gndo_£tup_tc
 = 
nå_pÜt_£tup_tc
,

277 .
	gndo_£t_vf_mac
 = 
nå_­p_£t_vf_mac
,

278 .
	gndo_£t_vf_vÏn
 = 
nå_­p_£t_vf_vÏn
,

279 .
	gndo_£t_vf_¥oofchk
 = 
nå_­p_£t_vf_¥oofchk
,

280 .
	gndo_g‘_vf_cÚfig
 = 
nå_­p_g‘_vf_cÚfig
,

281 .
	gndo_£t_vf_lšk_¡©e
 = 
nå_­p_£t_vf_lšk_¡©e
,

282 .
	gndo_fix_ã©u»s
 = 
nå_»´_fix_ã©u»s
,

283 .
	gndo_£t_ã©u»s
 = 
nå_pÜt_£t_ã©u»s
,

284 .
	gndo_£t_mac_add»ss
 = 
‘h_mac_addr
,

285 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(5, 1, 0)

286 .
	gndo_g‘_pÜt_·»Á_id
 = 
nå_pÜt_g‘_pÜt_·»Á_id
,

287 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 2, 0)

288 .
	gndo_g‘_devlšk
 = 
nå_devlšk_g‘_devlšk
,

290 .
	gndo_g‘_devlšk_pÜt
 = 
nå_devlšk_g‘_devlšk_pÜt
,

296 
	$nå_»´_Œªsãr_ã©u»s
(
Ãt_deviû
 *
Ãtdev
, Ãt_deviû *
low”
)

298 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

300 ià(
»´
->
d¡
->
u
.
pÜt_šfo
.
low”_dev
 !ð
low”
)

303 
Ãtdev
->
gso_max_size
 = 
low”
->gso_max_size;

304 
Ãtdev
->
gso_max_£gs
 = 
low”
->gso_max_segs;

306 
	`Ãtdev_upd©e_ã©u»s
(
Ãtdev
);

307 
	}
}

309 
	$nå_»´_þ—n
(
nå_»´
 *
»´
)

311 
	`uÄegi¡”_Ãtdev
(
»´
->
Ãtdev
);

312 
	`nå_­p_»´_þ—n
(
»´
->
­p
,„•r->
Ãtdev
);

313 
	`d¡_»Ëa£
((
d¡_’Œy
 *)
»´
->
d¡
);

314 
	`nå_pÜt_ä“
(
»´
->
pÜt
);

315 
	}
}

317 
lock_þass_key
 
	gnå_»´_Ãtdev_xm™_lock_key
;

318 
lock_þass_key
 
	gnå_»´_Ãtdev_addr_lock_key
;

320 
	$nå_»´_£t_lockd•_þass_Úe
(
Ãt_deviû
 *
dev
,

321 
Ãtdev_queue
 *
txq
,

322 *
_unu£d
)

324 
	`lockd•_£t_þass
(&
txq
->
_xm™_lock
, &
nå_»´_Ãtdev_xm™_lock_key
);

325 
	}
}

327 
	$nå_»´_£t_lockd•_þass
(
Ãt_deviû
 *
dev
)

329 
	`lockd•_£t_þass
(&
dev
->
addr_li¡_lock
, &
nå_»´_Ãtdev_addr_lock_key
);

330 
	`Ãtdev_fÜ_—ch_tx_queue
(
dev
, 
nå_»´_£t_lockd•_þass_Úe
, 
NULL
);

331 
	}
}

333 
	$nå_»´_š™
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

334 
u32
 
cmsg_pÜt_id
, 
nå_pÜt
 *
pÜt
,

335 
Ãt_deviû
 *
pf_Ãtdev
)

337 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

338 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
pf_Ãtdev
);

339 
u32
 
»´_ÿp
 = 
Â
->
Žv_ÿps
.repr_cap;

340 
”r
;

342 
	`nå_»´_£t_lockd•_þass
(
Ãtdev
);

344 
»´
->
pÜt
 =…ort;

345 
»´
->
d¡
 = 
	`m‘ad©a_d¡_®loc
(0, 
METADATA_HW_PORT_MUX
, 
GFP_KERNEL
);

346 ià(!
»´
->
d¡
)

347  -
ENOMEM
;

348 
»´
->
d¡
->
u
.
pÜt_šfo
.
pÜt_id
 = 
cmsg_pÜt_id
;

349 
»´
->
d¡
->
u
.
pÜt_šfo
.
low”_dev
 = 
pf_Ãtdev
;

351 
Ãtdev
->
Ãtdev_Ýs
 = &
nå_»´_Ãtdev_Ýs
;

352 
Ãtdev
->
‘htoÞ_Ýs
 = &
nå_pÜt_‘htoÞ_Ýs
;

354 
Ãtdev
->
max_mtu
 = 
pf_Ãtdev
->max_mtu;

356 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(5, 1, 0)

357 
	`SWITCHDEV_SET_OPS
(
Ãtdev
, &
nå_pÜt_sw™chdev_Ýs
);

360 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_LIVE_ADDR
)

361 
Ãtdev
->
´iv_æags
 |ð
IFF_LIVE_ADDR_CHANGE
;

363 
Ãtdev
->
hw_ã©u»s
 = 
NETIF_F_HIGHDMA
;

364 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_RXCSUM_ANY
)

365 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_RXCSUM
;

366 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_TXCSUM
)

367 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_IP_CSUM
 | 
NETIF_F_IPV6_CSUM
;

368 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_GATHER
)

369 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_SG
;

370 ià((
»´_ÿp
 & 
NFP_NET_CFG_CTRL_LSO
 && 
Â
->
fw_v”
.
majÜ
 > 2) ||

371 
»´_ÿp
 & 
NFP_NET_CFG_CTRL_LSO2
)

372 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_TSO
 | 
NETIF_F_TSO6
;

373 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_RSS_ANY
)

374 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_RXHASH
;

375 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_VXLAN
) {

376 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_LSO
)

377 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_GSO_UDP_TUNNEL
;

379 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_NVGRE
) {

380 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_LSO
)

381 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_GSO_GRE
;

383 ià(
»´_ÿp
 & (
NFP_NET_CFG_CTRL_VXLAN
 | 
NFP_NET_CFG_CTRL_NVGRE
))

384 
Ãtdev
->
hw_’c_ã©u»s
 =‚‘dev->
hw_ã©u»s
;

386 
Ãtdev
->
vÏn_ã©u»s
 =‚‘dev->
hw_ã©u»s
;

388 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_RXVLAN
)

389 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_VLAN_CTAG_RX
;

390 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_TXVLAN
) {

391 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_LSO2
)

392 
	`Ãtdev_w¬n
(
Ãtdev
, "Device‡dvertises both TSO2‡nd TXVLAN. Refusingoƒnable TXVLAN.\n");

394 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_VLAN_CTAG_TX
;

396 ià(
»´_ÿp
 & 
NFP_NET_CFG_CTRL_CTAG_FILTER
)

397 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_VLAN_CTAG_FILTER
;

399 
Ãtdev
->
ã©u»s
 =‚‘dev->
hw_ã©u»s
;

402 
Ãtdev
->
ã©u»s
 &ð~(
NETIF_F_TSO
 | 
NETIF_F_TSO6
);

403 
Ãtdev
->
gso_max_£gs
 = 
NFP_NET_LSO_MAX_SEGS
;

405 
Ãtdev
->
´iv_æags
 |ð
IFF_NO_QUEUE
 | 
IFF_DISABLE_NETPOLL
;

406 
Ãtdev
->
ã©u»s
 |ð
NETIF_F_LLTX
;

408 ià(
	`nå_­p_has_tc
(
­p
)) {

409 
Ãtdev
->
ã©u»s
 |ð
NETIF_F_HW_TC
;

410 
Ãtdev
->
hw_ã©u»s
 |ð
NETIF_F_HW_TC
;

413 
”r
 = 
	`nå_­p_»´_š™
(
­p
, 
Ãtdev
);

414 ià(
”r
)

415 
”r_þ—n
;

417 
”r
 = 
	`»gi¡”_Ãtdev
(
Ãtdev
);

418 ià(
”r
)

419 
”r_»´_þ—n
;

423 
”r_»´_þ—n
:

424 
	`nå_­p_»´_þ—n
(
­p
, 
Ãtdev
);

425 
”r_þ—n
:

426 
	`d¡_»Ëa£
((
d¡_’Œy
 *)
»´
->
d¡
);

427  
”r
;

428 
	}
}

430 
	$__nå_»´_ä“
(
nå_»´
 *
»´
)

432 
	`ä“_³rýu
(
»´
->
¡©s
);

433 
	`ä“_Ãtdev
(
»´
->
Ãtdev
);

434 
	}
}

436 
	$nå_»´_ä“
(
Ãt_deviû
 *
Ãtdev
)

438 
	`__nå_»´_ä“
(
	`Ãtdev_´iv
(
Ãtdev
));

439 
	}
}

441 
Ãt_deviû
 *

442 
	$nå_»´_®loc_mqs
(
nå_­p
 *
­p
, 
txqs
, 
rxqs
)

444 
Ãt_deviû
 *
Ãtdev
;

445 
nå_»´
 *
»´
;

447 
Ãtdev
 = 
	`®loc_‘h”dev_mqs
((*
»´
), 
txqs
, 
rxqs
);

448 ià(!
Ãtdev
)

449  
NULL
;

451 
	`Ãtif_ÿ¼›r_off
(
Ãtdev
);

453 
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

454 
»´
->
Ãtdev
 =‚etdev;

455 
»´
->
­p
 =‡pp;

457 
»´
->
¡©s
 = 
	`Ãtdev_®loc_pýu_¡©s
(
nå_»´_pýu_¡©s
);

458 ià(!
»´
->
¡©s
)

459 
”r_ä“_Ãtdev
;

461  
Ãtdev
;

463 
”r_ä“_Ãtdev
:

464 
	`ä“_Ãtdev
(
Ãtdev
);

465  
NULL
;

466 
	}
}

468 
	$nå_»´_þ—n_ªd_ä“
(
nå_»´
 *
»´
)

470 
	`nå_šfo
(
»´
->
­p
->
ýp
, "Destroying Representor(%s)\n",

471 
»´
->
Ãtdev
->
Çme
);

472 
	`nå_»´_þ—n
(
»´
);

473 
	`__nå_»´_ä“
(
»´
);

474 
	}
}

476 
	$nå_»´s_þ—n_ªd_ä“
(
nå_­p
 *
­p
, 
nå_»´s
 *
»´s
)

478 
Ãt_deviû
 *
Ãtdev
;

479 
i
;

481 
i
 = 0; i < 
»´s
->
num_»´s
; i++) {

482 
Ãtdev
 = 
	`nå_»´_g‘_locked
(
­p
, 
»´s
, 
i
);

483 ià(
Ãtdev
)

484 
	`nå_»´_þ—n_ªd_ä“
(
	`Ãtdev_´iv
(
Ãtdev
));

487 
	`kä“
(
»´s
);

488 
	}
}

491 
	$nå_»´s_þ—n_ªd_ä“_by_ty³
(
nå_­p
 *
­p
, 
nå_»´_ty³
 
ty³
)

493 
Ãt_deviû
 *
Ãtdev
;

494 
nå_»´s
 *
»´s
;

495 
i
;

497 
»´s
 = 
	`rcu_d”eã»nû_´Ùeùed
(
­p
->»´s[
ty³
],

498 
	`lockd•_is_h–d
(&
­p
->
pf
->
lock
));

499 ià(!
»´s
)

505 
i
 = 0; i < 
»´s
->
num_»´s
; i++) {

506 
Ãtdev
 = 
	`nå_»´_g‘_locked
(
­p
, 
»´s
, 
i
);

507 ià(
Ãtdev
)

508 
	`nå_­p_»´_´eþ—n
(
­p
, 
Ãtdev
);

511 
»´s
 = 
	`nå_­p_»´s_£t
(
­p
, 
ty³
, 
NULL
);

513 
	`synchrÚize_rcu
();

514 
	`nå_»´s_þ—n_ªd_ä“
(
­p
, 
»´s
);

515 
	}
}

517 
nå_»´s
 *
	$nå_»´s_®loc
(
num_»´s
)

519 
nå_»´s
 *
»´s
;

521 
»´s
 = 
	`kz®loc
((*reprs) +

522 
num_»´s
 * (
Ãt_deviû
 *), 
GFP_KERNEL
);

523 ià(!
»´s
)

524  
NULL
;

525 
»´s
->
num_»´s
 =‚um_reprs;

527  
»´s
;

528 
	}
}

530 
	$nå_»´s_»sync_phys_pÜts
(
nå_­p
 *
­p
)

532 
Ãt_deviû
 *
Ãtdev
;

533 
nå_»´s
 *
»´s
;

534 
nå_»´
 *
»´
;

535 
i
;

537 
»´s
 = 
	`nå_»´s_g‘_locked
(
­p
, 
NFP_REPR_TYPE_PHYS_PORT
);

538 ià(!
»´s
)

541 
i
 = 0; i < 
»´s
->
num_»´s
; i++) {

542 
Ãtdev
 = 
	`nå_»´_g‘_locked
(
­p
, 
»´s
, 
i
);

543 ià(!
Ãtdev
)

546 
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

547 ià(
»´
->
pÜt
->
ty³
 !ð
NFP_PORT_INVALID
)

550 
	`nå_­p_»´_´eþ—n
(
­p
, 
Ãtdev
);

551 
	`¹Æ_lock
();

552 
	`rcu_assign_poš‹r
(
»´s
->»´s[
i
], 
NULL
);

553 
	`¹Æ_uÆock
();

554 
	`synchrÚize_rcu
();

555 
	`nå_»´_þ—n
(
»´
);

559 
	}
}

	@src/nfp_net_repr.h

4 #iâdeà
NFP_NET_REPR_H


5 
	#NFP_NET_REPR_H


	)

7 
	~"nå_Ãt_com·t.h
"

9 
	gm‘ad©a_d¡
;

10 
	gnå_­p
;

11 
	gnå_Ãt
;

12 
	gnå_pÜt
;

14 #ifdeà
COMPAT__HAVE_METADATA_IP_TUNNEL


15 
	~<Ãt/d¡_m‘ad©a.h
>

23 
	snå_»´s
 {

24 
	mnum_»´s
;

25 
Ãt_deviû
 
__rcu
 *
	m»´s
[0];

37 
	snå_»´_pýu_¡©s
 {

38 
u64
 
	mrx_·ck‘s
;

39 
u64
 
	mrx_by‹s
;

40 
u64
 
	mtx_·ck‘s
;

41 
u64
 
	mtx_by‹s
;

42 
u64
 
	mtx_drÝs
;

43 
u64_¡©s_sync
 
	msyný
;

55 
	snå_»´
 {

56 
Ãt_deviû
 *
	mÃtdev
;

57 
m‘ad©a_d¡
 *
	md¡
;

58 
nå_pÜt
 *
	mpÜt
;

59 
nå_­p
 *
	m­p
;

60 
nå_»´_pýu_¡©s
 
__³rýu
 *
	m¡©s
;

61 *
	m­p_´iv
;

71 
	enå_»´_ty³
 {

72 
	mNFP_REPR_TYPE_PHYS_PORT
,

73 
	mNFP_REPR_TYPE_PF
,

74 
	mNFP_REPR_TYPE_VF
,

76 
	m__NFP_REPR_TYPE_MAX
,

78 
	#NFP_REPR_TYPE_MAX
 (
__NFP_REPR_TYPE_MAX
 - 1)

	)

80 cÚ¡ 
Ãt_deviû_Ýs
 
nå_»´_Ãtdev_Ýs
;

82 #ifdeà
COMPAT__HAVE_METADATA_IP_TUNNEL


83 
šlše
 
boÞ
 
	$nå_Ãtdev_is_nå_»´
(
Ãt_deviû
 *
Ãtdev
)

85  
Ãtdev
->
Ãtdev_Ýs
 =ð&
nå_»´_Ãtdev_Ýs
;

86 
	}
}

88 
šlše
 
	$nå_»´_g‘_pÜt_id
(
Ãt_deviû
 *
Ãtdev
)

90 
nå_»´
 *
´iv
 = 
	`Ãtdev_´iv
(
Ãtdev
);

92  
´iv
->
d¡
->
u
.
pÜt_šfo
.
pÜt_id
;

93 
	}
}

95 
Ãt_deviû
 *

96 
nå_»´_g‘_locked
(
nå_­p
 *
­p
, 
nå_»´s
 *
£t
,

97 
id
);

99 
nå_»´_šc_rx_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
Ën
);

101 
nå_»´_Œªsãr_ã©u»s
(
Ãt_deviû
 *
Ãtdev
, Ãt_deviû *
low”
);

102 
nå_»´_š™
(
nå_­p
 *
­p
, 
Ãt_deviû
 *
Ãtdev
,

103 
u32
 
cmsg_pÜt_id
, 
nå_pÜt
 *
pÜt
,

104 
Ãt_deviû
 *
pf_Ãtdev
);

105 
nå_»´_ä“
(
Ãt_deviû
 *
Ãtdev
);

106 
Ãt_deviû
 *

107 
nå_»´_®loc_mqs
(
nå_­p
 *
­p
, 
txqs
, 
rxqs
);

108 
nå_»´_þ—n_ªd_ä“
(
nå_»´
 *
»´
);

109 
nå_»´s_þ—n_ªd_ä“
(
nå_­p
 *
­p
, 
nå_»´s
 *
»´s
);

110 
nå_»´s_þ—n_ªd_ä“_by_ty³
(
nå_­p
 *
­p
,

111 
nå_»´_ty³
 
ty³
);

112 
nå_»´s
 *
nå_»´s_®loc
(
num_»´s
);

113 
nå_»´s_»sync_phys_pÜts
(
nå_­p
 *
­p
);

115 
šlše
 
Ãt_deviû
 *
	$nå_»´_®loc
(
nå_­p
 *
­p
)

117  
	`nå_»´_®loc_mqs
(
­p
, 1, 1);

118 
	}
}

120 
šlše
 
boÞ
 
	$nå_Ãtdev_is_nå_»´
(
Ãt_deviû
 *
Ãtdev
)

122  
çl£
;

123 
	}
}

125 
šlše
 

126 
	$nå_»´_šc_rx_¡©s
(
Ãt_deviû
 *
Ãtdev
, 
Ën
è{
	}
}

128 
šlše
 

129 
	$nå_»´_Œªsãr_ã©u»s
(
Ãt_deviû
 *
Ãtdev
, Ãt_deviû *
low”
)

131 
	}
}

133 
šlše
 
	$nå_»´s_»sync_phys_pÜts
(
nå_­p
 *
­p
)

136 
	}
}

	@src/nfp_net_sriov.c

4 
	~"nå_Ãt_com·t.h
"

6 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

7 
	~<lšux/b™f›ld.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/‘h”deviû.h
>

11 
	~<lšux/if_lšk.h
>

12 
	~<lšux/if_‘h”.h
>

14 
	~"nåcÜe/nå_ýp.h
"

15 
	~"nå_­p.h
"

16 
	~"nå_maš.h
"

17 
	~"nå_Ãt_ù¾.h
"

18 
	~"nå_Ãt.h
"

19 
	~"nå_Ãt_¤iov.h
"

22 
	$nå_Ãt_¤iov_check
(
nå_­p
 *
­p
, 
vf
, 
u16
 
ÿp
, cÚ¡ *
msg
)

24 
u16
 
ÿp_vf
;

26 ià(!
­p
 || !­p->
pf
->
vfcfg_tbl2
)

27  -
EOPNOTSUPP
;

29 
ÿp_vf
 = 
	`»adw
(
­p
->
pf
->
vfcfg_tbl2
 + 
NFP_NET_VF_CFG_MB_CAP
);

30 ià((
ÿp_vf
 & 
ÿp
) != cap) {

31 
	`nå_w¬n
(
­p
->
pf
->
ýp
, "ndo_£t_vf_% nÙ suµÜ‹d\n", 
msg
);

32  -
EOPNOTSUPP
;

35 ià(
vf
 < 0 || và>ð
­p
->
pf
->
num_vfs
) {

36 
	`nå_w¬n
(
­p
->
pf
->
ýp
, "šv®id VF id %d\n", 
vf
);

37  -
EINVAL
;

41 
	}
}

44 
	$nå_Ãt_¤iov_upd©e
(
nå_­p
 *
­p
, 
vf
, 
u16
 
upd©e
, cÚ¡ *
msg
)

46 
nå_Ãt
 *
Â
;

47 
»t
;

50 
	`wr™eb
(
vf
, 
­p
->
pf
->
vfcfg_tbl2
 + 
NFP_NET_VF_CFG_MB_VF_NUM
);

51 
	`wr™ew
(
upd©e
, 
­p
->
pf
->
vfcfg_tbl2
 + 
NFP_NET_VF_CFG_MB_UPD
);

53 
Â
 = 
	`li¡_fœ¡_’Œy
(&
­p
->
pf
->
vnics
, 
nå_Ãt
, 
vnic_li¡
);

55 
»t
 = 
	`nå_Ãt_»cÚfig
(
Â
, 
NFP_NET_CFG_UPDATE_VF
);

56 ià(
»t
)

57  
»t
;

59 
»t
 = 
	`»adw
(
­p
->
pf
->
vfcfg_tbl2
 + 
NFP_NET_VF_CFG_MB_RET
);

60 ià(
»t
)

61 
	`nå_w¬n
(
­p
->
pf
->
ýp
,

62 "FW„efu£d VF % upd©w™hƒ¼no: %d\n", 
msg
, 
»t
);

63  -
»t
;

64 
	}
}

66 
	$nå_­p_£t_vf_mac
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
u8
 *
mac
)

68 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

69 
vf_off£t
;

70 
”r
;

72 
”r
 = 
	`nå_Ãt_¤iov_check
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_CAP_MAC
, "mac");

73 ià(
”r
)

74  
”r
;

76 ià(
	`is_muÉiÿ¡_‘h”_addr
(
mac
)) {

77 
	`nå_w¬n
(
­p
->
pf
->
ýp
,

79 
mac
, 
vf
);

80  -
EINVAL
;

84 
vf_off£t
 = 
NFP_NET_VF_CFG_MB_SZ
 + 
vf
 * 
NFP_NET_VF_CFG_SZ
;

85 
	`wr™–
(
	`g‘_uÇligÃd_be32
(
mac
), 
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
);

86 
	`wr™ew
(
	`g‘_uÇligÃd_be16
(
mac
 + 4),

87 
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
 + 
NFP_NET_VF_CFG_MAC_LO
);

89 
”r
 = 
	`nå_Ãt_¤iov_upd©e
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_UPD_MAC
, "MAC");

90 ià(!
”r
)

91 
	`nå_šfo
(
­p
->
pf
->
ýp
,

93 
mac
, 
vf
);

95  
”r
;

96 
	}
}

98 #ià
VER_NON_RHEL_LT
(4, 9è|| 
VER_RHEL_LT
(7, 4)

99 
	$nå_­p_£t_vf_vÏn
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
u16
 
vÏn
, 
u8
 
qos
)

101 
	$nå_­p_£t_vf_vÏn
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
u16
 
vÏn
, 
u8
 
qos
,

102 
__be16
 
vÏn_´Ùo
)

105 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

106 
vf_off£t
;

107 
u16
 
vÏn_tci
;

108 
”r
;

110 
”r
 = 
	`nå_Ãt_¤iov_check
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_CAP_VLAN
, "vlan");

111 ià(
”r
)

112  
”r
;

114 #ià
	`VER_NON_RHEL_GE
(4, 9è|| 
	`VER_RHEL_GE
(7, 4)

115 ià(
vÏn_´Ùo
 !ð
	`htÚs
(
ETH_P_8021Q
))

116  -
EOPNOTSUPP
;

119 ià(
vÏn
 > 4095 || 
qos
 > 7) {

120 
	`nå_w¬n
(
­p
->
pf
->
ýp
,

121 "šv®id vÏÀid o¸qo fÜ VF id %d\n", 
vf
);

122  -
EINVAL
;

126 
vÏn_tci
 = 
	`FIELD_PREP
(
NFP_NET_VF_CFG_VLAN_VID
, 
vÏn
) |

127 
	`FIELD_PREP
(
NFP_NET_VF_CFG_VLAN_QOS
, 
qos
);

128 
vf_off£t
 = 
NFP_NET_VF_CFG_MB_SZ
 + 
vf
 * 
NFP_NET_VF_CFG_SZ
;

129 
	`wr™ew
(
vÏn_tci
, 
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
 + 
NFP_NET_VF_CFG_VLAN
);

131  
	`nå_Ãt_¤iov_upd©e
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_UPD_VLAN
,

133 
	}
}

135 
	$nå_­p_£t_vf_¥oofchk
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
boÞ
 
’abË
)

137 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

138 
vf_off£t
;

139 
u8
 
vf_ù¾
;

140 
”r
;

142 
”r
 = 
	`nå_Ãt_¤iov_check
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_CAP_SPOOF
,

144 ià(
”r
)

145  
”r
;

148 
vf_off£t
 = 
NFP_NET_VF_CFG_MB_SZ
 + 
vf
 * 
NFP_NET_VF_CFG_SZ
 +

149 
NFP_NET_VF_CFG_CTRL
;

150 
vf_ù¾
 = 
	`»adb
(
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
);

151 
vf_ù¾
 &ð~
NFP_NET_VF_CFG_CTRL_SPOOF
;

152 
vf_ù¾
 |ð
	`FIELD_PREP
(
NFP_NET_VF_CFG_CTRL_SPOOF
, 
’abË
);

153 
	`wr™eb
(
vf_ù¾
, 
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
);

155  
	`nå_Ãt_¤iov_upd©e
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_UPD_SPOOF
,

157 
	}
}

159 
	$nå_­p_£t_vf_lšk_¡©e
(
Ãt_deviû
 *
Ãtdev
, 
vf
,

160 
lšk_¡©e
)

162 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

163 
vf_off£t
;

164 
u8
 
vf_ù¾
;

165 
”r
;

167 
”r
 = 
	`nå_Ãt_¤iov_check
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_CAP_LINK_STATE
,

169 ià(
”r
)

170  
”r
;

172 
lšk_¡©e
) {

173 
IFLA_VF_LINK_STATE_AUTO
:

174 
IFLA_VF_LINK_STATE_ENABLE
:

175 
IFLA_VF_LINK_STATE_DISABLE
:

178  -
EINVAL
;

182 
vf_off£t
 = 
NFP_NET_VF_CFG_MB_SZ
 + 
vf
 * 
NFP_NET_VF_CFG_SZ
 +

183 
NFP_NET_VF_CFG_CTRL
;

184 
vf_ù¾
 = 
	`»adb
(
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
);

185 
vf_ù¾
 &ð~
NFP_NET_VF_CFG_CTRL_LINK_STATE
;

186 
vf_ù¾
 |ð
	`FIELD_PREP
(
NFP_NET_VF_CFG_CTRL_LINK_STATE
, 
lšk_¡©e
);

187 
	`wr™eb
(
vf_ù¾
, 
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
);

189  
	`nå_Ãt_¤iov_upd©e
(
­p
, 
vf
, 
NFP_NET_VF_CFG_MB_UPD_LINK_STATE
,

191 
	}
}

193 
	$nå_­p_g‘_vf_cÚfig
(
Ãt_deviû
 *
Ãtdev
, 
vf
,

194 
iæa_vf_šfo
 *
ivi
)

196 
nå_­p
 *
­p
 = 
	`nå_­p_äom_Ãtdev
(
Ãtdev
);

197 
vf_off£t
;

198 
u16
 
vÏn_tci
;

199 
u32
 
mac_hi
;

200 
u16
 
mac_lo
;

201 
u8
 
æags
;

202 
”r
;

204 
”r
 = 
	`nå_Ãt_¤iov_check
(
­p
, 
vf
, 0, "");

205 ià(
”r
)

206  
”r
;

208 
vf_off£t
 = 
NFP_NET_VF_CFG_MB_SZ
 + 
vf
 * 
NFP_NET_VF_CFG_SZ
;

210 
mac_hi
 = 
	`»adl
(
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
);

211 
mac_lo
 = 
	`»adw
(
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
 + 
NFP_NET_VF_CFG_MAC_LO
);

213 
æags
 = 
	`»adb
(
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
 + 
NFP_NET_VF_CFG_CTRL
);

214 
vÏn_tci
 = 
	`»adw
(
­p
->
pf
->
vfcfg_tbl2
 + 
vf_off£t
 + 
NFP_NET_VF_CFG_VLAN
);

216 
	`mem£t
(
ivi
, 0, (*ivi));

217 
ivi
->
vf
 = vf;

219 
	`put_uÇligÃd_be32
(
mac_hi
, &
ivi
->
mac
[0]);

220 
	`put_uÇligÃd_be16
(
mac_lo
, &
ivi
->
mac
[4]);

222 
ivi
->
vÏn
 = 
	`FIELD_GET
(
NFP_NET_VF_CFG_VLAN_VID
, 
vÏn_tci
);

223 
ivi
->
qos
 = 
	`FIELD_GET
(
NFP_NET_VF_CFG_VLAN_QOS
, 
vÏn_tci
);

225 
ivi
->
¥oofchk
 = 
	`FIELD_GET
(
NFP_NET_VF_CFG_CTRL_SPOOF
, 
æags
);

226 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 11, 0)

227 
ivi
->
lšk¡©e
 = 
	`FIELD_GET
(
NFP_NET_VF_CFG_CTRL_LINK_STATE
, 
æags
);

231 
	}
}

	@src/nfp_net_sriov.h

4 #iâdeà
_NFP_NET_SRIOV_H_


5 
	#_NFP_NET_SRIOV_H_


	)

12 
	#NFP_NET_VF_CFG_SZ
 16

	)

13 
	#NFP_NET_VF_CFG_MB_SZ
 16

	)

16 
	#NFP_NET_VF_CFG_MB
 0x0

	)

17 
	#NFP_NET_VF_CFG_MB_CAP
 0x0

	)

18 
	#NFP_NET_VF_CFG_MB_CAP_MAC
 (0x1 << 0)

	)

19 
	#NFP_NET_VF_CFG_MB_CAP_VLAN
 (0x1 << 1)

	)

20 
	#NFP_NET_VF_CFG_MB_CAP_SPOOF
 (0x1 << 2)

	)

21 
	#NFP_NET_VF_CFG_MB_CAP_LINK_STATE
 (0x1 << 3)

	)

22 
	#NFP_NET_VF_CFG_MB_RET
 0x2

	)

23 
	#NFP_NET_VF_CFG_MB_UPD
 0x4

	)

24 
	#NFP_NET_VF_CFG_MB_UPD_MAC
 (0x1 << 0)

	)

25 
	#NFP_NET_VF_CFG_MB_UPD_VLAN
 (0x1 << 1)

	)

26 
	#NFP_NET_VF_CFG_MB_UPD_SPOOF
 (0x1 << 2)

	)

27 
	#NFP_NET_VF_CFG_MB_UPD_LINK_STATE
 (0x1 << 3)

	)

28 
	#NFP_NET_VF_CFG_MB_VF_NUM
 0x7

	)

34 
	#NFP_NET_VF_CFG_MAC
 0x0

	)

35 
	#NFP_NET_VF_CFG_MAC_HI
 0x0

	)

36 
	#NFP_NET_VF_CFG_MAC_LO
 0x6

	)

37 
	#NFP_NET_VF_CFG_CTRL
 0x4

	)

38 
	#NFP_NET_VF_CFG_CTRL_SPOOF
 0x4

	)

39 
	#NFP_NET_VF_CFG_CTRL_LINK_STATE
 0x3

	)

40 
	#NFP_NET_VF_CFG_LS_MODE_AUTO
 0

	)

41 
	#NFP_NET_VF_CFG_LS_MODE_ENABLE
 1

	)

42 
	#NFP_NET_VF_CFG_LS_MODE_DISABLE
 2

	)

43 
	#NFP_NET_VF_CFG_VLAN
 0x8

	)

44 
	#NFP_NET_VF_CFG_VLAN_QOS
 0xe000

	)

45 
	#NFP_NET_VF_CFG_VLAN_VID
 0x0fff

	)

47 
nå_­p_£t_vf_mac
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
u8
 *
mac
);

48 #ià
VER_NON_RHEL_LT
(4, 9è|| 
VER_RHEL_LT
(7, 4)

49 
nå_­p_£t_vf_vÏn
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
u16
 
vÏn
, 
u8
 
qos
);

51 
nå_­p_£t_vf_vÏn
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
u16
 
vÏn
, 
u8
 
qos
,

52 
__be16
 
vÏn_´Ùo
);

54 
nå_­p_£t_vf_¥oofchk
(
Ãt_deviû
 *
Ãtdev
, 
vf
, 
boÞ
 
£‰šg
);

55 
nå_­p_£t_vf_lšk_¡©e
(
Ãt_deviû
 *
Ãtdev
, 
vf
,

56 
lšk_¡©e
);

57 
nå_­p_g‘_vf_cÚfig
(
Ãt_deviû
 *
Ãtdev
, 
vf
,

58 
iæa_vf_šfo
 *
ivi
);

	@src/nfp_netvf_main.c

10 
	~"nå_Ãt_com·t.h
"

12 
	~<lšux/moduË.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/š™.h
>

15 
	~<lšux/‘h”deviû.h
>

17 
	~"nåcÜe/nå_dev.h
"

18 
	~"nå_Ãt_ù¾.h
"

19 
	~"nå_Ãt.h
"

20 
	~"nå_maš.h
"

29 
	snå_Ãt_vf
 {

30 
nå_Ãt
 *
	mÂ
;

32 
msix_’Œy
 
	mœq_’Œ›s
[
NFP_NET_NON_Q_VECTORS
 +

33 
NFP_NET_MAX_TX_RINGS
];

34 
u8
 
__iomem
 *
	mq_b¬
;

36 
d’Œy
 *
	mddœ
;

39 cÚ¡ 
	gnå_Ãt_driv”_Çme
[] = "nfp_netvf";

41 cÚ¡ 
pci_deviû_id
 
	gnå_Ãtvf_pci_deviû_ids
[] = {

42 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP3800_VF
,

43 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

44 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP3800_VF
,

46 { 
PCI_VENDOR_ID_NETRONOME
, 
PCI_DEVICE_ID_NETRONOME_NFP6000_VF
,

47 
PCI_VENDOR_ID_NETRONOME
, 
PCI_ANY_ID
,

48 
PCI_ANY_ID
, 0, 
NFP_DEV_NFP6000_VF
,

52 #ià
COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES


53 
MODULE_DEVICE_TABLE
(
pci
, 
nå_Ãtvf_pci_deviû_ids
);

56 
	$nå_Ãtvf_g‘_mac_addr
(
nå_Ãt
 *
Â
)

58 
u8
 
mac_addr
[
ETH_ALEN
];

60 
	`put_uÇligÃd_be32
(
	`Â_»adl
(
Â
, 
NFP_NET_CFG_MACADDR
 + 0), &
mac_addr
[0]);

61 
	`put_uÇligÃd_be16
(
	`Â_»adw
(
Â
, 
NFP_NET_CFG_MACADDR
 + 6), &
mac_addr
[4]);

63 ià(!
	`is_v®id_‘h”_addr
(
mac_addr
)) {

64 
	`‘h_hw_addr_¿ndom
(
Â
->
dp
.
Ãtdev
);

68 
	`‘h”_addr_cÝy
(
Â
->
dp
.
Ãtdev
->
dev_addr
, 
mac_addr
);

69 
	`‘h”_addr_cÝy
(
Â
->
dp
.
Ãtdev
->
³rm_addr
, 
mac_addr
);

70 
	}
}

72 
	$nå_Ãtvf_pci_´obe
(
pci_dev
 *
pdev
,

73 cÚ¡ 
pci_deviû_id
 *
pci_id
)

75 cÚ¡ 
nå_dev_šfo
 *
dev_šfo
;

76 
nå_Ãt_fw_v”siÚ
 
fw_v”
;

77 
max_tx_ršgs
, 
max_rx_ršgs
;

78 
u32
 
tx_b¬_off
, 
rx_b¬_off
;

79 
u32
 
tx_b¬_sz
, 
rx_b¬_sz
;

80 
tx_b¬_no
, 
rx_b¬_no
;

81 
nå_Ãt_vf
 *
vf
;

82 
num_œqs
;

83 
u8
 
__iomem
 *
ù¾_b¬
;

84 
nå_Ãt
 *
Â
;

85 
u32
 
¡¬tq
;

86 
¡ride
;

87 
”r
;

89 
dev_šfo
 = &
nå_dev_šfo
[
pci_id
->
driv”_d©a
];

91 
vf
 = 
	`kz®loc
((*vf), 
GFP_KERNEL
);

92 ià(!
vf
)

93  -
ENOMEM
;

94 
	`pci_£t_drvd©a
(
pdev
, 
vf
);

96 
”r
 = 
	`pci_’abË_deviû_mem
(
pdev
);

97 ià(
”r
)

98 
”r_ä“_vf
;

100 
”r
 = 
	`pci_»que¡_»giÚs
(
pdev
, 
nå_Ãt_driv”_Çme
);

101 ià(
”r
) {

102 
	`dev_”r
(&
pdev
->
dev
, "Unableo‡llocate device memory.\n");

103 
”r_pci_di§bË
;

106 
	`pci_£t_ma¡”
(
pdev
);

108 
”r
 = 
	`dma_£t_mask_ªd_coh”’t
(&
pdev
->
dev
, 
dev_šfo
->
dma_mask
);

109 ià(
”r
)

110 
”r_pci_»giÚs
;

118 
ù¾_b¬
 = 
	`iÜem­_noÿche
(
	`pci_»sourû_¡¬t
(
pdev
, 
NFP_NET_CTRL_BAR
),

119 
NFP_NET_CFG_BAR_SZ
);

120 ià(!
ù¾_b¬
) {

121 
	`dev_”r
(&
pdev
->
dev
,

122 "FažedØm­„esourû %d\n", 
NFP_NET_CTRL_BAR
);

123 
”r
 = -
EIO
;

124 
”r_pci_»giÚs
;

127 
	`nå_Ãt_g‘_fw_v”siÚ
(&
fw_v”
, 
ù¾_b¬
);

128 ià(
fw_v”
.
dp_»sv
 & 
NFP_NET_CFG_VERSION_RESERVED_MASK
 ||

129 
fw_v”
.
þass
 !ð
NFP_NET_CFG_VERSION_CLASS_GENERIC
) {

130 
	`dev_”r
(&
pdev
->
dev
, "Unknown Firmware ABI %d.%d.%d.%d\n",

131 
fw_v”
.
dp_»sv
, fw_v”.
þass
,

132 
fw_v”
.
majÜ
, fw_v”.
mšÜ
);

133 
”r
 = -
EINVAL
;

134 
”r_ù¾_unm­
;

138 ià(
	`nå_Ãt_fw_v”_eq
(&
fw_v”
, 0, 0, 0, 1)) {

139 
¡ride
 = 2;

140 
tx_b¬_no
 = 
NFP_NET_Q0_BAR
;

141 
rx_b¬_no
 = 
NFP_NET_Q1_BAR
;

142 
	`dev_w¬n
(&
pdev
->
dev
, "OBSOLETE Firmware detected - VF isolation‚ot‡vailable\n");

144 
fw_v”
.
majÜ
) {

146 
¡ride
 = 4;

147 
tx_b¬_no
 = 
NFP_NET_Q0_BAR
;

148 
rx_b¬_no
 = 
tx_b¬_no
;

151 
	`dev_”r
(&
pdev
->
dev
, "Unsupported Firmware ABI %d.%d.%d.%d\n",

152 
fw_v”
.
dp_»sv
, fw_v”.
þass
,

153 
fw_v”
.
majÜ
, fw_v”.
mšÜ
);

154 
”r
 = -
EINVAL
;

155 
”r_ù¾_unm­
;

160 
max_tx_ršgs
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_MAX_TXRINGS
);

161 
max_rx_ršgs
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_MAX_RXRINGS
);

163 
tx_b¬_sz
 = 
NFP_QCP_QUEUE_ADDR_SZ
 * 
max_tx_ršgs
 * 
¡ride
;

164 
rx_b¬_sz
 = 
NFP_QCP_QUEUE_ADDR_SZ
 * 
max_rx_ršgs
 * 
¡ride
;

167 ià(
tx_b¬_sz
 > 
	`pci_»sourû_Ën
(
pdev
, 
tx_b¬_no
)) {

168 
	`dev_”r
(&
pdev
->
dev
,

170 
tx_b¬_sz
 = 
	`pci_»sourû_Ën
(
pdev
, 
tx_b¬_no
);

171 
max_tx_ršgs
 = (
tx_b¬_sz
 / 
NFP_QCP_QUEUE_ADDR_SZ
) / 2;

173 ià(
rx_b¬_sz
 > 
	`pci_»sourû_Ën
(
pdev
, 
rx_b¬_no
)) {

174 
	`dev_”r
(&
pdev
->
dev
,

176 
rx_b¬_sz
 = 
	`pci_»sourû_Ën
(
pdev
, 
rx_b¬_no
);

177 
max_rx_ršgs
 = (
rx_b¬_sz
 / 
NFP_QCP_QUEUE_ADDR_SZ
) / 2;

180 
¡¬tq
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_START_TXQ
);

181 
tx_b¬_off
 = 
	`nå_qý_queue_off£t
(
dev_šfo
, 
¡¬tq
);

182 
¡¬tq
 = 
	`»adl
(
ù¾_b¬
 + 
NFP_NET_CFG_START_RXQ
);

183 
rx_b¬_off
 = 
	`nå_qý_queue_off£t
(
dev_šfo
, 
¡¬tq
);

186 
Â
 = 
	`nå_Ãt_®loc
(
pdev
, 
dev_šfo
, 
ù¾_b¬
, 
Œue
,

187 
max_tx_ršgs
, 
max_rx_ršgs
);

188 ià(
	`IS_ERR
(
Â
)) {

189 
”r
 = 
	`PTR_ERR
(
Â
);

190 
”r_ù¾_unm­
;

192 
vf
->
Â
 =‚n;

194 
Â
->
dp
.
is_vf
 = 1;

195 
Â
->
¡ride_tx
 = 
¡ride
;

196 
Â
->
¡ride_rx
 = 
¡ride
;

198 ià(
rx_b¬_no
 =ð
tx_b¬_no
) {

199 
u32
 
b¬_off
, 
b¬_sz
;

200 
»sourû_size_t
 
m­_addr
;

203 ià(
tx_b¬_off
 < 
rx_b¬_off
)

204 
b¬_off
 = 
tx_b¬_off
;

206 
b¬_off
 = 
rx_b¬_off
;

208 ià((
tx_b¬_off
 + 
tx_b¬_sz
è> (
rx_b¬_off
 + 
rx_b¬_sz
))

209 
b¬_sz
 = (
tx_b¬_off
 + 
tx_b¬_sz
è- 
b¬_off
;

211 
b¬_sz
 = (
rx_b¬_off
 + 
rx_b¬_sz
è- 
b¬_off
;

213 
m­_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
tx_b¬_no
è+ 
b¬_off
;

214 
vf
->
q_b¬
 = 
	`iÜem­_noÿche
(
m­_addr
, 
b¬_sz
);

215 ià(!
vf
->
q_b¬
) {

216 
	`Â_”r
(
Â
, "FažedØm­„esourû %d\n", 
tx_b¬_no
);

217 
”r
 = -
EIO
;

218 
”r_Ãtdev_ä“
;

222 
Â
->
tx_b¬
 = 
vf
->
q_b¬
 + (
tx_b¬_off
 - 
b¬_off
);

224 
Â
->
rx_b¬
 = 
vf
->
q_b¬
 + (
rx_b¬_off
 - 
b¬_off
);

226 
»sourû_size_t
 
m­_addr
;

229 
m­_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
tx_b¬_no
è+ 
tx_b¬_off
;

230 
Â
->
tx_b¬
 = 
	`iÜem­_noÿche
(
m­_addr
, 
tx_b¬_sz
);

231 ià(!
Â
->
tx_b¬
) {

232 
	`Â_”r
(
Â
, "FažedØm­„esourû %d\n", 
tx_b¬_no
);

233 
”r
 = -
EIO
;

234 
”r_Ãtdev_ä“
;

238 
m­_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
rx_b¬_no
è+ 
rx_b¬_off
;

239 
Â
->
rx_b¬
 = 
	`iÜem­_noÿche
(
m­_addr
, 
rx_b¬_sz
);

240 ià(!
Â
->
rx_b¬
) {

241 
	`Â_”r
(
Â
, "FažedØm­„esourû %d\n", 
rx_b¬_no
);

242 
”r
 = -
EIO
;

243 
”r_unm­_tx
;

247 
	`nå_Ãtvf_g‘_mac_addr
(
Â
);

249 
num_œqs
 = 
	`nå_Ãt_œqs_®loc
(
pdev
, 
vf
->
œq_’Œ›s
,

250 
NFP_NET_MIN_VNIC_IRQS
,

251 
NFP_NET_NON_Q_VECTORS
 +

252 
Â
->
dp
.
num_r_vecs
);

253 ià(!
num_œqs
) {

254 
	`Â_w¬n
(
Â
, "Unableo‡llocate MSI-X Vectors. Exiting\n");

255 
”r
 = -
EIO
;

256 
”r_unm­_rx
;

258 
	`nå_Ãt_œqs_assign
(
Â
, 
vf
->
œq_’Œ›s
, 
num_œqs
);

260 
”r
 = 
	`nå_Ãt_š™
(
Â
);

261 ià(
”r
)

262 
”r_œqs_di§bË
;

264 
	`nå_Ãt_šfo
(
Â
);

265 
vf
->
ddœ
 = 
	`nå_Ãt_debugfs_deviû_add
(
pdev
);

266 
	`nå_Ãt_debugfs_vnic_add
(
Â
, 
vf
->
ddœ
);

270 
”r_œqs_di§bË
:

271 
	`nå_Ãt_œqs_di§bË
(
pdev
);

272 
”r_unm­_rx
:

273 ià(!
vf
->
q_b¬
)

274 
	`iounm­
(
Â
->
rx_b¬
);

275 
”r_unm­_tx
:

276 ià(!
vf
->
q_b¬
)

277 
	`iounm­
(
Â
->
tx_b¬
);

279 
	`iounm­
(
vf
->
q_b¬
);

280 
”r_Ãtdev_ä“
:

281 
	`nå_Ãt_ä“
(
Â
);

282 
”r_ù¾_unm­
:

283 
	`iounm­
(
ù¾_b¬
);

284 
”r_pci_»giÚs
:

285 
	`pci_»Ëa£_»giÚs
(
pdev
);

286 
”r_pci_di§bË
:

287 
	`pci_di§bË_deviû
(
pdev
);

288 
”r_ä“_vf
:

289 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

290 
	`kä“
(
vf
);

291  
”r
;

292 
	}
}

294 
	$nå_Ãtvf_pci_»move
(
pci_dev
 *
pdev
)

296 
nå_Ãt_vf
 *
vf
 = 
	`pci_g‘_drvd©a
(
pdev
);

297 
nå_Ãt
 *
Â
 = 
vf
->nn;

302 
	`nå_Ãt_debugfs_dœ_þ—n
(&
Â
->
debugfs_dœ
);

303 
	`nå_Ãt_debugfs_dœ_þ—n
(&
vf
->
ddœ
);

305 
	`nå_Ãt_þ—n
(
Â
);

307 
	`nå_Ãt_œqs_di§bË
(
pdev
);

309 ià(!
vf
->
q_b¬
) {

310 
	`iounm­
(
Â
->
rx_b¬
);

311 
	`iounm­
(
Â
->
tx_b¬
);

313 
	`iounm­
(
vf
->
q_b¬
);

315 
	`iounm­
(
Â
->
dp
.
ù¾_b¬
);

317 
	`nå_Ãt_ä“
(
Â
);

319 
	`pci_»Ëa£_»giÚs
(
pdev
);

320 
	`pci_di§bË_deviû
(
pdev
);

322 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

323 
	`kä“
(
vf
);

324 
	}
}

326 
pci_driv”
 
	gnå_Ãtvf_pci_driv”
 = {

327 .
Çme
 = 
nå_Ãt_driv”_Çme
,

328 .
	gid_bË
 = 
nå_Ãtvf_pci_deviû_ids
,

329 .
	g´obe
 = 
nå_Ãtvf_pci_´obe
,

330 .
	g»move
 = 
nå_Ãtvf_pci_»move
,

	@src/nfp_plat.c

11 
	~<lšux/k”Ãl.h
>

13 #ifdeà
CONFIG_ARCH_NFP


15 
	~<lšux/moduË.h
>

16 
	~<lšux/¶©fÜm_deviû.h
>

17 
	~<lšux/œq.h
>

18 
	~<lšux/œqdomaš.h
>

19 
	~<lšux/œqch/chašed_œq.h
>

20 
	~<lšux/io.h
>

21 
	~<lšux/of_deviû.h
>

22 
	~<lšux/of_add»ss.h
>

23 
	~<lšux/of_œq.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/š‹¼u±.h
>

27 
	~"nåcÜe/nå_¬m.h
"

28 
	~"nåcÜe/nå_ýp.h
"

30 
	~"nåcÜe/nå6000/nå6000.h
"

32 
	~"nåcÜe/nå_Ãt_vnic.h
"

34 
	~"nå_maš.h
"

36 
	#NFP_EXPL_START
 (0xde000000)

	)

37 
	#NFP_ARM_EM_START
 (0xd6000000 + 
NFP_ARM_EM
)

	)

39 
	#NFP_EXPA_START
 0xc0000000

	)

40 
	#NFP_ARM_START
 0xd6000000

	)

42 
	#BAR_FLAG_LOCKED
 
	`BIT
(0)

	)

52 
	#NFP_CPP_MODEL_CHIP_of
(
mod–
è(((mod–è>> 16è& 0xffff)

	)

62 
	#NFP_CPP_MODEL_IS_6000
(
mod–
) \

63 ((0x4000 <ð
	`NFP_CPP_MODEL_CHIP_of
(
mod–
)) && \

64 (
	`NFP_CPP_MODEL_CHIP_of
(
mod–
è< 0x7000))

	)

66 
	snå_¶©_b¬
 {

67 
	mæags
;

68 
©omic_t
 
	mu§ge
;

69 
u32
 
	mc¤
;

72 
	#NFP_EM_FILTER_BASE
 8

	)

73 
	#NFP_EM_FILTERS
 32

	)

75 
	snå_¶©
 {

76 
deviû
 *
	mdev
;

78 
¶©fÜm_deviû
 *
	mnå_dev_ýp
;

79 
¶©fÜm_deviû
 *
	mnå_Ãt_vnic
[4];

80 
nå_ýp
 *
	mýp
;

81 (*
	mrg‘_pushpuÎ
)(
u32
 
	mýp_id
, 
u64
 
	madd»ss
);

82 
¥šlock_t
 
	mlock
;

83 
nå_¶©_b¬
 
	mbulk_b¬
[7];

84 
nå_¶©_b¬
 
	mex·_b¬
[15];

85 
	mex¶_b¬_mask
[
BITS_TO_LONGS
(16)];

87 
__iomem
 *
	mgc¤
;

88 
deviû_node
 *
	m¬m_em
;

89 
phys_addr_t
 
	mex¶_phys
;

90 
size_t
 
	mex¶_size
;

91 
__iomem
 *
	mex¶_io
;

92 
__iomem
 *
	mex¶_d©a
;

94 
	mœq_u£d
[
BITS_TO_LONGS
(
NFP_EM_FILTERS
)];

95 
	mœq
[
NFP_EM_FILTERS
];

98 
	snå_¶©_¬—_´iv
 {

100 
u32
 
	mde¡
;

101 
u64
 
	maddr
;

102 
	msize
;

104 
	m»ad
;

105 
	mwr™e
;

106 
	mb¬
;

107 } 
	mwidth
;

110 
nå_¶©_b¬
 *
	mb¬
;

111 
»sourû
 
	m»sourû
;

114 
	eb¬_ty³
 {

115 
	mBAR_INVALID
 = 0,

116 
	mBAR_BULK
,

117 
	mBAR_EXPA
,

118 } 
	mty³
;

119 
	mb¬s
;

120 
	mid
;

121 
u64
 
	moff£t
;

122 
	mphys_addr
;

123 
	mphys_size
;

124 
__iomem
 *
	miomem
;

127 
	snå_¶©_ev’t_´iv
 {

128 
u32
 
	mm©ch
;

129 
u32
 
	mmask
;

130 
	mty³
;

131 
	mem_¦Ù
;

134 
	$b¬_lock
(
nå_¶©_b¬
 *
b¬
)

136 
	`©omic_šc
(&
b¬
->
u§ge
);

137 
b¬
->
æags
 |ð
BAR_FLAG_LOCKED
;

138 
	}
}

140 
	$b¬_uÆock
(
nå_¶©_b¬
 *
b¬
)

142 ià(
	`©omic_dec_ªd_‹¡
(&
b¬
->
u§ge
)) {

143 
b¬
->
æags
 &ð~
BAR_FLAG_LOCKED
;

144 
b¬
->
c¤
 = 0;

146 
	}
}

148 
	$b¬_fšd
(
nå_ýp_¬—
 *
¬—
, 
b¬_ty³
 
ty³
,

149 
b¬s
, 
u32
 
c¤
, 
ÿn_®loc
)

151 
nå_¶©
 *
nå_´iv
 = 
	`nå_ýp_´iv
(
	`nå_ýp_¬—_ýp
(
¬—
));

152 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

153 
nå_¶©_b¬
 *
b¬
;

154 
b¬_ba£
;

155 
b¬_max
;

156 
size_t
 
b¬_size
;

157 
i
, 
j
;

160 
	`BUG_ON
(
´iv
->
b¬
);

161 
	`BUG_ON
(
b¬s
 == 0);

163 
ty³
) {

164 
BAR_BULK
:

165 
b¬
 = 
nå_´iv
->
bulk_b¬
;

166 
b¬_max
 = 
	`ARRAY_SIZE
(
nå_´iv
->
bulk_b¬
);

167 
b¬_size
 = 
NFP_ARM_GCSR_BULK_SIZE
;

168 
b¬_ba£
 = 0;

170 
BAR_EXPA
:

171 
b¬
 = 
nå_´iv
->
ex·_b¬
;

172 
b¬_max
 = 
	`ARRAY_SIZE
(
nå_´iv
->
ex·_b¬
);

173 
b¬_size
 = 
NFP_ARM_GCSR_EXPA_SIZE
;

174 
b¬_ba£
 = 
NFP_EXPA_START
;

177  -
EINVAL
;

181 
b¬_max
 = b¬_max - 
b¬s
 + 1;

183 
	`¥š_lock
(&
nå_´iv
->
lock
);

186 
i
 = 0; i < 
b¬_max
; i++) {

187 
j
 = 0; j < 
b¬s
; j++) {

188 ià((
b¬
[
i
 + 
j
].
æags
 & 
BAR_FLAG_LOCKED
) == 0)

190 ià((
c¤
 + 
j
è!ð
b¬
[
i
 + j].csr)

193 ià(
j
 =ð
b¬s
)

196 ià(
i
 < 
b¬_max
) {

198 
found_¦Ù
;

201 ià(!
ÿn_®loc
) {

202 
	`¥š_uÆock
(&
nå_´iv
->
lock
);

203  -
EEXIST
;

207 
i
 = 0; i < 
b¬_max
; i++) {

208 
j
 = 0; j < 
b¬s
; j++) {

209 ià((
b¬
[
i
 + 
j
].
æags
 & 
BAR_FLAG_LOCKED
))

212 ià(
j
 =ð
b¬s
)

216 ià(
i
 =ð
b¬_max
) {

217 
	`¥š_uÆock
(&
nå_´iv
->
lock
);

218  -
ENOSPC
;

221 
found_¦Ù
:

222 
´iv
->
id
 = 
i
;

224 
j
 = 0; j < 
b¬s
; j++) {

225 
	`b¬_lock
(&
b¬
[
´iv
->
id
 + 
j
]);

226 
b¬
[
´iv
->
id
 + 
j
].
c¤
 = csr + j;

229 
	`¥š_uÆock
(&
nå_´iv
->
lock
);

231 
´iv
->
b¬
 = &b¬[´iv->
id
];

232 
´iv
->
b¬s
 = bars;

233 
´iv
->
ty³
 =ype;

234 
´iv
->
off£t
 =…riv->
addr
 & (
b¬_size
 - 1);

235 
´iv
->
phys_addr
 = 
b¬_ba£
 +…riv->
id
 * 
b¬_size
;

236 
´iv
->
phys_size
 = 
b¬_size
 * 
b¬s
;

239 
	}
}

241 
	$bulk_c¤
(
u32
 *
c¤
, u32 
de¡
, 
u64
 
addr
, 
width
)

243 *
c¤
 = 
	`NFP_ARM_GCSR_BULK_CSR
(0,

244 
	`NFP_CPP_ID_TARGET_of
(
de¡
),

245 
	`NFP_CPP_ID_TOKEN_of
(
de¡
),

246 (
width
 = 8è? 
NFP_ARM_GCSR_BULK_BAR_LEN_64BIT
 :

247 
NFP_ARM_GCSR_BULK_BAR_LEN_32BIT
,

248 
addr
);

249 
	}
}

251 
	$bulk_£t
(
nå_¶©
 *
´iv
, 
u32
 
c¤
, 
id
)

253 
i
;

255 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
id
));

256 
	`wr™–
(
c¤
, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
id
));

257 
i
 = 0; i < 10; i++)

258 ià(
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
id
)è=ð
c¤
)

260 ià(
i
 == 10)

261 
	`dev_”r
(
´iv
->
dev
, "BULK%d: %08x != %08x\n",

262 
id
,

263 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
id
)),

264 
c¤
);

265 
	}
}

267 
	$ex·_c¤
(
u32
 *
c¤
, u32 
de¡
, 
u64
 
addr
, 
width
)

269 
aùiÚ
 = 
	`NFP_CPP_ID_ACTION_of
(
de¡
);

270 
is_64
 = (
width
 == 8) ? 1 : 0;

272 ià(
aùiÚ
 =ð
NFP_CPP_ACTION_RW
)

273 
aùiÚ
 = 0;

275 *
c¤
 = 
	`NFP_ARM_GCSR_EXPA_CSR
(0,

276 
	`NFP_CPP_ID_TARGET_of
(
de¡
),

277 
	`NFP_CPP_ID_TOKEN_of
(
de¡
),

278 
is_64
 ? 
NFP_ARM_GCSR_EXPA_BAR_LEN_64BIT
 :

279 
NFP_ARM_GCSR_EXPA_BAR_LEN_32BIT
,

280 
	`NFP_CPP_ID_ACTION_of
(
de¡
),

281 
addr
);

282 
	}
}

284 
	$ex·_£t
(
nå_¶©
 *
´iv
, 
u32
 
c¤
, 
id
)

286 
i
;

288 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
id
));

289 
	`wr™–
(
c¤
, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
id
));

290 
i
 = 0; i < 10; i++)

291 ià(
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
id
)è=ð
c¤
)

293 ià(
i
 == 10)

294 
	`dev_”r
(
´iv
->
dev
, "EXPA%d: %08x != %08x\n",

295 
id
,

296 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
id
)),

297 
c¤
);

298 
	}
}

300 
	$nå_¶©_g‘_š‹rçû
(
deviû
 *
dev
)

302  
	`NFP_CPP_INTERFACE
(
NFP_CPP_INTERFACE_TYPE_ARM
,

304 
NFP_CPP_INTERFACE_CHANNEL_PEROPENER
);

305 
	}
}

307 
	$nå_¶©_¬—_š™
(
nå_ýp_¬—
 *
¬—
, 
u32
 
de¡
, 
u64
 
addr
,

308 
size
)

310 
nå_¶©
 *
nå_´iv
 = 
	`nå_ýp_´iv
(
	`nå_ýp_¬—_ýp
(
¬—
));

311 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

312 
µ
;

314 
µ
 = 
nå_´iv
->
	`rg‘_pushpuÎ
(
de¡
, 
addr
);

315 ià(
µ
 < 0)

316  
µ
;

318 
´iv
->
width
.
»ad
 = 
	`PUSH_WIDTH
(
µ
);

319 
´iv
->
width
.
wr™e
 = 
	`PULL_WIDTH
(
µ
);

320 ià(
´iv
->
width
.
»ad
 > 0 &&

321 
´iv
->
width
.
wr™e
 > 0 &&

322 
´iv
->
width
.
»ad
 !ð´iv->width.
wr™e
) {

323  -
EINVAL
;

326 ià(
´iv
->
width
.
»ad
)

327 
´iv
->
width
.
b¬
 =…riv->width.
»ad
;

329 
´iv
->
width
.
b¬
 =…riv->width.
wr™e
;

331 
´iv
->
de¡
 = dest;

332 
´iv
->
addr
 =‡ddr;

333 
´iv
->
size
 = size;

334 
´iv
->
b¬
 = 
NULL
;

337 
	}
}

339 
	$nå_¶©_¬—_þ—nup
(
nå_ýp_¬—
 *
¬—
)

341 
	}
}

343 
	$b¬_fšd_ªy
(
nå_ýp_¬—
 *
¬—
, 
ÿn_®loÿ‹
)

345 
nå_¶©
 *
nå_´iv
 = 
	`nå_ýp_´iv
(
	`nå_ýp_¬—_ýp
(
¬—
));

346 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

347 
size
;

348 
b¬s
, 
”r
, 
i
;

349 
width
;

350 
u32
 
de¡
;

351 
u64
 
addr
;

352 
u32
 
c¤
;

354 
	`BUG_ON
(
´iv
->
b¬
);

356 
de¡
 = 
´iv
->dest;

357 
addr
 = 
´iv
->addr;

358 
size
 = 
´iv
->size;

359 
width
 = 
´iv
->width.
b¬
;

361 
	#BARS
(
addr
, 
size
, 
max_size
) \

362 ((((
addr
è& ((
max_size
) - 1)) + \

363 (
size
è+ (
max_size
è- 1è/ (max_size))

	)

365 
b¬s
 = 
	`BARS
(
addr
, 
size
, 
NFP_ARM_GCSR_EXPA_SIZE
);

366 ià(
b¬s
 < 
	`ARRAY_SIZE
(
nå_´iv
->
ex·_b¬
)) {

367 
	`ex·_c¤
(&
c¤
, 
de¡
, 
addr
, 
width
);

368 
”r
 = 
	`b¬_fšd
(
¬—
, 
BAR_EXPA
, 
b¬s
, 
c¤
, 
ÿn_®loÿ‹
);

369 ià(
”r
 == 0) {

370 
i
 = 0; i < 
b¬s
; i++)

371 
	`ex·_£t
(
nå_´iv
, 
´iv
->
b¬
[
i
].
c¤
,

372 
´iv
->
id
 + 
i
);

377 
b¬s
 = 
	`BARS
(
addr
, 
size
, 
NFP_ARM_GCSR_BULK_SIZE
);

378 ià((
b¬s
 < 
	`ARRAY_SIZE
(
nå_´iv
->
bulk_b¬
)) &&

379 (
	`NFP_CPP_ID_ACTION_of
(
de¡
è=ð
NFP_CPP_ACTION_RW
 ||

380 
	`NFP_CPP_ID_ACTION_of
(
de¡
) == 0 ||

381 
	`NFP_CPP_ID_ACTION_of
(
de¡
) == 1)) {

382 
	`bulk_c¤
(&
c¤
, 
de¡
, 
addr
, 
width
);

384 
”r
 = 
	`b¬_fšd
(
¬—
, 
BAR_BULK
, 
b¬s
, 
c¤
, 
ÿn_®loÿ‹
);

385 ià(
”r
 == 0) {

386 
i
 = 0; i < 
b¬s
; i++)

387 
	`bulk_£t
(
nå_´iv
, 
´iv
->
b¬
[
i
].
c¤
,

388 
´iv
->
id
 + 
i
);

393  -
ENOSPC
;

394 
	}
}

396 
	$nå_¶©_acquœe
(
nå_ýp_¬—
 *
¬—
)

398 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

399 
phys_addr_t
 
phys_off£t
;

400 
”r
;

402 
”r
 = 
	`b¬_fšd_ªy
(
¬—
, 
çl£
);

403 ià(
”r
 != 0)

404 
”r
 = 
	`b¬_fšd_ªy
(
¬—
, 
Œue
);

406 ià(
”r
 == 0) {

407 
phys_off£t
 = 
´iv
->
phys_addr
 +…riv->
off£t
;

409 
	`mem£t
(&
´iv
->
»sourû
, 0, (priv->resource));

410 
´iv
->
»sourû
.
Çme
 = 
	`nå_ýp_¬—_Çme
(
¬—
);

411 
´iv
->
»sourû
.
¡¬t
 = 
phys_off£t
;

412 
´iv
->
»sourû
.
’d
 = 
phys_off£t
 +…riv->
size
 - 1;

413 
´iv
->
»sourû
.
æags
 = 
IORESOURCE_MEM
;

414 
´iv
->
»sourû
.
·»Á
 = 
NULL
;

417  
”r
;

418 
	}
}

420 
	$nå_¶©_»Ëa£
(
nå_ýp_¬—
 *
¬—
)

422 
nå_¶©
 *
nå_´iv
 = 
	`nå_ýp_´iv
(
	`nå_ýp_¬—_ýp
(
¬—
));

423 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

424 
i
;

426 
	`BUG_ON
(!
´iv
->
b¬
);

428 ià(
´iv
->
iomem
)

429 
	`iounm­
(
´iv
->
iomem
);

431 
	`¥š_lock
(&
nå_´iv
->
lock
);

433 
i
 = 0; i < 
´iv
->
b¬s
; i++)

434 
	`b¬_uÆock
(&
´iv
->
b¬
[
i
]);

436 
	`¥š_uÆock
(&
nå_´iv
->
lock
);

438 
´iv
->
b¬
 = 
NULL
;

439 
´iv
->
iomem
 = 
NULL
;

440 
	}
}

442 
»sourû
 *
	$nå_¶©_»sourû
(
nå_ýp_¬—
 *
¬—
)

444 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

446 
	`BUG_ON
(!
´iv
->
b¬
);

448  &
´iv
->
»sourû
;

449 
	}
}

451 
phys_addr_t
 
	$nå_¶©_phys
(
nå_ýp_¬—
 *
¬—
)

453 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

455 
	`BUG_ON
(!
´iv
->
b¬
);

457  
´iv
->
phys_addr
 +…riv->
off£t
;

458 
	}
}

460 
__iomem
 *
	$nå_¶©_iomem
(
nå_ýp_¬—
 *
¬—
)

462 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

463 
phys_addr_t
 
phys_off£t
;

465 
	`BUG_ON
(!
´iv
->
b¬
);

467 ià(
´iv
->
iomem
)

468  
´iv
->
iomem
;

470 
phys_off£t
 = 
´iv
->
phys_addr
 +…riv->
off£t
;

472 
´iv
->
iomem
 = 
	`iÜem­
(
phys_off£t
,…riv->
size
);

474  
´iv
->
iomem
;

475 
	}
}

477 
	$nå_¶©_»ad
(
nå_ýp_¬—
 *
¬—
, *
k”Ãl_vaddr
,

478 
off£t
, 
Ëngth
)

480 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

481 
__iomem
 *
iomem
;

482 
i
;

483 
is_64
;

485 
	`BUG_ON
(!
´iv
->
b¬
);

487 ià(!
´iv
->
width
.
»ad
)

488  -
EINVAL
;

490 
iomem
 = 
	`nå_ýp_¬—_iomem
(
¬—
);

491 ià(!
iomem
)

492  -
ENOMEM
;

494 
is_64
 = (
´iv
->
width
.
»ad
 == 8) ? 1 : 0;

496 ià(
is_64
) {

497 ià(((
off£t
 % (
u64
)) != 0) ||

498 ((
Ëngth
 % (
u64
)) != 0))

499  -
EINVAL
;

501 ià(((
off£t
 % (
u32
)) != 0) ||

502 ((
Ëngth
 % (
u32
)) != 0))

503  -
EINVAL
;

505 
	`BUG_ON
((
off£t
 + 
Ëngth
è> 
´iv
->
size
);

507 ià(
´iv
->
ty³
 =ð
BAR_BULK
 ||…riv->ty³ =ð
BAR_EXPA
) {

509 ià(((
off£t
 % (
u64
)) == 0) &&

510 ((
Ëngth
 % (
u64
)) == 0)) {

511 
i
 = 0; i < 
Ëngth
; i +ð(
u64
)) {

512 
u64
 
tmp
 = 
	`»adq
(
iomem
 + 
off£t
 + 
i
);

513 *(
u64
 *)(
k”Ãl_vaddr
 + 
i
èð
tmp
;

516 
i
 = 0; i < 
Ëngth
; i +ð(
u32
)) {

517 
u32
 
tmp
 = 
	`»adl
(
iomem
 + 
off£t
 + 
i
);

518 *(
u32
 *)(
k”Ãl_vaddr
 + 
i
èð
tmp
;

521  
i
;

526  -
EINVAL
;

527 
	}
}

529 
	$nå_¶©_wr™e
(
nå_ýp_¬—
 *
¬—
,

530 cÚ¡ *
k”Ãl_vaddr
, 
off£t
,

531 
Ëngth
)

533 
nå_¶©_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

534 
__iomem
 *
iomem
;

535 
i
;

536 
is_64
;

538 
	`BUG_ON
(!
´iv
->
b¬
);

540 ià(!
´iv
->
width
.
wr™e
)

541  -
EINVAL
;

543 
iomem
 = 
	`nå_ýp_¬—_iomem
(
¬—
);

544 ià(!
iomem
)

545  -
ENOMEM
;

547 
is_64
 = (
´iv
->
width
.
wr™e
 == 8) ? 1 : 0;

549 ià(
is_64
) {

550 ià(((
off£t
 % (
u64
)) != 0) ||

551 ((
Ëngth
 % (
u64
)) != 0))

552  -
EINVAL
;

554 ià(((
off£t
 % (
u32
)) != 0) ||

555 ((
Ëngth
 % (
u32
)) != 0))

556  -
EINVAL
;

559 ià(
´iv
->
ty³
 =ð
BAR_BULK
 ||…riv->ty³ =ð
BAR_EXPA
) {

561 ià(((
off£t
 % (
u64
)) == 0) &&

562 ((
Ëngth
 % (
u64
)) == 0)) {

563 
i
 = 0; i < 
Ëngth
; i +ð(
u64
)) {

564 
	`wr™eq
(*(
u64
 *)(
k”Ãl_vaddr
 + 
i
),

565 
iomem
 + 
off£t
 + 
i
);

568 
i
 = 0; i < 
Ëngth
; i +ð(
u32
)) {

569 
	`wr™–
(*(
u32
 *)(
k”Ãl_vaddr
 + 
i
),

570 
iomem
 + 
off£t
 + 
i
);

573  
i
;

578  -
EINVAL
;

579 
	}
}

581 
œq»tuº_t
 
	$nå_¶©_œq
(
œq
, *
´iv
)

583 
nå_ýp_ev’t
 *
ev’t
 = 
´iv
;

585 
	`nå_ýp_ev’t_ÿÎback
(
ev’t
);

587  
IRQ_HANDLED
;

588 
	}
}

590 
	$nå_¶©_ev’t_acquœe
(
nå_ýp_ev’t
 *
ev’t
,

591 
u32
 
m©ch
, u32 
mask
, 
ty³
)

593 
nå_¶©_ev’t_´iv
 *
ev’t_´iv
 = 
	`nå_ýp_ev’t_´iv
(
ev’t
);

594 
nå_¶©
 *
´iv
 = 
	`nå_ýp_´iv
(
	`nå_ýp_ev’t_ýp
(
ev’t
));

595 
”r
, 
em_¦Ù
;

596 
œq
;

597 
u32
 
¥ec
[4];

600 ià(
ty³
 != 0)

601  -
EINVAL
;

603 
ev’t_´iv
->
m©ch
 = match;

604 
ev’t_´iv
->
mask
 = mask;

605 
ev’t_´iv
->
ty³
 =ype;

606 
ev’t_´iv
->
em_¦Ù
 = -1;

608 
	`¥š_lock
(&
´iv
->
lock
);

610 
em_¦Ù
 = 
	`fšd_fœ¡_z”o_b™
(&
´iv
->
œq_u£d
, 32);

611 ià(
em_¦Ù
 >= 32) {

612 
	`¥š_uÆock
(&
´iv
->
lock
);

613  -
ENOSPC
;

615 
	`BUG_ON
(
	`‹¡_b™
(
em_¦Ù
, 
´iv
->
œq_u£d
));

617 
	`£t_b™
(
em_¦Ù
, 
´iv
->
œq_u£d
);

618 
	`¥š_uÆock
(&
´iv
->
lock
);

620 
ev’t_´iv
->
em_¦Ù
 =ƒm_slot;

621 
¥ec
[0] = 
ev’t_´iv
->
em_¦Ù
 * 32;

622 
¥ec
[1] = 
ev’t_´iv
->
m©ch
;

623 
¥ec
[2] = 
ev’t_´iv
->
mask
;

624 
¥ec
[3] = 
ev’t_´iv
->
ty³
;

626 
œq
 = 
	`œq_ü—‹_of_m­pšg
(
´iv
->
¬m_em
, 
¥ec
, 4);

627 
´iv
->
œq
[
em_¦Ù
] = irq;

629 
”r
 = 
	`»que¡_œq
(
œq
, 
nå_¶©_œq
, 0, "nå_¶©", 
ev’t
);

630 ià(
”r
 < 0) {

631 
	`¥š_lock
(&
´iv
->
lock
);

632 
	`þ—r_b™
(
em_¦Ù
, 
´iv
->
œq_u£d
);

633 
	`¥š_uÆock
(&
´iv
->
lock
);

636  
”r
;

637 
	}
}

639 
	$nå_¶©_ev’t_»Ëa£
(
nå_ýp_ev’t
 *
ev’t
)

641 
nå_¶©_ev’t_´iv
 *
ev’t_´iv
 = 
	`nå_ýp_ev’t_´iv
(
ev’t
);

642 
nå_¶©
 *
´iv
 = 
	`nå_ýp_´iv
(
	`nå_ýp_ev’t_ýp
(
ev’t
));

643 
œq
;

645 
	`¥š_lock
(&
´iv
->
lock
);

646 
	`þ—r_b™
(
ev’t_´iv
->
em_¦Ù
, 
´iv
->
œq_u£d
);

647 
œq
 = 
´iv
->œq[
ev’t_´iv
->
em_¦Ù
];

648 
´iv
->
œq
[
ev’t_´iv
->
em_¦Ù
] = -1;

649 
	`¥š_uÆock
(&
´iv
->
lock
);

651 
	`ä“_œq
(
œq
, 
ev’t
);

653 
	`œq_di¥o£_m­pšg
(
œq
);

654 
	}
}

656 
	#NFP_EXPL_POST
 0

	)

657 
	#NFP_EXPL1_BAR
 1

	)

658 
	#NFP_EXPL2_BAR
 2

	)

660 
	snå_¶©_ex¶ic™_´iv
 {

661 
	mšdex
;

664 
	#EXPL_BASE
 0xf800

	)

665 
	#EXPL_INDEX_TO_OFFSET
(
n
è(Òè<< 5)

	)

666 
	#EXPL_INDEX_TO_DATA_REF
(
n
è({ 
u16
 
off£t
 = 
EXPL_BASE
 + \

667 
	`EXPL_INDEX_TO_OFFSET
(
n
); \

668 (
off£t
 & 0x3ff0) | \

669 ((
off£t
 & 0xc000è>> 14); })

	)

670 
	#EXPL_INDEX_TO_SIGNAL_REF
(
n
è(0x60 + (Òè<< 1))

	)

672 
	$nå_¶©_ex¶ic™_acquœe
(
nå_ýp_ex¶ic™
 *
ex¶
)

674 
nå_¶©_ex¶ic™_´iv
 *
ex¶_´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

675 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ex¶ic™_ýp
(
ex¶
);

676 
nå_¶©
 *
´iv
 = 
	`nå_ýp_´iv
(
ýp
);

677 
i
;

680 
i
 = 0; i < 7; i++) {

681 ià(!
	`‹¡_ªd_£t_b™
(
i
, 
´iv
->
ex¶_b¬_mask
)) {

682 
ex¶_´iv
->
šdex
 = 
i
;

687  -
EBUSY
;

688 
	}
}

691 
	$nå_¶©_ex¶ic™_»Ëa£
(
nå_ýp_ex¶ic™
 *
ex¶
)

693 
nå_¶©_ex¶ic™_´iv
 *
ex¶_´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

694 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ex¶ic™_ýp
(
ex¶
);

695 
nå_¶©
 *
´iv
 = 
	`nå_ýp_´iv
(
ýp
);

697 
	`þ—r_b™
(
ex¶_´iv
->
šdex
, 
´iv
->
ex¶_b¬_mask
);

698 
	}
}

701 
	$nå_¶©_ex¶ic™_do
(
nå_ýp_ex¶ic™
 *
ex¶
,

702 cÚ¡ 
nå_ýp_ex¶ic™_commªd
 *
cmd
,

703 
u64
 
add»ss
)

705 
nå_¶©_ex¶ic™_´iv
 *
ex¶_´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

706 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ex¶ic™_ýp
(
ex¶
);

707 
u16
 
sigÇl_ma¡”
, 
d©a_ma¡”
, 
deçuÉ_ma¡”
;

708 
nå_¶©
 *
´iv
 = 
	`nå_ýp_´iv
(
ýp
);

709 
__iomem
 *
ex¶_io
 = 
´iv
->expl_io;

710 
__iomem
 *
gc¤
 = 
´iv
->gcsr;

711 
”r
, 
šdex
 = 
ex¶_´iv
->index;

712 
u32
 
ex¶1
, 
ex¶2
, 
po¡
;

713 
u16
 
d©a_»f
, 
sigÇl_»f
;

714 
u32
 
»quœed
 = 0;

715 
u32
 
mod–
 = 
	`nå_ýp_mod–
(
ýp
);

717 ià(
	`NFP_CPP_MODEL_IS_6000
(
mod–
))

718 
deçuÉ_ma¡”
 = 0x11;

720 
deçuÉ_ma¡”
 = 0x01;

722 ià(
cmd
->
d©a_ma¡”
 == 0)

723 
d©a_ma¡”
 = 
deçuÉ_ma¡”
;

725 
d©a_ma¡”
 = 
cmd
->data_master;

727 ià(
cmd
->
d©a_ma¡”
 =ð0 && cmd->
d©a_»f
 == 0)

728 
d©a_»f
 = 
	`EXPL_INDEX_TO_DATA_REF
(
šdex
);

730 
d©a_»f
 = 
cmd
->data_ref;

732 ià(
cmd
->
sigÇl_ma¡”
 == 0)

733 
sigÇl_ma¡”
 = 
deçuÉ_ma¡”
;

735 
sigÇl_ma¡”
 = 
cmd
->signal_master;

737 ià(
cmd
->
sigÇl_ma¡”
 =ð0 && cmd->
sigÇl_»f
 == 0)

738 
sigÇl_»f
 = 
	`EXPL_INDEX_TO_SIGNAL_REF
(
šdex
);

740 
sigÇl_»f
 = 
cmd
->signal_ref;

742 
ex¶1
 = 
NFP_ARM_GCSR_EXPL1_BAR_POSTED


743 | 
	`NFP_ARM_GCSR_EXPL1_BAR_DATA_MASTER
(
d©a_ma¡”
)

744 | 
	`NFP_ARM_GCSR_EXPL1_BAR_DATA_REF
(
d©a_»f
)

745 | 
	`NFP_ARM_GCSR_EXPL1_BAR_SIGNAL_REF
(
sigÇl_»f
);

747 
ex¶2
 = 
	`NFP_ARM_GCSR_EXPL2_BAR_TGT
(
	`NFP_CPP_ID_TARGET_of
(
cmd
->
ýp_id
))

748 | 
	`NFP_ARM_GCSR_EXPL2_BAR_ACT
(
	`NFP_CPP_ID_ACTION_of
(
cmd
->
ýp_id
))

749 | 
	`NFP_ARM_GCSR_EXPL2_BAR_TOK
(
	`NFP_CPP_ID_TOKEN_of
(
cmd
->
ýp_id
))

750 | 
	`NFP_ARM_GCSR_EXPL2_BAR_LEN
(
cmd
->
Ën
)

751 | 
	`NFP_ARM_GCSR_EXPL2_BAR_BYTE_MASK
(
cmd
->
by‹_mask
)

752 | 
	`NFP_ARM_GCSR_EXPL2_BAR_SIGNAL_MASTER
(
sigÇl_ma¡”
);

754 
po¡
 = 0;

755 ià(
cmd
->
po¡ed
) {

756 
po¡
 = 
NFP_ARM_GCSR_EXPL1_BAR_POSTED


757 | 
	`NFP_ARM_GCSR_EXPL_POST_SIG_A
(
cmd
->
siga
)

758 | 
	`NFP_ARM_GCSR_EXPL_POST_SIG_B
(
cmd
->
sigb
);

760 
cmd
->
siga_mode
) {

761 
NFP_SIGNAL_PUSH
:

763 
»quœed
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_A_RCVD
;

764 
NFP_SIGNAL_PUSH_OPTIONAL
:

765 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_A_VALID
;

766 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PUSH
;

768 
NFP_SIGNAL_PULL
:

769 
»quœed
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_A_RCVD
;

771 
NFP_SIGNAL_PULL_OPTIONAL
:

772 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_A_VALID
;

773 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PULL
;

775 
NFP_SIGNAL_NONE
:

779 
cmd
->
sigb_mode
) {

780 
NFP_SIGNAL_PUSH
:

781 
»quœed
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_B_RCVD
;

783 
NFP_SIGNAL_PUSH_OPTIONAL
:

784 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_B_VALID
;

785 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PUSH
;

787 
NFP_SIGNAL_PULL
:

788 
»quœed
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_B_RCVD
;

790 
NFP_SIGNAL_PULL_OPTIONAL
:

791 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_B_VALID
;

792 
po¡
 |ð
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PULL
;

794 
NFP_SIGNAL_NONE
:

799 ià(
sigÇl_ma¡”
 =ð
deçuÉ_ma¡”
) {

800 
»f
 = 
	`EXPL_INDEX_TO_SIGNAL_REF
(
šdex
);

802 
po¡
 &ð~(
	`NFP_ARM_GCSR_EXPL_POST_SIG_A
(~0) |

803 
	`NFP_ARM_GCSR_EXPL_POST_SIG_B
(~0));

804 
po¡
 |ð
	`NFP_ARM_GCSR_EXPL_POST_SIG_A
(
»f
) |

805 
	`NFP_ARM_GCSR_EXPL_POST_SIG_B
(
»f
 | 1);

809 
	`wr™–
(
	`NFP_ARM_GCSR_EXPL0_BAR_ADDR
(
add»ss
),

810 
gc¤
 + 
	`NFP_ARM_GCSR_EXPL0_BAR
(
šdex
));

812 
	`wr™–
(
ex¶1
, 
gc¤
 + 
	`NFP_ARM_GCSR_EXPL1_BAR
(
šdex
));

815 
	`wr™–
(
ex¶2
, 
gc¤
 + 
	`NFP_ARM_GCSR_EXPL2_BAR
(
šdex
));

818 
	`wr™–
(
po¡
 & ~
NFP_ARM_GCSR_EXPL_POST_CMD_COMPLETE
, 
gc¤
 +

819 
	`NFP_ARM_GCSR_EXPL_POST
(
šdex
));

823 
	`»adb
(
ex¶_io
 + (
NFP_ARM_GCSR_EXPL_SIZE
 * 
šdex
) +

824 (
add»ss
 & (
NFP_ARM_GCSR_EXPL_SIZE
 - 1)));

831 ià(
»quœed
) {

833 
po¡
 = 
	`»adl
(
gc¤
 + 
	`NFP_ARM_GCSR_EXPL_POST
(
šdex
));

834 
po¡
 = 
	`»adl
(
gc¤
 + 
	`NFP_ARM_GCSR_EXPL_POST
(
šdex
));

835 } ((
po¡
 & 
»quœed
) !=„equired));

839 
”r
 = 0;

840 ià(
po¡
 & 
NFP_ARM_GCSR_EXPL_POST_SIG_A_RCVD
)

841 
”r
 |ð
NFP_SIGNAL_MASK_A
;

842 ià(
po¡
 & 
NFP_ARM_GCSR_EXPL_POST_SIG_B_RCVD
)

843 
”r
 |ð
NFP_SIGNAL_MASK_B
;

845  
”r
;

846 
	}
}

849 
	$nå_¶©_ex¶ic™_put
(
nå_ýp_ex¶ic™
 *
ex¶
,

850 cÚ¡ *
buff
, 
size_t
 
Ën
)

852 
nå_¶©_ex¶ic™_´iv
 *
ex¶_´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

853 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ex¶ic™_ýp
(
ex¶
);

854 
nå_¶©
 *
´iv
 = 
	`nå_ýp_´iv
(
ýp
);

856 ià(
Ën
 > 128)

857  -
EINVAL
;

859 
	`memýy
(
´iv
->
ex¶_d©a
 + 
	`EXPL_INDEX_TO_OFFSET
(
ex¶_´iv
->
šdex
),

860 
buff
, 
Ën
);

862  
Ën
;

863 
	}
}

866 
	$nå_¶©_ex¶ic™_g‘
(
nå_ýp_ex¶ic™
 *
ex¶
, *
buff
, 
size_t
 
Ën
)

868 
nå_¶©_ex¶ic™_´iv
 *
ex¶_´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

869 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ex¶ic™_ýp
(
ex¶
);

870 
nå_¶©
 *
´iv
 = 
	`nå_ýp_´iv
(
ýp
);

872 ià(
Ën
 > 128)

873  -
EINVAL
;

875 
	`memýy
(
buff
, 
´iv
->
ex¶_d©a
 + 
	`EXPL_INDEX_TO_OFFSET
(
ex¶_´iv
->
šdex
),

876 
Ën
);

878  
Ën
;

879 
	}
}

881 cÚ¡ 
nå_ýp_Ý”©iÚs
 
	gnå_¶©_Ýs
 = {

882 .
g‘_š‹rçû
 = 
nå_¶©_g‘_š‹rçû
,

884 .
	g¬—_´iv_size
 = (
nå_¶©_¬—_´iv
),

885 .
	g¬—_š™
 = 
nå_¶©_¬—_š™
,

886 .
	g¬—_þ—nup
 = 
nå_¶©_¬—_þ—nup
,

887 .
	g¬—_acquœe
 = 
nå_¶©_acquœe
,

888 .
	g¬—_»Ëa£
 = 
nå_¶©_»Ëa£
,

889 .
	g¬—_phys
 = 
nå_¶©_phys
,

890 .
	g¬—_»sourû
 = 
nå_¶©_»sourû
,

891 .
	g¬—_iomem
 = 
nå_¶©_iomem
,

892 .
	g¬—_»ad
 = 
nå_¶©_»ad
,

893 .
	g¬—_wr™e
 = 
nå_¶©_wr™e
,

895 .
	gex¶ic™_´iv_size
 = (
nå_¶©_ex¶ic™_´iv
),

896 .
	gex¶ic™_acquœe
 = 
nå_¶©_ex¶ic™_acquœe
,

897 .
	gex¶ic™_»Ëa£
 = 
nå_¶©_ex¶ic™_»Ëa£
,

898 .
	gex¶ic™_put
 = 
nå_¶©_ex¶ic™_put
,

899 .
	gex¶ic™_g‘
 = 
nå_¶©_ex¶ic™_g‘
,

900 .
	gex¶ic™_do
 = 
nå_¶©_ex¶ic™_do
,

902 .
	gev’t_´iv_size
 = (
nå_¶©_ev’t_´iv
),

903 .
	gev’t_acquœe
 = 
nå_¶©_ev’t_acquœe
,

904 .
	gev’t_»Ëa£
 = 
nå_¶©_ev’t_»Ëa£
,

907 cÚ¡ 
of_deviû_id
 
	gnå_¶©_m©ch
[] = {

909 .
com·tibË
 = "netronome,nfp6000-arm-cpp",

910 .
	gd©a
 = 
nå_rg‘_pushpuÎ


914 
MODULE_DEVICE_TABLE
(
of
, 
nå_¶©_m©ch
);

916 
	#BARTYPE_EXPA
 1

	)

917 
	#BARTYPE_EXPL
 2

	)

919 
	$nå_¶©_b¬_sÿn
(
nå_¶©
 *
´iv
,

920 
u32
 
¬m_addr
, u32 
¬m_size
,

921 
u32
 
ýp_id
, 
u64
 
ýp_addr
, *
u£d
)

923 
µ
, 
rg‘
, 
aùiÚ
, 
tok’
, 
is_64
;

924 
deviû
 *
dev
 = 
´iv
->dev;

925 
b¬
, 
ty³
 = 0;

926 
u32
 
c¤
;

928 
rg‘
 = 
	`NFP_CPP_ID_TARGET_of
(
ýp_id
);

929 
aùiÚ
 = 
	`NFP_CPP_ID_ACTION_of
(
ýp_id
);

930 
tok’
 = 
	`NFP_CPP_ID_TOKEN_of
(
ýp_id
);

931 
µ
 = 
´iv
->
	`rg‘_pushpuÎ
(
ýp_id
, 
ýp_addr
);

932 
is_64
 = (
	`PUSH_WIDTH
(
µ
) == 8) ? 1 : 0;

934 
¬m_size
) {

936 
b¬
 = 
¬m_addr
 >> 29;

938 ià(
¬m_addr
 & ~0xe0000000) {

939 
	`dev_w¬n
(
dev
, "BULK BAR%d: ARM‡ddress is unaligned, ignoring\n",

940 
b¬
);

941  -
EINVAL
;

944 
	`b¬_lock
(&
´iv
->
bulk_b¬
[
b¬
]);

945 
	`£t_b™
(
b¬
, 
u£d
);

947 ià(
ýp_addr
 & ~0xffe0000000) {

948 
	`dev_w¬n
(
dev
, "BULK BAR%d: CPP‡ddress is unaligned\n",

949 
b¬
);

950  -
EINVAL
;

954 ià(
ýp_id
 == 0) {

955 
´iv
->
bulk_b¬
[
b¬
].
c¤
 = 
	`»adl
Õriv->
gc¤
 +

956 
	`NFP_ARM_GCSR_BULK_BAR
(
b¬
));

957 
	`dev_šfo
(
dev
, "BULK BAR%d: Preserved‡s 0x%08x\n",

958 
b¬
, 
´iv
->
bulk_b¬
[b¬].
c¤
);

962 ià((
ýp_id
 & 0xffffff00) == 0xffffff00) {

963 
ty³
 = 
BARTYPE_EXPA
;

964 
c¤
 = 
	`NFP_ARM_GCSR_BULK_CSR
(1, 0, 0, 0, 0);

965 
	`dev_šfo
(
dev
, "BULK BAR%d: Ex·nsiÚ\n", 
b¬
);

967 
c¤
 = 
	`NFP_ARM_GCSR_BULK_CSR
(0, 
rg‘
, 
tok’
, 
is_64
,

968 
ýp_addr
);

971 
´iv
->
bulk_b¬
[
b¬
].
c¤
 = csr;

972 
	`wr™–
(
c¤
, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
b¬
));

974 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
b¬
));

977 
b¬
 = (
¬m_addr
 >> 25) & 0xf;

979 ià(
¬m_addr
 < 0xc0000000 ||‡rm_addr >= 0xe0000000) {

980 
	`dev_w¬n
(
dev
, "EXPA BAR%d: ARM‡ddress outside of„ange 0x%08x-0x%08x\n",

981 
b¬
, 0xc0000000, 0xde000000);

982  -
EINVAL
;

984 ià(
¬m_addr
 & ~0xfe000000) {

985 
	`dev_w¬n
(
dev
, "EXPA BAR%d: ARM‡ddress is unaligned\n",

986 
b¬
);

987  -
EINVAL
;

990 
	`b¬_lock
(&
´iv
->
ex·_b¬
[
b¬
]);

991 
	`£t_b™
(
b¬
 + 8, 
u£d
);

994 ià(
ýp_id
 == 0) {

995 
´iv
->
ex·_b¬
[
b¬
].
c¤
 = 
	`»adl
Õriv->
gc¤
 +

996 
	`NFP_ARM_GCSR_EXPA_BAR
(
b¬
));

997 
	`dev_šfo
(
dev
, "EXPA BAR%d: Preserved‡s 0x%08x\n",

998 
b¬
, 
´iv
->
ex·_b¬
[b¬].
c¤
);

1002 ià(
ýp_addr
 & ~0xfffe000000) {

1003 
	`dev_w¬n
(
dev
, "EXPA BAR%d: CPP‡ddress is unaligned\n",

1004 
b¬
);

1005  -
EINVAL
;

1008 ià((
ýp_id
 & 0xffffff00) == 0xffffff00) {

1010 
	`dev_w¬n
(
dev
, "EXPA BAR%d: Ex¶ic™\n", 
b¬
);

1011 
ty³
 = 
BARTYPE_EXPL
;

1012 
c¤
 = 
	`NFP_ARM_GCSR_EXPA_CSR
(1, 0, 0, 0, 0, 0);

1014 
c¤
 = 
	`NFP_ARM_GCSR_EXPA_CSR
(0, 
rg‘
, 
aùiÚ
, 
tok’
,

1015 
is_64
, 
ýp_addr
);

1017 
´iv
->
ex·_b¬
[
b¬
].
c¤
 = csr;

1018 
	`wr™–
(
c¤
, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
b¬
));

1020 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
b¬
));

1023 
	`dev_w¬n
(
dev
, "IÎeg® ARM„ªgsiz0x%08x\n", 
¬m_size
);

1027  
ty³
;

1028 
	}
}

1033 
	$nå_¶©_of
(
nå_¶©
 *
´iv
)

1035 
deviû_node
 *
dn
 = 
´iv
->
dev
->
of_node
;

1036 
deviû
 *
dev
 = 
´iv
->dev;

1037 
	`DECLARE_BITMAP
(
u£d
, 8 + 16 + 8);

1038 
´Ý”ty
 *
´Ý
;

1039 
»sourû
 
»s
;

1040 cÚ¡ 
__be32
 *
±r
;

1041 
u32
 
tmp
;

1042 
”r
;

1043 
i
;

1045 
´iv
->
¬m_em
 = 
	`of_œq_fšd_·»Á
(
dn
);

1046 ià(!
´iv
->
¬m_em
) {

1047 
	`dev_”r
(
dev
, "Can't find interrupt…arent\n");

1048  -
EINVAL
;

1052 
i
 = 0; i < 
NFP_EM_FILTER_BASE
; i++)

1053 
	`£t_b™
(
i
, 
´iv
->
œq_u£d
);

1055 ià(
	`of_´Ý”ty_»ad_u32
(
dn
, "#add»ss-ûÎs", &
tmp
) < 0 ||mp != 2) {

1056 
	`dev_”r
(
dev
, "#add»ss-ûÎ <%d> !ð2\n", 
tmp
);

1057  -
EINVAL
;

1060 ià(
	`of_´Ý”ty_»ad_u32
(
dn
, "#size-ûÎs", &
tmp
) < 0 ||mp != 1) {

1061 
	`dev_”r
(
dev
, "#size-ûÎ <%d> !ð1\n", 
tmp
);

1062  -
EINVAL
;

1065 ià(
	`of_add»ss_to_»sourû
(
dn
, 0, &
»s
) < 0) {

1066 
	`dev_”r
(
dev
, "Can't get 'reg'„ange 0 for BULK\n");

1067  -
EINVAL
;

1070 
	`dev_šfo
(
dev
, "BAR © 0x%08x\n", 
»s
.
¡¬t
);

1072 ià(
	`»sourû_size
(&
»s
) < (4 * (8 + 16 + (8 * 4)))) {

1073 
	`dev_”r
(
dev
, "Size of 'reg'„ange 0 isoo small: 0x%x\n",

1074 
	`»sourû_size
(&
»s
));

1075  -
EINVAL
;

1078 
´iv
->
gc¤
 = 
	`of_iom­
(
dn
, 0);

1079 ià(!
´iv
->
gc¤
) {

1080 
	`dev_”r
(
dev
, "Can't maphe 'reg' index 0 ('csr')\n");

1081  -
ENOMEM
;

1084 
	`of_´Ý”ty_fÜ_—ch_u32
(
dn
, "¿nges", 
´Ý
, 
±r
, 
tmp
) {

1085 
u32
 
ýp_id
;

1086 
u64
 
ýp_addr
;

1088 
u32
 
¬m_addr
;

1089 
u32
 
¬m_size
;

1091 
ýp_id
 = 
tmp
 & 0xffffff00;

1092 
ýp_addr
 = (
u64
)(
tmp
 & 0xff) << 32;

1094 
±r
 = 
	`of_´Ý_Ãxt_u32
(
´Ý
,…Œ, &
tmp
);

1095 ià(!
±r
) {

1096 
	`dev_”r
(
dev
, "Property 'ranges' is 3 cells short!\n");

1097 
	`iounm­
(
´iv
->
gc¤
);

1098  -
EINVAL
;

1100 
ýp_addr
 |ð
tmp
;

1102 
±r
 = 
	`of_´Ý_Ãxt_u32
(
´Ý
,…Œ, &
tmp
);

1103 ià(!
±r
) {

1104 
	`dev_”r
(
dev
, "Property 'ranges' is 2 cells short!\n");

1105 
	`iounm­
(
´iv
->
gc¤
);

1106  -
EINVAL
;

1108 
¬m_addr
 = 
tmp
;

1110 
±r
 = 
	`of_´Ý_Ãxt_u32
(
´Ý
,…Œ, &
tmp
);

1111 ià(!
±r
) {

1112 
	`dev_”r
(
dev
, "Property 'ranges' is 1 cell short!\n");

1113 
	`iounm­
(
´iv
->
gc¤
);

1114  -
EINVAL
;

1116 
¬m_size
 = 
tmp
;

1118 
”r
 = 
	`nå_¶©_b¬_sÿn
(
´iv
, 
¬m_addr
, 
¬m_size
,

1119 
ýp_id
, 
ýp_addr
, 
u£d
);

1120 ià(
”r
 < 0) {

1121 
	`iounm­
(
´iv
->
gc¤
);

1122  
”r
;

1124 ià(
”r
 =ð
BARTYPE_EXPL
) {

1125 
´iv
->
ex¶_phys
 = 
¬m_addr
;

1126 
´iv
->
ex¶_size
 = 
¬m_size
;

1130 
´iv
->
ex¶_io
 = 
	`iÜem­
Õriv->
ex¶_phys
,…riv->
ex¶_size
);

1131 ià(!
´iv
->
ex¶_io
) {

1132 
	`iounm­
(
´iv
->
gc¤
);

1133  -
ENOMEM
;

1137 
´iv
->
ex¶_d©a
 = 
	`iÜem­
(
NFP_ARM_START
 + 
EXPL_BASE
, 32 * 7);

1138 ià(!
´iv
->
ex¶_d©a
) {

1139 
	`iounm­
(
´iv
->
ex¶_io
);

1140 
	`iounm­
(
´iv
->
gc¤
);

1141  -
ENOMEM
;

1145 
i
 = 0; i < 8; i++) {

1146 ià(!
	`‹¡_b™
(
i
, 
u£d
)) {

1147 
	`wr™–
(0, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
i
));

1148 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_BULK_BAR
(
i
));

1153 
i
 = 0; i < 16; i++) {

1154 ià(!
	`‹¡_b™
(8 + 
i
, 
u£d
)) {

1155 
	`wr™–
(0, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
i
));

1156 
	`»adl
(
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPA_BAR
(
i
));

1161 
i
 = 0; i < 8; i++) {

1162 ià(!
	`‹¡_b™
(8 + 16 + 
i
, 
u£d
)) {

1163 
	`wr™–
(0, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPL0_BAR
(
i
));

1164 
	`wr™–
(0, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPL1_BAR
(
i
));

1165 
	`wr™–
(0, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPL2_BAR
(
i
));

1166 
	`wr™–
(0, 
´iv
->
gc¤
 + 
	`NFP_ARM_GCSR_EXPL_POST
(
i
));

1171 
	}
}

1173 
	$nå_¶©_´obe
(
¶©fÜm_deviû
 *
pdev
)

1175 cÚ¡ 
of_deviû_id
 *
of_id
;

1176 
i
, 
”r
, 
vnic_un™s
;

1177 
nå_¶©
 *
´iv
;

1178 
u32
 
mod–
;

1180 
of_id
 = 
	`of_m©ch_deviû
(
nå_¶©_m©ch
, &
pdev
->
dev
);

1181 ià(!
of_id
) {

1182 
	`dev_”r
(&
pdev
->
dev
, "Failedo find devtree‚ode\n");

1183  -
EFAULT
;

1186 
´iv
 = 
	`kz®loc
((*´iv), 
GFP_KERNEL
);

1188 
´iv
->
rg‘_pushpuÎ
 = 
of_id
->
d©a
;

1189 
´iv
->
dev
 = &
pdev
->dev;

1190 
	`¥š_lock_š™
(&
´iv
->
lock
);

1192 
”r
 = 
	`nå_¶©_of
(
´iv
);

1193 ià(
”r
 < 0) {

1194 
	`dev_”r
(&
pdev
->
dev
, "Can't initialize device\n");

1195 
	`kä“
(
´iv
);

1196  
”r
;

1201 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
´iv
);

1203 
´iv
->
ýp
 = 
	`nå_ýp_äom_Ý”©iÚs
(&
nå_¶©_Ýs
,…riv->
dev
,…riv);

1204 
	`BUG_ON
(!
´iv
->
ýp
);

1206 
mod–
 = 
	`nå_ýp_mod–
(
´iv
->
ýp
);

1208 ià(
nå_dev_ýp
)

1209 
´iv
->
nå_dev_ýp
 = 
	`nå_¶©fÜm_deviû_»gi¡”
Õriv->
ýp
,

1210 
NFP_DEV_CPP_TYPE
);

1212 ià(
nå_Ãt_vnic
) {

1213 ià(
	`NFP_CPP_MODEL_IS_6000
(
mod–
))

1214 
vnic_un™s
 = 4;

1216 
vnic_un™s
 = 0;

1218 
vnic_un™s
 = 0;

1221 
i
 = 0; i < 
	`ARRAY_SIZE
(
´iv
->
nå_Ãt_vnic
); i++) {

1222 
¶©fÜm_deviû
 *
pdev
;

1224 ià(
i
 >ð
vnic_un™s
)

1227 
pdev
 = 
	`nå_¶©fÜm_deviû_»gi¡”_un™
(
´iv
->
ýp
,

1228 
NFP_NET_VNIC_TYPE
,

1229 
i
, 
NFP_NET_VNIC_UNITS
);

1230 
´iv
->
nå_Ãt_vnic
[
i
] = 
pdev
;

1234 
	}
}

1236 
	$nå_¶©_»move
(
¶©fÜm_deviû
 *
pdev
)

1238 
nå_¶©
 *
´iv
 = 
	`¶©fÜm_g‘_drvd©a
(
pdev
);

1239 
i
;

1241 
i
 = 0; i < 
	`ARRAY_SIZE
(
´iv
->
nå_Ãt_vnic
); i++)

1242 
	`nå_¶©fÜm_deviû_uÄegi¡”
(
´iv
->
nå_Ãt_vnic
[
i
]);

1244 
	`nå_¶©fÜm_deviû_uÄegi¡”
(
´iv
->
nå_dev_ýp
);

1245 
	`nå_ýp_ä“
(
´iv
->
ýp
);

1247 
	`iounm­
(
´iv
->
ex¶_io
);

1248 
	`iounm­
(
´iv
->
ex¶_d©a
);

1249 
	`iounm­
(
´iv
->
gc¤
);

1251 
	`kä“
(
´iv
);

1253 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
NULL
);

1256 
	}
}

1258 
¶©fÜm_driv”
 
	gnå_¶©_driv”
 = {

1259 .
´obe
 = 
nå_¶©_´obe
,

1260 .
	g»move
 = 
__ex™_p
(
nå_¶©_»move
),

1261 .
	gdriv”
 = {

1262 .
Çme
 = "nfp_plat",

1263 .
	gof_m©ch_bË
 = 
of_m©ch_±r
(
nå_¶©_m©ch
),

1264 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 11, 0)

1265 .
	gowÃr
 = 
THIS_MODULE
,

1273 
	$nå_¶©_š™
()

1275  
	`¶©fÜm_driv”_»gi¡”
(&
nå_¶©_driv”
);

1276 
	}
}

1281 
	$nå_¶©_ex™
()

1283 
	`¶©fÜm_driv”_uÄegi¡”
(&
nå_¶©_driv”
);

1284 
	}
}

	@src/nfp_port.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/lockd•.h
>

7 
	~<lšux/Ãtdeviû.h
>

8 #ià
COMPAT__HAVE_SWITCHDEV_ATTRS


9 
	~<Ãt/sw™chdev.h
>

12 
	~"nåcÜe/nå_ýp.h
"

13 
	~"nåcÜe/nå_n¥.h
"

14 
	~"nå_­p.h
"

15 
	~"nå_maš.h
"

16 
	~"nå_Ãt.h
"

17 
	~"nå_pÜt.h
"

19 
nå_pÜt
 *
	$nå_pÜt_äom_Ãtdev
(
Ãt_deviû
 *
Ãtdev
)

21 ià(
	`nå_Ãtdev_is_nå_Ãt
(
Ãtdev
)) {

22 
nå_Ãt
 *
Â
 = 
	`Ãtdev_´iv
(
Ãtdev
);

24  
Â
->
pÜt
;

27 ià(
	`nå_Ãtdev_is_nå_»´
(
Ãtdev
)) {

28 
nå_»´
 *
»´
 = 
	`Ãtdev_´iv
(
Ãtdev
);

30  
»´
->
pÜt
;

33 
	`WARN
(1, "Unknown‚etdevype for‚fp_port\n");

35  
NULL
;

36 
	}
}

38 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(5, 1, 0)

40 
	$nå_pÜt_©Œ_g‘
(
Ãt_deviû
 *
Ãtdev
, 
sw™chdev_©Œ
 *
©Œ
)

42 
nå_pÜt
 *
pÜt
;

44 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

45 ià(!
pÜt
)

46  -
EOPNOTSUPP
;

48 
©Œ
->
id
) {

49 
SWITCHDEV_ATTR_ID_PORT_PARENT_ID
: {

50 cÚ¡ 
u8
 *
£rŸl
;

52 
©Œ
->
u
.
µid
.
id_Ën
 = 
	`nå_ýp_£rŸl
(
pÜt
->
­p
->
ýp
, &
£rŸl
);

53 
	`memýy
(&
©Œ
->
u
.
µid
.
id
, 
£rŸl
,‡‰r->u.µid.
id_Ën
);

57  -
EOPNOTSUPP
;

61 
	}
}

63 cÚ¡ 
sw™chdev_Ýs
 
	gnå_pÜt_sw™chdev_Ýs
 = {

64 .
sw™chdev_pÜt_©Œ_g‘
 = 
nå_pÜt_©Œ_g‘
,

67 
	$nå_pÜt_g‘_pÜt_·»Á_id
(
Ãt_deviû
 *
Ãtdev
,

68 
Ãtdev_phys_™em_id
 *
µid
)

70 
nå_pÜt
 *
pÜt
;

71 cÚ¡ 
u8
 *
£rŸl
;

73 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

74 ià(!
pÜt
)

75  -
EOPNOTSUPP
;

77 
µid
->
id_Ën
 = 
	`nå_ýp_£rŸl
(
pÜt
->
­p
->
ýp
, &
£rŸl
);

78 
	`memýy
(&
µid
->
id
, 
£rŸl
,…pid->
id_Ën
);

81 
	}
}

84 #ià
VER_NON_RHEL_GE
(4, 13è|| 
VER_RHEL_GE
(7, 5)

85 #ià
VER_NON_RHEL_GE
(4, 14è|| 
VER_RHEL_GE
(7, 5)

86 
	$nå_pÜt_£tup_tc
(
Ãt_deviû
 *
Ãtdev
, 
tc_£tup_ty³
 
ty³
,

87 *
ty³_d©a
)

89 
	$nå_pÜt_£tup_tc
(
Ãt_deviû
 *
Ãtdev
, 
u32
 
hªdË
, u32 
chaš_šdex
,

90 
__be16
 
´Ùo
, 
tc_to_Ãtdev
 *
tc
)

93 
nå_pÜt
 *
pÜt
;

95 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

96 ià(!
pÜt
)

97  -
EOPNOTSUPP
;

99 #ià
	`VER_NON_RHEL_LT
(4, 14)

100 ià(
	`TC_H_MAJ
(
hªdË
è!ðTC_H_MAJ(
TC_H_INGRESS
è|| 
chaš_šdex
 ||

101 (
tc
->
ty³
 =ð
TC_SETUP_CLSFLOWER
 && !
	`‘h_´Ùo_is_802_3
(
´Ùo
)))

102  -
EOPNOTSUPP
;

104  
	`nå_­p_£tup_tc
(
pÜt
->
­p
, 
Ãtdev
, 
tc
->
ty³
,c->
þs_bpf
);

106  
	`nå_­p_£tup_tc
(
pÜt
->
­p
, 
Ãtdev
, 
ty³
, 
ty³_d©a
);

108 
	}
}

111 
	$nå_pÜt_£t_ã©u»s
(
Ãt_deviû
 *
Ãtdev
, 
Ãtdev_ã©u»s_t
 
ã©u»s
)

113 
nå_pÜt
 *
pÜt
;

115 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

116 ià(!
pÜt
)

119 ià((
Ãtdev
->
ã©u»s
 & 
NETIF_F_HW_TC
) > (features & NETIF_F_HW_TC) &&

120 
pÜt
->
tc_ofæßd_út
) {

121 
	`Ãtdev_”r
(
Ãtdev
, "Cannot disable HW TC offload while offloads‡ctive\n");

122  -
EBUSY
;

126 
	}
}

128 
nå_pÜt
 *

129 
	$nå_pÜt_äom_id
(
nå_pf
 *
pf
, 
nå_pÜt_ty³
 
ty³
, 
id
)

131 
nå_pÜt
 *
pÜt
;

133 
	`lockd•_as£¹_h–d
(&
pf
->
lock
);

135 ià(
ty³
 !ð
NFP_PORT_PHYS_PORT
)

136  
NULL
;

138 
	`li¡_fÜ_—ch_’Œy
(
pÜt
, &
pf
->
pÜts
, 
pÜt_li¡
)

139 ià(
pÜt
->
‘h_id
 =ð
id
)

140  
pÜt
;

142  
NULL
;

143 
	}
}

145 
nå_‘h_bË_pÜt
 *
	$__nå_pÜt_g‘_‘h_pÜt
(
nå_pÜt
 *
pÜt
)

147 ià(!
pÜt
)

148  
NULL
;

149 ià(
pÜt
->
ty³
 !ð
NFP_PORT_PHYS_PORT
)

150  
NULL
;

152  
pÜt
->
‘h_pÜt
;

153 
	}
}

155 
nå_‘h_bË_pÜt
 *
	$nå_pÜt_g‘_‘h_pÜt
(
nå_pÜt
 *
pÜt
)

157 ià(!
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
))

158  
NULL
;

160 ià(
	`‹¡_b™
(
NFP_PORT_CHANGED
, &
pÜt
->
æags
))

161 ià(
	`nå_Ãt_»äesh_‘h_pÜt
(
pÜt
))

162  
NULL
;

164  
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

165 
	}
}

168 
	$nå_pÜt_g‘_phys_pÜt_Çme
(
Ãt_deviû
 *
Ãtdev
, *
Çme
, 
size_t
 
Ën
)

170 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

171 
nå_pÜt
 *
pÜt
;

172 
n
;

174 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

175 ià(!
pÜt
)

176  -
EOPNOTSUPP
;

178 
pÜt
->
ty³
) {

179 
NFP_PORT_PHYS_PORT
:

180 
‘h_pÜt
 = 
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

181 ià(!
‘h_pÜt
)

182  -
EOPNOTSUPP
;

184 ià(!
‘h_pÜt
->
is_¥l™
)

185 
n
 = 
	`¢´štf
(
Çme
, 
Ën
, "p%d", 
‘h_pÜt
->
Ïb–_pÜt
);

187 
n
 = 
	`¢´štf
(
Çme
, 
Ën
, "p%ds%d", 
‘h_pÜt
->
Ïb–_pÜt
,

188 
‘h_pÜt
->
Ïb–_subpÜt
);

190 
NFP_PORT_PF_PORT
:

191 ià(!
pÜt
->
pf_¥l™
)

192 
n
 = 
	`¢´štf
(
Çme
, 
Ën
, "pf%d", 
pÜt
->
pf_id
);

194 
n
 = 
	`¢´štf
(
Çme
, 
Ën
, "pf%ds%d", 
pÜt
->
pf_id
,

195 
pÜt
->
pf_¥l™_id
);

197 
NFP_PORT_VF_PORT
:

198 
n
 = 
	`¢´štf
(
Çme
, 
Ën
, "pf%dvf%d", 
pÜt
->
pf_id
,…Üt->
vf_id
);

201  -
EOPNOTSUPP
;

204 ià(
n
 >ð
Ën
)

205  -
EINVAL
;

208 
	}
}

222 
	$nå_pÜt_cÚfigu»
(
Ãt_deviû
 *
Ãtdev
, 
boÞ
 
cÚfiged
)

224 
nå_‘h_bË_pÜt
 *
‘h_pÜt
;

225 
nå_pÜt
 *
pÜt
;

226 
”r
;

228 
pÜt
 = 
	`nå_pÜt_äom_Ãtdev
(
Ãtdev
);

229 
‘h_pÜt
 = 
	`__nå_pÜt_g‘_‘h_pÜt
(
pÜt
);

230 ià(!
‘h_pÜt
)

232 ià(
pÜt
->
‘h_fÜûd
)

235 
”r
 = 
	`nå_‘h_£t_cÚfigu»d
(
pÜt
->
­p
->
ýp
, 
‘h_pÜt
->
šdex
, 
cÚfiged
);

236  
”r
 < 0 &&ƒ¼ !ð-
EOPNOTSUPP
 ?ƒrr : 0;

237 
	}
}

239 #ifdeà
CONFIG_NFP_NET_PF


240 
	$nå_pÜt_š™_phy_pÜt
(
nå_pf
 *
pf
, 
nå_­p
 *
­p
,

241 
nå_pÜt
 *
pÜt
, 
id
)

244 ià(!
pf
->
‘h_tbl
 || 
id
 >ðpf->‘h_tbl->
couÁ
) {

245 
	`nå_”r
(
­p
->
ýp
,

247 
id
);

248  -
EINVAL
;

250 ià(
pf
->
‘h_tbl
->
pÜts
[
id
].
ov”ride_chªged
) {

251 
	`nå_w¬n
(
­p
->
ýp
,

253 
pf
->
‘h_tbl
->
pÜts
[
id
].
šdex
);

254 
pÜt
->
ty³
 = 
NFP_PORT_INVALID
;

258 
pÜt
->
‘h_pÜt
 = &
pf
->
‘h_tbl
->
pÜts
[
id
];

259 
pÜt
->
‘h_id
 = 
pf
->
‘h_tbl
->
pÜts
[
id
].
šdex
;

260 ià(
pf
->
mac_¡©s_mem
)

261 
pÜt
->
‘h_¡©s
 =

262 
pf
->
mac_¡©s_mem
 + 
pÜt
->
‘h_id
 * 
NFP_MAC_STATS_SIZE
;

265 
	}
}

267 
nå_pÜt
 *

268 
	$nå_pÜt_®loc
(
nå_­p
 *
­p
, 
nå_pÜt_ty³
 
ty³
,

269 
Ãt_deviû
 *
Ãtdev
)

271 
nå_pÜt
 *
pÜt
;

273 
pÜt
 = 
	`kz®loc
((*pÜt), 
GFP_KERNEL
);

274 ià(!
pÜt
)

275  
	`ERR_PTR
(-
ENOMEM
);

277 
pÜt
->
Ãtdev
 =‚etdev;

278 
pÜt
->
ty³
 =ype;

279 
pÜt
->
­p
 =‡pp;

281 
	`li¡_add_ž
(&
pÜt
->
pÜt_li¡
, &
­p
->
pf
->
pÜts
);

283  
pÜt
;

284 
	}
}

286 
	$nå_pÜt_ä“
(
nå_pÜt
 *
pÜt
)

288 ià(!
pÜt
)

290 
	`li¡_d–
(&
pÜt
->
pÜt_li¡
);

291 
	`kä“
(
pÜt
);

292 
	}
}

	@src/nfp_port.h

4 #iâdeà
_NFP_PORT_H_


5 
	#_NFP_PORT_H_


	)

7 
	~"nå_Ãt_com·t.h
"

9 #ià
COMPAT__HAS_DEVLINK


10 
	~<Ãt/devlšk.h
>

13 
	gÃt_deviû
;

14 
	gÃtdev_phys_™em_id
;

15 
	gnå_­p
;

16 
	gnå_pf
;

17 
	gnå_pÜt
;

28 
	enå_pÜt_ty³
 {

29 
	mNFP_PORT_INVALID
,

30 
	mNFP_PORT_PHYS_PORT
,

31 
	mNFP_PORT_PF_PORT
,

32 
	mNFP_PORT_VF_PORT
,

41 
	enå_pÜt_æags
 {

42 
	mNFP_PORT_CHANGED
 = 0,

65 
	snå_pÜt
 {

66 
Ãt_deviû
 *
	mÃtdev
;

67 
nå_pÜt_ty³
 
	mty³
;

69 
	mæags
;

70 
	mtc_ofæßd_út
;

72 
nå_­p
 *
	m­p
;

74 
devlšk_pÜt
 
	mdl_pÜt
;

79 
	m‘h_id
;

80 
boÞ
 
	m‘h_fÜûd
;

81 
nå_‘h_bË_pÜt
 *
	m‘h_pÜt
;

82 
u8
 
__iomem
 *
	m‘h_¡©s
;

86 
	mpf_id
;

87 
	mvf_id
;

88 
boÞ
 
	mpf_¥l™
;

89 
	mpf_¥l™_id
;

90 
u8
 
__iomem
 *
	mvnic
;

94 
li¡_h—d
 
	mpÜt_li¡
;

97 cÚ¡ 
‘htoÞ_Ýs
 
nå_pÜt_‘htoÞ_Ýs
;

98 cÚ¡ 
sw™chdev_Ýs
 
nå_pÜt_sw™chdev_Ýs
;

100 
	$__´štf
(2, 3è
u8
 *
	`nå_´_‘
(u8 *
d©a
, cÚ¡ *
fmt
, ...);

102 #ià
	`VER_NON_RHEL_GE
(4, 14è|| 
	`VER_RHEL_GE
(7, 5)

103 
	`nå_pÜt_£tup_tc
(
Ãt_deviû
 *
Ãtdev
, 
tc_£tup_ty³
 
ty³
,

104 *
ty³_d©a
);

106 
	`nå_pÜt_£tup_tc
(
Ãt_deviû
 *
Ãtdev
, 
u32
 
hªdË
, u32 
chaš_šdex
,

107 
__be16
 
´Ùo
, 
tc_to_Ãtdev
 *
tc
);

110 
šlše
 
boÞ
 
	$nå_pÜt_is_vnic
(cÚ¡ 
nå_pÜt
 *
pÜt
)

112  
pÜt
->
ty³
 =ð
NFP_PORT_PF_PORT
 ||…Üt->ty³ =ð
NFP_PORT_VF_PORT
;

113 
	}
}

116 
nå_pÜt_£t_ã©u»s
(
Ãt_deviû
 *
Ãtdev
, 
Ãtdev_ã©u»s_t
 
ã©u»s
);

118 
nå_pÜt
 *
nå_pÜt_äom_Ãtdev
(
Ãt_deviû
 *
Ãtdev
);

119 
nå_pÜt_g‘_pÜt_·»Á_id
(
Ãt_deviû
 *
Ãtdev
,

120 
Ãtdev_phys_™em_id
 *
µid
);

121 
nå_pÜt
 *

122 
nå_pÜt_äom_id
(
nå_pf
 *
pf
, 
nå_pÜt_ty³
 
ty³
, 
id
);

123 
nå_‘h_bË_pÜt
 *
__nå_pÜt_g‘_‘h_pÜt
(
nå_pÜt
 *
pÜt
);

124 
nå_‘h_bË_pÜt
 *
nå_pÜt_g‘_‘h_pÜt
(
nå_pÜt
 *
pÜt
);

127 
nå_pÜt_g‘_phys_pÜt_Çme
(
Ãt_deviû
 *
Ãtdev
, *
Çme
, 
size_t
 
Ën
);

128 
nå_pÜt_cÚfigu»
(
Ãt_deviû
 *
Ãtdev
, 
boÞ
 
cÚfiged
);

130 
nå_pÜt
 *

131 
nå_pÜt_®loc
(
nå_­p
 *
­p
, 
nå_pÜt_ty³
 
ty³
,

132 
Ãt_deviû
 *
Ãtdev
);

133 
nå_pÜt_ä“
(
nå_pÜt
 *
pÜt
);

135 
nå_pÜt_š™_phy_pÜt
(
nå_pf
 *
pf
, 
nå_­p
 *
­p
,

136 
nå_pÜt
 *
pÜt
, 
id
);

138 #ifdeà
CONFIG_NFP_NET_PF


139 
nå_Ãt_»äesh_‘h_pÜt
(
nå_pÜt
 *
pÜt
);

140 
nå_Ãt_»äesh_pÜt_bË
(
nå_pÜt
 *
pÜt
);

141 
nå_Ãt_»äesh_pÜt_bË_sync
(
nå_pf
 *
pf
);

143 
šlše
 
	$nå_Ãt_»äesh_‘h_pÜt
(
nå_pÜt
 *
pÜt
)

145  -
ENODEV
;

146 
	}
}

148 
šlše
 
	$nå_Ãt_»äesh_pÜt_bË
(
nå_pÜt
 *
pÜt
)

150 
	}
}

153 #ià
COMPAT__HAS_DEVLINK


154 
nå_devlšk_pÜt_»gi¡”
(
nå_­p
 *
­p
, 
nå_pÜt
 *
pÜt
);

155 
nå_devlšk_pÜt_uÄegi¡”
(
nå_pÜt
 *
pÜt
);

156 
nå_devlšk_pÜt_ty³_‘h_£t
(
nå_pÜt
 *
pÜt
);

157 
nå_devlšk_pÜt_ty³_þ—r
(
nå_pÜt
 *
pÜt
);

159 
šlše
 

160 
	$nå_devlšk_pÜt_»gi¡”
(
nå_­p
 *
­p
, 
nå_pÜt
 *
pÜt
)

163 
	}
}

165 
šlše
 
	$nå_devlšk_pÜt_uÄegi¡”
(
nå_pÜt
 *
pÜt
)

167 
	}
}

169 
šlše
 
	$nå_devlšk_pÜt_ty³_‘h_£t
(
nå_pÜt
 *
pÜt
)

171 
	}
}

173 
šlše
 
	$nå_devlšk_pÜt_ty³_þ—r
(
nå_pÜt
 *
pÜt
)

175 
	}
}

182 
	#NFP_MAC_STATS_BASE
 0x0000

	)

183 
	#NFP_MAC_STATS_SIZE
 0x0200

	)

185 
	#NFP_MAC_STATS_RX_IN_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x000)

	)

187 
	#NFP_MAC_STATS_RX_FRAME_TOO_LONG_ERRORS
 (
NFP_MAC_STATS_BASE
 + 0x010)

	)

188 
	#NFP_MAC_STATS_RX_RANGE_LENGTH_ERRORS
 (
NFP_MAC_STATS_BASE
 + 0x018)

	)

189 
	#NFP_MAC_STATS_RX_VLAN_RECEIVED_OK
 (
NFP_MAC_STATS_BASE
 + 0x020)

	)

190 
	#NFP_MAC_STATS_RX_IN_ERRORS
 (
NFP_MAC_STATS_BASE
 + 0x028)

	)

191 
	#NFP_MAC_STATS_RX_IN_BROADCAST_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x030)

	)

192 
	#NFP_MAC_STATS_RX_DROP_EVENTS
 (
NFP_MAC_STATS_BASE
 + 0x038)

	)

193 
	#NFP_MAC_STATS_RX_ALIGNMENT_ERRORS
 (
NFP_MAC_STATS_BASE
 + 0x040)

	)

194 
	#NFP_MAC_STATS_RX_PAUSE_MAC_CTRL_FRAMES
 (
NFP_MAC_STATS_BASE
 + 0x048)

	)

195 
	#NFP_MAC_STATS_RX_FRAMES_RECEIVED_OK
 (
NFP_MAC_STATS_BASE
 + 0x050)

	)

196 
	#NFP_MAC_STATS_RX_FRAME_CHECK_SEQUENCE_ERRORS
 (
NFP_MAC_STATS_BASE
 + 0x058)

	)

197 
	#NFP_MAC_STATS_RX_UNICAST_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x060)

	)

198 
	#NFP_MAC_STATS_RX_MULTICAST_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x068)

	)

199 
	#NFP_MAC_STATS_RX_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x070)

	)

200 
	#NFP_MAC_STATS_RX_UNDERSIZE_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x078)

	)

201 
	#NFP_MAC_STATS_RX_PKTS_64_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x080)

	)

202 
	#NFP_MAC_STATS_RX_PKTS_65_TO_127_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x088)

	)

203 
	#NFP_MAC_STATS_RX_PKTS_512_TO_1023_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x090)

	)

204 
	#NFP_MAC_STATS_RX_PKTS_1024_TO_1518_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x098)

	)

205 
	#NFP_MAC_STATS_RX_JABBERS
 (
NFP_MAC_STATS_BASE
 + 0x0a0)

	)

206 
	#NFP_MAC_STATS_RX_FRAGMENTS
 (
NFP_MAC_STATS_BASE
 + 0x0a8)

	)

207 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS2
 (
NFP_MAC_STATS_BASE
 + 0x0b0)

	)

208 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS3
 (
NFP_MAC_STATS_BASE
 + 0x0b8)

	)

209 
	#NFP_MAC_STATS_RX_PKTS_128_TO_255_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x0c0)

	)

210 
	#NFP_MAC_STATS_RX_PKTS_256_TO_511_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x0c8)

	)

211 
	#NFP_MAC_STATS_RX_PKTS_1519_TO_MAX_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x0d0)

	)

212 
	#NFP_MAC_STATS_RX_OVERSIZE_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x0d8)

	)

213 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS0
 (
NFP_MAC_STATS_BASE
 + 0x0e0)

	)

214 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS1
 (
NFP_MAC_STATS_BASE
 + 0x0e8)

	)

215 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS4
 (
NFP_MAC_STATS_BASE
 + 0x0f0)

	)

216 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS5
 (
NFP_MAC_STATS_BASE
 + 0x0f8)

	)

217 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS6
 (
NFP_MAC_STATS_BASE
 + 0x100)

	)

218 
	#NFP_MAC_STATS_RX_PAUSE_FRAMES_CLASS7
 (
NFP_MAC_STATS_BASE
 + 0x108)

	)

219 
	#NFP_MAC_STATS_RX_MAC_CTRL_FRAMES_RECEIVED
 (
NFP_MAC_STATS_BASE
 + 0x110)

	)

220 
	#NFP_MAC_STATS_RX_MAC_HEAD_DROP
 (
NFP_MAC_STATS_BASE
 + 0x118)

	)

224 
	#NFP_MAC_STATS_TX_QUEUE_DROP
 (
NFP_MAC_STATS_BASE
 + 0x138)

	)

225 
	#NFP_MAC_STATS_TX_OUT_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x140)

	)

227 
	#NFP_MAC_STATS_TX_VLAN_TRANSMITTED_OK
 (
NFP_MAC_STATS_BASE
 + 0x150)

	)

228 
	#NFP_MAC_STATS_TX_OUT_ERRORS
 (
NFP_MAC_STATS_BASE
 + 0x158)

	)

229 
	#NFP_MAC_STATS_TX_BROADCAST_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x160)

	)

230 
	#NFP_MAC_STATS_TX_PKTS_64_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x168)

	)

231 
	#NFP_MAC_STATS_TX_PKTS_256_TO_511_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x170)

	)

232 
	#NFP_MAC_STATS_TX_PKTS_512_TO_1023_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x178)

	)

233 
	#NFP_MAC_STATS_TX_PAUSE_MAC_CTRL_FRAMES
 (
NFP_MAC_STATS_BASE
 + 0x180)

	)

234 
	#NFP_MAC_STATS_TX_FRAMES_TRANSMITTED_OK
 (
NFP_MAC_STATS_BASE
 + 0x188)

	)

235 
	#NFP_MAC_STATS_TX_UNICAST_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x190)

	)

236 
	#NFP_MAC_STATS_TX_MULTICAST_PKTS
 (
NFP_MAC_STATS_BASE
 + 0x198)

	)

237 
	#NFP_MAC_STATS_TX_PKTS_65_TO_127_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x1a0)

	)

238 
	#NFP_MAC_STATS_TX_PKTS_128_TO_255_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x1a8)

	)

239 
	#NFP_MAC_STATS_TX_PKTS_1024_TO_1518_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x1b0)

	)

240 
	#NFP_MAC_STATS_TX_PKTS_1519_TO_MAX_OCTETS
 (
NFP_MAC_STATS_BASE
 + 0x1b8)

	)

241 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS0
 (
NFP_MAC_STATS_BASE
 + 0x1c0)

	)

242 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS1
 (
NFP_MAC_STATS_BASE
 + 0x1c8)

	)

243 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS4
 (
NFP_MAC_STATS_BASE
 + 0x1d0)

	)

244 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS5
 (
NFP_MAC_STATS_BASE
 + 0x1d8)

	)

245 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS2
 (
NFP_MAC_STATS_BASE
 + 0x1e0)

	)

246 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS3
 (
NFP_MAC_STATS_BASE
 + 0x1e8)

	)

247 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS6
 (
NFP_MAC_STATS_BASE
 + 0x1f0)

	)

248 
	#NFP_MAC_STATS_TX_PAUSE_FRAMES_CLASS7
 (
NFP_MAC_STATS_BASE
 + 0x1f8)

	)

	@src/nfp_shared_buf.c

4 
	~<lšux/k”Ãl.h
>

5 
	~<Ãt/devlšk.h
>

7 
	~"nåcÜe/nå_ýp.h
"

8 
	~"nåcÜe/nå_nffw.h
"

9 
	~"nå_abi.h
"

10 
	~"nå_­p.h
"

11 
	~"nå_maš.h
"

13 
u32
 
	$nå_sh¬ed_buf_poÞ_un™
(
nå_pf
 *
pf
, 
sb
)

15 
__Ë32
 
sb_id
 = 
	`ýu_to_Ë32
(
sb
);

16 
i
;

18 
i
 = 0; i < 
pf
->
num_sh¬ed_bufs
; i++)

19 ià(
pf
->
sh¬ed_bufs
[
i
].
id
 =ð
sb_id
)

20  
	`Ë32_to_ýu
(
pf
->
sh¬ed_bufs
[
i
].
poÞ_size_un™
);

22 
	`WARN_ON_ONCE
(1);

24 
	}
}

26 
	$nå_sh¬ed_buf_poÞ_g‘
(
nå_pf
 *
pf
, 
sb
, 
u16
 
poÞ_šdex
,

27 
devlšk_sb_poÞ_šfo
 *
poÞ_šfo
)

29 
nå_sh¬ed_buf_poÞ_šfo_g‘
 
g‘_d©a
;

30 
nå_sh¬ed_buf_poÞ_id
 
id
 = {

31 .
sh¬ed_buf
 = 
	`ýu_to_Ë32
(
sb
),

32 .
poÞ
 = 
	`ýu_to_Ë32
(
poÞ_šdex
),

34 
un™_size
;

35 
n
;

37 
un™_size
 = 
	`nå_sh¬ed_buf_poÞ_un™
(
pf
, 
sb
);

38 ià(!
un™_size
)

39  -
EINVAL
;

41 
n
 = 
	`nå_mbox_cmd
(
pf
, 
NFP_MBOX_POOL_GET
, &
id
, (id),

42 &
g‘_d©a
, (get_data));

43 ià(
n
 < 0)

44  
n
;

45 ià(
n
 < (
g‘_d©a
))

46  -
EIO
;

48 
poÞ_šfo
->
poÞ_ty³
 = 
	`Ë32_to_ýu
(
g‘_d©a
.pool_type);

49 
poÞ_šfo
->
th»shÞd_ty³
 = 
	`Ë32_to_ýu
(
g‘_d©a
.threshold_type);

50 
poÞ_šfo
->
size
 = 
	`Ë32_to_ýu
(
g‘_d©a
.sizeè* 
un™_size
;

51 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(5, 1, 0)

52 
poÞ_šfo
->
ûÎ_size
 = 
un™_size
;

56 
	}
}

58 
	$nå_sh¬ed_buf_poÞ_£t
(
nå_pf
 *
pf
, 
sb
,

59 
u16
 
poÞ_šdex
, 
u32
 
size
,

60 
devlšk_sb_th»shÞd_ty³
 
th»shÞd_ty³
)

62 
nå_sh¬ed_buf_poÞ_šfo_£t
 
£t_d©a
 = {

63 .
id
 = {

64 .
sh¬ed_buf
 = 
	`ýu_to_Ë32
(
sb
),

65 .
poÞ
 = 
	`ýu_to_Ë32
(
poÞ_šdex
),

67 .
th»shÞd_ty³
 = 
	`ýu_to_Ë32
(threshold_type),

69 
un™_size
;

71 
un™_size
 = 
	`nå_sh¬ed_buf_poÞ_un™
(
pf
, 
sb
);

72 ià(!
un™_size
 || 
size
 % unit_size)

73  -
EINVAL
;

74 
£t_d©a
.
size
 = 
	`ýu_to_Ë32
(siz/ 
un™_size
);

76  
	`nå_mbox_cmd
(
pf
, 
NFP_MBOX_POOL_SET
, &
£t_d©a
, (set_data),

77 
NULL
, 0);

78 
	}
}

80 
	$nå_sh¬ed_buf_»gi¡”
(
nå_pf
 *
pf
)

82 
devlšk
 *devlšk = 
	`´iv_to_devlšk
(
pf
);

83 
i
, 
num_’Œ›s
, 
’Œy_sz
;

84 
nå_ýp_¬—
 *
sb_desc_¬—
;

85 
u8
 
__iomem
 *
sb_desc
;

86 
n
, 
”r
;

88 ià(!
pf
->
mbox
)

91 
n
 = 
	`nå_pf_¹sym_»ad_ÝtiÚ®
(
pf
, 
NFP_SHARED_BUF_COUNT_SYM_NAME
, 0);

92 ià(
n
 <= 0)

93  
n
;

94 
num_’Œ›s
 = 
n
;

96 
sb_desc
 = 
	`nå_pf_m­_¹sym
(
pf
, "sb_tbl", 
NFP_SHARED_BUF_TABLE_SYM_NAME
,

97 
num_’Œ›s
 * (
pf
->
sh¬ed_bufs
[0]),

98 &
sb_desc_¬—
);

99 ià(
	`IS_ERR
(
sb_desc
))

100  
	`PTR_ERR
(
sb_desc
);

102 
’Œy_sz
 = 
	`nå_ýp_¬—_size
(
sb_desc_¬—
è/ 
num_’Œ›s
;

104 
pf
->
sh¬ed_bufs
 = 
	`km®loc_¬¿y
(
num_’Œ›s
, (pf->shared_bufs[0]),

105 
GFP_KERNEL
);

106 ià(!
pf
->
sh¬ed_bufs
) {

107 
”r
 = -
ENOMEM
;

108 
”r_»Ëa£_¬—
;

111 
i
 = 0; i < 
num_’Œ›s
; i++) {

112 
nå_sh¬ed_buf
 *
sb
 = &
pf
->
sh¬ed_bufs
[
i
];

115 
	`memýy_äomio
(
sb
, 
sb_desc
 + 
i
 * 
’Œy_sz
, (*sb));

117 
”r
 = 
	`devlšk_sb_»gi¡”
(
devlšk
,

118 
	`Ë32_to_ýu
(
sb
->
id
),

119 
	`Ë32_to_ýu
(
sb
->
size
),

120 
	`Ë16_to_ýu
(
sb
->
šg»ss_poÞs_couÁ
),

121 
	`Ë16_to_ýu
(
sb
->
eg»ss_poÞs_couÁ
),

122 
	`Ë16_to_ýu
(
sb
->
šg»ss_tc_couÁ
),

123 
	`Ë16_to_ýu
(
sb
->
eg»ss_tc_couÁ
));

124 ià(
”r
)

125 
”r_uÄeg_´ev
;

127 
pf
->
num_sh¬ed_bufs
 = 
num_’Œ›s
;

129 
	`nå_ýp_¬—_»Ëa£_ä“
(
sb_desc_¬—
);

133 
”r_uÄeg_´ev
:

134 
i
--)

135 
	`devlšk_sb_uÄegi¡”
(
devlšk
,

136 
	`Ë32_to_ýu
(
pf
->
sh¬ed_bufs
[
i
].
id
));

137 
	`kä“
(
pf
->
sh¬ed_bufs
);

138 
”r_»Ëa£_¬—
:

139 
	`nå_ýp_¬—_»Ëa£_ä“
(
sb_desc_¬—
);

140  
”r
;

141 
	}
}

143 
	$nå_sh¬ed_buf_uÄegi¡”
(
nå_pf
 *
pf
)

145 
devlšk
 *devlšk = 
	`´iv_to_devlšk
(
pf
);

146 
i
;

148 
i
 = 0; i < 
pf
->
num_sh¬ed_bufs
; i++)

149 
	`devlšk_sb_uÄegi¡”
(
devlšk
,

150 
	`Ë32_to_ýu
(
pf
->
sh¬ed_bufs
[
i
].
id
));

151 
	`kä“
(
pf
->
sh¬ed_bufs
);

152 
	}
}

	@src/nfp_test_harness.h

4 #iâdeà
NFP_TEST_HARNESS_H


5 
	#NFP_TEST_HARNESS_H
 1

	)

7 
	~<lšux/li¡.h
>

8 
	~<lšux/mu‹x.h
>

9 
	~<lšux/ty³s.h
>

11 
	sÁh
 {

12 
mu‹x
 
	mlock
;

13 
d’Œy
 *
	mdœ
;

15 
u8
 
	mid
;

17 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 4, 0)

18 
u32
 
	mhwšfo_¡©ic_db
;

20 
boÞ
 
	mhwšfo_¡©ic_db
;

22 
u8
 
	mhwšfo_key_d©a
[1024];

23 
debugfs_blob_w¿µ”
 
	mhwšfo_key
;

24 
u8
 
	mhwšfo_v®_d©a
[1024];

25 
debugfs_blob_w¿µ”
 
	mhwšfo_v®
;

27 
u8
 
	m¹sym_key_d©a
[1024];

28 
debugfs_blob_w¿µ”
 
	m¹sym_key
;

30 
u8
 
	mfw_lßd_d©a
[1024];

31 
debugfs_blob_w¿µ”
 
	mfw_lßd
;

33 
u8
 
	mwr_Úly_d©a
[1024];

34 
debugfs_blob_w¿µ”
 
	mwr_Úly
;

36 
debugfs_blob_w¿µ”
 
	mfwdump
;

37 
debugfs_blob_w¿µ”
 
	mdump¥ec
;

38 
u32
 
	mdump_Ëv–
;

41 cÚ¡ *
	mÇme
;

42 
nå_»sourû
 *
	m»s
;

43 } 
	m»sourûs
[1024];

45 
li¡_h—d
 
	m¿nd
;

46 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 4, 0)

47 
u32
 
	m¿nd_Œigg”_w¬ns
;

49 
boÞ
 
	m¿nd_Œigg”_w¬ns
;

53 
Áh
‚th;

55 cÚ¡ 
fže_Ý”©iÚs
 
Áh_¿nd_r_Ýs
;

	@src/nfp_test_harness_main.c

4 
	~"nå_Ãt_com·t.h
"

6 
	~<lšux/debugfs.h
>

7 
	~<lšux/”ºo.h
>

8 
	~<lšux/fœmw¬e.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/¹ÃŽšk.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/vm®loc.h
>

15 
	~"nå_maš.h
"

16 
	~"nåcÜe/nå.h
"

17 
	~"nåcÜe/nå_nffw.h
"

18 
	~"nåcÜe/nå_n¥.h
"

19 
	~"nåcÜe/nå6000/nå6000.h
"

20 
	~"nå_‹¡_h¬Ãss.h
"

22 
	#NTH_MAX_DUMPSPEC_SIZE
 10240

	)

24 
Áh
 
	gÁh
 = {

25 .
hwšfo_key
 = {

26 .
d©a
 = 
Áh
.
hwšfo_key_d©a
,

27 .
	gsize
 = (
Áh
.
hwšfo_key_d©a
),

29 .
	ghwšfo_v®
 = {

30 .
d©a
 = 
Áh
.
hwšfo_v®_d©a
,

31 .
	gsize
 = (
Áh
.
hwšfo_v®_d©a
),

34 .
	g¹sym_key
 = {

35 .
d©a
 = 
Áh
.
¹sym_key_d©a
,

36 .
	gsize
 = (
Áh
.
¹sym_key_d©a
),

39 .
	gfw_lßd
 = {

40 .
d©a
 = 
Áh
.
fw_lßd_d©a
,

41 .
	gsize
 = (
Áh
.
fw_lßd_d©a
),

45 .
	gwr_Úly
 = {

46 .
d©a
 = 
Áh
.
wr_Úly_d©a
,

47 .
	gsize
 = (
Áh
.
wr_Úly_d©a
),

51 
	#NTH_DECLARE_HANDLER
(
__Çme
) \

53 
Áh_
 ## 
__Çme
 ## 
	`_Ý’
(
šode
 *šode, 
fže
 *
f
) \

55  
	`sšgË_Ý’
(
f
, 
Áh_
 ## 
__Çme
 ## 
_»ad
, \

56 
šode
->
i_´iv©e
); \

59 cÚ¡ 
fže_Ý”©iÚs
 
Áh_
 ## 
__Çme
 ## 
_Ýs
 = { \

60 .
owÃr
 = 
THIS_MODULE
, \

61 .
Ý’
 = 
Áh_
 ## 
__Çme
 ## 
_Ý’
, \

62 .
»Ëa£
 = 
sšgË_»Ëa£
, \

63 .
»ad
 = 
£q_»ad
, \

64 .
Î£ek
 = 
£q_l£ek
, \

65 }

	)

67 
	#NTH_DECLARE_ACTION
(
__Çme
, 
__Ý
) \

68 
Áh_
 ## 
__Çme
 ## 
	`_»ad
(
£q_fže
 *
fže
, *
d©a
) \

70 
nå_ýp
 *
ýp
; \

72 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
); \

73 ià(!
ýp
) \

74  -
EBUSY
; \

76 
	`__Ý
(
ýp
); \

78 
	`nå_ýp_ä“
(
ýp
); \

82 
	`NTH_DECLARE_HANDLER
(
__Çme
);

	)

84 
	#NTH_DECLARE_ACTION_NSP
(
__Çme
, 
__Ý
) \

85 
Áh_
 ## 
__Çme
 ## 
	`_»ad
(
£q_fže
 *
fže
, *
d©a
) \

87 
nå_ýp
 *
ýp
; \

88 
nå_n¥
 *
n¥
; \

89 
»t
; \

91 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
); \

92 ià(!
ýp
) \

93  -
EBUSY
; \

95 
n¥
 = 
	`nå_n¥_Ý’
(
ýp
); \

96 ià(
	`IS_ERR
(
n¥
)) { \

97 
»t
 = 
	`PTR_ERR
(
n¥
); \

98 
ex™_ä“_ýp
; \

101 
»t
 = 
	`__Ý
(
n¥
); \

103 
	`nå_n¥_þo£
(
n¥
); \

104 
ex™_ä“_ýp
: \

105 
	`nå_ýp_ä“
(
ýp
); \

107  
»t
; \

109 
	`NTH_DECLARE_HANDLER
(
__Çme
);

	)

111 
	$Áh_dfs_fže_g‘
(
d’Œy
 *d’Œy, *
¤cu_idx
)

113 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 15, 0)

114  
	`debugfs_fže_g‘
(
d’Œy
);

115 #–ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 7, 0)

116  
	`debugfs_u£_fže_¡¬t
(
d’Œy
, 
¤cu_idx
);

120 
	}
}

122 
	$Áh_dfs_fže_put
(
d’Œy
 *d’Œy, 
¤cu_idx
)

124 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 15, 0)

125 
	`debugfs_fže_put
(
d’Œy
);

126 #–ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 7, 0)

127 
	`debugfs_u£_fže_fšish
(
¤cu_idx
);

129 
	}
}

131 
	$Áh_£rŸl_»ad
(
£q_fže
 *
fže
, *
d©a
)

133 
nå_ýp
 *
ýp
;

134 
size
, 
”r
 = 0;

135 cÚ¡ 
u8
 *
£rŸl
;

137 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

138 ià(!
ýp
)

139  -
EBUSY
;

141 
size
 = 
	`nå_ýp_£rŸl
(
ýp
, &
£rŸl
);

142 ià(
size
 != 6) {

143 
”r
 = -
EINVAL
;

144 
ex™_ä“
;

147 
	`£q_´štf
(
fže
, "%pM", 
£rŸl
);

148 
ex™_ä“
:

149 
	`nå_ýp_ä“
(
ýp
);

151  
”r
;

152 
	}
}

153 
NTH_DECLARE_HANDLER
(
£rŸl
);

155 
	$Áh_š‹rçû_»ad
(
£q_fže
 *
fže
, *
d©a
)

157 
nå_ýp
 *
ýp
;

159 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

160 ià(!
ýp
)

161  -
EBUSY
;

163 
	`£q_´štf
(
fže
, "%04hx\n", 
	`nå_ýp_š‹rçû
(
ýp
));

165 
	`nå_ýp_ä“
(
ýp
);

168 
	}
}

169 
NTH_DECLARE_HANDLER
(
š‹rçû
);

171 
NTH_DECLARE_ACTION_NSP
(
»£t
, 
nå_n¥_deviû_soá_»£t
);

173 
	$Áh_¹sym_couÁ_»ad
(
£q_fže
 *
fže
, *
d©a
)

175 
nå_¹sym_bË
 *
¹bl
;

176 
nå_ýp
 *
ýp
;

178 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

179 ià(!
ýp
)

180  -
EBUSY
;

182 
¹bl
 = 
	`nå_¹sym_bË_»ad
(
ýp
);

184 
	`£q_´štf
(
fže
, "%d\n", 
	`nå_¹sym_couÁ
(
¹bl
));

186 
	`kä“
(
¹bl
);

187 
	`nå_ýp_ä“
(
ýp
);

190 
	}
}

191 
NTH_DECLARE_HANDLER
(
¹sym_couÁ
);

193 
	$Áh_¹sym_dump_»ad
(
£q_fže
 *
fže
, *
d©a
)

195 cÚ¡ 
nå_¹sym
 *
¹sym
;

196 
nå_¹sym_bË
 *
¹bl
;

197 
nå_ýp
 *
ýp
;

198 
i
;

200 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

201 ià(!
ýp
)

202  -
EBUSY
;

204 
¹bl
 = 
	`nå_¹sym_bË_»ad
(
ýp
);

206 
i
 = 0;

207 (
¹sym
 = 
	`nå_¹sym_g‘
(
¹bl
, 
i
++)))

208 
	`£q_´štf
(
fže
, "%s\n", 
¹sym
->
Çme
);

210 
	`kä“
(
¹bl
);

211 
	`nå_ýp_ä“
(
ýp
);

214 
	}
}

215 
NTH_DECLARE_HANDLER
(
¹sym_dump
);

217 
ssize_t
 
	$Áh_»ad_blob
(
fže
 *fže, 
__u£r
 *
u£r_buf
,

218 
size_t
 
couÁ
, 
loff_t
 *
µos
)

220 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

221 
¤cu_idx
;

222 
ssize_t
 
»t
;

224 
	`mu‹x_lock
(&
Áh
.
lock
);

225 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

226 ià(
	`lik–y
(!
»t
))

227 
»t
 = 
	`sim¶e_»ad_äom_bufãr
(
u£r_buf
, 
couÁ
, 
µos
,

228 
blob
->
d©a
, blob->
size
);

229 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

230 
	`mu‹x_uÆock
(&
Áh
.
lock
);

232  
»t
;

233 
	}
}

235 
ssize_t
 
	$Áh_wr™e_hwšfo
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

236 
size_t
 
couÁ
, 
loff_t
 *
µos
)

238 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

239 
u8
 *
d©a
 = 
blob
->d©a, *
tmp_buf
 = 
NULL
;

240 
nå_hwšfo
 *
hwšfo
 = 
NULL
;

241 
nå_ýp
 *
ýp
;

242 cÚ¡ *
v®ue
;

243 
ssize_t
 
»t
, 
Ën
;

244 
¤cu_idx
;

246 
	`mu‹x_lock
(&
Áh
.
lock
);

248 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

249 ià(
	`lik–y
(!
»t
))

250 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, blob->
size
 - 1,

251 
µos
, 
u£r_buf
, 
couÁ
);

252 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

253 ià(
»t
 < 0)

254 
ex™_uÆock
;

255 
Ën
 = 
»t
;

257 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

258 ià(!
ýp
) {

259 
»t
 = -
EBUSY
;

260 
ex™_uÆock
;

263 
	`mem£t
(
Áh
.
hwšfo_v®_d©a
, 0, (nth.hwinfo_val_data));

265 ià(
Áh
.
hwšfo_¡©ic_db
) {

266 
d©a
[
Ën
] = 0;

267 
hwšfo
 = 
	`nå_hwšfo_»ad
(
ýp
);

268 
v®ue
 = 
	`nå_hwšfo_lookup
(
hwšfo
, 
d©a
);

269 ià(!
v®ue
) {

270 
»t
 = -
EINVAL
;

271 
ex™_ä“
;

274 
nå_n¥
 *
n¥
;

276 
tmp_buf
 = 
	`kmemdup
(
d©a
, 
Ën
, 
GFP_KERNEL
);

277 ià(!
tmp_buf
) {

278 
»t
 = -
ENOMEM
;

279 
ex™_ä“
;

282 
n¥
 = 
	`nå_n¥_Ý’
(
ýp
);

283 
»t
 = 
	`PTR_ERR_OR_ZERO
(
n¥
);

284 ià(
»t
)

285 
ex™_ä“
;

287 
»t
 = 
	`nå_n¥_hwšfo_lookup
(
n¥
, 
tmp_buf
, 
Ën
);

288 
	`nå_n¥_þo£
(
n¥
);

289 ià(
»t
)

290 
ex™_ä“
;

292 
»t
 = 
Ën
;

293 
v®ue
 = 
tmp_buf
;

296 
	`memýy
(
Áh
.
hwšfo_v®_d©a
, 
v®ue
,

297 
	`¡ºËn
(
v®ue
, (
Áh
.
hwšfo_v®_d©a
)));

299 
ex™_ä“
:

300 
	`kä“
(
tmp_buf
);

301 
	`kä“
(
hwšfo
);

302 
	`nå_ýp_ä“
(
ýp
);

303 
ex™_uÆock
:

304 
	`mu‹x_uÆock
(&
Áh
.
lock
);

306  
»t
;

307 
	}
}

309 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_hwšfo_Ýs
 = {

310 .
»ad
 = 
Áh_»ad_blob
,

311 .
	gwr™e
 = 
Áh_wr™e_hwšfo
,

312 .
	gÝ’
 = 
sim¶e_Ý’
,

313 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

316 
ssize_t
 
	$Áh_wr™e_¹sym
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

317 
size_t
 
couÁ
, 
loff_t
 *
µos
)

319 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

320 cÚ¡ 
nå_¹sym
 *
v®ue
;

321 
nå_¹sym_bË
 *
¹bl
;

322 
u8
 *
d©a
 = 
blob
->data;

323 
nå_ýp
 *
ýp
;

324 
¤cu_idx
;

325 
ssize_t
 
»t
;

327 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

328 ià(
	`lik–y
(!
»t
))

329 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, blob->
size
 - 1,

330 
µos
, 
u£r_buf
, 
couÁ
);

331 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

332 ià(
»t
 < 0)

333  
»t
;

334 
d©a
[
»t
] = 0;

336 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

337 ià(!
ýp
)

338  -
EBUSY
;

340 
¹bl
 = 
	`nå_¹sym_bË_»ad
(
ýp
);

341 
v®ue
 = 
	`nå_¹sym_lookup
(
¹bl
, 
d©a
);

342 ià(!
v®ue
)

343 
»t
 = -
ENOENT
;

345 
	`kä“
(
¹bl
);

346 
	`nå_ýp_ä“
(
ýp
);

348  
»t
;

349 
	}
}

351 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_¹sym_Ýs
 = {

352 .
»ad
 = 
Áh_»ad_blob
,

353 .
	gwr™e
 = 
Áh_wr™e_¹sym
,

354 .
	gÝ’
 = 
sim¶e_Ý’
,

355 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

358 
ssize_t


359 
	$Áh_»ad_¹sym_v®
(
fže
 *fže, 
__u£r
 *
u£r_buf
,

360 
size_t
 
couÁ
, 
loff_t
 *
µos
)

362 
nå_¹sym_bË
 *
¹bl
;

363 cÚ¡ 
nå_¹sym
 *
sym
;

364 
nå_ýp
 *
ýp
;

365 
¤cu_idx
;

366 
ssize_t
 
»t
;

367 
u8
 *
buf
;

369 
	`mu‹x_lock
(&
Áh
.
lock
);

370 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

371 ià(
»t
)

372 
ex™_uÆock
;

374 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

375 ià(!
ýp
) {

376 
»t
 = -
EBUSY
;

377 
ex™_dfs_put
;

380 
buf
 = 
	`km®loc
(
couÁ
, 
GFP_USER
);

381 ià(!
buf
) {

382 
»t
 = -
ENOMEM
;

383 
ex™_ä“_ýp
;

386 
¹bl
 = 
	`nå_¹sym_bË_»ad
(
ýp
);

387 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
Áh
.
¹sym_key
.
d©a
);

388 ià(
sym
) {

389 
»t
 = 
	`nå_¹sym_»ad
(
ýp
, 
sym
, *
µos
, 
buf
, 
couÁ
);

391 
»t
 = -
ENOENT
;

392 
ex™_ä“_¹bl
;

395 ià(
»t
 > 0) {

396 ià(
	`cÝy_to_u£r
(
u£r_buf
, 
buf
, 
»t
))

397 
»t
 = -
EFAULT
;

399 *
µos
 +ð
»t
;

402 
ex™_ä“_¹bl
:

403 
	`kä“
(
¹bl
);

404 
	`kä“
(
buf
);

405 
ex™_ä“_ýp
:

406 
	`nå_ýp_ä“
(
ýp
);

407 
ex™_dfs_put
:

408 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

409 
ex™_uÆock
:

410 
	`mu‹x_uÆock
(&
Áh
.
lock
);

412  
»t
;

413 
	}
}

415 
ssize_t


416 
	$Áh_wr™e_¹sym_v®
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

417 
size_t
 
couÁ
, 
loff_t
 *
µos
)

419 
nå_¹sym_bË
 *
¹bl
;

420 cÚ¡ 
nå_¹sym
 *
sym
;

421 
nå_ýp
 *
ýp
;

422 
¤cu_idx
;

423 
ssize_t
 
»t
;

424 
u8
 *
buf
;

426 
	`mu‹x_lock
(&
Áh
.
lock
);

427 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

428 ià(
»t
)

429 
ex™_uÆock
;

431 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

432 ià(!
ýp
) {

433 
»t
 = -
EBUSY
;

434 
ex™_dfs_put
;

437 
buf
 = 
	`km®loc
(
couÁ
, 
GFP_USER
);

438 ià(!
buf
) {

439 
»t
 = -
ENOMEM
;

440 
ex™_ä“_ýp
;

442 ià(
	`cÝy_äom_u£r
(
buf
, 
u£r_buf
, 
couÁ
)) {

443 
»t
 = -
EFAULT
;

444 
ex™_ä“_buf
;

447 
¹bl
 = 
	`nå_¹sym_bË_»ad
(
ýp
);

448 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
Áh
.
¹sym_key
.
d©a
);

449 ià(
sym
) {

450 
»t
 = 
	`nå_¹sym_wr™e
(
ýp
, 
sym
, *
µos
, 
buf
, 
couÁ
);

452 
»t
 = -
ENOENT
;

453 
ex™_ä“_¹bl
;

456 ià(
»t
 > 0)

457 *
µos
 +ð
»t
;

459 
ex™_ä“_¹bl
:

460 
	`kä“
(
¹bl
);

461 
ex™_ä“_buf
:

462 
	`kä“
(
buf
);

463 
ex™_ä“_ýp
:

464 
	`nå_ýp_ä“
(
ýp
);

465 
ex™_dfs_put
:

466 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

467 
ex™_uÆock
:

468 
	`mu‹x_uÆock
(&
Áh
.
lock
);

470  
»t
;

471 
	}
}

473 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_¹sym_v®_Ýs
 = {

474 .
»ad
 = 
Áh_»ad_¹sym_v®
,

475 .
	gwr™e
 = 
Áh_wr™e_¹sym_v®
,

476 .
	gÝ’
 = 
sim¶e_Ý’
,

477 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

480 
ssize_t
 
	$Áh_wr™e_fw_lßd
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

481 
size_t
 
couÁ
, 
loff_t
 *
µos
)

483 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

484 cÚ¡ 
fœmw¬e
 *
fw
;

485 
u8
 *
d©a
 = 
blob
->data;

486 
nå_ýp
 *
ýp
;

487 
nå_n¥
 *
n¥
;

488 
ssize_t
 
cÝ›d
, 
»t
;

489 
¤cu_idx
;

491 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

492 ià(
	`lik–y
(!
»t
))

493 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, blob->
size
 - 1,

494 
µos
, 
u£r_buf
, 
couÁ
);

495 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

496 ià(
»t
 < 0)

497  
»t
;

498 
d©a
[
»t
] = 0;

499 
cÝ›d
 = 
»t
;

501 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

502 ià(!
ýp
)

503  -
EBUSY
;

505 
»t
 = 
	`»que¡_fœmw¬e
(&
fw
, 
d©a
, 
	`nå_ýp_deviû
(
ýp
)->
·»Á
);

506 ià(
»t
 < 0)

507 
ex™_ä“_ýp
;

509 
n¥
 = 
	`nå_n¥_Ý’
(
ýp
);

510 ià(
	`IS_ERR
(
n¥
)) {

511 
»t
 = 
	`PTR_ERR
(
n¥
);

512 
ex™_»Ëa£_fw
;

515 
»t
 = 
	`nå_n¥_wa™
(
n¥
);

516 ià(
»t
 < 0)

517 
ex™_n¥_þo£
;

519 
»t
 = 
	`nå_n¥_deviû_soá_»£t
(
n¥
);

520 ià(
»t
 < 0) {

521 
	`´_”r
("FažedØsoá„e£ˆthNFP: %zd\n", 
»t
);

522 
ex™_n¥_þo£
;

525 
»t
 = 
	`nå_n¥_lßd_fw
(
n¥
, 
fw
);

526 ià(
»t
) {

527 
	`´_”r
("FW†ßdšg fažed: %zd\n", 
»t
);

528 
ex™_n¥_þo£
;

531 
ex™_n¥_þo£
:

532 
	`nå_n¥_þo£
(
n¥
);

533 
ex™_»Ëa£_fw
:

534 
	`»Ëa£_fœmw¬e
(
fw
);

535 
ex™_ä“_ýp
:

536 
	`nå_ýp_ä“
(
ýp
);

538  
»t
 ?„‘ : 
cÝ›d
;

539 
	}
}

541 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_fw_lßd_Ýs
 = {

542 .
»ad
 = 
Áh_»ad_blob
,

543 .
	gwr™e
 = 
Áh_wr™e_fw_lßd
,

544 .
	gÝ’
 = 
sim¶e_Ý’
,

545 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

548 
	$Áh_»sourû_»ad
(
£q_fže
 *
fže
, *
d©a
)

550 
i
;

552 
i
 = 0; i < 
	`ARRAY_SIZE
(
Áh
.
»sourûs
); i++) {

553 ià(!
Áh
.
»sourûs
[
i
].
Çme
)

556 
	`£q_´štf
(
fže
, "%d\t%s\t%p %s\t%08x %010llx %llx\n",

557 
i
, 
Áh
.
»sourûs
[i].
Çme
,‚th.»sourûs[i].
»s
,

558 
	`nå_»sourû_Çme
(
Áh
.
»sourûs
[
i
].
»s
),

559 
	`nå_»sourû_ýp_id
(
Áh
.
»sourûs
[
i
].
»s
),

560 
	`nå_»sourû_add»ss
(
Áh
.
»sourûs
[
i
].
»s
),

561 
	`nå_»sourû_size
(
Áh
.
»sourûs
[
i
].
»s
));

565 
	}
}

567 
ssize_t


568 
	$Áh_»sourû_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

569 
size_t
 
couÁ
, 
loff_t
 *
µos
)

571 
nå_ýp
 *
ýp
;

572 
ssize_t
 
cÝ›d
, 
»t
;

573 
Çme
[16] = {};

574 
¤cu_idx
;

575 
i
;

577 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

578 ià(
	`lik–y
(!
»t
))

579 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
Çme
, (name) - 1,

580 
µos
, 
u£r_buf
, 
couÁ
);

581 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

582 ià(
»t
 < 0)

583  
»t
;

584 
cÝ›d
 = 
»t
;

585 
»t
 = 0;

587 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

588 ià(!
ýp
)

589  -
EBUSY
;

591 ià(
	`k¡¹Þ
(
Çme
, 0, &
i
)) {

592 *
Ãw_Çme
;

594 
	`mu‹x_lock
(&
Áh
.
lock
);

595 
i
 = 0; i < 
	`ARRAY_SIZE
(
Áh
.
»sourûs
); i++)

596 ià(!
Áh
.
»sourûs
[
i
].
»s
)

598 ià(
i
 =ð
	`ARRAY_SIZE
(
Áh
.
»sourûs
)) {

599 
	`mu‹x_uÆock
(&
Áh
.
lock
);

600 
»t
 = -
ENOSPC
;

601 
ex™_ä“_ýp
;

604 
Áh
.
»sourûs
[
i
].
»s
 = (*)1;

605 
	`mu‹x_uÆock
(&
Áh
.
lock
);

607 
Ãw_Çme
 = 
	`k¡rdup
(
Çme
, 
GFP_KERNEL
);

608 ià(!
Ãw_Çme
) {

609 
»t
 = -
ENOMEM
;

610 
	`mem£t
(&
Áh
.
»sourûs
[
i
], 0, (nth.resources[i]));

611 
ex™_ä“_ýp
;

614 
Áh
.
»sourûs
[
i
].
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
Çme
);

615 ià(
	`IS_ERR
(
Áh
.
»sourûs
[
i
].
»s
)) {

616 
	`kä“
(
Ãw_Çme
);

617 
»t
 = 
	`PTR_ERR
(
Áh
.
»sourûs
[
i
].
»s
);

618 
	`mem£t
(&
Áh
.
»sourûs
[
i
], 0, (nth.resources[i]));

619 
ex™_ä“_ýp
;

621 
Áh
.
»sourûs
[
i
].
Çme
 = 
Ãw_Çme
;

622 } ià(
Áh
.
»sourûs
[
i
].
Çme
) {

623 
	`kä“
(
Áh
.
»sourûs
[
i
].
Çme
);

624 
	`nå_»sourû_»Ëa£
(
Áh
.
»sourûs
[
i
].
»s
);

625 
	`mem£t
(&
Áh
.
»sourûs
[
i
], 0, (nth.resources[i]));

627 
»t
 = -
EINVAL
;

630 
ex™_ä“_ýp
:

631 
	`nå_ýp_ä“
(
ýp
);

633  
»t
 ?„‘ : 
cÝ›d
;

634 
	}
}

636 
	$Áh_»sourû_Ý’
(
šode
 *šode, 
fže
 *
f
)

638  
	`sšgË_Ý’
(
f
, 
Áh_»sourû_»ad
, 
šode
->
i_´iv©e
);

639 
	}
}

641 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_»sourû_Ýs
 = {

642 .
owÃr
 = 
THIS_MODULE
,

643 .
	gÝ’
 = 
Áh_»sourû_Ý’
,

644 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

645 .
	gwr™e
 = 
Áh_»sourû_wr™e
,

646 .
	g»ad
 = 
£q_»ad
,

647 .
	gÎ£ek
 = 
£q_l£ek
,

650 
	$Áh_‘h_bË_»ad
(
£q_fže
 *
fže
, *
d©a
)

652 
nå_‘h_bË
 *
‘h_bË
;

653 
nå_ýp
 *
ýp
;

654 
i
;

656 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

657 ià(!
ýp
)

658  -
EBUSY
;

660 
‘h_bË
 = 
	`nå_‘h_»ad_pÜts
(
ýp
);

661 ià(!
‘h_bË
) {

662 
	`nå_ýp_ä“
(
ýp
);

663  -
EIO
;

666 
i
 = 0; i < 
‘h_bË
->
couÁ
; i++) {

667 
	`£q_´štf
(
fže
, "%d: %u %u %u %u %u %u %pM %d.%d %d %d %d ",

668 
i
, 
‘h_bË
->
pÜts
[i].
‘h_šdex
,

669 
‘h_bË
->
pÜts
[
i
].
šdex
,

670 
‘h_bË
->
pÜts
[
i
].
nbi
,

671 
‘h_bË
->
pÜts
[
i
].
ba£
,

672 
‘h_bË
->
pÜts
[
i
].
ÏÃs
,

673 
‘h_bË
->
pÜts
[
i
].
¥“d
,

674 
‘h_bË
->
pÜts
[
i
].
mac_addr
,

675 
‘h_bË
->
pÜts
[
i
].
Ïb–_pÜt
,

676 
‘h_bË
->
pÜts
[
i
].
Ïb–_subpÜt
,

677 
‘h_bË
->
pÜts
[
i
].
’abËd
,

678 
‘h_bË
->
pÜts
[
i
].
tx_’abËd
,

679 
‘h_bË
->
pÜts
[
i
].
rx_’abËd
);

681 
	`£q_´štf
(
fže
, "| %d %d %d %d ",

682 
‘h_bË
->
pÜts
[
i
].
š‹rçû
,

683 
‘h_bË
->
pÜts
[
i
].
medŸ
,

684 
‘h_bË
->
pÜts
[
i
].
ªeg
,

685 
‘h_bË
->
pÜts
[
i
].
ov”ride_chªged
);

687 
	`£q_´štf
(
fže
, "| 0x%02hhx %d\n",

688 
‘h_bË
->
pÜts
[
i
].
pÜt_ty³
,

689 
‘h_bË
->
pÜts
[
i
].
is_¥l™
);

692 
	`kä“
(
‘h_bË
);

693 
	`nå_ýp_ä“
(
ýp
);

695 
	}
}

697 
	$Áh_‘h_bË_Ý’
(
šode
 *šode, 
fže
 *
f
)

699  
	`sšgË_Ý’
(
f
, 
Áh_‘h_bË_»ad
, 
šode
->
i_´iv©e
);

700 
	}
}

702 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_‘h_bË_Ýs
 = {

703 .
owÃr
 = 
THIS_MODULE
,

704 .
	gÝ’
 = 
Áh_‘h_bË_Ý’
,

705 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

706 .
	g»ad
 = 
£q_»ad
,

707 .
	gÎ£ek
 = 
£q_l£ek
,

710 
ssize_t


711 
	$Áh_wr™e_‘h_’abË
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

712 
size_t
 
couÁ
, 
loff_t
 *
µos
)

714 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

715 
idx
, 
’abË
;

716 
u8
 *
d©a
 = 
blob
->data;

717 
nå_ýp
 *
ýp
;

718 
”r
, 
¤cu_idx
;

719 
ssize_t
 
»t
;

721 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

722 ià(
	`lik–y
(!
»t
))

723 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, blob->
size
 - 1,

724 
µos
, 
u£r_buf
, 
couÁ
);

725 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

726 ià(
»t
 < 0)

727  
»t
;

728 
d©a
[
»t
] = 0;

730 ià(
	`ssÿnf
(
d©a
, "%u %u", &
idx
, &
’abË
) != 2)

731  -
EINVAL
;

733 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

734 ià(!
ýp
)

735  -
EBUSY
;

737 
”r
 = 
	`nå_‘h_£t_mod_’abË
(
ýp
, 
idx
, 
’abË
);

738 ià(
”r
)

739 
»t
 = 
”r
;

741 
	`nå_ýp_ä“
(
ýp
);

743  
»t
;

744 
	}
}

746 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_‘h_’abË_Ýs
 = {

747 .
»ad
 = 
Áh_»ad_blob
,

748 .
	gwr™e
 = 
Áh_wr™e_‘h_’abË
,

749 .
	gÝ’
 = 
sim¶e_Ý’
,

750 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

753 
ssize_t


754 
	$Áh_wr™e_‘h_ªeg
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

755 
size_t
 
couÁ
, 
loff_t
 *
µos
)

757 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

758 
idx
, 
ªeg
;

759 
u8
 *
d©a
 = 
blob
->data;

760 
nå_ýp
 *
ýp
;

761 
nå_n¥
 *
n¥
;

762 
”r
, 
¤cu_idx
;

763 
ssize_t
 
»t
;

765 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

766 ià(
	`lik–y
(!
»t
))

767 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, blob->
size
 - 1,

768 
µos
, 
u£r_buf
, 
couÁ
);

769 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

770 ià(
»t
 < 0)

771  
»t
;

772 
d©a
[
»t
] = 0;

774 ià(
	`ssÿnf
(
d©a
, "%u %u", &
idx
, &
ªeg
) != 2)

775  -
EINVAL
;

777 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

778 ià(!
ýp
)

779  -
EBUSY
;

781 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
ýp
, 
idx
);

782 ià(
	`IS_ERR
(
n¥
)) {

783 
»t
 = 
	`PTR_ERR
(
n¥
);

784 
”r
;

787 
	`__nå_‘h_£t_ªeg
(
n¥
, 
ªeg
);

788 
”r
 = 
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

789 ià(
”r
)

790 
»t
 = 
”r
;

791 
”r
:

792 
	`nå_ýp_ä“
(
ýp
);

794  
»t
;

795 
	}
}

797 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_‘h_ªeg_Ýs
 = {

798 .
»ad
 = 
Áh_»ad_blob
,

799 .
	gwr™e
 = 
Áh_wr™e_‘h_ªeg
,

800 .
	gÝ’
 = 
sim¶e_Ý’
,

801 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

804 
ssize_t


805 
	$Áh_wr™e_‘h_¥“d
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

806 
size_t
 
couÁ
, 
loff_t
 *
µos
)

808 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

809 
idx
, 
¥“d
;

810 
u8
 *
d©a
 = 
blob
->data;

811 
nå_ýp
 *
ýp
;

812 
nå_n¥
 *
n¥
;

813 
”r
, 
¤cu_idx
;

814 
ssize_t
 
»t
;

816 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

817 ià(
	`lik–y
(!
»t
))

818 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, blob->
size
 - 1,

819 
µos
, 
u£r_buf
, 
couÁ
);

820 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

821 ià(
»t
 < 0)

822  
»t
;

823 
d©a
[
»t
] = 0;

825 ià(
	`ssÿnf
(
d©a
, "%u %u", &
idx
, &
¥“d
) != 2)

826  -
EINVAL
;

828 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

829 ià(!
ýp
)

830  -
EBUSY
;

832 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
ýp
, 
idx
);

833 ià(
	`IS_ERR
(
n¥
)) {

834 
»t
 = 
	`PTR_ERR
(
n¥
);

835 
”r
;

838 
	`__nå_‘h_£t_¥“d
(
n¥
, 
¥“d
);

839 
”r
 = 
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

840 ià(
”r
)

841 
»t
 = 
”r
;

842 
”r
:

843 
	`nå_ýp_ä“
(
ýp
);

845  
»t
;

846 
	}
}

848 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_‘h_¥“d_Ýs
 = {

849 .
»ad
 = 
Áh_»ad_blob
,

850 .
	gwr™e
 = 
Áh_wr™e_‘h_¥“d
,

851 .
	gÝ’
 = 
sim¶e_Ý’
,

852 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

855 
ssize_t


856 
	$Áh_wr™e_‘h_ÏÃs
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

857 
size_t
 
couÁ
, 
loff_t
 *
µos
)

859 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

860 
idx
, 
ÏÃs
;

861 
u8
 *
d©a
 = 
blob
->data;

862 
nå_ýp
 *
ýp
;

863 
nå_n¥
 *
n¥
;

864 
”r
, 
¤cu_idx
;

865 
ssize_t
 
»t
;

867 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

868 ià(
	`lik–y
(!
»t
))

869 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, blob->
size
 - 1,

870 
µos
, 
u£r_buf
, 
couÁ
);

871 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

872 ià(
»t
 < 0)

873  
»t
;

874 
d©a
[
»t
] = 0;

876 ià(
	`ssÿnf
(
d©a
, "%u %u", &
idx
, &
ÏÃs
) != 2)

877  -
EINVAL
;

879 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

880 ià(!
ýp
)

881  -
EBUSY
;

883 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
ýp
, 
idx
);

884 ià(
	`IS_ERR
(
n¥
)) {

885 
»t
 = 
	`PTR_ERR
(
n¥
);

886 
”r
;

889 
	`__nå_‘h_£t_¥l™
(
n¥
, 
ÏÃs
);

890 
”r
 = 
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

891 ià(
”r
)

892 
»t
 = 
”r
;

893 
”r
:

894 
	`nå_ýp_ä“
(
ýp
);

896  
»t
;

897 
	}
}

899 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_‘h_ÏÃs_Ýs
 = {

900 .
»ad
 = 
Áh_»ad_blob
,

901 .
	gwr™e
 = 
Áh_wr™e_‘h_ÏÃs
,

902 .
	gÝ’
 = 
sim¶e_Ý’
,

903 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

906 
nå_pf
 *
	$Áh_g‘_dump_pf
(
nå_ýp
 *
ýp
)

908 
nå_pf
 *
pf
 = 
	`kz®loc
((*pf), 
GFP_KERNEL
);

910 
pf
->
ýp
 = cpp;

911 
pf
->
¹bl
 = 
	`nå_¹sym_bË_»ad
(
ýp
);

912 ià(!
pf
->
¹bl
)

913  
NULL
;

915 
pf
->
m
 = 
	`nå_m_Ý’
(
ýp
);

916 ià(!
pf
->
m
)

917  
NULL
;

919 
pf
->
hwšfo
 = 
	`nå_hwšfo_»ad
(
ýp
);

920 ià(!
pf
->
hwšfo
)

921  
NULL
;

923  
pf
;

924 
	}
}

926 
	$Áh_ä“_dump_pf
(
nå_pf
 *
pf
)

928 
	`kä“
(
pf
->
¹bl
);

929 
	`kä“
(
pf
->
hwšfo
);

930 
	`nå_m_þo£
(
pf
->
m
);

931 
	`kä“
(
pf
);

932 
	}
}

934 
	$Áh_ü—‹_´iv©e_w¿µ”
(
fže
 *fže, 
d©a_size
,

935 *
sourû
)

937 
debugfs_blob_w¿µ”
 *
w¿µ”
;

939 
w¿µ”
 = 
	`km®loc
((*w¿µ”), 
GFP_KERNEL
);

940 ià(!
w¿µ”
)

941  -
ENOMEM
;

943 
w¿µ”
->
d©a
 = 
	`vm®loc
(
d©a_size
);

944 ià(!
w¿µ”
->
d©a
) {

945 
	`kä“
(
w¿µ”
);

946  -
ENOMEM
;

952 ià(
sourû
) {

953 
w¿µ”
->
size
 = 
d©a_size
;

954 
	`memýy
(
w¿µ”
->
d©a
, 
sourû
, 
d©a_size
);

956 
w¿µ”
->
size
 = 0;

958 
fže
->
´iv©e_d©a
 = 
w¿µ”
;

961 
	}
}

963 
	$Áh_ä“_´iv©e_w¿µ”
(
šode
 *šode, 
fže
 *file)

965 
debugfs_blob_w¿µ”
 *
w¿µ”
 = 
fže
->
´iv©e_d©a
;

967 
	`vä“
(
w¿µ”
->
d©a
);

968 
	`kä“
(
w¿µ”
);

971 
	}
}

973 
	$Áh_fwdump_¥ec_Ý’
(
šode
 *šode, 
fže
 *file)

975  
	`Áh_ü—‹_´iv©e_w¿µ”
(
fže
, 
NTH_MAX_DUMPSPEC_SIZE
, 
NULL
);

976 
	}
}

978 
ssize_t


979 
	$Áh_fwdump_¥ec_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

980 
size_t
 
couÁ
, 
loff_t
 *
µos
)

982 
debugfs_blob_w¿µ”
 *
blob
 = 
fže
->
´iv©e_d©a
;

983 
¤cu_idx
;

984 
ssize_t
 
»t
;

986 
»t
 = 
	`Áh_dfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
, &
¤cu_idx
);

987 ià(
	`lik–y
(!
»t
))

988 
»t
 = 
	`sim¶e_wr™e_to_bufãr
(
blob
->
d©a
, 
NTH_MAX_DUMPSPEC_SIZE
,

989 
µos
, 
u£r_buf
, 
couÁ
);

990 
	`Áh_dfs_fže_put
(
fže
->
f_·th
.
d’Œy
, 
¤cu_idx
);

993 ià(
»t
 > 0)

994 
blob
->
size
 +ð
»t
;

996  
»t
;

997 
	}
}

1001 
	$Áh_fwdump_¥ec_þo£
(
šode
 *šode, 
fže
 *file)

1003 
debugfs_blob_w¿µ”
 *
w¿µ”
 = 
fže
->
´iv©e_d©a
;

1005 
	`mu‹x_lock
(&
Áh
.
lock
);

1006 
	`vä“
(
Áh
.
dump¥ec
.
d©a
);

1007 
Áh
.
dump¥ec
.
d©a
 = 
w¿µ”
->data;

1008 
Áh
.
dump¥ec
.
size
 = 
w¿µ”
->size;

1009 
	`mu‹x_uÆock
(&
Áh
.
lock
);

1011 
	`kä“
(
w¿µ”
);

1014 
	}
}

1016 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_fwdump_¥ec_Ýs
 = {

1017 .
Ý’
 = 
Áh_fwdump_¥ec_Ý’
,

1018 .
	gwr™e
 = 
Áh_fwdump_¥ec_wr™e
,

1019 .
	g»Ëa£
 = 
Áh_fwdump_¥ec_þo£
,

1020 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

1023 
nå_dump¥ec
 *
	$Áh_ü—‹_dump¥ec
(*
d©a
, 
u32
 
size
)

1025 
nå_dump¥ec
 *
dump¥ec
;

1027 
dump¥ec
 = 
	`vm®loc
((*dump¥ecè+ 
size
);

1028 ià(!
dump¥ec
)

1029  
NULL
;

1031 
dump¥ec
->
size
 = size;

1032 
	`memýy
(
dump¥ec
->
d©a
, d©a, 
size
);

1034  
dump¥ec
;

1035 
	}
}

1037 
	$Áh_fwdump_Œigg”_»ad
(
£q_fže
 *
fže
, *
d©a
)

1039 
nå_dump¥ec
 *
dump¥ec
 = 
NULL
;

1040 
‘htoÞ_dump
 
dump_·¿m
;

1041 
nå_ýp
 *
ýp
;

1042 
s64
 
ÿlcuÏ‹d_Ën
;

1043 
nå_pf
 *
pf
;

1044 
u32
 
dump_Ëv–
;

1045 *
dump
;

1046 
”r
;

1048 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

1049 ià(!
ýp
)

1050  -
EBUSY
;

1052 
pf
 = 
	`Áh_g‘_dump_pf
(
ýp
);

1053 
dump_Ëv–
 = 
	`READ_ONCE
(
Áh
.dump_level);

1054 ià(!
pf
 || !
dump_Ëv–
) {

1055 
”r
 = -
EOPNOTSUPP
;

1056 
ex™_ä“_ýp
;

1060 
	`mu‹x_lock
(&
Áh
.
lock
);

1061 ià(
Áh
.
dump¥ec
.
d©a
)

1062 
dump¥ec
 = 
	`Áh_ü—‹_dump¥ec
(
Áh
.dump¥ec.
d©a
,

1063 
Áh
.
dump¥ec
.
size
);

1064 
	`mu‹x_uÆock
(&
Áh
.
lock
);

1066 ià(!
dump¥ec
) {

1067 
”r
 = -
EINVAL
;

1068 
ex™_ä“_ýp
;

1071 
ÿlcuÏ‹d_Ën
 = 
	`nå_Ãt_dump_ÿlcuÏ‹_size
(
pf
, 
dump¥ec
, 
dump_Ëv–
);

1072 ià(
ÿlcuÏ‹d_Ën
 < 0) {

1073 
”r
 = 
ÿlcuÏ‹d_Ën
;

1074 
ex™_ä“_ýp
;

1077 
dump
 = 
	`vz®loc
(
ÿlcuÏ‹d_Ën
);

1078 ià(!
dump
) {

1079 
”r
 = -
ENOMEM
;

1080 
ex™_ä“_ýp
;

1083 
dump_·¿m
.
æag
 = 
dump_Ëv–
;

1084 
dump_·¿m
.
Ën
 = 
ÿlcuÏ‹d_Ën
;

1090 
	`¹Æ_lock
();

1091 
”r
 = 
	`nå_Ãt_dump_pÝuÏ‹_bufãr
(
pf
, 
dump¥ec
, &
dump_·¿m
, 
dump
);

1092 
	`¹Æ_uÆock
();

1095 
	`mu‹x_lock
(&
Áh
.
lock
);

1096 
	`vä“
(
Áh
.
fwdump
.
d©a
);

1097 
Áh
.
fwdump
.
d©a
 = 
dump
;

1098 
Áh
.
fwdump
.
size
 = 
dump_·¿m
.
Ën
;

1100 ià(
Áh
.
fwdump
.
size
 !ð
ÿlcuÏ‹d_Ën
)

1101 
”r
 = -
EMSGSIZE
;

1102 
	`mu‹x_uÆock
(&
Áh
.
lock
);

1104 
ex™_ä“_ýp
:

1105 
	`nå_ýp_ä“
(
ýp
);

1106 
	`Áh_ä“_dump_pf
(
pf
);

1107 
	`vä“
(
dump¥ec
);

1108 
	`£q_´štf
(
fže
, "%d\n", 
”r
);

1111 
	}
}

1112 
NTH_DECLARE_HANDLER
(
fwdump_Œigg”
);

1117 
	$Áh_fwdump_Ý’
(
šode
 *šode, 
fže
 *file)

1119 
»t
;

1121 
	`mu‹x_lock
(&
Áh
.
lock
);

1122 ià(!
Áh
.
fwdump
.
d©a
) {

1123 
»t
 = -
ENOENT
;

1124 
ex™_uÆock
;

1126 
»t
 = 
	`Áh_ü—‹_´iv©e_w¿µ”
(
fže
, 
Áh
.
fwdump
.
size
,

1127 
Áh
.
fwdump
.
d©a
);

1129 
ex™_uÆock
:

1130 
	`mu‹x_uÆock
(&
Áh
.
lock
);

1132  
»t
;

1133 
	}
}

1135 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_fwdump_d©a_Ýs
 = {

1136 .
»ad
 = 
Áh_»ad_blob
,

1137 .
	gÝ’
 = 
Áh_fwdump_Ý’
,

1138 .
	g»Ëa£
 = 
Áh_ä“_´iv©e_w¿µ”
,

1139 .
	gÎ£ek
 = 
deçuÉ_Î£ek
,

1142 
__š™
 
	$Áh_š™
()

1144 
boÞ
 
çž
 = 
çl£
;

1146 
	`INIT_LIST_HEAD
(&
Áh
.
¿nd
);

1147 
	`mu‹x_š™
(&
Áh
.
lock
);

1149 
Áh
.
dœ
 = 
	`debugfs_ü—‹_dœ
("Áh", 
NULL
);

1150 ià(!
Áh
.
dœ
)

1151  -
EBUSY
;

1153 
çž
 |ð!
	`debugfs_ü—‹_u8
("id", 0600, 
Áh
.
dœ
, &Áh.
id
);

1155 
çž
 |ð!
	`debugfs_ü—‹_fže
("»£t", 0400, 
Áh
.
dœ
,

1156 
NULL
, &
Áh_»£t_Ýs
);

1158 
çž
 |ð!
	`debugfs_ü—‹_fže
("£rŸl", 0400, 
Áh
.
dœ
,

1159 
NULL
, &
Áh_£rŸl_Ýs
);

1160 
çž
 |ð!
	`debugfs_ü—‹_fže
("š‹rçû", 0400, 
Áh
.
dœ
,

1161 
NULL
, &
Áh_š‹rçû_Ýs
);

1163 
Áh
.
hwšfo_¡©ic_db
 = 
Œue
;

1164 
çž
 |ð!
	`debugfs_ü—‹_boÞ
("hwšfo_¡©ic_db", 0600, 
Áh
.
dœ
,

1165 &
Áh
.
hwšfo_¡©ic_db
);

1166 
çž
 |ð!
	`debugfs_ü—‹_fže
("hwšfo_key", 0600, 
Áh
.
dœ
,

1167 &
Áh
.
hwšfo_key
, &
Áh_hwšfo_Ýs
);

1168 
çž
 |ð!
	`debugfs_ü—‹_blob
("hwšfo_v®", 0400, 
Áh
.
dœ
,

1169 &
Áh
.
hwšfo_v®
);

1171 
çž
 |ð!
	`debugfs_ü—‹_u32
("fw_dump_Ëv–", 0600, 
Áh
.
dœ
,

1172 &
Áh
.
dump_Ëv–
);

1173 
çž
 |ð!
	`debugfs_ü—‹_fže
("fw_dump_¥ec", 0200, 
Áh
.
dœ
, 
NULL
,

1174 &
Áh_fwdump_¥ec_Ýs
);

1175 
çž
 |ð!
	`debugfs_ü—‹_fže
("fw_dump_Œigg”", 0400, 
Áh
.
dœ
, 
NULL
,

1176 &
Áh_fwdump_Œigg”_Ýs
);

1177 
çž
 |ð!
	`debugfs_ü—‹_fže
("fw_dump_d©a", 0400, 
Áh
.
dœ
, 
NULL
,

1178 &
Áh_fwdump_d©a_Ýs
);

1180 
çž
 |ð!
	`debugfs_ü—‹_fže
("¹sym_couÁ", 0400, 
Áh
.
dœ
,

1181 
NULL
, &
Áh_¹sym_couÁ_Ýs
);

1182 
çž
 |ð!
	`debugfs_ü—‹_fže
("¹sym_dump", 0400, 
Áh
.
dœ
,

1183 
NULL
, &
Áh_¹sym_dump_Ýs
);

1184 
çž
 |ð!
	`debugfs_ü—‹_fže
("¹sym_key", 0600, 
Áh
.
dœ
,

1185 &
Áh
.
¹sym_key
, &
Áh_¹sym_Ýs
);

1186 
çž
 |ð!
	`debugfs_ü—‹_fže
("¹sym_v®", 0600, 
Áh
.
dœ
,

1187 
NULL
, &
Áh_¹sym_v®_Ýs
);

1189 
çž
 |ð!
	`debugfs_ü—‹_fže
("fw_lßd", 0600, 
Áh
.
dœ
,

1190 &
Áh
.
fw_lßd
, &
Áh_fw_lßd_Ýs
);

1192 
çž
 |ð!
	`debugfs_ü—‹_fže
("»sourû", 0600, 
Áh
.
dœ
,

1193 
NULL
, &
Áh_»sourû_Ýs
);

1195 
çž
 |ð!
	`debugfs_ü—‹_fže
("‘h_bË", 0400, 
Áh
.
dœ
,

1196 
NULL
, &
Áh_‘h_bË_Ýs
);

1197 
çž
 |ð!
	`debugfs_ü—‹_fže
("‘h_’abË", 0600, 
Áh
.
dœ
,

1198 &
Áh
.
wr_Úly
, &
Áh_‘h_’abË_Ýs
);

1199 
çž
 |ð!
	`debugfs_ü—‹_fže
("‘h_ªeg", 0600, 
Áh
.
dœ
,

1200 &
Áh
.
wr_Úly
, &
Áh_‘h_ªeg_Ýs
);

1201 
çž
 |ð!
	`debugfs_ü—‹_fže
("‘h_¥“d", 0600, 
Áh
.
dœ
,

1202 &
Áh
.
wr_Úly
, &
Áh_‘h_¥“d_Ýs
);

1203 
çž
 |ð!
	`debugfs_ü—‹_fže
("‘h_ÏÃs", 0600, 
Áh
.
dœ
,

1204 &
Áh
.
wr_Úly
, &
Áh_‘h_ÏÃs_Ýs
);

1206 
çž
 |ð!
	`debugfs_ü—‹_fže
("¿nd_r", 0600, 
Áh
.
dœ
,

1207 
NULL
, &
Áh_¿nd_r_Ýs
);

1208 
çž
 |ð!
	`debugfs_ü—‹_boÞ
("¿nd_Œigg”_w¬ns", 0600, 
Áh
.
dœ
,

1209 &
Áh
.
¿nd_Œigg”_w¬ns
);

1211 ià(
çž
) {

1212 
	`debugfs_»move_»cursive
(
Áh
.
dœ
);

1213  -
EINVAL
;

1217 
	}
}

1219 
__ex™
 
	$Áh_ex™
()

1221 
i
;

1223 
	`mu‹x_de¡roy
(&
Áh
.
lock
);

1224 
	`debugfs_»move_»cursive
(
Áh
.
dœ
);

1226 
i
 = 0; i < 
	`ARRAY_SIZE
(
Áh
.
»sourûs
); i++) {

1227 ià(!
Áh
.
»sourûs
[
i
].
Çme
)

1229 
	`kä“
(
Áh
.
»sourûs
[
i
].
Çme
);

1230 
	`nå_»sourû_»Ëa£
(
Áh
.
»sourûs
[
i
].
»s
);

1233 
	`vä“
(
Áh
.
dump¥ec
.
d©a
);

1234 
	`vä“
(
Áh
.
fwdump
.
d©a
);

1235 
	}
}

1237 
moduË_š™
(
Áh_š™
);

1238 
moduË_ex™
(
Áh_ex™
);

1240 
MODULE_AUTHOR
("Netronome Systems <oss-drivers@netronome.com>");

1241 
MODULE_LICENSE
("GPL");

1242 
MODULE_DESCRIPTION
("The Netronome Flow Processor (NFP)est harness.");

	@src/nfp_test_harness_rand.c

4 
	~"nåcÜe/kcom·t.h
"

6 
	~<lšux/debugfs.h
>

7 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 11, 0)

8 
	~<lšux/sched/sigÇl.h
>

10 
	~<lšux/¿ndom.h
>

12 
	~"nåcÜe/nå.h
"

13 
	~"nåcÜe/nå_nffw.h
"

14 
	~"nåcÜe/nå_n¥.h
"

15 
	~"nåcÜe/nå6000/nå6000.h
"

16 
	~"nå_‹¡_h¬Ãss.h
"

19 
	#NTH_GENERATE_OVERSIZED_ACCESSES
 0

	)

21 
	sÁh_¿nd_’Œy
 {

22 
li¡_h—d
 
	mli¡
;

23 
pid_t
 
	mpid
;

24 
	mty³
;

25 
u32
 
	maddr
;

26 
u32
 
	msize
;

28 
u32
 
	m¿nd
;

29 
u64
 
	múŒ
;

30 
u64
 
	md–
;

33 
	$Áh_¿nd_r_»ad
(
£q_fže
 *
fže
, *
d©a
)

35 
Áh_¿nd_’Œy
 *
¿nd
;

37 
	`mu‹x_lock
(&
Áh
.
lock
);

38 
	`li¡_fÜ_—ch_’Œy
(
¿nd
, &
Áh
.¿nd, 
li¡
) {

39 
¿nd
->
úŒ
 +ð¿nd->
d–
;

40 
	`£q_´štf
(
fže
, "%d [%08x] %c %08x %04x %llu \t %llu\n",

41 
¿nd
->
pid
,„and->rand,

42 
¿nd
->
ty³
,„ªd->
addr
,„ªd->
size
,

43 
¿nd
->
úŒ
,„ªd->
d–
);

44 
¿nd
->
d–
 = 0;

46 
	`mu‹x_uÆock
(&
Áh
.
lock
);

49 
	}
}

52 
	$Áh_upd©e_¿nd_¡©e
(
Áh_¿nd_’Œy
 *
’Œy
, 
ty³
,

53 
u32
 
addr
, u32 
size
)

55 
’Œy
->
ty³
 =ype;

56 
’Œy
->
addr
 =‡ddr;

57 
’Œy
->
size
 = size;

58 
	}
}

60 
u32
 
	$Áh_¿nd_size
(
u32
 
max
)

62 
u32
 
»t
;

64 !(
»t
 = 
	`´ªdom_u32_max
(
max
) & ~0x7))

66  
»t
;

67 
	}
}

69 
u32
 
	$Áh_¿nd_addr
(
u32
 
size
)

71 
u32
 
addr
;

73 
addr
 = 
	`´ªdom_u32
() & ~(3 << 31 | 0x7);

74 ià(!
	`READ_ONCE
(
Áh
.
¿nd_Œigg”_w¬ns
))

75 ià(
	`round_down
(
addr
, 0x100000) !=

76 
	`round_down
(
addr
 + 
size
, 0x100000))

77 
addr
 -ð
size
;

79  
addr
;

80 
	}
}

83 
	$Áh_¿nd_»ad_»s
(
nå_ýp
 *
ýp
, 
Áh_¿nd_’Œy
 *
’Œy
,

84 
u8
 *
buff
, cÚ¡ u8 *
ex³ù
, 
u32
 
max_size
)

86 
nå_»sourû
 *
»s
;

87 
size
, 
addr
, 
v®
;

89 
	`Áh_upd©e_¿nd_¡©e
(
’Œy
, 't', 0, 0);

90 
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
NFP_RESOURCE_NFP_NFFW
);

91 ià(
	`IS_ERR
(
»s
)) {

92 
	`´_”r
("ERR: Resource‡cqurie failed %ld!\n",

93 
	`PTR_ERR
(
»s
));

97 
addr
 = 
	`nå_»sourû_add»ss
(
»s
);

98 
size
 = 
	`mš_t
(
u64
, 
max_size
, 
	`nå_»sourû_size
(
»s
));

99 
	`Áh_upd©e_¿nd_¡©e
(
’Œy
, 'T', 
addr
, 
size
);

100 
v®
 = 
	`nå_ýp_»ad
(
ýp
, 
	`nå_»sourû_ýp_id
(
»s
),

101 
addr
, 
buff
, 
size
);

102 ià(
v®
 !ð
size
)

103 
	`´_”r
("ERR:„esourû„—d fažed %d v %d\n", 
v®
, 
size
);

104 
	`nå_»sourû_»Ëa£
(
»s
);

106 ià(
ex³ù
 && 
	`memcmp
(
buff
,ƒx³ù, 
size
))

107 
	`´_”r
("ERR:„esource„ead incorrect\n");

108 
	}
}

110 
ssize_t
 
	$Áh_¿nd_r_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
u£r_buf
,

111 
size_t
 
couÁ
, 
loff_t
 *
µos
)

113 
Áh_¿nd_’Œy
 
’Œy
 = {};

114 
nå_‘h_bË
 *
‘h_bË
;

115 
nå_ýp
 *
ýp
;

116 
u8
 *
bufãr
;

117 
u8
 *
nffw
;

119 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
Áh
.
id
);

120 ià(!
ýp
)

121  -
EBUSY
;

123 
‘h_bË
 = 
	`nå_‘h_»ad_pÜts
(
ýp
);

124 ià(!
‘h_bË
) {

125 
	`nå_ýp_ä“
(
ýp
);

126  -
EIO
;

129 
	#NTH_RAND_R_BUFSZ
 (1 << 14)

	)

130 
bufãr
 = 
	`km®loc
(
NTH_RAND_R_BUFSZ
, 
GFP_KERNEL
);

131 
nffw
 = 
	`km®loc
(
NTH_RAND_R_BUFSZ
, 
GFP_KERNEL
);

132 ià(!
bufãr
 || !
nffw
)

133 
out
;

135 
’Œy
.
pid
 = 
	`sk_pid_Ä
(
cu¼’t
);

137 
	`mu‹x_lock
(&
Áh
.
lock
);

138 
	`li¡_add_ž
(&
’Œy
.
li¡
, &
Áh
.
¿nd
);

139 
	`mu‹x_uÆock
(&
Áh
.
lock
);

141 
	`Áh_¿nd_»ad_»s
(
ýp
, &
’Œy
, 
nffw
, 
NULL
, 
NTH_RAND_R_BUFSZ
);

143 !
	`sigÇl_³ndšg
(
cu¼’t
)) {

144 
u32
 
d¡
 = 
	`NFP_CPP_ID
(
NFP_CPP_TARGET_MU
, 
NFP_CPP_ACTION_RW
, 0) |

145 
NFP_ISL_EMEM0
;

146 
u32
 
diû
;

148 
diû
 = 
	`´ªdom_u32
();

149 
’Œy
.
¿nd
 = 
diû
;

150 
’Œy
.
d–
++;

153 ià(!(
diû
 & 0xfff)) {

154 *
»s
;

156 
	`Áh_upd©e_¿nd_¡©e
(&
’Œy
, 'e', 0, 0);

157 
»s
 = 
	`nå_‘h_»ad_pÜts
(
ýp
);

158 ià(!
»s
) {

159 
	`´_”r
("ERR: Failedo„eadable\n");

162 ià(
	`memcmp
(
‘h_bË
, 
»s
, (*eth_table)))

163 
	`´_”r
("ERR: ETHable doesn't match!\n");

164 
	`kä“
(
»s
);

166 
diû
 >>= 12;

168 ià(!(
diû
 & 0x1ff))

169 
	`Áh_¿nd_»ad_»s
(
ýp
, &
’Œy
, 
bufãr
, 
nffw
,

170 
NTH_RAND_R_BUFSZ
);

171 
diû
 >>= 9;

173 ià(
diû
 & 1) {

174 
nå_ýp_¬—
 *
»s
;

175 
size
, 
addr
, 
v®
;

177 
size
 = 
	`Áh_¿nd_size
(
NTH_RAND_R_BUFSZ
);

178 
addr
 = 
	`Áh_¿nd_addr
(
size
);

179 
	`Áh_upd©e_¿nd_¡©e
(&
’Œy
, 'a', 
addr
, 
size
);

181 
»s
 = 
	`nå_ýp_¬—_®loc_acquœe
(
ýp
, 
NULL
,

182 
d¡
, 
addr
, 
size
);

183 ià(!
»s
) {

184 
	`´_”r
("ERR: Alloc/acquire‡rea failed!\n");

188 
	`Áh_upd©e_¿nd_¡©e
(&
’Œy
, 'A', 
addr
, 
size
);

189 
v®
 = 
	`nå_ýp_¬—_»ad
(
»s
, 0, 
bufãr
, 
size
);

190 ià(
v®
 !ð
size
)

191 
	`´_”r
("ERR:‡rea„ead failed %d vs %d\n",

192 
v®
, 
size
);

193 
	`nå_ýp_¬—_»Ëa£_ä“
(
»s
);

195 
diû
 >>= 1;

197 ià(
diû
 & 1) {

198 
size
, 
addr
, 
v®
;

200 
size
 = 
	`Áh_¿nd_size
(
NTH_RAND_R_BUFSZ
);

201 
addr
 = 
	`Áh_¿nd_addr
(
size
);

203 
	`Áh_upd©e_¿nd_¡©e
(&
’Œy
, 'r', 
addr
, 
size
);

204 
v®
 = 
	`nå_ýp_»ad
(
ýp
, 
d¡
, 
addr
, 
bufãr
, 
size
);

205 ià(
v®
 !ð
size
)

206 
	`´_”r
("ERR: quick„ead failed %d vs %u\n",

207 
v®
, 
size
);

209 
diû
 >>= 1;

212 
	`mu‹x_lock
(&
Áh
.
lock
);

213 
	`li¡_d–
(&
’Œy
.
li¡
);

214 
	`mu‹x_uÆock
(&
Áh
.
lock
);

216 
	`kä“
(
bufãr
);

217 
	`kä“
(
nffw
);

218 
out
:

219 
	`kä“
(
‘h_bË
);

220 
	`nå_ýp_ä“
(
ýp
);

222 
	}
}

224 
	$Áh_¿nd_r_Ý’
(
šode
 *šode, 
fže
 *
f
)

226  
	`sšgË_Ý’
(
f
, 
Áh_¿nd_r_»ad
, 
šode
->
i_´iv©e
);

227 
	}
}

229 cÚ¡ 
fže_Ý”©iÚs
 
	gÁh_¿nd_r_Ýs
 = {

230 .
owÃr
 = 
THIS_MODULE
,

231 .
	gÝ’
 = 
Áh_¿nd_r_Ý’
,

232 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

233 .
	g»ad
 = 
£q_»ad
,

234 .
	gwr™e
 = 
Áh_¿nd_r_wr™e
,

235 .
	gÎ£ek
 = 
£q_l£ek
,

	@src/nfpcore/crc32.h

4 #iâdeà
NFP_CRC32_H


5 
	#NFP_CRC32_H


	)

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/üc32.h
>

17 
šlše
 
u32
 
	$üc32_posix_’d
(
u32
 
üc
, 
size_t
 
tÙ®_Ën
)

20 
tÙ®_Ën
 != 0) {

21 
u8
 
c
 = 
tÙ®_Ën
 & 0xff;

23 
üc
 = 
	`üc32_be
(üc, &
c
, 1);

24 
tÙ®_Ën
 >>= 8;

27  ~
üc
;

28 
	}
}

30 
šlše
 
u32
 
	$üc32_posix
(cÚ¡ *
buff
, 
size_t
 
Ën
)

32  
	`üc32_posix_’d
(
	`üc32_be
(0, 
buff
, 
Ën
),†en);

33 
	}
}

	@src/nfpcore/kcompat.h

8 #iâdeà
__KERNEL__NFP_COMPAT_H__


9 
	#__KERNEL__NFP_COMPAT_H__


	)

11 
	~<g’”©ed/ut¤–—£.h
>

12 
	~<lšux/v”siÚ.h
>

19 #iâdeà
RHEL_RELEASE_VERSION


20 
	#RHEL_RELEASE_VERSION
(
a
, 
b
è((×è<< 8è+ (b))

	)

22 #iâdeà
RHEL_RELEASE_CODE


23 
	#RHEL_RELEASE_CODE
 0

	)

26 #ifdeà
COMPAT__UTS_UBUNTU_RELEASE_ABI_BAD


27 #undeà
UTS_UBUNTU_RELEASE_ABI


30 #iâdeà
UTS_UBUNTU_RELEASE_ABI


31 
	#UTS_UBUNTU_RELEASE_ABI
 0

	)

34 
	#VER_IS_VANILLA
 (!
RHEL_RELEASE_CODE
 && !
UTS_UBUNTU_RELEASE_ABI
)

	)

36 
	#VER_KERN_LT
(
x
, 
y
è(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(x, y, 0))

	)

37 
	#VER_KERN_GE
(
x
, 
y
è(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(x, y, 0))

	)

38 
	#VER_KERN_EQ
(
x
, 
y
è(
	`VER_KERN_GE
(x, yè&& 
	`VER_KERN_LT
(x, y + 1))

	)

40 
	#VER_VANILLA_LT
(
x
, 
y
è(
VER_IS_VANILLA
 && 
	`VER_KERN_LT
(x, y))

	)

42 
	#VER_UBUNTU_LT
(
x
, 
y
, 
z
) \

43 (
UTS_UBUNTU_RELEASE_ABI
 && \

44 ((
	`VER_KERN_EQ
(
x
, 
y
è&& 
UTS_UBUNTU_RELEASE_ABI
 < (
z
)) || \

45 
	`VER_KERN_LT
(
x
, 
y
)))

	)

47 
	#VER_NON_RHEL_LT
(
x
, 
y
è(!
RHEL_RELEASE_CODE
 && 
	`VER_KERN_LT
(x, y))

	)

48 
	#VER_NON_RHEL_GE
(
x
, 
y
è(!
RHEL_RELEASE_CODE
 && 
	`VER_KERN_GE
(x, y))

	)

49 
	#VER_RHEL_LT
(
x
, 
y
) \

50 (
RHEL_RELEASE_CODE
 && RHEL_RELEASE_CODE < 
	`RHEL_RELEASE_VERSION
(
x
, 
y
))

	)

51 
	#VER_RHEL_GE
(
x
, 
y
) \

52 (
RHEL_RELEASE_CODE
 && RHEL_RELEASE_CODE >ð
	`RHEL_RELEASE_VERSION
(
x
, 
y
))

	)

53 
	#VER_IS_NON_RHEL
 !
RHEL_RELEASE_CODE


	)

55 
	#COMPAT__USE_DMA_SKIP_SYNC
 (
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 10, 0))

	)

56 
	#COMPAT__HAS_DEVLINK
 (
	`VER_NON_RHEL_GE
(4, 6è|| 
	`VER_RHEL_GE
(7, 4))

	)

57 
	#COMPAT__HAS_DEVLINK_SB
 (
	`VER_NON_RHEL_GE
(4, 7è|| 
	`VER_RHEL_GE
(7, 4))

	)

59 
	#COMPAT__CAN_HAVE_MULTIPLE_MOD_TABLES
 \

60 (
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 15, 0))

	)

62 
	~<lšux/debugfs.h
>

63 
	~<lšux/k”Ãl.h
>

64 
	~<lšux/deviû.h
>

65 
	~<lšux/io.h
>

66 
	~<lšux/pci.h
>

67 
	~<lšux/”r.h
>

68 
	~<lšux/‘h”deviû.h
>

69 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

70 
	~<lšux/b™f›ld.h
>

72 
	~<lšux/¿ndom.h
>

73 
	~<lšux/vm®loc.h
>

75 #iâdeà
PCI_VENDOR_ID_NETRONOME


76 
	#PCI_VENDOR_ID_NETRONOME
 0x19“

	)

78 #iâdeà
PCI_DEVICE_ID_NETRONOME_NFP3800


79 
	#PCI_DEVICE_ID_NETRONOME_NFP3800
 0x3800

	)

81 #iâdeà
PCI_DEVICE_ID_NETRONOME_NFP4000


82 
	#PCI_DEVICE_ID_NETRONOME_NFP4000
 0x4000

	)

84 #iâdeà
PCI_DEVICE_ID_NETRONOME_NFP5000


85 
	#PCI_DEVICE_ID_NETRONOME_NFP5000
 0x5000

	)

87 #iâdeà
PCI_DEVICE_ID_NETRONOME_NFP6000


88 
	#PCI_DEVICE_ID_NETRONOME_NFP6000
 0x6000

	)

90 #iâdeà
PCI_DEVICE_ID_NETRONOME_NFP3800_VF


91 
	#PCI_DEVICE_ID_NETRONOME_NFP3800_VF
 0x3803

	)

93 #iâdeà
PCI_DEVICE_ID_NETRONOME_NFP6000_VF


94 
	#PCI_DEVICE_ID_NETRONOME_NFP6000_VF
 0x6003

	)

97 #iâdeà
U32_MAX


98 
	#U32_MAX
 ((
u32
)~0U)

	)

100 #iâdeà
U64_MAX


101 
	#U64_MAX
 ((
u64
)~0U)

	)

104 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 6, 0))

105 
	~<lšux/sizes.h
>

107 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 38))

108 
	~<asm-g’”ic/sizes.h
>

110 
	#SZ_1M
 (1024 * 1024)

	)

111 
	#SZ_512M
 (512 * 1024 * 1024)

	)

115 
	~<lšux/b™Ýs.h
>

116 #iâdeà
BIT


117 
	#BIT
(
Ä
è(1UL << (Ä))

	)

119 #iâdeà
BIT_ULL


120 
	#BIT_ULL
(
Ä
è(1ULL << (Ä))

	)

123 #iâdeà
GENMASK


124 
	#GENMASK
(
h
, 
l
) \

125 ((~0UL << (
l
)è& (~0UL >> (
BITS_PER_LONG
 - (
h
è- 1)))

	)

128 #iâdeà
GENMASK_ULL


129 
	#GENMASK_ULL
(
h
, 
l
) \

130 ((~0ULL << (
l
)è& (~0ULL >> (
BITS_PER_LONG_LONG
 - (
h
è- 1)))

	)

133 #iâdeà
dma_rmb


134 
	#dma_rmb
(è
	`rmb
()

	)

137 #iâdeà
READ_ONCE


138 
	#READ_ONCE
(
x
è(x)

	)

141 #ià(
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 27))

142 #ià
defšed
(
CONFIG_X86_PAE
è|| defšed(
CONFIG_X86_64
) || \

143 
	$defšed
(
CONFIG_PHYS_ADDR_T_64BIT
)

147 
	#phys_addr_t
 
u64


	)

149 
	#phys_addr_t
 
u32


	)

153 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

154 
	tušŒ_t
;

157 #iâdeà
__maybe_unu£d


158 
	#__maybe_unu£d
 
	`__©Œibu‹__
((
unu£d
))

	)

161 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 28)

162 
	#IORESOURCE_TYPE_BITS
 0x00000f00

	)

163 
šlše
 
	$»sourû_ty³
(cÚ¡ 
»sourû
 *
»s
)

165  
»s
->
æags
 & 
IORESOURCE_TYPE_BITS
;

166 
	}
}

169 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 21)

170 
šlše
 
__iomem
 *
	$com·t_devm_iÜem­_noÿche
(
deviû
 *
dev
,

171 
»sourû_size_t
 
off£t
,

172 
size
)

174  
	`iÜem­_noÿche
(
off£t
, 
size
);

175 
	}
}

177 
šlše
 
	$com·t_devm_iounm­
(
deviû
 *
dev
, 
__iomem
 *
addr
)

179 
	`iounm­
(
addr
);

180 
	}
}

182 #undeà
devm_iÜem­_noÿche


183 #undeà
devm_iounm­


184 
	#devm_iÜem­_noÿche
(
_d
, 
_o
, 
_s
è
	`com·t_devm_iÜem­_noÿche
(_d, _o, _s)

	)

185 
	#devm_iounm­
(
_d
, 
_a
è
	`com·t_devm_iounm­
(_d, _a)

	)

188 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 0, 0)

189 
šlše
 
	$com·t_k¡¹oul
(cÚ¡ *
¡r
, 
ba£
, *
»s
)

191 *
ý
;

192 *
»s
 = 
	`sim¶e_¡¹oul
(
¡r
, &
ý
, 
ba£
);

193 ià(
ý
 && *cp == '\n')

194 
ý
++;

196  (!
ý
 || *ý !ð0 || (ý - 
¡r
è=ð0è? -
EINVAL
 : 0;

197 
	}
}

199 
	#k¡¹oul
(
¡r
, 
ba£
, 
»s
è
	`com·t_k¡¹oul
(¡r, ba£,„es)

	)

202 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 0, 0)

203 
	~<lšux/Ãtdeviû.h
>

204 
	#com·t_Ãtdev_´štk
(
dev
, 
Ëv–
, 
fmt
, 
¬gs
...) \

205 ({ 
	`´štk
("%s%s: " 
fmt
, 
Ëv–
, 
dev
->
Çme
, ##
¬gs
); })

	)

206 #iâdeà
Ãtdev_šfo


207 
	#Ãtdev_šfo
(
dev
, 
fÜm©
, 
¬gs
...) \

208 
	`com·t_Ãtdev_´štk
(
dev
, 
KERN_INFO
, 
fÜm©
, ##
¬gs
)

	)

210 #iâdeà
Ãtdev_dbg


211 
	#Ãtdev_dbg
(
dev
, 
fÜm©
, 
¬gs
...) \

212 
	`com·t_Ãtdev_´štk
(
dev
, 
KERN_DEBUG
, 
fÜm©
, ##
¬gs
)

	)

214 #iâdeà
Ãtdev_w¬n


215 
	#Ãtdev_w¬n
(
dev
, 
fÜm©
, 
¬gs
...) \

216 
	`com·t_Ãtdev_´štk
(
dev
, 
KERN_WARNING
, 
fÜm©
, ##
¬gs
)

	)

218 #iâdeà
Ãtdev_”r


219 
	#Ãtdev_”r
(
dev
, 
fÜm©
, 
¬gs
...) \

220 
	`com·t_Ãtdev_´štk
(
dev
, 
KERN_ERR
, 
fÜm©
, ##
¬gs
)

	)

224 #ià
VER_NON_RHEL_LT
(3, 12è|| 
VER_RHEL_LT
(7, 1)

225 
šlše
 
	$PTR_ERR_OR_ZERO
(cÚ¡ *
±r
)

227 ià(
	`IS_ERR
(
±r
))

228  
	`PTR_ERR
(
±r
);

230 
	}
}

233 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 13, 0)

234 
šlše


235 
	$com·t_dma_£t_mask_ªd_coh”’t
(
deviû
 *
dev
, 
u64
 
mask
)

237 
rc
 = 
	`dma_£t_mask
(
dev
, 
mask
);

239 ià(
rc
 == 0)

240 
	`dma_£t_coh”’t_mask
(
dev
, 
mask
);

242  
rc
;

243 
	}
}

244 
	#dma_£t_mask_ªd_coh”’t
(
dev
, 
mask
) \

245 
	`com·t_dma_£t_mask_ªd_coh”’t
(
dev
, 
mask
)

	)

248 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 14, 0)

249 
	#»que¡_fœmw¬e_dœeù
 
»que¡_fœmw¬e


	)

251 
šlše
 
	$_pci_’abË_msi_¿nge
(
pci_dev
 *
dev
,

252 
mšvec
, 
maxvec
)

254 
nvec
 = 
maxvec
;

255 
rc
;

257 ià(
maxvec
 < 
mšvec
)

258  -
ERANGE
;

261 
rc
 = 
	`pci_’abË_msi_block
(
dev
, 
nvec
);

262 ià(
rc
 < 0) {

263  
rc
;

264 } ià(
rc
 > 0) {

265 ià(
rc
 < 
mšvec
)

266  -
ENOSPC
;

267 
nvec
 = 
rc
;

269 } 
rc
);

271  
nvec
;

272 
	}
}

274 
	#pci_’abË_msi_¿nge
(
dev
, 
mšv
, 
maxv
) \

275 
	`_pci_’abË_msi_¿nge
(
dev
, 
mšv
, 
maxv
)

	)

277 
šlše
 
	$com·t_pci_’abË_msix_¿nge
(
pci_dev
 *
dev
,

278 
msix_’Œy
 *
’Œ›s
,

279 
mšvec
, 
maxvec
)

281 
nvec
 = 
maxvec
;

282 
rc
;

284 ià(
maxvec
 < 
mšvec
)

285  -
ERANGE
;

288 
rc
 = 
	`pci_’abË_msix
(
dev
, 
’Œ›s
, 
nvec
);

289 ià(
rc
 < 0) {

290  
rc
;

291 } ià(
rc
 > 0) {

292 ià(
rc
 < 
mšvec
)

293  -
ENOSPC
;

294 
nvec
 = 
rc
;

296 } 
rc
);

298  
nvec
;

299 
	}
}

301 
	#pci_’abË_msix_¿nge
(
dev
, 
’Œ›s
, 
mšv
, 
maxv
) \

302 
	`com·t_pci_’abË_msix_¿nge
(
dev
, 
’Œ›s
, 
mšv
, 
maxv
)

	)

305 #ià
VER_NON_RHEL_LT
(3, 14è|| 
VER_RHEL_LT
(7, 1)

306 
šlše
 
u32
 
	$´ªdom_u32_max
(
u32
 
max
)

308  
	`´ªdom_u32
(è% 
max
;

309 
	}
}

312 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 26)

313 
	~<lšux/mm.h
>

320 
šlše
 *
	$®loc_·ges_exaù
(
size_t
 
size
, 
gå_t
 
gå_mask
)

322 
Üd”
 = 
	`g‘_Üd”
(
size
);

323 
addr
;

325 
addr
 = 
	`__g‘_ä“_·ges
(
gå_mask
, 
Üd”
);

327  (*)
addr
;

328 
	}
}

330 
šlše
 
	$ä“_·ges_exaù
(*
vœt
, 
size_t
 
size
)

332 
addr
 = ()
vœt
;

333 
’d
 = 
addr
 + 
	`PAGE_ALIGN
(
size
);

335 
addr
 < 
’d
) {

336 
	`ä“_·ge
(
addr
);

337 
addr
 +ð
PAGE_SIZE
;

339 
	}
}

342 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 25)

343 
	~<lšux/deviû.h
>

344 
šlše
 cÚ¡ *
	$dev_Çme
(cÚ¡ 
deviû
 *
dev
)

346  
	`kobjeù_Çme
(&
dev
->
kobj
);

347 
	}
}

350 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 27)

351 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 29)

352 
	~<lšux/á¿û.h
>

353 
	#Œaû_´štk
 
á¿û_´štk


	)

356 
	#Œaû_´štk
(
¬gs
...)

	)

359 #ià(
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 24))

360 
	#_NEED_PROC_CREATE


	)

363 #ià(
RHEL_RELEASE_CODE
 > 
RHEL_RELEASE_VERSION
(5, 0))

364 #undeà
_NEED_PROC_CREATE


367 #ifdeà
_NEED_PROC_CREATE


368 
	~<lšux/´oc_fs.h
>

370 
šlše
 
´oc_dœ_’Œy
 *
	$´oc_ü—‹
(cÚ¡ *
Çme
, 
mode_t
 
mode
,

371 
´oc_dœ_’Œy
 *
·»Á
,

372 cÚ¡ 
fže_Ý”©iÚs


373 *
´oc_fÝs
)

375 
´oc_dœ_’Œy
 *
pde
;

377 
pde
 = 
	`ü—‹_´oc_’Œy
(
Çme
, 
mode
, 
·»Á
);

378 ià(
pde
)

379 
pde
->
´oc_fÝs
 =…roc_fops;

381  
pde
;

382 
	}
}

385 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

386 
	#DMA_BIT_MASK
(
n
è((Òè=ð64è? ~0ULL : ((1ULL << (n)è- 1))

	)

389 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

393 
	~<lšux/£q_fže.h
>

394 
	#£q_Ý’
(
fže
, 
Ý
è
	`cÚ¡_£q_Ý’
(fže, op)

	)

395 
šlše
 
	$cÚ¡_£q_Ý’
(
fže
 *file,

396 cÚ¡ 
£q_Ý”©iÚs
 *
Ý
)

398 
£q_fže
 *
p
 = 
fže
->
´iv©e_d©a
;

400 ià(!
p
) {

401 
p
 = 
	`km®loc
((*p), 
GFP_KERNEL
);

402 ià(!
p
)

403  -
ENOMEM
;

404 
fže
->
´iv©e_d©a
 = 
p
;

406 
	`mem£t
(
p
, 0, (*p));

407 
	`mu‹x_š™
(&
p
->
lock
);

408 
p
->
Ý
 = (
£q_Ý”©iÚs
 *)op;

409 
fže
->
f_v”siÚ
 = 0;

410 
fže
->
f_mode
 &ð~(
FMODE_PREAD
 | 
FMODE_PWRITE
);

412 
	}
}

415 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 33)

416 #iâdeà
sysfs_©Œ_š™


417 
	#sysfs_©Œ_š™
(
x
èdØ{ } 0)

	)

421 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 32)

422 
šlše
 
	$com·t_IS_ERR_OR_NULL
(cÚ¡ *
±r
)

424  !
±r
 || 
	`IS_ERR_VALUE
(()ptr);

425 
	}
}

427 #undeà
IS_ERR_OR_NULL


428 
	#IS_ERR_OR_NULL
(
x
è
	`com·t_IS_ERR_OR_NULL
(x)

	)

431 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 29)

432 
pci_’abË_msi
(
pci_dev
 *
dev
);

433 
šlše
 
	$pci_’abË_msi_block
(
pci_dev
 *
dev
, 
nvec
)

435 ià(
nvec
 > 1)

437  
	`pci_’abË_msi
(
dev
);

438 
	}
}

441 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 28è&& 
defšed
(
CONFIG_X86_32
)

442 
šlše
 
__u64
 
	$»adq
(cÚ¡ 
__iomem
 *
addr
)

444 cÚ¡ 
u32
 
__iomem
 *
p
 = 
addr
;

445 
u32
 
low
, 
high
;

447 
low
 = 
	`»adl
(
p
);

448 
high
 = 
	`»adl
(
p
 + 1);

450  
low
 + ((
u64
)
high
 << 32);

451 
	}
}

453 
šlše
 
	$wr™eq
(
__u64
 
v®
, 
__iomem
 *
addr
)

455 
	`wr™–
(
v®
, 
addr
);

456 
	`wr™–
(
v®
 >> 32, 
addr
 + 4);

457 
	}
}

460 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 0, 0)

461 
	#HAVE_NET_DEVICE_OPS


	)

464 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0))

465 
	#pci_¡Ý_ªd_»move_bus_deviû
 
pci_»move_bus_deviû


	)

468 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 10, 0))

469 
	#PDE_DATA
(
šode
è(
	`PROC_I
(šode)->
pde
->
d©a
)

	)

472 
	~<lšux/mm.h
>

473 #iâdeà
VM_RESERVED


474 
	#VM_RESERVED
 (
VM_DONTEXPAND
 | 
VM_DONTDUMP
)

	)

477 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0))

478 #iâdeà
SIZE_MAX


479 
	#SIZE_MAX
 (~(
size_t
)0)

	)

481 
šlše
 *
	$_km®loc_¬¿y
(
size_t
 
n
, size_ˆ
size
, 
gå_t
 
æags
)

483 ià(
size
 !ð0 && 
n
 > 
SIZE_MAX
 / size)

484  
NULL
;

485  
	`__km®loc
(
n
 * 
size
, 
æags
);

486 
	}
}

488 
	#km®loc_¬¿y
(
n
, 
size
, 
æags
è
	`_km®loc_¬¿y
Ò, size, fÏgs)

	)

491 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 6, 0))

492 
	#SUPPORTED_40000ba£KR4_FuÎ
 
	`BIT
(23)

	)

493 
	#SUPPORTED_40000ba£CR4_FuÎ
 
	`BIT
(24)

	)

494 
	#SUPPORTED_40000ba£SR4_FuÎ
 
	`BIT
(25)

	)

495 
	#SUPPORTED_40000ba£LR4_FuÎ
 
	`BIT
(26)

	)

497 
	#ADVERTISED_40000ba£KR4_FuÎ
 
	`BIT
(23)

	)

498 
	#ADVERTISED_40000ba£CR4_FuÎ
 
	`BIT
(24)

	)

499 
	#ADVERTISED_40000ba£SR4_FuÎ
 
	`BIT
(25)

	)

500 
	#ADVERTISED_40000ba£LR4_FuÎ
 
	`BIT
(26)

	)

504 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 8, 0)) && \

505 (
	gRHEL_RELEASE_CODE
 < 
	$RHEL_RELEASE_VERSION
(6, 5))

506 
šlše
 
	$pci_¤iov_g‘_tÙ®vfs
(
pci_dev
 *
pdev
)

508 
u16
 
tÙ®
 = 0;

509 
pos
;

511 
pos
 = 
	`pci_fšd_ext_ÿ·bž™y
(
pdev
, 
PCI_EXT_CAP_ID_SRIOV
);

512 ià(
pos
)

513 
	`pci_»ad_cÚfig_wÜd
(
pdev
, 
pos
 + 
PCI_SRIOV_TOTAL_VF
, &
tÙ®
);

515  
tÙ®
;

516 
	}
}

519 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 2, 0))

521 
	#PCI_DEV_FLAGS_ASSIGNED
 4

	)

524 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 10, 0)) && \

525 (
	gRHEL_RELEASE_CODE
 < 
	$RHEL_RELEASE_VERSION
(6, 5))

526 
šlše
 
	$pci_vfs_assigÃd
(
pci_dev
 *
pdev
)

528 
pci_dev
 *
vfdev
;

529 
vfs_assigÃd
 = 0;

530 
dev_id
;

531 
pos
;

534 ià(!
pdev
->
is_physâ
)

537 
pos
 = 
	`pci_fšd_ext_ÿ·bž™y
(
pdev
, 
PCI_EXT_CAP_ID_SRIOV
);

538 ià(!
pos
)

545 
	`pci_»ad_cÚfig_wÜd
(
pdev
, 
pos
 + 
PCI_SRIOV_VF_DID
, &
dev_id
);

548 
vfdev
 = 
	`pci_g‘_deviû
(
pdev
->
v’dÜ
, 
dev_id
, 
NULL
);

549 
vfdev
) {

554 ià(
vfdev
->
is_vœtâ
 && (vfdev->
physâ
 =ð
pdev
) &&

555 (
vfdev
->
dev_æags
 & 
PCI_DEV_FLAGS_ASSIGNED
))

556 
vfs_assigÃd
++;

558 
vfdev
 = 
	`pci_g‘_deviû
(
pdev
->
v’dÜ
, 
dev_id
, vfdev);

561  
vfs_assigÃd
;

562 
	}
}

565 #ià
VER_VANILLA_LT
(3, 15è|| 
VER_UBUNTU_LT
(3, 13, 0è|| 
VER_RHEL_LT
(7, 1)

566 
šlše
 
	$kvä“
(*
±r
)

568 ià(
	`is_vm®loc_addr
(
±r
))

569 
	`vä“
(
±r
);

571 
	`kä“
(
±r
);

572 
	}
}

575 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 14, 0))

576 
šlše
 
	$com·t_‘h”_addr_cÝy
(
u8
 *
d¡
, cÚ¡ u8 *
¤c
)

578 #ià
	`defšed
(
CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS
)

579 *(
u32
 *)
d¡
 = *(cÚ¡ u32 *)
¤c
;

580 *(
u16
 *)(
d¡
 + 4èð*(cÚ¡ u16 *)(
¤c
 + 4);

582 
u16
 *
a
 = (u16 *)
d¡
;

583 cÚ¡ 
u16
 *
b
 = (cÚ¡ u16 *)
¤c
;

585 
a
[0] = 
b
[0];

586 
a
[1] = 
b
[1];

587 
a
[2] = 
b
[2];

589 
	}
}

591 
	#‘h”_addr_cÝy
(
d¡
, 
¤c
è
	`com·t_‘h”_addr_cÝy
(d¡, src)

	)

594 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 10, 0))

595 
	#li¡_fœ¡_’Œy_Ü_nuÎ
(
±r
, 
ty³
, 
memb”
) \

596 (!
	`li¡_em±y
(
±r
è? 
	`li¡_fœ¡_’Œy
ÕŒ, 
ty³
, 
memb”
è: 
NULL
)

	)

599 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 0, 0))

600 
šlše
 
	$com·t_k¡¹Þ
(cÚ¡ *
ý
, 
ba£
, *
v®p
)

602 *
tmp
;

603 
v®
;

605 
v®
 = 
	`sim¶e_¡¹Þ
(
ý
, &
tmp
, 
ba£
);

606 ià(!
tmp
 || *tmp != 0)

607  -
EINVAL
;

609 ià(
v®p
)

610 *
v®p
 = 
v®
;

613 
	}
}

615 
	#k¡¹Þ
(
ý
, 
ba£
, 
v®p
è
	`com·t_k¡¹Þ
(ý, ba£, v®p)

	)

621 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 17, 0))

622 
	~<lšux/time.h
>

624 
	~<lšux/timek“pšg.h
>

630 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 17, 0))

631 
	#NET_NAME_UNKNOWN
 ""

	)

632 
šlše


633 
Ãt_deviû
 *
com·t_®loc_Ãtdev
(
sizeof_´iv
,

634 cÚ¡ *
Çme
,

635 cÚ¡ *
assign_ty³
,

636 (*
£tup
)(
Ãt_deviû
 *))

638  
	`®loc_Ãtdev
(
sizeof_´iv
, 
Çme
, 
£tup
);

639 
	}
}

641 #undeà
®loc_Ãtdev


642 
	#®loc_Ãtdev
(
sz
, 
nm
, 
ty
, 
£tup
è
	`com·t_®loc_Ãtdev
(sz,‚m,y, s‘up)

	)

649 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 3, 0)

650 
	#com·t_fÜ_—ch_msi
(
_desc
, 
_dev
) \

651 
	`li¡_fÜ_—ch_’Œy
((
_desc
), &(
_dev
)->
msi_li¡
, 
li¡
)

	)

653 
	#com·t_fÜ_—ch_msi
(
_desc
, 
_dev
) \

654 
	`li¡_fÜ_—ch_’Œy
((
_desc
), &(
_dev
)->
dev
.
msi_li¡
, 
li¡
)

	)

657 #ià!
COMPAT__HAS_DEVLINK


658 
	sdevlšk_pÜt
 {

659 
	mdummy
;

662 
	sdevlšk_Ýs
 {

663 
	mdummy
;

666 
	sdevlšk
 {

667 
	mdummy
;

670 
šlše
 
devlšk
 *

671 
	$devlšk_®loc
(cÚ¡ 
devlšk_Ýs
 *
Ýs
, 
size_t
 
´iv_size
)

673  
	`kz®loc
(
´iv_size
, 
GFP_KERNEL
);

674 
	}
}

676 
šlše
 *
	$devlšk_´iv
(
devlšk
 *
p
)

678  
p
;

679 
	}
}

681 
šlše
 
devlšk
 *
	$´iv_to_devlšk
(*
p
)

683  
p
;

684 
	}
}

686 
šlše
 
	$devlšk_»gi¡”
(
devlšk
 *
p
, 
deviû
 *
d
)

689 
	}
}

691 
šlše
 
	$devlšk_uÄegi¡”
(
devlšk
 *
d
è{ 
	}
}

693 
šlše
 
	$devlšk_ä“
(
devlšk
 *
p
)

695 
	`kä“
(
p
);

696 
	}
}

699 #ià
VER_NON_RHEL_LT
(4, 7è|| 
VER_RHEL_LT
(7, 4)

700 
šlše
 

701 
	$Ãtif_Œªs_upd©e
(
Ãt_deviû
 *
Ãtdev
)

703 
Ãtdev
->
Œªs_¡¬t
 = 
jiff›s
;

704 
	}
}

707 #ià
VER_NON_RHEL_LT
(4, 8è|| 
VER_RHEL_LT
(7, 4)

708 
	edevlšk_esw™ch_mode
 {

709 
	mDEVLINK_ESWITCH_MODE_LEGACY
,

710 
	mDEVLINK_ESWITCH_MODE_SWITCHDEV
,

714 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 10, 0)

715 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 8, 0)

716 
šlše
 cÚ¡ 
fže_Ý”©iÚs
 *

717 
	$com·t_debugfs_»®_fÝs
(cÚ¡ 
fže
 *file)

719  
fže
->
f_·th
.
d’Œy
->
d_fsd©a
;

720 
	}
}

721 
	#debugfs_»®_fÝs
 
com·t_debugfs_»®_fÝs


	)

724 
	#debugfs_»®_fÝs
(
x
è&
nå_tx_q_fÝs


	)

728 #ià
VER_NON_RHEL_LT
(4, 9è|| 
VER_RHEL_LT
(7, 5)

729 
	#_c1
(
x
è((xè& 1)

	)

730 
	#_c2
(
x
è((((x)& 0x0003è&& !
	`_c1
(x)è* ( _c1((xè>> 1è+ 1è+ _c1(x))

	)

731 
	#_c4
(
x
è((((x)& 0x000fè&& !
	`_c2
(x)è* ( _c2((xè>> 2è+ 2è+ _c2(x))

	)

732 
	#_c8
(
x
è((((x)& 0x00ffè&& !
	`_c4
(x)è* ( _c4((xè>> 4è+ 4è+ _c4(x))

	)

733 
	#_c16
(
x
è((((x)& 0xffffè&& !
	`_c8
(x)è* ( _c8((xè>> 8è+ 8è+ _c8(x))

	)

734 
	#_c32
(
x
è((((x)& ~0Uè&& !
	`_c16
(x)è* (_c16((xè>> 16è+ 16è+ _c16(x))

	)

735 
	#_c64
(
x
è((((x)& ~0ULLè&& !
	`_c32
(x)è* (_c32((xè>> 32è+ 32è+ _c32(x))

	)

737 
	#c64
(
x
è(
	`_c64
(xè- 1)

	)

739 
	#FIELD_GET
(
MASK
, 
v®
) \

740 (
	`ty³of
(
MASK
))((((
u64
)
v®
è& (MASK)è>> 
	`c64
((u64)MASK))

	)

741 
	#FIELD_PREP
(
MASK
, 
v®
) \

742 (
	`ty³of
(
MASK
))((((
u64
)
v®
è<< 
	`c64
((u64)MASK)è& (MASK))

	)

743 
	#__bf_shf
 
c64


	)

745 
	#__BF_FIELD_CHECK
(
_mask
, 
_»g
, 
_v®
, 
_pfx
èdØ{} 0)

	)

748 #iâdeà
FIELD_FIT


749 
	#FIELD_FIT
(
mask
, 
v®
è(!((((
u64
)v®è<< 
	`__bf_shf
(mask)è& ~(mask)))

	)

752 
šlše
 
	$com·t_vmf_g‘_addr
(
vm_çuÉ
 *
vmf
)

754 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 10, 0)

755  
vmf
->
add»ss
;

757  ()
vmf
->
vœtu®_add»ss
;

759 
	}
}

761 #ià!
COMPAT__USE_DMA_SKIP_SYNC


762 #undeà
DMA_ATTR_SKIP_CPU_SYNC


763 
	#DMA_ATTR_SKIP_CPU_SYNC
 0

	)

766 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 12, 0)

767 
	gÃŽšk_ext_ack
;

770 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 12, 0)

771 
	#pci_’abË_msix
 
pci_’abË_msix_exaù


	)

774 #ià
VER_NON_RHEL_LT
(4, 14è|| 
VER_RHEL_LT
(7, 6)

775 
šlše
 
tim”_£tup
(
tim”_li¡
 *
t
, (*
f
)(),

776 
æags
)

778 
	`__£tup_tim”
(
t
, 
f
, (é, 
æags
);

779 
	}
}

781 
	#äom_tim”
(
v¬
, 
ÿÎback_tim”
, 
tim”_f›ldÇme
) \

782 
	`cÚš”_of
((*)
ÿÎback_tim”
, 
	`ty³of
(*
v¬
), 
tim”_f›ldÇme
)

	)

788 #ià
VER_RHEL_GE
(7, 5)

789 #undeà
CONFIG_NFP_APP_FLOWER


792 #ià
VER_NON_RHEL_LT
(4, 16è|| 
VER_RHEL_LT
(7, 6)

793 
	sxdp_rxq_šfo
 {

794 
	mem±y
;

798 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 17, 0)

799 
šlše
 
	$pc›_´št_lšk_¡©us
(
pci_dev
 *
dev
)

801 
	}
}

804 #iâdeà
check_mul_ov”æow


805 
	#¬¿y_size
(
a
, 
b
è(×è* (b))

	)

806 
	#¡ruù_size
(
a
, 
b
, 
c
è((*×)è+ (×)->b[0]è* (c))

	)

809 
šlše
 
	$com·t_pci_¤iov_»£t_tÙ®vfs
(
pci_dev
 *
dev
)

811 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 18, 0)

816 
	`pci_¤iov_£t_tÙ®vfs
(
dev
, 0);

818 
	}
}

820 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 18, 0)

821 
šlše
 *
	$kvÿÎoc
(
size_t
 
n
, size_ˆ
size
, 
gå_t
 
æags
)

823 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 12, 0)

824  
	`kvm®loc_¬¿y
(
n
, 
size
, 
æags
 | 
__GFP_ZERO
);

826  
	`kÿÎoc
(
n
, 
size
, 
æags
);

828 
	}
}

831 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 19, 0)

832 
	s»croÿl_v®ue_adv
 {

833 
u32
 
	mm
;

834 
u8
 
	msh
, 
	mexp
;

835 
boÞ
 
	mis_wide_m
;

838 
šlše
 
»croÿl_v®ue_adv
 
	$»croÿl_v®ue_adv
(
u32
 
d
, 
u8
 
´ec
)

840 
»croÿl_v®ue_adv
 
R
;

841 
u32
 
l
, 
po¡_shiá
;

842 
u64
 
mhigh
, 
mlow
;

845 
l
 = 
	`æs
(
d
 - 1);

850 
	`WARN
(
l
 == 32,

852 
d
, 
__func__
);

853 
po¡_shiá
 = 
l
;

854 
mlow
 = 1ULL << (32 + 
l
);

855 
	`do_div
(
mlow
, 
d
);

856 
mhigh
 = (1ULL << (32 + 
l
)è+ (1ULL << (32 +† - 
´ec
));

857 
	`do_div
(
mhigh
, 
d
);

859 ; 
po¡_shiá
 > 0;…ost_shift--) {

860 
u64
 
lo
 = 
mlow
 >> 1, 
hi
 = 
mhigh
 >> 1;

862 ià(
lo
 >ð
hi
)

865 
mlow
 = 
lo
;

866 
mhigh
 = 
hi
;

869 
R
.
m
 = (
u32
)
mhigh
;

870 
R
.
sh
 = 
po¡_shiá
;

871 
R
.
exp
 = 
l
;

872 
R
.
is_wide_m
 = 
mhigh
 > 
U32_MAX
;

874  
R
;

875 
	}
}

878 #ià
VER_NON_RHEL_LT
(4, 19è|| 
VER_RHEL_LT
(8, 0)

879 
	sxdp_©chm’t_šfo
 {

880 
bpf_´og
 *
	m´og
;

881 
u32
 
	mæags
;

885 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 20, 0)

886 
sigšfo_t
 
	tk”Ãl_sigšfo_t
;

	@src/nfpcore/nfp.h

9 #iâdeà
__NFP_H__


10 
	#__NFP_H__


	)

12 
	~"kcom·t.h
"

14 
	~<lšux/deviû.h
>

15 
	~<lšux/ty³s.h
>

17 
	~"nå_ýp.h
"

21 
	gnå_hwšfo
;

22 
nå_hwšfo
 *
nå_hwšfo_»ad
(
nå_ýp
 *
ýp
);

23 cÚ¡ *
nå_hwšfo_lookup
(
nå_hwšfo
 *
hwšfo
, cÚ¡ *
lookup
);

24 *
nå_hwšfo_g‘_·cked_¡ršgs
(
nå_hwšfo
 *
hwšfo
);

25 
u32
 
nå_hwšfo_g‘_·cked_¡r_size
(
nå_hwšfo
 *
hwšfo
);

29 
	gnå_n¥
;

31 
nå_ýp
 *
nå_n¥_ýp
(
nå_n¥
 *
¡©e
);

32 
boÞ
 
nå_n¥_cÚfig_modif›d
(
nå_n¥
 *
¡©e
);

33 
nå_n¥_cÚfig_£t_modif›d
(
nå_n¥
 *
¡©e
, 
boÞ
 
modif›d
);

34 *
nå_n¥_cÚfig_’Œ›s
(
nå_n¥
 *
¡©e
);

35 
nå_n¥_cÚfig_idx
(
nå_n¥
 *
¡©e
);

36 
nå_n¥_cÚfig_£t_¡©e
(
nå_n¥
 *
¡©e
, *
’Œ›s
,

37 
idx
);

38 
nå_n¥_cÚfig_þ—r_¡©e
(
nå_n¥
 *
¡©e
);

39 
nå_n¥_»ad_‘h_bË
(
nå_n¥
 *
¡©e
, *
buf
, 
size
);

40 
nå_n¥_wr™e_‘h_bË
(
nå_n¥
 *
¡©e
,

41 cÚ¡ *
buf
, 
size
);

42 
nå_n¥_»ad_id’tify
(
nå_n¥
 *
¡©e
, *
buf
, 
size
);

43 
nå_n¥_»ad_£nsÜs
(
nå_n¥
 *
¡©e
, 
£nsÜ_mask
,

44 *
buf
, 
size
);

51 
	#NFP_RESOURCE_VNIC_PCI_0
 "vnic.p0"

	)

52 
	#NFP_RESOURCE_VNIC_PCI_1
 "vnic.p1"

	)

53 
	#NFP_RESOURCE_VNIC_PCI_2
 "vnic.p2"

	)

54 
	#NFP_RESOURCE_VNIC_PCI_3
 "vnic.p3"

	)

57 
	#NFP_RESOURCE_NFP_HWINFO
 "nå.šfo"

	)

60 
	#NFP_RESOURCE_NSP
 "nå.¥"

	)

61 
	#NFP_RESOURCE_NSP_DIAG
 "¬m.dŸg"

	)

64 
	#NFP_RESOURCE_NFP_NFFW
 "nå.nffw"

	)

67 
	#NFP_RESOURCE_MAC_STATISTICS
 "mac.¡©"

	)

69 
nå_»sourû_bË_š™
(
nå_ýp
 *
ýp
);

71 
nå_»sourû
 *

72 
nå_»sourû_acquœe
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
);

74 
nå_»sourû_»Ëa£
(
nå_»sourû
 *
»s
);

76 
nå_»sourû_wa™
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
, 
£cs
);

78 
u32
 
nå_»sourû_ýp_id
(
nå_»sourû
 *
»s
);

80 cÚ¡ *
nå_»sourû_Çme
(
nå_»sourû
 *
»s
);

82 
u64
 
nå_»sourû_add»ss
(
nå_»sourû
 *
»s
);

84 
u64
 
nå_»sourû_size
(
nå_»sourû
 *
»s
);

	@src/nfpcore/nfp6000/nfp6000.h

4 #iâdeà
NFP6000_NFP6000_H


5 
	#NFP6000_NFP6000_H


	)

7 
	~<lšux/”ºo.h
>

8 
	~<lšux/ty³s.h
>

11 
	#NFP_CPP_TARGET_INVALID
 0

	)

12 
	#NFP_CPP_TARGET_NBI
 1

	)

13 
	#NFP_CPP_TARGET_QDR
 2

	)

14 
	#NFP_CPP_TARGET_ILA
 6

	)

15 
	#NFP_CPP_TARGET_MU
 7

	)

16 
	#NFP_CPP_TARGET_PCIE
 9

	)

17 
	#NFP_CPP_TARGET_ARM
 10

	)

18 
	#NFP_CPP_TARGET_CRYPTO
 12

	)

19 
	#NFP_CPP_TARGET_ISLAND_XPB
 14

	)

20 
	#NFP_CPP_TARGET_ISLAND_CAP
 14

	)

21 
	#NFP_CPP_TARGET_CT_XPB
 14

	)

22 
	#NFP_CPP_TARGET_LOCAL_SCRATCH
 15

	)

23 
	#NFP_CPP_TARGET_CLS
 
NFP_CPP_TARGET_LOCAL_SCRATCH


	)

25 
	#NFP_ISL_EMEM0
 24

	)

27 
	#NFP_MU_ADDR_ACCESS_TYPE_MASK
 3ULL

	)

28 
	#NFP_MU_ADDR_ACCESS_TYPE_DIRECT
 2ULL

	)

30 
	#PUSHPULL
(
_puÎ
, 
_push
è((_puÎè<< 4 | (_pushè<< 0)

	)

31 
	#PUSH_WIDTH
(
_pushpuÎ
è
	`pushpuÎ_width
((_pushpuÎè>> 0)

	)

32 
	#PULL_WIDTH
(
_pushpuÎ
è
	`pushpuÎ_width
((_pushpuÎè>> 4)

	)

34 
šlše
 
	$pushpuÎ_width
(
µ
)

36 
µ
 &= 0xf;

38 ià(
µ
 == 0)

39  -
EINVAL
;

40  2 << 
µ
;

41 
	}
}

43 
šlše
 
	$nå_ý·t_mu_loÿl™y_lsb
(
mode
, 
boÞ
 
addr40
)

45 
mode
) {

47  
addr40
 ? 38 : 30;

49  -
EINVAL
;

51 
	}
}

53 
nå_rg‘_pushpuÎ
(
u32
 
ýp_id
, 
u64
 
add»ss
);

54 
nå_rg‘_ýp
(
u32
 
ýp_i¦ªd_id
, 
u64
 
ýp_i¦ªd_add»ss
,

55 
u32
 *
ýp_rg‘_id
, 
u64
 *
ýp_rg‘_add»ss
,

56 cÚ¡ 
u32
 *
imb_bË
);

	@src/nfpcore/nfp6000/nfp_xpb.h

9 #iâdeà
NFP6000_XPB_H


10 
	#NFP6000_XPB_H


	)

14 
	#NFP_XPB_OVERLAY
(
i¦ªd
è(((i¦ªdè& 0x3fè<< 24)

	)

16 
	#NFP_XPB_ISLAND
(
i¦ªd
è(
	`NFP_XPB_OVERLAY
(i¦ªdè+ 0x60000)

	)

18 
	#NFP_XPB_ISLAND_of
(
off£t
è(((off£tè>> 24è& 0x3F)

	)

22 
	#NFP_XPB_DEVICE
(
i¦ªd
, 
¦ave
, 
deviû
) \

23 (
	`NFP_XPB_OVERLAY
(
i¦ªd
) | \

24 (((
¦ave
) & 3) << 22) | \

25 (((
deviû
è& 0x3fè<< 16))

	)

	@src/nfpcore/nfp6000_pcie.c

18 
	~<asm/uÇligÃd.h
>

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/moduË.h
>

21 
	~<lšux/k»f.h
>

22 
	~<lšux/io.h
>

23 
	~<lšux/d–ay.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/sÜt.h
>

26 
	~<lšux/sched.h
>

27 
	~<lšux/ty³s.h
>

28 
	~<lšux/pci.h
>

30 
	~"nå_ýp.h
"

31 
	~"nå_dev.h
"

33 
	~"nå6000/nå6000.h
"

35 
	~"nå6000_pc›.h
"

37 
	#NFP_PCIE_BAR
(
_pf
è(0x30000 + ((_pfè& 7è* 0xc0)

	)

38 
	#NFP_PCIE_BAR_EXPLICIT_BAR0
(
_x
, 
_y
) \

39 (0x00000080 + (0x40 * ((
_x
è& 0x3)è+ (0x10 * ((
_y
è& 0x3)))

	)

40 
	#NFP_PCIE_BAR_EXPLICIT_BAR0_SigÇlTy³
(
_x
è(((_xè& 0x3è<< 30)

	)

41 
	#NFP_PCIE_BAR_EXPLICIT_BAR0_SigÇlTy³_of
(
_x
è(((_xè>> 30è& 0x3)

	)

42 
	#NFP_PCIE_BAR_EXPLICIT_BAR0_Tok’
(
_x
è(((_xè& 0x3è<< 28)

	)

43 
	#NFP_PCIE_BAR_EXPLICIT_BAR0_Tok’_of
(
_x
è(((_xè>> 28è& 0x3)

	)

44 
	#NFP_PCIE_BAR_EXPLICIT_BAR0_Add»ss
(
_x
è(((_xè& 0xffffffè<< 0)

	)

45 
	#NFP_PCIE_BAR_EXPLICIT_BAR0_Add»ss_of
(
_x
è(((_xè>> 0è& 0xffffff)

	)

46 
	#NFP_PCIE_BAR_EXPLICIT_BAR1
(
_x
, 
_y
) \

47 (0x00000084 + (0x40 * ((
_x
è& 0x3)è+ (0x10 * ((
_y
è& 0x3)))

	)

48 
	#NFP_PCIE_BAR_EXPLICIT_BAR1_SigÇlRef
(
_x
è(((_xè& 0x7fè<< 24)

	)

49 
	#NFP_PCIE_BAR_EXPLICIT_BAR1_SigÇlRef_of
(
_x
è(((_xè>> 24è& 0x7f)

	)

50 
	#NFP_PCIE_BAR_EXPLICIT_BAR1_D©aMa¡”
(
_x
è(((_xè& 0x3ffè<< 14)

	)

51 
	#NFP_PCIE_BAR_EXPLICIT_BAR1_D©aMa¡”_of
(
_x
è(((_xè>> 14è& 0x3ff)

	)

52 
	#NFP_PCIE_BAR_EXPLICIT_BAR1_D©aRef
(
_x
è(((_xè& 0x3fffè<< 0)

	)

53 
	#NFP_PCIE_BAR_EXPLICIT_BAR1_D©aRef_of
(
_x
è(((_xè>> 0è& 0x3fff)

	)

54 
	#NFP_PCIE_BAR_EXPLICIT_BAR2
(
_x
, 
_y
) \

55 (0x00000088 + (0x40 * ((
_x
è& 0x3)è+ (0x10 * ((
_y
è& 0x3)))

	)

56 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_T¬g‘
(
_x
è(((_xè& 0xfè<< 28)

	)

57 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_T¬g‘_of
(
_x
è(((_xè>> 28è& 0xf)

	)

58 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_AùiÚ
(
_x
è(((_xè& 0x1fè<< 23)

	)

59 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_AùiÚ_of
(
_x
è(((_xè>> 23è& 0x1f)

	)

60 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_L’gth
(
_x
è(((_xè& 0x1fè<< 18)

	)

61 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_L’gth_of
(
_x
è(((_xè>> 18è& 0x1f)

	)

62 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_By‹Mask
(
_x
è(((_xè& 0xffè<< 10)

	)

63 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_By‹Mask_of
(
_x
è(((_xè>> 10è& 0xff)

	)

64 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_SigÇlMa¡”
(
_x
è(((_xè& 0x3ffè<< 0)

	)

65 
	#NFP_PCIE_BAR_EXPLICIT_BAR2_SigÇlMa¡”_of
(
_x
è(((_xè>> 0è& 0x3ff)

	)

67 
	#NFP_PCIE_BAR_PCIE2CPP_AùiÚ_Ba£Add»ss
(
_x
è(((_xè& 0x1fè<< 16)

	)

68 
	#NFP_PCIE_BAR_PCIE2CPP_AùiÚ_Ba£Add»ss_of
(
_x
è(((_xè>> 16è& 0x1f)

	)

69 
	#NFP_PCIE_BAR_PCIE2CPP_Ba£Add»ss
(
_x
è(((_xè& 0xffffè<< 0)

	)

70 
	#NFP_PCIE_BAR_PCIE2CPP_Ba£Add»ss_of
(
_x
è(((_xè>> 0è& 0xffff)

	)

71 
	#NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù
(
_x
è(((_xè& 0x3è<< 27)

	)

72 
	#NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_of
(
_x
è(((_xè>> 27è& 0x3)

	)

73 
	#NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_32BIT
 0

	)

74 
	#NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_64BIT
 1

	)

75 
	#NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_0BYTE
 3

	)

76 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(
_x
è(((_xè& 0x7è<< 29)

	)

77 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_of
(
_x
è(((_xè>> 29è& 0x7)

	)

78 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_FIXED
 0

	)

79 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_BULK
 1

	)

80 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_TARGET
 2

	)

81 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_GENERAL
 3

	)

82 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT0
 4

	)

83 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT1
 5

	)

84 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT2
 6

	)

85 
	#NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT3
 7

	)

86 
	#NFP_PCIE_BAR_PCIE2CPP_T¬g‘_Ba£Add»ss
(
_x
è(((_xè& 0xfè<< 23)

	)

87 
	#NFP_PCIE_BAR_PCIE2CPP_T¬g‘_Ba£Add»ss_of
(
_x
è(((_xè>> 23è& 0xf)

	)

88 
	#NFP_PCIE_BAR_PCIE2CPP_Tok’_Ba£Add»ss
(
_x
è(((_xè& 0x3è<< 21)

	)

89 
	#NFP_PCIE_BAR_PCIE2CPP_Tok’_Ba£Add»ss_of
(
_x
è(((_xè>> 21è& 0x3)

	)

90 
	#NFP_PCIE_EM
 0x020000

	)

91 
	#NFP_PCIE_SRAM
 0x000000

	)

96 
	#NFP_PCI_MIN_MAP_SIZE
 0x080000

	)

98 
	#NFP_PCIE_P2C_FIXED_SIZE
(
b¬
è(1 << (b¬)->
b™size
)

	)

99 
	#NFP_PCIE_P2C_BULK_SIZE
(
b¬
è(1 << (b¬)->
b™size
)

	)

100 
	#NFP_PCIE_P2C_GENERAL_TARGET_OFFSET
(
b¬
, 
x
è((xè<< ((b¬)->
b™size
 - 2))

	)

101 
	#NFP_PCIE_P2C_GENERAL_TOKEN_OFFSET
(
b¬
, 
x
è((xè<< ((b¬)->
b™size
 - 4))

	)

102 
	#NFP_PCIE_P2C_GENERAL_SIZE
(
b¬
è(1 << ((b¬)->
b™size
 - 4))

	)

104 
	#NFP_PCIE_P2C_EXPBAR_OFFSET
(
b¬_šdex
è((b¬_šdexè* 4)

	)

110 
	gnå6000_ex¶ic™_b¬s
 = 2;

111 
moduË_·¿m
(
nå6000_ex¶ic™_b¬s
, , 0444);

112 
MODULE_PARM_DESC
(
nå6000_ex¶ic™_b¬s
, "Number ofƒxplicit BARs (0-4)");

113 
	#NFP_PCIE_EXPLICIT_BARS
 
nå6000_ex¶ic™_b¬s


	)

117 
	gnå6000_debug
;

118 
moduË_·¿m
(
nå6000_debug
, , 0644);

119 
MODULE_PARM_DESC
(
nå6000_debug
, "Enable debugging forhe NFP6000 PCIe");

120 
	#NFP_PCIE_VERBOSE_DEBUG
 
nå6000_debug


	)

122 
	#nå6000_dbg
(
¬g
...) \

124 ià(
NFP_PCIE_VERBOSE_DEBUG
) \

125 
	`dev_dbg
(
¬g
); \

126 } 0)

	)

128 
	gnå6000_pc›
;

129 
	gnå6000_¬—_´iv
;

143 
	snå_b¬
 {

144 
nå6000_pc›
 *
	mnå
;

145 
u32
 
	mb¬cfg
;

146 
u64
 
	mba£
;

147 
u64
 
	mmask
;

148 
u32
 
	mb™size
;

149 
	mšdex
;

150 
©omic_t
 
	m»fút
;

152 
__iomem
 *
	miomem
;

153 
»sourû
 *
	m»sourû
;

156 
	#NFP_PCI_BAR_MAX
 (
PCI_64BIT_BAR_COUNT
 * 8)

	)

158 
	snå6000_pc›
 {

159 
pci_dev
 *
	mpdev
;

160 
deviû
 *
	mdev
;

161 cÚ¡ 
nå_dev_šfo
 *
	mdev_šfo
;

164 
¥šlock_t
 
	mb¬_lock
;

165 
	mb¬s
;

166 
nå_b¬
 
	mb¬
[
NFP_PCI_BAR_MAX
];

167 
wa™_queue_h—d_t
 
	mb¬_wa™”s
;

171 
__iomem
 *
	mc¤
;

172 
__iomem
 *
	mem
;

173 
__iomem
 *
	mex¶
[4];

174 } 
	miomem
;

178 
mu‹x
 
	mmu‹x
;

179 
u8
 
	mma¡”_id
;

180 
u8
 
	msigÇl_»f
;

181 
__iomem
 *
	md©a
;

183 
__iomem
 *
	maddr
;

184 
	mb™size
;

185 
	mä“
[4];

186 } 
	mgroup
[4];

187 } 
	mex¶
;

190 
nå_em_mªag”
 *
	mev’t
;

193 
u32
 
	$nå_b¬_m­ty³
(
nå_b¬
 *
b¬
)

195  
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³_of
(
b¬
->
b¬cfg
);

196 
	}
}

198 
»sourû_size_t
 
	$nå_b¬_»sourû_Ën
(
nå_b¬
 *
b¬
)

200  
	`pci_»sourû_Ën
(
b¬
->
nå
->
pdev
, (b¬->
šdex
 / 8) * 2) / 8;

201 
	}
}

203 
»sourû_size_t
 
	$nå_b¬_»sourû_¡¬t
(
nå_b¬
 *
b¬
)

205  
	`pci_»sourû_¡¬t
(
b¬
->
nå
->
pdev
, (b¬->
šdex
 / 8) * 2)

206 + 
	`nå_b¬_»sourû_Ën
(
b¬
è* (b¬->
šdex
 & 7);

207 
	}
}

209 
	#TARGET_WIDTH_32
 4

	)

210 
	#TARGET_WIDTH_64
 8

	)

213 
	$compu‹_b¬
(cÚ¡ 
nå6000_pc›
 *
nå
, cÚ¡ 
nå_b¬
 *
b¬
,

214 
u32
 *
b¬_cÚfig
, 
u64
 *
b¬_ba£
,

215 
tgt
, 
aù
, 
tok
, 
u64
 
off£t
, 
size_t
 
size
, 
width
)

217 
b™size
;

218 
u32
 
Ãwcfg
;

220 ià(
tgt
 >ð
NFP_CPP_NUM_TARGETS
)

221  -
EINVAL
;

223 
width
) {

225 
Ãwcfg
 = 
	`NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù
(

226 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_64BIT
);

229 
Ãwcfg
 = 
	`NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù
(

230 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_32BIT
);

233 
Ãwcfg
 = 
	`NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù
(

234 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_0BYTE
);

237  -
EINVAL
;

240 ià(
aù
 !ð
NFP_CPP_ACTION_RW
 &&‡ct != 0) {

242 
u64
 
mask
 = ~(
	`NFP_PCIE_P2C_FIXED_SIZE
(
b¬
) - 1);

244 
Ãwcfg
 |ð
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

245 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_FIXED
);

246 
Ãwcfg
 |ð
	`NFP_PCIE_BAR_PCIE2CPP_T¬g‘_Ba£Add»ss
(
tgt
);

247 
Ãwcfg
 |ð
	`NFP_PCIE_BAR_PCIE2CPP_AùiÚ_Ba£Add»ss
(
aù
);

248 
Ãwcfg
 |ð
	`NFP_PCIE_BAR_PCIE2CPP_Tok’_Ba£Add»ss
(
tok
);

250 ià((
off£t
 & 
mask
è!ð((off£ˆ+ 
size
 - 1) & mask)) {

251 
	`nå6000_dbg
(
nå
->
dev
, "BAR%d: Won't use for Fixed mapping <%#llx,%#llx>,‡ction=%d. BARoo small (0x%llx).\n",

252 
b¬
->
šdex
, 
off£t
, off£ˆ+ 
size
, 
aù
,

253 ()
mask
);

254  -
EINVAL
;

256 
off£t
 &ð
mask
;

258 
	`nå6000_dbg
(
nå
->
dev
, "BAR%d: Created Fixed mapping %d:%d:%d:0x%#llx-0x%#llx>\n",

259 
b¬
->
šdex
, 
tgt
, 
aù
, 
tok
, 
off£t
, off£ˆ+ 
mask
);

261 
b™size
 = 40 - 16;

263 
u64
 
mask
 = ~(
	`NFP_PCIE_P2C_BULK_SIZE
(
b¬
) - 1);

266 
Ãwcfg
 |ð
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

267 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_BULK
);

268 
Ãwcfg
 |ð
	`NFP_PCIE_BAR_PCIE2CPP_T¬g‘_Ba£Add»ss
(
tgt
);

269 
Ãwcfg
 |ð
	`NFP_PCIE_BAR_PCIE2CPP_Tok’_Ba£Add»ss
(
tok
);

271 ià((
off£t
 & 
mask
è!ð((off£ˆ+ 
size
 - 1) & mask)) {

272 
	`nå6000_dbg
(
nå
->
dev
, "BAR%d: Won't use for bulk mapping <%#llx,%#llx>,arget=%d,oken=%d. BARoo small (%#llx) - (%#llx != %#llx).\n",

273 
b¬
->
šdex
, 
off£t
, off£ˆ+ 
size
,

274 
tgt
, 
tok
, 
mask
, 
off£t
 & mask,

275 (
off£t
 + 
size
 - 1è& 
mask
);

276  -
EINVAL
;

279 
off£t
 &ð
mask
;

281 
	`nå6000_dbg
(
nå
->
dev
, "BAR%d: Created bulk mapping %d:x:%d:%#llx-%#llx\n",

282 
b¬
->
šdex
, 
tgt
, 
tok
, 
off£t
, off£ˆ+ ~
mask
);

284 
b™size
 = 40 - 21;

287 ià(
b¬
->
b™size
 < bitsize) {

288 
	`nå6000_dbg
(
nå
->
dev
, "BAR%d: Too small for %d:%d:%d\n",

289 
b¬
->
šdex
, 
tgt
, 
tok
, 
aù
);

290  -
EINVAL
;

293 
Ãwcfg
 |ð
off£t
 >> 
b™size
;

295 ià(
b¬_ba£
)

296 *
b¬_ba£
 = 
off£t
;

298 ià(
b¬_cÚfig
)

299 *
b¬_cÚfig
 = 
Ãwcfg
;

302 
	}
}

305 
	$nå6000_b¬_wr™e
(
nå6000_pc›
 *
nå
, 
nå_b¬
 *
b¬
, 
u32
 
Ãwcfg
)

307 
xb¬
;

309 
xb¬
 = 
	`NFP_PCIE_P2C_EXPBAR_OFFSET
(
b¬
->
šdex
);

311 ià(
nå
->
iomem
.
c¤
) {

312 
	`wr™–
(
Ãwcfg
, 
nå
->
iomem
.
c¤
 + 
xb¬
);

314 
	`»adl
(
nå
->
iomem
.
c¤
 + 
xb¬
);

316 
xb¬
 +ð
nå
->
dev_šfo
->
pc›_cfg_expb¬_off£t
;

317 
	`pci_wr™e_cÚfig_dwÜd
(
nå
->
pdev
, 
xb¬
, 
Ãwcfg
);

320 
b¬
->
b¬cfg
 = 
Ãwcfg
;

322 
	`nå6000_dbg
(
nå
->
dev
, "BAR%d: upd©edØ0x%08x\n", 
b¬
->
šdex
, 
Ãwcfg
);

325 
	}
}

328 
	$»cÚfigu»_b¬
(
nå6000_pc›
 *
nå
, 
nå_b¬
 *
b¬
,

329 
tgt
, 
aù
, 
tok
, 
u64
 
off£t
, 
size_t
 
size
, 
width
)

331 
u64
 
Ãwba£
;

332 
u32
 
Ãwcfg
;

333 
”r
;

335 
”r
 = 
	`compu‹_b¬
(
nå
, 
b¬
, &
Ãwcfg
, &
Ãwba£
,

336 
tgt
, 
aù
, 
tok
, 
off£t
, 
size
, 
width
);

337 ià(
”r
)

338  
”r
;

340 
b¬
->
ba£
 = 
Ãwba£
;

342  
	`nå6000_b¬_wr™e
(
nå
, 
b¬
, 
Ãwcfg
);

343 
	}
}

346 
	$m©chšg_b¬
(
nå_b¬
 *
b¬
, 
u32
 
tgt
, u32 
aù
, u32 
tok
,

347 
u64
 
off£t
, 
size_t
 
size
, 
width
)

349 
nå6000_pc›
 *
nå
 = 
b¬
->nfp;

350 
u32
 
m­ty³
;

351 
b¬tgt
, 
b¬aù
, 
b¬tok
;

352 
b¬width
;

354 
m­ty³
 = 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³_of
(
b¬
->
b¬cfg
);

355 
b¬tgt
 = 
	`NFP_PCIE_BAR_PCIE2CPP_T¬g‘_Ba£Add»ss_of
(
b¬
->
b¬cfg
);

356 
b¬tok
 = 
	`NFP_PCIE_BAR_PCIE2CPP_Tok’_Ba£Add»ss_of
(
b¬
->
b¬cfg
);

357 
b¬aù
 = 
	`NFP_PCIE_BAR_PCIE2CPP_AùiÚ_Ba£Add»ss_of
(
b¬
->
b¬cfg
);

359 
b¬width
 = 
	`NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_of
(
b¬
->
b¬cfg
);

360 
b¬width
) {

361 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_32BIT
:

362 
b¬width
 = 4;

364 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_64BIT
:

365 
b¬width
 = 8;

367 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_0BYTE
:

368 
b¬width
 = 0;

371 
b¬width
 = -1;

375 ià(
NFP_PCIE_VERBOSE_DEBUG
) {

376 
	`dev_dbg
(
nå
->
dev
, "BAR[%d] want: %d:%d:%d:0x%llx-0x%llx (%d bit)\n",

377 
b¬
->
šdex
, 
tgt
, 
aù
, 
tok
,

378 
off£t
,

379 
off£t
 + 
size
 - 1, 
width
 * 8);

381 
m­ty³
) {

382 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_FIXED
:

383 
	`dev_dbg
(
nå
->
dev
, "BAR[%d] have: %d:%d:%d:0x%llx-0x%llx (%d bit)\n",

384 
b¬
->
šdex
,

385 
b¬tgt
, 
b¬aù
, 
b¬tok
,

386 
b¬
->
ba£
,

387 (
b¬
->
ba£
 + (1 << b¬->
b™size
) - 1),

388 
b¬width
 * 8);

390 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_BULK
:

391 
	`dev_dbg
(
nå
->
dev
, "BAR[%d] have: %d:x:%d:0x%llx-0x%llx (%d bit)\n",

392 
b¬
->
šdex
,

393 
b¬tgt
, 
b¬tok
,

394 
b¬
->
ba£
,

395 (
b¬
->
ba£
 + (1 << b¬->
b™size
) - 1),

396 
b¬width
 * 8);

398 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_TARGET
:

399 
	`dev_dbg
(
nå
->
dev
, "BAR[%d] have: %d:x:-:0x%llx-0x%llx (%d bit)\n",

400 
b¬
->
šdex
,

401 
b¬tgt
,

402 
b¬
->
ba£
,

403 (
b¬
->
ba£
 + (1 << b¬->
b™size
) - 1),

404 
b¬width
 * 8);

406 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_GENERAL
:

407 
	`dev_dbg
(
nå
->
dev
, "BAR[%d] have: -:x:-:0x%llx-0x%llx (%d bit)\n",

408 
b¬
->
šdex
,

409 
b¬
->
ba£
,

410 (
b¬
->
ba£
 + (1 << b¬->
b™size
) - 1),

411 
b¬width
 * 8);

414 
	`dev_dbg
(
nå
->
dev
, "BAR[%d] is Explicit Group %d\n",

415 
b¬
->
šdex
, 
m­ty³
 & 3);

420 
m­ty³
) {

421 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_TARGET
:

422 
b¬tok
 = -1;

424 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_BULK
:

425 
b¬aù
 = 
NFP_CPP_ACTION_RW
;

426 ià(
aù
 == 0)

427 
aù
 = 
NFP_CPP_ACTION_RW
;

429 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_FIXED
:

437 ià(
b¬width
 !ð
width
)

440 ià((
b¬tgt
 < 0 || b¬tgˆ=ð
tgt
) &&

441 (
b¬tok
 < 0 || b¬tok =ð
tok
) &&

442 (
b¬aù
 =ð
aù
) &&

443 
b¬
->
ba£
 <ð
off£t
 &&

444 (
b¬
->
ba£
 + (1 << b¬->
b™size
)è>ð(
off£t
 + 
size
))

449 
	}
}

452 
	$fšd_m©chšg_b¬
(
nå6000_pc›
 *
nå
,

453 
u32
 
tgt
, u32 
aù
, u32 
tok
, 
u64
 
off£t
, 
size_t
 
size
, 
width
)

455 
n
;

457 
n
 = 0;‚ < 
nå
->
b¬s
;‚++) {

458 
nå_b¬
 *
b¬
 = &
nå
->b¬[
n
];

460 ià(
	`m©chšg_b¬
(
b¬
, 
tgt
, 
aù
, 
tok
, 
off£t
, 
size
, 
width
)) {

461 
	`nå6000_dbg
(
nå
->
dev
, "Found matching BAR%d for <%#llx,%#llx>,arget=%d,‡ction=%d,oken=%d\n",

462 
b¬
->
šdex
, 
off£t
,

463 
off£t
 + 
size
, 
tgt
, 
aù
, 
tok
);

464  
n
;

469 
	}
}

473 
	$fšd_unu£d_b¬_noblock
(cÚ¡ 
nå6000_pc›
 *
nå
,

474 
tgt
, 
aù
, 
tok
,

475 
u64
 
off£t
, 
size_t
 
size
, 
width
)

477 
n
, 
busy
 = 0;

479 
n
 = 0;‚ < 
nå
->
b¬s
;‚++) {

480 cÚ¡ 
nå_b¬
 *
b¬
 = &
nå
->b¬[
n
];

481 
”r
;

483 ià(!
b¬
->
b™size
)

487 
”r
 = 
	`compu‹_b¬
(
nå
, 
b¬
, 
NULL
, NULL,

488 
tgt
, 
aù
, 
tok
, 
off£t
, 
size
, 
width
);

489 ià(
”r
)

492 ià(!
	`©omic_»ad
(&
b¬
->
»fút
))

493  
n
;

495 
busy
++;

498 ià(
	`WARN
(!
busy
, "No suitable BAR found for„equestgt:0x%x‡ct:0x%xok:0x%x off:0x%llx size:%zd width:%d\n",

499 
tgt
, 
aù
, 
tok
, 
off£t
, 
size
, 
width
))

500  -
EINVAL
;

502  -
EAGAIN
;

503 
	}
}

506 
	$fšd_unu£d_b¬_ªd_lock
(
nå6000_pc›
 *
nå
,

507 
tgt
, 
aù
, 
tok
,

508 
u64
 
off£t
, 
size_t
 
size
, 
width
)

510 
æags
;

511 
n
;

513 
	`¥š_lock_œq§ve
(&
nå
->
b¬_lock
, 
æags
);

515 
n
 = 
	`fšd_unu£d_b¬_noblock
(
nå
, 
tgt
, 
aù
, 
tok
, 
off£t
, 
size
, 
width
);

516 ià(
n
 < 0)

517 
	`¥š_uÆock_œq»¡Üe
(&
nå
->
b¬_lock
, 
æags
);

519 
	`__»Ëa£
(&
nå
->
b¬_lock
);

521  
n
;

522 
	}
}

524 
	$nå_b¬_g‘
(
nå6000_pc›
 *
nå
, 
nå_b¬
 *
b¬
)

526 
	`©omic_šc
(&
b¬
->
»fút
);

527 
	}
}

529 
	$nå_b¬_put
(
nå6000_pc›
 *
nå
, 
nå_b¬
 *
b¬
)

531 ià(
	`©omic_dec_ªd_‹¡
(&
b¬
->
»fút
))

532 
	`wake_up_š‹¼u±ibË
(&
nå
->
b¬_wa™”s
);

533 
	}
}

536 
	$nå_wa™_fÜ_b¬
(
nå6000_pc›
 *
nå
, *
b¬num
,

537 
u32
 
tgt
, u32 
aù
, u32 
tok
, 
u64
 
off£t
, 
size_t
 
size
, 
width
)

539  
	`wa™_ev’t_š‹¼u±ibË
(
nå
->
b¬_wa™”s
,

540 (*
b¬num
 = 
	`fšd_unu£d_b¬_ªd_lock
(
nå
, 
tgt
, 
aù
, 
tok
,

541 
off£t
, 
size
, 
width
))

542 !ð-
EAGAIN
);

543 
	}
}

546 
	$nå_®loc_b¬
(
nå6000_pc›
 *
nå
,

547 
u32
 
tgt
, u32 
aù
, u32 
tok
,

548 
u64
 
off£t
, 
size_t
 
size
, 
width
, 
nÚblockšg
)

550 
œqæags
;

551 
b¬num
, 
»tv®
;

553 ià(
size
 > (1 << 24))

554  -
EINVAL
;

556 
	`¥š_lock_œq§ve
(&
nå
->
b¬_lock
, 
œqæags
);

557 
b¬num
 = 
	`fšd_m©chšg_b¬
(
nå
, 
tgt
, 
aù
, 
tok
, 
off£t
, 
size
, 
width
);

558 ià(
b¬num
 >= 0) {

560 
	`nå_b¬_g‘
(
nå
, &nå->
b¬
[
b¬num
]);

561 
	`¥š_uÆock_œq»¡Üe
(&
nå
->
b¬_lock
, 
œqæags
);

562  
b¬num
;

565 
b¬num
 = 
	`fšd_unu£d_b¬_noblock
(
nå
, 
tgt
, 
aù
, 
tok
,

566 
off£t
, 
size
, 
width
);

567 ià(
b¬num
 < 0) {

568 ià(
nÚblockšg
)

569 
”r_nob¬
;

575 
	`¥š_uÆock_œq»¡Üe
(&
nå
->
b¬_lock
, 
œqæags
);

576 
»tv®
 = 
	`nå_wa™_fÜ_b¬
(
nå
, &
b¬num
, 
tgt
, 
aù
, 
tok
,

577 
off£t
, 
size
, 
width
);

578 ià(
»tv®
)

579  
»tv®
;

580 
	`__acquœe
(&
nå
->
b¬_lock
);

583 
	`nå_b¬_g‘
(
nå
, &nå->
b¬
[
b¬num
]);

584 
»tv®
 = 
	`»cÚfigu»_b¬
(
nå
, &nå->
b¬
[
b¬num
],

585 
tgt
, 
aù
, 
tok
, 
off£t
, 
size
, 
width
);

586 ià(
»tv®
 < 0) {

587 
	`nå_b¬_put
(
nå
, &nå->
b¬
[
b¬num
]);

588 
b¬num
 = 
»tv®
;

591 
”r_nob¬
:

592 
	`¥š_uÆock_œq»¡Üe
(&
nå
->
b¬_lock
, 
œqæags
);

593  
b¬num
;

594 
	}
}

599 
ssize_t
 
	$show_b¬cfg
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

600 *
buf
)

602 *
b¬ty³
[8] = {

606 
nå6000_pc›
 *
nå
 = 
	`nå_ýp_´iv
(
	`dev_g‘_drvd©a
(
dev
));

607 
n
, 
m­ty³
, 
tgù
, 
tg‰ok
, 
Ëngth
, 
aùiÚ
;

608 
ssize_t
 
off
 = 0;

609 
u64
 
ba£
;

611 
n
 = 0;‚ < 
nå
->
b¬s
;‚++) {

612 
nå_b¬
 *
b¬
 = &
nå
->b¬[
n
];

613 
u£rs
 = 
	`©omic_»ad
(&
b¬
->
»fút
);

615 ià(
u£rs
 =ð0 && !
NFP_PCIE_VERBOSE_DEBUG
)

618 
m­ty³
 = 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³_of
(

619 
b¬
->
b¬cfg
);

620 
tgù
 = 
	`NFP_PCIE_BAR_PCIE2CPP_T¬g‘_Ba£Add»ss_of
(

621 
b¬
->
b¬cfg
);

622 
tg‰ok
 = 
	`NFP_PCIE_BAR_PCIE2CPP_Tok’_Ba£Add»ss_of
(

623 
b¬
->
b¬cfg
);

624 
aùiÚ
 = 
	`NFP_PCIE_BAR_PCIE2CPP_AùiÚ_Ba£Add»ss_of
(

625 
b¬
->
b¬cfg
);

626 
Ëngth
 = 
	`NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_of
(

627 
b¬
->
b¬cfg
) ? 64 : 32;

628 
ba£
 = 
	`NFP_PCIE_BAR_PCIE2CPP_Ba£Add»ss_of
(

629 
b¬
->
b¬cfg
);

631 
off
 +ð
	`sú´štf
(
buf
 + off, 
PAGE_SIZE
 - off,

633 
b¬
->
šdex
, b¬->
b™size
, 
b¬ty³
[
m­ty³
]);

634 
m­ty³
) {

635 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_FIXED
:

636 
off
 +ð
	`sú´štf
(
buf
 + off, 
PAGE_SIZE
 - off,

638 
tgù
, 
tg‰ok
, 
aùiÚ
);

639 
ba£
 <<= (40 - 16);

641 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_BULK
:

642 
off
 +ð
	`sú´štf
(
buf
 + off, 
PAGE_SIZE
 - off,

644 
tgù
, 
tg‰ok
);

645 
ba£
 |ð(
u64
)
aùiÚ
 << 16;

646 
ba£
 <<= (40 - 21);

648 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_TARGET
:

649 
off
 +ð
	`sú´štf
(
buf
 + off, 
PAGE_SIZE
 - off,

651 
tgù
);

652 
ba£
 |ð(
u64
)
tg‰ok
 << 21;

653 
ba£
 |ð(
u64
)
aùiÚ
 << 16;

654 
ba£
 <<= (40 - 23);

656 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_GENERAL
:

657 
off
 +ð
	`sú´štf
(
buf
 + off, 
PAGE_SIZE
 - off,

658 "aùiÚ: %#x, ", 
tgù
);

659 
ba£
 |ð(
u64
)
tgù
 << 23;

660 
ba£
 |ð(
u64
)
tg‰ok
 << 21;

661 
ba£
 |ð(
u64
)
aùiÚ
 << 16;

662 
ba£
 <<= (40 - 27);

667 
off
 +ð
	`sú´štf
(
buf
 + off, 
PAGE_SIZE
 - off,

668 "%d-b™, ba£: %#Îx, u£rs: %d\n", 
Ëngth
,

669 
ba£
, 
u£rs
);

672  
off
;

673 
	}
}

675 
DEVICE_ATTR
(
b¬cfg
, 
S_IRUGO
, 
show_b¬cfg
, 
NULL
);

677 
	$nå6000_pc›b¬s_©Œ_add
(
deviû
 *
dev
)

679  
	`deviû_ü—‹_fže
(
dev
, &
dev_©Œ_b¬cfg
);

680 
	}
}

682 
	$nå6000_pc›b¬s_©Œ_»move
(
deviû
 *
dev
)

684 
	`deviû_»move_fže
(
dev
, &
dev_©Œ_b¬cfg
);

685 
	}
}

687 
di§bË_b¬s
(
nå6000_pc›
 *
nå
);

689 
	$b¬_cmp
(cÚ¡ *
­Œ
, cÚ¡ *
b±r
)

691 cÚ¡ 
nå_b¬
 *
a
 = 
­Œ
, *
b
 = 
b±r
;

693 ià(
a
->
b™size
 =ð
b
->bitsize)

694  
a
->
šdex
 - 
b
->index;

696  
a
->
b™size
 - 
b
->bitsize;

697 
	}
}

715 
	$’abË_b¬s
(
nå6000_pc›
 *
nå
, 
u16
 
š‹rçû
)

717 cÚ¡ 
u32
 
b¬cfg_msix_g’”®
 =

718 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

719 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_GENERAL
) |

720 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_32BIT
;

721 cÚ¡ 
u32
 
b¬cfg_msix_xpb
 =

722 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

723 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_BULK
) |

724 
NFP_PCIE_BAR_PCIE2CPP_L’gthS–eù_32BIT
 |

725 
	`NFP_PCIE_BAR_PCIE2CPP_T¬g‘_Ba£Add»ss
(

726 
NFP_CPP_TARGET_ISLAND_XPB
);

727 cÚ¡ 
u32
 
b¬cfg_ex¶ic™
[4] = {

728 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

729 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT0
),

730 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

731 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT1
),

732 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

733 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT2
),

734 
	`NFP_PCIE_BAR_PCIE2CPP_M­Ty³
(

735 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_EXPLICIT3
),

737 
¡©us_msg
[196] = {};

738 
i
, 
”r
, 
b¬s_ä“
;

739 
nå_b¬
 *
b¬
;

740 
ex¶_groups
;

741 *
msg
, *
’d
;

743 
msg
 = 
¡©us_msg
 +

744 
	`¢´štf
(
¡©us_msg
, (status_msg) - 1, "RESERVED BARs: ");

745 
’d
 = 
¡©us_msg
 + (status_msg) - 1;

747 
b¬
 = &
nå
->bar[0];

748 
i
 = 0; i < 
	`ARRAY_SIZE
(
nå
->
b¬
); i++, bar++) {

749 
»sourû
 *
»s
;

751 
»s
 = &
nå
->
pdev
->
»sourû
[(
i
 >> 3) * 2];

754 ià(!(
	`»sourû_ty³
(
»s
è& 
IORESOURCE_MEM
)) {

755 
b¬
--;

759 
b¬
->
»sourû
 = 
»s
;

760 
b¬
->
b¬cfg
 = 0;

762 
b¬
->
nå
 =‚fp;

763 
b¬
->
šdex
 = 
i
;

764 
b¬
->
mask
 = 
	`nå_b¬_»sourû_Ën
(bar) - 1;

765 
b¬
->
b™size
 = 
	`æs
(b¬->
mask
);

766 
b¬
->
ba£
 = 0;

767 
b¬
->
iomem
 = 
NULL
;

770 
nå
->
b¬s
 = 
b¬
 - &nfp->bar[0];

771 ià(
nå
->
b¬s
 < 8) {

772 
	`dev_”r
(
nå
->
dev
, "No usable BARs found!\n");

773  -
EINVAL
;

776 
b¬s_ä“
 = 
nå
->
b¬s
;

780 
	`mu‹x_š™
(&
nå
->
ex¶
.
mu‹x
);

782 
nå
->
ex¶
.
ma¡”_id
 = ((
	`NFP_CPP_INTERFACE_UNIT_of
(
š‹rçû
) & 3) + 4)

784 
nå
->
ex¶
.
sigÇl_»f
 = 0x10;

787 
b¬
 = &
nå
->bar[0];

788 ià(
	`nå_b¬_»sourû_Ën
(
b¬
è>ð
NFP_PCI_MIN_MAP_SIZE
)

789 
b¬
->
iomem
 = 
	`iÜem­_noÿche
(
	`nå_b¬_»sourû_¡¬t
(bar),

790 
	`nå_b¬_»sourû_Ën
(
b¬
));

791 ià(
b¬
->
iomem
) {

792 
pf
;

794 
msg
 +ð
	`¢´štf
(msg, 
’d
 - msg, "0.0: General/MSI-X SRAM, ");

795 
	`©omic_šc
(&
b¬
->
»fút
);

796 
b¬s_ä“
--;

798 
	`nå6000_b¬_wr™e
(
nå
, 
b¬
, 
b¬cfg_msix_g’”®
);

800 
nå
->
ex¶
.
d©a
 = 
b¬
->
iomem
 + 
NFP_PCIE_SRAM
 +

801 
nå
->
dev_šfo
->
pc›_ex¶_off£t
;

803 
nå
->
pdev
->
deviû
) {

804 
PCI_DEVICE_ID_NETRONOME_NFP3800
:

805 
pf
 = 
nå
->
pdev
->
devâ
 & 7;

806 
nå
->
iomem
.
c¤
 = 
b¬
->iomem + 
	`NFP_PCIE_BAR
(
pf
);

808 
PCI_DEVICE_ID_NETRONOME_NFP4000
:

809 
PCI_DEVICE_ID_NETRONOME_NFP5000
:

810 
PCI_DEVICE_ID_NETRONOME_NFP6000
:

811 
nå
->
iomem
.
c¤
 = 
b¬
->iomem + 
	`NFP_PCIE_BAR
(0);

814 
	`dev_”r
(
nå
->
dev
, "Unsupported device ID: %04hx!\n",

815 
nå
->
pdev
->
deviû
);

816 
”r
 = -
EINVAL
;

817 
”r_unm­_b¬0
;

819 
nå
->
iomem
.
em
 = 
b¬
->iomem + 
NFP_PCIE_EM
;

822 
nå
->
pdev
->
deviû
) {

823 
PCI_DEVICE_ID_NETRONOME_NFP3800
:

824 
ex¶_groups
 = 1;

826 
PCI_DEVICE_ID_NETRONOME_NFP4000
:

827 
PCI_DEVICE_ID_NETRONOME_NFP5000
:

828 
PCI_DEVICE_ID_NETRONOME_NFP6000
:

829 
ex¶_groups
 = 4;

832 
	`dev_”r
(
nå
->
dev
, "Unsupported device ID: %04hx!\n",

833 
nå
->
pdev
->
deviû
);

834 
”r
 = -
EINVAL
;

835 
”r_unm­_b¬0
;

839 
b¬
 = &
nå
->bar[1];

840 
msg
 +ð
	`¢´štf
(msg, 
’d
 - msg, "0.1: PCIe XPB/MSI-X PBA, ");

841 
	`©omic_šc
(&
b¬
->
»fút
);

842 
b¬s_ä“
--;

844 
	`nå6000_b¬_wr™e
(
nå
, 
b¬
, 
b¬cfg_msix_xpb
);

847 
i
 = 0; i < 4; i++) {

848 
j
;

850 ià(
i
 >ð
NFP_PCIE_EXPLICIT_BARS
 || i >ð
ex¶_groups
) {

851 
nå
->
ex¶
.
group
[
i
].
b™size
 = 0;

855 
b¬
 = &
nå
->b¬[4 + 
i
];

856 
b¬
->
iomem
 = 
	`iÜem­_noÿche
(
	`nå_b¬_»sourû_¡¬t
(bar),

857 
	`nå_b¬_»sourû_Ën
(
b¬
));

858 ià(
b¬
->
iomem
) {

859 
msg
 +ð
	`¢´štf
(msg, 
’d
 - msg,

860 "0.%d: Ex¶ic™%d, ", 4 + 
i
, i);

861 
	`©omic_šc
(&
b¬
->
»fút
);

862 
b¬s_ä“
--;

864 
nå
->
ex¶
.
group
[
i
].
b™size
 = 
b¬
->bitsize;

865 
nå
->
ex¶
.
group
[
i
].
addr
 = 
b¬
->
iomem
;

866 
	`nå6000_b¬_wr™e
(
nå
, 
b¬
, 
b¬cfg_ex¶ic™
[
i
]);

868 
j
 = 0; j < 4; j++)

869 
nå
->
ex¶
.
group
[
i
].
ä“
[
j
] = 
Œue
;

871 
nå
->
iomem
.
ex¶
[
i
] = 
b¬
->iomem;

875 
	`sÜt
(&
nå
->
b¬
[0],‚å->
b¬s
, (nfp->bar[0]),

876 
b¬_cmp
, 
NULL
);

878 
	`dev_šfo
(
nå
->
dev
, "%sä“: %d/%d\n", 
¡©us_msg
, 
b¬s_ä“
,‚å->
b¬s
);

882 
”r_unm­_b¬0
:

883 ià(
nå
->
b¬
[0].
iomem
)

884 
	`iounm­
(
nå
->
b¬
[0].
iomem
);

885  
”r
;

886 
	}
}

888 
	$di§bË_b¬s
(
nå6000_pc›
 *
nå
)

890 
nå_b¬
 *
b¬
 = &
nå
->bar[0];

891 
n
;

893 
n
 = 0;‚ < 
nå
->
b¬s
;‚++, 
b¬
++) {

894 ià(
b¬
->
iomem
) {

895 
	`iounm­
(
b¬
->
iomem
);

896 
b¬
->
iomem
 = 
NULL
;

899 
	}
}

905 
	snå6000_¬—_´iv
 {

906 
©omic_t
 
	m»fút
;

908 
nå_b¬
 *
	mb¬
;

909 
u32
 
	mb¬_off£t
;

911 
u32
 
	mrg‘
;

912 
u32
 
	maùiÚ
;

913 
u32
 
	mtok’
;

914 
u64
 
	moff£t
;

916 
	m»ad
;

917 
	mwr™e
;

918 
	mb¬
;

919 } 
	mwidth
;

920 
size_t
 
	msize
;

922 
__iomem
 *
	miomem
;

923 
phys_addr_t
 
	mphys
;

924 
»sourû
 
	m»sourû
;

927 
	$nå6000_¬—_š™
(
nå_ýp_¬—
 *
¬—
, 
u32
 
de¡
,

928 
add»ss
, 
size
)

930 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

931 
u32
 
rg‘
 = 
	`NFP_CPP_ID_TARGET_of
(
de¡
);

932 
u32
 
aùiÚ
 = 
	`NFP_CPP_ID_ACTION_of
(
de¡
);

933 
u32
 
tok’
 = 
	`NFP_CPP_ID_TOKEN_of
(
de¡
);

934 
µ
;

936 
µ
 = 
	`nå_rg‘_pushpuÎ
(
	`NFP_CPP_ID
(
rg‘
, 
aùiÚ
, 
tok’
), 
add»ss
);

937 ià(
µ
 < 0)

938  
µ
;

940 
´iv
->
width
.
»ad
 = 
	`PUSH_WIDTH
(
µ
);

941 
´iv
->
width
.
wr™e
 = 
	`PULL_WIDTH
(
µ
);

942 ià(
´iv
->
width
.
»ad
 > 0 &&

943 
´iv
->
width
.
wr™e
 > 0 &&

944 
´iv
->
width
.
»ad
 !ð´iv->width.
wr™e
) {

945  -
EINVAL
;

948 ià(
´iv
->
width
.
»ad
 > 0)

949 
´iv
->
width
.
b¬
 =…riv->width.
»ad
;

951 
´iv
->
width
.
b¬
 =…riv->width.
wr™e
;

953 
	`©omic_£t
(&
´iv
->
»fút
, 0);

954 
´iv
->
b¬
 = 
NULL
;

956 
´iv
->
rg‘
 =arget;

957 
´iv
->
aùiÚ
 =‡ction;

958 
´iv
->
tok’
 =oken;

959 
´iv
->
off£t
 = 
add»ss
;

960 
´iv
->
size
 = size;

961 
	`mem£t
(&
´iv
->
»sourû
, 0, (priv->resource));

964 
	}
}

966 
	$nå6000_¬—_þ—nup
(
nå_ýp_¬—
 *
¬—
)

968 
	}
}

970 
	$´iv_¬—_g‘
(
nå_ýp_¬—
 *
¬—
)

972 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

974 
	`©omic_šc
(&
´iv
->
»fút
);

975 
	}
}

977 
	$´iv_¬—_put
(
nå_ýp_¬—
 *
¬—
)

979 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

981 ià(
	`WARN_ON
(!
	`©omic_»ad
(&
´iv
->
»fút
)))

984  
	`©omic_dec_ªd_‹¡
(&
´iv
->
»fút
);

985 
	}
}

987 
	$nå6000_¬—_acquœe
(
nå_ýp_¬—
 *
¬—
)

989 
nå6000_pc›
 *
nå
 = 
	`nå_ýp_´iv
(
	`nå_ýp_¬—_ýp
(
¬—
));

990 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

991 
b¬num
, 
”r
;

993 ià(
´iv
->
b¬
) {

995 
	`´iv_¬—_g‘
(
¬—
);

999 
b¬num
 = 
	`nå_®loc_b¬
(
nå
, 
´iv
->
rg‘
,…riv->
aùiÚ
,…riv->
tok’
,

1000 
´iv
->
off£t
,…riv->
size
,…riv->
width
.
b¬
, 1);

1002 ià(
b¬num
 < 0) {

1003 
	`nå6000_dbg
(
nå
->
dev
, "Failedo‡llocate bar %d:%d:%d:0x%llx: %d\n",

1004 
´iv
->
rg‘
,…riv->
aùiÚ
,

1005 
´iv
->
tok’
,…riv->
off£t
, 
b¬num
);

1006 
”r
 = 
b¬num
;

1007 
”r_®loc_b¬
;

1009 
´iv
->
b¬
 = &
nå
->b¬[
b¬num
];

1012 ià(
	`nå_b¬_m­ty³
(
´iv
->
b¬
) ==

1013 
NFP_PCIE_BAR_PCIE2CPP_M­Ty³_GENERAL
) {

1014 
´iv
->
b¬_off£t
 =…riv->
off£t
 &

1015 (
	`NFP_PCIE_P2C_GENERAL_SIZE
(
´iv
->
b¬
) - 1);

1016 
´iv
->
b¬_off£t
 +ð
	`NFP_PCIE_P2C_GENERAL_TARGET_OFFSET
(

1017 
´iv
->
b¬
,…riv->
rg‘
);

1018 
´iv
->
b¬_off£t
 +ð
	`NFP_PCIE_P2C_GENERAL_TOKEN_OFFSET
(

1019 
´iv
->
b¬
,…riv->
tok’
);

1021 
´iv
->
b¬_off£t
 =…riv->
off£t
 &…riv->
b¬
->
mask
;

1029 
´iv
->
phys
 = 
	`nå_b¬_»sourû_¡¬t
Õriv->
b¬
è+…riv->
b¬_off£t
;

1030 
´iv
->
»sourû
.
Çme
 = 
	`nå_ýp_¬—_Çme
(
¬—
);

1031 
´iv
->
»sourû
.
¡¬t
 =…riv->
phys
;

1032 
´iv
->
»sourû
.
’d
 =…riv->»sourû.
¡¬t
 +…riv->
size
 - 1;

1033 
´iv
->
»sourû
.
æags
 = 
IORESOURCE_MEM
;

1036 ià(
´iv
->
b¬
->
iomem
)

1037 
´iv
->
iomem
 =…riv->
b¬
->iomem +…riv->
b¬_off£t
;

1040 
´iv
->
iomem
 = 
	`iÜem­_noÿche
Õriv->
phys
,…riv->
size
);

1042 ià(
	`IS_ERR_OR_NULL
(
´iv
->
iomem
)) {

1043 
	`dev_”r
(
nå
->
dev
, "Can't ioremap()‡ %d byte„egion of BAR %d\n",

1044 ()
´iv
->
size
,…riv->
b¬
->
šdex
);

1045 
”r
 = !
´iv
->
iomem
 ? -
ENOMEM
 : 
	`PTR_ERR
(priv->iomem);

1046 
´iv
->
iomem
 = 
NULL
;

1047 
”r_iomem_»m­
;

1050 
	`´iv_¬—_g‘
(
¬—
);

1053 
”r_iomem_»m­
:

1054 
	`nå_b¬_put
(
nå
, 
´iv
->
b¬
);

1055 
´iv
->
b¬
 = 
NULL
;

1056 
”r_®loc_b¬
:

1057  
”r
;

1058 
	}
}

1060 
	$nå6000_¬—_»Ëa£
(
nå_ýp_¬—
 *
¬—
)

1062 
nå6000_pc›
 *
nå
 = 
	`nå_ýp_´iv
(
	`nå_ýp_¬—_ýp
(
¬—
));

1063 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

1065 ià(!
	`´iv_¬—_put
(
¬—
))

1068 ià(!
´iv
->
b¬
->
iomem
)

1069 
	`iounm­
(
´iv
->
iomem
);

1071 
	`nå_b¬_put
(
nå
, 
´iv
->
b¬
);

1073 
´iv
->
b¬
 = 
NULL
;

1074 
´iv
->
iomem
 = 
NULL
;

1075 
	}
}

1077 
phys_addr_t
 
	$nå6000_¬—_phys
(
nå_ýp_¬—
 *
¬—
)

1079 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

1081  
´iv
->
phys
;

1082 
	}
}

1084 
__iomem
 *
	$nå6000_¬—_iomem
(
nå_ýp_¬—
 *
¬—
)

1086 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

1088  
´iv
->
iomem
;

1089 
	}
}

1091 
»sourû
 *
	$nå6000_¬—_»sourû
(
nå_ýp_¬—
 *
¬—
)

1097 
nå6000_¬—_´iv
 *
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

1099  
´iv
->
b¬
->
»sourû
;

1100 
	}
}

1102 
	$nå6000_¬—_»ad
(
nå_ýp_¬—
 *
¬—
, *
k”Ãl_vaddr
,

1103 
off£t
, 
Ëngth
)

1105 
u64
 
__maybe_unu£d
 *
w½Œ64
 = 
k”Ãl_vaddr
;

1106 cÚ¡ 
u64
 
__iomem
 
__maybe_unu£d
 *
rd±r64
;

1107 
nå6000_¬—_´iv
 *
´iv
;

1108 
u32
 *
w½Œ32
 = 
k”Ãl_vaddr
;

1109 cÚ¡ 
u32
 
__iomem
 *
rd±r32
;

1110 
n
, 
width
;

1112 
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

1113 
rd±r64
 = 
´iv
->
iomem
 + 
off£t
;

1114 
rd±r32
 = 
´iv
->
iomem
 + 
off£t
;

1116 ià(
off£t
 + 
Ëngth
 > 
´iv
->
size
)

1117  -
EFAULT
;

1119 
width
 = 
´iv
->width.
»ad
;

1120 ià(
width
 <= 0)

1121  -
EINVAL
;

1124 ià(
´iv
->
rg‘
 =ð(
NFP_CPP_TARGET_MU
 & 
NFP_CPP_TARGET_ID_MASK
) &&

1125 
´iv
->
aùiÚ
 =ð
NFP_CPP_ACTION_RW
 &&

1126 (
off£t
 % (
u64
è=ð4 || 
Ëngth
 % (u64) == 4))

1127 
width
 = 
TARGET_WIDTH_32
;

1130 ià((
´iv
->
off£t
 + off£tè& (
width
 - 1))

1131  
	`nå_ýp_ex¶ic™_»ad
(
	`nå_ýp_¬—_ýp
(
¬—
),

1132 
	`NFP_CPP_ID
(
´iv
->
rg‘
,

1133 
´iv
->
aùiÚ
,

1134 
´iv
->
tok’
),

1135 
´iv
->
off£t
 + offset,

1136 
k”Ãl_vaddr
, 
Ëngth
, 
width
);

1138 ià(
	`WARN_ON
(!
´iv
->
b¬
))

1139  -
EFAULT
;

1141 
width
) {

1142 
TARGET_WIDTH_32
:

1143 ià(
off£t
 % (
u32
è!ð0 || 
Ëngth
 % (u32) != 0)

1144  -
EINVAL
;

1146 
n
 = 0;‚ < 
Ëngth
;‚ +ð(
u32
))

1147 *
w½Œ32
++ = 
	`__¿w_»adl
(
rd±r32
++);

1148  
n
;

1149 #ifdeà
__¿w_»adq


1150 
TARGET_WIDTH_64
:

1151 ià(
off£t
 % (
u64
è!ð0 || 
Ëngth
 % (u64) != 0)

1152  -
EINVAL
;

1154 
n
 = 0;‚ < 
Ëngth
;‚ +ð(
u64
))

1155 *
w½Œ64
++ = 
	`__¿w_»adq
(
rd±r64
++);

1156  
n
;

1159  -
EINVAL
;

1161 
	}
}

1164 
	$nå6000_¬—_wr™e
(
nå_ýp_¬—
 *
¬—
,

1165 cÚ¡ *
k”Ãl_vaddr
,

1166 
off£t
, 
Ëngth
)

1168 cÚ¡ 
u64
 
__maybe_unu£d
 *
rd±r64
 = 
k”Ãl_vaddr
;

1169 
u64
 
__iomem
 
__maybe_unu£d
 *
w½Œ64
;

1170 cÚ¡ 
u32
 *
rd±r32
 = 
k”Ãl_vaddr
;

1171 
nå6000_¬—_´iv
 *
´iv
;

1172 
u32
 
__iomem
 *
w½Œ32
;

1173 
n
, 
width
;

1175 
´iv
 = 
	`nå_ýp_¬—_´iv
(
¬—
);

1176 
w½Œ64
 = 
´iv
->
iomem
 + 
off£t
;

1177 
w½Œ32
 = 
´iv
->
iomem
 + 
off£t
;

1179 ià(
off£t
 + 
Ëngth
 > 
´iv
->
size
)

1180  -
EFAULT
;

1182 
width
 = 
´iv
->width.
wr™e
;

1183 ià(
width
 <= 0)

1184  -
EINVAL
;

1187 ià(
´iv
->
rg‘
 =ð(
NFP_CPP_TARGET_ID_MASK
 & 
NFP_CPP_TARGET_MU
) &&

1188 
´iv
->
aùiÚ
 =ð
NFP_CPP_ACTION_RW
 &&

1189 (
off£t
 % (
u64
è=ð4 || 
Ëngth
 % (u64) == 4))

1190 
width
 = 
TARGET_WIDTH_32
;

1193 ià((
´iv
->
off£t
 + off£tè& (
width
 - 1))

1194  
	`nå_ýp_ex¶ic™_wr™e
(
	`nå_ýp_¬—_ýp
(
¬—
),

1195 
	`NFP_CPP_ID
(
´iv
->
rg‘
,

1196 
´iv
->
aùiÚ
,

1197 
´iv
->
tok’
),

1198 
´iv
->
off£t
 + offset,

1199 
k”Ãl_vaddr
, 
Ëngth
, 
width
);

1201 ià(
	`WARN_ON
(!
´iv
->
b¬
))

1202  -
EFAULT
;

1204 
width
) {

1205 
TARGET_WIDTH_32
:

1206 ià(
off£t
 % (
u32
è!ð0 || 
Ëngth
 % (u32) != 0)

1207  -
EINVAL
;

1209 
n
 = 0;‚ < 
Ëngth
;‚ +ð(
u32
)) {

1210 
	`__¿w_wr™–
(*
rd±r32
++, 
w½Œ32
++);

1211 
	`wmb
();

1213  
n
;

1214 #ifdeà
__¿w_wr™eq


1215 
TARGET_WIDTH_64
:

1216 ià(
off£t
 % (
u64
è!ð0 || 
Ëngth
 % (u64) != 0)

1217  -
EINVAL
;

1219 
n
 = 0;‚ < 
Ëngth
;‚ +ð(
u64
)) {

1220 
	`__¿w_wr™eq
(*
rd±r64
++, 
w½Œ64
++);

1221 
	`wmb
();

1223  
n
;

1226  -
EINVAL
;

1228 
	}
}

1230 
	snå6000_ex¶ic™_´iv
 {

1231 
nå6000_pc›
 *
	mnå
;

1233 
	mgroup
;

1234 
	m¬—
;

1235 } 
	mb¬
;

1236 
	mb™size
;

1237 
__iomem
 *
	md©a
;

1238 
__iomem
 *
	maddr
;

1241 
	$nå6000_ex¶ic™_acquœe
(
nå_ýp_ex¶ic™
 *
ex¶
)

1243 
nå6000_pc›
 *
nå
 = 
	`nå_ýp_´iv
(
	`nå_ýp_ex¶ic™_ýp
(
ex¶
));

1244 
nå6000_ex¶ic™_´iv
 *
´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

1245 
i
, 
j
;

1247 
	`mu‹x_lock
(&
nå
->
ex¶
.
mu‹x
);

1248 
i
 = 0; i < 
	`ARRAY_SIZE
(
nå
->
ex¶
.
group
); i++) {

1249 ià(!
nå
->
ex¶
.
group
[
i
].
b™size
)

1252 
j
 = 0; j < 
	`ARRAY_SIZE
(
nå
->
ex¶
.
group
[
i
].
ä“
); j++) {

1253 
u16
 
d©a_off£t
;

1255 ià(!
nå
->
ex¶
.
group
[
i
].
ä“
[
j
])

1258 
´iv
->
nå
 =‚fp;

1259 
´iv
->
b¬
.
group
 = 
i
;

1260 
´iv
->
b¬
.
¬—
 = 
j
;

1261 
´iv
->
b™size
 = 
nå
->
ex¶
.
group
[
i
].bitsize - 2;

1263 
d©a_off£t
 = (
´iv
->
b¬
.
group
 << 9) +

1264 (
´iv
->
b¬
.
¬—
 << 7);

1265 
´iv
->
d©a
 = 
nå
->
ex¶
.d©¨+ 
d©a_off£t
;

1266 
´iv
->
addr
 = 
nå
->
ex¶
.
group
[
i
].addr +

1267 (
´iv
->
b¬
.
¬—
 <<…riv->
b™size
);

1268 
nå
->
ex¶
.
group
[
i
].
ä“
[
j
] = 
çl£
;

1270 
	`mu‹x_uÆock
(&
nå
->
ex¶
.
mu‹x
);

1274 
	`mu‹x_uÆock
(&
nå
->
ex¶
.
mu‹x
);

1276  -
EAGAIN
;

1277 
	}
}

1279 
	$nå6000_ex¶ic™_»Ëa£
(
nå_ýp_ex¶ic™
 *
ex¶
)

1281 
nå6000_ex¶ic™_´iv
 *
´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

1282 
nå6000_pc›
 *
nå
 = 
´iv
->nfp;

1284 
	`mu‹x_lock
(&
nå
->
ex¶
.
mu‹x
);

1285 
nå
->
ex¶
.
group
[
´iv
->
b¬
.group].
ä“
[´iv->b¬.
¬—
] = 
Œue
;

1286 
	`mu‹x_uÆock
(&
nå
->
ex¶
.
mu‹x
);

1287 
	}
}

1289 
	$nå6000_ex¶ic™_put
(
nå_ýp_ex¶ic™
 *
ex¶
,

1290 cÚ¡ *
buff
, 
size_t
 
Ën
)

1292 
nå6000_ex¶ic™_´iv
 *
´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

1293 cÚ¡ 
u32
 *
¤c
 = 
buff
;

1294 
size_t
 
i
;

1296 
i
 = 0; i < 
Ën
; i +ð(
u32
))

1297 
	`wr™–
(*(
¤c
++), 
´iv
->
d©a
 + 
i
);

1299  
i
;

1300 
	}
}

1303 
	$nå6000_ex¶ic™_do
(
nå_ýp_ex¶ic™
 *
ex¶
,

1304 cÚ¡ 
nå_ýp_ex¶ic™_commªd
 *
cmd
, 
u64
 
add»ss
)

1306 
nå6000_ex¶ic™_´iv
 *
´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

1307 
u8
 
sigÇl_ma¡”
, 
sigÇl_»f
, 
d©a_ma¡”
;

1308 
nå6000_pc›
 *
nå
 = 
´iv
->nfp;

1309 
sigmask
 = 0;

1310 
u16
 
d©a_»f
;

1311 
u32
 
c¤
[3];

1313 ià(
cmd
->
siga_mode
)

1314 
sigmask
 |ð1 << 
cmd
->
siga
;

1315 ià(
cmd
->
sigb_mode
)

1316 
sigmask
 |ð1 << 
cmd
->
sigb
;

1318 
sigÇl_ma¡”
 = 
cmd
->signal_master;

1319 ià(!
sigÇl_ma¡”
)

1320 
sigÇl_ma¡”
 = 
nå
->
ex¶
.
ma¡”_id
;

1322 
sigÇl_»f
 = 
cmd
->signal_ref;

1323 ià(
sigÇl_ma¡”
 =ð
nå
->
ex¶
.
ma¡”_id
)

1324 
sigÇl_»f
 = 
nå
->
ex¶
.signal_ref +

1325 ((
´iv
->
b¬
.
group
 * 4 +…riv->b¬.
¬—
) << 1);

1327 
d©a_ma¡”
 = 
cmd
->data_master;

1328 ià(!
d©a_ma¡”
)

1329 
d©a_ma¡”
 = 
nå
->
ex¶
.
ma¡”_id
;

1331 
d©a_»f
 = 
cmd
->data_ref;

1332 ià(
d©a_ma¡”
 =ð
nå
->
ex¶
.
ma¡”_id
)

1333 
d©a_»f
 = 0x1000 +

1334 (
´iv
->
b¬
.
group
 << 9è+ (´iv->b¬.
¬—
 << 7);

1336 
c¤
[0] = 
	`NFP_PCIE_BAR_EXPLICIT_BAR0_SigÇlTy³
(
sigmask
) |

1337 
	`NFP_PCIE_BAR_EXPLICIT_BAR0_Tok’
(

1338 
	`NFP_CPP_ID_TOKEN_of
(
cmd
->
ýp_id
)) |

1339 
	`NFP_PCIE_BAR_EXPLICIT_BAR0_Add»ss
(
add»ss
 >> 16);

1341 
c¤
[1] = 
	`NFP_PCIE_BAR_EXPLICIT_BAR1_SigÇlRef
(
sigÇl_»f
) |

1342 
	`NFP_PCIE_BAR_EXPLICIT_BAR1_D©aMa¡”
(
d©a_ma¡”
) |

1343 
	`NFP_PCIE_BAR_EXPLICIT_BAR1_D©aRef
(
d©a_»f
);

1345 
c¤
[2] = 
	`NFP_PCIE_BAR_EXPLICIT_BAR2_T¬g‘
(

1346 
	`NFP_CPP_ID_TARGET_of
(
cmd
->
ýp_id
)) |

1347 
	`NFP_PCIE_BAR_EXPLICIT_BAR2_AùiÚ
(

1348 
	`NFP_CPP_ID_ACTION_of
(
cmd
->
ýp_id
)) |

1349 
	`NFP_PCIE_BAR_EXPLICIT_BAR2_L’gth
(
cmd
->
Ën
) |

1350 
	`NFP_PCIE_BAR_EXPLICIT_BAR2_By‹Mask
(
cmd
->
by‹_mask
) |

1351 
	`NFP_PCIE_BAR_EXPLICIT_BAR2_SigÇlMa¡”
(
sigÇl_ma¡”
);

1353 ià(
NFP_PCIE_VERBOSE_DEBUG
) {

1354 
i
;

1356 
i
 = 0; i < 3; i++)

1357 
	`dev_dbg
(
nå
->
dev
, "EXPL%d.%d: BAR%d = 0x%08x\n",

1358 
´iv
->
b¬
.
group
,…riv->b¬.
¬—
, 
i
, 
c¤
[i]);

1361 ià(
nå
->
iomem
.
c¤
) {

1362 
	`wr™–
(
c¤
[0], 
nå
->
iomem
.csr +

1363 
	`NFP_PCIE_BAR_EXPLICIT_BAR0
(
´iv
->
b¬
.
group
,

1364 
´iv
->
b¬
.
¬—
));

1365 
	`wr™–
(
c¤
[1], 
nå
->
iomem
.csr +

1366 
	`NFP_PCIE_BAR_EXPLICIT_BAR1
(
´iv
->
b¬
.
group
,

1367 
´iv
->
b¬
.
¬—
));

1368 
	`wr™–
(
c¤
[2], 
nå
->
iomem
.csr +

1369 
	`NFP_PCIE_BAR_EXPLICIT_BAR2
(
´iv
->
b¬
.
group
,

1370 
´iv
->
b¬
.
¬—
));

1372 
	`»adl
(
nå
->
iomem
.
c¤
 +

1373 
	`NFP_PCIE_BAR_EXPLICIT_BAR0
(
´iv
->
b¬
.
group
,

1374 
´iv
->
b¬
.
¬—
));

1375 
	`»adl
(
nå
->
iomem
.
c¤
 +

1376 
	`NFP_PCIE_BAR_EXPLICIT_BAR1
(
´iv
->
b¬
.
group
,

1377 
´iv
->
b¬
.
¬—
));

1378 
	`»adl
(
nå
->
iomem
.
c¤
 +

1379 
	`NFP_PCIE_BAR_EXPLICIT_BAR2
(
´iv
->
b¬
.
group
,

1380 
´iv
->
b¬
.
¬—
));

1382 
	`pci_wr™e_cÚfig_dwÜd
(
nå
->
pdev
, 0x400 +

1383 
	`NFP_PCIE_BAR_EXPLICIT_BAR0
(

1384 
´iv
->
b¬
.
group
,…riv->b¬.
¬—
),

1385 
c¤
[0]);

1387 
	`pci_wr™e_cÚfig_dwÜd
(
nå
->
pdev
, 0x400 +

1388 
	`NFP_PCIE_BAR_EXPLICIT_BAR1
(

1389 
´iv
->
b¬
.
group
,…riv->b¬.
¬—
),

1390 
c¤
[1]);

1392 
	`pci_wr™e_cÚfig_dwÜd
(
nå
->
pdev
, 0x400 +

1393 
	`NFP_PCIE_BAR_EXPLICIT_BAR2
(

1394 
´iv
->
b¬
.
group
,…riv->b¬.
¬—
),

1395 
c¤
[2]);

1398 
	`nå6000_dbg
(
nå
->
dev
, "EXPL%d.%d: Kickoff 0x%llx (@0x%08x)\n",

1399 
´iv
->
b¬
.
group
,…riv->b¬.
¬—
, 
add»ss
,

1400 ()(
add»ss
 & ((1 << 
´iv
->
b™size
) - 1)));

1403 
	`»adb
(
´iv
->
addr
 + (
add»ss
 & ((1 <<…riv->
b™size
) - 1)));

1405  
sigmask
;

1406 
	}
}

1408 
	$nå6000_ex¶ic™_g‘
(
nå_ýp_ex¶ic™
 *
ex¶
,

1409 *
buff
, 
size_t
 
Ën
)

1411 
nå6000_ex¶ic™_´iv
 *
´iv
 = 
	`nå_ýp_ex¶ic™_´iv
(
ex¶
);

1412 
u32
 *
d¡
 = 
buff
;

1413 
size_t
 
i
;

1415 
i
 = 0; i < 
Ën
; i +ð(
u32
))

1416 *(
d¡
++èð
	`»adl
(
´iv
->
d©a
 + 
i
);

1418  
i
;

1419 
	}
}

1421 
	$nå6000_š™
(
nå_ýp
 *
ýp
)

1423 
	`nå_ýp_¬—_ÿche_add
(
ýp
, 
SZ_64K
);

1424 
	`nå_ýp_¬—_ÿche_add
(
ýp
, 
SZ_64K
);

1425 
	`nå_ýp_¬—_ÿche_add
(
ýp
, 
SZ_256K
);

1427  
	`nå6000_pc›b¬s_©Œ_add
(
	`nå_ýp_deviû
(
ýp
));

1428 
	}
}

1430 
	snå6000_ev’t_´iv
 {

1431 
	mfž‹r
;

1434 
	$nå6000_ev’t_acquœe
(
nå_ýp_ev’t
 *
ev’t
, 
u32
 
m©ch
,

1435 
u32
 
mask
, u32 
ty³
)

1437 
nå6000_ev’t_´iv
 *
ev
 = 
	`nå_ýp_ev’t_´iv
(
ev’t
);

1438 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ev’t_ýp
(
ev’t
);

1439 
nå6000_pc›
 *
nå
 = 
	`nå_ýp_´iv
(
ýp
);

1440 
fž‹r
;

1442 
fž‹r
 = 
	`nå_em_mªag”_acquœe
(
nå
->
ev’t
,ƒv’t, 
m©ch
, 
mask
, 
ty³
);

1443 ià(
fž‹r
 < 0)

1444  
fž‹r
;

1446 
ev
->
fž‹r
 = filter;

1449 
	}
}

1451 
	$nå6000_ev’t_»Ëa£
(
nå_ýp_ev’t
 *
ev’t
)

1453 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ev’t_ýp
(
ev’t
);

1454 
nå6000_pc›
 *
nå
 = 
	`nå_ýp_´iv
(
ýp
);

1455 
nå6000_ev’t_´iv
 *
ev
 = 
	`nå_ýp_ev’t_´iv
(
ev’t
);

1457 
	`nå_em_mªag”_»Ëa£
(
nå
->
ev’t
, 
ev
->
fž‹r
);

1458 
	}
}

1460 
	$nå6000_ä“
(
nå_ýp
 *
ýp
)

1462 
nå6000_pc›
 *
nå
 = 
	`nå_ýp_´iv
(
ýp
);

1464 
	`nå6000_pc›b¬s_©Œ_»move
(
	`nå_ýp_deviû
(
ýp
));

1465 
	`nå_em_mªag”_de¡roy
(
nå
->
ev’t
);

1466 
	`di§bË_b¬s
(
nå
);

1467 
	`kä“
(
nå
);

1468 
	}
}

1470 
	$nå6000_»ad_£rŸl
(
deviû
 *
dev
, 
u8
 *
£rŸl
)

1472 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

1473 
pos
;

1474 
u32
 
»g
;

1476 
pos
 = 
	`pci_fšd_ext_ÿ·bž™y
(
pdev
, 
PCI_EXT_CAP_ID_DSN
);

1477 ià(!
pos
) {

1478 
	`dev_”r
(
dev
, "can't find PCIe Serial Number Capability\n");

1479  -
EINVAL
;

1482 
	`pci_»ad_cÚfig_dwÜd
(
pdev
, 
pos
 + 4, &
»g
);

1483 
	`put_uÇligÃd_be16
(
»g
 >> 16, 
£rŸl
 + 4);

1484 
	`pci_»ad_cÚfig_dwÜd
(
pdev
, 
pos
 + 8, &
»g
);

1485 
	`put_uÇligÃd_be32
(
»g
, 
£rŸl
);

1488 
	}
}

1490 
	$nå6000_g‘_š‹rçû
(
deviû
 *
dev
)

1492 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

1493 
pos
;

1494 
u32
 
»g
;

1496 
pos
 = 
	`pci_fšd_ext_ÿ·bž™y
(
pdev
, 
PCI_EXT_CAP_ID_DSN
);

1497 ià(!
pos
) {

1498 
	`dev_”r
(
dev
, "can't find PCIe Serial Number Capability\n");

1499  -
EINVAL
;

1502 
	`pci_»ad_cÚfig_dwÜd
(
pdev
, 
pos
 + 4, &
»g
);

1504  
»g
 & 0xffff;

1505 
	}
}

1507 cÚ¡ 
nå_ýp_Ý”©iÚs
 
	gnå6000_pc›_Ýs
 = {

1508 .
owÃr
 = 
THIS_MODULE
,

1510 .
	gš™
 = 
nå6000_š™
,

1511 .
	gä“
 = 
nå6000_ä“
,

1513 .
	g»ad_£rŸl
 = 
nå6000_»ad_£rŸl
,

1514 .
	gg‘_š‹rçû
 = 
nå6000_g‘_š‹rçû
,

1516 .
	g¬—_´iv_size
 = (
nå6000_¬—_´iv
),

1517 .
	g¬—_š™
 = 
nå6000_¬—_š™
,

1518 .
	g¬—_þ—nup
 = 
nå6000_¬—_þ—nup
,

1519 .
	g¬—_acquœe
 = 
nå6000_¬—_acquœe
,

1520 .
	g¬—_»Ëa£
 = 
nå6000_¬—_»Ëa£
,

1521 .
	g¬—_phys
 = 
nå6000_¬—_phys
,

1522 .
	g¬—_iomem
 = 
nå6000_¬—_iomem
,

1523 .
	g¬—_»sourû
 = 
nå6000_¬—_»sourû
,

1524 .
	g¬—_»ad
 = 
nå6000_¬—_»ad
,

1525 .
	g¬—_wr™e
 = 
nå6000_¬—_wr™e
,

1527 .
	gex¶ic™_´iv_size
 = (
nå6000_ex¶ic™_´iv
),

1528 .
	gex¶ic™_acquœe
 = 
nå6000_ex¶ic™_acquœe
,

1529 .
	gex¶ic™_»Ëa£
 = 
nå6000_ex¶ic™_»Ëa£
,

1530 .
	gex¶ic™_put
 = 
nå6000_ex¶ic™_put
,

1531 .
	gex¶ic™_do
 = 
nå6000_ex¶ic™_do
,

1532 .
	gex¶ic™_g‘
 = 
nå6000_ex¶ic™_g‘
,

1534 .
	gev’t_´iv_size
 = (
nå6000_ev’t_´iv
),

1535 .
	gev’t_acquœe
 = 
nå6000_ev’t_acquœe
,

1536 .
	gev’t_»Ëa£
 = 
nå6000_ev’t_»Ëa£
,

1547 
nå_ýp
 *

1548 
	$nå_ýp_äom_nå6000_pc›
(
pci_dev
 *
pdev
,

1549 cÚ¡ 
nå_dev_šfo
 *
dev_šfo
, 
ev’t_œq
)

1551 
nå6000_pc›
 *
nå
;

1552 
u16
 
š‹rçû
;

1553 
”r
;

1556 
	`dev_šfo
(&
pdev
->
dev
, "Netronome Flow Processor %s PCIe Card Probe\n",

1557 
dev_šfo
->
ch_Çmes
);

1558 
	`pc›_´št_lšk_¡©us
(
pdev
);

1560 
nå
 = 
	`kz®loc
((*nå), 
GFP_KERNEL
);

1561 ià(!
nå
) {

1562 
”r
 = -
ENOMEM
;

1563 
”r_»t
;

1566 
nå
->
dev
 = &
pdev
->dev;

1567 
nå
->
pdev
 =…dev;

1568 
nå
->
dev_šfo
 = dev_info;

1569 
	`š™_wa™queue_h—d
(&
nå
->
b¬_wa™”s
);

1570 
	`¥š_lock_š™
(&
nå
->
b¬_lock
);

1572 
š‹rçû
 = 
	`nå6000_g‘_š‹rçû
(&
pdev
->
dev
);

1574 ià(
	`NFP_CPP_INTERFACE_TYPE_of
(
š‹rçû
) !=

1575 
NFP_CPP_INTERFACE_TYPE_PCI
) {

1576 
	`dev_”r
(&
pdev
->
dev
,

1578 
	`NFP_CPP_INTERFACE_TYPE_of
(
š‹rçû
),

1579 
NFP_CPP_INTERFACE_TYPE_PCI
);

1580 
”r
 = -
ENODEV
;

1581 
”r_ä“_nå
;

1584 ià(
	`NFP_CPP_INTERFACE_CHANNEL_of
(
š‹rçû
) !=

1585 
NFP_CPP_INTERFACE_CHANNEL_PEROPENER
) {

1586 
	`dev_”r
(&
pdev
->
dev
, "Interface channel %d is‚otheƒxpected %d\n",

1587 
	`NFP_CPP_INTERFACE_CHANNEL_of
(
š‹rçû
),

1588 
NFP_CPP_INTERFACE_CHANNEL_PEROPENER
);

1589 
”r
 = -
ENODEV
;

1590 
”r_ä“_nå
;

1593 
”r
 = 
	`’abË_b¬s
(
nå
, 
š‹rçû
);

1594 ià(
”r
)

1595 
”r_ä“_nå
;

1597 ià(
nå
->
iomem
.
em
 && 
ev’t_œq
 >= 0) {

1598 
nå
->
ev’t
 = 
	`nå_em_mªag”_ü—‹
Òå->
iomem
.
em
, 
ev’t_œq
);

1599 ià(
	`IS_ERR_OR_NULL
(
nå
->
ev’t
)) {

1600 
”r
 = 
nå
->
ev’t
 ? 
	`PTR_ERR
Òå->ev’tè: -
ENOMEM
;

1601 
”r_b¬_di§bË
;

1606  
	`nå_ýp_äom_Ý”©iÚs
(&
nå6000_pc›_Ýs
, &
pdev
->
dev
, 
nå
);

1608 
”r_b¬_di§bË
:

1609 
	`di§bË_b¬s
(
nå
);

1610 
”r_ä“_nå
:

1611 
	`kä“
(
nå
);

1612 
”r_»t
:

1613 
	`dev_”r
(&
pdev
->
dev
, "NFP6000 PCI setup failed\n");

1614  
	`ERR_PTR
(
”r
);

1615 
	}
}

	@src/nfpcore/nfp6000_pcie.h

9 #iâdeà
NFP6000_PCIE_H


10 
	#NFP6000_PCIE_H


	)

12 
	~"nå_ýp.h
"

14 
nå_ýp
 *

15 
nå_ýp_äom_nå6000_pc›
(
pci_dev
 *
pdev
,

16 cÚ¡ 
nå_dev_šfo
 *
dev_šfo
, 
ev’t_œq
);

	@src/nfpcore/nfp_arm.h

9 #iâdeà
NFP_ARM_H


10 
	#NFP_ARM_H


	)

12 
	#NFP_ARM_QUEUE
(
_q
è(0x100000 + (0x800 * ((_qè& 0xff)))

	)

13 
	#NFP_ARM_IM
 0x200000

	)

14 
	#NFP_ARM_EM
 0x300000

	)

15 
	#NFP_ARM_GCSR
 0x400000

	)

16 
	#NFP_ARM_MPCORE
 0x800000

	)

17 
	#NFP_ARM_PL310
 0xa00000

	)

19 
	#NFP_ARM_GCSR_BULK_BAR
(
_b¬
è(0x0 + (0x4 * ((_b¬è& 0x7)))

	)

20 
	#NFP_ARM_GCSR_BULK_BAR_TYPE
 (0x1 << 31)

	)

21 
	#NFP_ARM_GCSR_BULK_BAR_TYPE_BULK
 (0x0)

	)

22 
	#NFP_ARM_GCSR_BULK_BAR_TYPE_EXPA
 (0x80000000)

	)

23 
	#NFP_ARM_GCSR_BULK_BAR_TGT
(
_x
è(((_xè& 0xfè<< 27)

	)

24 
	#NFP_ARM_GCSR_BULK_BAR_TGT_of
(
_x
è(((_xè>> 27è& 0xf)

	)

25 
	#NFP_ARM_GCSR_BULK_BAR_TOK
(
_x
è(((_xè& 0x3è<< 25)

	)

26 
	#NFP_ARM_GCSR_BULK_BAR_TOK_of
(
_x
è(((_xè>> 25è& 0x3)

	)

27 
	#NFP_ARM_GCSR_BULK_BAR_LEN
 (0x1 << 24)

	)

28 
	#NFP_ARM_GCSR_BULK_BAR_LEN_32BIT
 (0x0)

	)

29 
	#NFP_ARM_GCSR_BULK_BAR_LEN_64BIT
 (0x1000000)

	)

30 
	#NFP_ARM_GCSR_BULK_BAR_ADDR
(
_x
è((_xè& 0x7ff)

	)

31 
	#NFP_ARM_GCSR_BULK_BAR_ADDR_of
(
_x
è((_xè& 0x7ff)

	)

33 
	#NFP_ARM_GCSR_EXPA_BAR
(
_b¬
è(0x20 + (0x4 * ((_b¬è& 0xf)))

	)

34 
	#NFP_ARM_GCSR_EXPA_BAR_TYPE
 (0x1 << 31)

	)

35 
	#NFP_ARM_GCSR_EXPA_BAR_TYPE_EXPA
 (0x0)

	)

36 
	#NFP_ARM_GCSR_EXPA_BAR_TYPE_EXPL
 (0x80000000)

	)

37 
	#NFP_ARM_GCSR_EXPA_BAR_TGT
(
_x
è(((_xè& 0xfè<< 27)

	)

38 
	#NFP_ARM_GCSR_EXPA_BAR_TGT_of
(
_x
è(((_xè>> 27è& 0xf)

	)

39 
	#NFP_ARM_GCSR_EXPA_BAR_TOK
(
_x
è(((_xè& 0x3è<< 25)

	)

40 
	#NFP_ARM_GCSR_EXPA_BAR_TOK_of
(
_x
è(((_xè>> 25è& 0x3)

	)

41 
	#NFP_ARM_GCSR_EXPA_BAR_LEN
 (0x1 << 24)

	)

42 
	#NFP_ARM_GCSR_EXPA_BAR_LEN_32BIT
 (0x0)

	)

43 
	#NFP_ARM_GCSR_EXPA_BAR_LEN_64BIT
 (0x1000000)

	)

44 
	#NFP_ARM_GCSR_EXPA_BAR_ACT
(
_x
è(((_xè& 0x1fè<< 19)

	)

45 
	#NFP_ARM_GCSR_EXPA_BAR_ACT_of
(
_x
è(((_xè>> 19è& 0x1f)

	)

46 
	#NFP_ARM_GCSR_EXPA_BAR_ACT_DERIVED
 (0)

	)

47 
	#NFP_ARM_GCSR_EXPA_BAR_ADDR
(
_x
è((_xè& 0x7fff)

	)

48 
	#NFP_ARM_GCSR_EXPA_BAR_ADDR_of
(
_x
è((_xè& 0x7fff)

	)

50 
	#NFP_ARM_GCSR_EXPL0_BAR
(
_b¬
è(0x60 + (0x4 * ((_b¬è& 0x7)))

	)

51 
	#NFP_ARM_GCSR_EXPL0_BAR_ADDR
(
_x
è((_xè& 0x3ffff)

	)

52 
	#NFP_ARM_GCSR_EXPL0_BAR_ADDR_of
(
_x
è((_xè& 0x3ffff)

	)

54 
	#NFP_ARM_GCSR_EXPL1_BAR
(
_b¬
è(0x80 + (0x4 * ((_b¬è& 0x7)))

	)

55 
	#NFP_ARM_GCSR_EXPL1_BAR_POSTED
 (0x1 << 31)

	)

56 
	#NFP_ARM_GCSR_EXPL1_BAR_SIGNAL_REF
(
_x
è(((_xè& 0x7fè<< 24)

	)

57 
	#NFP_ARM_GCSR_EXPL1_BAR_SIGNAL_REF_of
(
_x
è(((_xè>> 24è& 0x7f)

	)

58 
	#NFP_ARM_GCSR_EXPL1_BAR_DATA_MASTER
(
_x
è(((_xè& 0xffè<< 16)

	)

59 
	#NFP_ARM_GCSR_EXPL1_BAR_DATA_MASTER_of
(
_x
è(((_xè>> 16è& 0xff)

	)

60 
	#NFP_ARM_GCSR_EXPL1_BAR_DATA_REF
(
_x
è((_xè& 0x3fff)

	)

61 
	#NFP_ARM_GCSR_EXPL1_BAR_DATA_REF_of
(
_x
è((_xè& 0x3fff)

	)

63 
	#NFP_ARM_GCSR_EXPL2_BAR
(
_b¬
è(0xa0 + (0x4 * ((_b¬è& 0x7)))

	)

64 
	#NFP_ARM_GCSR_EXPL2_BAR_TGT
(
_x
è(((_xè& 0xfè<< 28)

	)

65 
	#NFP_ARM_GCSR_EXPL2_BAR_TGT_of
(
_x
è(((_xè>> 28è& 0xf)

	)

66 
	#NFP_ARM_GCSR_EXPL2_BAR_ACT
(
_x
è(((_xè& 0x1fè<< 23)

	)

67 
	#NFP_ARM_GCSR_EXPL2_BAR_ACT_of
(
_x
è(((_xè>> 23è& 0x1f)

	)

68 
	#NFP_ARM_GCSR_EXPL2_BAR_LEN
(
_x
è(((_xè& 0x1fè<< 18)

	)

69 
	#NFP_ARM_GCSR_EXPL2_BAR_LEN_of
(
_x
è(((_xè>> 18è& 0x1f)

	)

70 
	#NFP_ARM_GCSR_EXPL2_BAR_BYTE_MASK
(
_x
è(((_xè& 0xffè<< 10)

	)

71 
	#NFP_ARM_GCSR_EXPL2_BAR_BYTE_MASK_of
(
_x
è(((_xè>> 10è& 0xff)

	)

72 
	#NFP_ARM_GCSR_EXPL2_BAR_TOK
(
_x
è(((_xè& 0x3è<< 8)

	)

73 
	#NFP_ARM_GCSR_EXPL2_BAR_TOK_of
(
_x
è(((_xè>> 8è& 0x3)

	)

74 
	#NFP_ARM_GCSR_EXPL2_BAR_SIGNAL_MASTER
(
_x
è((_xè& 0xff)

	)

75 
	#NFP_ARM_GCSR_EXPL2_BAR_SIGNAL_MASTER_of
(
_x
è((_xè& 0xff)

	)

77 
	#NFP_ARM_GCSR_EXPL_POST
(
_b¬
è(0xc0 + (0x4 * ((_b¬è& 0x7)))

	)

78 
	#NFP_ARM_GCSR_EXPL_POST_SIG_B
(
_x
è(((_xè& 0x7fè<< 25)

	)

79 
	#NFP_ARM_GCSR_EXPL_POST_SIG_B_of
(
_x
è(((_xè>> 25è& 0x7f)

	)

80 
	#NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS
 (0x1 << 24)

	)

81 
	#NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PULL
 (0x0)

	)

82 
	#NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PUSH
 (0x1000000)

	)

83 
	#NFP_ARM_GCSR_EXPL_POST_SIG_A
(
_x
è(((_xè& 0x7fè<< 17)

	)

84 
	#NFP_ARM_GCSR_EXPL_POST_SIG_A_of
(
_x
è(((_xè>> 17è& 0x7f)

	)

85 
	#NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS
 (0x1 << 16)

	)

86 
	#NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PULL
 (0x0)

	)

87 
	#NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PUSH
 (0x10000)

	)

88 
	#NFP_ARM_GCSR_EXPL_POST_SIG_B_RCVD
 (0x1 << 7)

	)

89 
	#NFP_ARM_GCSR_EXPL_POST_SIG_B_VALID
 (0x1 << 6)

	)

90 
	#NFP_ARM_GCSR_EXPL_POST_SIG_A_RCVD
 (0x1 << 5)

	)

91 
	#NFP_ARM_GCSR_EXPL_POST_SIG_A_VALID
 (0x1 << 4)

	)

92 
	#NFP_ARM_GCSR_EXPL_POST_CMD_COMPLETE
 (0x1)

	)

94 
	#NFP_ARM_GCSR_MPCORE_BASE
 0x00e0

	)

95 
	#NFP_ARM_GCSR_MPCORE_BASE_ADDR
(
_x
è(((_xè& 0x7ffffè<< 13)

	)

96 
	#NFP_ARM_GCSR_MPCORE_BASE_ADDR_of
(
_x
è(((_xè>> 13è& 0x7ffff)

	)

98 
	#NFP_ARM_GCSR_PL310_BASE
 0x00e4

	)

99 
	#NFP_ARM_GCSR_PL310_BASE_ADDR
(
_x
è(((_xè& 0xfffffè<< 12)

	)

100 
	#NFP_ARM_GCSR_PL310_BASE_ADDR_of
(
_x
è(((_xè>> 12è& 0xfffff)

	)

102 
	#NFP_ARM_GCSR_MP0_CFG
 0x00e8

	)

103 
	#NFP_ARM_GCSR_MP0_CFG_SPI_BOOT
 (0x1 << 14)

	)

104 
	#NFP_ARM_GCSR_MP0_CFG_ENDIAN
(
_x
è(((_xè& 0x3è<< 12)

	)

105 
	#NFP_ARM_GCSR_MP0_CFG_ENDIAN_of
(
_x
è(((_xè>> 12è& 0x3)

	)

106 
	#NFP_ARM_GCSR_MP0_CFG_ENDIAN_LITTLE
 (0)

	)

107 
	#NFP_ARM_GCSR_MP0_CFG_ENDIAN_BIG
 (1)

	)

108 
	#NFP_ARM_GCSR_MP0_CFG_RESET_VECTOR
 (0x1 << 8)

	)

109 
	#NFP_ARM_GCSR_MP0_CFG_RESET_VECTOR_LO
 (0x0)

	)

110 
	#NFP_ARM_GCSR_MP0_CFG_RESET_VECTOR_HI
 (0x100)

	)

111 
	#NFP_ARM_GCSR_MP0_CFG_OUTCLK_EN
(
_x
è(((_xè& 0xfè<< 4)

	)

112 
	#NFP_ARM_GCSR_MP0_CFG_OUTCLK_EN_of
(
_x
è(((_xè>> 4è& 0xf)

	)

113 
	#NFP_ARM_GCSR_MP0_CFG_ARMID
(
_x
è((_xè& 0xf)

	)

114 
	#NFP_ARM_GCSR_MP0_CFG_ARMID_of
(
_x
è((_xè& 0xf)

	)

116 
	#NFP_ARM_GCSR_MP0_CACHE_ERR
 0x00ec

	)

117 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D7
 (0x1 << 15)

	)

118 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D6
 (0x1 << 14)

	)

119 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D5
 (0x1 << 13)

	)

120 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D4
 (0x1 << 12)

	)

121 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D3
 (0x1 << 11)

	)

122 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D2
 (0x1 << 10)

	)

123 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D1
 (0x1 << 9)

	)

124 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_D0
 (0x1 << 8)

	)

125 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I7
 (0x1 << 7)

	)

126 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I6
 (0x1 << 6)

	)

127 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I5
 (0x1 << 5)

	)

128 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I4
 (0x1 << 4)

	)

129 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I3
 (0x1 << 3)

	)

130 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I2
 (0x1 << 2)

	)

131 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I1
 (0x1 << 1)

	)

132 
	#NFP_ARM_GCSR_MP0_CACHE_ERR_MP0_I0
 (0x1)

	)

134 
	#NFP_ARM_GCSR_DFT
 0x0100

	)

135 
	#NFP_ARM_GCSR_DFT_DBG_REQ
 (0x1 << 20)

	)

136 
	#NFP_ARM_GCSR_DFT_DBG_EN
 (0x1 << 19)

	)

137 
	#NFP_ARM_GCSR_DFT_WFE_EVT_TRG
 (0x1 << 18)

	)

138 
	#NFP_ARM_GCSR_DFT_ETM_WFI_RDY
 (0x1 << 17)

	)

139 
	#NFP_ARM_GCSR_DFT_ETM_PWR_ON
 (0x1 << 16)

	)

140 
	#NFP_ARM_GCSR_DFT_BIST_FAIL_of
(
_x
è(((_xè>> 8è& 0xf)

	)

141 
	#NFP_ARM_GCSR_DFT_BIST_DONE_of
(
_x
è(((_xè>> 4è& 0xf)

	)

142 
	#NFP_ARM_GCSR_DFT_BIST_RUN
(
_x
è((_xè& 0x7)

	)

143 
	#NFP_ARM_GCSR_DFT_BIST_RUN_of
(
_x
è((_xè& 0x7)

	)

148 
	#NFP_ARM_GCSR_START
 (0xd6000000 + 
NFP_ARM_GCSR
)

	)

149 
	#NFP_ARM_GCSR_SIZE
 
SZ_64K


	)

153 
	#NFP_ARM_GCSR_BULK_BITS
 11

	)

154 
	#NFP_ARM_GCSR_EXPA_BITS
 15

	)

155 
	#NFP_ARM_GCSR_EXPL_BITS
 18

	)

157 
	#NFP_ARM_GCSR_BULK_SHIFT
 (40 - 11)

	)

158 
	#NFP_ARM_GCSR_EXPA_SHIFT
 (40 - 15)

	)

159 
	#NFP_ARM_GCSR_EXPL_SHIFT
 (40 - 18)

	)

161 
	#NFP_ARM_GCSR_BULK_SIZE
 (1 << 
NFP_ARM_GCSR_BULK_SHIFT
)

	)

162 
	#NFP_ARM_GCSR_EXPA_SIZE
 (1 << 
NFP_ARM_GCSR_EXPA_SHIFT
)

	)

163 
	#NFP_ARM_GCSR_EXPL_SIZE
 (1 << 
NFP_ARM_GCSR_EXPL_SHIFT
)

	)

165 
	#NFP_ARM_GCSR_EXPL2_CSR
(
rg‘
, 
aùiÚ
, 
Ëngth
, \

166 
by‹_mask
, 
tok’
, 
sigÇl_ma¡”
) \

167 (
	`NFP_ARM_GCSR_EXPL2_BAR_TGT
(
rg‘
) | \

168 
	`NFP_ARM_GCSR_EXPL2_BAR_ACT
(
aùiÚ
) | \

169 
	`NFP_ARM_GCSR_EXPL2_BAR_LEN
(
Ëngth
) | \

170 
	`NFP_ARM_GCSR_EXPL2_BAR_BYTE_MASK
(
by‹_mask
) | \

171 
	`NFP_ARM_GCSR_EXPL2_BAR_TOK
(
tok’
) | \

172 
	`NFP_ARM_GCSR_EXPL2_BAR_SIGNAL_MASTER
(
sigÇl_ma¡”
))

	)

173 
	#NFP_ARM_GCSR_EXPL1_CSR
(
po¡ed
, 
sigÇl_»f
, 
d©a_ma¡”
, 
d©a_»f
) \

174 (((
po¡ed
è? 
NFP_ARM_GCSR_EXPL1_BAR_POSTED
 : 0) | \

175 
	`NFP_ARM_GCSR_EXPL1_BAR_SIGNAL_REF
(
sigÇl_»f
) | \

176 
	`NFP_ARM_GCSR_EXPL1_BAR_DATA_MASTER
(
d©a_ma¡”
) | \

177 
	`NFP_ARM_GCSR_EXPL1_BAR_DATA_REF
(
d©a_»f
))

	)

178 
	#NFP_ARM_GCSR_EXPL0_CSR
(
add»ss
) \

179 
	`NFP_ARM_GCSR_EXPL0_BAR_ADDR
((
add»ss
è>> 
NFP_ARM_GCSR_EXPL_SHIFT
)

	)

180 
	#NFP_ARM_GCSR_EXPL_POST_EXPECT_A
(
sig_»f
, 
is_push
, 
is_»quœed
) \

181 (
	`NFP_ARM_GCSR_EXPL_POST_SIG_A
(
sig_»f
) | \

182 ((
is_push
è? 
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PUSH
 : \

183 
NFP_ARM_GCSR_EXPL_POST_SIG_A_BUS_PULL
) | \

184 ((
is_»quœed
è? 
NFP_ARM_GCSR_EXPL_POST_SIG_A_VALID
 : 0))

	)

185 
	#NFP_ARM_GCSR_EXPL_POST_EXPECT_B
(
sig_»f
, 
is_push
, 
is_»quœed
) \

186 (
	`NFP_ARM_GCSR_EXPL_POST_SIG_B
(
sig_»f
) | \

187 ((
is_push
è? 
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PUSH
 : \

188 
NFP_ARM_GCSR_EXPL_POST_SIG_B_BUS_PULL
) | \

189 ((
is_»quœed
è? 
NFP_ARM_GCSR_EXPL_POST_SIG_B_VALID
 : 0))

	)

191 
	#NFP_ARM_GCSR_EXPA_CSR
(
mode
, 
rg‘
, 
tok’
, 
is_64
, 
aùiÚ
, 
add»ss
) \

192 (((
mode
è? 
NFP_ARM_GCSR_EXPA_BAR_TYPE_EXPL
 : \

193 
NFP_ARM_GCSR_EXPA_BAR_TYPE_EXPA
) | \

194 
	`NFP_ARM_GCSR_EXPA_BAR_TGT
(
rg‘
) | \

195 
	`NFP_ARM_GCSR_EXPA_BAR_TOK
(
tok’
) | \

196 ((
is_64
è? 
NFP_ARM_GCSR_EXPA_BAR_LEN_64BIT
 : \

197 
NFP_ARM_GCSR_EXPA_BAR_LEN_32BIT
) | \

198 
	`NFP_ARM_GCSR_EXPA_BAR_ACT
(
aùiÚ
) | \

199 
	`NFP_ARM_GCSR_EXPA_BAR_ADDR
((
add»ss
è>> 
NFP_ARM_GCSR_EXPA_SHIFT
))

	)

201 
	#NFP_ARM_GCSR_BULK_CSR
(
mode
, 
rg‘
, 
tok’
, 
is_64
, 
add»ss
) \

202 (((
mode
è? 
NFP_ARM_GCSR_BULK_BAR_TYPE_EXPA
 : \

203 
NFP_ARM_GCSR_BULK_BAR_TYPE_BULK
) | \

204 
	`NFP_ARM_GCSR_BULK_BAR_TGT
(
rg‘
) | \

205 
	`NFP_ARM_GCSR_BULK_BAR_TOK
(
tok’
) | \

206 ((
is_64
è? 
NFP_ARM_GCSR_BULK_BAR_LEN_64BIT
 : \

207 
NFP_ARM_GCSR_BULK_BAR_LEN_32BIT
) | \

208 
	`NFP_ARM_GCSR_BULK_BAR_ADDR
((
add»ss
è>> 
NFP_ARM_GCSR_BULK_SHIFT
))

	)

211 
	#NFP_ARM_MPCORE_SIZE
 
SZ_128K


	)

214 
	#NFP_ARM_PCSR_SIZE
 
SZ_64K


	)

	@src/nfpcore/nfp_cpp.h

10 #iâdeà
__NFP_CPP_H__


11 
	#__NFP_CPP_H__


	)

13 
	~<lšux/ùy³.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/sizes.h
>

17 
	~"kcom·t.h
"

19 #iâdeà
NFP_SUBSYS


20 
	#NFP_SUBSYS
 "nå"

	)

23 
	#nå_”r
(
ýp
, 
fmt
, 
¬gs
...) \

24 
	`dev_”r
(
	`nå_ýp_deviû
(
ýp
)->
·»Á
, 
NFP_SUBSYS
 ": " 
fmt
, ## 
¬gs
)

	)

25 
	#nå_w¬n
(
ýp
, 
fmt
, 
¬gs
...) \

26 
	`dev_w¬n
(
	`nå_ýp_deviû
(
ýp
)->
·»Á
, 
NFP_SUBSYS
 ": " 
fmt
, ## 
¬gs
)

	)

27 
	#nå_šfo
(
ýp
, 
fmt
, 
¬gs
...) \

28 
	`dev_šfo
(
	`nå_ýp_deviû
(
ýp
)->
·»Á
, 
NFP_SUBSYS
 ": " 
fmt
, ## 
¬gs
)

	)

29 
	#nå_dbg
(
ýp
, 
fmt
, 
¬gs
...) \

30 
	`dev_dbg
(
	`nå_ýp_deviû
(
ýp
)->
·»Á
, 
NFP_SUBSYS
 ": " 
fmt
, ## 
¬gs
)

	)

31 
	#nå_´štk
(
Ëv–
, 
ýp
, 
fmt
, 
¬gs
...) \

32 
	`dev_´štk
(
Ëv–
, 
	`nå_ýp_deviû
(
ýp
)->
·»Á
, \

33 
NFP_SUBSYS
 ": " 
fmt
, ## 
¬gs
)

	)

35 
	#PCI_64BIT_BAR_COUNT
 3

	)

39 
	#PCI_DEVICE_ID_NETRONOME_NFP3800
 0x3800

	)

41 
	#NFP_CPP_NUM_TARGETS
 16

	)

43 
	#NFP_CPP_SAFE_AREA_SIZE
 
SZ_2M


	)

46 
	#NFP_MUTEX_WAIT_FIRST_WARN
 15

	)

47 
	#NFP_MUTEX_WAIT_NEXT_WARN
 5

	)

48 
	#NFP_MUTEX_WAIT_ERROR
 60

	)

50 
	gdeviû
;

55 
	gnå_ýp_¬—
;

60 
	gnå_ýp
;

65 
	g»sourû
;

76 
	#NFP_CPP_ACTION_RW
 32

	)

78 
	#NFP_CPP_TARGET_ID_MASK
 0x1f

	)

80 
	#NFP_CPP_ATOMIC_RD
(
rg‘
, 
i¦ªd
) \

81 
	`NFP_CPP_ISLAND_ID
((
rg‘
), 3, 0, (
i¦ªd
))

	)

82 
	#NFP_CPP_ATOMIC_WR
(
rg‘
, 
i¦ªd
) \

83 
	`NFP_CPP_ISLAND_ID
((
rg‘
), 4, 0, (
i¦ªd
))

	)

98 
	#NFP_CPP_ID
(
rg‘
, 
aùiÚ
, 
tok’
) \

99 ((((
rg‘
è& 0x7fè<< 24è| (((
tok’
) & 0xff) << 16) | \

100 (((
aùiÚ
è& 0xffè<< 8))

	)

116 
	#NFP_CPP_ISLAND_ID
(
rg‘
, 
aùiÚ
, 
tok’
, 
i¦ªd
) \

117 ((((
rg‘
è& 0x7fè<< 24è| (((
tok’
) & 0xff) << 16) | \

118 (((
aùiÚ
è& 0xffè<< 8è| (((
i¦ªd
è& 0xffè<< 0))

	)

126 
šlše
 
u8
 
	$NFP_CPP_ID_TARGET_of
(
u32
 
id
)

128  (
id
 >> 24è& 
NFP_CPP_TARGET_ID_MASK
;

129 
	}
}

136 
šlše
 
u8
 
	$NFP_CPP_ID_TOKEN_of
(
u32
 
id
)

138  (
id
 >> 16) & 0xff;

139 
	}
}

147 
šlše
 
u8
 
	$NFP_CPP_ID_ACTION_of
(
u32
 
id
)

149  (
id
 >> 8) & 0xff;

150 
	}
}

158 
šlše
 
u8
 
	$NFP_CPP_ID_ISLAND_of
(
u32
 
id
)

160  (
id
 >> 0) & 0xff;

161 
	}
}

166 
	#NFP_CPP_INTERFACE_TYPE_INVALID
 0x0

	)

167 
	#NFP_CPP_INTERFACE_TYPE_PCI
 0x1

	)

168 
	#NFP_CPP_INTERFACE_TYPE_ARM
 0x2

	)

169 
	#NFP_CPP_INTERFACE_TYPE_RPC
 0x3

	)

170 
	#NFP_CPP_INTERFACE_TYPE_ILA
 0x4

	)

188 
	#NFP_CPP_INTERFACE
(
ty³
, 
un™
, 
chªÃl
) \

189 ((((
ty³
) & 0xf) << 12) | \

190 (((
un™
) & 0xf) << 8) | \

191 (((
chªÃl
è& 0xffè<< 0))

	)

198 
	#NFP_CPP_INTERFACE_TYPE_of
(
š‹rçû
è(((š‹rçûè>> 12è& 0xf)

	)

205 
	#NFP_CPP_INTERFACE_UNIT_of
(
š‹rçû
è(((š‹rçûè>> 8è& 0xf)

	)

212 
	#NFP_CPP_INTERFACE_CHANNEL_of
(
š‹rçû
è(((š‹rçûè>> 0è& 0xff)

	)

215 
nå_ýp
 *
nå_ýp_äom_deviû_id
(
id
);

216 
nå_ýp_ä“
(
nå_ýp
 *
ýp
);

217 
nå_ýp_deviû_id
(
nå_ýp
 *
ýp
);

218 
u32
 
nå_ýp_mod–
(
nå_ýp
 *
ýp
);

219 
u16
 
nå_ýp_š‹rçû
(
nå_ýp
 *
ýp
);

220 
nå_ýp_£rŸl
(
nå_ýp
 *
ýp
, cÚ¡ 
u8
 **
£rŸl
);

221 
nå_ýp_mu_loÿl™y_lsb
(
nå_ýp
 *
ýp
);

223 *
nå_nbi_ÿche
(
nå_ýp
 *
ýp
);

224 
nå_nbi_ÿche_£t
(
nå_ýp
 *
ýp
, *
v®
);

226 
nå_ýp_¬—
 *
nå_ýp_¬—_®loc_w™h_Çme
(
nå_ýp
 *
ýp
,

227 
u32
 
ýp_id
,

228 cÚ¡ *
Çme
,

229 
add»ss
,

230 
size
);

231 
nå_ýp_¬—
 *
nå_ýp_¬—_®loc
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

232 
add»ss
,

233 
size
);

234 
nå_ýp_¬—
 *

235 
nå_ýp_¬—_®loc_acquœe
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
, 
u32
 
ýp_id
,

236 
add»ss
, 
size
);

237 
nå_ýp_¬—_ä“
(
nå_ýp_¬—
 *
¬—
);

238 
nå_ýp_¬—_acquœe
(
nå_ýp_¬—
 *
¬—
);

239 
nå_ýp_¬—_acquœe_nÚblockšg
(
nå_ýp_¬—
 *
¬—
);

240 
nå_ýp_¬—_»Ëa£
(
nå_ýp_¬—
 *
¬—
);

241 
nå_ýp_¬—_»Ëa£_ä“
(
nå_ýp_¬—
 *
¬—
);

242 
nå_ýp_¬—_»ad
(
nå_ýp_¬—
 *
¬—
, 
off£t
,

243 *
bufãr
, 
size_t
 
Ëngth
);

244 
nå_ýp_¬—_wr™e
(
nå_ýp_¬—
 *
¬—
, 
off£t
,

245 cÚ¡ *
bufãr
, 
size_t
 
Ëngth
);

246 
size_t
 
nå_ýp_¬—_size
(
nå_ýp_¬—
 *
¬—
);

247 cÚ¡ *
nå_ýp_¬—_Çme
(
nå_ýp_¬—
 *
ýp_¬—
);

248 *
nå_ýp_¬—_´iv
(
nå_ýp_¬—
 *
ýp_¬—
);

249 
nå_ýp
 *
nå_ýp_¬—_ýp
(
nå_ýp_¬—
 *
ýp_¬—
);

250 
»sourû
 *
nå_ýp_¬—_»sourû
(
nå_ýp_¬—
 *
¬—
);

251 
phys_addr_t
 
nå_ýp_¬—_phys
(
nå_ýp_¬—
 *
¬—
);

252 
__iomem
 *
nå_ýp_¬—_iomem
(
nå_ýp_¬—
 *
¬—
);

254 
nå_ýp_¬—_»adl
(
nå_ýp_¬—
 *
¬—
, 
off£t
,

255 
u32
 *
v®ue
);

256 
nå_ýp_¬—_wr™–
(
nå_ýp_¬—
 *
¬—
, 
off£t
,

257 
u32
 
v®ue
);

258 
nå_ýp_¬—_»adq
(
nå_ýp_¬—
 *
¬—
, 
off£t
,

259 
u64
 *
v®ue
);

260 
nå_ýp_¬—_wr™eq
(
nå_ýp_¬—
 *
¬—
, 
off£t
,

261 
u64
 
v®ue
);

262 
nå_ýp_¬—_fžl
(
nå_ýp_¬—
 *
¬—
, 
off£t
,

263 
u32
 
v®ue
, 
size_t
 
Ëngth
);

265 
nå_xpb_»adl
(
nå_ýp
 *
ýp
, 
u32
 
xpb_tgt
, u32 *
v®ue
);

266 
nå_xpb_wr™–
(
nå_ýp
 *
ýp
, 
u32
 
xpb_tgt
, u32 
v®ue
);

267 
nå_xpb_wr™–m
(
nå_ýp
 *
ýp
, 
u32
 
xpb_tgt
, u32 
mask
, u32 
v®ue
);

270 
nå_ýp_»ad
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

271 
add»ss
, *
k”Ãl_vaddr
, 
size_t
 
Ëngth
);

272 
nå_ýp_wr™e
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

273 
add»ss
, cÚ¡ *
k”Ãl_vaddr
,

274 
size_t
 
Ëngth
);

275 
nå_ýp_»adl
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

276 
add»ss
, 
u32
 *
v®ue
);

277 
nå_ýp_wr™–
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

278 
add»ss
, 
u32
 
v®ue
);

279 
nå_ýp_»adq
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

280 
add»ss
, 
u64
 *
v®ue
);

281 
nå_ýp_wr™eq
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

282 
add»ss
, 
u64
 
v®ue
);

284 
u8
 
__iomem
 *

285 
nå_ýp_m­_¬—
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
, 
u32
 
ýp_id
, 
u64
 
addr
,

286 
size
, 
nå_ýp_¬—
 **
¬—
);

288 
	gnå_ýp_mu‹x
;

290 
nå_ýp_mu‹x_š™
(
nå_ýp
 *
ýp
, 
rg‘
,

291 
add»ss
, 
u32
 
key_id
);

292 
nå_ýp_mu‹x
 *
nå_ýp_mu‹x_®loc
(
nå_ýp
 *
ýp
, 
rg‘
,

293 
add»ss
,

294 
u32
 
key_id
);

295 
nå_ýp_mu‹x_ä“
(
nå_ýp_mu‹x
 *
mu‹x
);

296 
nå_ýp_mu‹x_lock
(
nå_ýp_mu‹x
 *
mu‹x
);

297 
nå_ýp_mu‹x_uÆock
(
nå_ýp_mu‹x
 *
mu‹x
);

298 
nå_ýp_mu‹x_Œylock
(
nå_ýp_mu‹x
 *
mu‹x
);

299 
nå_ýp_mu‹x_»þaim
(
nå_ýp
 *
ýp
, 
rg‘
,

300 
add»ss
);

302 
	gnå_ýp_ev’t
;

303 
	gsigaùiÚ
;

305 
nå_ýp_ev’t
 *
nå_ýp_ev’t_®loc
(
nå_ýp
 *
ýp
,

306 
u32
 
ev’t_m©ch
,

307 
u32
 
ev’t_mask
, 
ty³
);

308 
nå_ýp
 *
nå_ýp_ev’t_ýp
(
nå_ýp_ev’t
 *
ýp_ev’t
);

309 
nå_ýp_ev’t_as_sigÇl
(
nå_ýp_ev’t
 *
ev’t
, 
signum
,

310 cÚ¡ 
sigaùiÚ
 *
aù
);

311 
nå_ýp_ev’t_ä“
(
nå_ýp_ev’t
 *
ev’t
);

319 
šlše
 
u8
 
	$nå_ýpcÜe_pc›_un™
(
nå_ýp
 *
ýp
)

321  
	`NFP_CPP_INTERFACE_UNIT_of
(
	`nå_ýp_š‹rçû
(
ýp
));

322 
	}
}

324 
	gnå_ýp_ex¶ic™
;

326 
	snå_ýp_ex¶ic™_commªd
 {

327 
u32
 
	mýp_id
;

328 
u16
 
	md©a_»f
;

329 
u8
 
	md©a_ma¡”
;

330 
u8
 
	mËn
;

331 
u8
 
	mby‹_mask
;

332 
u8
 
	msigÇl_ma¡”
;

333 
u8
 
	msigÇl_»f
;

334 
u8
 
	mpo¡ed
;

335 
u8
 
	msiga
;

336 
u8
 
	msigb
;

337 
s8
 
	msiga_mode
;

338 
s8
 
	msigb_mode
;

341 
	#NFP_SERIAL_LEN
 6

	)

370 
	snå_ýp_Ý”©iÚs
 {

371 
size_t
 
	m¬—_´iv_size
;

372 
size_t
 
	mev’t_´iv_size
;

373 
moduË
 *
	mowÃr
;

375 (*
	mš™
)(
nå_ýp
 *
	mýp
);

376 (*
	mä“
)(
nå_ýp
 *
	mýp
);

378 (*
	m»ad_£rŸl
)(
deviû
 *
	mdev
, 
u8
 *
	m£rŸl
);

379 (*
	mg‘_š‹rçû
)(
deviû
 *
	mdev
);

381 (*
	m¬—_š™
)(
nå_ýp_¬—
 *
	m¬—
,

382 
u32
 
	mde¡
, 
	madd»ss
,

383 
	msize
);

384 (*
	m¬—_þ—nup
)(
nå_ýp_¬—
 *
	m¬—
);

385 (*
	m¬—_acquœe
)(
nå_ýp_¬—
 *
	m¬—
);

386 (*
	m¬—_»Ëa£
)(
nå_ýp_¬—
 *
	m¬—
);

387 
	m»sourû
 *(*
	m¬—_»sourû
)(
nå_ýp_¬—
 *
	m¬—
);

388 
phys_addr_t
 (*
¬—_phys
)(
nå_ýp_¬—
 *
	m¬—
);

389 
	m__iomem
 *(*
	m¬—_iomem
)(
nå_ýp_¬—
 *
	m¬—
);

390 (*
	m¬—_»ad
)(
nå_ýp_¬—
 *
	m¬—
, *
	mk”Ãl_vaddr
,

391 
	moff£t
, 
	mËngth
);

392 (*
	m¬—_wr™e
)(
nå_ýp_¬—
 *
	m¬—
, cÚ¡ *
	mk”Ãl_vaddr
,

393 
	moff£t
, 
	mËngth
);

398 (*
	mev’t_acquœe
)(
nå_ýp_ev’t
 *
	mev’t
, 
u32
 
	mm©ch
,

399 
u32
 
	mmask
, u32 
	mty³
);

400 (*
	mev’t_»Ëa£
)(
nå_ýp_ev’t
 *
	mev’t
);

402 
size_t
 
	mex¶ic™_´iv_size
;

403 (*
	mex¶ic™_acquœe
)(
nå_ýp_ex¶ic™
 *
	mex¶
);

404 (*
	mex¶ic™_»Ëa£
)(
nå_ýp_ex¶ic™
 *
	mex¶
);

405 (*
	mex¶ic™_put
)(
nå_ýp_ex¶ic™
 *
	mex¶
,

406 cÚ¡ *
	mbuff
, 
size_t
 
	mËn
);

407 (*
	mex¶ic™_g‘
)(
nå_ýp_ex¶ic™
 *
	mex¶
,

408 *
	mbuff
, 
size_t
 
	mËn
);

409 (*
	mex¶ic™_do
)(
nå_ýp_ex¶ic™
 *
	mex¶
,

410 cÚ¡ 
nå_ýp_ex¶ic™_commªd
 *
	mcmd
,

411 
u64
 
	madd»ss
);

414 
nå_ýp
 *

415 
nå_ýp_äom_Ý”©iÚs
(cÚ¡ 
nå_ýp_Ý”©iÚs
 *
Ýs
,

416 
deviû
 *
·»Á
, *
´iv
);

417 *
nå_ýp_´iv
(
nå_ýp
 *
´iv
);

419 
nå_ýp_¬—_ÿche_add
(
nå_ýp
 *
ýp
, 
size_t
 
size
);

428 
	#NFP_CPP_INTERFACE_CHANNEL_PEROPENER
 255

	)

429 
deviû
 *
nå_ýp_deviû
(
nå_ýp
 *
ýp
);

431 
nå_ýp_ev’t_ÿÎback
(
nå_ýp_ev’t
 *
ev’t
);

432 
nå_ýp_ev’t_as_ÿÎback
(
nå_ýp_ev’t
 *
ev’t
,

433 (*
ÿÎback
)(*), *
´iv
);

434 *
	`nå_ýp_ev’t_´iv
(
nå_ýp_ev’t
 *
ýp_ev’t
);

436 
u64
 
	`nå_ýp_i¦ªd_mask
(
nå_ýp
 *
ýp
);

440 
	#NFP_SIGNAL_MASK_A
 
	`BIT
(0è

	)

441 
	#NFP_SIGNAL_MASK_B
 
	`BIT
(1è

	)

443 
	enå_ýp_ex¶ic™_sigÇl_mode
 {

444 
NFP_SIGNAL_NONE
 = 0,

445 
NFP_SIGNAL_PUSH
 = 1,

446 
NFP_SIGNAL_PUSH_OPTIONAL
 = -1,

447 
NFP_SIGNAL_PULL
 = 2,

448 
NFP_SIGNAL_PULL_OPTIONAL
 = -2,

451 
nå_ýp_ex¶ic™
 *
	`nå_ýp_ex¶ic™_acquœe
(
nå_ýp
 *
ýp
);

452 
	`nå_ýp_ex¶ic™_£t_rg‘
(
nå_ýp_ex¶ic™
 *
ex¶
, 
u32
 
ýp_id
,

453 
u8
 
Ën
, u8 
mask
);

454 
	`nå_ýp_ex¶ic™_£t_d©a
(
nå_ýp_ex¶ic™
 *
ex¶
,

455 
u8
 
d©a_ma¡”
, 
u16
 
d©a_»f
);

456 
	`nå_ýp_ex¶ic™_£t_sigÇl
(
nå_ýp_ex¶ic™
 *
ex¶
,

457 
u8
 
sigÇl_ma¡”
, u8 
sigÇl_»f
);

458 
	`nå_ýp_ex¶ic™_£t_po¡ed
(
nå_ýp_ex¶ic™
 *
ex¶
, 
po¡ed
,

459 
u8
 
siga
,

460 
nå_ýp_ex¶ic™_sigÇl_mode
 
siga_mode
,

461 
u8
 
sigb
,

462 
nå_ýp_ex¶ic™_sigÇl_mode
 
sigb_mode
);

463 
	`nå_ýp_ex¶ic™_put
(
nå_ýp_ex¶ic™
 *
ex¶
,

464 cÚ¡ *
buff
, 
size_t
 
Ën
);

465 
	`nå_ýp_ex¶ic™_do
(
nå_ýp_ex¶ic™
 *
ex¶
, 
u64
 
add»ss
);

466 
	`nå_ýp_ex¶ic™_g‘
(
nå_ýp_ex¶ic™
 *
ex¶
, *
buff
, 
size_t
 
Ën
);

467 
	`nå_ýp_ex¶ic™_»Ëa£
(
nå_ýp_ex¶ic™
 *
ex¶
);

468 
nå_ýp
 *
	`nå_ýp_ex¶ic™_ýp
(
nå_ýp_ex¶ic™
 *
ex¶
);

469 *
	`nå_ýp_ex¶ic™_´iv
(
nå_ýp_ex¶ic™
 *
ýp_ex¶ic™
);

473 
nå_em_mªag”
;

475 
nå_em_mªag”
 *
	`nå_em_mªag”_ü—‹
(
__iomem
 *
em
, 
œq
);

476 
	`nå_em_mªag”_de¡roy
(
nå_em_mªag”
 *
evm
);

478 
	`nå_em_mªag”_acquœe
(
nå_em_mªag”
 *
evm
,

479 
nå_ýp_ev’t
 *
ev’t
,

480 
u32
 
m©ch
, u32 
mask
, u32 
ty³
);

481 
	`nå_em_mªag”_»Ëa£
(
nå_em_mªag”
 *
evm
, 
fž‹r
);

485 
	`nå_ýp_mod–_autod‘eù
(
nå_ýp
 *
ýp
, 
u32
 *
mod–
);

487 
	`nå_ýp_ex¶ic™_»ad
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

488 
u64
 
addr
, *
buff
, 
size_t
 
Ën
,

489 
width_»ad
);

491 
	`nå_ýp_ex¶ic™_wr™e
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

492 
u64
 
addr
, cÚ¡ *
buff
, 
size_t
 
Ën
,

493 
width_wr™e
);

497 
	`nå_ýpcÜe_š™
();

498 
	`nå_ýpcÜe_ex™
();

507 
	snå_¶©fÜm_d©a
 {

508 
nå
;

509 
un™
;

512 
	#nå_¶©fÜm_deviû_d©a
(
pdev
è(Õdev)->
dev
.
¶©fÜm_d©a
)

	)

514 
¶©fÜm_deviû
 *
	`nå_¶©fÜm_deviû_»gi¡”_un™
(
nå_ýp
 *
ýp
,

515 cÚ¡ *
ty³
,

516 
un™
, 
un™s
);

517 
¶©fÜm_deviû
 *
	`nå_¶©fÜm_deviû_»gi¡”
(
nå_ýp
 *
ýp
,

518 cÚ¡ *
ty³
);

519 
	`nå_¶©fÜm_deviû_uÄegi¡”
(
¶©fÜm_deviû
 *
pdev
);

	@src/nfpcore/nfp_cppcore.c

12 
	~<asm/uÇligÃd.h
>

13 
	~<lšux/d–ay.h
>

14 
	~<lšux/deviû.h
>

15 
	~<lšux/iÝÜt.h
>

16 
	~<lšux/k”Ãl.h
>

17 
	~<lšux/moduË.h
>

18 
	~<lšux/mu‹x.h
>

19 
	~<lšux/¶©fÜm_deviû.h
>

20 
	~<lšux/´oc_fs.h
>

21 
	~<lšux/£q_fže.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/wa™.h
>

26 
	~"nå_¬m.h
"

27 
	~"nå_ýp.h
"

28 
	~"nå6000/nå6000.h
"

30 
	#NFP_ARM_GCSR_SOFTMODEL2
 0x0000014c

	)

31 
	#NFP_ARM_GCSR_SOFTMODEL3
 0x00000150

	)

35 
	gignÜe_quœks
;

36 
moduË_·¿m
(
ignÜe_quœks
, , 0644);

37 
MODULE_PARM_DESC
(
ignÜe_quœks
,

40 
	snå_ýp_»sourû
 {

41 
li¡_h—d
 
	mli¡
;

42 cÚ¡ *
	mÇme
;

43 
u32
 
	mýp_id
;

44 
u64
 
	m¡¬t
;

45 
u64
 
	m’d
;

79 
	snå_ýp
 {

80 
	mid
;

81 
deviû
 
	mdev
;

82 
k»f
 
	mk»f
;

84 *
	m´iv
;

86 
u32
 
	mmod–
;

87 
u16
 
	mš‹rçû
;

88 
u8
 
	m£rŸl
[
NFP_SERIAL_LEN
];

90 cÚ¡ 
nå_ýp_Ý”©iÚs
 *
	mÝ
;

91 
li¡_h—d
 
	m»sourû_li¡
;

92 
rwlock_t
 
	m»sourû_lock
;

93 
li¡_h—d
 
	mli¡
;

94 
wa™_queue_h—d_t
 
	mwa™q
;

96 
¶©fÜm_deviû
 *
	mã©u»
[32];

98 
u32
 
	mimb_ÿt_bË
[16];

99 
u64
 
	mi¦ªd_mask
;

100 
	mmu_loÿl™y_lsb
;

102 
mu‹x
 
	m¬—_ÿche_mu‹x
;

103 
li¡_h—d
 
	m¬—_ÿche_li¡
;

105 *
	mnbi
;

109 
	snå_ýp_¬—_ÿche
 {

110 
li¡_h—d
 
	m’Œy
;

111 
u32
 
	mid
;

112 
u64
 
	maddr
;

113 
u32
 
	msize
;

114 
nå_ýp_¬—
 *
	m¬—
;

117 
	snå_ýp_¬—
 {

118 
nå_ýp
 *
	mýp
;

119 
k»f
 
	mk»f
;

120 
©omic_t
 
	m»fcouÁ
;

121 
mu‹x
 
	mmu‹x
;

122 
	moff£t
;

123 
	msize
;

124 
nå_ýp_»sourû
 
	m»sourû
;

125 
__iomem
 *
	miomem
;

129 
	snå_ýp_ex¶ic™
 {

130 
nå_ýp
 *
	mýp
;

131 
nå_ýp_ex¶ic™_commªd
 
	mcmd
;

135 
	snå_ýp_ev’t
 {

136 
nå_ýp
 *
	mýp
;

138 
¥šlock_t
 
	mlock
;

139 (*
	mfunc
)(*
	m´iv
);

140 *
	m´iv
;

141 } 
	mÿÎback
;

145 
	#NFP_CPP_MAX
 256

	)

147 
DECLARE_BITMAP
(
nå_ýp_id
, 
NFP_CPP_MAX
);

148 
mu‹x
 
	gnå_ýp_id_lock
;

149 
li¡_h—d
 
	gnå_ýp_li¡
;

150 
rwlock_t
 
	gnå_ýp_li¡_lock
;

152 
ssize_t
 
	$show_¬—
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

153 *
buf
)

155 
nå_ýp
 *
ýp
 = 
	`dev_g‘_drvd©a
(
dev
);

156 
nå_ýp_»sourû
 *
r
;

157 
Ëá
 = 
PAGE_SIZE
;

159 
	`»ad_lock
(&
ýp
->
»sourû_lock
);

161 
	`li¡_fÜ_—ch_’Œy
(
r
, &
ýp
->
»sourû_li¡
, 
li¡
) {

162 
nå_ýp_¬—
 *
¬—
 =

163 
	`cÚš”_of
(
r
, 
nå_ýp_¬—
, 
»sourû
);

164 
couÁ
 = 
	`©omic_»ad
(&
¬—
->
»fcouÁ
);

165 
Ën
;

167 
Ën
 = 
	`¢´štf
(
buf
, 
Ëá
, "%d %d:%d:%d:0x%0llx-0x%0llx%s%s\n",

168 
couÁ
,

169 
	`NFP_CPP_ID_TARGET_of
(
r
->
ýp_id
),

170 
	`NFP_CPP_ID_ACTION_of
(
r
->
ýp_id
),

171 
	`NFP_CPP_ID_TOKEN_of
(
r
->
ýp_id
),

172 
r
->
¡¬t
,„->
’d
,

173 
r
->
Çme
 ? " " : "",

174 
r
->
Çme
 ?„->name : "");

175 ià(
Ën
 > 
Ëá
) {

176 *
buf
 = 0;

180 
buf
 +ð
Ën
;

181 
Ëá
 -ð
Ën
;

184 
	`»ad_uÆock
(&
ýp
->
»sourû_lock
);

186  
PAGE_SIZE
 - 
Ëá
;

187 
	}
}

189 
DEVICE_ATTR
(
¬—
, 
S_IRUGO
, 
show_¬—
, 
NULL
);

191 
	$nå_ýp_id_acquœe
()

193 
id
;

195 
	`mu‹x_lock
(&
nå_ýp_id_lock
);

196 
id
 = 
	`fšd_fœ¡_z”o_b™
(
nå_ýp_id
, 
NFP_CPP_MAX
);

197 ià(
id
 < 
NFP_CPP_MAX
)

198 
	`£t_b™
(
id
, 
nå_ýp_id
);

199 
	`mu‹x_uÆock
(&
nå_ýp_id_lock
);

201  
id
 < 
NFP_CPP_MAX
 ? id : -1;

202 
	}
}

204 
	$nå_ýp_id_»Ëa£
(
id
)

206 
	`mu‹x_lock
(&
nå_ýp_id_lock
);

207 
	`þ—r_b™
(
id
, 
nå_ýp_id
);

208 
	`mu‹x_uÆock
(&
nå_ýp_id_lock
);

209 
	}
}

211 
	$__»sourû_add
(
li¡_h—d
 *
h—d
, 
nå_ýp_»sourû
 *
»s
)

213 
nå_ýp_»sourû
 *
tmp
;

214 
li¡_h—d
 *
pos
;

216 
	`li¡_fÜ_—ch
(
pos
, 
h—d
) {

217 
tmp
 = 
	`cÚš”_of
(
pos
, 
nå_ýp_»sourû
, 
li¡
);

219 ià(
tmp
->
ýp_id
 > 
»s
->cpp_id)

222 ià(
tmp
->
ýp_id
 =ð
»s
->ýp_id &&mp->
¡¬t
 >„es->start)

226 
	`li¡_add_ž
(&
»s
->
li¡
, 
pos
);

227 
	}
}

229 
	$__»sourû_d–
(
nå_ýp_»sourû
 *
»s
)

231 
	`li¡_d–_š™
(&
»s
->
li¡
);

232 
	}
}

234 
	$__»Ëa£_ýp_¬—
(
k»f
 *kref)

236 
nå_ýp_¬—
 *
¬—
 =

237 
	`cÚš”_of
(
k»f
, 
nå_ýp_¬—
, kref);

238 
nå_ýp
 *
ýp
 = 
	`nå_ýp_¬—_ýp
(
¬—
);

240 ià(
¬—
->
ýp
->
Ý
->
¬—_þ—nup
)

241 
¬—
->
ýp
->
Ý
->
	`¬—_þ—nup
(area);

243 
	`wr™e_lock
(&
ýp
->
»sourû_lock
);

244 
	`__»sourû_d–
(&
¬—
->
»sourû
);

245 
	`wr™e_uÆock
(&
ýp
->
»sourû_lock
);

246 
	`kä“
(
¬—
);

247 
	}
}

249 
	$nå_ýp_¬—_put
(
nå_ýp_¬—
 *
¬—
)

251 
	`k»f_put
(&
¬—
->
k»f
, 
__»Ëa£_ýp_¬—
);

252 
	}
}

254 
nå_ýp_¬—
 *
	$nå_ýp_¬—_g‘
(
nå_ýp_¬—
 *
¬—
)

256 
	`k»f_g‘
(&
¬—
->
k»f
);

258  
¬—
;

259 
	}
}

261 
	$__nå_ýp_»Ëa£
(
k»f
 *kref)

263 
nå_ýp
 *
ýp
 = 
	`cÚš”_of
(
k»f
, nfp_cpp, kref);

264 
nå_ýp_¬—_ÿche
 *
ÿche
, *
ùmp
;

265 
nå_ýp_»sourû
 *
»s
, *
¹mp
;

267 
	`deviû_»move_fže
(&
ýp
->
dev
, &
dev_©Œ_¬—
);

270 
	`li¡_fÜ_—ch_’Œy_§ã
(
ÿche
, 
ùmp
, &
ýp
->
¬—_ÿche_li¡
, 
’Œy
) {

271 
	`li¡_d–
(&
ÿche
->
’Œy
);

272 ià(
ÿche
->
id
)

273 
	`nå_ýp_¬—_»Ëa£
(
ÿche
->
¬—
);

274 
	`nå_ýp_¬—_ä“
(
ÿche
->
¬—
);

275 
	`kä“
(
ÿche
);

279 
	`WARN_ON
(!
	`li¡_em±y
(&
ýp
->
»sourû_li¡
));

282 
	`li¡_fÜ_—ch_’Œy_§ã
(
»s
, 
¹mp
, &
ýp
->
»sourû_li¡
, 
li¡
) {

283 
nå_ýp_¬—
 *
¬—
 = 
	`cÚš”_of
(
»s
,

284 
nå_ýp_¬—
,

285 
»sourû
);

287 
	`dev_”r
(
ýp
->
dev
.
·»Á
, "Dangling‡rea: %d:%d:%d:0x%0llx-0x%0llx%s%s\n",

288 
	`NFP_CPP_ID_TARGET_of
(
»s
->
ýp_id
),

289 
	`NFP_CPP_ID_ACTION_of
(
»s
->
ýp_id
),

290 
	`NFP_CPP_ID_TOKEN_of
(
»s
->
ýp_id
),

291 
»s
->
¡¬t
,„es->
’d
,

292 
»s
->
Çme
 ? " " : "",

293 
»s
->
Çme
 ?„es->name : "");

295 ià(
¬—
->
ýp
->
Ý
->
¬—_»Ëa£
)

296 
¬—
->
ýp
->
Ý
->
	`¬—_»Ëa£
(area);

298 
	`__»Ëa£_ýp_¬—
(&
¬—
->
k»f
);

301 ià(
ýp
->
Ý
->
ä“
)

302 
ýp
->
Ý
->
	`ä“
(cpp);

304 
	`kä“
(
ýp
->
nbi
);

306 
	`wr™e_lock
(&
nå_ýp_li¡_lock
);

307 
	`li¡_d–_š™
(&
ýp
->
li¡
);

308 
	`wr™e_uÆock
(&
nå_ýp_li¡_lock
);

310 
	`deviû_uÄegi¡”
(&
ýp
->
dev
);

312 
	`nå_ýp_id_»Ëa£
(
ýp
->
id
);

313 
	`kä“
(
ýp
);

314 
	}
}

316 
nå_ýp
 *
	$nå_ýp_g‘
(
nå_ýp
 *
ýp
)

318 ià(!
	`k»f_g‘_uÆess_z”o
(&
ýp
->
k»f
))

319  
NULL
;

321  
ýp
;

322 
	}
}

324 
	$nå_ýp_put
(
nå_ýp
 *
ýp
)

326 
	`k»f_put
(&
ýp
->
k»f
, 
__nå_ýp_»Ëa£
);

327 
	}
}

335 
nå_ýp
 *
	$nå_ýp_äom_deviû_id
(
id
)

337 
nå_ýp
 *
tmp
, *
ýp
 = 
NULL
;

339 
	`»ad_lock
(&
nå_ýp_li¡_lock
);

340 
	`li¡_fÜ_—ch_’Œy
(
tmp
, &
nå_ýp_li¡
, 
li¡
) {

341 ià(
tmp
->
id
 == id) {

342 
ýp
 = 
	`nå_ýp_g‘
(
tmp
);

346 
	`»ad_uÆock
(&
nå_ýp_li¡_lock
);

348  
ýp
;

349 
	}
}

355 
	$nå_ýp_ä“
(
nå_ýp
 *
ýp
)

357 
	`nå_ýp_put
(
ýp
);

358 
	}
}

366 
	$nå_ýp_deviû_id
(
nå_ýp
 *
ýp
)

368  
ýp
->
id
;

369 
	}
}

377 
u32
 
	$nå_ýp_mod–
(
nå_ýp
 *
ýp
)

379  
ýp
->
mod–
;

380 
	}
}

388 
u16
 
	$nå_ýp_š‹rçû
(
nå_ýp
 *
ýp
)

390  
ýp
->
š‹rçû
;

391 
	}
}

400 
	$nå_ýp_£rŸl
(
nå_ýp
 *
ýp
, cÚ¡ 
u8
 **
£rŸl
)

402 *
£rŸl
 = &
ýp
->serial[0];

403  (
ýp
->
£rŸl
);

404 
	}
}

406 *
	$nå_nbi_ÿche
(
nå_ýp
 *
ýp
)

408  
ýp
->
nbi
;

409 
	}
}

411 
	$nå_nbi_ÿche_£t
(
nå_ýp
 *
ýp
, *
v®
)

413 
ýp
->
nbi
 = 
v®
;

414 
	}
}

416 
	#NFP_IMB_TGTADDRESSMODECFG_MODE_of
(
_x
è(((_xè>> 13è& 0x7)

	)

417 
	#NFP_IMB_TGTADDRESSMODECFG_ADDRMODE
 
	`BIT
(12)

	)

418 
	#NFP_IMB_TGTADDRESSMODECFG_ADDRMODE_32_BIT
 0

	)

419 
	#NFP_IMB_TGTADDRESSMODECFG_ADDRMODE_40_BIT
 
	`BIT
(12)

	)

421 
	$nå_ýp_£t_mu_loÿl™y_lsb
(
nå_ýp
 *
ýp
)

423 
mode
, 
addr40
;

424 
u32
 
imbý·t
;

425 
»s
;

427 
imbý·t
 = 
ýp
->
imb_ÿt_bË
[
NFP_CPP_TARGET_MU
];

428 
mode
 = 
	`NFP_IMB_TGTADDRESSMODECFG_MODE_of
(
imbý·t
);

429 
addr40
 = !!(
imbý·t
 & 
NFP_IMB_TGTADDRESSMODECFG_ADDRMODE
);

431 
»s
 = 
	`nå_ý·t_mu_loÿl™y_lsb
(
mode
, 
addr40
);

432 ià(
»s
 < 0)

433  
»s
;

434 
ýp
->
mu_loÿl™y_lsb
 = 
»s
;

437 
	}
}

439 
	$nå_ýp_mu_loÿl™y_lsb
(
nå_ýp
 *
ýp
)

441  
ýp
->
mu_loÿl™y_lsb
;

442 
	}
}

459 
nå_ýp_¬—
 *

460 
	$nå_ýp_¬—_®loc_w™h_Çme
(
nå_ýp
 *
ýp
, 
u32
 
de¡
, cÚ¡ *
Çme
,

461 
add»ss
, 
size
)

463 
nå_ýp_¬—
 *
¬—
;

464 
u64
 
tmp64
 = 
add»ss
;

465 
”r
, 
Çme_Ën
;

468 
”r
 = 
	`nå_rg‘_ýp
(
de¡
, 
tmp64
, &de¡, &tmp64, 
ýp
->
imb_ÿt_bË
);

469 ià(
”r
 < 0)

470  
NULL
;

472 
add»ss
 = 
tmp64
;

474 ià(!
Çme
)

475 
Çme
 = "(reserved)";

477 
Çme_Ën
 = 
	`¡¾’
(
Çme
) + 1;

478 
¬—
 = 
	`kz®loc
((*¬—è+ 
ýp
->
Ý
->
¬—_´iv_size
 + 
Çme_Ën
,

479 
GFP_KERNEL
);

480 ià(!
¬—
)

481  
NULL
;

483 
¬—
->
ýp
 = cpp;

484 
¬—
->
»sourû
.
Çme
 = (*)area + (*area) +

485 
ýp
->
Ý
->
¬—_´iv_size
;

486 
	`memýy
((*)
¬—
->
»sourû
.
Çme
,‚ame, 
Çme_Ën
);

488 
¬—
->
»sourû
.
ýp_id
 = 
de¡
;

489 
¬—
->
»sourû
.
¡¬t
 = 
add»ss
;

490 
¬—
->
»sourû
.
’d
 =‡»a->»sourû.
¡¬t
 + 
size
 - 1;

491 
	`INIT_LIST_HEAD
(&
¬—
->
»sourû
.
li¡
);

493 
	`©omic_£t
(&
¬—
->
»fcouÁ
, 0);

494 
	`k»f_š™
(&
¬—
->
k»f
);

495 
	`mu‹x_š™
(&
¬—
->
mu‹x
);

497 ià(
ýp
->
Ý
->
¬—_š™
) {

498 
”r
;

500 
”r
 = 
ýp
->
Ý
->
	`¬—_š™
(
¬—
, 
de¡
, 
add»ss
, 
size
);

501 ià(
”r
 < 0) {

502 
	`kä“
(
¬—
);

503  
NULL
;

507 
	`wr™e_lock
(&
ýp
->
»sourû_lock
);

508 
	`__»sourû_add
(&
ýp
->
»sourû_li¡
, &
¬—
->
»sourû
);

509 
	`wr™e_uÆock
(&
ýp
->
»sourû_lock
);

511 
¬—
->
off£t
 = 
add»ss
;

512 
¬—
->
size
 = size;

514  
¬—
;

515 
	}
}

531 
nå_ýp_¬—
 *

532 
	$nå_ýp_¬—_®loc
(
nå_ýp
 *
ýp
, 
u32
 
de¡
,

533 
add»ss
, 
size
)

535  
	`nå_ýp_¬—_®loc_w™h_Çme
(
ýp
, 
de¡
, 
NULL
, 
add»ss
, 
size
);

536 
	}
}

554 
nå_ýp_¬—
 *

555 
	$nå_ýp_¬—_®loc_acquœe
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
, 
u32
 
de¡
,

556 
add»ss
, 
size
)

558 
nå_ýp_¬—
 *
¬—
;

560 
¬—
 = 
	`nå_ýp_¬—_®loc_w™h_Çme
(
ýp
, 
de¡
, 
Çme
, 
add»ss
, 
size
);

561 ià(!
¬—
)

562  
NULL
;

564 ià(
	`nå_ýp_¬—_acquœe
(
¬—
)) {

565 
	`nå_ýp_¬—_ä“
(
¬—
);

566  
NULL
;

569  
¬—
;

570 
	}
}

578 
	$nå_ýp_¬—_ä“
(
nå_ýp_¬—
 *
¬—
)

580 ià(
	`©omic_»ad
(&
¬—
->
»fcouÁ
))

581 
	`nå_w¬n
(
¬—
->
ýp
, "Warning: freeing busy‡rea\n");

582 
	`nå_ýp_¬—_put
(
¬—
);

583 
	}
}

585 
boÞ
 
	$nå_ýp_¬—_acquœe_Œy
(
nå_ýp_¬—
 *
¬—
, *
¡©us
)

587 *
¡©us
 = 
¬—
->
ýp
->
Ý
->
	`¬—_acquœe
(area);

589  *
¡©us
 !ð-
EAGAIN
;

590 
	}
}

592 
	$__nå_ýp_¬—_acquœe
(
nå_ýp_¬—
 *
¬—
)

594 
”r
, 
¡©us
;

596 ià(
	`©omic_šc_»tuº
(&
¬—
->
»fcouÁ
) > 1)

599 ià(!
¬—
->
ýp
->
Ý
->
¬—_acquœe
)

602 
”r
 = 
	`wa™_ev’t_š‹¼u±ibË
(
¬—
->
ýp
->
wa™q
,

603 
	`nå_ýp_¬—_acquœe_Œy
(
¬—
, &
¡©us
));

604 ià(!
”r
)

605 
”r
 = 
¡©us
;

606 ià(
”r
) {

607 
	`nå_w¬n
(
¬—
->
ýp
, "W¬nšg:‡»¨wa™ fažed: %d\n", 
”r
);

608 
	`©omic_dec
(&
¬—
->
»fcouÁ
);

609  
”r
;

612 
	`nå_ýp_¬—_g‘
(
¬—
);

615 
	}
}

626 
	$nå_ýp_¬—_acquœe
(
nå_ýp_¬—
 *
¬—
)

628 
»t
;

630 
	`mu‹x_lock
(&
¬—
->
mu‹x
);

631 
»t
 = 
	`__nå_ýp_¬—_acquœe
(
¬—
);

632 
	`mu‹x_uÆock
(&
¬—
->
mu‹x
);

634  
»t
;

635 
	}
}

648 
	$nå_ýp_¬—_acquœe_nÚblockšg
(
nå_ýp_¬—
 *
¬—
)

650 
	`mu‹x_lock
(&
¬—
->
mu‹x
);

651 ià(
	`©omic_šc_»tuº
(&
¬—
->
»fcouÁ
) == 1) {

652 ià(
¬—
->
ýp
->
Ý
->
¬—_acquœe
) {

653 
”r
;

655 
”r
 = 
¬—
->
ýp
->
Ý
->
	`¬—_acquœe
(area);

656 ià(
”r
 < 0) {

657 
	`©omic_dec
(&
¬—
->
»fcouÁ
);

658 
	`mu‹x_uÆock
(&
¬—
->
mu‹x
);

659  
”r
;

663 
	`mu‹x_uÆock
(&
¬—
->
mu‹x
);

665 
	`nå_ýp_¬—_g‘
(
¬—
);

667 
	}
}

675 
	$nå_ýp_¬—_»Ëa£
(
nå_ýp_¬—
 *
¬—
)

677 
	`mu‹x_lock
(&
¬—
->
mu‹x
);

679 ià(
	`©omic_dec_ªd_‹¡
(&
¬—
->
»fcouÁ
)) {

680 ià(
¬—
->
ýp
->
Ý
->
¬—_»Ëa£
) {

681 
¬—
->
ýp
->
Ý
->
	`¬—_»Ëa£
(area);

683 
	`wake_up_š‹¼u±ibË_®l
(&
¬—
->
ýp
->
wa™q
);

686 
	`mu‹x_uÆock
(&
¬—
->
mu‹x
);

688 
	`nå_ýp_¬—_put
(
¬—
);

689 
	}
}

697 
	$nå_ýp_¬—_»Ëa£_ä“
(
nå_ýp_¬—
 *
¬—
)

699 
	`nå_ýp_¬—_»Ëa£
(
¬—
);

700 
	`nå_ýp_¬—_ä“
(
¬—
);

701 
	}
}

717 
	$nå_ýp_¬—_»ad
(
nå_ýp_¬—
 *
¬—
,

718 
off£t
, *
k”Ãl_vaddr
,

719 
size_t
 
Ëngth
)

721  
¬—
->
ýp
->
Ý
->
	`¬—_»ad
×»a, 
k”Ãl_vaddr
, 
off£t
, 
Ëngth
);

722 
	}
}

738 
	$nå_ýp_¬—_wr™e
(
nå_ýp_¬—
 *
¬—
,

739 
off£t
, cÚ¡ *
k”Ãl_vaddr
,

740 
size_t
 
Ëngth
)

742  
¬—
->
ýp
->
Ý
->
	`¬—_wr™e
×»a, 
k”Ãl_vaddr
, 
off£t
, 
Ëngth
);

743 
	}
}

751 
size_t
 
	$nå_ýp_¬—_size
(
nå_ýp_¬—
 *
ýp_¬—
)

753  
ýp_¬—
->
size
;

754 
	}
}

762 cÚ¡ *
	$nå_ýp_¬—_Çme
(
nå_ýp_¬—
 *
ýp_¬—
)

764  
ýp_¬—
->
»sourû
.
Çme
;

765 
	}
}

773 *
	$nå_ýp_¬—_´iv
(
nå_ýp_¬—
 *
ýp_¬—
)

775  &
ýp_¬—
[1];

776 
	}
}

784 
nå_ýp
 *
	$nå_ýp_¬—_ýp
(
nå_ýp_¬—
 *
ýp_¬—
)

786  
ýp_¬—
->
ýp
;

787 
	}
}

797 
»sourû
 *
	$nå_ýp_¬—_»sourû
(
nå_ýp_¬—
 *
¬—
)

799 
»sourû
 *
»s
 = 
NULL
;

801 ià(
¬—
->
ýp
->
Ý
->
¬—_»sourû
)

802 
»s
 = 
¬—
->
ýp
->
Ý
->
	`¬—_»sourû
(area);

804  
»s
;

805 
	}
}

815 
phys_addr_t
 
	$nå_ýp_¬—_phys
(
nå_ýp_¬—
 *
¬—
)

817 
phys_addr_t
 
addr
 = ~0;

819 ià(
¬—
->
ýp
->
Ý
->
¬—_phys
)

820 
addr
 = 
¬—
->
ýp
->
Ý
->
	`¬—_phys
(area);

822  
addr
;

823 
	}
}

836 
__iomem
 *
	$nå_ýp_¬—_iomem
(
nå_ýp_¬—
 *
¬—
)

838 
__iomem
 *
iomem
 = 
NULL
;

840 ià(
¬—
->
ýp
->
Ý
->
¬—_iomem
)

841 
iomem
 = 
¬—
->
ýp
->
Ý
->
	`¬—_iomem
(area);

843  
iomem
;

844 
	}
}

854 
	$nå_ýp_¬—_»adl
(
nå_ýp_¬—
 *
¬—
,

855 
off£t
, 
u32
 *
v®ue
)

857 
u8
 
tmp
[4];

858 
n
;

860 
n
 = 
	`nå_ýp_¬—_»ad
(
¬—
, 
off£t
, &
tmp
, (tmp));

861 ià(
n
 !ð(
tmp
))

862  
n
 < 0 ?‚ : -
EIO
;

864 *
v®ue
 = 
	`g‘_uÇligÃd_Ë32
(
tmp
);

866 
	}
}

876 
	$nå_ýp_¬—_wr™–
(
nå_ýp_¬—
 *
¬—
,

877 
off£t
, 
u32
 
v®ue
)

879 
u8
 
tmp
[4];

880 
n
;

882 
	`put_uÇligÃd_Ë32
(
v®ue
, 
tmp
);

883 
n
 = 
	`nå_ýp_¬—_wr™e
(
¬—
, 
off£t
, &
tmp
, (tmp));

885  
n
 =ð(
tmp
è? 0 :‚ < 0 ?‚ : -
EIO
;

886 
	}
}

896 
	$nå_ýp_¬—_»adq
(
nå_ýp_¬—
 *
¬—
,

897 
off£t
, 
u64
 *
v®ue
)

899 
u8
 
tmp
[8];

900 
n
;

902 
n
 = 
	`nå_ýp_¬—_»ad
(
¬—
, 
off£t
, &
tmp
, (tmp));

903 ià(
n
 !ð(
tmp
))

904  
n
 < 0 ?‚ : -
EIO
;

906 *
v®ue
 = 
	`g‘_uÇligÃd_Ë64
(
tmp
);

908 
	}
}

918 
	$nå_ýp_¬—_wr™eq
(
nå_ýp_¬—
 *
¬—
,

919 
off£t
, 
u64
 
v®ue
)

921 
u8
 
tmp
[8];

922 
n
;

924 
	`put_uÇligÃd_Ë64
(
v®ue
, 
tmp
);

925 
n
 = 
	`nå_ýp_¬—_wr™e
(
¬—
, 
off£t
, &
tmp
, (tmp));

927  
n
 =ð(
tmp
è? 0 :‚ < 0 ?‚ : -
EIO
;

928 
	}
}

941 
	$nå_ýp_¬—_fžl
(
nå_ýp_¬—
 *
¬—
,

942 
off£t
, 
u32
 
v®ue
, 
size_t
 
Ëngth
)

944 
u8
 
tmp
[4];

945 
size_t
 
i
;

946 
k
;

948 
	`put_uÇligÃd_Ë32
(
v®ue
, 
tmp
);

950 ià(
off£t
 % (
tmp
è|| 
Ëngth
 % (tmp))

951  -
EINVAL
;

953 
i
 = 0; i < 
Ëngth
; i +ð(
tmp
)) {

954 
k
 = 
	`nå_ýp_¬—_wr™e
(
¬—
, 
off£t
 + 
i
, &
tmp
, (tmp));

955 ià(
k
 < 0)

956  
k
;

959  
i
;

960 
	}
}

967 
	$nå_ýp_¬—_ÿche_add
(
nå_ýp
 *
ýp
, 
size_t
 
size
)

969 
nå_ýp_¬—_ÿche
 *
ÿche
;

970 
nå_ýp_¬—
 *
¬—
;

975 
¬—
 = 
	`nå_ýp_¬—_®loc
(
ýp
, 
	`NFP_CPP_ID
(7, 
NFP_CPP_ACTION_RW
, 0),

976 0, 
size
);

977 ià(!
¬—
)

978  -
ENOMEM
;

980 
ÿche
 = 
	`kz®loc
((*ÿche), 
GFP_KERNEL
);

981 ià(!
ÿche
)

982  -
ENOMEM
;

984 
ÿche
->
id
 = 0;

985 
ÿche
->
addr
 = 0;

986 
ÿche
->
size
 = size;

987 
ÿche
->
¬—
 =‡rea;

988 
	`mu‹x_lock
(&
ýp
->
¬—_ÿche_mu‹x
);

989 
	`li¡_add_ž
(&
ÿche
->
’Œy
, &
ýp
->
¬—_ÿche_li¡
);

990 
	`mu‹x_uÆock
(&
ýp
->
¬—_ÿche_mu‹x
);

993 
	}
}

995 
nå_ýp_¬—_ÿche
 *

996 
	$¬—_ÿche_g‘
(
nå_ýp
 *
ýp
, 
u32
 
id
,

997 
u64
 
addr
, *
off£t
, 
size_t
 
Ëngth
)

999 
nå_ýp_¬—_ÿche
 *
ÿche
;

1000 
”r
;

1006 ià(
Ëngth
 =ð0 || 
id
 == 0)

1007  
NULL
;

1010 
”r
 = 
	`nå_rg‘_ýp
(
id
, 
addr
, &id, &addr, 
ýp
->
imb_ÿt_bË
);

1011 ià(
”r
 < 0)

1012  
NULL
;

1014 
	`mu‹x_lock
(&
ýp
->
¬—_ÿche_mu‹x
);

1016 ià(
	`li¡_em±y
(&
ýp
->
¬—_ÿche_li¡
)) {

1017 
	`mu‹x_uÆock
(&
ýp
->
¬—_ÿche_mu‹x
);

1018  
NULL
;

1021 
addr
 +ð*
off£t
;

1024 
	`li¡_fÜ_—ch_’Œy
(
ÿche
, &
ýp
->
¬—_ÿche_li¡
, 
’Œy
) {

1025 ià(
id
 =ð
ÿche
->id &&

1026 
addr
 >ð
ÿche
->addr &&

1027 
addr
 + 
Ëngth
 <ð
ÿche
->add¸+ cache->
size
)

1028 
ex™
;

1032 
ÿche
 = 
	`li¡_’Œy
(
ýp
->
¬—_ÿche_li¡
.
´ev
,

1033 
nå_ýp_¬—_ÿche
, 
’Œy
);

1036 ià(
	`round_down
(
addr
 + 
Ëngth
 - 1, 
ÿche
->
size
) !=

1037 
	`round_down
(
addr
, 
ÿche
->
size
)) {

1038 
	`mu‹x_uÆock
(&
ýp
->
¬—_ÿche_mu‹x
);

1039  
NULL
;

1043 ià(
ÿche
->
id
) {

1044 
	`nå_ýp_¬—_»Ëa£
(
ÿche
->
¬—
);

1045 
ÿche
->
id
 = 0;

1046 
ÿche
->
addr
 = 0;

1050 
ÿche
->
id
 = id;

1051 
ÿche
->
addr
 =‡dd¸& ~(
u64
)(ÿche->
size
 - 1);

1054 ià(
ýp
->
Ý
->
¬—_š™
) {

1055 
”r
 = 
ýp
->
Ý
->
	`¬—_š™
(
ÿche
->
¬—
,

1056 
id
, 
ÿche
->
addr
, cache->
size
);

1057 ià(
”r
 < 0) {

1058 
	`mu‹x_uÆock
(&
ýp
->
¬—_ÿche_mu‹x
);

1059  
NULL
;

1064 
”r
 = 
	`nå_ýp_¬—_acquœe
(
ÿche
->
¬—
);

1065 ià(
”r
 < 0) {

1066 
	`mu‹x_uÆock
(&
ýp
->
¬—_ÿche_mu‹x
);

1067  
NULL
;

1070 
ex™
:

1072 *
off£t
 = 
addr
 - 
ÿche
->addr;

1073  
ÿche
;

1074 
	}
}

1077 
	$¬—_ÿche_put
(
nå_ýp
 *
ýp
, 
nå_ýp_¬—_ÿche
 *
ÿche
)

1079 ià(!
ÿche
)

1083 
	`li¡_d–
(&
ÿche
->
’Œy
);

1084 
	`li¡_add
(&
ÿche
->
’Œy
, &
ýp
->
¬—_ÿche_li¡
);

1086 
	`mu‹x_uÆock
(&
ýp
->
¬—_ÿche_mu‹x
);

1087 
	}
}

1089 
	$__nå_ýp_»ad
(
nå_ýp
 *
ýp
, 
u32
 
de¡š©iÚ
,

1090 
add»ss
, *
k”Ãl_vaddr
,

1091 
size_t
 
Ëngth
)

1093 
nå_ýp_¬—_ÿche
 *
ÿche
;

1094 
nå_ýp_¬—
 *
¬—
;

1095 
off£t
 = 0;

1096 
”r
;

1098 
ÿche
 = 
	`¬—_ÿche_g‘
(
ýp
, 
de¡š©iÚ
, 
add»ss
, &
off£t
, 
Ëngth
);

1099 ià(
ÿche
) {

1100 
¬—
 = 
ÿche
->area;

1102 
¬—
 = 
	`nå_ýp_¬—_®loc
(
ýp
, 
de¡š©iÚ
, 
add»ss
, 
Ëngth
);

1103 ià(!
¬—
)

1104  -
ENOMEM
;

1106 
”r
 = 
	`nå_ýp_¬—_acquœe
(
¬—
);

1107 ià(
”r
) {

1108 
	`nå_ýp_¬—_ä“
(
¬—
);

1109  
”r
;

1113 
”r
 = 
	`nå_ýp_¬—_»ad
(
¬—
, 
off£t
, 
k”Ãl_vaddr
, 
Ëngth
);

1115 ià(
ÿche
)

1116 
	`¬—_ÿche_put
(
ýp
, 
ÿche
);

1118 
	`nå_ýp_¬—_»Ëa£_ä“
(
¬—
);

1120  
”r
;

1121 
	}
}

1133 
	$nå_ýp_»ad
(
nå_ýp
 *
ýp
, 
u32
 
de¡š©iÚ
,

1134 
add»ss
, *
k”Ãl_vaddr
,

1135 
size_t
 
Ëngth
)

1137 
size_t
 
n
, 
off£t
;

1138 
»t
;

1140 
off£t
 = 0; off£ˆ< 
Ëngth
; off£ˆ+ð
n
) {

1141 
r_addr
 = 
add»ss
 + 
off£t
;

1144 
n
 = 
	`mš_t
(
size_t
, 
Ëngth
 - 
off£t
,

1145 
	`ALIGN
(
r_addr
 + 1, 
NFP_CPP_SAFE_AREA_SIZE
) -„_addr);

1147 
»t
 = 
	`__nå_ýp_»ad
(
ýp
, 
de¡š©iÚ
, 
add»ss
 + 
off£t
,

1148 
k”Ãl_vaddr
 + 
off£t
, 
n
);

1149 ià(
»t
 < 0)

1150  
»t
;

1151 ià(
»t
 !ð
n
)

1152  
off£t
 + 
n
;

1155  
Ëngth
;

1156 
	}
}

1158 
	$__nå_ýp_wr™e
(
nå_ýp
 *
ýp
, 
u32
 
de¡š©iÚ
,

1159 
add»ss
,

1160 cÚ¡ *
k”Ãl_vaddr
, 
size_t
 
Ëngth
)

1162 
nå_ýp_¬—_ÿche
 *
ÿche
;

1163 
nå_ýp_¬—
 *
¬—
;

1164 
off£t
 = 0;

1165 
”r
;

1167 
ÿche
 = 
	`¬—_ÿche_g‘
(
ýp
, 
de¡š©iÚ
, 
add»ss
, &
off£t
, 
Ëngth
);

1168 ià(
ÿche
) {

1169 
¬—
 = 
ÿche
->area;

1171 
¬—
 = 
	`nå_ýp_¬—_®loc
(
ýp
, 
de¡š©iÚ
, 
add»ss
, 
Ëngth
);

1172 ià(!
¬—
)

1173  -
ENOMEM
;

1175 
”r
 = 
	`nå_ýp_¬—_acquœe
(
¬—
);

1176 ià(
”r
) {

1177 
	`nå_ýp_¬—_ä“
(
¬—
);

1178  
”r
;

1182 
”r
 = 
	`nå_ýp_¬—_wr™e
(
¬—
, 
off£t
, 
k”Ãl_vaddr
, 
Ëngth
);

1184 ià(
ÿche
)

1185 
	`¬—_ÿche_put
(
ýp
, 
ÿche
);

1187 
	`nå_ýp_¬—_»Ëa£_ä“
(
¬—
);

1189  
”r
;

1190 
	}
}

1202 
	$nå_ýp_wr™e
(
nå_ýp
 *
ýp
, 
u32
 
de¡š©iÚ
,

1203 
add»ss
,

1204 cÚ¡ *
k”Ãl_vaddr
, 
size_t
 
Ëngth
)

1206 
size_t
 
n
, 
off£t
;

1207 
»t
;

1209 
off£t
 = 0; off£ˆ< 
Ëngth
; off£ˆ+ð
n
) {

1210 
w_addr
 = 
add»ss
 + 
off£t
;

1213 
n
 = 
	`mš_t
(
size_t
, 
Ëngth
 - 
off£t
,

1214 
	`ALIGN
(
w_addr
 + 1, 
NFP_CPP_SAFE_AREA_SIZE
) - w_addr);

1216 
»t
 = 
	`__nå_ýp_wr™e
(
ýp
, 
de¡š©iÚ
, 
add»ss
 + 
off£t
,

1217 
k”Ãl_vaddr
 + 
off£t
, 
n
);

1218 ià(
»t
 < 0)

1219  
»t
;

1220 ià(
»t
 !ð
n
)

1221  
off£t
 + 
n
;

1224  
Ëngth
;

1225 
	}
}

1228 
u32
 
	$nå_xpb_to_ýp
(
nå_ýp
 *
ýp
, 
u32
 *
xpb_addr
)

1230 
i¦ªd
;

1231 
u32
 
xpb
;

1233 
xpb
 = 
	`NFP_CPP_ID
(14, 
NFP_CPP_ACTION_RW
, 0);

1237 
i¦ªd
 = (*
xpb_addr
 >> 24) & 0x3f;

1238 ià(!
i¦ªd
)

1239  
xpb
;

1241 ià(
i¦ªd
 != 1) {

1242 *
xpb_addr
 |= 1 << 30;

1243  
xpb
;

1247 *
xpb_addr
 &= ~0x7f000000;

1248 ià(*
xpb_addr
 < 0x60000) {

1249 *
xpb_addr
 |= 1 << 30;

1252 ià(
	`NFP_CPP_INTERFACE_TYPE_of
(
	`nå_ýp_š‹rçû
(
ýp
))

1253 !ð
NFP_CPP_INTERFACE_TYPE_ARM
)

1254 *
xpb_addr
 |= 1 << 24;

1257  
xpb
;

1258 
	}
}

1268 
	$nå_xpb_»adl
(
nå_ýp
 *
ýp
, 
u32
 
xpb_addr
, u32 *
v®ue
)

1270 
u32
 
ýp_de¡
 = 
	`nå_xpb_to_ýp
(
ýp
, &
xpb_addr
);

1272  
	`nå_ýp_»adl
(
ýp
, 
ýp_de¡
, 
xpb_addr
, 
v®ue
);

1273 
	}
}

1283 
	$nå_xpb_wr™–
(
nå_ýp
 *
ýp
, 
u32
 
xpb_addr
, u32 
v®ue
)

1285 
u32
 
ýp_de¡
 = 
	`nå_xpb_to_ýp
(
ýp
, &
xpb_addr
);

1287  
	`nå_ýp_wr™–
(
ýp
, 
ýp_de¡
, 
xpb_addr
, 
v®ue
);

1288 
	}
}

1301 
	$nå_xpb_wr™–m
(
nå_ýp
 *
ýp
, 
u32
 
xpb_tgt
,

1302 
u32
 
mask
, u32 
v®ue
)

1304 
”r
;

1305 
u32
 
tmp
;

1307 
”r
 = 
	`nå_xpb_»adl
(
ýp
, 
xpb_tgt
, &
tmp
);

1308 ià(
”r
 < 0)

1309  
”r
;

1311 
tmp
 &ð~
mask
;

1312 
tmp
 |ð
mask
 & 
v®ue
;

1313  
	`nå_xpb_wr™–
(
ýp
, 
xpb_tgt
, 
tmp
);

1314 
	}
}

1322 *
	$nå_ýp_ev’t_´iv
(
nå_ýp_ev’t
 *
ýp_ev’t
)

1324  &
ýp_ev’t
[1];

1325 
	}
}

1333 
nå_ýp
 *
	$nå_ýp_ev’t_ýp
(
nå_ýp_ev’t
 *
ýp_ev’t
)

1335  
ýp_ev’t
->
ýp
;

1336 
	}
}

1347 
nå_ýp_ev’t
 *

1348 
	$nå_ýp_ev’t_®loc
(
nå_ýp
 *
ýp
, 
u32
 
m©ch
, u32 
mask
, 
ty³
)

1350 
nå_ýp_ev’t
 *
ev’t
;

1351 
”r
;

1353 ià(!
ýp
->
Ý
->
ev’t_acquœe
)

1354  
	`ERR_PTR
(-
ENODEV
);

1356 ià(
ty³
 < 0)

1357 
ty³
 = 0;

1359 ià(
ty³
 > 7)

1360  
	`ERR_PTR
(-
EINVAL
);

1362 
ev’t
 = 
	`kz®loc
((*ev’tè+ 
ýp
->
Ý
->
ev’t_´iv_size
,

1363 
GFP_KERNEL
);

1364 ià(!
ev’t
)

1365  
	`ERR_PTR
(-
ENOMEM
);

1367 
ev’t
->
ýp
 = 
	`nå_ýp_g‘
(cpp);

1369 
	`¥š_lock_š™
(&
ev’t
->
ÿÎback
.
lock
);

1371 
”r
 = 
ýp
->
Ý
->
	`ev’t_acquœe
(
ev’t
, 
mask
, 
m©ch
, 
ty³
);

1372 ià(
”r
 < 0) {

1373 
	`nå_ýp_put
(
ýp
);

1374 
	`kä“
(
ev’t
);

1375  
	`ERR_PTR
(
”r
);

1378  
ev’t
;

1379 
	}
}

1389 
nå_ýp_ev’t_as_ÿÎback
(
nå_ýp_ev’t
 *
ev’t
,

1390 (*
func
)(*), *
´iv
)

1392 
æags
;

1394 
	`¥š_lock_œq§ve
(&
ev’t
->
ÿÎback
.
lock
, 
æags
);

1395 
ev’t
->
ÿÎback
.
func
 = func;

1396 
ev’t
->
ÿÎback
.
´iv
 =…riv;

1397 
	`¥š_uÆock_œq»¡Üe
(&
ev’t
->
ÿÎback
.
lock
, 
æags
);

1400 
	}
}

1409 
	$nå_ýp_ev’t_ÿÎback
(
nå_ýp_ev’t
 *
ev’t
)

1411 (*
func
)(*);

1412 
æags
;

1413 *
´iv
;

1415 ià(!
ev’t
)

1419 
	`¥š_lock_œq§ve
(&
ev’t
->
ÿÎback
.
lock
, 
æags
);

1420 
func
 = 
ev’t
->
ÿÎback
.func;

1421 
´iv
 = 
ev’t
->
ÿÎback
.priv;

1422 
	`¥š_uÆock_œq»¡Üe
(&
ev’t
->
ÿÎback
.
lock
, 
æags
);

1424 ià(
func
)

1425 
	`func
(
´iv
);

1426 
	}
}

1432 
	$nå_ýp_ev’t_ä“
(
nå_ýp_ev’t
 *
ev’t
)

1434 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ev’t_ýp
(
ev’t
);

1436 ià(
ýp
->
Ý
->
ev’t_»Ëa£
)

1437 
ýp
->
Ý
->
	`ev’t_»Ëa£
(
ev’t
);

1439 
	`nå_ýp_put
(
ýp
);

1440 
	`kä“
(
ev’t
);

1441 
	}
}

1444 
lock_þass_key
 
	gnå_ýp_»sourû_lock_key
;

1446 
	$nå_ýp_dev_»Ëa£
(
deviû
 *
dev
)

1449 
	}
}

1462 
nå_ýp
 *

1463 
	$nå_ýp_äom_Ý”©iÚs
(cÚ¡ 
nå_ýp_Ý”©iÚs
 *
Ýs
,

1464 
deviû
 *
·»Á
, *
´iv
)

1466 cÚ¡ 
u32
 
¬m
 = 
	`NFP_CPP_ID
(
NFP_CPP_TARGET_ARM
, 
NFP_CPP_ACTION_RW
, 0);

1467 
nå_ýp
 *
ýp
;

1468 
id
, 
ifc
, 
”r
;

1469 
u32
 
mask
[2];

1470 
u32
 
xpbaddr
;

1471 
size_t
 
tgt
;

1473 
id
 = 
	`nå_ýp_id_acquœe
();

1474 ià(
id
 < 0) {

1475 
	`dev_”r
(
·»Á
, "Out of NFP CPP API slots.\n");

1476  
	`ERR_PTR
(
id
);

1479 
ýp
 = 
	`kz®loc
((*ýp), 
GFP_KERNEL
);

1480 ià(!
ýp
) {

1481 
”r
 = -
ENOMEM
;

1482 
”r_m®loc
;

1485 
ýp
->
id
 = id;

1486 
ýp
->
Ý
 = 
Ýs
;

1487 
ýp
->
´iv
 =…riv;

1489 
ifc
 = 
Ýs
->
	`g‘_š‹rçû
(
·»Á
);

1490 ià(
ifc
 < 0) {

1491 
”r
 = 
ifc
;

1492 
”r_ä“_ýp
;

1494 
ýp
->
š‹rçû
 = 
ifc
;

1495 ià(
Ýs
->
»ad_£rŸl
) {

1496 
”r
 = 
Ýs
->
	`»ad_£rŸl
(
·»Á
, 
ýp
->
£rŸl
);

1497 ià(
”r
)

1498 
”r_ä“_ýp
;

1501 
	`k»f_š™
(&
ýp
->
k»f
);

1502 
	`rwlock_š™
(&
ýp
->
»sourû_lock
);

1503 
	`š™_wa™queue_h—d
(&
ýp
->
wa™q
);

1504 
	`lockd•_£t_þass
(&
ýp
->
»sourû_lock
, &
nå_ýp_»sourû_lock_key
);

1505 
	`INIT_LIST_HEAD
(&
ýp
->
»sourû_li¡
);

1506 
	`INIT_LIST_HEAD
(&
ýp
->
¬—_ÿche_li¡
);

1507 
	`mu‹x_š™
(&
ýp
->
¬—_ÿche_mu‹x
);

1508 
ýp
->
dev
.
š™_Çme
 = "cpp";

1509 
ýp
->
dev
.
·»Á
 =…arent;

1510 
ýp
->
dev
.
»Ëa£
 = 
nå_ýp_dev_»Ëa£
;

1511 
”r
 = 
	`deviû_»gi¡”
(&
ýp
->
dev
);

1512 ià(
”r
 < 0) {

1513 
	`put_deviû
(&
ýp
->
dev
);

1514 
”r_ä“_ýp
;

1517 
	`dev_£t_drvd©a
(&
ýp
->
dev
, cpp);

1519 
”r
 = 
	`deviû_ü—‹_fže
(&
ýp
->
dev
, &
dev_©Œ_¬—
);

1520 ià(
”r
 < 0)

1521 
”r_©Œ
;

1526 ià(
ýp
->
Ý
->
š™
) {

1527 
”r
 = 
ýp
->
Ý
->
	`š™
(cpp);

1528 ià(
”r
 < 0) {

1529 
	`dev_”r
(
·»Á
,

1531 
”r_out
;

1535 
”r
 = 
	`nå_ýp_mod–_autod‘eù
(
ýp
, &ýp->
mod–
);

1536 ià(
”r
 < 0) {

1537 
	`dev_”r
(
·»Á
, "NFP model detection failed\n");

1538 
”r_out
;

1541 
tgt
 = 0;gˆ< 
	`ARRAY_SIZE
(
ýp
->
imb_ÿt_bË
);gt++) {

1543 
xpbaddr
 = 0x000a0000 + (
tgt
 * 4);

1544 
”r
 = 
	`nå_xpb_»adl
(
ýp
, 
xpbaddr
,

1545 &
ýp
->
imb_ÿt_bË
[
tgt
]);

1546 ià(
”r
 < 0) {

1547 
	`dev_”r
(
·»Á
,

1549 
”r_out
;

1553 
	`nå_ýp_»adl
(
ýp
, 
¬m
, 
NFP_ARM_GCSR
 + 
NFP_ARM_GCSR_SOFTMODEL2
,

1554 &
mask
[0]);

1555 
	`nå_ýp_»adl
(
ýp
, 
¬m
, 
NFP_ARM_GCSR
 + 
NFP_ARM_GCSR_SOFTMODEL3
,

1556 &
mask
[1]);

1558 
ýp
->
i¦ªd_mask
 = (
u64
)
mask
[1] << 32 | mask[0];

1560 
”r
 = 
	`nå_ýp_£t_mu_loÿl™y_lsb
(
ýp
);

1561 ià(
”r
 < 0) {

1562 
	`dev_”r
(
·»Á
, "Can't calculate MU†ocality bit offset\n");

1563 
”r_out
;

1566 
	`wr™e_lock
(&
nå_ýp_li¡_lock
);

1567 
	`li¡_add_ž
(&
ýp
->
li¡
, &
nå_ýp_li¡
);

1568 
	`wr™e_uÆock
(&
nå_ýp_li¡_lock
);

1570 
	`dev_šfo
(
ýp
->
dev
.
·»Á
, "Model: 0x%08x, SN: %pM, Ifc: 0x%04x\n",

1571 
	`nå_ýp_mod–
(
ýp
), cµ->
£rŸl
, 
	`nå_ýp_š‹rçû
(cpp));

1573  
ýp
;

1575 
”r_out
:

1576 
	`deviû_»move_fže
(&
ýp
->
dev
, &
dev_©Œ_¬—
);

1577 
”r_©Œ
:

1578 
	`deviû_uÄegi¡”
(&
ýp
->
dev
);

1579 
”r_ä“_ýp
:

1580 
	`kä“
(
ýp
);

1581 
”r_m®loc
:

1582 
	`nå_ýp_id_»Ëa£
(
id
);

1583  
	`ERR_PTR
(
”r
);

1584 
	}
}

1592 *
	$nå_ýp_´iv
(
nå_ýp
 *
ýp
)

1594  
ýp
->
´iv
;

1595 
	}
}

1603 
deviû
 *
	$nå_ýp_deviû
(
nå_ýp
 *
ýp
)

1605  &
ýp
->
dev
;

1606 
	}
}

1614 
u64
 
	$nå_ýp_i¦ªd_mask
(
nå_ýp
 *
ýp
)

1616  
ýp
->
i¦ªd_mask
;

1617 
	}
}

1619 
	#NFP_EXPL_OP
(
func
, 
ex¶
, 
¬gs
...) \

1621 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ex¶ic™_ýp
(
ex¶
); \

1622 
”r
 = -
ENODEV
; \

1624 ià(
ýp
->
Ý
->
func
) { \

1625 
	`nå_ýp_g‘
(
ýp
); \

1626 
”r
 = 
ýp
->
Ý
->
	`func
(
ex¶
, ##
¬gs
); \

1627 
	`nå_ýp_put
(
ýp
); \

1629 
”r
; \

1630 })

	)

1632 
	#NFP_EXPL_OP_NR
(
func
, 
ex¶
, 
¬gs
...) \

1634 
nå_ýp
 *
ýp
 = 
	`nå_ýp_ex¶ic™_ýp
(
ex¶
); \

1636 ià(
ýp
->
Ý
->
func
) { \

1637 
	`nå_ýp_g‘
(
ýp
); \

1638 
ýp
->
Ý
->
	`func
(
ex¶
, ##
¬gs
); \

1639 
	`nå_ýp_put
(
ýp
); \

1641 })

	)

1652 
nå_ýp_ex¶ic™
 *
	$nå_ýp_ex¶ic™_acquœe
(
nå_ýp
 *
ýp
)

1654 
nå_ýp_ex¶ic™
 *
ex¶
;

1655 
”r
;

1657 
ex¶
 = 
	`kz®loc
((*ex¶è+ 
ýp
->
Ý
->
ex¶ic™_´iv_size
, 
GFP_KERNEL
);

1658 ià(!
ex¶
)

1659  
NULL
;

1661 
ex¶
->
ýp
 = cpp;

1662 
”r
 = 
	`NFP_EXPL_OP
(
ex¶ic™_acquœe
, 
ex¶
);

1663 ià(
”r
 < 0) {

1664 
	`kä“
(
ex¶
);

1665  
NULL
;

1668  
ex¶
;

1669 
	}
}

1680 
	$nå_ýp_ex¶ic™_£t_rg‘
(
nå_ýp_ex¶ic™
 *
ex¶
,

1681 
u32
 
ýp_id
, 
u8
 
Ën
, u8 
mask
)

1683 
ex¶
->
cmd
.
ýp_id
 = cpp_id;

1684 
ex¶
->
cmd
.
Ën
 =†en;

1685 
ex¶
->
cmd
.
by‹_mask
 = 
mask
;

1688 
	}
}

1698 
	$nå_ýp_ex¶ic™_£t_d©a
(
nå_ýp_ex¶ic™
 *
ex¶
,

1699 
u8
 
d©a_ma¡”
, 
u16
 
d©a_»f
)

1701 
ex¶
->
cmd
.
d©a_ma¡”
 = data_master;

1702 
ex¶
->
cmd
.
d©a_»f
 = data_ref;

1705 
	}
}

1715 
	$nå_ýp_ex¶ic™_£t_sigÇl
(
nå_ýp_ex¶ic™
 *
ex¶
,

1716 
u8
 
sigÇl_ma¡”
, u8 
sigÇl_»f
)

1718 
ex¶
->
cmd
.
sigÇl_ma¡”
 = signal_master;

1719 
ex¶
->
cmd
.
sigÇl_»f
 = signal_ref;

1722 
	}
}

1735 
	$nå_ýp_ex¶ic™_£t_po¡ed
(
nå_ýp_ex¶ic™
 *
ex¶
, 
po¡ed
,

1736 
u8
 
siga
,

1737 
nå_ýp_ex¶ic™_sigÇl_mode
 
siga_mode
,

1738 
u8
 
sigb
,

1739 
nå_ýp_ex¶ic™_sigÇl_mode
 
sigb_mode
)

1741 
ex¶
->
cmd
.
po¡ed
 =…osted;

1742 
ex¶
->
cmd
.
siga
 = siga;

1743 
ex¶
->
cmd
.
sigb
 = sigb;

1744 
ex¶
->
cmd
.
siga_mode
 = siga_mode;

1745 
ex¶
->
cmd
.
sigb_mode
 = sigb_mode;

1748 
	}
}

1763 
	$nå_ýp_ex¶ic™_put
(
nå_ýp_ex¶ic™
 *
ex¶
,

1764 cÚ¡ *
buff
, 
size_t
 
Ën
)

1766  
	`NFP_EXPL_OP
(
ex¶ic™_put
, 
ex¶
, 
buff
, 
Ën
);

1767 
	}
}

1779 
	$nå_ýp_ex¶ic™_do
(
nå_ýp_ex¶ic™
 *
ex¶
, 
u64
 
add»ss
)

1781  
	`NFP_EXPL_OP
(
ex¶ic™_do
, 
ex¶
, &ex¶->
cmd
, 
add»ss
);

1782 
	}
}

1800 
	$nå_ýp_ex¶ic™_g‘
(
nå_ýp_ex¶ic™
 *
ex¶
, *
buff
, 
size_t
 
Ën
)

1802  
	`NFP_EXPL_OP
(
ex¶ic™_g‘
, 
ex¶
, 
buff
, 
Ën
);

1803 
	}
}

1810 
	$nå_ýp_ex¶ic™_»Ëa£
(
nå_ýp_ex¶ic™
 *
ex¶
)

1812 
	`NFP_EXPL_OP_NR
(
ex¶ic™_»Ëa£
, 
ex¶
);

1813 
	`kä“
(
ex¶
);

1814 
	}
}

1822 
nå_ýp
 *
	$nå_ýp_ex¶ic™_ýp
(
nå_ýp_ex¶ic™
 *
ýp_ex¶ic™
)

1824  
ýp_ex¶ic™
->
ýp
;

1825 
	}
}

1833 *
	$nå_ýp_ex¶ic™_´iv
(
nå_ýp_ex¶ic™
 *
ýp_ex¶ic™
)

1835  &
ýp_ex¶ic™
[1];

1836 
	}
}

1843 
	$nå_ýpcÜe_š™
()

1845 #iâdeà
PCI_DEVICE_ID_NETRONOME_NFP4000


1846 ià(!
ignÜe_quœks
) {

1847 
	`´_”r
("Error:his kernel does‚ot have quirk_nfp6000\n");

1848 
	`´_”r
("Please contact support@netronome.com for more information\n");

1849  -
EINVAL
;

1851 
	`´_w¬n
("Warning:his kernel does‚ot have quirk_nfp6000\n");

1852 
	`´_w¬n
("Please contact support@netronome.com for more information\n");

1854 
	`´_šfo
("Netronome NFP CPP API\n");

1856 
	`mu‹x_š™
(&
nå_ýp_id_lock
);

1857 
	`INIT_LIST_HEAD
(&
nå_ýp_li¡
);

1858 
	`rwlock_š™
(&
nå_ýp_li¡_lock
);

1861 
	}
}

1866 
	$nå_ýpcÜe_ex™
()

1868 
	`BUG_ON
(!
	`li¡_em±y
(&
nå_ýp_li¡
));

1869 
	}
}

	@src/nfpcore/nfp_cpplib.c

11 
	~"kcom·t.h
"

13 
	~<asm/uÇligÃd.h
>

14 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

15 
	~<lšux/b™f›ld.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/moduË.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/sched.h
>

23 
	~"nå_ýp.h
"

24 
	~"nå6000/nå6000.h
"

25 
	~"nå6000/nå_xpb.h
"

28 
	#NFP_PL_DEVICE_PART_NFP6000
 0x6200

	)

29 
	#NFP_PL_DEVICE_ID
 0x00000004

	)

30 
	#NFP_PL_DEVICE_ID_MASK
 
	`GENMASK
(7, 0)

	)

31 
	#NFP_PL_DEVICE_PART_MASK
 
	`GENMASK
(31, 16)

	)

32 
	#NFP_PL_DEVICE_MODEL_MASK
 \

33 (
NFP_PL_DEVICE_PART_MASK
 | 
NFP_PL_DEVICE_ID_MASK
)

	)

35 
	#NFP6000_ARM_GCSR_SOFTMODEL0
 0x00400144

	)

46 
	$nå_ýp_»adl
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

47 
add»ss
, 
u32
 *
v®ue
)

49 
u8
 
tmp
[4];

50 
n
;

52 
n
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
add»ss
, 
tmp
, (tmp));

53 ià(
n
 !ð(
tmp
))

54  
n
 < 0 ?‚ : -
EIO
;

56 *
v®ue
 = 
	`g‘_uÇligÃd_Ë32
(
tmp
);

58 
	}
}

69 
	$nå_ýp_wr™–
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

70 
add»ss
, 
u32
 
v®ue
)

72 
u8
 
tmp
[4];

73 
n
;

75 
	`put_uÇligÃd_Ë32
(
v®ue
, 
tmp
);

76 
n
 = 
	`nå_ýp_wr™e
(
ýp
, 
ýp_id
, 
add»ss
, 
tmp
, (tmp));

78  
n
 =ð(
tmp
è? 0 :‚ < 0 ?‚ : -
EIO
;

79 
	}
}

90 
	$nå_ýp_»adq
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

91 
add»ss
, 
u64
 *
v®ue
)

93 
u8
 
tmp
[8];

94 
n
;

96 
n
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
add»ss
, 
tmp
, (tmp));

97 ià(
n
 !ð(
tmp
))

98  
n
 < 0 ?‚ : -
EIO
;

100 *
v®ue
 = 
	`g‘_uÇligÃd_Ë64
(
tmp
);

102 
	}
}

113 
	$nå_ýp_wr™eq
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

114 
add»ss
, 
u64
 
v®ue
)

116 
u8
 
tmp
[8];

117 
n
;

119 
	`put_uÇligÃd_Ë64
(
v®ue
, 
tmp
);

120 
n
 = 
	`nå_ýp_wr™e
(
ýp
, 
ýp_id
, 
add»ss
, 
tmp
, (tmp));

122  
n
 =ð(
tmp
è? 0 :‚ < 0 ?‚ : -
EIO
;

123 
	}
}

128 
	$nå_ýp_mod–_autod‘eù
(
nå_ýp
 *
ýp
, 
u32
 *
mod–
)

130 cÚ¡ 
u32
 
¬m_id
 = 
	`NFP_CPP_ID
(
NFP_CPP_TARGET_ARM
, 0, 0);

131 
u32
 
dev_id
;

132 
”r
;

134 
”r
 = 
	`nå_xpb_»adl
(
ýp
, 
	`NFP_XPB_DEVICE
(1, 1, 16è+ 
NFP_PL_DEVICE_ID
,

135 &
dev_id
);

136 ià(
”r
 < 0)

137  
”r
;

139 *
mod–
 = 
dev_id
 & 
NFP_PL_DEVICE_MODEL_MASK
;

142 ià(
	`FIELD_GET
(
NFP_PL_DEVICE_PART_MASK
, 
dev_id
) ==

143 
NFP_PL_DEVICE_PART_NFP6000
) {

144 
”r
 = 
	`nå_ýp_»adl
(
ýp
, 
¬m_id
, 
NFP6000_ARM_GCSR_SOFTMODEL0
,

145 
mod–
);

146 ià(
”r
 < 0)

147  
”r
;

150 *
mod–
 &= ~0xff;

151 *
mod–
 |ð(
dev_id
 & 
NFP_PL_DEVICE_ID_MASK
) - 0x10;

155 
	}
}

157 
u8
 
	$nå_by‹mask
(
width
, 
u64
 
addr
)

159 ià(
width
 == 8)

161 ià(
width
 == 4)

162  0x0à<< (
addr
 & 4);

163 ià(
width
 == 2)

164  0x03 << (
addr
 & 6);

165 ià(
width
 == 1)

166  0x01 << (
addr
 & 7);

169 
	}
}

171 
	$nå_ýp_ex¶ic™_»ad
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
,

172 
u64
 
addr
, *
buff
, 
size_t
 
Ën
, 
width_»ad
)

174 
nå_ýp_ex¶ic™
 *
ex¶
;

175 *
tmp
 = 
buff
;

176 
”r
, 
i
, 
šü
;

177 
u8
 
by‹_mask
;

179 ià(
Ën
 & (
width_»ad
 - 1))

180  -
EINVAL
;

182 
ex¶
 = 
	`nå_ýp_ex¶ic™_acquœe
(
ýp
);

183 ià(!
ex¶
)

184  -
EBUSY
;

186 
šü
 = 
	`mš_t
(, 16 * 
width_»ad
, 128);

187 
šü
 = 
	`mš_t
(, inü, 
Ën
);

190 ià(
	`NFP_CPP_ID_ACTION_of
(
ýp_id
è=ð
NFP_CPP_ACTION_RW
)

191 
ýp_id
 = 
	`NFP_CPP_ID
(
	`NFP_CPP_ID_TARGET_of
(cpp_id), 0,

192 
	`NFP_CPP_ID_TOKEN_of
(
ýp_id
));

194 
by‹_mask
 = 
	`nå_by‹mask
(
width_»ad
, 
addr
);

196 
	`nå_ýp_ex¶ic™_£t_rg‘
(
ex¶
, 
ýp_id
,

197 
šü
 / 
width_»ad
 - 1, 
by‹_mask
);

198 
	`nå_ýp_ex¶ic™_£t_po¡ed
(
ex¶
, 1, 0, 
NFP_SIGNAL_PUSH
,

199 0, 
NFP_SIGNAL_NONE
);

201 
i
 = 0; i < 
Ën
; i +ð
šü
, 
addr
 +ðšü, 
tmp
 += incr) {

202 ià(
i
 + 
šü
 > 
Ën
) {

203 
šü
 = 
Ën
 - 
i
;

204 
	`nå_ýp_ex¶ic™_£t_rg‘
(
ex¶
, 
ýp_id
,

205 
šü
 / 
width_»ad
 - 1,

209 
”r
 = 
	`nå_ýp_ex¶ic™_do
(
ex¶
, 
addr
);

210 ià(
”r
 < 0)

211 
ex™_»Ëa£
;

213 
”r
 = 
	`nå_ýp_ex¶ic™_g‘
(
ex¶
, 
tmp
, 
šü
);

214 ià(
”r
 < 0)

215 
ex™_»Ëa£
;

217 
”r
 = 
Ën
;

218 
ex™_»Ëa£
:

219 
	`nå_ýp_ex¶ic™_»Ëa£
(
ex¶
);

221  
”r
;

222 
	}
}

224 
	$nå_ýp_ex¶ic™_wr™e
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
, 
u64
 
addr
,

225 cÚ¡ *
buff
, 
size_t
 
Ën
, 
width_wr™e
)

227 
nå_ýp_ex¶ic™
 *
ex¶
;

228 cÚ¡ *
tmp
 = 
buff
;

229 
”r
, 
i
, 
šü
;

230 
u8
 
by‹_mask
;

232 ià(
Ën
 & (
width_wr™e
 - 1))

233  -
EINVAL
;

235 
ex¶
 = 
	`nå_ýp_ex¶ic™_acquœe
(
ýp
);

236 ià(!
ex¶
)

237  -
EBUSY
;

239 
šü
 = 
	`mš_t
(, 16 * 
width_wr™e
, 128);

240 
šü
 = 
	`mš_t
(, inü, 
Ën
);

243 ià(
	`NFP_CPP_ID_ACTION_of
(
ýp_id
è=ð
NFP_CPP_ACTION_RW
)

244 
ýp_id
 = 
	`NFP_CPP_ID
(
	`NFP_CPP_ID_TARGET_of
(cpp_id), 1,

245 
	`NFP_CPP_ID_TOKEN_of
(
ýp_id
));

247 
by‹_mask
 = 
	`nå_by‹mask
(
width_wr™e
, 
addr
);

249 
	`nå_ýp_ex¶ic™_£t_rg‘
(
ex¶
, 
ýp_id
,

250 
šü
 / 
width_wr™e
 - 1, 
by‹_mask
);

251 
	`nå_ýp_ex¶ic™_£t_po¡ed
(
ex¶
, 1, 0, 
NFP_SIGNAL_PULL
,

252 0, 
NFP_SIGNAL_NONE
);

254 
i
 = 0; i < 
Ën
; i +ð
šü
, 
addr
 +ðšü, 
tmp
 += incr) {

255 ià(
i
 + 
šü
 > 
Ën
) {

256 
šü
 = 
Ën
 - 
i
;

257 
	`nå_ýp_ex¶ic™_£t_rg‘
(
ex¶
, 
ýp_id
,

258 
šü
 / 
width_wr™e
 - 1,

262 
”r
 = 
	`nå_ýp_ex¶ic™_put
(
ex¶
, 
tmp
, 
šü
);

263 ià(
”r
 < 0)

264 
ex™_»Ëa£
;

266 
”r
 = 
	`nå_ýp_ex¶ic™_do
(
ex¶
, 
addr
);

267 ià(
”r
 < 0)

268 
ex™_»Ëa£
;

270 
”r
 = 
Ën
;

271 
ex™_»Ëa£
:

272 
	`nå_ýp_ex¶ic™_»Ëa£
(
ex¶
);

274  
”r
;

275 
	}
}

291 
u8
 
__iomem
 *

292 
	$nå_ýp_m­_¬—
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
, 
u32
 
ýp_id
, 
u64
 
addr
,

293 
size
, 
nå_ýp_¬—
 **
¬—
)

295 
u8
 
__iomem
 *
»s
;

297 *
¬—
 = 
	`nå_ýp_¬—_®loc_acquœe
(
ýp
, 
Çme
, 
ýp_id
, 
addr
, 
size
);

298 ià(!*
¬—
)

299 
”r_eio
;

301 
»s
 = 
	`nå_ýp_¬—_iomem
(*
¬—
);

302 ià(!
»s
)

303 
”r_»Ëa£_ä“
;

305  
»s
;

307 
”r_»Ëa£_ä“
:

308 
	`nå_ýp_¬—_»Ëa£_ä“
(*
¬—
);

309 
”r_eio
:

310  (
u8
 
__iomem
 *)
	`ERR_PTR
(-
EIO
);

311 
	}
}

	@src/nfpcore/nfp_dev.c

4 
	~"kcom·t.h
"

6 
	~<lšux/dma-m­pšg.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/sizes.h
>

10 
	~"nå_dev.h
"

12 cÚ¡ 
nå_dev_šfo
 
	gnå_dev_šfo
[
NFP_DEV_CNT
] = {

13 [
NFP_DEV_NFP3800
] = {

14 .
dma_mask
 = 
DMA_BIT_MASK
(48),

15 .
	gqc_idx_mask
 = 
GENMASK
(8, 0),

16 .
	gqc_addr_off£t
 = 0x400000,

17 .
	gmš_qc_size
 = 512,

18 .
	gmax_qc_size
 = 
SZ_64K
,

20 .
	gch_Çmes
 = "NFP3800",

21 .
	gpc›_cfg_expb¬_off£t
 = 0x0a00,

22 .
	gpc›_ex¶_off£t
 = 0xd000,

23 .
	gqc_¬—_sz
 = 0x100000,

25 [
NFP_DEV_NFP3800_VF
] = {

26 .
dma_mask
 = 
DMA_BIT_MASK
(48),

27 .
	gqc_idx_mask
 = 
GENMASK
(8, 0),

28 .
	gqc_addr_off£t
 = 0,

29 .
	gmš_qc_size
 = 512,

30 .
	gmax_qc_size
 = 
SZ_64K
,

32 [
NFP_DEV_NFP6000
] = {

33 .
dma_mask
 = 
DMA_BIT_MASK
(40),

34 .
	gqc_idx_mask
 = 
GENMASK
(7, 0),

35 .
	gqc_addr_off£t
 = 0x80000,

36 .
	gmš_qc_size
 = 256,

37 .
	gmax_qc_size
 = 
SZ_256K
,

39 .
	gch_Çmes
 = "NFP4000/NFP5000/NFP6000",

40 .
	gpc›_cfg_expb¬_off£t
 = 0x0400,

41 .
	gpc›_ex¶_off£t
 = 0x1000,

42 .
	gqc_¬—_sz
 = 0x80000,

44 [
NFP_DEV_NFP6000_VF
] = {

45 .
dma_mask
 = 
DMA_BIT_MASK
(40),

46 .
	gqc_idx_mask
 = 
GENMASK
(7, 0),

47 .
	gqc_addr_off£t
 = 0,

48 .
	gmš_qc_size
 = 256,

49 .
	gmax_qc_size
 = 
SZ_256K
,

	@src/nfpcore/nfp_dev.h

4 #iâdeà
_NFP_DEV_H_


5 
	#_NFP_DEV_H_


	)

7 
	~<lšux/ty³s.h
>

9 
	enå_dev_id
 {

10 
	mNFP_DEV_NFP3800
,

11 
	mNFP_DEV_NFP3800_VF
,

12 
	mNFP_DEV_NFP6000
,

13 
	mNFP_DEV_NFP6000_VF
,

14 
	mNFP_DEV_CNT
,

17 
	snå_dev_šfo
 {

19 
u64
 
	mdma_mask
;

20 
u32
 
	mqc_idx_mask
;

21 
u32
 
	mqc_addr_off£t
;

22 
u32
 
	mmš_qc_size
;

23 
u32
 
	mmax_qc_size
;

26 cÚ¡ *
	mch_Çmes
;

27 
u32
 
	mpc›_cfg_expb¬_off£t
;

28 
u32
 
	mpc›_ex¶_off£t
;

29 
u32
 
	mqc_¬—_sz
;

32 cÚ¡ 
nå_dev_šfo
‚å_dev_šfo[
NFP_DEV_CNT
];

	@src/nfpcore/nfp_em_manager.c

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/io.h
>

11 
	~<lšux/š‹¼u±.h
>

13 
	~"nå.h
"

14 
	~"nå_ýp.h
"

16 
	#NFP_EM_FILTERS
 32

	)

18 
	#NFP_EM_FILTER
(
_f
è(0x0 + (0x20 * ((_fè& 0x1f)))

	)

20 
	#NFP_EM_FILTER_STATUS
 0x0000

	)

21 
	#NFP_EM_FILTER_ACK
 0x0010

	)

23 
	#NFP_EM_FILTER_FLAGS
 0x0004

	)

24 
	#NFP_EM_FILTER_FLAGS_PENDING_STATUS
 (0x1 << 1)

	)

25 
	#NFP_EM_FILTER_FLAGS_STATUS
 (0x1)

	)

27 
	#NFP_EM_FILTER_MASK
 0x0008

	)

28 
	#NFP_EM_FILTER_MASK_TYPE
(
_x
è(((_xè& 0x7è<< 24)

	)

29 
	#NFP_EM_FILTER_MASK_TYPE_of
(
_x
è(((_xè>> 24è& 0x7)

	)

30 
	#NFP_EM_FILTER_MASK_TYPE_COUNT32
 (0)

	)

31 
	#NFP_EM_FILTER_MASK_TYPE_COUNT16
 (1)

	)

32 
	#NFP_EM_FILTER_MASK_TYPE_MASK32
 (2)

	)

33 
	#NFP_EM_FILTER_MASK_TYPE_MASK16
 (3)

	)

34 
	#NFP_EM_FILTER_MASK_TYPE_FIRSTEV
 (4)

	)

35 
	#NFP_EM_FILTER_MASK_TYPE_LASTEV
 (5)

	)

36 
	#NFP_EM_FILTER_MASK_EVENT
(
_x
è((_xè& 0xfffff)

	)

37 
	#NFP_EM_FILTER_MASK_EVENT_of
(
_x
è((_xè& 0xfffff)

	)

39 
	#NFP_EM_FILTER_MATCH
 0x000c

	)

40 
	#NFP_EM_FILTER_MATCH_EVENT
(
_x
è((_xè& 0xfffff)

	)

41 
	#NFP_EM_FILTER_MATCH_EVENT_of
(
_x
è((_xè& 0xfffff)

	)

43 
	#NFP_EM_ALL_STATUS
 0x0400

	)

45 
	#NFP_EM_ALL_PENDING
 0x0404

	)

47 
	#NFP_EM_CONFIG
 0x0408

	)

49 
	#NFP_EVENT_TYPE_COUNT32
 0x0000

	)

50 
	#NFP_EVENT_COUNT32_CNT32_of
(
_x
è(_x)

	)

52 
	#NFP_EVENT_TYPE_COUNT16
 0x0001

	)

53 
	#NFP_EVENT_COUNT16_TMOUT
(
_x
è(((_xè& 0x7è<< 29)

	)

54 
	#NFP_EVENT_COUNT16_TMOUT_of
(
_x
è(((_xè>> 29è& 0x7)

	)

55 
	#NFP_EVENT_COUNT16_UPCNT_of
(
_x
è(((_xè>> 23è& 0x3f)

	)

56 
	#NFP_EVENT_COUNT16_OVERRIDE
(
_x
è(((_xè& 0x3fè<< 16)

	)

57 
	#NFP_EVENT_COUNT16_OVERRIDE_of
(
_x
è(((_xè>> 16è& 0x3f)

	)

58 
	#NFP_EVENT_COUNT16_CNT16_of
(
_x
è((_xè& 0xffff)

	)

60 
	#NFP_EVENT_TYPE_MASK32
 0x0002

	)

62 
	#NFP_EVENT_TYPE_MASK16
 0x0003

	)

63 
	#NFP_EVENT_MASK16_TMOUT
(
_x
è(((_xè& 0x7è<< 29)

	)

64 
	#NFP_EVENT_MASK16_TMOUT_of
(
_x
è(((_xè>> 29è& 0x7)

	)

65 
	#NFP_EVENT_MASK16_UPCNT_of
(
_x
è(((_xè>> 23è& 0x3f)

	)

66 
	#NFP_EVENT_MASK16_OVERRIDE
(
_x
è(((_xè& 0x7è<< 20)

	)

67 
	#NFP_EVENT_MASK16_OVERRIDE_of
(
_x
è(((_xè>> 20è& 0x7)

	)

68 
	#NFP_EVENT_MASK16_CNT4
(
_x
è(((_xè& 0xfè<< 16)

	)

69 
	#NFP_EVENT_MASK16_CNT4_of
(
_x
è(((_xè>> 16è& 0xf)

	)

70 
	#NFP_EVENT_MASK16_MASK16_of
(
_x
è((_xè& 0xffff)

	)

72 
	#NFP_EVENT_TYPE_FIRSTEV
 0x0004

	)

73 
	#NFP_EVENT_TYPE_LASTEV
 0x0005

	)

74 
	#NFP_EVENT_EVENT_TMOUT
(
_x
è(((_xè& 0x7è<< 29)

	)

75 
	#NFP_EVENT_EVENT_TMOUT_of
(
_x
è(((_xè>> 29è& 0x7)

	)

76 
	#NFP_EVENT_EVENT_UPCNT_of
(
_x
è(((_xè>> 23è& 0x3f)

	)

77 
	#NFP_EVENT_EVENT_CNT2
(
_x
è(((_xè& 0x3è<< 20)

	)

78 
	#NFP_EVENT_EVENT_CNT2_of
(
_x
è(((_xè>> 20è& 0x3)

	)

79 
	#NFP_EVENT_EVENT_EVENT_of
(
_x
è((_xè& 0xfffff)

	)

81 
	#NFP_EM_EVENT_TYPE_STATUS_FLAGS
 4

	)

83 
	#NFP_EM_EVENT_PIN_ID
(
pš
) \

84 (((((
pš
è>> 3è& 0x7è<< 8è| (1 << (Õšè& 0x7)))

	)

85 
	#NFP_EM_EVENT_MATCH
(
sourû
, 
pš_id
, 
ev’t_ty³
) \

86 (((
sourû
è<< 16è| ((
pš_id
è<< 4è| (
ev’t_ty³
))

	)

87 
	#NFP_EM_EVENT_TYPE_of
(
ev
è(Óvè& 0xf)

	)

88 
	#NFP_EM_EVENT_SOURCE_of
(
ev
è((Óvè>> 4è& 0xfff)

	)

89 
	#NFP_EM_EVENT_PROVIDER_of
(
ev
è((Óvè>> 16è& 0xf)

	)

91 
	snå_em_mªag”
 {

92 
¥šlock_t
 
	mlock
;

93 
	mœq
;

94 
__iomem
 *
	mem
;

96 
u32
 
	mm©ch
;

97 
u32
 
	mmask
;

98 
	mty³
;

99 
nå_ýp_ev’t
 *
	mev’t
;

100 } 
	mfž‹r
[32];

103 
œq»tuº_t
 
	$nå_em_mªag”_œq
(
œq
, *
´iv
)

105 
nå_em_mªag”
 *
evm
 = 
´iv
;

106 
i
;

107 
u32
 
tmp
;

109 
tmp
 = 
	`»adl
(
evm
->
em
 + 
NFP_EM_ALL_STATUS
);

111 
i
 = 0; i < 
	`ARRAY_SIZE
(
evm
->
fž‹r
); i++) {

112 ià(
tmp
 & (1 << 
i
)) {

113 
	`nå_ýp_ev’t_ÿÎback
(
evm
->
fž‹r
[
i
].
ev’t
);

114 
	`»adl
(
evm
->
em
 + 
	`NFP_EM_FILTER
(
i
è+ 
NFP_EM_FILTER_ACK
);

118  (
tmp
è? 
IRQ_HANDLED
 : 
IRQ_NONE
;

119 
	}
}

128 
nå_em_mªag”
 *
	$nå_em_mªag”_ü—‹
(
__iomem
 *
em
, 
œq
)

130 
”r
;

131 
nå_em_mªag”
 *
evm
;

133 
evm
 = 
	`km®loc
((*evm), 
GFP_KERNEL
);

134 ià(!
evm
)

135  
	`ERR_PTR
(-
ENOMEM
);

137 
evm
->
œq
 = irq;

138 
evm
->
em
 =ƒm;

140 
	`¥š_lock_š™
(&
evm
->
lock
);

142 
”r
 = 
	`»que¡_œq
(
evm
->
œq
, 
nå_em_mªag”_œq
,

143 
IRQF_SHARED
, "nå_em", 
evm
);

144 ià(
”r
 < 0) {

145 
	`kä“
(
evm
);

146  
	`ERR_PTR
(
”r
);

149  
evm
;

150 
	}
}

156 
	$nå_em_mªag”_de¡roy
(
nå_em_mªag”
 *
evm
)

158 ià(!
evm
)

161 
	`ä“_œq
(
evm
->
œq
,ƒvm);

162 
	`kä“
(
evm
);

163 
	}
}

175 
	$nå_em_mªag”_acquœe
(
nå_em_mªag”
 *
evm
,

176 
nå_ýp_ev’t
 *
ev’t
,

177 
u32
 
m©ch
, u32 
mask
, u32 
ty³
)

179 
æags
;

180 
i
;

182 ià(!
evm
)

183  -
EINVAL
;

185 
	`¥š_lock_œq§ve
(&
evm
->
lock
, 
æags
);

186 
i
 = 0; i < 
	`ARRAY_SIZE
(
evm
->
fž‹r
); i++) {

187 ià(!
evm
->
fž‹r
[
i
].
ev’t
) {

188 
evm
->
fž‹r
[
i
].
ev’t
 =ƒvent;

192 
	`¥š_uÆock_œq»¡Üe
(&
evm
->
lock
, 
æags
);

194 ià(
i
 =ð
	`ARRAY_SIZE
(
evm
->
fž‹r
))

195  -
EBUSY
;

197 
evm
->
fž‹r
[
i
].
mask
 = mask;

198 
evm
->
fž‹r
[
i
].
m©ch
 = match;

199 
evm
->
fž‹r
[
i
].
ty³
 =ype;

200 
	`wr™–
(
	`NFP_EM_FILTER_MASK_TYPE
(
ty³
) |

201 
	`NFP_EM_FILTER_MASK_EVENT
(
mask
),

202 
evm
->
em
 + 
	`NFP_EM_FILTER
(
i
è+ 
NFP_EM_FILTER_MASK
);

203 
	`wr™–
(
	`NFP_EM_FILTER_MATCH_EVENT
(
m©ch
),

204 
evm
->
em
 + 
	`NFP_EM_FILTER
(
i
è+ 
NFP_EM_FILTER_MATCH
);

206  
i
;

207 
	}
}

214 
	$nå_em_mªag”_»Ëa£
(
nå_em_mªag”
 *
evm
, 
fž‹r
)

216 
æags
;

218 
	`¥š_lock_œq§ve
(&
evm
->
lock
, 
æags
);

219 
	`wr™–
(
	`NFP_EM_FILTER_MASK_EVENT
(0xffffff),

220 
evm
->
em
 + 
	`NFP_EM_FILTER
(
fž‹r
è+ 
NFP_EM_FILTER_MASK
);

221 
	`wr™–
(
	`NFP_EM_FILTER_MATCH_EVENT
(0xffffff),

222 
evm
->
em
 + 
	`NFP_EM_FILTER
(
fž‹r
è+ 
NFP_EM_FILTER_MATCH
);

223 
	`»adl
(
evm
->
em
 + 
	`NFP_EM_FILTER
(
fž‹r
è+ 
NFP_EM_FILTER_ACK
);

224 
evm
->
fž‹r
[fž‹r].
ev’t
 = 
NULL
;

225 
	`¥š_uÆock_œq»¡Üe
(&
evm
->
lock
, 
æags
);

226 
	}
}

	@src/nfpcore/nfp_export.c

8 
	~<lšux/moduË.h
>

10 
	~"nå.h
"

11 
	~"nå_ýp.h
"

12 
	~"nå_maš.h
"

13 
	~"nå_nbi.h
"

14 
	~"nå_nffw.h
"

15 
	~"nå_n¥.h
"

19 
EXPORT_SYMBOL
(
nå_ýp_äom_deviû_id
);

20 
EXPORT_SYMBOL
(
nå_ýp_deviû_id
);

21 
EXPORT_SYMBOL
(
nå_ýp_ä“
);

22 
EXPORT_SYMBOL
(
nå_ýp_mod–
);

23 
EXPORT_SYMBOL
(
nå_ýp_š‹rçû
);

24 
EXPORT_SYMBOL
(
nå_ýp_£rŸl
);

25 
EXPORT_SYMBOL
(
nå_ýp_¬—_´iv
);

26 
EXPORT_SYMBOL
(
nå_ýp_¬—_ýp
);

27 
EXPORT_SYMBOL
(
nå_ýp_¬—_Çme
);

28 
EXPORT_SYMBOL
(
nå_ýp_¬—_®loc_w™h_Çme
);

29 
EXPORT_SYMBOL
(
nå_ýp_¬—_®loc
);

30 
EXPORT_SYMBOL
(
nå_ýp_¬—_®loc_acquœe
);

31 
EXPORT_SYMBOL
(
nå_ýp_¬—_ä“
);

32 
EXPORT_SYMBOL
(
nå_ýp_¬—_»Ëa£_ä“
);

33 
EXPORT_SYMBOL
(
nå_ýp_¬—_acquœe
);

34 
EXPORT_SYMBOL
(
nå_ýp_¬—_acquœe_nÚblockšg
);

35 
EXPORT_SYMBOL
(
nå_ýp_¬—_»Ëa£
);

36 
EXPORT_SYMBOL
(
nå_ýp_¬—_»ad
);

37 
EXPORT_SYMBOL
(
nå_ýp_¬—_wr™e
);

38 
EXPORT_SYMBOL
(
nå_ýp_¬—_»sourû
);

39 
EXPORT_SYMBOL
(
nå_ýp_¬—_phys
);

40 
EXPORT_SYMBOL
(
nå_ýp_¬—_iomem
);

41 
EXPORT_SYMBOL
(
nå_ýp_¬—_»adl
);

42 
EXPORT_SYMBOL
(
nå_ýp_¬—_wr™–
);

43 
EXPORT_SYMBOL
(
nå_ýp_¬—_»adq
);

44 
EXPORT_SYMBOL
(
nå_ýp_¬—_wr™eq
);

45 
EXPORT_SYMBOL
(
nå_ýp_»adl
);

46 
EXPORT_SYMBOL
(
nå_ýp_wr™–
);

47 
EXPORT_SYMBOL
(
nå_ýp_»adq
);

48 
EXPORT_SYMBOL
(
nå_ýp_wr™eq
);

49 
EXPORT_SYMBOL
(
nå_xpb_»adl
);

50 
EXPORT_SYMBOL
(
nå_xpb_wr™–
);

51 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_´iv
);

52 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_ýp
);

53 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_acquœe
);

54 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_£t_rg‘
);

55 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_£t_d©a
);

56 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_£t_sigÇl
);

57 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_£t_po¡ed
);

58 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_put
);

59 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_do
);

60 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_g‘
);

61 
EXPORT_SYMBOL
(
nå_ýp_ex¶ic™_»Ëa£
);

62 
EXPORT_SYMBOL
(
nå_ýp_ev’t_´iv
);

63 
EXPORT_SYMBOL
(
nå_ýp_ev’t_ýp
);

64 
EXPORT_SYMBOL
(
nå_ýp_ev’t_®loc
);

65 
EXPORT_SYMBOL
(
nå_ýp_ev’t_as_ÿÎback
);

66 
EXPORT_SYMBOL
(
nå_ýp_ev’t_ä“
);

67 
EXPORT_SYMBOL
(
nå_ýp_äom_Ý”©iÚs
);

68 
EXPORT_SYMBOL
(
nå_ýp_deviû
);

69 
EXPORT_SYMBOL
(
nå_ýp_´iv
);

70 
EXPORT_SYMBOL
(
nå_ýp_i¦ªd_mask
);

74 
EXPORT_SYMBOL
(
nå_xpb_wr™–m
);

75 
EXPORT_SYMBOL
(
nå_ýp_»ad
);

76 
EXPORT_SYMBOL
(
nå_ýp_wr™e
);

77 
EXPORT_SYMBOL
(
nå_ýp_¬—_fžl
);

81 
EXPORT_SYMBOL
(
nå_nbi_Ý’
);

82 
EXPORT_SYMBOL
(
nå_nbi_þo£
);

83 
EXPORT_SYMBOL
(
nå_nbi_šdex
);

84 
EXPORT_SYMBOL
(
nå_nbi_mac_acquœe
);

85 
EXPORT_SYMBOL
(
nå_nbi_mac_»Ëa£
);

89 
EXPORT_SYMBOL
(
nå_nbi_mac_‘h_»ad_lšk¡©e
);

90 
EXPORT_SYMBOL
(
nå_nbi_mac_‘h_»ad_mode
);

91 
EXPORT_SYMBOL
(
nå_nbi_mac_‘h_wr™e_mac_addr
);

92 
EXPORT_SYMBOL
(
nå_nbi_mac_‘h_»ad_mac_addr
);

96 
EXPORT_SYMBOL
(
nå_‘h_»ad_pÜts
);

97 
EXPORT_SYMBOL
(
nå_‘h_£t_mod_’abË
);

98 
EXPORT_SYMBOL
(
nå_‘h_£t_cÚfigu»d
);

102 
EXPORT_SYMBOL
(
nå_¹sym_bË_»ad
);

103 
EXPORT_SYMBOL
(
nå_¹sym_couÁ
);

104 
EXPORT_SYMBOL
(
nå_¹sym_g‘
);

105 
EXPORT_SYMBOL
(
nå_¹sym_lookup
);

112 
EXPORT_SYMBOL_GPL
(
nå_¹sym_»ad
);

113 
EXPORT_SYMBOL_GPL
(
nå_¹sym_wr™e
);

117 
EXPORT_SYMBOL_GPL
(
nå_hwšfo_»ad
);

118 
EXPORT_SYMBOL_GPL
(
nå_hwšfo_lookup
);

121 
EXPORT_SYMBOL_GPL
(
nå_»sourû_acquœe
);

122 
EXPORT_SYMBOL_GPL
(
nå_»sourû_»Ëa£
);

123 
EXPORT_SYMBOL_GPL
(
nå_»sourû_ýp_id
);

124 
EXPORT_SYMBOL_GPL
(
nå_»sourû_Çme
);

125 
EXPORT_SYMBOL_GPL
(
nå_»sourû_add»ss
);

126 
EXPORT_SYMBOL_GPL
(
nå_»sourû_size
);

130 
EXPORT_SYMBOL_GPL
(
nå_n¥_Ý’
);

131 
EXPORT_SYMBOL_GPL
(
nå_n¥_þo£
);

132 
EXPORT_SYMBOL_GPL
(
nå_n¥_wa™
);

133 
EXPORT_SYMBOL_GPL
(
nå_n¥_deviû_soá_»£t
);

134 
EXPORT_SYMBOL_GPL
(
nå_n¥_lßd_fw
);

135 
EXPORT_SYMBOL_GPL
(
nå_‘h_cÚfig_¡¬t
);

136 
EXPORT_SYMBOL_GPL
(
nå_‘h_cÚfig_comm™_’d
);

137 
EXPORT_SYMBOL_GPL
(
__nå_‘h_£t_ªeg
);

138 
EXPORT_SYMBOL_GPL
(
__nå_‘h_£t_¥“d
);

139 
EXPORT_SYMBOL_GPL
(
__nå_‘h_£t_¥l™
);

140 
EXPORT_SYMBOL_GPL
(
nå_n¥_hwšfo_lookup
);

143 
EXPORT_SYMBOL_GPL
(
nå_Ãt_dump_ÿlcuÏ‹_size
);

144 
EXPORT_SYMBOL_GPL
(
nå_Ãt_dump_pÝuÏ‹_bufãr
);

147 
EXPORT_SYMBOL_GPL
(
nå_m_Ý’
);

148 
EXPORT_SYMBOL_GPL
(
nå_m_þo£
);

	@src/nfpcore/nfp_hwinfo.c

17 
	~<asm/by‹Üd”.h
>

18 
	~<asm/uÇligÃd.h
>

19 
	~<lšux/d–ay.h
>

20 
	~<lšux/log2.h
>

21 
	~<lšux/k”Ãl.h
>

22 
	~<lšux/moduË.h
>

23 
	~<lšux/¦ab.h
>

25 
	#NFP_SUBSYS
 "nå_hwšfo"

	)

27 
	~"üc32.h
"

28 
	~"nå.h
"

29 
	~"nå_ýp.h
"

30 
	~"nå6000/nå6000.h
"

32 
	#HWINFO_SIZE_MIN
 0x100

	)

34 
	ghwšfo_wa™
 = 20;

35 
moduË_·¿m
(
hwšfo_wa™
, , 
S_IRUGO
);

36 
MODULE_PARM_DESC
(
hwšfo_wa™
,

39 
	ghwšfo_debug
;

40 
moduË_·¿m
(
hwšfo_debug
, , 
S_IRUGO
);

41 
MODULE_PARM_DESC
(
hwšfo_debug
, "Enableo†og hwinfo contents on†oad");

91 
	#NFP_HWINFO_VERSION_1
 ('H' << 24 | 'I' << 16 | 1 << 8 | 0 << 1 | 0)

	)

92 
	#NFP_HWINFO_VERSION_2
 ('H' << 24 | 'I' << 16 | 2 << 8 | 0 << 1 | 0)

	)

93 
	#NFP_HWINFO_VERSION_UPDATING
 
	`BIT
(0)

	)

95 
	snå_hwšfo
 {

96 
u8
 
	m¡¬t
[0];

98 
__Ë32
 
	mv”siÚ
;

99 
__Ë32
 
	msize
;

102 
__Ë32
 
	mlim™
;

103 
__Ë32
 
	m»sv
;

105 
	md©a
[];

108 
boÞ
 
	$nå_hwšfo_is_upd©šg
(
nå_hwšfo
 *
hwšfo
)

110  
	`Ë32_to_ýu
(
hwšfo
->
v”siÚ
è& 
NFP_HWINFO_VERSION_UPDATING
;

111 
	}
}

114 
	$hwšfo_db_w®k
(
nå_ýp
 *
ýp
, 
nå_hwšfo
 *
hwšfo
, 
u32
 
size
)

116 cÚ¡ *
key
, *
v®
, *
’d
 = 
hwšfo
->
d©a
 + 
size
;

118 
key
 = 
hwšfo
->
d©a
; *key && key < 
’d
;

119 
key
 = 
v®
 + 
	`¡¾’
(val) + 1) {

121 
v®
 = 
key
 + 
	`¡¾’
(key) + 1;

122 ià(
v®
 >ð
’d
) {

123 
	`nå_w¬n
(
ýp
, "Bad HWINFO - overflowing key\n");

124  -
EINVAL
;

127 ià(
v®
 + 
	`¡¾’
(v®è+ 1 > 
’d
) {

128 
	`nå_w¬n
(
ýp
, "Bad HWINFO - overflowing value\n");

129  -
EINVAL
;

132 ià(
hwšfo_debug
)

133 
	`nå_šfo
(
ýp
, "%s=%s\n", 
key
, 
v®
);

137 
	}
}

140 
	$hwšfo_db_v®id©e
(
nå_ýp
 *
ýp
, 
nå_hwšfo
 *
db
, 
u32
 
Ën
)

142 
u32
 
size
, 
üc
;

144 
size
 = 
	`Ë32_to_ýu
(
db
->size);

145 ià(
size
 > 
Ën
) {

146 
	`nå_”r
(
ýp
, "UnsuµÜ‹d hwšfØsiz%u > %u\n", 
size
, 
Ën
);

147  -
EINVAL
;

150 
size
 -ð(
u32
);

151 
üc
 = 
	`üc32_posix
(
db
, 
size
);

152 ià(
üc
 !ð
	`g‘_uÇligÃd_Ë32
(
db
->
¡¬t
 + 
size
)) {

153 
	`nå_”r
(
ýp
, "Corrupt hwinfoable (CRC mismatch), calculated 0x%x,ƒxpected 0x%x\n",

154 
üc
, 
	`g‘_uÇligÃd_Ë32
(
db
->
¡¬t
 + 
size
));

156  -
EINVAL
;

159  
	`hwšfo_db_w®k
(
ýp
, 
db
, 
size
);

160 
	}
}

162 
nå_hwšfo
 *

163 
	$hwšfo_Œy_ãtch
(
nå_ýp
 *
ýp
, 
size_t
 *
ýp_size
)

165 
nå_hwšfo
 *
h—d”
;

166 
nå_»sourû
 *
»s
;

167 
u64
 
ýp_addr
;

168 
u32
 
ýp_id
;

169 
”r
;

170 
u8
 *
db
;

172 
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
NFP_RESOURCE_NFP_HWINFO
);

173 ià(!
	`IS_ERR
(
»s
)) {

174 
ýp_id
 = 
	`nå_»sourû_ýp_id
(
»s
);

175 
ýp_addr
 = 
	`nå_»sourû_add»ss
(
»s
);

176 *
ýp_size
 = 
	`nå_»sourû_size
(
»s
);

178 
	`nå_»sourû_»Ëa£
(
»s
);

180 ià(*
ýp_size
 < 
HWINFO_SIZE_MIN
)

181  
NULL
;

182 } ià(
	`PTR_ERR
(
»s
è=ð-
ENOENT
) {

184 
ýp_id
 = 
	`NFP_CPP_ISLAND_ID
(
NFP_CPP_TARGET_MU
,

185 
NFP_CPP_ACTION_RW
, 0, 1);

186 
ýp_addr
 = 0x30000;

187 *
ýp_size
 = 0x0e000;

189  
NULL
;

192 
db
 = 
	`km®loc
(*
ýp_size
 + 1, 
GFP_KERNEL
);

193 ià(!
db
)

194  
NULL
;

196 
”r
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
ýp_addr
, 
db
, *
ýp_size
);

197 ià(
”r
 !ð*
ýp_size
)

198 
ex™_ä“
;

200 
h—d”
 = (*)
db
;

201 ià(
	`nå_hwšfo_is_upd©šg
(
h—d”
))

202 
ex™_ä“
;

204 ià(
	`Ë32_to_ýu
(
h—d”
->
v”siÚ
è!ð
NFP_HWINFO_VERSION_2
) {

205 
	`nå_”r
(
ýp
, "Unknown HWInfo version: 0x%08x\n",

206 
	`Ë32_to_ýu
(
h—d”
->
v”siÚ
));

207 
ex™_ä“
;

211 
db
[*
ýp_size
] = '\0';

213  (*)
db
;

214 
ex™_ä“
:

215 
	`kä“
(
db
);

216  
NULL
;

217 
	}
}

219 
nå_hwšfo
 *
	$hwšfo_ãtch
(
nå_ýp
 *
ýp
, 
size_t
 *
hwdb_size
)

221 cÚ¡ 
wa™_uÁž
 = 
jiff›s
 + 
hwšfo_wa™
 * 
HZ
;

222 
nå_hwšfo
 *
db
;

223 
”r
;

226 cÚ¡ 
¡¬t_time
 = 
jiff›s
;

228 
db
 = 
	`hwšfo_Œy_ãtch
(
ýp
, 
hwdb_size
);

229 ià(
db
)

230  
db
;

232 
”r
 = 
	`m¦“p_š‹¼u±ibË
(100);

233 ià(
”r
 || 
	`time_aá”
(
¡¬t_time
, 
wa™_uÁž
)) {

234 
	`nå_”r
(
ýp
, "NFP‡ccessƒrror\n");

235  
NULL
;

238 
	}
}

240 
nå_hwšfo
 *
	$nå_hwšfo_»ad
(
nå_ýp
 *
ýp
)

242 
nå_hwšfo
 *
db
;

243 
size_t
 
hwdb_size
 = 0;

244 
”r
;

246 
db
 = 
	`hwšfo_ãtch
(
ýp
, &
hwdb_size
);

247 ià(!
db
)

248  
NULL
;

250 
”r
 = 
	`hwšfo_db_v®id©e
(
ýp
, 
db
, 
hwdb_size
);

251 ià(
”r
) {

252 
	`kä“
(
db
);

253  
NULL
;

256  
db
;

257 
	}
}

266 cÚ¡ *
	$nå_hwšfo_lookup
(
nå_hwšfo
 *
hwšfo
, cÚ¡ *
lookup
)

268 cÚ¡ *
key
, *
v®
, *
’d
;

270 ià(!
hwšfo
 || !
lookup
)

271  
NULL
;

273 
’d
 = 
hwšfo
->
d©a
 + 
	`Ë32_to_ýu
(hwšfo->
size
è- (
u32
);

275 
key
 = 
hwšfo
->
d©a
; *key && key < 
’d
;

276 
key
 = 
v®
 + 
	`¡¾’
(val) + 1) {

278 
v®
 = 
key
 + 
	`¡¾’
(key) + 1;

280 ià(
	`¡rcmp
(
key
, 
lookup
) == 0)

281  
v®
;

284  
NULL
;

285 
	}
}

287 *
	$nå_hwšfo_g‘_·cked_¡ršgs
(
nå_hwšfo
 *
hwšfo
)

289  
hwšfo
->
d©a
;

290 
	}
}

292 
u32
 
	$nå_hwšfo_g‘_·cked_¡r_size
(
nå_hwšfo
 *
hwšfo
)

294  
	`Ë32_to_ýu
(
hwšfo
->
size
è- (
u32
);

295 
	}
}

	@src/nfpcore/nfp_mip.c

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/¦ab.h
>

13 
	~"nå.h
"

14 
	~"nå_ýp.h
"

15 
	~"nå_nffw.h
"

17 
	#NFP_MIP_SIGNATURE
 
	`ýu_to_Ë32
(0x0050494dè

	)

18 
	#NFP_MIP_VERSION
 
	`ýu_to_Ë32
(1)

	)

19 
	#NFP_MIP_MAX_OFFSET
 (256 * 1024)

	)

21 
	snå_m
 {

22 
__Ë32
 
	msigÇtu»
;

23 
__Ë32
 
	mm_v”siÚ
;

24 
__Ë32
 
	mm_size
;

25 
__Ë32
 
	mfœ¡_’Œy
;

27 
__Ë32
 
	mv”siÚ
;

28 
__Ë32
 
	mbuždnum
;

29 
__Ë32
 
	mbuždtime
;

30 
__Ë32
 
	mlßdtime
;

32 
__Ë32
 
	msymb_addr
;

33 
__Ë32
 
	msymb_size
;

34 
__Ë32
 
	m¡¹ab_addr
;

35 
__Ë32
 
	m¡¹ab_size
;

37 
	mÇme
[16];

38 
	mtoÞchaš
[32];

43 
	$nå_m_Œy_»ad
(
nå_ýp
 *
ýp
, 
u32
 
ýp_id
, 
u64
 
addr
, 
nå_m
 *
m
)

45 
»t
;

47 
»t
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
addr
, 
m
, (*mip));

48 ià(
»t
 !ð(*
m
)) {

49 
	`nå_”r
(
ýp
, "Failedo„ead MIP data (%d, %zu)\n",

50 
»t
, (*
m
));

51  -
EIO
;

53 ià(
m
->
sigÇtu»
 !ð
NFP_MIP_SIGNATURE
) {

54 
	`nå_w¬n
(
ýp
, "Incorrect MIP signature (0x%08x)\n",

55 
	`Ë32_to_ýu
(
m
->
sigÇtu»
));

56  -
EINVAL
;

58 ià(
m
->
m_v”siÚ
 !ð
NFP_MIP_VERSION
) {

59 
	`nå_w¬n
(
ýp
, "Unsupported MIP version (%d)\n",

60 
	`Ë32_to_ýu
(
m
->
m_v”siÚ
));

61  -
EINVAL
;

65 
	}
}

68 
	$nå_m_»ad_»sourû
(
nå_ýp
 *
ýp
, 
nå_m
 *
m
)

70 
nå_nffw_šfo
 *
nffw_šfo
;

71 
u32
 
ýp_id
;

72 
u64
 
addr
;

73 
”r
;

75 
nffw_šfo
 = 
	`nå_nffw_šfo_Ý’
(
ýp
);

76 ià(
	`IS_ERR
(
nffw_šfo
))

77  
	`PTR_ERR
(
nffw_šfo
);

79 
”r
 = 
	`nå_nffw_šfo_m_fœ¡
(
nffw_šfo
, &
ýp_id
, &
addr
);

80 ià(
”r
)

81 
ex™_þo£_nffw
;

83 
”r
 = 
	`nå_m_Œy_»ad
(
ýp
, 
ýp_id
, 
addr
, 
m
);

84 
ex™_þo£_nffw
:

85 
	`nå_nffw_šfo_þo£
(
nffw_šfo
);

86  
”r
;

87 
	}
}

99 cÚ¡ 
nå_m
 *
	$nå_m_Ý’
(
nå_ýp
 *
ýp
)

101 
nå_m
 *
m
;

102 
”r
;

104 
m
 = 
	`km®loc
((*m), 
GFP_KERNEL
);

105 ià(!
m
)

106  
NULL
;

108 
”r
 = 
	`nå_m_»ad_»sourû
(
ýp
, 
m
);

109 ià(
”r
) {

110 
	`kä“
(
m
);

111  
NULL
;

114 
m
->
Çme
[(mip->name) - 1] = 0;

116  
m
;

117 
	}
}

119 
	$nå_m_þo£
(cÚ¡ 
nå_m
 *
m
)

121 
	`kä“
(
m
);

122 
	}
}

124 cÚ¡ *
	$nå_m_Çme
(cÚ¡ 
nå_m
 *
m
)

126  
m
->
Çme
;

127 
	}
}

135 
	$nå_m_symb
(cÚ¡ 
nå_m
 *
m
, 
u32
 *
addr
, u32 *
size
)

137 *
addr
 = 
	`Ë32_to_ýu
(
m
->
symb_addr
);

138 *
size
 = 
	`Ë32_to_ýu
(
m
->
symb_size
);

139 
	}
}

147 
	$nå_m_¡¹ab
(cÚ¡ 
nå_m
 *
m
, 
u32
 *
addr
, u32 *
size
)

149 *
addr
 = 
	`Ë32_to_ýu
(
m
->
¡¹ab_addr
);

150 *
size
 = 
	`Ë32_to_ýu
(
m
->
¡¹ab_size
);

151 
	}
}

	@src/nfpcore/nfp_mutex.c

4 
	~<lšux/d–ay.h
>

5 
	~<lšux/deviû.h
>

6 
	~<lšux/jiff›s.h
>

7 
	~<lšux/ty³s.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/wa™.h
>

11 
	~"nå_ýp.h
"

12 
	~"nå6000/nå6000.h
"

14 
	snå_ýp_mu‹x
 {

15 
nå_ýp
 *
	mýp
;

16 
	mrg‘
;

17 
u16
 
	md•th
;

18 
	madd»ss
;

19 
u32
 
	mkey
;

22 
u32
 
	$nå_mu‹x_locked
(
u16
 
š‹rçû
)

24  (
u32
)
š‹rçû
 << 16 | 0x000f;

25 
	}
}

27 
u32
 
	$nå_mu‹x_uÆocked
(
u16
 
š‹rçû
)

29  (
u32
)
š‹rçû
 << 16 | 0x0000;

30 
	}
}

32 
u32
 
	$nå_mu‹x_owÃr
(
u32
 
v®
)

34  
v®
 >> 16;

35 
	}
}

37 
boÞ
 
	$nå_mu‹x_is_locked
(
u32
 
v®
)

39  (
v®
 & 0xffff) == 0x000f;

40 
	}
}

42 
boÞ
 
	$nå_mu‹x_is_uÆocked
(
u32
 
v®
)

44  (
v®
 & 0xffff) == 0000;

45 
	}
}

48 
	#NFP_MUTEX_DEPTH_MAX
 0xffff

	)

51 
	$nå_ýp_mu‹x_v®id©e
(
u16
 
š‹rçû
, *
rg‘
, 
add»ss
)

54 ià(
	`NFP_CPP_INTERFACE_TYPE_of
(
š‹rçû
) ==

55 
NFP_CPP_INTERFACE_TYPE_INVALID
)

56  -
EINVAL
;

59 ià(
add»ss
 & 7)

60  -
EINVAL
;

62 ià(*
rg‘
 !ð
NFP_CPP_TARGET_MU
)

63  -
EINVAL
;

66 
	}
}

86 
	$nå_ýp_mu‹x_š™
(
nå_ýp
 *
ýp
,

87 
rg‘
, 
add»ss
, 
u32
 
key
)

89 cÚ¡ 
u32
 
muw
 = 
	`NFP_CPP_ID
(
rg‘
, 4, 0);

90 
u16
 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
ýp
);

91 
”r
;

93 
”r
 = 
	`nå_ýp_mu‹x_v®id©e
(
š‹rçû
, &
rg‘
, 
add»ss
);

94 ià(
”r
)

95  
”r
;

97 
”r
 = 
	`nå_ýp_wr™–
(
ýp
, 
muw
, 
add»ss
 + 4, 
key
);

98 ià(
”r
)

99  
”r
;

101 
”r
 = 
	`nå_ýp_wr™–
(
ýp
, 
muw
, 
add»ss
, 
	`nå_mu‹x_locked
(
š‹rçû
));

102 ià(
”r
)

103  
”r
;

106 
	}
}

123 
nå_ýp_mu‹x
 *
	$nå_ýp_mu‹x_®loc
(
nå_ýp
 *
ýp
, 
rg‘
,

124 
add»ss
, 
u32
 
key
)

126 cÚ¡ 
u32
 
mur
 = 
	`NFP_CPP_ID
(
rg‘
, 3, 0);

127 
u16
 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
ýp
);

128 
nå_ýp_mu‹x
 *
mu‹x
;

129 
”r
;

130 
u32
 
tmp
;

132 
”r
 = 
	`nå_ýp_mu‹x_v®id©e
(
š‹rçû
, &
rg‘
, 
add»ss
);

133 ià(
”r
)

134  
NULL
;

136 
”r
 = 
	`nå_ýp_»adl
(
ýp
, 
mur
, 
add»ss
 + 4, &
tmp
);

137 ià(
”r
 < 0)

138  
NULL
;

140 ià(
tmp
 !ð
key
)

141  
NULL
;

143 
mu‹x
 = 
	`kz®loc
((*mu‹x), 
GFP_KERNEL
);

144 ià(!
mu‹x
)

145  
NULL
;

147 
mu‹x
->
ýp
 = cpp;

148 
mu‹x
->
rg‘
 =arget;

149 
mu‹x
->
add»ss
 =‡ddress;

150 
mu‹x
->
key
 = key;

151 
mu‹x
->
d•th
 = 0;

153  
mu‹x
;

154 
	}
}

160 
	$nå_ýp_mu‹x_ä“
(
nå_ýp_mu‹x
 *
mu‹x
)

162 
	`kä“
(
mu‹x
);

163 
	}
}

171 
	$nå_ýp_mu‹x_lock
(
nå_ýp_mu‹x
 *
mu‹x
)

173 
w¬n_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_FIRST_WARN
 * 
HZ
;

174 
”r_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_ERROR
 * 
HZ
;

175 
timeout_ms
 = 1;

176 
”r
;

184 
”r
 = 
	`nå_ýp_mu‹x_Œylock
(
mu‹x
);

185 ià(
”r
 !ð-
EBUSY
)

188 
”r
 = 
	`m¦“p_š‹¼u±ibË
(
timeout_ms
);

189 ià(
”r
 != 0) {

190 
	`nå_šfo
(
mu‹x
->
ýp
,

192  -
ERESTARTSYS
;

195 ià(
	`time_is_befÜe_eq_jiff›s
(
w¬n_©
)) {

196 
w¬n_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_NEXT_WARN
 * 
HZ
;

197 
	`nå_w¬n
(
mu‹x
->
ýp
,

199 
mu‹x
->
d•th
,

200 
mu‹x
->
rg‘
, mu‹x->
add»ss
, mu‹x->
key
);

202 ià(
	`time_is_befÜe_eq_jiff›s
(
”r_©
)) {

203 
	`nå_”r
(
mu‹x
->
ýp
, "Error: mutex waitimed out\n");

204  -
EBUSY
;

208  
”r
;

209 
	}
}

217 
	$nå_ýp_mu‹x_uÆock
(
nå_ýp_mu‹x
 *
mu‹x
)

219 cÚ¡ 
u32
 
muw
 = 
	`NFP_CPP_ID
(
mu‹x
->
rg‘
, 4, 0);

220 cÚ¡ 
u32
 
mur
 = 
	`NFP_CPP_ID
(
mu‹x
->
rg‘
, 3, 0);

221 
nå_ýp
 *
ýp
 = 
mu‹x
->cpp;

222 
u32
 
key
, 
v®ue
;

223 
u16
 
š‹rçû
;

224 
”r
;

226 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
ýp
);

228 ià(
mu‹x
->
d•th
 > 1) {

229 
mu‹x
->
d•th
--;

233 
”r
 = 
	`nå_ýp_»adl
(
mu‹x
->
ýp
, 
mur
, mu‹x->
add»ss
 + 4, &
key
);

234 ià(
”r
 < 0)

235  
”r
;

237 ià(
key
 !ð
mu‹x
->key)

238  -
EPERM
;

240 
”r
 = 
	`nå_ýp_»adl
(
mu‹x
->
ýp
, 
mur
, mu‹x->
add»ss
, &
v®ue
);

241 ià(
”r
 < 0)

242  
”r
;

244 ià(
v®ue
 !ð
	`nå_mu‹x_locked
(
š‹rçû
))

245  -
EACCES
;

247 
”r
 = 
	`nå_ýp_wr™–
(
ýp
, 
muw
, 
mu‹x
->
add»ss
,

248 
	`nå_mu‹x_uÆocked
(
š‹rçû
));

249 ià(
”r
 < 0)

250  
”r
;

252 
mu‹x
->
d•th
 = 0;

254 
	}
}

262 
	$nå_ýp_mu‹x_Œylock
(
nå_ýp_mu‹x
 *
mu‹x
)

264 cÚ¡ 
u32
 
muw
 = 
	`NFP_CPP_ID
(
mu‹x
->
rg‘
, 4, 0);

265 cÚ¡ 
u32
 
mus
 = 
	`NFP_CPP_ID
(
mu‹x
->
rg‘
, 5, 3);

266 cÚ¡ 
u32
 
mur
 = 
	`NFP_CPP_ID
(
mu‹x
->
rg‘
, 3, 0);

267 
nå_ýp
 *
ýp
 = 
mu‹x
->cpp;

268 
u32
 
key
, 
v®ue
, 
tmp
;

269 
”r
;

271 ià(
mu‹x
->
d•th
 > 0) {

272 ià(
mu‹x
->
d•th
 =ð
NFP_MUTEX_DEPTH_MAX
)

273  -
E2BIG
;

274 
mu‹x
->
d•th
++;

279 
”r
 = 
	`nå_ýp_»adl
(
ýp
, 
mur
, 
mu‹x
->
add»ss
 + 4, &
key
);

280 ià(
”r
 < 0)

281  
”r
;

283 ià(
key
 !ð
mu‹x
->key)

284  -
EPERM
;

290 
v®ue
 = 
	`nå_mu‹x_locked
(
	`nå_ýp_š‹rçû
(
ýp
));

304 
”r
 = 
	`nå_ýp_»adl
(
ýp
, 
mus
, 
mu‹x
->
add»ss
, &
tmp
);

305 ià(
”r
 < 0)

306  
”r
;

309 ià(
	`nå_mu‹x_is_uÆocked
(
tmp
)) {

319 
”r
 = 
	`nå_ýp_wr™–
(
ýp
, 
muw
, 
mu‹x
->
add»ss
, 
v®ue
);

320 ià(
”r
 < 0)

321  
”r
;

323 
mu‹x
->
d•th
 = 1;

327  
	`nå_mu‹x_is_locked
(
tmp
è? -
EBUSY
 : -
EINVAL
;

328 
	}
}

341 
	$nå_ýp_mu‹x_»þaim
(
nå_ýp
 *
ýp
, 
rg‘
,

342 
add»ss
)

344 cÚ¡ 
u32
 
mur
 = 
	`NFP_CPP_ID
(
rg‘
, 3, 0);

345 cÚ¡ 
u32
 
muw
 = 
	`NFP_CPP_ID
(
rg‘
, 4, 0);

346 
u16
 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
ýp
);

347 
”r
;

348 
u32
 
tmp
;

350 
”r
 = 
	`nå_ýp_mu‹x_v®id©e
(
š‹rçû
, &
rg‘
, 
add»ss
);

351 ià(
”r
)

352  
”r
;

355 
”r
 = 
	`nå_ýp_»adl
(
ýp
, 
mur
, 
add»ss
, &
tmp
);

356 ià(
”r
 < 0)

357  
”r
;

359 ià(
	`nå_mu‹x_is_uÆocked
(
tmp
è|| 
	`nå_mu‹x_owÃr
Ñmpè!ð
š‹rçû
)

363 
”r
 = 
	`nå_ýp_wr™–
(
ýp
, 
muw
, 
add»ss
, 
	`nå_mu‹x_uÆocked
(
š‹rçû
));

364 ià(
”r
 < 0)

365  
”r
;

368 
	}
}

	@src/nfpcore/nfp_nbi.c

10 
	~<lšux/jiff›s.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/Ãtdeviû.h
>

13 
	~<lšux/‘htoÞ.h
>

14 
	~<lšux/moduË.h
>

16 
	~"nå.h
"

17 
	~"nå_nffw.h
"

18 
	~"nå_nbi.h
"

20 
	~"nå6000/nå_xpb.h
"

23 
	#TX_FLUSH_FLAG_STOP
 (0UL << 0)

	)

24 
	#TX_FLUSH_FLAG_RUN
 
	`BIT
(0)

	)

25 
	#TX_FLUSH_FLAG_ACK
 
	`BIT
(31)

	)

27 
	#ME_ISLAND_MIN
 1

	)

28 
	#ME_ISLAND_MAX
 62

	)

30 
	snå_nbi_´iv
 {

32 
u32
 
	mýp_id
;

33 
u64
 
	mýp_addr
;

34 } 
	m¡©s
;

38 
boÞ
 
	mhas_sym
;

39 
nå_¹sym
 
	msym
;

40 
	mcouÁ
;

41 } 
	mtx_æush_æags
;

44 
	snå_nbi_dev
 {

45 
nå_ýp
 *
	mýp
;

46 
	mnbi
;

47 
nå_nbi_´iv
 *
	m´iv
;

56 
	snå_nbi_mac_¡©s_¥ec
 {

58 
u64
 
	mpÜts
;

60 
u64
 
	mchªs63_0
;

62 
u64
 
	mchªs127_64
;

64 
u32
 
	mžk
[2];

86 
	snå_nbi_mac_¡©s_¡©e
 {

88 
u32
 
	m³riod
;

90 
u32
 
	m»ady
;

92 
u64
 
	mupd©ed
;

94 
nå_nbi_mac_¡©s_¥ec
 
	maùive
;

96 
nå_nbi_mac_¡©s_¥ec
 
	mþ—r
;

98 
u64
 
	mpÜtþr_couÁ
[24];

100 
u64
 
	mchªþr_couÁ
[128];

102 
u64
 
	mžkþr_couÁ
[2];

108 
	snå_nbi_mac_¡©s
 {

110 
nå_nbi_mac_pÜt¡©s
 
	mpÜt¡©s
[24];

112 
nå_nbi_mac_chª¡©s
 
	mchª¡©s
[128];

114 
nå_nbi_mac_žk¡©s
 
	mžk¡©s
[2];

116 
nå_nbi_mac_¡©s_¡©e
 
	m¡©e
;

119 
	#NFP_NBI_MAC_STATS_MAGIC
 0x«6d730000000000ULL

	)

121 
	snå_nbi_mac_®l¡©s
 {

122 
u64
 
	mmagic
;

123 
nå_nbi_mac_¡©s
 
	mmac
[2];

126 *
	$nå_nbi
(
nå_ýp
 *
ýp
)

128 
nå_¹sym_bË
 *
¹bl
;

129 cÚ¡ 
nå_¹sym
 *
sym
;

130 
nå_nbi_´iv
 *
´iv
;

131 
nå_»sourû
 *
»s
;

132 
i
;

134 
´iv
 = 
	`nå_nbi_ÿche
(
ýp
);

135 ià(
´iv
)

136  
´iv
;

138 
´iv
 = 
	`kz®loc
((*´iv), 
GFP_KERNEL
);

139 ià(!
´iv
)

140  
NULL
;

142 
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
NFP_RESOURCE_MAC_STATISTICS
);

143 ià(
	`IS_ERR
(
»s
)) {

144 
	`kä“
(
´iv
);

145  
NULL
;

148 
´iv
->
¡©s
.
ýp_id
 = 
	`nå_»sourû_ýp_id
(
»s
);

149 
´iv
->
¡©s
.
ýp_addr
 = 
	`nå_»sourû_add»ss
(
»s
);

150 
	`nå_»sourû_»Ëa£
(
»s
);

152 
¹bl
 = 
	`nå_¹sym_bË_»ad
(
ýp
);

154 
i
 = 
ME_ISLAND_MIN
; i <ð
ME_ISLAND_MAX
; i++) {

155 
tx_æags_Çme
[32];

157 
	`¢´štf
(
tx_æags_Çme
, (tx_flags_name),

158 "i%hhu.·u£_pÞl_tx_æush_æags", (
u8
)
i
);

159 
tx_æags_Çme
[(tx_flags_name) - 1] = 0;

161 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
tx_æags_Çme
);

162 ià(
sym
) {

163 
	`nå_šfo
(
ýp
, "NBI: Firmware TX…ause control: %s\n",

164 
tx_æags_Çme
);

165 
´iv
->
tx_æush_æags
.
has_sym
 = 
Œue
;

166 
´iv
->
tx_æush_æags
.
sym
 = *sym;

170 
	`kä“
(
¹bl
);

172 
	`nå_nbi_ÿche_£t
(
ýp
, 
´iv
);

173  
´iv
;

174 
	}
}

183 
nå_nbi_dev
 *
	$nå_nbi_Ý’
(
nå_ýp
 *
ýp
, 
nbi_id
)

185 
nå_nbi_´iv
 *
´iv
;

186 
nå_nbi_dev
 *
nbi
;

188 ià(
nbi_id
 < 0 ||‚bi_id >= 2)

189  
NULL
;

191 
´iv
 = 
	`nå_nbi
(
ýp
);

192 ià(!
´iv
)

193  
NULL
;

195 
nbi
 = 
	`kz®loc
((*nbi), 
GFP_KERNEL
);

196 ià(!
nbi
)

197  
NULL
;

199 
nbi
->
ýp
 = cpp;

200 
nbi
->nb˜ð
nbi_id
;

201 
nbi
->
´iv
 =…riv;

203  
nbi
;

204 
	}
}

210 
	$nå_nbi_þo£
(
nå_nbi_dev
 *
nbi
)

212 
	`kä“
(
nbi
);

213 
	}
}

221 
	$nå_nbi_šdex
(
nå_nbi_dev
 *
nbi
)

223  
nbi
->nbi;

224 
	}
}

234 
	$nå_nbi_mac_¡©s_»ad_pÜt
(
nå_nbi_dev
 *
nbi
, 
pÜt
,

235 
nå_nbi_mac_pÜt¡©s
 *
¡©s
)

237 
nå_nbi_´iv
 *
´iv
 = 
nbi
->priv;

238 
u64
 
magic
 = 0;

240 ià(
pÜt
 < 0 ||…ort >= 24)

241  -
EINVAL
;

244 
	`nå_ýp_»adq
(
nbi
->
ýp
, 
´iv
->
¡©s
.
ýp_id
,…riv->¡©s.
ýp_addr
,

245 &
magic
);

246 ià(
magic
 !ð
NFP_NBI_MAC_STATS_MAGIC
)

247  -
EINVAL
;

249  
	`nå_ýp_»ad
(
nbi
->
ýp
, 
´iv
->
¡©s
.
ýp_id
,…riv->¡©s.
ýp_addr
 +

250 
	`off£tof
(
nå_nbi_mac_®l¡©s
,

251 
mac
[
nbi
->nbi].
pÜt¡©s
[
pÜt
]),

252 
¡©s
, (*stats));

253 
	}
}

263 
	$nå_nbi_mac_¡©s_»ad_chª
(
nå_nbi_dev
 *
nbi
, 
chª
,

264 
nå_nbi_mac_chª¡©s
 *
¡©s
)

266 
nå_nbi_´iv
 *
´iv
 = 
nbi
->priv;

267 
u64
 
magic
 = 0;

269 ià(
chª
 < 0 || chan >= 128)

270  -
EINVAL
;

273 
	`nå_ýp_»adq
(
nbi
->
ýp
, 
´iv
->
¡©s
.
ýp_id
,…riv->¡©s.
ýp_addr
,

274 &
magic
);

275 ià(
magic
 !ð
NFP_NBI_MAC_STATS_MAGIC
)

276  -
EINVAL
;

278  
	`nå_ýp_»ad
(
nbi
->
ýp
, 
´iv
->
¡©s
.
ýp_id
,…riv->¡©s.
ýp_addr
 +

279 
	`off£tof
(
nå_nbi_mac_®l¡©s
,

280 
mac
[
nbi
->nbi].
chª¡©s
[
chª
]),

281 
¡©s
, (*stats));

282 
	}
}

292 
	$nå_nbi_mac_¡©s_»ad_žks
(
nå_nbi_dev
 *
nbi
, 
žk
,

293 
nå_nbi_mac_žk¡©s
 *
¡©s
)

295 
nå_nbi_´iv
 *
´iv
 = 
nbi
->priv;

296 
u64
 
magic
 = 0;

298 ià(
žk
 < 0 || ilk >= 2)

299  -
EINVAL
;

302 
	`nå_ýp_»adq
(
nbi
->
ýp
, 
´iv
->
¡©s
.
ýp_id
,…riv->¡©s.
ýp_addr
,

303 &
magic
);

304 ià(
magic
 !ð
NFP_NBI_MAC_STATS_MAGIC
)

305  -
EINVAL
;

307  
	`nå_ýp_»ad
(
nbi
->
ýp
, 
´iv
->
¡©s
.
ýp_id
,…riv->¡©s.
ýp_addr
 +

308 
	`off£tof
(
nå_nbi_mac_®l¡©s
,

309 
mac
[
nbi
->nbi].
žk¡©s
[
žk
]),

310 
¡©s
, (*stats));

311 
	}
}

313 
	$nå_nbi_tx_æush_æags
(
nå_nbi_dev
 *
nbi
, 
u32
 
æags
)

315 
nå_nbi_´iv
 *
´iv
 = 
nbi
->priv;

316 cÚ¡ 
nå_¹sym
 *
sym
;

317 cÚ¡ 
timeout_ms
 = 100;

318 
u64
 
wa™_uÁž
;

319 
u32
 
tmp
;

320 
”r
;

325 ià(!
´iv
->
tx_æush_æags
.
has_sym
)

327 
sym
 = &
´iv
->
tx_æush_æags
.sym;

330 
”r
 = 
	`nå_¹sym_wr™–
(
nbi
->
ýp
, 
sym
, 4, 
æags
);

331 ià(
”r
 < 0)

332  
”r
;

335 
”r
 = 
	`nå_¹sym_»adl
(
nbi
->
ýp
, 
sym
, 4, &
tmp
);

336 ià(
”r
 < 0)

337  
”r
;

340 
wa™_uÁž
 = 
	`g‘_jiff›s_64
(è+ 
	`m£cs_to_jiff›s
(
timeout_ms
);

343 
”r
 = 
	`nå_¹sym_»adl
(
nbi
->
ýp
, 
sym
, 4, &
tmp
);

344 ià(
”r
 < 0)

345  
”r
;

347 ià(
tmp
 & 
TX_FLUSH_FLAG_ACK
)

349 } 
	`time_aá”64
(
	`g‘_jiff›s_64
(), 
wa™_uÁž
));

358 ià(
æags
 !ð
TX_FLUSH_FLAG_RUN
) {

359 
	`nå_w¬n
(
nbi
->
ýp
, "NBI:…ause_poll_tx_flush_flags was‚ot‡cknowledged‡fter %dms.\n",

360 
timeout_ms
);

364 
	}
}

372 
	$nå_nbi_mac_acquœe
(
nå_nbi_dev
 *
nbi
)

374 
nå_nbi_´iv
 *
´iv
 = 
nbi
->priv;

376 ià(
´iv
->
tx_æush_æags
.
couÁ
 == 0) {

377 
”r
;

379 
”r
 = 
	`nå_nbi_tx_æush_æags
(
nbi
, 
TX_FLUSH_FLAG_STOP
);

380 ià(
”r
 < 0)

381  
”r
;

384  
´iv
->
tx_æush_æags
.
couÁ
++;

385 
	}
}

393 
	$nå_nbi_mac_»Ëa£
(
nå_nbi_dev
 *
nbi
)

395 
nå_nbi_´iv
 *
´iv
 = 
nbi
->priv;

397 ià(
´iv
->
tx_æush_æags
.
couÁ
 < 1) {

398 
	`WARN_ON
(
´iv
->
tx_æush_æags
.
couÁ
 < 1);

402 ià(
´iv
->
tx_æush_æags
.
couÁ
 == 1) {

403 
”r
;

405 
”r
 = 
	`nå_nbi_tx_æush_æags
(
nbi
, 
TX_FLUSH_FLAG_RUN
);

406 ià(
”r
 < 0)

407  
”r
;

410  --
´iv
->
tx_æush_æags
.
couÁ
;

411 
	}
}

425 
	$nå_nbi_mac_»gr
(
nå_nbi_dev
 *
nbi
, 
u32
 
ba£
, u32 
»g
, u32 *
d©a
)

427 
u32
 
r
 = 
	`NFP_XPB_ISLAND
(
nbi
->nb˜+ 8è+ 
ba£
 + 
»g
;

429  
	`nå_xpb_»adl
(
nbi
->
ýp
, 
r
, 
d©a
);

430 
	}
}

454 
	$nå_nbi_mac_»gw
(
nå_nbi_dev
 *
nbi
, 
u32
 
ba£
, u32 
»g
,

455 
u32
 
mask
, u32 
d©a
)

457 
nå_nbi_´iv
 *
´iv
 = 
nbi
->priv;

458 
u32
 
r
 = 
	`NFP_XPB_ISLAND
(
nbi
->nb˜+ 8è+ 
ba£
 + 
»g
;

460 ià(
´iv
->
tx_æush_æags
.
has_sym
 && !´iv->tx_æush_æags.
couÁ
)

461 
	`nå_w¬n
(
nbi
->
ýp
, "NBI:‚bi_nbi_mac_regw() called outside of‚fp_nbi_mac_acquire()/release()\n");

463  
	`nå_xpb_wr™–m
(
nbi
->
ýp
, 
r
, 
mask
, 
d©a
);

464 
	}
}

	@src/nfpcore/nfp_nbi.h

11 #iâdeà
__NFP_NBI_H__


12 
	#__NFP_NBI_H__


	)

14 
	~"nå.h
"

15 
	~"nå_ýp.h
"

22 
	gnå_nbi_dev
;

24 
nå_nbi_dev
 *
nå_nbi_Ý’
(
nå_ýp
 *
ýp
, 
nbi
);

25 
nå_nbi_þo£
(
nå_nbi_dev
 *
nånbidev
);

27 
nå_nbi_šdex
(
nå_nbi_dev
 *
nånbidev
);

29 
nå_nbi_mac_»gr
(
nå_nbi_dev
 *
nbi
, 
u32
 
ba£
, u32 
»g
, u32 *
d©a
);

30 
nå_nbi_mac_»gw
(
nå_nbi_dev
 *
nbi
, 
u32
 
ba£
, u32 
»g
,

31 
u32
 
mask
, u32 
d©a
);

34 
	#NFP_NBI_MAC_STATS_OFFSET
 0xed000

	)

37 
	#NFP_NBI_MAC_STATS_ACCCMD_INIT
 0x00000000

	)

39 
	#NFP_NBI_MAC_STATS_ACCCMD_READ
 0x01000000

	)

41 
	#NFP_NBI_MAC_STATS_ACCCMD_RESET
 0x04000000

	)

43 
	#NFP_NBI_MAC_STATS_ACCCMD_ECCCLR
 0x05000000

	)

45 
	#NFP_NBI_MAC_STATS_ACCTYPE_PKTS
 0x00000000

	)

47 
	#NFP_NBI_MAC_STATS_ACCTYPE_FC
 0x00010000

	)

49 
	#NFP_NBI_MAC_STATS_ACCTYPE_RXCRC
 0x00020000

	)

58 
	snå_nbi_mac_pÜt¡©s
 {

59 
u64
 
	mRxAlignm’tE¼Üs
;

60 
u64
 
	mRxCBFCPau£F¿mesReûived0
;

61 
u64
 
	mRxCBFCPau£F¿mesReûived1
;

62 
u64
 
	mRxCBFCPau£F¿mesReûived2
;

63 
u64
 
	mRxCBFCPau£F¿mesReûived3
;

64 
u64
 
	mRxCBFCPau£F¿mesReûived4
;

65 
u64
 
	mRxCBFCPau£F¿mesReûived5
;

66 
u64
 
	mRxCBFCPau£F¿mesReûived6
;

67 
u64
 
	mRxCBFCPau£F¿mesReûived7
;

68 
u64
 
	mRxF¿meCheckSequ’ûE¼Üs
;

69 
u64
 
	mRxF¿meTooLÚgE¼Üs
;

70 
u64
 
	mRxF¿mesReûivedOK
;

71 
u64
 
	mRxInRªgeL’gthE¼Üs
;

72 
u64
 
	mRxPIfInBrßdCa¡Pkts
;

73 
u64
 
	mRxPIfInE¼Üs
;

74 
u64
 
	mRxPIfInMuÉiCa¡Pkts
;

75 
u64
 
	mRxPIfInUniCa¡Pkts
;

76 
u64
 
	mRxPStsDrÝEv’ts
;

77 
u64
 
	mRxPStsF¿gm’ts
;

78 
u64
 
	mRxPStsJabb”s
;

79 
u64
 
	mRxPStsOv”sizePkts
;

80 
u64
 
	mRxPStsPkts
;

81 
u64
 
	mRxPStsPkts1024to1518où‘s
;

82 
u64
 
	mRxPStsPkts128to255où‘s
;

83 
u64
 
	mRxPStsPkts1519toMaxoù‘s
;

84 
u64
 
	mRxPStsPkts256to511où‘s
;

85 
u64
 
	mRxPStsPkts512to1023où‘s
;

86 
u64
 
	mRxPStsPkts64où‘s
;

87 
u64
 
	mRxPStsPkts65to127où‘s
;

88 
u64
 
	mRxPStsUnd”sizePkts
;

89 
u64
 
	mRxPau£MacCŽF¿mesReûived
;

90 
u64
 
	mRxVÏnReûivedOK
;

91 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d0
;

92 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d1
;

93 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d2
;

94 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d3
;

95 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d4
;

96 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d5
;

97 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d6
;

98 
u64
 
	mTxCBFCPau£F¿mesT¿nsm™‹d7
;

99 
u64
 
	mTxF¿mesT¿nsm™‹dOK
;

100 
u64
 
	mTxPIfOutBrßdCa¡Pkts
;

101 
u64
 
	mTxPIfOutE¼Üs
;

102 
u64
 
	mTxPIfOutMuÉiCa¡Pkts
;

103 
u64
 
	mTxPIfOutUniCa¡Pkts
;

104 
u64
 
	mTxPStsPkts1024to1518où‘s
;

105 
u64
 
	mTxPStsPkts128to255où‘s
;

106 
u64
 
	mTxPStsPkts1518toMAXoù‘s
;

107 
u64
 
	mTxPStsPkts256to511où‘s
;

108 
u64
 
	mTxPStsPkts512to1023où‘s
;

109 
u64
 
	mTxPStsPkts64où‘s
;

110 
u64
 
	mTxPStsPkts65to127où‘s
;

111 
u64
 
	mTxPau£MacCŽF¿mesT¿nsm™‹d
;

112 
u64
 
	mTxVÏnT¿nsm™‹dOK
;

113 
u64
 
	mRxPIfInOù‘s
;

114 
u64
 
	mTxPIfOutOù‘s
;

118 
	snå_nbi_mac_chª¡©s
 {

119 
u64
 
	mRxCIfInE¼Üs
;

120 
u64
 
	mRxCIfInUniCa¡Pkts
;

121 
u64
 
	mRxCIfInMuÉiCa¡Pkts
;

122 
u64
 
	mRxCIfInBrßdCa¡Pkts
;

123 
u64
 
	mRxCStsPkts
;

124 
u64
 
	mRxCStsPkts64où‘s
;

125 
u64
 
	mRxCStsPkts65to127où‘s
;

126 
u64
 
	mRxCStsPkts128to255où‘s
;

127 
u64
 
	mRxCStsPkts256to511où‘s
;

128 
u64
 
	mRxCStsPkts512to1023où‘s
;

129 
u64
 
	mRxCStsPkts1024to1518où‘s
;

130 
u64
 
	mRxCStsPkts1519toMaxoù‘s
;

131 
u64
 
	mRxChªF¿mesReûivedOK
;

132 
u64
 
	mRxChªVÏnReûivedOK
;

133 
u64
 
	mTxCIfOutBrßdCa¡Pkts
;

134 
u64
 
	mTxCIfOutE¼Üs
;

135 
u64
 
	mTxCIfOutUniCa¡Pkts
;

136 
u64
 
	mTxChªF¿mesT¿nsm™‹dOK
;

137 
u64
 
	mTxChªVÏnT¿nsm™‹dOK
;

138 
u64
 
	mTxCIfOutMuÉiCa¡Pkts
;

139 
u64
 
	mRxCIfInOù‘s
;

140 
u64
 
	mRxCStsOù‘s
;

141 
u64
 
	mTxCIfOutOù‘s
;

145 
	snå_nbi_mac_žk¡©s
 {

146 
u64
 
	mLkTxStsFžl
;

147 
u64
 
	mLkTxStsP¬™y
;

148 
u64
 
	mLkTxStsRdP¬™y
;

149 
u64
 
	mLkTxStsWrP¬™y
;

151 
u64
 
	mLkTxStsWrBy‹
;

152 
u64
 
	mLkTxStsWrPkt
;

153 
u64
 
	mLkTxStsWrE¼
;

154 
u64
 
	mLkTxStsRdBy‹
;

155 
u64
 
	mLkTxStsRdPkt
;

156 
u64
 
	mLkTxStsRdE¼
;

158 
u64
 
	mLkRxStsFžl
;

159 
u64
 
	mLkRxStsP¬™y
;

160 
u64
 
	mLkRxStsRdP¬™y
;

161 
u64
 
	mLkRxStsWrP¬™y
;

163 
u64
 
	mLkRxStsWrBy‹
;

164 
u64
 
	mLkRxStsWrPkt
;

165 
u64
 
	mLkRxStsWrE¼
;

166 
u64
 
	mLkRxStsRdBy‹
;

167 
u64
 
	mLkRxStsRdPkt
;

168 
u64
 
	mLkRxStsRdE¼
;

171 
nå_nbi_mac_¡©s_»ad_pÜt
(
nå_nbi_dev
 *
nbi
, 
pÜt
,

172 
nå_nbi_mac_pÜt¡©s
 *
¡©s
);

174 
nå_nbi_mac_¡©s_»ad_chª
(
nå_nbi_dev
 *
nbi
, 
chª
,

175 
nå_nbi_mac_chª¡©s
 *
¡©s
);

177 
nå_nbi_mac_¡©s_»ad_žks
(
nå_nbi_dev
 *
nbi
, 
cÜe
,

178 
nå_nbi_mac_žk¡©s
 *
¡©s
);

182 
	#NFP_NBI_MAC_DQDWRR_TO
 1000

	)

184 
	#NFP_NBI_MAC_CHAN_MAX
 127

	)

185 
	#NFP_NBI_MAC_CHAN_PAUSE_WM_MAX
 2047

	)

186 
	#NFP_NBI_MAC_PORT_HWM_MAX
 2047

	)

187 
	#NFP_NBI_MAC_PORT_HWM_DELTA_MAX
 31

	)

189 
	#NFP_NBI_MAC_ENET_OFF
 0

	)

190 
	#NFP_NBI_MAC_ILK
 1

	)

191 
	#NFP_NBI_MAC_ENET_10M
 2

	)

192 
	#NFP_NBI_MAC_ENET_100M
 3

	)

193 
	#NFP_NBI_MAC_ENET_1G
 4

	)

194 
	#NFP_NBI_MAC_ENET_10G
 5

	)

195 
	#NFP_NBI_MAC_ENET_40G
 6

	)

196 
	#NFP_NBI_MAC_ENET_100G
 7

	)

198 
	#NFP_NBI_MAC_SINGLE_LANE
(
l
è(Ö =ð
NFP_NBI_MAC_ENET_10M
) || \

199 (
l
 =ð
NFP_NBI_MAC_ENET_100M
) || \

200 (
l
 =ð
NFP_NBI_MAC_ENET_1G
) || \

201 (
l
 =ð
NFP_NBI_MAC_ENET_10G
))

	)

203 
	#NFP_NBI_MAC_ONEG_MODE
(
l
è(Ö =ð
NFP_NBI_MAC_ENET_10M
) || \

204 (
l
 =ð
NFP_NBI_MAC_ENET_100M
) || \

205 (
l
 =ð
NFP_NBI_MAC_ENET_1G
))

	)

207 
nå_nbi_mac_acquœe
(
nå_nbi_dev
 *
nbi
);

208 
nå_nbi_mac_»Ëa£
(
nå_nbi_dev
 *
nbi
);

210 
nå_nbi_mac_‘h_»ad_lšk¡©e
(
nå_nbi_dev
 *
nbi
,

211 
cÜe
, 
pÜt
, 
u32
 *
lšk¡©e
);

212 
nå_nbi_mac_‘h_wr™e_mac_addr
(
nå_nbi_dev
 *
nbi
,

213 
cÜe
, 
pÜt
, 
u64
 
hwaddr
);

214 
nå_nbi_mac_‘h_»ad_mac_addr
(
nå_nbi_dev
 *
nbi
, 
cÜe
,

215 
pÜt
, 
u64
 *
waddr
);

216 
nå_nbi_mac_‘h_»ad_mode
(
nå_nbi_dev
 *
nbi
, 
cÜe
, 
pÜt
);

	@src/nfpcore/nfp_nbi_mac_eth.c

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/moduË.h
>

16 
	~"nå.h
"

17 
	~"nå_nbi.h
"

19 
	#NFP_MAC
 0x3a0000

	)

20 
	#NFP_MAC_MACMUXCTRL
 0x0000000c

	)

21 
	#NFP_MAC_MACSERDESEN
 0x00000010

	)

22 
	#NFP_MAC_MACSERDESEN_SERDESENABLE
(
_x
è(((_xè& 0xffffffè<< 0)

	)

23 
	#NFP_MAC_ETH
(
_x
) \

24 (
NFP_MAC
 + 0x40000 + ((
_x
è& 0x1è* 0x20000)

	)

25 
	#NFP_MAC_ETH_MACETHCHPCSSEG_BASERSTATUS1
(
_x
) \

26 (0x00004080 + (0x400 * ((
_x
è& 0xf)))

	)

27 
	#NFP_MAC_ETH_MACETHCHPCSSEG_BASERSTATUS1_BLOCKLOCKED
 \

28 (1 << 0)

	)

29 
	#NFP_MAC_ETH_MACETHCHPCSSEG_BASERSTATUS1_RCVLINKSTATUS
 \

30 (1 << 12)

	)

31 
	#NFP_MAC_ETH_MACETHCHPCSSEG_CTL1
(
_x
) \

32 (0x00004000 + (0x400 * ((
_x
è& 0xf)))

	)

33 
	#NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_LOOPBACK
 \

34 (1 << 14)

	)

35 
	#NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_0
(
_x
) \

36 (((
_x
è& 0xfè<< 2)

	)

37 
	#NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_13
 \

38 (1 << 13)

	)

39 
	#NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_6
 \

40 (1 << 6)

	)

41 
	#NFP_MAC_ETH_MACETHCHPCSSEG_STATUS1
(
_x
) \

42 (0x00004004 + (0x400 * ((
_x
è& 0xf)))

	)

43 
	#NFP_MAC_ETH_MACETHCHPCSSEG_STATUS1_RCVLINKSTATUS
 \

44 (1 << 2)

	)

45 
	#NFP_MAC_ETH_MACETHGLOBAL_ETHACTCTLSEG
 0x00003000

	)

46 
	#NFP_MAC_ETH_MACETHGLOBAL_ETHACTCTLSEG_ETHACTIVATESEGMENT
(
_x
) \

47 (((
_x
è& 0xfffè<< 0)

	)

48 
	#NFP_MAC_ETH_MACETHSEG_ETHCMDCONFIG
(
_x
) \

49 (0x00000008 + (0x400 * ((
_x
è& 0xf)))

	)

50 
	#NFP_MAC_ETH_MACETHSEG_ETHCMDCONFIG_ETHRXENA
 \

51 (1 << 1)

	)

52 
	#NFP_MAC_ETH_MACETHSEG_ETHCMDCONFIG_ETHTXENA
 \

53 (1 << 0)

	)

54 
	#NFP_MAC_ETH_MACETHSEG_ETHMACADDR0
(
_x
) \

55 (0x0000000ø+ (0x400 * ((
_x
è& 0xf)))

	)

56 
	#NFP_MAC_ETH_MACETHSEG_ETHMACADDR0_ETHMACADDR0
(
_x
) \

57 (((
_x
è& 0xffffffffè<< 0)

	)

58 
	#NFP_MAC_ETH_MACETHSEG_ETHMACADDR1
(
_x
) \

59 (0x00000010 + (0x400 * ((
_x
è& 0xf)))

	)

60 
	#NFP_MAC_ETH_MACETHSEG_ETHMACADDR1_ETHMACADDR1
(
_x
) \

61 (((
_x
è& 0xffffè<< 0)

	)

62 
	#NFP_MAC_ETH_ETHSGMIIIFMODE
(
_x
) \

63 (0x00000350 + (0x400 * ((
_x
è& 0xf)))

	)

64 
	#NFP_MAC_ETH_ETHSGMIIIFMODE_ETHSGMIIENA
 \

65 (1 << 0)

	)

66 
	#NFP_MAC_ETH_ETHSGMIIIFMODE_ETHSGMIIPCSENABLE
 \

67 (1 << 5)

	)

68 
	#NFP_MAC_ETH_ETHSGMIIIFMODE_SPEED_100MBPS
 (1)

	)

69 
	#NFP_MAC_ETH_ETHSGMIIIFMODE_SPEED_10MBPS
 (0)

	)

70 
	#NFP_MAC_ETH_ETHSGMIIIFMODE_SPEED_of
(
_x
) \

71 (((
_x
è>> 2è& 0x3)

	)

72 
	#NFP_NBI_MAC_ETHCHPCSCTL1_MODE_MASK
 \

73 (
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_13
 | \

74 
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_6
 | \

75 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_0
(0xf))

	)

76 
	#NFP_NBI_MAC_ETHCHPCSCTL1_MODE_10GE
 \

77 (
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_13
 | \

78 
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_6
 | \

79 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_0
(0))

	)

80 
	#NFP_NBI_MAC_ETHCHPCSCTL1_MODE_10PASSTS
 \

81 (
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_13
 | \

82 
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_6
 | \

83 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_0
(0x1))

	)

84 
	#NFP_NBI_MAC_ETHCHPCSCTL1_MODE_8023AV
 \

85 (
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_13
 | \

86 
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_6
 | \

87 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_0
(0x2))

	)

88 
	#NFP_NBI_MAC_ETHCHPCSCTL1_MODE_40GE
 \

89 (
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_13
 | \

90 
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_6
 | \

91 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_0
(0x3))

	)

92 
	#NFP_NBI_MAC_ETHCHPCSCTL1_MODE_100GE
 \

93 (
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_13
 | \

94 
NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_6
 | \

95 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1_SPEED_0
(0x4))

	)

96 
	#NFP_NBI_MAC_MACMUXCTRL_ERROR
 0x1

	)

97 
	#NFP_NBI_MAC_ETHACTCTLSEG_DISABLED
 0x2

	)

98 
	#NFP_NBI_MAC_ETHCHPCSStus1_RCVLINKSTATUS_DOWN
 0x4

	)

99 
	#NFP_NBI_MAC_ETHCHPCSBASERSTATUS1_RCVLINKSTATUS_DOWN
 0x8

	)

100 
	#NFP_NBI_MAC_ETHCHPCSBASERSTATUS1_BLOCKLOCKED_FALSE
 0x10

	)

101 
	#NFP_NBI_MAC_ETHCMDCONFIG_ETHTXENA_FALSE
 0x20

	)

102 
	#NFP_NBI_MAC_ETHCMDCONFIG_ETHRXENA_FALSE
 0x40

	)

103 
	#NFP_MAC_ILK_LKRXALIGNSTATUS_FALSE
 0x80

	)

104 
	#NFP_MAC_ILK_LKRXSTATUSMESSAGE_FALSE
 0x100

	)

105 
	#NFP_NBI_MAC_MACEQINH
 0x00000278

	)

106 
	#NFP_NBI_MAC_MACEQINHDONE
 0x0000027c

	)

107 
	#NFP_NBI_MAC_HYD0BLOCKRESET
 0x00000004

	)

108 
	#NFP_NBI_MAC_HYD1BLOCKRESET
 0x00000008

	)

109 
	#NFP_NBI_MAC_MACHYDBLKRESET_MAC_HYD_RX_SERDES_RST
(
_x
) \

110 (((
_x
è& 0xfffè<< 20)

	)

111 
	#NFP_NBI_MAC_MACHYDBLKRESET_MAC_HYD_TX_SERDES_RST
(
_x
) \

112 (((
_x
è& 0xfffè<< 4)

	)

128 
	$nå_nbi_mac_‘h_»ad_lšk¡©e
(
nå_nbi_dev
 *
nbi
, 
cÜe
, 
pÜt
,

129 
u32
 *
lšk¡©e
)

131 
u64
 
r
;

132 
u32
 
d
 = 0;

133 
u32
 
m
 = 0;

134 
u32
 
¡©us
 = 0;

135 
»t
;

137 ià(!
nbi
)

138  -
ENODEV
;

140 ià((
cÜe
 < 0) || (core > 1))

141  -
EINVAL
;

143 ià((
pÜt
 < 0) || (port > 11))

144  -
EINVAL
;

146 ià(
lšk¡©e
)

147 *
lšk¡©e
 = 0;

149 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
NFP_MAC
,

150 
NFP_MAC_MACMUXCTRL
, &
d
);

151 ià(
»t
 < 0)

152  
»t
;

154 
m
 = 1 << ((
cÜe
 * 12è+ 
pÜt
);

155 ià((
d
 & 
m
) > 0)

156 
¡©us
 |ð
NFP_NBI_MAC_MACMUXCTRL_ERROR
;

158 
r
 = 
NFP_MAC_ETH_MACETHGLOBAL_ETHACTCTLSEG
;

159 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

160 ià(
»t
 < 0)

161  
»t
;

163 ià(!(
d
 & (0x1 << 
pÜt
)))

164 
¡©us
 |ð
NFP_NBI_MAC_ETHACTCTLSEG_DISABLED
;

166 
r
 = 
	`NFP_MAC_ETH_MACETHCHPCSSEG_STATUS1
(
pÜt
);

168 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

169 ià(
»t
 < 0)

170  
»t
;

172 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

173 ià(
»t
 < 0)

174  
»t
;

176 ià(!(
d
 & 
NFP_MAC_ETH_MACETHCHPCSSEG_STATUS1_RCVLINKSTATUS
))

177 
¡©us
 |ð
NFP_NBI_MAC_ETHCHPCSStus1_RCVLINKSTATUS_DOWN
;

179 
r
 = 
	`NFP_MAC_ETH_MACETHCHPCSSEG_BASERSTATUS1
(
pÜt
);

180 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

181 ià(
»t
 < 0)

182  
»t
;

184 ià(!(
d
 & 
NFP_MAC_ETH_MACETHCHPCSSEG_BASERSTATUS1_RCVLINKSTATUS
))

185 
¡©us
 |=

186 
NFP_NBI_MAC_ETHCHPCSBASERSTATUS1_RCVLINKSTATUS_DOWN
;

188 ià(!(
d
 & 
NFP_MAC_ETH_MACETHCHPCSSEG_BASERSTATUS1_BLOCKLOCKED
))

189 
¡©us
 |=

190 
NFP_NBI_MAC_ETHCHPCSBASERSTATUS1_BLOCKLOCKED_FALSE
;

192 ià(
lšk¡©e
) {

193 *
lšk¡©e
 = 
¡©us
;

194 
r
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHCMDCONFIG
(
pÜt
);

195 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

196 ià(
»t
 < 0)

197  
»t
;

199 ià(!(
d
 & 
NFP_MAC_ETH_MACETHSEG_ETHCMDCONFIG_ETHTXENA
))

200 *
lšk¡©e
 |ð
NFP_NBI_MAC_ETHCMDCONFIG_ETHTXENA_FALSE
;

202 ià(!(
d
 & 
NFP_MAC_ETH_MACETHSEG_ETHCMDCONFIG_ETHRXENA
))

203 *
lšk¡©e
 |ð
NFP_NBI_MAC_ETHCMDCONFIG_ETHRXENA_FALSE
;

206  (
¡©us
) ? 0 : 1;

207 
	}
}

229 
	$nå_nbi_mac_‘h_»ad_mode
(
nå_nbi_dev
 *
nbi
, 
cÜe
, 
pÜt
)

231 
»t
;

232 
u64
 
r
;

233 
u32
 
d
 = 0;

234 
u32
 
m
 = 0;

235 
u32
 
mux
 = 0;

236 
mode
;

237 
s
;

239 ià(!
nbi
)

240  -
ENODEV
;

242 ià((
cÜe
 < 0) || (core > 1))

243  -
EINVAL
;

245 ià((
pÜt
 < 0) || (port > 11))

246  -
EINVAL
;

249 
»t
 =

250 
	`nå_nbi_mac_»gr
(
nbi
, 
NFP_MAC
, 
NFP_MAC_MACMUXCTRL
,

251 &
mux
);

252 ià(
»t
 < 0)

253  
»t
;

255 
m
 = 1 << ((
cÜe
 * 12è+ 
pÜt
);

256 ià((
mux
 & 
m
) > 0)

257  
NFP_NBI_MAC_ILK
;

260 
r
 = 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1
(0);

261 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

262 ià(
»t
 < 0)

263  
»t
;

265 ià((
d
 & 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_MASK
) ==

266 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_100GE
) {

268 ià(
pÜt
 < 10)

269  
NFP_NBI_MAC_ENET_100G
;

273 
s
 = 
pÜt
 % 4;

274 
r
 = 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1
(
pÜt
 - 
s
);

275 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

276 ià(
»t
 < 0)

277  
»t
;

279 ià((
d
 & 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_MASK
) ==

280 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_40GE
)

281  
NFP_NBI_MAC_ENET_40G
;

284 
r
 = 
	`NFP_MAC_ETH_MACETHCHPCSSEG_CTL1
(
pÜt
);

285 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

286 ià(
»t
 < 0)

287  
»t
;

289 
d
 & 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_MASK
) {

290 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_10GE
:

292 
r
 = 
	`NFP_MAC_ETH_ETHSGMIIIFMODE
(
pÜt
);

293 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

294 ià(
»t
 < 0)

295  
»t
;

297 ià(
d
 & 
NFP_MAC_ETH_ETHSGMIIIFMODE_ETHSGMIIPCSENABLE
) {

298 ià(
d
 & 
NFP_MAC_ETH_ETHSGMIIIFMODE_ETHSGMIIENA
) {

299 
s
;

301 
s
 = 
	`NFP_MAC_ETH_ETHSGMIIIFMODE_SPEED_of
(
d
);

303 
s
) {

304 
NFP_MAC_ETH_ETHSGMIIIFMODE_SPEED_10MBPS
:

305 
mode
 = 
NFP_NBI_MAC_ENET_10M
;

307 
NFP_MAC_ETH_ETHSGMIIIFMODE_SPEED_100MBPS
:

308 
mode
 = 
NFP_NBI_MAC_ENET_100M
;

312 
mode
 = 
NFP_NBI_MAC_ENET_1G
;

315 
mode
 = -
EINVAL
;

320 
mode
 = 
NFP_NBI_MAC_ENET_1G
;

322  
mode
;

324  
NFP_NBI_MAC_ENET_10G
;

328 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_8023AV
:

330 
NFP_NBI_MAC_ETHCHPCSCTL1_MODE_10PASSTS
:

336  -
EINVAL
;

337 
	}
}

339 
	$nå_nbi_mac_‘h_wr™e_mac_addr_
(
nå_nbi_dev
 *
nbi
, 
cÜe
,

340 
pÜt
, 
u64
 
hwaddr
)

342 
»t
;

343 
u64
 
r
;

344 
u32
 
d
 = 0;

345 
u32
 
m
 = 0;

347 ià(!
nbi
)

348  -
ENODEV
;

350 ià((
cÜe
 < 0) || (core > 1))

351  -
EINVAL
;

353 ià((
pÜt
 < 0) || (port > 11))

354  -
EINVAL
;

356 ià((
hwaddr
 >> 48) > 0)

357  -
EINVAL
;

359 
r
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR0
(
pÜt
);

360 
m
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR0_ETHMACADDR0
(0xffffffffffffULL);

361 
d
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR0_ETHMACADDR0
(
hwaddr
);

363 
»t
 = 
	`nå_nbi_mac_»gw
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, 
m
, 
d
);

364 ià(
»t
 < 0)

365  
»t
;

367 
r
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR1
(
pÜt
);

368 
m
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR1_ETHMACADDR1
(0xffff);

369 
d
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR1_ETHMACADDR1
(
hwaddr
 >> 32);

371  
	`nå_nbi_mac_»gw
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, 
m
, 
d
);

372 
	}
}

383 
	$nå_nbi_mac_‘h_wr™e_mac_addr
(
nå_nbi_dev
 *
nbi
, 
cÜe
,

384 
pÜt
, 
u64
 
hwaddr
)

386 
rc
, 
”r
;

388 
”r
 = 
	`nå_nbi_mac_acquœe
(
nbi
);

389 ià(
”r
 < 0)

390  
”r
;

392 
rc
 = 
	`nå_nbi_mac_‘h_wr™e_mac_addr_
(
nbi
, 
cÜe
, 
pÜt
, 
hwaddr
);

394 
”r
 = 
	`nå_nbi_mac_»Ëa£
(
nbi
);

395 ià(
”r
 < 0)

396  
”r
;

398  
rc
;

399 
	}
}

410 
	$nå_nbi_mac_‘h_»ad_mac_addr
(
nå_nbi_dev
 *
nbi
, 
cÜe
,

411 
pÜt
, 
u64
 *
hwaddr
)

413 
»t
;

414 
u64
 
r
;

415 
u32
 
d
 = 0;

416 
u32
 
m
 = 0;

418 ià(!
nbi
)

419  -
ENODEV
;

421 ià((
cÜe
 < 0) || (core > 1))

422  -
EINVAL
;

424 ià((
pÜt
 < 0) || (port > 11))

425  -
EINVAL
;

427 ià(!
hwaddr
)

428  -
EINVAL
;

430 
r
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR0
(
pÜt
);

431 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
d
);

432 ià(
»t
 < 0)

433  
»t
;

435 
r
 = 
	`NFP_MAC_ETH_MACETHSEG_ETHMACADDR1
(
pÜt
);

436 
»t
 = 
	`nå_nbi_mac_»gr
(
nbi
, 
	`NFP_MAC_ETH
(
cÜe
), 
r
, &
m
);

437 ià(
»t
 < 0)

438  
»t
;

440 *
hwaddr
 = 
m
;

441 *
hwaddr
 = (*hwadd¸<< 32è| 
d
;

443 
	}
}

	@src/nfpcore/nfp_net_vnic.c

14 
	~<lšux/moduË.h
>

15 
	~<lšux/Ãtdeviû.h
>

16 
	~<lšux/‘h”deviû.h
>

17 
	~<lšux/¶©fÜm_deviû.h
>

18 
	~<lšux/if_¬p.h
>

19 
	~<lšux/.h
>

20 
	~<lšux/io.h
>

21 
	~<lšux/š6.h
>

23 
	~"nå.h
"

24 
	~"nå_ýp.h
"

26 
	~"nå_Ãt_vnic.h
"

28 
	#IPHDR_ALIGN_OFFSET
 ((16 - ((
‘hhdr
))è& 0xf)

	)

29 
	#PKTBUF_OFFSET
 (2è

	)

50 
	snå_Ãt_vnic_queue
 {

52 
u32
 
	mËngth
;

53 
u32
 
	mty³
;

54 
u32
 
	m’abËd
;

55 
u32
 
	m__rsvd
;

56 } 
	mù¾
;

57 
	mpktd©a
[0];

60 
	snå_Ãt_vnic
 {

61 
¶©fÜm_deviû
 *
	mpdev
;

62 
Ãt_deviû
 *
	mÃtdev
;

63 
nå_ýp
 *
	mýp
;

64 
nå_ýp_¬—
 *
	m¬—
;

65 
Ãt_deviû_¡©s
 
	m¡©s
;

66 
tim”_li¡
 
	mtim”
;

67 
	mtim”_št
;

69 
	mid
;

70 
	mmtu
;

71 
	mho¡side
:1;

72 
	mup
:1;

74 
u8
 
	m»mÙe_mac
[
ETH_ALEN
];

75 
š6_addr
 
	m»mÙe_6
;

77 
__iomem
 *
	mpktbufs
;

78 
nå_Ãt_vnic_queue
 
__iomem
 *
	mrx
;

79 
nå_Ãt_vnic_queue
 
__iomem
 *
	mtx
;

82 
	gnå_Ãt_vnic_pÞlš‹rv®
 = 1;

83 
moduË_·¿m
(
nå_Ãt_vnic_pÞlš‹rv®
, 
ušt
, 0444);

84 
MODULE_PARM_DESC
(
nå_Ãt_vnic_pÞlš‹rv®
, "Polling interval for Rx/Tx queues (in ms)");

86 
	gnå_Ãt_vnic_debug
;

87 
moduË_·¿m
(
nå_Ãt_vnic_debug
, 
ušt
, 0444);

88 
MODULE_PARM_DESC
(
nå_Ãt_vnic_debug
, "Enable debug…rintk messages");

90 
	#nå_Ãt_vnic_”r
(
¢
, 
fmt
, 
¬gs
...) \

91 
	`Ãtdev_”r
((
¢
)->
Ãtdev
, 
fmt
, ## 
¬gs
)

	)

92 
	#nå_Ãt_vnic_w¬n
(
¢
, 
fmt
, 
¬gs
...) \

93 
	`Ãtdev_w¬n
((
¢
)->
Ãtdev
, 
fmt
, ## 
¬gs
)

	)

94 
	#nå_Ãt_vnic_šfo
(
¢
, 
fmt
, 
¬gs
...) \

95 
	`Ãtdev_šfo
((
¢
)->
Ãtdev
, 
fmt
, ## 
¬gs
)

	)

96 
	#nå_Ãt_vnic_dbg
(
¢
, 
fmt
, 
¬gs
...) do { \

97 ià(
nå_Ãt_vnic_debug
) \

98 
	`Ãtdev_dbg
((
¢
)->
Ãtdev
, 
fmt
, ## 
¬gs
); \

99 } 0)

	)

101 
	$Âq_pkt_»ad
(*
d¡
, 
nå_Ãt_vnic_queue
 
__iomem
 *
squeue
,

102 
size_t
 
size
)

104 
u32
 
__iomem
 *
s
 = (u32 __iomem *)&
squeue
->
pktd©a
[0];

105 
u32
 *
d
, 
n
;

108 #ià
PKTBUF_OFFSET
 != 0

109 
u32
 
tmp
 = 
	`__¿w_»adl
(
s
++);

110 
u8
 *
tb
 = (u8 *)&
tmp
;

111 #ià
PKTBUF_OFFSET
 == 1

112 ((
u8
 *)
d¡
)[0] = 
tb
[1];

113 ((
u8
 *)
d¡
)[1] = 
tb
[2];

114 ((
u8
 *)
d¡
)[2] = 
tb
[3];

115 #–ià
PKTBUF_OFFSET
 == 2

116 ((
u8
 *)
d¡
)[0] = 
tb
[2];

117 ((
u8
 *)
d¡
)[1] = 
tb
[3];

118 #–ià
PKTBUF_OFFSET
 == 3

119 ((
u8
 *)
d¡
)[0] = 
tb
[3];

121 
d¡
 +ð(4 - 
PKTBUF_OFFSET
);

122 
size
 -ð(4 - 
PKTBUF_OFFSET
);

125 
d
 = 
d¡
;

126 
n
 = (
size
 + (
u32
) - 1) / (u32);

127 
n
--)

128 *
d
++ = 
	`__¿w_»adl
(
s
++);

129 
	}
}

131 
	$Âq_pkt_wr™e
(
nå_Ãt_vnic_queue
 
__iomem
 *
dqueue
,

132 *
¤c
, 
size_t
 
size
)

134 
u32
 
__iomem
 *
d
 = (u32 __iomem *)&
dqueue
->
pktd©a
[0];

135 
u32
 *
s
, 
n
;

138 #ià
PKTBUF_OFFSET
 != 0

139 
u32
 
tmp
 = 0;

140 
u8
 *
tb
 = (u8 *)&
tmp
;

141 #ià
PKTBUF_OFFSET
 == 1

142 
tb
[1] = ((
u8
 *)
¤c
)[0];

143 
tb
[2] = ((
u8
 *)
¤c
)[1];

144 
tb
[3] = ((
u8
 *)
¤c
)[2];

145 #–ià
PKTBUF_OFFSET
 == 2

146 
tb
[2] = ((
u8
 *)
¤c
)[0];

147 
tb
[3] = ((
u8
 *)
¤c
)[1];

148 #–ià
PKTBUF_OFFSET
 == 3

149 
tb
[3] = ((
u8
 *)
¤c
)[0];

151 
	`__¿w_wr™–
(
tmp
, 
d
++);

152 
¤c
 +ð(4 - 
PKTBUF_OFFSET
);

153 
size
 -ð(4 - 
PKTBUF_OFFSET
);

156 
s
 = 
¤c
;

157 
n
 = (
size
 + (
u32
) - 1) / (u32);

158 
n
--)

159 
	`__¿w_wr™–
(*
s
++, 
d
++);

160 
	}
}

162 
	$Âq_’abËd
(
nå_Ãt_vnic_queue
 
__iomem
 *
queue
)

164  
	`»adl
(&
queue
->
ù¾
.
’abËd
);

165 
	}
}

167 
	$Âq_³ndšg_pkt
(
nå_Ãt_vnic_queue
 
__iomem
 *
queue
)

169  
	`»adl
(&
queue
->
ù¾
.
Ëngth
);

170 
	}
}

172 
	$Âq_»ûive_pkt
(
nå_Ãt_vnic_queue
 
__iomem
 *
queue
)

174 
	`wr™–
(0, &
queue
->
ù¾
.
Ëngth
);

175 
	}
}

177 
	$nå_Ãt_vnic_ÿ¼›r_d‘eù
(
nå_Ãt_vnic
 *
vnic
)

179 ià(
	`Âq_’abËd
(
vnic
->
tx
)) {

180 ià(!
vnic
->
up
) {

181 
	`Ãtif_ÿ¼›r_Ú
(
vnic
->
Ãtdev
);

182 
vnic
->
up
 = 1;

185 ià(
vnic
->
up
) {

186 
	`Ãtif_ÿ¼›r_off
(
vnic
->
Ãtdev
);

187 
vnic
->
up
 = 0;

191  
vnic
->
up
;

192 
	}
}

194 
	$nå_Ãt_vnic_tx
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
)

196 
nå_Ãt_vnic
 *
vnic
 = 
	`Ãtdev_´iv
(
Ãtdev
);

198 ià(!
vnic
->
up
) {

200 
	`dev_kä“_skb_ªy
(
skb
);

201 
vnic
->
¡©s
.
tx_”rÜs
++;

202 
vnic
->
¡©s
.
tx_ÿ¼›r_”rÜs
++;

203 
	`nå_Ãt_vnic_dbg
(
vnic
, "Tx whždowÀ(%d)\n", 
skb
->
Ën
);

204  
NETDEV_TX_OK
;

206 ià(
skb
->
Ën
 > 
vnic
->
mtu
) {

208 
	`dev_kä“_skb_ªy
(
skb
);

209 
vnic
->
¡©s
.
tx_”rÜs
++;

210 
vnic
->
¡©s
.
tx_drÝ³d
++;

211 
	`nå_Ãt_vnic_”r
(
vnic
, "Tx ToØbig (%d)\n", 
skb
->
Ën
);

212  
NETDEV_TX_OK
;

214 ià(
	`Âq_³ndšg_pkt
(
vnic
->
tx
)) {

216 
	`Ãtif_¡Ý_queue
(
Ãtdev
);

217 
	`nå_Ãt_vnic_dbg
(
vnic
, "Tx Busy [%d]\n", 
skb
->
Ën
);

218  
NETDEV_TX_BUSY
;

222 
	`Âq_pkt_wr™e
(
vnic
->
tx
, 
skb
->
d©a
, skb->
Ën
);

223 
	`wr™–
(0, &
vnic
->
tx
->
ù¾
.
ty³
);

224 
	`wr™–
(
skb
->
Ën
, &
vnic
->
tx
->
ù¾
.
Ëngth
);

227 
	`wmb
();

229 
	`dev_kä“_skb_ªy
(
skb
);

230 
	`Ãtif_Œªs_upd©e
(
Ãtdev
);

231 
vnic
->
¡©s
.
tx_·ck‘s
++;

232 
vnic
->
¡©s
.
tx_by‹s
 +ð
skb
->
Ën
;

234 
	`nå_Ãt_vnic_dbg
(
vnic
, "Tx Com¶‘[%d]\n", 
skb
->
Ën
);

235  
NETDEV_TX_OK
;

236 
	}
}

238 
	$nå_Ãt_vnic_tx_pÞl
(
nå_Ãt_vnic
 *
vnic
)

240 ià(!
	`Âq_³ndšg_pkt
(
vnic
->
tx
) &&

241 
	`Ãtif_queue_¡Ý³d
(
vnic
->
Ãtdev
)) {

243 
	`nå_Ãt_vnic_dbg
(
vnic
, "Tx Resume\n");

244 
	`Ãtif_wake_queue
(
vnic
->
Ãtdev
);

246 
	}
}

248 
	$nå_Ãt_vnic_rx
(
nå_Ãt_vnic
 *
vnic
)

250 
sk_buff
 *
skb
;

251 
u32
 
pkt_size
, 
pkt_ty³
;

252 
”r
;

254 
pkt_size
 = 
	`»adl
(&
vnic
->
rx
->
ù¾
.
Ëngth
);

255 ià(
pkt_size
 == 0)

258 
pkt_ty³
 = 
	`»adl
(&
vnic
->
rx
->
ù¾
.
ty³
);

259 ià(
pkt_size
 > 
vnic
->
mtu
 || 
pkt_ty³
 != 0) {

260 
	`nå_Ãt_vnic_dbg
(
vnic
,

262 
pkt_size
, 
pkt_ty³
);

263 
	`Âq_»ûive_pkt
(
vnic
->
rx
);

264  -
EINVAL
;

267 
skb
 = 
	`Ãtdev_®loc_skb
(
vnic
->
Ãtdev
, 
pkt_size
 + 
IPHDR_ALIGN_OFFSET
);

268 ià(!
skb
) {

269 
	`Âq_»ûive_pkt
(
vnic
->
rx
);

270 
vnic
->
¡©s
.
rx_drÝ³d
++;

271 
	`nå_Ãt_vnic_dbg
(
vnic
, "Rx Fažu» [%d]\n", 
pkt_size
);

272  -
ENOMEM
;

274 
	`skb_»£rve
(
skb
, 
IPHDR_ALIGN_OFFSET
);

277 
	`Âq_pkt_»ad
(
	`skb_put
(
skb
, 
pkt_size
), 
vnic
->
rx
,…kt_size);

278 
skb
->
dev
 = 
vnic
->
Ãtdev
;

279 
skb
->
´ÙocÞ
 = 
	`‘h_ty³_Œªs
(skb, 
vnic
->
Ãtdev
);

280 
skb
->
_summed
 = 
CHECKSUM_UNNECESSARY
;

281 
”r
 = 
	`Ãtif_»ûive_skb
(
skb
);

283 ià(!
”r
) {

284 
vnic
->
¡©s
.
rx_·ck‘s
++;

285 
vnic
->
¡©s
.
rx_by‹s
 +ð
pkt_size
;

286 
	`nå_Ãt_vnic_dbg
(
vnic
, "Rx Reûived [%d]\n", 
pkt_size
);

288 
vnic
->
¡©s
.
rx_drÝ³d
++;

289 
	`nå_Ãt_vnic_dbg
(
vnic
, "Rx DrÝ³d [%d]\n", 
pkt_size
);

292 
	`Âq_»ûive_pkt
(
vnic
->
rx
);

293  
”r
;

294 
	}
}

296 
	$nå_Ãt_vnic_rx_pÞl
(
nå_Ãt_vnic
 *
vnic
)

298 ià(
	`Âq_³ndšg_pkt
(
vnic
->
rx
))

299 
	`nå_Ãt_vnic_rx
(
vnic
);

300 
	}
}

306 
	$nå_Ãt_vnic_scheduË
(
nå_Ãt_vnic
 *
vnic
)

308 
	`mod_tim”
(&
vnic
->
tim”
, 
jiff›s
 + vnic->
tim”_št
);

309 
	}
}

315 #ià
VER_NON_RHEL_LT
(4, 14è|| 
VER_RHEL_LT
(7, 6)

316 
	$nå_Ãt_vnic_tim”
(
t
)

318 
	$nå_Ãt_vnic_tim”
(
tim”_li¡
 *
t
)

321 
nå_Ãt_vnic
 *
vnic
 = 
	`äom_tim”
(vnic, 
t
, 
tim”
);

323 
	`BUG_ON
(!
vnic
);

325 
	`nå_Ãt_vnic_ÿ¼›r_d‘eù
(
vnic
);

327 ià(
vnic
->
up
) {

328 
	`nå_Ãt_vnic_rx_pÞl
(
vnic
);

329 
	`nå_Ãt_vnic_tx_pÞl
(
vnic
);

332 
	`nå_Ãt_vnic_scheduË
(
vnic
);

333 
	}
}

335 
Ãt_deviû_¡©s
 *
	$nå_Ãt_vnic_¡©s
(
Ãt_deviû
 *
Ãtdev
)

337 
nå_Ãt_vnic
 *
vnic
 = 
	`Ãtdev_´iv
(
Ãtdev
);

339  &
vnic
->
¡©s
;

340 
	}
}

342 
	$nå_Ãt_vnic_Ãtdev_Ý’
(
Ãt_deviû
 *
Ãtdev
)

344 
nå_Ãt_vnic
 *
vnic
 = 
	`Ãtdev_´iv
(
Ãtdev
);

347 
	`tim”_£tup
(&
vnic
->
tim”
, 
nå_Ãt_vnic_tim”
, 0);

348 
vnic
->
tim”_št
 = 
nå_Ãt_vnic_pÞlš‹rv®
 * 
HZ
 / 1000;

349 ià(!
vnic
->
tim”_št
)

350 
vnic
->
tim”_št
 = 1;

351 
	`nå_Ãt_vnic_scheduË
(
vnic
);

353 
	`Ãtif_¡¬t_queue
(
Ãtdev
);

356 
	`wr™–
(1, &
vnic
->
rx
->
ù¾
.
’abËd
);

358 
	`nå_Ãt_vnic_dbg
(
vnic
, "% Ý’ed\n", 
Ãtdev
->
Çme
);

360 
	}
}

362 
	$nå_Ãt_vnic_Ãtdev_þo£
(
Ãt_deviû
 *
Ãtdev
)

364 
nå_Ãt_vnic
 *
vnic
 = 
	`Ãtdev_´iv
(
Ãtdev
);

366 
	`Ãtif_¡Ý_queue
(
Ãtdev
);

367 
	`d–_tim”_sync
(&
vnic
->
tim”
);

370 
	`wr™–
(0, &
vnic
->
rx
->
ù¾
.
’abËd
);

372 
	`nå_Ãt_vnic_dbg
(
vnic
, "% þo£d\n", 
Ãtdev
->
Çme
);

374 
	}
}

379 
Ãt_deviû_Ýs
 
	gnå_Ãt_vnic_Ãtdev_Ýs
 = {

380 .
ndo_Ý’
 = 
nå_Ãt_vnic_Ãtdev_Ý’
,

381 .
	gndo_¡Ý
 = 
nå_Ãt_vnic_Ãtdev_þo£
,

382 .
	gndo_¡¬t_xm™
 = 
nå_Ãt_vnic_tx
,

383 .
	gndo_g‘_¡©s
 = 
nå_Ãt_vnic_¡©s
,

389 
ssize_t


390 
	$show_»mÙe_mac
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

392 
nå_Ãt_vnic
 *
vnic
 = 
	`dev_g‘_drvd©a
(
dev
);

394  
	`¥rštf
(
buf
, "%pM\n", 
vnic
->
»mÙe_mac
);

395 
	}
}

397 
ssize_t


398 
	$show_»mÙe_6
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

400 
nå_Ãt_vnic
 *
vnic
 = 
	`dev_g‘_drvd©a
(
dev
);

405 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 31))

406  
	`¥rštf
(
buf
, "%pI6c\n", &
vnic
->
»mÙe_6
);

408  
	`¥rštf
(
buf
,

410 
vnic
->
»mÙe_6
.
s6_addr
[0],

411 
vnic
->
»mÙe_6
.
s6_addr
[1],

413 
vnic
->
»mÙe_6
.
s6_addr
[2],

414 
vnic
->
»mÙe_6
.
s6_addr
[3],

416 
vnic
->
»mÙe_6
.
s6_addr
[4],

417 
vnic
->
»mÙe_6
.
s6_addr
[5],

419 
vnic
->
»mÙe_6
.
s6_addr
[6],

420 
vnic
->
»mÙe_6
.
s6_addr
[7],

422 
vnic
->
»mÙe_6
.
s6_addr
[8],

423 
vnic
->
»mÙe_6
.
s6_addr
[9],

425 
vnic
->
»mÙe_6
.
s6_addr
[10],

426 
vnic
->
»mÙe_6
.
s6_addr
[11],

428 
vnic
->
»mÙe_6
.
s6_addr
[12],

429 
vnic
->
»mÙe_6
.
s6_addr
[13],

431 
vnic
->
»mÙe_6
.
s6_addr
[14],

432 
vnic
->
»mÙe_6
.
s6_addr
[15]);

434 
	}
}

436 
DEVICE_ATTR
(
»mÙe_mac
, 
S_IRUGO
, 
show_»mÙe_mac
, 
NULL
);

437 
DEVICE_ATTR
(
»mÙe_6
, 
S_IRUGO
, 
show_»mÙe_6
, 
NULL
);

439 
	$nå_Ãt_vnic_©Œ_add
(
nå_Ãt_vnic
 *
vnic
)

441 
”r
 = 0;

443 
”r
 = 
	`deviû_ü—‹_fže
(&
vnic
->
pdev
->
dev
, &
dev_©Œ_»mÙe_mac
);

444 ià(
”r
)

445  
”r
;

447 
”r
 = 
	`deviû_ü—‹_fže
(&
vnic
->
pdev
->
dev
, &
dev_©Œ_»mÙe_6
);

448 ià(
”r
)

449 
	`deviû_»move_fže
(&
vnic
->
pdev
->
dev
, &
dev_©Œ_»mÙe_mac
);

451  
”r
;

452 
	}
}

454 
	$nå_Ãt_vnic_©Œ_»move
(
nå_Ãt_vnic
 *
vnic
)

456 
	`deviû_»move_fže
(&
vnic
->
pdev
->
dev
, &
dev_©Œ_»mÙe_mac
);

457 
	`deviû_»move_fže
(&
vnic
->
pdev
->
dev
, &
dev_©Œ_»mÙe_6
);

458 
	}
}

480 
	#DEFAULT_MAC
 "\x02\x15\x4D\x42\x00\x00"

	)

481 
	$nå_Ãt_vnic_assign_addr
(
Ãt_deviû
 *
Ãtdev
,

482 
vnic_un™
, cÚ¡ *
mac_¡r
)

484 
nå_Ãt_vnic
 *
vnic
 = 
	`Ãtdev_´iv
(
Ãtdev
);

485 
u8
 
mac_addr
[
ETH_ALEN
];

486 
deçuÉ_mac
 = 0;

489 ià(!
mac_¡r
) {

490 
	`‘h”_addr_cÝy
(
mac_addr
, 
DEFAULT_MAC
);

491 
deçuÉ_mac
 = 1;

492 
mac_out
;

495 ià(
	`ssÿnf
(
mac_¡r
, "%02hhx:%02hhx:%02hhx:%02hhx:%02hhx:%02hhx",

496 &
mac_addr
[0], &mac_addr[1], &mac_addr[2],

497 &
mac_addr
[3], &mac_addr[4], &mac_addr[5]) != 6) {

498 
	`nå_Ãt_vnic_w¬n
(
vnic
,

500 
mac_¡r
);

501 
	`‘h”_addr_cÝy
(
mac_addr
, 
DEFAULT_MAC
);

502 
deçuÉ_mac
 = 1;

503 
mac_out
;

506 ià(
	`is_z”o_‘h”_addr
(
mac_addr
)) {

507 
	`nå_Ãt_vnic_w¬n
(
vnic
,

509 
	`‘h”_addr_cÝy
(
mac_addr
, 
DEFAULT_MAC
);

510 
deçuÉ_mac
 = 1;

511 
mac_out
;

514 
mac_out
:

516 
mac_addr
[0] |= 0x2;

517 
mac_addr
[5] +ð
vnic_un™
;

519 
	`‘h”_addr_cÝy
(
vnic
->
»mÙe_mac
, 
mac_addr
);

528 ià(
vnic
->
ho¡side
) {

529 
mac_addr
[0] |= 0x4;

530 ià(
deçuÉ_mac
)

531 
mac_addr
[
ETH_ALEN
 - 1] = 
vnic
->
id
;

532 
vnic
->
»mÙe_mac
[0] &= ~(0x4);

534 
mac_addr
[0] &= ~(0x4);

535 ià(
deçuÉ_mac
)

536 
	`mem£t
(
vnic
->
»mÙe_mac
, 0, 
ETH_ALEN
);

538 
vnic
->
»mÙe_mac
[0] |= 0x4;

541 ià(
	`is_z”o_‘h”_addr
(
mac_addr
)) {

542 
vnic
->
»mÙe_6
.
s6_addr32
[0] = 
	`htÚl
(0xfe800000);

543 
vnic
->
»mÙe_6
.
s6_addr32
[1] = 0;

547 
vnic
->
»mÙe_6
.
s6_addr32
[0] = 
	`htÚl
(0xfe800000);

548 
vnic
->
»mÙe_6
.
s6_addr32
[1] = 0;

551 
	`memýy
(
vnic
->
»mÙe_6
.
s6_addr
 + 8, vnic->
»mÙe_mac
, 3);

552 
	`memýy
(
vnic
->
»mÙe_6
.
s6_addr
 + 8 + 5,

553 
vnic
->
»mÙe_mac
 + 3, 3);

554 
vnic
->
»mÙe_6
.
s6_addr
[8 + 3] = 0xFF;

555 
vnic
->
»mÙe_6
.
s6_addr
[8 + 4] = 0xFE;

556 
vnic
->
»mÙe_6
.
s6_addr
[8 + 0] ^= 0x2;

560 
	`‘h”_addr_cÝy
(
Ãtdev
->
dev_addr
, 
mac_addr
);

561 
	}
}

563 
	$nå_Ãt_vnic_Ãtdev_£tup
(
Ãt_deviû
 *
Ãtdev
)

565 
	`‘h”_£tup
(
Ãtdev
);

567 
Ãtdev
->
Ãtdev_Ýs
 = &
nå_Ãt_vnic_Ãtdev_Ýs
;

568 
Ãtdev
->
æags
 &ð~
IFF_MULTICAST
;

569 
Ãtdev
->
tx_queue_Ën
 = 100;

570 
	}
}

572 
	$nå_Ãt_vnic_´obe
(
¶©fÜm_deviû
 *
pdev
)

574 
Ãt_deviû
 *
Ãtdev
;

575 
nå_Ãt_vnic
 *
vnic
;

576 
”r
;

577 
u16
 
š‹rçû
;

578 cÚ¡ *
»s_Çme
;

579 
nå_»sourû
 *
»s
;

580 
u64
 
ýp_addr
;

581 
u32
 
ýp_id
;

582 
b¬sz
;

583 
nå_ýp_¬—
 *
¬—
;

584 
vnic_un™
;

585 
nå_ýp
 *
ýp
;

586 
nå_¶©fÜm_d©a
 *
pd©a
;

587 *
Ãtm_mac
 = "ethm.mac";

588 
nå_hwšfo
 *
hwšfo
;

589 cÚ¡ *
mac_hwšfo
;

590 
mac_¡r
[32] = {};

592 
pd©a
 = 
	`nå_¶©fÜm_deviû_d©a
(
pdev
);

593 
	`BUG_ON
(!
pd©a
);

595 
ýp
 = 
	`nå_ýp_äom_deviû_id
(
pd©a
->
nå
);

596 ià(!
ýp
)

597  -
ENODEV
;

599 
vnic_un™
 = 
pd©a
->
un™
;

608 
hwšfo
 = 
	`nå_hwšfo_»ad
(
ýp
);

609 
mac_hwšfo
 = 
	`nå_hwšfo_lookup
(
hwšfo
, 
Ãtm_mac
);

610 ià(
mac_hwšfo
)

611 
	`memýy
(
mac_¡r
, 
mac_hwšfo
, (mac_str) - 1);

612 
	`kä“
(
hwšfo
);

614 
vnic_un™
) {

616 
»s_Çme
 = 
NFP_RESOURCE_VNIC_PCI_0
;

619 
»s_Çme
 = 
NFP_RESOURCE_VNIC_PCI_1
;

622 
»s_Çme
 = 
NFP_RESOURCE_VNIC_PCI_2
;

625 
»s_Çme
 = 
NFP_RESOURCE_VNIC_PCI_3
;

628 
»s_Çme
 = 
NULL
;

632 ià(!
»s_Çme
) {

633 
	`nå_ýp_ä“
(
ýp
);

634  -
ENODEV
;

637 
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
»s_Çme
);

638 ià(
	`IS_ERR
(
»s
)) {

639 
	`dev_”r
(&
pdev
->
dev
, "No '%s'„esource…resent\n",

640 
»s_Çme
);

641 
”r
 = -
ENOENT
;

642 
”r_»sourû_acquœe
;

645 
ýp_addr
 = 
	`nå_»sourû_add»ss
(
»s
);

646 
ýp_id
 = 
	`nå_»sourû_ýp_id
(
»s
);

647 
b¬sz
 = 
	`nå_»sourû_size
(
»s
);

648 
	`nå_»sourû_»Ëa£
(
»s
);

650 
¬—
 = 
	`nå_ýp_¬—_®loc_acquœe
(
ýp
, "vnic", 
ýp_id
, 
ýp_addr
, 
b¬sz
);

651 ià(!
¬—
) {

652 
	`dev_”r
(&
pdev
->
dev
, "Can't‡cquire %lu byte‡rea‡t %d:%d:%d:0x%llx\n",

653 
b¬sz
, 
	`NFP_CPP_ID_TARGET_of
(
ýp_id
),

654 
	`NFP_CPP_ID_ACTION_of
(
ýp_id
),

655 
	`NFP_CPP_ID_TOKEN_of
(
ýp_id
),

656 ()
b¬sz
);

657 
”r
 = -
EINVAL
;

658 
”r_¬—_acquœe
;

661 
Ãtdev
 = 
	`®loc_Ãtdev
((*
vnic
), "nvn%d",

662 
NET_NAME_UNKNOWN
,

663 
nå_Ãt_vnic_Ãtdev_£tup
);

664 ià(!
Ãtdev
) {

665 
”r
 = -
ENOMEM
;

666 
”r_®loc_Ãtdev
;

669 
š‹rçû
 = 
	`nå_ýp_š‹rçû
(
ýp
);

672 
vnic
 = 
	`Ãtdev_´iv
(
Ãtdev
);

673 
	`mem£t
(
vnic
, 0, (*vnic));

674 
vnic
->
pdev
 =…dev;

675 
vnic
->
ýp
 = cpp;

676 
vnic
->
¬—
 =‡rea;

677 
vnic
->
Ãtdev
 =‚etdev;

678 
vnic
->
id
 = 
pdev
->id;

679 
vnic
->
ho¡side
 = 
	`NFP_CPP_INTERFACE_TYPE_of
(
š‹rçû
)

680 !ð
NFP_CPP_INTERFACE_TYPE_ARM
;

683 ià(!*
mac_¡r
)

684 
	`nå_Ãt_vnic_w¬n
(
vnic
,

686 
Ãtm_mac
);

687 
	`nå_Ãt_vnic_assign_addr
(
Ãtdev
, 
vnic_un™
, 
mac_¡r
);

689 
	`SET_NETDEV_DEV
(
Ãtdev
, &
pdev
->
dev
);

690 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
vnic
);

693 
vnic
->
pktbufs
 = 
	`devm_iÜem­_noÿche
(

694 &
pdev
->
dev
, 
	`nå_ýp_¬—_phys
(
¬—
), 
b¬sz
);

695 ià(!
vnic
->
pktbufs
) {

696 
	`nå_Ãt_vnic_”r
(
vnic
, "Failedo map…acket buffers\n");

697 
”r
 = -
EIO
;

698 
”r_pktbufs
;

702 
vnic
->
mtu
 = (
b¬sz
 / 2è- (*vnic->
rx
è- (
u32
);

703 ià(
vnic
->
ho¡side
) {

704 
vnic
->
rx
 = vnic->
pktbufs
;

705 
vnic
->
tx
 = vnic->
pktbufs
 + (
b¬sz
 / 2);

707 
vnic
->
rx
 = vnic->
pktbufs
 + (
b¬sz
 / 2);

708 
vnic
->
tx
 = vnic->
pktbufs
;

712 
Ãtdev
->
mtu
 = 
vnic
->mtu - 16;

714 
”r
 = 
	`»gi¡”_Ãtdev
(
Ãtdev
);

715 ià(
”r
)

716 
”r_»gi¡”_Ãtdev
;

718 
”r
 = 
	`nå_Ãt_vnic_©Œ_add
(
vnic
);

719 ià(
”r
)

720 
”r_add_©Œ
;

722 
	`nå_Ãt_vnic_šfo
(
vnic
, "NFP vNIC MAC Address: %pM\n",

723 
Ãtdev
->
dev_addr
);

727 
”r_add_©Œ
:

728 
	`uÄegi¡”_Ãtdev
(
vnic
->
Ãtdev
);

729 
”r_»gi¡”_Ãtdev
:

730 
	`devm_iounm­
(&
pdev
->
dev
, 
vnic
->
pktbufs
);

731 
”r_pktbufs
:

732 
	`ä“_Ãtdev
(
Ãtdev
);

733 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
NULL
);

734 
”r_®loc_Ãtdev
:

735 
	`nå_ýp_¬—_»Ëa£_ä“
(
¬—
);

736 
”r_¬—_acquœe
:

737 
”r_»sourû_acquœe
:

738 
	`nå_ýp_ä“
(
ýp
);

739  
”r
;

740 
	}
}

742 
	$nå_Ãt_vnic_»move
(
¶©fÜm_deviû
 *
pdev
)

744 
nå_Ãt_vnic
 *
vnic
 = 
	`¶©fÜm_g‘_drvd©a
(
pdev
);

746 
	`nå_Ãt_vnic_©Œ_»move
(
vnic
);

747 
	`uÄegi¡”_Ãtdev
(
vnic
->
Ãtdev
);

748 
	`devm_iounm­
(&
pdev
->
dev
, 
vnic
->
pktbufs
);

749 
	`ä“_Ãtdev
(
vnic
->
Ãtdev
);

750 
	`¶©fÜm_£t_drvd©a
(
pdev
, 
NULL
);

751 
	`nå_ýp_¬—_»Ëa£_ä“
(
vnic
->
¬—
);

752 
	`nå_ýp_ä“
(
vnic
->
ýp
);

755 
	}
}

760 
¶©fÜm_driv”
 
	gnå_Ãt_vnic_driv”
 = {

761 .
´obe
 = 
nå_Ãt_vnic_´obe
,

762 .
	g»move
 = 
nå_Ãt_vnic_»move
,

763 .
	gdriv”
 = {

764 .
Çme
 = 
NFP_NET_VNIC_TYPE
,

775 
	$nå_Ãt_vnic_š™
()

777 
	`´_šfo
("%s: NFP vNIC driver, Copyright (C) 2010-2015 Netronome Systems\n",

778 
NFP_NET_VNIC_TYPE
);

780  
	`¶©fÜm_driv”_»gi¡”
(&
nå_Ãt_vnic_driv”
);

781 
	}
}

786 
	$nå_Ãt_vnic_ex™
()

788 
	`¶©fÜm_driv”_uÄegi¡”
(&
nå_Ãt_vnic_driv”
);

789 
	}
}

	@src/nfpcore/nfp_net_vnic.h

9 #iâdeà
NFP_NET_VNIC_H


10 
	#NFP_NET_VNIC_H


	)

12 
	#NFP_NET_VNIC_TYPE
 "nå-Ãt-vnic"

	)

13 
	#NFP_NET_VNIC_UNITS
 4

	)

15 
nå_Ãt_vnic_š™
();

16 
nå_Ãt_vnic_ex™
();

	@src/nfpcore/nfp_nffw.c

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/¦ab.h
>

14 
	~"nå.h
"

15 
	~"nå_ýp.h
"

16 
	~"nå_nffw.h
"

17 
	~"nå6000/nå6000.h
"

22 
	#NFFW_FWID_EXT
 3

	)

23 
	#NFFW_FWID_BASE
 4

	)

25 
	#NFFW_FWID_ALL
 255

	)

38 
	#NFFW_INFO_VERSION_CURRENT
 2

	)

41 
	#NFFW_MEINFO_CNT_V1
 120

	)

42 
	#NFFW_FWINFO_CNT_V1
 120

	)

43 
	#NFFW_MEINFO_CNT_V2
 200

	)

44 
	#NFFW_FWINFO_CNT_V2
 200

	)

49 
	snffw_mešfo
 {

50 
__Ë32
 
	mùxmask__fwid__meid
;

53 
	snffw_fwšfo
 {

54 
__Ë32
 
	mlßded__mu_da__m_off_hi
;

55 
__Ë32
 
	mm_ýpid
;

56 
__Ë32
 
	mm_off£t_lo
;

59 
	snå_nffw_šfo_v1
 {

60 
nffw_mešfo
 
	mmešfo
[
NFFW_MEINFO_CNT_V1
];

61 
nffw_fwšfo
 
	mfwšfo
[
NFFW_FWINFO_CNT_V1
];

64 
	snå_nffw_šfo_v2
 {

65 
nffw_mešfo
 
	mmešfo
[
NFFW_MEINFO_CNT_V2
];

66 
nffw_fwšfo
 
	mfwšfo
[
NFFW_FWINFO_CNT_V2
];

70 
	snå_nffw_šfo_d©a
 {

71 
__Ë32
 
	mæags
[2];

73 
nå_nffw_šfo_v1
 
	mv1
;

74 
nå_nffw_šfo_v2
 
	mv2
;

75 } 
	mšfo
;

78 
	snå_nffw_šfo
 {

79 
nå_ýp
 *
	mýp
;

80 
nå_»sourû
 *
	m»s
;

82 
nå_nffw_šfo_d©a
 
	mfwšf
;

92 
u32
 
	$nffw_»s_šfo_v”siÚ_g‘
(cÚ¡ 
nå_nffw_šfo_d©a
 *
»s
)

94  (
	`Ë32_to_ýu
(
»s
->
æags
[0]) >> 16) & 0xfff;

95 
	}
}

98 
u32
 
	$nffw_»s_æg_š™_g‘
(cÚ¡ 
nå_nffw_šfo_d©a
 *
»s
)

100  (
	`Ë32_to_ýu
(
»s
->
æags
[0]) >> 0) & 1;

101 
	}
}

104 
u32
 
	$nffw_fwšfo_lßded_g‘
(cÚ¡ 
nffw_fwšfo
 *
fi
)

106  (
	`Ë32_to_ýu
(
fi
->
lßded__mu_da__m_off_hi
) >> 31) & 1;

107 
	}
}

110 
u32
 
	$nffw_fwšfo_m_ýpid_g‘
(cÚ¡ 
nffw_fwšfo
 *
fi
)

112  
	`Ë32_to_ýu
(
fi
->
m_ýpid
);

113 
	}
}

116 
u32
 
	$nffw_fwšfo_m_mu_da_g‘
(cÚ¡ 
nffw_fwšfo
 *
fi
)

118  (
	`Ë32_to_ýu
(
fi
->
lßded__mu_da__m_off_hi
) >> 8) & 1;

119 
	}
}

122 
u64
 
	$nffw_fwšfo_m_off£t_g‘
(cÚ¡ 
nffw_fwšfo
 *
fi
)

124 
u64
 
m_off_hi
 = 
	`Ë32_to_ýu
(
fi
->
lßded__mu_da__m_off_hi
);

126  (
m_off_hi
 & 0xFFè<< 32 | 
	`Ë32_to_ýu
(
fi
->
m_off£t_lo
);

127 
	}
}

130 
	$nffw_»s_fwšfos
(
nå_nffw_šfo_d©a
 *
fwšf
, 
nffw_fwšfo
 **
¬r
)

139 
	`nffw_»s_šfo_v”siÚ_g‘
(
fwšf
)) {

142 *
¬r
 = &
fwšf
->
šfo
.
v1
.
fwšfo
[0];

143  
NFFW_FWINFO_CNT_V1
;

145 *
¬r
 = &
fwšf
->
šfo
.
v2
.
fwšfo
[0];

146  
NFFW_FWINFO_CNT_V2
;

148 *
¬r
 = 
NULL
;

151 
	}
}

159 
nå_nffw_šfo
 *
	$nå_nffw_šfo_Ý’
(
nå_ýp
 *
ýp
)

161 
nå_nffw_šfo_d©a
 *
fwšf
;

162 
nå_nffw_šfo
 *
¡©e
;

163 
u32
 
šfo_v”
;

164 
”r
;

166 
¡©e
 = 
	`kz®loc
((*¡©e), 
GFP_KERNEL
);

167 ià(!
¡©e
)

168  
	`ERR_PTR
(-
ENOMEM
);

170 
¡©e
->
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
NFP_RESOURCE_NFP_NFFW
);

171 ià(
	`IS_ERR
(
¡©e
->
»s
))

172 
”r_ä“
;

174 
fwšf
 = &
¡©e
->fwinf;

176 ià((*
fwšf
è> 
	`nå_»sourû_size
(
¡©e
->
»s
))

177 
”r_»Ëa£
;

179 
”r
 = 
	`nå_ýp_»ad
(
ýp
, 
	`nå_»sourû_ýp_id
(
¡©e
->
»s
),

180 
	`nå_»sourû_add»ss
(
¡©e
->
»s
),

181 
fwšf
, (*fwinf));

182 ià(
”r
 < ()(*
fwšf
))

183 
”r_»Ëa£
;

185 ià(!
	`nffw_»s_æg_š™_g‘
(
fwšf
))

186 
”r_»Ëa£
;

188 
šfo_v”
 = 
	`nffw_»s_šfo_v”siÚ_g‘
(
fwšf
);

189 ià(
šfo_v”
 > 
NFFW_INFO_VERSION_CURRENT
)

190 
”r_»Ëa£
;

192 
¡©e
->
ýp
 = cpp;

193  
¡©e
;

195 
”r_»Ëa£
:

196 
	`nå_»sourû_»Ëa£
(
¡©e
->
»s
);

197 
”r_ä“
:

198 
	`kä“
(
¡©e
);

199  
	`ERR_PTR
(-
EIO
);

200 
	}
}

206 
	$nå_nffw_šfo_þo£
(
nå_nffw_šfo
 *
¡©e
)

208 
	`nå_»sourû_»Ëa£
(
¡©e
->
»s
);

209 
	`kä“
(
¡©e
);

210 
	}
}

218 
nffw_fwšfo
 *
	$nå_nffw_šfo_fwid_fœ¡
(
nå_nffw_šfo
 *
¡©e
)

220 
nffw_fwšfo
 *
fwšfo
;

221 
út
, 
i
;

223 
út
 = 
	`nffw_»s_fwšfos
(&
¡©e
->
fwšf
, &
fwšfo
);

224 ià(!
út
)

225  
NULL
;

227 
i
 = 0; i < 
út
; i++)

228 ià(
	`nffw_fwšfo_lßded_g‘
(&
fwšfo
[
i
]))

229  &
fwšfo
[
i
];

231  
NULL
;

232 
	}
}

242 
	$nå_nffw_šfo_m_fœ¡
(
nå_nffw_šfo
 *
¡©e
, 
u32
 *
ýp_id
, 
u64
 *
off
)

244 
nffw_fwšfo
 *
fwšfo
;

246 
fwšfo
 = 
	`nå_nffw_šfo_fwid_fœ¡
(
¡©e
);

247 ià(!
fwšfo
)

248  -
EINVAL
;

250 *
ýp_id
 = 
	`nffw_fwšfo_m_ýpid_g‘
(
fwšfo
);

251 *
off
 = 
	`nffw_fwšfo_m_off£t_g‘
(
fwšfo
);

253 ià(
	`nffw_fwšfo_m_mu_da_g‘
(
fwšfo
)) {

254 
loÿl™y_off
 = 
	`nå_ýp_mu_loÿl™y_lsb
(
¡©e
->
ýp
);

256 *
off
 &ð~(
NFP_MU_ADDR_ACCESS_TYPE_MASK
 << 
loÿl™y_off
);

257 *
off
 |ð
NFP_MU_ADDR_ACCESS_TYPE_DIRECT
 << 
loÿl™y_off
;

261 
	}
}

	@src/nfpcore/nfp_nffw.h

10 #iâdeà
NFP_NFFW_H


11 
	#NFP_NFFW_H


	)

15 
	gnå_nffw_šfo
;

17 
nå_nffw_šfo
 *
nå_nffw_šfo_Ý’
(
nå_ýp
 *
ýp
);

18 
nå_nffw_šfo_þo£
(
nå_nffw_šfo
 *
¡©e
);

19 
nå_nffw_šfo_m_fœ¡
(
nå_nffw_šfo
 *
¡©e
, 
u32
 *
ýp_id
, 
u64
 *
off
);

23 
	gnå_m
;

25 cÚ¡ 
nå_m
 *
nå_m_Ý’
(
nå_ýp
 *
ýp
);

26 
nå_m_þo£
(cÚ¡ 
nå_m
 *
m
);

28 cÚ¡ *
nå_m_Çme
(cÚ¡ 
nå_m
 *
m
);

29 
nå_m_symb
(cÚ¡ 
nå_m
 *
m
, 
u32
 *
addr
, u32 *
size
);

30 
nå_m_¡¹ab
(cÚ¡ 
nå_m
 *
m
, 
u32
 *
addr
, u32 *
size
);

34 
	enå_¹sym_ty³
 {

35 
	mNFP_RTSYM_TYPE_NONE
 = 0,

36 
	mNFP_RTSYM_TYPE_OBJECT
 = 1,

37 
	mNFP_RTSYM_TYPE_FUNCTION
 = 2,

38 
	mNFP_RTSYM_TYPE_ABS
 = 3,

41 
	#NFP_RTSYM_TARGET_NONE
 0

	)

42 
	#NFP_RTSYM_TARGET_LMEM
 -1

	)

43 
	#NFP_RTSYM_TARGET_EMU_CACHE
 -7

	)

54 
	snå_¹sym
 {

55 cÚ¡ *
	mÇme
;

56 
u64
 
	maddr
;

57 
u64
 
	msize
;

58 
nå_¹sym_ty³
 
	mty³
;

59 
	mrg‘
;

60 
	mdomaš
;

63 
	gnå_¹sym_bË
;

65 
nå_¹sym_bË
 *
nå_¹sym_bË_»ad
(
nå_ýp
 *
ýp
);

66 
nå_¹sym_bË
 *

67 
__nå_¹sym_bË_»ad
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_m
 *
m
);

68 
nå_¹sym_couÁ
(
nå_¹sym_bË
 *
¹bl
);

69 cÚ¡ 
nå_¹sym
 *
nå_¹sym_g‘
(
nå_¹sym_bË
 *
¹bl
, 
idx
);

70 cÚ¡ 
nå_¹sym
 *

71 
nå_¹sym_lookup
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
);

73 
u64
 
nå_¹sym_size
(cÚ¡ 
nå_¹sym
 *
¹sym
);

74 
__nå_¹sym_»ad
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

75 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, *
buf
, 
size_t
 
Ën
);

76 
nå_¹sym_»ad
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

77 *
buf
, 
size_t
 
Ën
);

78 
__nå_¹sym_»adl
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

79 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, 
u32
 *
v®ue
);

80 
nå_¹sym_»adl
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

81 
u32
 *
v®ue
);

82 
__nå_¹sym_»adq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

83 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, u64 *
v®ue
);

84 
nå_¹sym_»adq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

85 
u64
 *
v®ue
);

86 
__nå_¹sym_wr™e
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

87 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, *
buf
, 
size_t
 
Ën
);

88 
nå_¹sym_wr™e
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

89 *
buf
, 
size_t
 
Ën
);

90 
__nå_¹sym_wr™–
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

91 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, 
u32
 
v®ue
);

92 
nå_¹sym_wr™–
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

93 
u32
 
v®ue
);

94 
__nå_¹sym_wr™eq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

95 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, u64 
v®ue
);

96 
nå_¹sym_wr™eq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

97 
u64
 
v®ue
);

99 
u64
 
nå_¹sym_»ad_Ë
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
,

100 *
”rÜ
);

101 
nå_¹sym_wr™e_Ë
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
,

102 
u64
 
v®ue
);

103 
u8
 
__iomem
 *

104 
nå_¹sym_m­
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
, cÚ¡ *
id
,

105 
mš_size
, 
nå_ýp_¬—
 **
¬—
);

	@src/nfpcore/nfp_nsp.c

9 
	~"kcom·t.h
"

11 
	~<asm/uÇligÃd.h
>

12 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

13 
	~<lšux/b™f›ld.h
>

15 
	~<lšux/d–ay.h
>

16 
	~<lšux/fœmw¬e.h
>

17 
	~<lšux/k”Ãl.h
>

18 
	~<lšux/kth»ad.h
>

19 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(4, 18, 0)

20 
	~<lšux/ov”æow.h
>

22 
	~<lšux/sizes.h
>

23 
	~<lšux/¦ab.h
>

25 
	#NFP_SUBSYS
 "nå_n¥"

	)

27 
	~"nå.h
"

28 
	~"nå_ýp.h
"

29 
	~"nå_n¥.h
"

31 
	#NFP_NSP_TIMEOUT_DEFAULT
 30

	)

32 
	#NFP_NSP_TIMEOUT_BOOT
 30

	)

35 
	#NSP_STATUS
 0x00

	)

36 
	#NSP_STATUS_MAGIC
 
	`GENMASK_ULL
(63, 48)

	)

37 
	#NSP_STATUS_MAJOR
 
	`GENMASK_ULL
(47, 44)

	)

38 
	#NSP_STATUS_MINOR
 
	`GENMASK_ULL
(43, 32)

	)

39 
	#NSP_STATUS_CODE
 
	`GENMASK_ULL
(31, 16)

	)

40 
	#NSP_STATUS_RESULT
 
	`GENMASK_ULL
(15, 8)

	)

41 
	#NSP_STATUS_BUSY
 
	`BIT_ULL
(0)

	)

43 
	#NSP_COMMAND
 0x08

	)

44 
	#NSP_COMMAND_OPTION
 
	`GENMASK_ULL
(63, 32)

	)

45 
	#NSP_COMMAND_CODE
 
	`GENMASK_ULL
(31, 16)

	)

46 
	#NSP_COMMAND_DMA_BUF
 
	`BIT_ULL
(1)

	)

47 
	#NSP_COMMAND_START
 
	`BIT_ULL
(0)

	)

50 
	#NSP_BUFFER
 0x10

	)

51 
	#NSP_BUFFER_CPP
 
	`GENMASK_ULL
(63, 40)

	)

52 
	#NSP_BUFFER_ADDRESS
 
	`GENMASK_ULL
(39, 0)

	)

54 
	#NSP_DFLT_BUFFER
 0x18

	)

55 
	#NSP_DFLT_BUFFER_CPP
 
	`GENMASK_ULL
(63, 40)

	)

56 
	#NSP_DFLT_BUFFER_ADDRESS
 
	`GENMASK_ULL
(39, 0)

	)

58 
	#NSP_DFLT_BUFFER_CONFIG
 0x20

	)

59 
	#NSP_DFLT_BUFFER_DMA_CHUNK_ORDER
 
	`GENMASK_ULL
(63, 58)

	)

60 
	#NSP_DFLT_BUFFER_SIZE_4KB
 
	`GENMASK_ULL
(15, 8)

	)

61 
	#NSP_DFLT_BUFFER_SIZE_MB
 
	`GENMASK_ULL
(7, 0)

	)

63 
	#NFP_CAP_CMD_DMA_SG
 0x28

	)

65 
	#NSP_MAGIC
 0xab10

	)

66 
	#NSP_MAJOR
 0

	)

67 
	#NSP_MINOR
 8

	)

69 
	#NSP_CODE_MAJOR
 
	`GENMASK
(15, 12)

	)

70 
	#NSP_CODE_MINOR
 
	`GENMASK
(11, 0)

	)

72 
	#NFP_FW_LOAD_RET_MAJOR
 
	`GENMASK
(15, 8)

	)

73 
	#NFP_FW_LOAD_RET_MINOR
 
	`GENMASK
(23, 16)

	)

75 
	#NFP_HWINFO_LOOKUP_SIZE
 
	`GENMASK
(11, 0)

	)

77 
	#NFP_VERSIONS_SIZE
 
	`GENMASK
(11, 0)

	)

78 
	#NFP_VERSIONS_CNT_OFF
 0

	)

79 
	#NFP_VERSIONS_BSP_OFF
 2

	)

80 
	#NFP_VERSIONS_CPLD_OFF
 6

	)

81 
	#NFP_VERSIONS_APP_OFF
 10

	)

82 
	#NFP_VERSIONS_BUNDLE_OFF
 14

	)

83 
	#NFP_VERSIONS_UNDI_OFF
 18

	)

84 
	#NFP_VERSIONS_NCSI_OFF
 22

	)

85 
	#NFP_VERSIONS_CFGR_OFF
 26

	)

87 
	#NSP_SFF_EEPROM_BLOCK_LEN
 8

	)

89 
	enå_n¥_cmd
 {

90 
	mSPCODE_NOOP
 = 0,

91 
	mSPCODE_SOFT_RESET
 = 1,

92 
	mSPCODE_FW_DEFAULT
 = 2,

93 
	mSPCODE_PHY_INIT
 = 3,

94 
	mSPCODE_MAC_INIT
 = 4,

95 
	mSPCODE_PHY_RXADAPT
 = 5,

96 
	mSPCODE_FW_LOAD
 = 6,

97 
	mSPCODE_ETH_RESCAN
 = 7,

98 
	mSPCODE_ETH_CONTROL
 = 8,

99 
	mSPCODE_NSP_WRITE_FLASH
 = 11,

100 
	mSPCODE_NSP_SENSORS
 = 12,

101 
	mSPCODE_NSP_IDENTIFY
 = 13,

102 
	mSPCODE_FW_STORED
 = 16,

103 
	mSPCODE_HWINFO_LOOKUP
 = 17,

104 
	mSPCODE_VERSIONS
 = 21,

105 
	mSPCODE_READ_SFF_EEPROM
 = 22,

108 
	snå_n¥_dma_buf
 {

109 
__Ë32
 
	mchunk_út
;

110 
__Ë32
 
	m»£rved
[3];

112 
__Ë32
 
	msize
;

113 
__Ë32
 
	m»£rved
;

114 
__Ë64
 
	maddr
;

115 } 
	mdescs
[];

119 
	mcode
;

120 cÚ¡ *
	mmsg
;

121 } 
	gn¥_”rÜs
[] = {

129 
	snå_n¥
 {

130 
nå_ýp
 *
	mýp
;

131 
nå_»sourû
 *
	m»s
;

133 
u16
 
	mmajÜ
;

134 
u16
 
	mmšÜ
;

135 } 
	mv”
;

138 
boÞ
 
	mmodif›d
;

139 
	midx
;

140 *
	m’Œ›s
;

152 
	snå_n¥_commªd_¬g
 {

153 
u16
 
	mcode
;

154 
boÞ
 
	mdma
;

155 
	mtimeout_£c
;

156 
u32
 
	mÝtiÚ
;

157 
u64
 
	mbuf
;

158 (*
	m”rÜ_cb
)(
nå_n¥
 *
	m¡©e
, 
u32
 
	m»t_v®
);

169 
	snå_n¥_commªd_buf_¬g
 {

170 
nå_n¥_commªd_¬g
 
	m¬g
;

171 cÚ¡ *
	mš_buf
;

172 
	mš_size
;

173 *
	mout_buf
;

174 
	mout_size
;

177 
nå_ýp
 *
	$nå_n¥_ýp
(
nå_n¥
 *
¡©e
)

179  
¡©e
->
ýp
;

180 
	}
}

182 
boÞ
 
	$nå_n¥_cÚfig_modif›d
(
nå_n¥
 *
¡©e
)

184  
¡©e
->
modif›d
;

185 
	}
}

187 
	$nå_n¥_cÚfig_£t_modif›d
(
nå_n¥
 *
¡©e
, 
boÞ
 
modif›d
)

189 
¡©e
->
modif›d
 = modified;

190 
	}
}

192 *
	$nå_n¥_cÚfig_’Œ›s
(
nå_n¥
 *
¡©e
)

194  
¡©e
->
’Œ›s
;

195 
	}
}

197 
	$nå_n¥_cÚfig_idx
(
nå_n¥
 *
¡©e
)

199  
¡©e
->
idx
;

200 
	}
}

203 
	$nå_n¥_cÚfig_£t_¡©e
(
nå_n¥
 *
¡©e
, *
’Œ›s
, 
idx
)

205 
¡©e
->
’Œ›s
 =ƒntries;

206 
¡©e
->
idx
 = idx;

207 
	}
}

209 
	$nå_n¥_cÚfig_þ—r_¡©e
(
nå_n¥
 *
¡©e
)

211 
¡©e
->
’Œ›s
 = 
NULL
;

212 
¡©e
->
idx
 = 0;

213 
	}
}

215 
	$nå_n¥_´št_ex‹nded_”rÜ
(
nå_n¥
 *
¡©e
, 
u32
 
»t_v®
)

217 
i
;

219 ià(!
»t_v®
)

222 
i
 = 0; i < 
	`ARRAY_SIZE
(
n¥_”rÜs
); i++)

223 ià(
»t_v®
 =ð
n¥_”rÜs
[
i
].
code
)

224 
	`nå_”r
(
¡©e
->
ýp
, "”¸msg: %s\n", 
n¥_”rÜs
[
i
].
msg
);

225 
	}
}

227 
	$nå_n¥_check
(
nå_n¥
 *
¡©e
)

229 
nå_ýp
 *
ýp
 = 
¡©e
->cpp;

230 
u64
 
n¥_¡©us
, 
»g
;

231 
u32
 
n¥_ýp
;

232 
”r
;

234 
n¥_ýp
 = 
	`nå_»sourû_ýp_id
(
¡©e
->
»s
);

235 
n¥_¡©us
 = 
	`nå_»sourû_add»ss
(
¡©e
->
»s
è+ 
NSP_STATUS
;

237 
”r
 = 
	`nå_ýp_»adq
(
ýp
, 
n¥_ýp
, 
n¥_¡©us
, &
»g
);

238 ià(
”r
 < 0)

239  
”r
;

241 ià(
	`FIELD_GET
(
NSP_STATUS_MAGIC
, 
»g
è!ð
NSP_MAGIC
) {

242 
	`nå_”r
(
ýp
, "Cannot detect NFP Service Processor\n");

243  -
ENODEV
;

246 
¡©e
->
v”
.
majÜ
 = 
	`FIELD_GET
(
NSP_STATUS_MAJOR
, 
»g
);

247 
¡©e
->
v”
.
mšÜ
 = 
	`FIELD_GET
(
NSP_STATUS_MINOR
, 
»g
);

249 ià(
¡©e
->
v”
.
majÜ
 !ð
NSP_MAJOR
 || s‹->v”.
mšÜ
 < 
NSP_MINOR
) {

250 
	`nå_”r
(
ýp
, "Unsupported ABI %hu.%hu\n",

251 
¡©e
->
v”
.
majÜ
, s‹->v”.
mšÜ
);

252  -
EINVAL
;

255 ià(
»g
 & 
NSP_STATUS_BUSY
) {

256 
	`nå_”r
(
ýp
, "Service…rocessor busy!\n");

257  -
EBUSY
;

261 
	}
}

267 
nå_n¥
 *
	$nå_n¥_Ý’
(
nå_ýp
 *
ýp
)

269 
nå_»sourû
 *
»s
;

270 
nå_n¥
 *
¡©e
;

271 
”r
;

273 
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
NFP_RESOURCE_NSP
);

274 ià(
	`IS_ERR
(
»s
))

275  (*)
»s
;

277 
¡©e
 = 
	`kz®loc
((*¡©e), 
GFP_KERNEL
);

278 ià(!
¡©e
) {

279 
	`nå_»sourû_»Ëa£
(
»s
);

280  
	`ERR_PTR
(-
ENOMEM
);

282 
¡©e
->
ýp
 = cpp;

283 
¡©e
->
»s
 =„es;

285 
”r
 = 
	`nå_n¥_check
(
¡©e
);

286 ià(
”r
) {

287 
	`nå_n¥_þo£
(
¡©e
);

288  
	`ERR_PTR
(
”r
);

291  
¡©e
;

292 
	}
}

298 
	$nå_n¥_þo£
(
nå_n¥
 *
¡©e
)

300 
	`nå_»sourû_»Ëa£
(
¡©e
->
»s
);

301 
	`kä“
(
¡©e
);

302 
	}
}

304 
u16
 
	$nå_n¥_g‘_abi_v”_majÜ
(
nå_n¥
 *
¡©e
)

306  
¡©e
->
v”
.
majÜ
;

307 
	}
}

309 
u16
 
	$nå_n¥_g‘_abi_v”_mšÜ
(
nå_n¥
 *
¡©e
)

311  
¡©e
->
v”
.
mšÜ
;

312 
	}
}

315 
	$nå_n¥_wa™_»g
(
nå_ýp
 *
ýp
, 
u64
 *
»g
, 
u32
 
n¥_ýp
, u64 
addr
,

316 
u64
 
mask
, u64 
v®
, 
u32
 
timeout_£c
)

318 cÚ¡ 
wa™_uÁž
 = 
jiff›s
 + 
timeout_£c
 * 
HZ
;

319 
”r
;

322 cÚ¡ 
¡¬t_time
 = 
jiff›s
;

324 
”r
 = 
	`nå_ýp_»adq
(
ýp
, 
n¥_ýp
, 
addr
, 
»g
);

325 ià(
”r
 < 0)

326  
”r
;

328 ià((*
»g
 & 
mask
è=ð
v®
)

331 
	`m¦“p
(25);

333 ià(
	`time_aá”
(
¡¬t_time
, 
wa™_uÁž
))

334  -
ETIMEDOUT
;

336 
	}
}

354 
	$__nå_n¥_commªd
(
nå_n¥
 *
¡©e
, cÚ¡ 
nå_n¥_commªd_¬g
 *
¬g
)

356 
u64
 
»g
, 
»t_v®
, 
n¥_ba£
, 
n¥_bufãr
, 
n¥_¡©us
, 
n¥_commªd
;

357 
nå_ýp
 *
ýp
 = 
¡©e
->cpp;

358 
u32
 
n¥_ýp
;

359 
”r
;

361 
n¥_ýp
 = 
	`nå_»sourû_ýp_id
(
¡©e
->
»s
);

362 
n¥_ba£
 = 
	`nå_»sourû_add»ss
(
¡©e
->
»s
);

363 
n¥_¡©us
 = 
n¥_ba£
 + 
NSP_STATUS
;

364 
n¥_commªd
 = 
n¥_ba£
 + 
NSP_COMMAND
;

365 
n¥_bufãr
 = 
n¥_ba£
 + 
NSP_BUFFER
;

367 
”r
 = 
	`nå_n¥_check
(
¡©e
);

368 ià(
”r
)

369  
”r
;

371 
”r
 = 
	`nå_ýp_wr™eq
(
ýp
, 
n¥_ýp
, 
n¥_bufãr
, 
¬g
->
buf
);

372 ià(
”r
 < 0)

373  
”r
;

375 
”r
 = 
	`nå_ýp_wr™eq
(
ýp
, 
n¥_ýp
, 
n¥_commªd
,

376 
	`FIELD_PREP
(
NSP_COMMAND_OPTION
, 
¬g
->
ÝtiÚ
) |

377 
	`FIELD_PREP
(
NSP_COMMAND_CODE
, 
¬g
->
code
) |

378 
	`FIELD_PREP
(
NSP_COMMAND_DMA_BUF
, 
¬g
->
dma
) |

379 
	`FIELD_PREP
(
NSP_COMMAND_START
, 1));

380 ià(
”r
 < 0)

381  
”r
;

384 
”r
 = 
	`nå_n¥_wa™_»g
(
ýp
, &
»g
, 
n¥_ýp
, 
n¥_commªd
,

385 
NSP_COMMAND_START
, 0, 
NFP_NSP_TIMEOUT_DEFAULT
);

386 ià(
”r
) {

387 
	`nå_”r
(
ýp
, "Error %d waiting for code 0x%04xo start\n",

388 
”r
, 
¬g
->
code
);

389  
”r
;

393 
”r
 = 
	`nå_n¥_wa™_»g
(
ýp
, &
»g
, 
n¥_ýp
, 
n¥_¡©us
, 
NSP_STATUS_BUSY
,

394 0, 
¬g
->
timeout_£c
 ?: 
NFP_NSP_TIMEOUT_DEFAULT
);

395 ià(
”r
) {

396 
	`nå_”r
(
ýp
, "Error %d waiting for code 0x%04xo complete\n",

397 
”r
, 
¬g
->
code
);

398  
”r
;

401 
”r
 = 
	`nå_ýp_»adq
(
ýp
, 
n¥_ýp
, 
n¥_commªd
, &
»t_v®
);

402 ià(
”r
 < 0)

403  
”r
;

404 
»t_v®
 = 
	`FIELD_GET
(
NSP_COMMAND_OPTION
,„et_val);

406 
”r
 = 
	`FIELD_GET
(
NSP_STATUS_RESULT
, 
»g
);

407 ià(
”r
) {

408 
	`nå_w¬n
(
ýp
, "Result (error) code set: %d (%d) command: %d\n",

409 -
”r
, ()
»t_v®
, 
¬g
->
code
);

410 ià(
¬g
->
”rÜ_cb
)

411 
¬g
->
	`”rÜ_cb
(
¡©e
, 
»t_v®
);

413 
	`nå_n¥_´št_ex‹nded_”rÜ
(
¡©e
, 
»t_v®
);

414  -
”r
;

417  
»t_v®
;

418 
	}
}

420 
	$nå_n¥_commªd
(
nå_n¥
 *
¡©e
, 
u16
 
code
)

422 cÚ¡ 
nå_n¥_commªd_¬g
 
¬g
 = {

423 .
code
 = code,

426  
	`__nå_n¥_commªd
(
¡©e
, &
¬g
);

427 
	}
}

430 
	$nå_n¥_commªd_buf_def
(
nå_n¥
 *
n¥
,

431 
nå_n¥_commªd_buf_¬g
 *
¬g
)

433 
nå_ýp
 *
ýp
 = 
n¥
->cpp;

434 
u64
 
»g
, 
ýp_buf
;

435 
”r
, 
»t
;

436 
u32
 
ýp_id
;

438 
”r
 = 
	`nå_ýp_»adq
(
ýp
, 
	`nå_»sourû_ýp_id
(
n¥
->
»s
),

439 
	`nå_»sourû_add»ss
(
n¥
->
»s
) +

440 
NSP_DFLT_BUFFER
,

441 &
»g
);

442 ià(
”r
 < 0)

443  
”r
;

445 
ýp_id
 = 
	`FIELD_GET
(
NSP_DFLT_BUFFER_CPP
, 
»g
) << 8;

446 
ýp_buf
 = 
	`FIELD_GET
(
NSP_DFLT_BUFFER_ADDRESS
, 
»g
);

448 ià(
¬g
->
š_buf
 &&‡rg->
š_size
) {

449 
”r
 = 
	`nå_ýp_wr™e
(
ýp
, 
ýp_id
, 
ýp_buf
,

450 
¬g
->
š_buf
,‡rg->
š_size
);

451 ià(
”r
 < 0)

452  
”r
;

455 ià(
¬g
->
out_buf
 &&‡rg->
out_size
 &&‡rg->out_siz>‡rg->
š_size
) {

456 
”r
 = 
	`nå_ýp_wr™e
(
ýp
, 
ýp_id
, 
ýp_buf
 + 
¬g
->
š_size
,

457 
¬g
->
out_buf
,‡rg->
out_size
 -‡rg->
š_size
);

458 ià(
”r
 < 0)

459  
”r
;

462 ià(!
	`FIELD_FIT
(
NSP_BUFFER_CPP
, 
ýp_id
 >> 8) ||

463 !
	`FIELD_FIT
(
NSP_BUFFER_ADDRESS
, 
ýp_buf
)) {

464 
	`nå_”r
(
ýp
, "Buffer out of„each %08x %016llx\n",

465 
ýp_id
, 
ýp_buf
);

466  -
EINVAL
;

469 
¬g
->¬g.
buf
 = 
	`FIELD_PREP
(
NSP_BUFFER_CPP
, 
ýp_id
 >> 8) |

470 
	`FIELD_PREP
(
NSP_BUFFER_ADDRESS
, 
ýp_buf
);

471 
»t
 = 
	`__nå_n¥_commªd
(
n¥
, &
¬g
->arg);

472 ià(
»t
 < 0)

473  
»t
;

475 ià(
¬g
->
out_buf
 &&‡rg->
out_size
) {

476 
”r
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
ýp_buf
,

477 
¬g
->
out_buf
,‡rg->
out_size
);

478 ià(
”r
 < 0)

479  
”r
;

482  
»t
;

483 
	}
}

486 
	$nå_n¥_commªd_buf_dma_sg
(
nå_n¥
 *
n¥
,

487 
nå_n¥_commªd_buf_¬g
 *
¬g
,

488 
max_size
, 
chunk_Üd”
,

489 
dma_Üd”
)

491 
nå_ýp
 *
ýp
 = 
n¥
->cpp;

492 
nå_n¥_dma_buf
 *
desc
;

494 
dma_addr_t
 
dma_addr
;

495 
Ën
;

496 *
chunk
;

497 } *
chunks
;

498 
size_t
 
chunk_size
, 
dma_size
;

499 
dma_addr_t
 
dma_desc
;

500 
deviû
 *
dev
;

501 
off
;

502 
i
, 
»t
, 
n£g
;

503 
size_t
 
desc_sz
;

505 
chunk_size
 = 
	`BIT_ULL
(
chunk_Üd”
);

506 
dma_size
 = 
	`BIT_ULL
(
dma_Üd”
);

507 
n£g
 = 
	`DIV_ROUND_UP
(
max_size
, 
chunk_size
);

509 
chunks
 = 
	`kz®loc
(
	`¬¿y_size
((*chunks), 
n£g
), 
GFP_KERNEL
);

510 ià(!
chunks
)

511  -
ENOMEM
;

513 
off
 = 0;

514 
»t
 = -
ENOMEM
;

515 
i
 = 0; i < 
n£g
; i++) {

516 
coff
;

518 
chunks
[
i
].
chunk
 = 
	`km®loc
(
chunk_size
,

519 
GFP_KERNEL
 | 
__GFP_NOWARN
);

520 ià(!
chunks
[
i
].
chunk
)

521 
ex™_ä“_´ev
;

523 
chunks
[
i
].
Ën
 = 
	`mš_t
(
u64
, 
chunk_size
, 
max_size
 - 
off
);

525 
coff
 = 0;

526 ià(
¬g
->
š_size
 > 
off
) {

527 
coff
 = 
	`mš_t
(
u64
, 
¬g
->
š_size
 - 
off
, 
chunk_size
);

528 
	`memýy
(
chunks
[
i
].
chunk
, 
¬g
->
š_buf
 + 
off
, 
coff
);

530 
	`mem£t
(
chunks
[
i
].
chunk
 + 
coff
, 0, 
chunk_size
 - coff);

532 
off
 +ð
chunks
[
i
].
Ën
;

535 
dev
 = 
	`nå_ýp_deviû
(
ýp
)->
·»Á
;

537 
i
 = 0; i < 
n£g
; i++) {

538 
dma_addr_t
 
addr
;

540 
addr
 = 
	`dma_m­_sšgË
(
dev
, 
chunks
[
i
].
chunk
, chunks[i].
Ën
,

541 
DMA_BIDIRECTIONAL
);

542 
chunks
[
i
].
dma_addr
 = 
addr
;

544 
»t
 = 
	`dma_m­pšg_”rÜ
(
dev
, 
addr
);

545 ià(
»t
)

546 
ex™_unm­_´ev
;

548 ià(
	`WARN_ONCE
(
	`round_down
(
addr
, 
dma_size
) !=

549 
	`round_down
(
addr
 + 
chunks
[
i
].
Ën
 - 1, 
dma_size
),

551 &
addr
, 
chunks
[
i
].
Ën
, 
dma_size
)) {

552 
»t
 = -
EFAULT
;

553 
i
++;

554 
ex™_unm­_´ev
;

558 
desc_sz
 = 
	`¡ruù_size
(
desc
, 
descs
, 
n£g
);

559 
desc
 = 
	`km®loc
(
desc_sz
, 
GFP_KERNEL
);

560 ià(!
desc
) {

561 
»t
 = -
ENOMEM
;

562 
ex™_unm­_®l
;

565 
desc
->
chunk_út
 = 
	`ýu_to_Ë32
(
n£g
);

566 
i
 = 0; i < 
n£g
; i++) {

567 
desc
->
descs
[
i
].
size
 = 
	`ýu_to_Ë32
(
chunks
[i].
Ën
);

568 
desc
->
descs
[
i
].
addr
 = 
	`ýu_to_Ë64
(
chunks
[i].
dma_addr
);

571 
dma_desc
 = 
	`dma_m­_sšgË
(
dev
, 
desc
, 
desc_sz
, 
DMA_TO_DEVICE
);

572 
»t
 = 
	`dma_m­pšg_”rÜ
(
dev
, 
dma_desc
);

573 ià(
»t
)

574 
ex™_ä“_desc
;

576 
¬g
->¬g.
dma
 = 
Œue
;

577 
¬g
->¬g.
buf
 = 
dma_desc
;

578 
»t
 = 
	`__nå_n¥_commªd
(
n¥
, &
¬g
->arg);

579 ià(
»t
 < 0)

580 
ex™_unm­_desc
;

582 
i
 = 0;

583 
off
 = 0;

584 
off
 < 
¬g
->
out_size
) {

585 
Ën
;

587 
Ën
 = 
	`mš_t
(
u64
, 
chunks
[
i
].Ën, 
¬g
->
out_size
 - 
off
);

588 
	`memýy
(
¬g
->
out_buf
 + 
off
, 
chunks
[
i
].
chunk
, 
Ën
);

589 
off
 +ð
Ën
;

590 
i
++;

593 
ex™_unm­_desc
:

594 
	`dma_unm­_sšgË
(
dev
, 
dma_desc
, 
desc_sz
, 
DMA_TO_DEVICE
);

595 
ex™_ä“_desc
:

596 
	`kä“
(
desc
);

597 
ex™_unm­_®l
:

598 
i
 = 
n£g
;

599 
ex™_unm­_´ev
:

600 --
i
 >= 0)

601 
	`dma_unm­_sšgË
(
dev
, 
chunks
[
i
].
dma_addr
, chunks[i].
Ën
,

602 
DMA_BIDIRECTIONAL
);

603 
i
 = 
n£g
;

604 
ex™_ä“_´ev
:

605 --
i
 >= 0)

606 
	`kä“
(
chunks
[
i
].
chunk
);

607 
	`kä“
(
chunks
);

608 ià(
»t
 < 0)

609 
	`nå_”r
(
ýp
, "NSP: SG DMA failed for command 0x%04x: %d (sz:%d cord:%d)\n",

610 
¬g
->¬g.
code
, 
»t
, 
max_size
, 
chunk_Üd”
);

611  
»t
;

612 
	}
}

615 
	$nå_n¥_commªd_buf_dma
(
nå_n¥
 *
n¥
,

616 
nå_n¥_commªd_buf_¬g
 *
¬g
,

617 
max_size
, 
dma_Üd”
)

619 
chunk_Üd”
, 
buf_Üd”
;

620 
nå_ýp
 *
ýp
 = 
n¥
->cpp;

621 
boÞ
 
sg_ok
;

622 
u64
 
»g
;

623 
”r
;

625 
buf_Üd”
 = 
	`Üd”_ba£_2
(
	`roundup_pow_of_two
(
max_size
));

627 
”r
 = 
	`nå_ýp_»adq
(
ýp
, 
	`nå_»sourû_ýp_id
(
n¥
->
»s
),

628 
	`nå_»sourû_add»ss
(
n¥
->
»s
è+ 
NFP_CAP_CMD_DMA_SG
,

629 &
»g
);

630 ià(
”r
 < 0)

631  
”r
;

632 
sg_ok
 = 
»g
 & 
	`BIT_ULL
(
¬g
->¬g.
code
 - 1);

634 ià(!
sg_ok
) {

635 ià(
buf_Üd”
 > 
dma_Üd”
) {

636 
	`nå_”r
(
ýp
, "NSP: can't service‚on-SG DMA for command 0x%04x\n",

637 
¬g
->¬g.
code
);

638  -
ENOMEM
;

640 
chunk_Üd”
 = 
buf_Üd”
;

642 
chunk_Üd”
 = 
	`mš_t
(, 
dma_Üd”
, 
PAGE_SHIFT
);

645  
	`nå_n¥_commªd_buf_dma_sg
(
n¥
, 
¬g
, 
max_size
, 
chunk_Üd”
,

646 
dma_Üd”
);

647 
	}
}

650 
	$nå_n¥_commªd_buf
(
nå_n¥
 *
n¥
, 
nå_n¥_commªd_buf_¬g
 *
¬g
)

652 
dma_Üd”
, 
def_size
, 
max_size
;

653 
nå_ýp
 *
ýp
 = 
n¥
->cpp;

654 
u64
 
»g
;

655 
”r
;

657 ià(
n¥
->
v”
.
mšÜ
 < 13) {

658 
	`nå_”r
(
ýp
, "NSP: Code 0x%04x with buffer‚ot supported (ABI %hu.%hu)\n",

659 
¬g
->¬g.
code
, 
n¥
->
v”
.
majÜ
,‚¥->v”.
mšÜ
);

660  -
EOPNOTSUPP
;

663 
”r
 = 
	`nå_ýp_»adq
(
ýp
, 
	`nå_»sourû_ýp_id
(
n¥
->
»s
),

664 
	`nå_»sourû_add»ss
(
n¥
->
»s
) +

665 
NSP_DFLT_BUFFER_CONFIG
,

666 &
»g
);

667 ià(
”r
 < 0)

668  
”r
;

671 ià(
¬g
->
out_buf
 &&‡rg->
out_size
 &&‡rg->out_siz>‡rg->
š_size
)

672 
	`mem£t
(
¬g
->
out_buf
, 0,‡rg->
out_size
 -‡rg->
š_size
);

674 
max_size
 = 
	`max
(
¬g
->
š_size
,‡rg->
out_size
);

675 
def_size
 = 
	`FIELD_GET
(
NSP_DFLT_BUFFER_SIZE_MB
, 
»g
è* 
SZ_1M
 +

676 
	`FIELD_GET
(
NSP_DFLT_BUFFER_SIZE_4KB
, 
»g
è* 
SZ_4K
;

677 
dma_Üd”
 = 
	`FIELD_GET
(
NSP_DFLT_BUFFER_DMA_CHUNK_ORDER
, 
»g
);

678 ià(
def_size
 >ð
max_size
) {

679  
	`nå_n¥_commªd_buf_def
(
n¥
, 
¬g
);

680 } ià(!
dma_Üd”
) {

681 
	`nå_”r
(
ýp
, "NSP: default bufferoo small for command 0x%04x (%u < %u)\n",

682 
¬g
->¬g.
code
, 
def_size
, 
max_size
);

683  -
EINVAL
;

686  
	`nå_n¥_commªd_buf_dma
(
n¥
, 
¬g
, 
max_size
, 
dma_Üd”
);

687 
	}
}

689 
	$nå_n¥_wa™
(
nå_n¥
 *
¡©e
)

691 cÚ¡ 
wa™_uÁž
 = 
jiff›s
 + 
NFP_NSP_TIMEOUT_BOOT
 * 
HZ
;

692 
”r
;

694 
	`nå_dbg
(
¡©e
->
ýp
, "Waiting for NSPo„espond (%u sec max).\n",

695 
NFP_NSP_TIMEOUT_BOOT
);

698 cÚ¡ 
¡¬t_time
 = 
jiff›s
;

700 
”r
 = 
	`nå_n¥_commªd
(
¡©e
, 
SPCODE_NOOP
);

701 ià(
”r
 !ð-
EAGAIN
)

704 ià(
	`m¦“p_š‹¼u±ibË
(25)) {

705 
”r
 = -
ERESTARTSYS
;

709 ià(
	`time_aá”
(
¡¬t_time
, 
wa™_uÁž
)) {

710 
”r
 = -
ETIMEDOUT
;

714 ià(
”r
)

715 
	`nå_”r
(
¡©e
->
ýp
, "NSP fažedØ»¥Úd %d\n", 
”r
);

717  
”r
;

718 
	}
}

720 
	$nå_n¥_deviû_soá_»£t
(
nå_n¥
 *
¡©e
)

722  
	`nå_n¥_commªd
(
¡©e
, 
SPCODE_SOFT_RESET
);

723 
	}
}

725 
	$nå_n¥_mac_»š™
(
nå_n¥
 *
¡©e
)

727  
	`nå_n¥_commªd
(
¡©e
, 
SPCODE_MAC_INIT
);

728 
	}
}

730 
	$nå_n¥_lßd_fw_ex‹nded_msg
(
nå_n¥
 *
¡©e
, 
u32
 
»t_v®
)

732 cÚ¡ * cÚ¡ 
majÜ_msg
[] = {

737 cÚ¡ * cÚ¡ 
mšÜ_msg
[] = {

754 
majÜ
, 
mšÜ
;

755 cÚ¡ *
Ëv–
;

757 
majÜ
 = 
	`FIELD_GET
(
NFP_FW_LOAD_RET_MAJOR
, 
»t_v®
);

758 
mšÜ
 = 
	`FIELD_GET
(
NFP_FW_LOAD_RET_MINOR
, 
»t_v®
);

760 ià(!
	`nå_n¥_has_¡Üed_fw_lßd
(
¡©e
))

764 ià(
majÜ
 =ð0 && (
mšÜ
 == 0 || minor == 10))

765 
Ëv–
 = 
KERN_DEBUG
;

766 ià(
majÜ
 == 2)

767 
Ëv–
 = 
KERN_ERR
;

769 
Ëv–
 = 
KERN_INFO
;

771 ià(
majÜ
 >ð
	`ARRAY_SIZE
(
majÜ_msg
))

772 
	`nå_´štk
(
Ëv–
, 
¡©e
->
ýp
, "FW†oading status: %x\n",

773 
»t_v®
);

774 ià(
mšÜ
 >ð
	`ARRAY_SIZE
(
mšÜ_msg
))

775 
	`nå_´štk
(
Ëv–
, 
¡©e
->
ýp
, "%s,„eason code: %d\n",

776 
majÜ_msg
[
majÜ
], 
mšÜ
);

778 
	`nå_´štk
(
Ëv–
, 
¡©e
->
ýp
, "%s%c %s\n",

779 
majÜ_msg
[
majÜ
], 
mšÜ
 ? ',' : '.',

780 
mšÜ_msg
[
mšÜ
]);

781 
	}
}

783 
	$nå_n¥_lßd_fw
(
nå_n¥
 *
¡©e
, cÚ¡ 
fœmw¬e
 *
fw
)

785 
nå_n¥_commªd_buf_¬g
 
lßd_fw
 = {

787 .
code
 = 
SPCODE_FW_LOAD
,

788 .
ÝtiÚ
 = 
fw
->
size
,

789 .
”rÜ_cb
 = 
nå_n¥_lßd_fw_ex‹nded_msg
,

791 .
š_buf
 = 
fw
->
d©a
,

792 .
š_size
 = 
fw
->
size
,

794 
»t
;

796 
»t
 = 
	`nå_n¥_commªd_buf
(
¡©e
, &
lßd_fw
);

797 ià(
»t
 < 0)

798  
»t
;

800 
	`nå_n¥_lßd_fw_ex‹nded_msg
(
¡©e
, 
»t
);

802 
	}
}

804 
	$nå_n¥_wr™e_æash
(
nå_n¥
 *
¡©e
, cÚ¡ 
fœmw¬e
 *
fw
)

806 
nå_n¥_commªd_buf_¬g
 
wr™e_æash
 = {

808 .
code
 = 
SPCODE_NSP_WRITE_FLASH
,

809 .
ÝtiÚ
 = 
fw
->
size
,

810 .
timeout_£c
 = 900,

812 .
š_buf
 = 
fw
->
d©a
,

813 .
š_size
 = 
fw
->
size
,

816  
	`nå_n¥_commªd_buf
(
¡©e
, &
wr™e_æash
);

817 
	}
}

819 
	$nå_n¥_»ad_‘h_bË
(
nå_n¥
 *
¡©e
, *
buf
, 
size
)

821 
nå_n¥_commªd_buf_¬g
 
‘h_»sÿn
 = {

823 .
code
 = 
SPCODE_ETH_RESCAN
,

824 .
ÝtiÚ
 = 
size
,

826 .
out_buf
 = 
buf
,

827 .
out_size
 = 
size
,

830  
	`nå_n¥_commªd_buf
(
¡©e
, &
‘h_»sÿn
);

831 
	}
}

833 
	$nå_n¥_wr™e_‘h_bË
(
nå_n¥
 *
¡©e
,

834 cÚ¡ *
buf
, 
size
)

836 
nå_n¥_commªd_buf_¬g
 
‘h_ù¾
 = {

838 .
code
 = 
SPCODE_ETH_CONTROL
,

839 .
ÝtiÚ
 = 
size
,

841 .
š_buf
 = 
buf
,

842 .
š_size
 = 
size
,

845  
	`nå_n¥_commªd_buf
(
¡©e
, &
‘h_ù¾
);

846 
	}
}

848 
	$nå_n¥_»ad_id’tify
(
nå_n¥
 *
¡©e
, *
buf
, 
size
)

850 
nå_n¥_commªd_buf_¬g
 
id’tify
 = {

852 .
code
 = 
SPCODE_NSP_IDENTIFY
,

853 .
ÝtiÚ
 = 
size
,

855 .
out_buf
 = 
buf
,

856 .
out_size
 = 
size
,

859  
	`nå_n¥_commªd_buf
(
¡©e
, &
id’tify
);

860 
	}
}

862 
	$nå_n¥_»ad_£nsÜs
(
nå_n¥
 *
¡©e
, 
£nsÜ_mask
,

863 *
buf
, 
size
)

865 
nå_n¥_commªd_buf_¬g
 
£nsÜs
 = {

867 .
code
 = 
SPCODE_NSP_SENSORS
,

868 .
ÝtiÚ
 = 
£nsÜ_mask
,

870 .
out_buf
 = 
buf
,

871 .
out_size
 = 
size
,

874  
	`nå_n¥_commªd_buf
(
¡©e
, &
£nsÜs
);

875 
	}
}

877 
	$nå_n¥_lßd_¡Üed_fw
(
nå_n¥
 *
¡©e
)

879 cÚ¡ 
nå_n¥_commªd_¬g
 
¬g
 = {

880 .
code
 = 
SPCODE_FW_STORED
,

881 .
”rÜ_cb
 = 
nå_n¥_lßd_fw_ex‹nded_msg
,

883 
»t
;

885 
»t
 = 
	`__nå_n¥_commªd
(
¡©e
, &
¬g
);

886 ià(
»t
 < 0)

887  
»t
;

889 
	`nå_n¥_lßd_fw_ex‹nded_msg
(
¡©e
, 
»t
);

891 
	}
}

894 
	$__nå_n¥_hwšfo_lookup
(
nå_n¥
 *
¡©e
, *
buf
, 
size
)

896 
nå_n¥_commªd_buf_¬g
 
hwšfo_lookup
 = {

898 .
code
 = 
SPCODE_HWINFO_LOOKUP
,

899 .
ÝtiÚ
 = 
size
,

901 .
š_buf
 = 
buf
,

902 .
š_size
 = 
size
,

903 .
out_buf
 = 
buf
,

904 .
out_size
 = 
size
,

907  
	`nå_n¥_commªd_buf
(
¡©e
, &
hwšfo_lookup
);

908 
	}
}

910 
	$nå_n¥_hwšfo_lookup
(
nå_n¥
 *
¡©e
, *
buf
, 
size
)

912 
”r
;

914 
size
 = 
	`mš_t
(
u32
, size, 
NFP_HWINFO_LOOKUP_SIZE
);

916 
”r
 = 
	`__nå_n¥_hwšfo_lookup
(
¡©e
, 
buf
, 
size
);

917 ià(
”r
)

918  
”r
;

920 ià(
	`¡ºËn
(
buf
, 
size
) == size) {

921 
	`nå_”r
(
¡©e
->
ýp
, "NSP HWinfo value‚ot NULL-terminated\n");

922  -
EINVAL
;

926 
	}
}

928 
	$nå_n¥_v”siÚs
(
nå_n¥
 *
¡©e
, *
buf
, 
size
)

930 
nå_n¥_commªd_buf_¬g
 
v”siÚs
 = {

932 .
code
 = 
SPCODE_VERSIONS
,

933 .
ÝtiÚ
 = 
	`mš_t
(
u32
, 
size
, 
NFP_VERSIONS_SIZE
),

935 .
out_buf
 = 
buf
,

936 .
out_size
 = 
	`mš_t
(
u32
, 
size
, 
NFP_VERSIONS_SIZE
),

939  
	`nå_n¥_commªd_buf
(
¡©e
, &
v”siÚs
);

940 
	}
}

942 cÚ¡ *
	$nå_n¥_v”siÚs_g‘
(
nå_n¥_v”siÚs
 
id
, 
boÞ
 
æash
,

943 cÚ¡ 
u8
 *
buf
, 
size
)

945 cÚ¡ 
u32
 
id2off
[] = {

946 [
NFP_VERSIONS_BSP
] = 
NFP_VERSIONS_BSP_OFF
,

947 [
NFP_VERSIONS_CPLD
] = 
NFP_VERSIONS_CPLD_OFF
,

948 [
NFP_VERSIONS_APP
] = 
NFP_VERSIONS_APP_OFF
,

949 [
NFP_VERSIONS_BUNDLE
] = 
NFP_VERSIONS_BUNDLE_OFF
,

950 [
NFP_VERSIONS_UNDI
] = 
NFP_VERSIONS_UNDI_OFF
,

951 [
NFP_VERSIONS_NCSI
] = 
NFP_VERSIONS_NCSI_OFF
,

952 [
NFP_VERSIONS_CFGR
] = 
NFP_VERSIONS_CFGR_OFF
,

954 
f›ld
, 
buf_f›ld_út
, 
buf_off
;

956 ià(
id
 >ð
	`ARRAY_SIZE
(
id2off
) || !id2off[id])

957  
	`ERR_PTR
(-
EINVAL
);

959 
f›ld
 = 
id
 * 2 + 
æash
;

961 
buf_f›ld_út
 = 
	`g‘_uÇligÃd_Ë16
(
buf
);

962 ià(
buf_f›ld_út
 <ð
f›ld
)

963  
	`ERR_PTR
(-
ENOENT
);

965 
buf_off
 = 
	`g‘_uÇligÃd_Ë16
(
buf
 + 
id2off
[
id
] + 
æash
 * 2);

966 ià(!
buf_off
)

967  
	`ERR_PTR
(-
ENOENT
);

969 ià(
buf_off
 >ð
size
)

970  
	`ERR_PTR
(-
EINVAL
);

971 ià(
	`¡ºËn
(&
buf
[
buf_off
], 
size
 - buf_off) == size - buf_off)

972  
	`ERR_PTR
(-
EINVAL
);

974  (cÚ¡ *)&
buf
[
buf_off
];

975 
	}
}

978 
	$__nå_n¥_moduË_“´om
(
nå_n¥
 *
¡©e
, *
buf
, 
size
)

980 
nå_n¥_commªd_buf_¬g
 
moduË_“´om
 = {

982 .
code
 = 
SPCODE_READ_SFF_EEPROM
,

983 .
ÝtiÚ
 = 
size
,

985 .
š_buf
 = 
buf
,

986 .
š_size
 = 
size
,

987 .
out_buf
 = 
buf
,

988 .
out_size
 = 
size
,

991  
	`nå_n¥_commªd_buf
(
¡©e
, &
moduË_“´om
);

992 
	}
}

994 
	$nå_n¥_»ad_moduË_“´om
(
nå_n¥
 *
¡©e
, 
‘h_šdex
,

995 
off£t
, *
d©a
,

996 
Ën
, *
»ad_Ën
)

998 
	s“´om_buf
 {

999 
u8
 
m‘®’
;

1000 
__Ë16
 
Ëngth
;

1001 
__Ë16
 
off£t
;

1002 
__Ë16
 
»adËn
;

1003 
u8
 
‘h_šdex
;

1004 
u8
 
d©a
[0];

1005 } 
__·cked
 *
buf
;

1006 
bufsz
, 
»t
;

1008 
	`BUILD_BUG_ON
(
	`off£tof
(
“´om_buf
, 
d©a
) % 8);

1011 
bufsz
 = 
	`¡ruù_size
(
buf
, 
d©a
, 
	`round_up
(
Ën
, 
NSP_SFF_EEPROM_BLOCK_LEN
));

1012 
buf
 = 
	`kz®loc
(
bufsz
, 
GFP_KERNEL
);

1013 ià(!
buf
)

1014  -
ENOMEM
;

1016 
buf
->
m‘®’
 =

1017 
	`off£tof
(
“´om_buf
, 
d©a
è/ 
NSP_SFF_EEPROM_BLOCK_LEN
;

1018 
buf
->
Ëngth
 = 
	`ýu_to_Ë16
(
Ën
);

1019 
buf
->
off£t
 = 
	`ýu_to_Ë16
(offset);

1020 
buf
->
‘h_šdex
 =ƒth_index;

1022 
»t
 = 
	`__nå_n¥_moduË_“´om
(
¡©e
, 
buf
, 
bufsz
);

1024 *
»ad_Ën
 = 
	`mš_t
(, 
Ën
, 
	`Ë16_to_ýu
(
buf
->
»adËn
));

1025 ià(*
»ad_Ën
)

1026 
	`memýy
(
d©a
, 
buf
->d©a, *
»ad_Ën
);

1028 ià(!
»t
 && *
»ad_Ën
 < 
Ën
)

1029 
»t
 = -
EIO
;

1031 
	`kä“
(
buf
);

1033  
»t
;

1034 
	}
}

	@src/nfpcore/nfp_nsp.h

4 #iâdeà
NSP_NSP_H


5 
	#NSP_NSP_H
 1

	)

7 
	~<lšux/ty³s.h
>

8 
	~<lšux/if_‘h”.h
>

10 
	gfœmw¬e
;

11 
	gnå_ýp
;

12 
	gnå_n¥
;

14 
nå_n¥
 *
nå_n¥_Ý’
(
nå_ýp
 *
ýp
);

15 
nå_n¥_þo£
(
nå_n¥
 *
¡©e
);

16 
u16
 
nå_n¥_g‘_abi_v”_majÜ
(
nå_n¥
 *
¡©e
);

17 
u16
 
nå_n¥_g‘_abi_v”_mšÜ
(
nå_n¥
 *
¡©e
);

18 
nå_n¥_wa™
(
nå_n¥
 *
¡©e
);

19 
nå_n¥_deviû_soá_»£t
(
nå_n¥
 *
¡©e
);

20 
nå_n¥_lßd_fw
(
nå_n¥
 *
¡©e
, cÚ¡ 
fœmw¬e
 *
fw
);

21 
nå_n¥_wr™e_æash
(
nå_n¥
 *
¡©e
, cÚ¡ 
fœmw¬e
 *
fw
);

22 
nå_n¥_mac_»š™
(
nå_n¥
 *
¡©e
);

23 
nå_n¥_lßd_¡Üed_fw
(
nå_n¥
 *
¡©e
);

24 
nå_n¥_hwšfo_lookup
(
nå_n¥
 *
¡©e
, *
buf
, 
size
);

25 
nå_n¥_»ad_moduË_“´om
(
nå_n¥
 *
¡©e
, 
‘h_šdex
,

26 
off£t
, *
d©a
,

27 
Ën
, *
»ad_Ën
);

29 
šlše
 
boÞ
 
	$nå_n¥_has_mac_»š™
(
nå_n¥
 *
¡©e
)

31  
	`nå_n¥_g‘_abi_v”_mšÜ
(
¡©e
) > 20;

32 
	}
}

34 
šlše
 
boÞ
 
	$nå_n¥_has_¡Üed_fw_lßd
(
nå_n¥
 *
¡©e
)

36  
	`nå_n¥_g‘_abi_v”_mšÜ
(
¡©e
) > 23;

37 
	}
}

39 
šlše
 
boÞ
 
	$nå_n¥_has_hwšfo_lookup
(
nå_n¥
 *
¡©e
)

41  
	`nå_n¥_g‘_abi_v”_mšÜ
(
¡©e
) > 24;

42 
	}
}

44 
šlše
 
boÞ
 
	$nå_n¥_has_v”siÚs
(
nå_n¥
 *
¡©e
)

46  
	`nå_n¥_g‘_abi_v”_mšÜ
(
¡©e
) > 27;

47 
	}
}

49 
šlše
 
boÞ
 
	$nå_n¥_has_»ad_moduË_“´om
(
nå_n¥
 *
¡©e
)

51  
	`nå_n¥_g‘_abi_v”_mšÜ
(
¡©e
) > 28;

52 
	}
}

54 
	enå_‘h_š‹rçû
 {

55 
	mNFP_INTERFACE_NONE
 = 0,

56 
	mNFP_INTERFACE_SFP
 = 1,

57 
	mNFP_INTERFACE_SFPP
 = 10,

58 
	mNFP_INTERFACE_SFP28
 = 28,

59 
	mNFP_INTERFACE_QSFP
 = 40,

60 
	mNFP_INTERFACE_RJ45
 = 45,

61 
	mNFP_INTERFACE_CXP
 = 100,

62 
	mNFP_INTERFACE_QSFP28
 = 112,

65 
	enå_‘h_medŸ
 {

66 
	mNFP_MEDIA_DAC_PASSIVE
 = 0,

67 
	mNFP_MEDIA_DAC_ACTIVE
,

68 
	mNFP_MEDIA_FIBRE
,

71 
	enå_‘h_ªeg
 {

72 
	mNFP_ANEG_AUTO
 = 0,

73 
	mNFP_ANEG_SEARCH
,

74 
	mNFP_ANEG_25G_CONSORTIUM
,

75 
	mNFP_ANEG_25G_IEEE
,

76 
	mNFP_ANEG_DISABLED
,

79 
	enå_‘h_ãc
 {

80 
	mNFP_FEC_AUTO_BIT
 = 0,

81 
	mNFP_FEC_BASER_BIT
,

82 
	mNFP_FEC_REED_SOLOMON_BIT
,

83 
	mNFP_FEC_DISABLED_BIT
,

86 
	#NFP_FEC_AUTO
 
	`BIT
(
NFP_FEC_AUTO_BIT
)

	)

87 
	#NFP_FEC_BASER
 
	`BIT
(
NFP_FEC_BASER_BIT
)

	)

88 
	#NFP_FEC_REED_SOLOMON
 
	`BIT
(
NFP_FEC_REED_SOLOMON_BIT
)

	)

89 
	#NFP_FEC_DISABLED
 
	`BIT
(
NFP_FEC_DISABLED_BIT
)

	)

121 
	snå_‘h_bË
 {

122 
	mcouÁ
;

123 
	mmax_šdex
;

124 
	snå_‘h_bË_pÜt
 {

125 
	m‘h_šdex
;

126 
	mšdex
;

127 
	mnbi
;

128 
	mba£
;

129 
	mÏÃs
;

130 
	m¥“d
;

132 
	mš‹rçû
;

133 
nå_‘h_medŸ
 
	mmedŸ
;

135 
nå_‘h_ãc
 
	mãc
;

136 
nå_‘h_ªeg
 
	mªeg
;

138 
u8
 
	mmac_addr
[
ETH_ALEN
];

140 
u8
 
	mÏb–_pÜt
;

141 
u8
 
	mÏb–_subpÜt
;

143 
boÞ
 
	m’abËd
;

144 
boÞ
 
	mtx_’abËd
;

145 
boÞ
 
	mrx_’abËd
;

147 
boÞ
 
	mov”ride_chªged
;

150 
u8
 
	mpÜt_ty³
;

152 
	mpÜt_ÏÃs
;

154 
boÞ
 
	mis_¥l™
;

156 
	mãc_modes_suµÜ‹d
;

157 } 
	mpÜts
[0];

160 
nå_‘h_bË
 *
nå_‘h_»ad_pÜts
(
nå_ýp
 *
ýp
);

161 
nå_‘h_bË
 *

162 
__nå_‘h_»ad_pÜts
(
nå_ýp
 *
ýp
, 
nå_n¥
 *
n¥
);

164 
nå_‘h_£t_mod_’abË
(
nå_ýp
 *
ýp
, 
idx
, 
boÞ
 
’abË
);

165 
nå_‘h_£t_cÚfigu»d
(
nå_ýp
 *
ýp
, 
idx
,

166 
boÞ
 
cÚfiged
);

168 
nå_‘h_£t_ãc
(
nå_ýp
 *
ýp
, 
idx
, 
nå_‘h_ãc
 
mode
);

170 
šlše
 
boÞ
 
	$nå_‘h_ÿn_suµÜt_ãc
(
nå_‘h_bË_pÜt
 *
‘h_pÜt
)

172  !!
‘h_pÜt
->
ãc_modes_suµÜ‹d
;

173 
	}
}

175 
šlše
 

176 
	$nå_‘h_suµÜ‹d_ãc_modes
(
nå_‘h_bË_pÜt
 *
‘h_pÜt
)

178  
‘h_pÜt
->
ãc_modes_suµÜ‹d
;

179 
	}
}

181 
nå_n¥
 *
nå_‘h_cÚfig_¡¬t
(
nå_ýp
 *
ýp
, 
idx
);

182 
nå_‘h_cÚfig_comm™_’d
(
nå_n¥
 *
n¥
);

183 
nå_‘h_cÚfig_þ—nup_’d
(
nå_n¥
 *
n¥
);

185 
__nå_‘h_£t_ªeg
(
nå_n¥
 *
n¥
, 
nå_‘h_ªeg
 
mode
);

186 
__nå_‘h_£t_¥“d
(
nå_n¥
 *
n¥
, 
¥“d
);

187 
__nå_‘h_£t_¥l™
(
nå_n¥
 *
n¥
, 
ÏÃs
);

201 
	snå_n¥_id’tify
 {

202 
	mv”siÚ
[40];

203 
u8
 
	mæags
;

204 
u8
 
	mbr_´im¬y
;

205 
u8
 
	mbr_£cÚd¬y
;

206 
u8
 
	mbr_n¥
;

207 
u16
 
	m´im¬y
;

208 
u16
 
	m£cÚd¬y
;

209 
u16
 
	mn¥
;

210 
u64
 
	m£nsÜ_mask
;

213 
nå_n¥_id’tify
 *
__nå_n¥_id’tify
(
nå_n¥
 *
n¥
);

215 
	enå_n¥_£nsÜ_id
 {

216 
	mNFP_SENSOR_CHIP_TEMPERATURE
,

217 
	mNFP_SENSOR_ASSEMBLY_POWER
,

218 
	mNFP_SENSOR_ASSEMBLY_12V_POWER
,

219 
	mNFP_SENSOR_ASSEMBLY_3V3_POWER
,

222 
nå_hwmÚ_»ad_£nsÜ
(
nå_ýp
 *
ýp
, 
nå_n¥_£nsÜ_id
 
id
,

223 *
v®
);

225 
	#NFP_NSP_VERSION_BUFSZ
 1024

	)

227 
	enå_n¥_v”siÚs
 {

228 
	mNFP_VERSIONS_BSP
,

229 
	mNFP_VERSIONS_CPLD
,

230 
	mNFP_VERSIONS_APP
,

231 
	mNFP_VERSIONS_BUNDLE
,

232 
	mNFP_VERSIONS_UNDI
,

233 
	mNFP_VERSIONS_NCSI
,

234 
	mNFP_VERSIONS_CFGR
,

237 
nå_n¥_v”siÚs
(
nå_n¥
 *
¡©e
, *
buf
, 
size
);

238 cÚ¡ *
nå_n¥_v”siÚs_g‘
(
nå_n¥_v”siÚs
 
id
, 
boÞ
 
æash
,

239 cÚ¡ 
u8
 *
buf
, 
size
);

	@src/nfpcore/nfp_nsp_cmds.c

4 
	~<lšux/k”Ãl.h
>

5 
	~<lšux/¦ab.h
>

7 
	~"nå.h
"

8 
	~"nå_n¥.h
"

10 
	sn¥_id’tify
 {

11 
u8
 
	mv”siÚ
[40];

12 
u8
 
	mæags
;

13 
u8
 
	mbr_´im¬y
;

14 
u8
 
	mbr_£cÚd¬y
;

15 
u8
 
	mbr_n¥
;

16 
__Ë16
 
	m´im¬y
;

17 
__Ë16
 
	m£cÚd¬y
;

18 
__Ë16
 
	mn¥
;

19 
u8
 
	m»£rved
[6];

20 
__Ë64
 
	m£nsÜ_mask
;

23 
nå_n¥_id’tify
 *
	$__nå_n¥_id’tify
(
nå_n¥
 *
n¥
)

25 
nå_n¥_id’tify
 *
n¥i
 = 
NULL
;

26 
n¥_id’tify
 *
ni
;

27 
»t
;

29 ià(
	`nå_n¥_g‘_abi_v”_mšÜ
(
n¥
) < 15)

30  
NULL
;

32 
ni
 = 
	`kz®loc
((*ni), 
GFP_KERNEL
);

33 ià(!
ni
)

34  
NULL
;

36 
»t
 = 
	`nå_n¥_»ad_id’tify
(
n¥
, 
ni
, (*ni));

37 ià(
»t
 < 0) {

38 
	`nå_”r
(
	`nå_n¥_ýp
(
n¥
), "reading bsp version failed %d\n",

39 
»t
);

40 
ex™_ä“
;

43 
n¥i
 = 
	`kz®loc
((*n¥i), 
GFP_KERNEL
);

44 ià(!
n¥i
)

45 
ex™_ä“
;

47 
	`memýy
(
n¥i
->
v”siÚ
, 
ni
->version, (nspi->version));

48 
n¥i
->
v”siÚ
[(nspi->version) - 1] = '\0';

49 
n¥i
->
æags
 = 
ni
->flags;

50 
n¥i
->
br_´im¬y
 = 
ni
->br_primary;

51 
n¥i
->
br_£cÚd¬y
 = 
ni
->br_secondary;

52 
n¥i
->
br_n¥
 = 
ni
->br_nsp;

53 
n¥i
->
´im¬y
 = 
	`Ë16_to_ýu
(
ni
->primary);

54 
n¥i
->
£cÚd¬y
 = 
	`Ë16_to_ýu
(
ni
->secondary);

55 
n¥i
->
n¥
 = 
	`Ë16_to_ýu
(
ni
->nsp);

56 
n¥i
->
£nsÜ_mask
 = 
	`Ë64_to_ýu
(
ni
->sensor_mask);

58 
ex™_ä“
:

59 
	`kä“
(
ni
);

60  
n¥i
;

61 
	}
}

63 
	snå_£nsÜs
 {

64 
__Ë32
 
	mch_‹mp
;

65 
__Ë32
 
	mas£mbly_pow”
;

66 
__Ë32
 
	mas£mbly_12v_pow”
;

67 
__Ë32
 
	mas£mbly_3v3_pow”
;

70 
	$nå_hwmÚ_»ad_£nsÜ
(
nå_ýp
 *
ýp
, 
nå_n¥_£nsÜ_id
 
id
,

71 *
v®
)

73 
nå_£nsÜs
 
s
;

74 
nå_n¥
 *
n¥
;

75 
»t
;

77 
n¥
 = 
	`nå_n¥_Ý’
(
ýp
);

78 ià(
	`IS_ERR
(
n¥
))

79  
	`PTR_ERR
(
n¥
);

81 
»t
 = 
	`nå_n¥_»ad_£nsÜs
(
n¥
, 
	`BIT
(
id
), &
s
, (s));

82 
	`nå_n¥_þo£
(
n¥
);

84 ià(
»t
 < 0)

85  
»t
;

87 
id
) {

88 
NFP_SENSOR_CHIP_TEMPERATURE
:

89 *
v®
 = 
	`Ë32_to_ýu
(
s
.
ch_‹mp
);

91 
NFP_SENSOR_ASSEMBLY_POWER
:

92 *
v®
 = 
	`Ë32_to_ýu
(
s
.
as£mbly_pow”
);

94 
NFP_SENSOR_ASSEMBLY_12V_POWER
:

95 *
v®
 = 
	`Ë32_to_ýu
(
s
.
as£mbly_12v_pow”
);

97 
NFP_SENSOR_ASSEMBLY_3V3_POWER
:

98 *
v®
 = 
	`Ë32_to_ýu
(
s
.
as£mbly_3v3_pow”
);

101  -
EINVAL
;

104 
	}
}

	@src/nfpcore/nfp_nsp_eth.c

8 
	~"../nå_Ãt_com·t.h
"

10 #ià
VER_NON_RHEL_GE
(4, 9è|| 
VER_RHEL_GE
(7, 5)

11 
	~<lšux/b™f›ld.h
>

13 
	~<lšux/‘htoÞ.h
>

14 
	~<lšux/if_‘h”.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/moduË.h
>

18 
	~"nå.h
"

19 
	~"nå_n¥.h
"

20 
	~"nå6000/nå6000.h
"

22 
	#NSP_ETH_NBI_PORT_COUNT
 24

	)

23 
	#NSP_ETH_MAX_COUNT
 (2 * 
NSP_ETH_NBI_PORT_COUNT
)

	)

24 
	#NSP_ETH_TABLE_SIZE
 (
NSP_ETH_MAX_COUNT
 * \

25 (
‘h_bË_’Œy
))

	)

27 
	#NSP_ETH_PORT_LANES
 
	`GENMASK_ULL
(3, 0)

	)

28 
	#NSP_ETH_PORT_INDEX
 
	`GENMASK_ULL
(15, 8)

	)

29 
	#NSP_ETH_PORT_LABEL
 
	`GENMASK_ULL
(53, 48)

	)

30 
	#NSP_ETH_PORT_PHYLABEL
 
	`GENMASK_ULL
(59, 54)

	)

31 
	#NSP_ETH_PORT_FEC_SUPP_BASER
 
	`BIT_ULL
(60)

	)

32 
	#NSP_ETH_PORT_FEC_SUPP_RS
 
	`BIT_ULL
(61)

	)

34 
	#NSP_ETH_PORT_LANES_MASK
 
	`ýu_to_Ë64
(
NSP_ETH_PORT_LANES
)

	)

36 
	#NSP_ETH_STATE_CONFIGURED
 
	`BIT_ULL
(0)

	)

37 
	#NSP_ETH_STATE_ENABLED
 
	`BIT_ULL
(1)

	)

38 
	#NSP_ETH_STATE_TX_ENABLED
 
	`BIT_ULL
(2)

	)

39 
	#NSP_ETH_STATE_RX_ENABLED
 
	`BIT_ULL
(3)

	)

40 
	#NSP_ETH_STATE_RATE
 
	`GENMASK_ULL
(11, 8)

	)

41 
	#NSP_ETH_STATE_INTERFACE
 
	`GENMASK_ULL
(19, 12)

	)

42 
	#NSP_ETH_STATE_MEDIA
 
	`GENMASK_ULL
(21, 20)

	)

43 
	#NSP_ETH_STATE_OVRD_CHNG
 
	`BIT_ULL
(22)

	)

44 
	#NSP_ETH_STATE_ANEG
 
	`GENMASK_ULL
(25, 23)

	)

45 
	#NSP_ETH_STATE_FEC
 
	`GENMASK_ULL
(27, 26)

	)

47 
	#NSP_ETH_CTRL_CONFIGURED
 
	`BIT_ULL
(0)

	)

48 
	#NSP_ETH_CTRL_ENABLED
 
	`BIT_ULL
(1)

	)

49 
	#NSP_ETH_CTRL_TX_ENABLED
 
	`BIT_ULL
(2)

	)

50 
	#NSP_ETH_CTRL_RX_ENABLED
 
	`BIT_ULL
(3)

	)

51 
	#NSP_ETH_CTRL_SET_RATE
 
	`BIT_ULL
(4)

	)

52 
	#NSP_ETH_CTRL_SET_LANES
 
	`BIT_ULL
(5)

	)

53 
	#NSP_ETH_CTRL_SET_ANEG
 
	`BIT_ULL
(6)

	)

54 
	#NSP_ETH_CTRL_SET_FEC
 
	`BIT_ULL
(7)

	)

56 
	enå_‘h_¿w
 {

57 
	mNSP_ETH_RAW_PORT
 = 0,

58 
	mNSP_ETH_RAW_STATE
,

59 
	mNSP_ETH_RAW_MAC
,

60 
	mNSP_ETH_RAW_CONTROL
,

62 
	mNSP_ETH_NUM_RAW


65 
	enå_‘h_¿‹
 {

66 
	mRATE_INVALID
 = 0,

67 
	mRATE_10M
,

68 
	mRATE_100M
,

69 
	mRATE_1G
,

70 
	mRATE_10G
,

71 
	mRATE_25G
,

74 
	u‘h_bË_’Œy
 {

76 
__Ë64
 
	mpÜt
;

77 
__Ë64
 
	m¡©e
;

78 
u8
 
	mmac_addr
[6];

79 
u8
 
	m»sv
[2];

80 
__Ë64
 
	mcÚŒÞ
;

82 
__Ë64
 
	m¿w
[
NSP_ETH_NUM_RAW
];

86 
nå_‘h_¿‹
 
	m¿‹
;

87 
	m¥“d
;

88 } 
	gn¥_‘h_¿‹_tbl
[] = {

89 { 
RATE_INVALID
, 0, },

90 { 
RATE_10M
, 
SPEED_10
, },

91 { 
RATE_100M
, 
SPEED_100
, },

92 { 
RATE_1G
, 
SPEED_1000
, },

93 { 
RATE_10G
, 
SPEED_10000
, },

94 { 
RATE_25G
, 
SPEED_25000
, },

97 
	$nå_‘h_¿‹2¥“d
(
nå_‘h_¿‹
 
¿‹
)

99 
i
;

101 
i
 = 0; i < 
	`ARRAY_SIZE
(
n¥_‘h_¿‹_tbl
); i++)

102 ià(
n¥_‘h_¿‹_tbl
[
i
].
¿‹
 ==„ate)

103  
n¥_‘h_¿‹_tbl
[
i
].
¥“d
;

106 
	}
}

108 
	$nå_‘h_¥“d2¿‹
(
¥“d
)

110 
i
;

112 
i
 = 0; i < 
	`ARRAY_SIZE
(
n¥_‘h_¿‹_tbl
); i++)

113 ià(
n¥_‘h_¿‹_tbl
[
i
].
¥“d
 == speed)

114  
n¥_‘h_¿‹_tbl
[
i
].
¿‹
;

116  
RATE_INVALID
;

117 
	}
}

119 
	$nå_‘h_cÝy_mac_»v”£
(
u8
 *
d¡
, cÚ¡ u8 *
¤c
)

121 
i
;

123 
i
 = 0; i < 
ETH_ALEN
; i++)

124 
d¡
[
ETH_ALEN
 - 
i
 - 1] = 
¤c
[i];

125 
	}
}

128 
	$nå_‘h_pÜt_Œª¦©e
(
nå_n¥
 *
n¥
, cÚ¡ 
‘h_bË_’Œy
 *
¤c
,

129 
šdex
, 
nå_‘h_bË_pÜt
 *
d¡
)

131 
¿‹
;

132 
ãc
;

133 
u64
 
pÜt
, 
¡©e
;

135 
pÜt
 = 
	`Ë64_to_ýu
(
¤c
->port);

136 
¡©e
 = 
	`Ë64_to_ýu
(
¤c
->state);

138 
d¡
->
‘h_šdex
 = 
	`FIELD_GET
(
NSP_ETH_PORT_INDEX
, 
pÜt
);

139 
d¡
->
šdex
 = index;

140 
d¡
->
nbi
 = 
šdex
 / 
NSP_ETH_NBI_PORT_COUNT
;

141 
d¡
->
ba£
 = 
šdex
 % 
NSP_ETH_NBI_PORT_COUNT
;

142 
d¡
->
ÏÃs
 = 
	`FIELD_GET
(
NSP_ETH_PORT_LANES
, 
pÜt
);

144 
d¡
->
’abËd
 = 
	`FIELD_GET
(
NSP_ETH_STATE_ENABLED
, 
¡©e
);

145 
d¡
->
tx_’abËd
 = 
	`FIELD_GET
(
NSP_ETH_STATE_TX_ENABLED
, 
¡©e
);

146 
d¡
->
rx_’abËd
 = 
	`FIELD_GET
(
NSP_ETH_STATE_RX_ENABLED
, 
¡©e
);

148 
¿‹
 = 
	`nå_‘h_¿‹2¥“d
(
	`FIELD_GET
(
NSP_ETH_STATE_RATE
, 
¡©e
));

149 
d¡
->
¥“d
 = d¡->
ÏÃs
 * 
¿‹
;

151 
d¡
->
š‹rçû
 = 
	`FIELD_GET
(
NSP_ETH_STATE_INTERFACE
, 
¡©e
);

152 
d¡
->
medŸ
 = 
	`FIELD_GET
(
NSP_ETH_STATE_MEDIA
, 
¡©e
);

154 
	`nå_‘h_cÝy_mac_»v”£
(
d¡
->
mac_addr
, 
¤c
->mac_addr);

156 
d¡
->
Ïb–_pÜt
 = 
	`FIELD_GET
(
NSP_ETH_PORT_PHYLABEL
, 
pÜt
);

157 
d¡
->
Ïb–_subpÜt
 = 
	`FIELD_GET
(
NSP_ETH_PORT_LABEL
, 
pÜt
);

159 ià(
	`nå_n¥_g‘_abi_v”_mšÜ
(
n¥
) < 17)

162 
d¡
->
ov”ride_chªged
 = 
	`FIELD_GET
(
NSP_ETH_STATE_OVRD_CHNG
, 
¡©e
);

163 
d¡
->
ªeg
 = 
	`FIELD_GET
(
NSP_ETH_STATE_ANEG
, 
¡©e
);

165 ià(
	`nå_n¥_g‘_abi_v”_mšÜ
(
n¥
) < 22)

168 
ãc
 = 
	`FIELD_GET
(
NSP_ETH_PORT_FEC_SUPP_BASER
, 
pÜt
);

169 
d¡
->
ãc_modes_suµÜ‹d
 |ð
ãc
 << 
NFP_FEC_BASER_BIT
;

170 
ãc
 = 
	`FIELD_GET
(
NSP_ETH_PORT_FEC_SUPP_RS
, 
pÜt
);

171 
d¡
->
ãc_modes_suµÜ‹d
 |ð
ãc
 << 
NFP_FEC_REED_SOLOMON_BIT
;

172 ià(
d¡
->
ãc_modes_suµÜ‹d
)

173 
d¡
->
ãc_modes_suµÜ‹d
 |ð
NFP_FEC_AUTO
 | 
NFP_FEC_DISABLED
;

175 
d¡
->
ãc
 = 1 << 
	`FIELD_GET
(
NSP_ETH_STATE_FEC
, 
¡©e
);

176 
	}
}

179 
	$nå_‘h_ÿlc_pÜt_geom‘ry
(
nå_ýp
 *
ýp
, 
nå_‘h_bË
 *
bË
)

181 
i
, 
j
;

183 
i
 = 0; i < 
bË
->
couÁ
; i++) {

184 
bË
->
max_šdex
 = 
	`max
ÑabË->max_šdex,abË->
pÜts
[
i
].
šdex
);

186 
j
 = 0; j < 
bË
->
couÁ
; j++) {

187 ià(
bË
->
pÜts
[
i
].
Ïb–_pÜt
 !=

188 
bË
->
pÜts
[
j
].
Ïb–_pÜt
)

190 
bË
->
pÜts
[
i
].
pÜt_ÏÃs
 +ðbË->pÜts[
j
].
ÏÃs
;

192 ià(
i
 =ð
j
)

194 ià(
bË
->
pÜts
[
i
].
Ïb–_subpÜt
 ==

195 
bË
->
pÜts
[
j
].
Ïb–_subpÜt
)

196 
	`nå_w¬n
(
ýp
,

198 
bË
->
pÜts
[
i
].
Ïb–_pÜt
,

199 
bË
->
pÜts
[
i
].
Ïb–_subpÜt
);

201 
bË
->
pÜts
[
i
].
is_¥l™
 = 
Œue
;

204 
	}
}

207 
	$nå_‘h_ÿlc_pÜt_ty³
(
nå_ýp
 *
ýp
, 
nå_‘h_bË_pÜt
 *
’Œy
)

209 ià(
’Œy
->
š‹rçû
 =ð
NFP_INTERFACE_NONE
) {

210 
’Œy
->
pÜt_ty³
 = 
PORT_NONE
;

212 } ià(
’Œy
->
š‹rçû
 =ð
NFP_INTERFACE_RJ45
) {

213 
’Œy
->
pÜt_ty³
 = 
PORT_TP
;

217 ià(
’Œy
->
medŸ
 =ð
NFP_MEDIA_FIBRE
)

218 
’Œy
->
pÜt_ty³
 = 
PORT_FIBRE
;

220 
’Œy
->
pÜt_ty³
 = 
PORT_DA
;

221 
	}
}

232 
nå_‘h_bË
 *
	$nå_‘h_»ad_pÜts
(
nå_ýp
 *
ýp
)

234 
nå_‘h_bË
 *
»t
;

235 
nå_n¥
 *
n¥
;

237 
n¥
 = 
	`nå_n¥_Ý’
(
ýp
);

238 ià(
	`IS_ERR
(
n¥
))

239  
NULL
;

241 
»t
 = 
	`__nå_‘h_»ad_pÜts
(
ýp
, 
n¥
);

242 
	`nå_n¥_þo£
(
n¥
);

244  
»t
;

245 
	}
}

247 
nå_‘h_bË
 *

248 
	$__nå_‘h_»ad_pÜts
(
nå_ýp
 *
ýp
, 
nå_n¥
 *
n¥
)

250 
‘h_bË_’Œy
 *
’Œ›s
;

251 
nå_‘h_bË
 *
bË
;

252 
i
, 
j
, 
»t
, 
út
 = 0;

254 
’Œ›s
 = 
	`kz®loc
(
NSP_ETH_TABLE_SIZE
, 
GFP_KERNEL
);

255 ià(!
’Œ›s
)

256  
NULL
;

258 
»t
 = 
	`nå_n¥_»ad_‘h_bË
(
n¥
, 
’Œ›s
, 
NSP_ETH_TABLE_SIZE
);

259 ià(
»t
 < 0) {

260 
	`nå_”r
(
ýp
, "»adšg…ÜˆbË fažed %d\n", 
»t
);

261 
”r
;

264 
i
 = 0; i < 
NSP_ETH_MAX_COUNT
; i++)

265 ià(
’Œ›s
[
i
].
pÜt
 & 
NSP_ETH_PORT_LANES_MASK
)

266 
út
++;

272 ià(
»t
 &&„‘ !ð
út
) {

273 
	`nå_”r
(
ýp
, "tableƒntry count„eported (%d) does‚ot matchƒntries…resent (%d)\n",

274 
»t
, 
út
);

275 
”r
;

278 
bË
 = 
	`kz®loc
(
	`¡ruù_size
ÑabË, 
pÜts
, 
út
), 
GFP_KERNEL
);

279 ià(!
bË
)

280 
”r
;

282 
bË
->
couÁ
 = 
út
;

283 
i
 = 0, 
j
 = 0; i < 
NSP_ETH_MAX_COUNT
; i++)

284 ià(
’Œ›s
[
i
].
pÜt
 & 
NSP_ETH_PORT_LANES_MASK
)

285 
	`nå_‘h_pÜt_Œª¦©e
(
n¥
, &
’Œ›s
[
i
], i,

286 &
bË
->
pÜts
[
j
++]);

288 
	`nå_‘h_ÿlc_pÜt_geom‘ry
(
ýp
, 
bË
);

289 
i
 = 0; i < 
bË
->
couÁ
; i++)

290 
	`nå_‘h_ÿlc_pÜt_ty³
(
ýp
, &
bË
->
pÜts
[
i
]);

292 
	`kä“
(
’Œ›s
);

294  
bË
;

296 
”r
:

297 
	`kä“
(
’Œ›s
);

298  
NULL
;

299 
	}
}

301 
nå_n¥
 *
	$nå_‘h_cÚfig_¡¬t
(
nå_ýp
 *
ýp
, 
idx
)

303 
‘h_bË_’Œy
 *
’Œ›s
;

304 
nå_n¥
 *
n¥
;

305 
»t
;

307 
’Œ›s
 = 
	`kz®loc
(
NSP_ETH_TABLE_SIZE
, 
GFP_KERNEL
);

308 ià(!
’Œ›s
)

309  
	`ERR_PTR
(-
ENOMEM
);

311 
n¥
 = 
	`nå_n¥_Ý’
(
ýp
);

312 ià(
	`IS_ERR
(
n¥
)) {

313 
	`kä“
(
’Œ›s
);

314  
n¥
;

317 
»t
 = 
	`nå_n¥_»ad_‘h_bË
(
n¥
, 
’Œ›s
, 
NSP_ETH_TABLE_SIZE
);

318 ià(
»t
 < 0) {

319 
	`nå_”r
(
ýp
, "»adšg…ÜˆbË fažed %d\n", 
»t
);

320 
”r
;

323 ià(!(
’Œ›s
[
idx
].
pÜt
 & 
NSP_ETH_PORT_LANES_MASK
)) {

324 
	`nå_w¬n
(
ýp
, "tryingo set…ort state on disabled…ort %d\n",

325 
idx
);

326 
”r
;

329 
	`nå_n¥_cÚfig_£t_¡©e
(
n¥
, 
’Œ›s
, 
idx
);

330  
n¥
;

332 
”r
:

333 
	`nå_n¥_þo£
(
n¥
);

334 
	`kä“
(
’Œ›s
);

335  
	`ERR_PTR
(-
EIO
);

336 
	}
}

338 
	$nå_‘h_cÚfig_þ—nup_’d
(
nå_n¥
 *
n¥
)

340 
‘h_bË_’Œy
 *
’Œ›s
 = 
	`nå_n¥_cÚfig_’Œ›s
(
n¥
);

342 
	`nå_n¥_cÚfig_£t_modif›d
(
n¥
, 
çl£
);

343 
	`nå_n¥_cÚfig_þ—r_¡©e
(
n¥
);

344 
	`nå_n¥_þo£
(
n¥
);

345 
	`kä“
(
’Œ›s
);

346 
	}
}

362 
	$nå_‘h_cÚfig_comm™_’d
(
nå_n¥
 *
n¥
)

364 
‘h_bË_’Œy
 *
’Œ›s
 = 
	`nå_n¥_cÚfig_’Œ›s
(
n¥
);

365 
»t
 = 1;

367 ià(
	`nå_n¥_cÚfig_modif›d
(
n¥
)) {

368 
»t
 = 
	`nå_n¥_wr™e_‘h_bË
(
n¥
, 
’Œ›s
, 
NSP_ETH_TABLE_SIZE
);

369 
»t
 =„et < 0 ?„et : 0;

372 
	`nå_‘h_cÚfig_þ—nup_’d
(
n¥
);

374  
»t
;

375 
	}
}

391 
	$nå_‘h_£t_mod_’abË
(
nå_ýp
 *
ýp
, 
idx
, 
boÞ
 
’abË
)

393 
‘h_bË_’Œy
 *
’Œ›s
;

394 
nå_n¥
 *
n¥
;

395 
u64
 
»g
;

397 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
ýp
, 
idx
);

398 ià(
	`IS_ERR
(
n¥
))

399  
	`PTR_ERR
(
n¥
);

401 
’Œ›s
 = 
	`nå_n¥_cÚfig_’Œ›s
(
n¥
);

404 
»g
 = 
	`Ë64_to_ýu
(
’Œ›s
[
idx
].
¡©e
);

405 ià(
’abË
 !ð
	`FIELD_GET
(
NSP_ETH_CTRL_ENABLED
, 
»g
)) {

406 
»g
 = 
	`Ë64_to_ýu
(
’Œ›s
[
idx
].
cÚŒÞ
);

407 
»g
 &ð~
NSP_ETH_CTRL_ENABLED
;

408 
»g
 |ð
	`FIELD_PREP
(
NSP_ETH_CTRL_ENABLED
, 
’abË
);

409 
’Œ›s
[
idx
].
cÚŒÞ
 = 
	`ýu_to_Ë64
(
»g
);

411 
	`nå_n¥_cÚfig_£t_modif›d
(
n¥
, 
Œue
);

414  
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

415 
	}
}

430 
	$nå_‘h_£t_cÚfigu»d
(
nå_ýp
 *
ýp
, 
idx
, 
boÞ
 
cÚfiged
)

432 
‘h_bË_’Œy
 *
’Œ›s
;

433 
nå_n¥
 *
n¥
;

434 
u64
 
»g
;

436 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
ýp
, 
idx
);

437 ià(
	`IS_ERR
(
n¥
))

438  
	`PTR_ERR
(
n¥
);

443 ià(
	`nå_n¥_g‘_abi_v”_mšÜ
(
n¥
) < 20) {

444 
	`nå_‘h_cÚfig_þ—nup_’d
(
n¥
);

445  -
EOPNOTSUPP
;

448 
’Œ›s
 = 
	`nå_n¥_cÚfig_’Œ›s
(
n¥
);

451 
»g
 = 
	`Ë64_to_ýu
(
’Œ›s
[
idx
].
¡©e
);

452 ià(
cÚfiged
 !ð
	`FIELD_GET
(
NSP_ETH_STATE_CONFIGURED
, 
»g
)) {

453 
»g
 = 
	`Ë64_to_ýu
(
’Œ›s
[
idx
].
cÚŒÞ
);

454 
»g
 &ð~
NSP_ETH_CTRL_CONFIGURED
;

455 
»g
 |ð
	`FIELD_PREP
(
NSP_ETH_CTRL_CONFIGURED
, 
cÚfiged
);

456 
’Œ›s
[
idx
].
cÚŒÞ
 = 
	`ýu_to_Ë64
(
»g
);

458 
	`nå_n¥_cÚfig_£t_modif›d
(
n¥
, 
Œue
);

461  
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

462 
	}
}

465 
	$nå_‘h_£t_b™_cÚfig
(
nå_n¥
 *
n¥
, 
¿w_idx
,

466 cÚ¡ 
u64
 
mask
, cÚ¡ 
shiá
,

467 
v®
, cÚ¡ 
u64
 
ù¾_b™
)

469 
‘h_bË_’Œy
 *
’Œ›s
 = 
	`nå_n¥_cÚfig_’Œ›s
(
n¥
);

470 
idx
 = 
	`nå_n¥_cÚfig_idx
(
n¥
);

471 
u64
 
»g
;

476 ià(
	`nå_n¥_g‘_abi_v”_mšÜ
(
n¥
) < 17) {

477 
	`nå_”r
(
	`nå_n¥_ýp
(
n¥
),

479  -
EOPNOTSUPP
;

483 
»g
 = 
	`Ë64_to_ýu
(
’Œ›s
[
idx
].
¿w
[
¿w_idx
]);

484 ià(
v®
 =ð(
»g
 & 
mask
è>> 
shiá
)

487 
»g
 &ð~
mask
;

488 
»g
 |ð(
v®
 << 
shiá
è& 
mask
;

489 
’Œ›s
[
idx
].
¿w
[
¿w_idx
] = 
	`ýu_to_Ë64
(
»g
);

491 
’Œ›s
[
idx
].
cÚŒÞ
 |ð
	`ýu_to_Ë64
(
ù¾_b™
);

493 
	`nå_n¥_cÚfig_£t_modif›d
(
n¥
, 
Œue
);

496 
	}
}

498 
	#NFP_ETH_SET_BIT_CONFIG
(
n¥
, 
¿w_idx
, 
mask
, 
v®
, 
ù¾_b™
) \

500 
	`__BF_FIELD_CHECK
(
mask
, 0ULL, 
v®
, "NFP_ETH_SET_BIT_CONFIG: "); \

501 
	`nå_‘h_£t_b™_cÚfig
(
n¥
, 
¿w_idx
, 
mask
, 
	`__bf_shf
(mask), \

502 
v®
, 
ù¾_b™
); \

503 })

	)

515 
	$__nå_‘h_£t_ªeg
(
nå_n¥
 *
n¥
, 
nå_‘h_ªeg
 
mode
)

517  
	`NFP_ETH_SET_BIT_CONFIG
(
n¥
, 
NSP_ETH_RAW_STATE
,

518 
NSP_ETH_STATE_ANEG
, 
mode
,

519 
NSP_ETH_CTRL_SET_ANEG
);

520 
	}
}

532 
	$__nå_‘h_£t_ãc
(
nå_n¥
 *
n¥
, 
nå_‘h_ãc
 
mode
)

534  
	`NFP_ETH_SET_BIT_CONFIG
(
n¥
, 
NSP_ETH_RAW_STATE
,

535 
NSP_ETH_STATE_FEC
, 
mode
,

536 
NSP_ETH_CTRL_SET_FEC
);

537 
	}
}

551 
	$nå_‘h_£t_ãc
(
nå_ýp
 *
ýp
, 
idx
, 
nå_‘h_ãc
 
mode
)

553 
nå_n¥
 *
n¥
;

554 
”r
;

556 
n¥
 = 
	`nå_‘h_cÚfig_¡¬t
(
ýp
, 
idx
);

557 ià(
	`IS_ERR
(
n¥
))

558  
	`PTR_ERR
(
n¥
);

560 
”r
 = 
	`__nå_‘h_£t_ãc
(
n¥
, 
mode
);

561 ià(
”r
) {

562 
	`nå_‘h_cÚfig_þ—nup_’d
(
n¥
);

563  
”r
;

566  
	`nå_‘h_cÚfig_comm™_’d
(
n¥
);

567 
	}
}

581 
	$__nå_‘h_£t_¥“d
(
nå_n¥
 *
n¥
, 
¥“d
)

583 
nå_‘h_¿‹
 
¿‹
;

585 
¿‹
 = 
	`nå_‘h_¥“d2¿‹
(
¥“d
);

586 ià(
¿‹
 =ð
RATE_INVALID
) {

587 
	`nå_w¬n
(
	`nå_n¥_ýp
(
n¥
),

589 
¥“d
);

590  -
EINVAL
;

593  
	`NFP_ETH_SET_BIT_CONFIG
(
n¥
, 
NSP_ETH_RAW_STATE
,

594 
NSP_ETH_STATE_RATE
, 
¿‹
,

595 
NSP_ETH_CTRL_SET_RATE
);

596 
	}
}

608 
	$__nå_‘h_£t_¥l™
(
nå_n¥
 *
n¥
, 
ÏÃs
)

610  
	`NFP_ETH_SET_BIT_CONFIG
(
n¥
, 
NSP_ETH_RAW_PORT
, 
NSP_ETH_PORT_LANES
,

611 
ÏÃs
, 
NSP_ETH_CTRL_SET_LANES
);

612 
	}
}

	@src/nfpcore/nfp_platform.c

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/deviû.h
>

11 
	~<lšux/¶©fÜm_deviû.h
>

13 
	~"nå.h
"

14 
	~"nå_ýp.h
"

28 
¶©fÜm_deviû
 *
	$nå_¶©fÜm_deviû_»gi¡”_un™
(
nå_ýp
 *
ýp
,

29 cÚ¡ *
ty³
,

30 
un™
, 
un™s
)

32 
deviû
 *
dev
 = 
	`nå_ýp_deviû
(
ýp
);

33 cÚ¡ 
nå_¶©fÜm_d©a
 
pd©a
 = {

34 .
nå
 = 
	`nå_ýp_deviû_id
(
ýp
),

35 .
un™
 = unit,

37 
¶©fÜm_deviû
 *
pdev
;

38 
”r
;

39 
id
;

41 
id
 = 
	`nå_ýp_deviû_id
(
ýp
è* 
un™s
 + 
un™
;

43 
pdev
 = 
	`¶©fÜm_deviû_®loc
(
ty³
, 
id
);

44 ià(!
pdev
) {

45 
	`dev_”r
(
dev
, "Can't create '%s.%d'…latform device\n",

46 
ty³
, 
id
);

47  
NULL
;

50 
pdev
->
dev
.
·»Á
 = dev;

51 
	`¶©fÜm_deviû_add_d©a
(
pdev
, &
pd©a
, (pdata));

53 
”r
 = 
	`¶©fÜm_deviû_add
(
pdev
);

54 ià(
”r
 < 0) {

55 
	`dev_”r
(
dev
, "Can't„egister '%s.%d'…latform device\n",

56 
ty³
, 
id
);

57 
	`¶©fÜm_deviû_put
(
pdev
);

58  
NULL
;

61  
pdev
;

62 
	}
}

74 
¶©fÜm_deviû
 *
	$nå_¶©fÜm_deviû_»gi¡”
(
nå_ýp
 *
ýp
,

75 cÚ¡ *
ty³
)

77  
	`nå_¶©fÜm_deviû_»gi¡”_un™
(
ýp
, 
ty³
, 0, 1);

78 
	}
}

85 
	$nå_¶©fÜm_deviû_uÄegi¡”
(
¶©fÜm_deviû
 *
pdev
)

87 
	`¶©fÜm_deviû_uÄegi¡”
(
pdev
);

88 
	}
}

	@src/nfpcore/nfp_resource.c

9 
	~<lšux/d–ay.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/¦ab.h
>

13 
	~"üc32.h
"

14 
	~"nå.h
"

15 
	~"nå_ýp.h
"

16 
	~"nå6000/nå6000.h
"

18 
	#NFP_RESOURCE_TBL_TARGET
 
NFP_CPP_TARGET_MU


	)

19 
	#NFP_RESOURCE_TBL_BASE
 0x8100000000ULL

	)

22 
	#NFP_RESOURCE_TBL_NAME
 "nå.»s"

	)

23 
	#NFP_RESOURCE_TBL_KEY
 0x00000000

	)

25 
	#NFP_RESOURCE_ENTRY_NAME_SZ
 8

	)

41 
	snå_»sourû_’Œy
 {

42 
	snå_»sourû_’Œy_mu‹x
 {

43 
u32
 
	mowÃr
;

44 
u32
 
	mkey
;

45 } 
	mmu‹x
;

46 
	snå_»sourû_’Œy_»giÚ
 {

47 
u8
 
	mÇme
[
NFP_RESOURCE_ENTRY_NAME_SZ
];

48 
u8
 
	m»£rved
[5];

49 
u8
 
	mýp_aùiÚ
;

50 
u8
 
	mýp_tok’
;

51 
u8
 
	mýp_rg‘
;

52 
u32
 
	m·ge_off£t
;

53 
u32
 
	m·ge_size
;

54 } 
	m»giÚ
;

57 
	#NFP_RESOURCE_TBL_SIZE
 4096

	)

58 
	#NFP_RESOURCE_TBL_ENTRIES
 (
NFP_RESOURCE_TBL_SIZE
 / \

59 (
nå_»sourû_’Œy
))

	)

61 
	snå_»sourû
 {

62 
	mÇme
[
NFP_RESOURCE_ENTRY_NAME_SZ
 + 1];

63 
u32
 
	mýp_id
;

64 
u64
 
	maddr
;

65 
u64
 
	msize
;

66 
nå_ýp_mu‹x
 *
	mmu‹x
;

69 
	$nå_ýp_»sourû_fšd
(
nå_ýp
 *
ýp
, 
nå_»sourû
 *
»s
)

71 
nå_»sourû_’Œy
 
’Œy
;

72 
u32
 
ýp_id
, 
key
;

73 
»t
, 
i
;

75 
ýp_id
 = 
	`NFP_CPP_ID
(
NFP_RESOURCE_TBL_TARGET
, 3, 0);

78 ià(!
	`¡rcmp
(
»s
->
Çme
, 
NFP_RESOURCE_TBL_NAME
)) {

79 
	`nå_”r
(
ýp
, "Grabbing device†ock‚ot supported\n");

80  -
EOPNOTSUPP
;

82 
key
 = 
	`üc32_posix
(
»s
->
Çme
, 
NFP_RESOURCE_ENTRY_NAME_SZ
);

84 
i
 = 0; i < 
NFP_RESOURCE_TBL_ENTRIES
; i++) {

85 
u64
 
addr
 = 
NFP_RESOURCE_TBL_BASE
 +

86 (
nå_»sourû_’Œy
è* 
i
;

88 
»t
 = 
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
addr
, &
’Œy
, (entry));

89 ià(
»t
 !ð(
’Œy
))

90  -
EIO
;

92 ià(
’Œy
.
mu‹x
.
key
 != key)

96 
»s
->
mu‹x
 =

97 
	`nå_ýp_mu‹x_®loc
(
ýp
,

98 
NFP_RESOURCE_TBL_TARGET
, 
addr
, 
key
);

99 
»s
->
ýp_id
 = 
	`NFP_CPP_ID
(
’Œy
.
»giÚ
.
ýp_rg‘
,

100 
’Œy
.
»giÚ
.
ýp_aùiÚ
,

101 
’Œy
.
»giÚ
.
ýp_tok’
);

102 
»s
->
addr
 = (
u64
)
’Œy
.
»giÚ
.
·ge_off£t
 << 8;

103 
»s
->
size
 = (
u64
)
’Œy
.
»giÚ
.
·ge_size
 << 8;

108  -
ENOENT
;

109 
	}
}

112 
	$nå_»sourû_Œy_acquœe
(
nå_ýp
 *
ýp
, 
nå_»sourû
 *
»s
,

113 
nå_ýp_mu‹x
 *
dev_mu‹x
)

115 
”r
;

117 ià(
	`nå_ýp_mu‹x_lock
(
dev_mu‹x
))

118  -
EINVAL
;

120 
”r
 = 
	`nå_ýp_»sourû_fšd
(
ýp
, 
»s
);

121 ià(
”r
)

122 
”r_uÆock_dev
;

124 
”r
 = 
	`nå_ýp_mu‹x_Œylock
(
»s
->
mu‹x
);

125 ià(
”r
)

126 
”r_»s_mu‹x_ä“
;

128 
	`nå_ýp_mu‹x_uÆock
(
dev_mu‹x
);

132 
”r_»s_mu‹x_ä“
:

133 
	`nå_ýp_mu‹x_ä“
(
»s
->
mu‹x
);

134 
”r_uÆock_dev
:

135 
	`nå_ýp_mu‹x_uÆock
(
dev_mu‹x
);

137  
”r
;

138 
	}
}

149 
nå_»sourû
 *

150 
	$nå_»sourû_acquœe
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
)

152 
w¬n_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_FIRST_WARN
 * 
HZ
;

153 
”r_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_ERROR
 * 
HZ
;

154 
nå_ýp_mu‹x
 *
dev_mu‹x
;

155 
nå_»sourû
 *
»s
;

156 
”r
;

158 
»s
 = 
	`kz®loc
((*»s), 
GFP_KERNEL
);

159 ià(!
»s
)

160  
	`ERR_PTR
(-
ENOMEM
);

162 
	`¡ºýy
(
»s
->
Çme
,‚ame, 
NFP_RESOURCE_ENTRY_NAME_SZ
);

164 
dev_mu‹x
 = 
	`nå_ýp_mu‹x_®loc
(
ýp
, 
NFP_RESOURCE_TBL_TARGET
,

165 
NFP_RESOURCE_TBL_BASE
,

166 
NFP_RESOURCE_TBL_KEY
);

167 ià(!
dev_mu‹x
) {

168 
	`kä“
(
»s
);

169  
	`ERR_PTR
(-
ENOMEM
);

173 
”r
 = 
	`nå_»sourû_Œy_acquœe
(
ýp
, 
»s
, 
dev_mu‹x
);

174 ià(!
”r
)

176 ià(
”r
 !ð-
EBUSY
)

177 
”r_ä“
;

179 
”r
 = 
	`m¦“p_š‹¼u±ibË
(1);

180 ià(
”r
 != 0) {

181 
”r
 = -
ERESTARTSYS
;

182 
”r_ä“
;

185 ià(
	`time_is_befÜe_eq_jiff›s
(
w¬n_©
)) {

186 
w¬n_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_NEXT_WARN
 * 
HZ
;

187 
	`nå_w¬n
(
ýp
, "Warning: waiting for NFP„esource %s\n",

188 
Çme
);

190 ià(
	`time_is_befÜe_eq_jiff›s
(
”r_©
)) {

191 
	`nå_”r
(
ýp
, "E¼Ü:„esourû % timed out\n", 
Çme
);

192 
”r
 = -
EBUSY
;

193 
”r_ä“
;

197 
	`nå_ýp_mu‹x_ä“
(
dev_mu‹x
);

199  
»s
;

201 
”r_ä“
:

202 
	`nå_ýp_mu‹x_ä“
(
dev_mu‹x
);

203 
	`kä“
(
»s
);

204  
	`ERR_PTR
(
”r
);

205 
	}
}

213 
	$nå_»sourû_»Ëa£
(
nå_»sourû
 *
»s
)

215 
	`nå_ýp_mu‹x_uÆock
(
»s
->
mu‹x
);

216 
	`nå_ýp_mu‹x_ä“
(
»s
->
mu‹x
);

217 
	`kä“
(
»s
);

218 
	}
}

231 
	$nå_»sourû_wa™
(
nå_ýp
 *
ýp
, cÚ¡ *
Çme
, 
£cs
)

233 
w¬n_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_FIRST_WARN
 * 
HZ
;

234 
”r_©
 = 
jiff›s
 + 
£cs
 * 
HZ
;

235 
nå_»sourû
 *
»s
;

237 
Œue
) {

238 
»s
 = 
	`nå_»sourû_acquœe
(
ýp
, 
Çme
);

239 ià(!
	`IS_ERR
(
»s
)) {

240 
	`nå_»sourû_»Ëa£
(
»s
);

244 ià(
	`PTR_ERR
(
»s
è!ð-
ENOENT
) {

245 
	`nå_”r
(
ýp
, "error waiting for„esource %s: %ld\n",

246 
Çme
, 
	`PTR_ERR
(
»s
));

247  
	`PTR_ERR
(
»s
);

249 ià(
	`time_is_befÜe_eq_jiff›s
(
”r_©
)) {

250 
	`nå_”r
(
ýp
, "timeouˆwa™šg fÜ„esourû %s\n", 
Çme
);

251  -
ETIMEDOUT
;

253 ià(
	`time_is_befÜe_eq_jiff›s
(
w¬n_©
)) {

254 
w¬n_©
 = 
jiff›s
 + 
NFP_MUTEX_WAIT_NEXT_WARN
 * 
HZ
;

255 
	`nå_šfo
(
ýp
, "wa™šg fÜ NFP„esourû %s\n", 
Çme
);

257 ià(
	`m¦“p_š‹¼u±ibË
(10)) {

258 
	`nå_”r
(
ýp
, "wait for„esource %s interrupted\n",

259 
Çme
);

260  -
ERESTARTSYS
;

263 
	}
}

271 
u32
 
	$nå_»sourû_ýp_id
(
nå_»sourû
 *
»s
)

273  
»s
->
ýp_id
;

274 
	}
}

282 cÚ¡ *
	$nå_»sourû_Çme
(
nå_»sourû
 *
»s
)

284  
»s
->
Çme
;

285 
	}
}

293 
u64
 
	$nå_»sourû_add»ss
(
nå_»sourû
 *
»s
)

295  
»s
->
addr
;

296 
	}
}

304 
u64
 
	$nå_»sourû_size
(
nå_»sourû
 *
»s
)

306  
»s
->
size
;

307 
	}
}

318 
	$nå_»sourû_bË_š™
(
nå_ýp
 *
ýp
)

320 
nå_ýp_mu‹x
 *
dev_mu‹x
;

321 
i
, 
”r
;

323 
”r
 = 
	`nå_ýp_mu‹x_»þaim
(
ýp
, 
NFP_RESOURCE_TBL_TARGET
,

324 
NFP_RESOURCE_TBL_BASE
);

325 ià(
”r
 < 0) {

326 
	`nå_”r
(
ýp
, "Error: failedo„eclaim„esourceable mutex\n");

327  
”r
;

329 ià(
”r
)

330 
	`nå_w¬n
(
ýp
, "Warning: busted main„esourceable mutex\n");

332 
dev_mu‹x
 = 
	`nå_ýp_mu‹x_®loc
(
ýp
, 
NFP_RESOURCE_TBL_TARGET
,

333 
NFP_RESOURCE_TBL_BASE
,

334 
NFP_RESOURCE_TBL_KEY
);

335 ià(!
dev_mu‹x
)

336  -
ENOMEM
;

338 ià(
	`nå_ýp_mu‹x_lock
(
dev_mu‹x
)) {

339 
	`nå_”r
(
ýp
, "Error: failedo claim„esourceable mutex\n");

340 
	`nå_ýp_mu‹x_ä“
(
dev_mu‹x
);

341  -
EINVAL
;

345 
i
 = 1; i < 
NFP_RESOURCE_TBL_ENTRIES
; i++) {

346 
u64
 
addr
 = 
NFP_RESOURCE_TBL_BASE
 +

347 (
nå_»sourû_’Œy
è* 
i
;

349 
”r
 = 
	`nå_ýp_mu‹x_»þaim
(
ýp
, 
NFP_RESOURCE_TBL_TARGET
, 
addr
);

350 ià(
”r
 < 0) {

351 
	`nå_”r
(
ýp
,

353 
i
);

354 
”r_uÆock
;

356 ià(
”r
)

357 
	`nå_w¬n
(
ýp
, "W¬nšg: bu¡ed„esourû %d mu‹x\n", 
i
);

360 
”r
 = 0;

361 
”r_uÆock
:

362 
	`nå_ýp_mu‹x_uÆock
(
dev_mu‹x
);

363 
	`nå_ýp_mu‹x_ä“
(
dev_mu‹x
);

365  
”r
;

366 
	}
}

	@src/nfpcore/nfp_rtsym.c

12 
	~"kcom·t.h
"

14 
	~<asm/uÇligÃd.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/moduË.h
>

17 
	~<lšux/¦ab.h
>

18 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 5, 0)

19 
	~<asm-g’”ic/io-64-nÚ©omic-hi-lo.h
>

21 
	~<lšux/io-64-nÚ©omic-hi-lo.h
>

24 
	~"nå.h
"

25 
	~"nå_ýp.h
"

26 
	~"nå_nffw.h
"

27 
	~"nå6000/nå6000.h
"

30 
	#SYM_TGT_LMEM
 0

	)

31 
	#SYM_TGT_EMU_CACHE
 0x17

	)

33 
	snå_¹sym_’Œy
 {

34 
u8
 
	mty³
;

35 
u8
 
	mrg‘
;

36 
u8
 
	mi¦ªd
;

37 
u8
 
	maddr_hi
;

38 
__Ë32
 
	maddr_lo
;

39 
__Ë16
 
	mÇme
;

40 
u8
 
	mm’um
;

41 
u8
 
	msize_hi
;

42 
__Ë32
 
	msize_lo
;

45 
	snå_¹sym_bË
 {

46 
nå_ýp
 *
	mýp
;

47 
	mnum
;

48 *
	m¡¹ab
;

49 
nå_¹sym
 
	msymb
[];

52 
	$nå_meid
(
u8
 
i¦ªd_id
, u8 
m’um
)

54  (
i¦ªd_id
 & 0x3Fè=ði¦ªd_id && 
m’um
 < 12 ?

55 (
i¦ªd_id
 << 4è| (
m’um
 + 4) : -1;

56 
	}
}

59 
	$nå_¹sym_sw_’Œy_š™
(
nå_¹sym_bË
 *
ÿche
, 
u32
 
¡¹ab_size
,

60 
nå_¹sym
 *
sw
, 
nå_¹sym_’Œy
 *
fw
)

62 
sw
->
ty³
 = 
fw
->type;

63 
sw
->
Çme
 = 
ÿche
->
¡¹ab
 + 
	`Ë16_to_ýu
(
fw
->Çmeè% 
¡¹ab_size
;

64 
sw
->
addr
 = ((
u64
)
fw
->
addr_hi
 << 32è| 
	`Ë32_to_ýu
(fw->
addr_lo
);

65 
sw
->
size
 = ((
u64
)
fw
->
size_hi
 << 32è| 
	`Ë32_to_ýu
(fw->
size_lo
);

67 
fw
->
rg‘
) {

68 
SYM_TGT_LMEM
:

69 
sw
->
rg‘
 = 
NFP_RTSYM_TARGET_LMEM
;

71 
SYM_TGT_EMU_CACHE
:

72 
sw
->
rg‘
 = 
NFP_RTSYM_TARGET_EMU_CACHE
;

75 
sw
->
rg‘
 = 
fw
->target;

79 ià(
fw
->
m’um
 != 0xff)

80 
sw
->
domaš
 = 
	`nå_meid
(
fw
->
i¦ªd
, fw->
m’um
);

81 ià(
fw
->
i¦ªd
 != 0xff)

82 
sw
->
domaš
 = 
fw
->
i¦ªd
;

84 
sw
->
domaš
 = -1;

85 
	}
}

87 
nå_¹sym_bË
 *
	$nå_¹sym_bË_»ad
(
nå_ýp
 *
ýp
)

89 
nå_¹sym_bË
 *
¹bl
;

90 cÚ¡ 
nå_m
 *
m
;

92 
m
 = 
	`nå_m_Ý’
(
ýp
);

93 
¹bl
 = 
	`__nå_¹sym_bË_»ad
(
ýp
, 
m
);

94 
	`nå_m_þo£
(
m
);

96  
¹bl
;

97 
	}
}

99 
nå_¹sym_bË
 *

100 
	$__nå_¹sym_bË_»ad
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_m
 *
m
)

102 cÚ¡ 
u32
 
d¿m
 = 
	`NFP_CPP_ID
(
NFP_CPP_TARGET_MU
, 
NFP_CPP_ACTION_RW
, 0) |

103 
NFP_ISL_EMEM0
;

104 
u32
 
¡¹ab_addr
, 
symb_addr
, 
¡¹ab_size
, 
symb_size
;

105 
nå_¹sym_’Œy
 *
¹symb
;

106 
nå_¹sym_bË
 *
ÿche
;

107 
”r
, 
n
, 
size
;

109 ià(!
m
)

110  
NULL
;

112 
	`nå_m_¡¹ab
(
m
, &
¡¹ab_addr
, &
¡¹ab_size
);

113 
	`nå_m_symb
(
m
, &
symb_addr
, &
symb_size
);

115 ià(!
symb_size
 || !
¡¹ab_size
 || symb_siz% (*
¹symb
))

116  
NULL
;

119 
symb_size
 = 
	`round_up
(symtab_size, 8);

120 
¡¹ab_size
 = 
	`round_up
(strtab_size, 8);

122 
¹symb
 = 
	`km®loc
(
symb_size
, 
GFP_KERNEL
);

123 ià(!
¹symb
)

124  
NULL
;

126 
size
 = (*
ÿche
);

127 
size
 +ð
symb_size
 / (*
¹symb
è* (
nå_¹sym
);

128 
size
 +ð
¡¹ab_size
 + 1;

129 
ÿche
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

130 ià(!
ÿche
)

131 
ex™_ä“_¹sym_¿w
;

133 
ÿche
->
ýp
 = cpp;

134 
ÿche
->
num
 = 
symb_size
 / (*
¹symb
);

135 
ÿche
->
¡¹ab
 = (*)&ÿche->
symb
[ÿche->
num
];

137 
”r
 = 
	`nå_ýp_»ad
(
ýp
, 
d¿m
, 
symb_addr
, 
¹symb
, 
symb_size
);

138 ià(
”r
 !ð
symb_size
)

139 
ex™_ä“_ÿche
;

141 
”r
 = 
	`nå_ýp_»ad
(
ýp
, 
d¿m
, 
¡¹ab_addr
, 
ÿche
->
¡¹ab
, 
¡¹ab_size
);

142 ià(
”r
 !ð
¡¹ab_size
)

143 
ex™_ä“_ÿche
;

144 
ÿche
->
¡¹ab
[
¡¹ab_size
] = '\0';

146 
n
 = 0;‚ < 
ÿche
->
num
;‚++)

147 
	`nå_¹sym_sw_’Œy_š™
(
ÿche
, 
¡¹ab_size
,

148 &
ÿche
->
symb
[
n
], &
¹symb
[n]);

150 
	`kä“
(
¹symb
);

152  
ÿche
;

154 
ex™_ä“_ÿche
:

155 
	`kä“
(
ÿche
);

156 
ex™_ä“_¹sym_¿w
:

157 
	`kä“
(
¹symb
);

158  
NULL
;

159 
	}
}

167 
	$nå_¹sym_couÁ
(
nå_¹sym_bË
 *
¹bl
)

169 ià(!
¹bl
)

170  -
EINVAL
;

171  
¹bl
->
num
;

172 
	}
}

181 cÚ¡ 
nå_¹sym
 *
	$nå_¹sym_g‘
(
nå_¹sym_bË
 *
¹bl
, 
idx
)

183 ià(!
¹bl
)

184  
NULL
;

185 ià(
idx
 >ð
¹bl
->
num
)

186  
NULL
;

188  &
¹bl
->
symb
[
idx
];

189 
	}
}

198 cÚ¡ 
nå_¹sym
 *

199 
	$nå_¹sym_lookup
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
)

201 
n
;

203 ià(!
¹bl
)

204  
NULL
;

206 
n
 = 0;‚ < 
¹bl
->
num
;‚++)

207 ià(
	`¡rcmp
(
Çme
, 
¹bl
->
symb
[
n
].name) == 0)

208  &
¹bl
->
symb
[
n
];

210  
NULL
;

211 
	}
}

213 
u64
 
	$nå_¹sym_size
(cÚ¡ 
nå_¹sym
 *
sym
)

215 
sym
->
ty³
) {

216 
NFP_RTSYM_TYPE_NONE
:

217 
	`´_”r
("¹sym '%s':y³ NONE\n", 
sym
->
Çme
);

220 
	`´_w¬n
("¹sym '%s': unknowÀty³: %d\n", 
sym
->
Çme
, sym->
ty³
);

222 
NFP_RTSYM_TYPE_OBJECT
:

223 
NFP_RTSYM_TYPE_FUNCTION
:

224  
sym
->
size
;

225 
NFP_RTSYM_TYPE_ABS
:

226  (
u64
);

228 
	}
}

231 
	$nå_¹sym_to_de¡
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

232 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, 
u32
 *
ýp_id
, u64 *
addr
)

234 ià(
sym
->
ty³
 !ð
NFP_RTSYM_TYPE_OBJECT
) {

235 
	`nå_”r
(
ýp
, "rtsym '%s': direct‡ccesso‚on-object„tsym\n",

236 
sym
->
Çme
);

237  -
EINVAL
;

240 *
addr
 = 
sym
->add¸+ 
off
;

242 ià(
sym
->
rg‘
 =ð
NFP_RTSYM_TARGET_EMU_CACHE
) {

243 
loÿl™y_off
 = 
	`nå_ýp_mu_loÿl™y_lsb
(
ýp
);

245 *
addr
 &ð~(
NFP_MU_ADDR_ACCESS_TYPE_MASK
 << 
loÿl™y_off
);

246 *
addr
 |ð
NFP_MU_ADDR_ACCESS_TYPE_DIRECT
 << 
loÿl™y_off
;

248 *
ýp_id
 = 
	`NFP_CPP_ISLAND_ID
(
NFP_CPP_TARGET_MU
, 
aùiÚ
, 
tok’
,

249 
sym
->
domaš
);

250 } ià(
sym
->
rg‘
 < 0) {

251 
	`nå_”r
(
ýp
, "rtsym '%s': unhandledargetƒncoding: %d\n",

252 
sym
->
Çme
, sym->
rg‘
);

253  -
EINVAL
;

255 *
ýp_id
 = 
	`NFP_CPP_ISLAND_ID
(
sym
->
rg‘
, 
aùiÚ
, 
tok’
,

256 
sym
->
domaš
);

260 
	}
}

262 
	$__nå_¹sym_»ad
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

263 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, *
buf
, 
size_t
 
Ën
)

265 
u64
 
sym_size
 = 
	`nå_¹sym_size
(
sym
);

266 
u32
 
ýp_id
;

267 
u64
 
addr
;

268 
”r
;

270 ià(
off
 > 
sym_size
) {

271 
	`nå_”r
(
ýp
, "rtsym '%s':„ead out of bounds: off: %lld +†en: %zd > size: %lld\n",

272 
sym
->
Çme
, 
off
, 
Ën
, 
sym_size
);

273  -
ENXIO
;

275 
Ën
 = 
	`mš_t
(
size_t
,†’, 
sym_size
 - 
off
);

277 ià(
sym
->
ty³
 =ð
NFP_RTSYM_TYPE_ABS
) {

278 
u8
 
tmp
[8];

280 
	`put_uÇligÃd_Ë64
(
sym
->
addr
, 
tmp
);

281 
	`memýy
(
buf
, &
tmp
[
off
], 
Ën
);

283  
Ën
;

286 
”r
 = 
	`nå_¹sym_to_de¡
(
ýp
, 
sym
, 
aùiÚ
, 
tok’
, 
off
, &
ýp_id
, &
addr
);

287 ià(
”r
)

288  
”r
;

290  
	`nå_ýp_»ad
(
ýp
, 
ýp_id
, 
addr
, 
buf
, 
Ën
);

291 
	}
}

293 
	$nå_¹sym_»ad
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

294 *
buf
, 
size_t
 
Ën
)

296  
	`__nå_¹sym_»ad
(
ýp
, 
sym
, 
NFP_CPP_ACTION_RW
, 0, 
off
, 
buf
, 
Ën
);

297 
	}
}

299 
	$__nå_¹sym_»adl
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

300 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, 
u32
 *
v®ue
)

302 
u32
 
ýp_id
;

303 
u64
 
addr
;

304 
”r
;

306 ià(
off
 + 4 > 
	`nå_¹sym_size
(
sym
)) {

307 
	`nå_”r
(
ýp
, "rtsym '%s':„eadl out of bounds: off: %lld + 4 > size: %lld\n",

308 
sym
->
Çme
, 
off
, 
	`nå_¹sym_size
(sym));

309  -
ENXIO
;

312 
”r
 = 
	`nå_¹sym_to_de¡
(
ýp
, 
sym
, 
aùiÚ
, 
tok’
, 
off
, &
ýp_id
, &
addr
);

313 ià(
”r
)

314  
”r
;

316  
	`nå_ýp_»adl
(
ýp
, 
ýp_id
, 
addr
, 
v®ue
);

317 
	}
}

319 
	$nå_¹sym_»adl
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

320 
u32
 *
v®ue
)

322  
	`__nå_¹sym_»adl
(
ýp
, 
sym
, 
NFP_CPP_ACTION_RW
, 0, 
off
, 
v®ue
);

323 
	}
}

325 
	$__nå_¹sym_»adq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

326 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, u64 *
v®ue
)

328 
u32
 
ýp_id
;

329 
u64
 
addr
;

330 
”r
;

332 ià(
off
 + 8 > 
	`nå_¹sym_size
(
sym
)) {

333 
	`nå_”r
(
ýp
, "rtsym '%s':„eadq out of bounds: off: %lld + 8 > size: %lld\n",

334 
sym
->
Çme
, 
off
, 
	`nå_¹sym_size
(sym));

335  -
ENXIO
;

338 ià(
sym
->
ty³
 =ð
NFP_RTSYM_TYPE_ABS
) {

339 *
v®ue
 = 
sym
->
addr
;

343 
”r
 = 
	`nå_¹sym_to_de¡
(
ýp
, 
sym
, 
aùiÚ
, 
tok’
, 
off
, &
ýp_id
, &
addr
);

344 ià(
”r
)

345  
”r
;

347  
	`nå_ýp_»adq
(
ýp
, 
ýp_id
, 
addr
, 
v®ue
);

348 
	}
}

350 
	$nå_¹sym_»adq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

351 
u64
 *
v®ue
)

353  
	`__nå_¹sym_»adq
(
ýp
, 
sym
, 
NFP_CPP_ACTION_RW
, 0, 
off
, 
v®ue
);

354 
	}
}

356 
	$__nå_¹sym_wr™e
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

357 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, *
buf
, 
size_t
 
Ën
)

359 
u64
 
sym_size
 = 
	`nå_¹sym_size
(
sym
);

360 
u32
 
ýp_id
;

361 
u64
 
addr
;

362 
”r
;

364 ià(
off
 > 
sym_size
) {

365 
	`nå_”r
(
ýp
, "rtsym '%s': write out of bounds: off: %lld +†en: %zd > size: %lld\n",

366 
sym
->
Çme
, 
off
, 
Ën
, 
sym_size
);

367  -
ENXIO
;

369 
Ën
 = 
	`mš_t
(
size_t
,†’, 
sym_size
 - 
off
);

371 
”r
 = 
	`nå_¹sym_to_de¡
(
ýp
, 
sym
, 
aùiÚ
, 
tok’
, 
off
, &
ýp_id
, &
addr
);

372 ià(
”r
)

373  
”r
;

375  
	`nå_ýp_wr™e
(
ýp
, 
ýp_id
, 
addr
, 
buf
, 
Ën
);

376 
	}
}

378 
	$nå_¹sym_wr™e
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

379 *
buf
, 
size_t
 
Ën
)

381  
	`__nå_¹sym_wr™e
(
ýp
, 
sym
, 
NFP_CPP_ACTION_RW
, 0, 
off
, 
buf
, 
Ën
);

382 
	}
}

384 
	$__nå_¹sym_wr™–
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

385 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, 
u32
 
v®ue
)

387 
u32
 
ýp_id
;

388 
u64
 
addr
;

389 
”r
;

391 ià(
off
 + 4 > 
	`nå_¹sym_size
(
sym
)) {

392 
	`nå_”r
(
ýp
, "rtsym '%s': writel out of bounds: off: %lld + 4 > size: %lld\n",

393 
sym
->
Çme
, 
off
, 
	`nå_¹sym_size
(sym));

394  -
ENXIO
;

397 
”r
 = 
	`nå_¹sym_to_de¡
(
ýp
, 
sym
, 
aùiÚ
, 
tok’
, 
off
, &
ýp_id
, &
addr
);

398 ià(
”r
)

399  
”r
;

401  
	`nå_ýp_wr™–
(
ýp
, 
ýp_id
, 
addr
, 
v®ue
);

402 
	}
}

404 
	$nå_¹sym_wr™–
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

405 
u32
 
v®ue
)

407  
	`__nå_¹sym_wr™–
(
ýp
, 
sym
, 
NFP_CPP_ACTION_RW
, 0, 
off
, 
v®ue
);

408 
	}
}

410 
	$__nå_¹sym_wr™eq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
,

411 
u8
 
aùiÚ
, u8 
tok’
, 
u64
 
off
, u64 
v®ue
)

413 
u32
 
ýp_id
;

414 
u64
 
addr
;

415 
”r
;

417 ià(
off
 + 8 > 
	`nå_¹sym_size
(
sym
)) {

418 
	`nå_”r
(
ýp
, "rtsym '%s': writeq out of bounds: off: %lld + 8 > size: %lld\n",

419 
sym
->
Çme
, 
off
, 
	`nå_¹sym_size
(sym));

420  -
ENXIO
;

423 
”r
 = 
	`nå_¹sym_to_de¡
(
ýp
, 
sym
, 
aùiÚ
, 
tok’
, 
off
, &
ýp_id
, &
addr
);

424 ià(
”r
)

425  
”r
;

427  
	`nå_ýp_wr™eq
(
ýp
, 
ýp_id
, 
addr
, 
v®ue
);

428 
	}
}

430 
	$nå_¹sym_wr™eq
(
nå_ýp
 *
ýp
, cÚ¡ 
nå_¹sym
 *
sym
, 
u64
 
off
,

431 
u64
 
v®ue
)

433  
	`__nå_¹sym_wr™eq
(
ýp
, 
sym
, 
NFP_CPP_ACTION_RW
, 0, 
off
, 
v®ue
);

434 
	}
}

448 
u64
 
	$nå_¹sym_»ad_Ë
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
,

449 *
”rÜ
)

451 cÚ¡ 
nå_¹sym
 *
sym
;

452 
u32
 
v®32
;

453 
u64
 
v®
;

454 
”r
;

456 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
Çme
);

457 ià(!
sym
) {

458 
”r
 = -
ENOENT
;

459 
ex™
;

462 
	`nå_¹sym_size
(
sym
)) {

464 
”r
 = 
	`nå_¹sym_»adl
(
¹bl
->
ýp
, 
sym
, 0, &
v®32
);

465 
v®
 = 
v®32
;

468 
”r
 = 
	`nå_¹sym_»adq
(
¹bl
->
ýp
, 
sym
, 0, &
v®
);

471 
	`nå_”r
(
¹bl
->
ýp
,

473 
Çme
, 
	`nå_¹sym_size
(
sym
));

474 
”r
 = -
EINVAL
;

478 
ex™
:

479 ià(
”rÜ
)

480 *
”rÜ
 = 
”r
;

482 ià(
”r
)

484  
v®
;

485 
	}
}

499 
	$nå_¹sym_wr™e_Ë
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
,

500 
u64
 
v®ue
)

502 cÚ¡ 
nå_¹sym
 *
sym
;

503 
”r
;

505 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
Çme
);

506 ià(!
sym
)

507  -
ENOENT
;

509 
	`nå_¹sym_size
(
sym
)) {

511 
”r
 = 
	`nå_¹sym_wr™–
(
¹bl
->
ýp
, 
sym
, 0, 
v®ue
);

514 
”r
 = 
	`nå_¹sym_wr™eq
(
¹bl
->
ýp
, 
sym
, 0, 
v®ue
);

517 
	`nå_”r
(
¹bl
->
ýp
,

519 
Çme
, 
	`nå_¹sym_size
(
sym
));

520 
”r
 = -
EINVAL
;

524  
”r
;

525 
	}
}

527 
u8
 
__iomem
 *

528 
	$nå_¹sym_m­
(
nå_¹sym_bË
 *
¹bl
, cÚ¡ *
Çme
, cÚ¡ *
id
,

529 
mš_size
, 
nå_ýp_¬—
 **
¬—
)

531 cÚ¡ 
nå_¹sym
 *
sym
;

532 
u8
 
__iomem
 *
mem
;

533 
u32
 
ýp_id
;

534 
u64
 
addr
;

535 
”r
;

537 
sym
 = 
	`nå_¹sym_lookup
(
¹bl
, 
Çme
);

538 ià(!
sym
)

539  (
u8
 
__iomem
 *)
	`ERR_PTR
(-
ENOENT
);

541 
”r
 = 
	`nå_¹sym_to_de¡
(
¹bl
->
ýp
, 
sym
, 
NFP_CPP_ACTION_RW
, 0, 0,

542 &
ýp_id
, &
addr
);

543 ià(
”r
) {

544 
	`nå_”r
(
¹bl
->
ýp
, "¹sym '%s': m­pšg fažed\n", 
Çme
);

545  (
u8
 
__iomem
 *)
	`ERR_PTR
(
”r
);

548 ià(
sym
->
size
 < 
mš_size
) {

549 
	`nå_”r
(
¹bl
->
ýp
, "¹sym '%s':oØsm®l\n", 
Çme
);

550  (
u8
 
__iomem
 *)
	`ERR_PTR
(-
EINVAL
);

553 
mem
 = 
	`nå_ýp_m­_¬—
(
¹bl
->
ýp
, 
id
, 
ýp_id
, 
addr
, 
sym
->
size
, 
¬—
);

554 ià(
	`IS_ERR
(
mem
)) {

555 
	`nå_”r
(
¹bl
->
ýp
, "rtysm '%s': failedo map: %ld\n",

556 
Çme
, 
	`PTR_ERR
(
mem
));

557  
mem
;

560  
mem
;

561 
	}
}

	@src/nfpcore/nfp_target.c

12 
	#´_fmt
(
fmt
è"NFP¬g‘: " 
	)
fmt

14 
	~<lšux/b™Ýs.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/´štk.h
>

18 
	~"nå_ýp.h
"

20 
	~"nå6000/nå6000.h
"

22 
	#P32
 1

	)

23 
	#P64
 2

	)

29 
	#AT
(
_aùiÚ
, 
_tok’
, 
_puÎ
, 
_push
) \

30 
	`NFP_CPP_ID
(0, (
_aùiÚ
), (
_tok’
)): \

31  
	`PUSHPULL
((
_puÎ
), (
_push
))

	)

33 
	$rg‘_rw
(
u32
 
ýp_id
, 
µ
, 
¡¬t
, 
Ën
)

35 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

36 
	`AT
(0, 0, 0, 
µ
);

37 
	`AT
(1, 0, 
µ
, 0);

38 
	`AT
(
NFP_CPP_ACTION_RW
, 0, 
µ
,…p);

40  -
EINVAL
;

42 
	}
}

44 
	$nå6000_nbi_dma
(
u32
 
ýp_id
)

46 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

47 
	`AT
(0, 0, 0, 
P64
);

48 
	`AT
(1, 0, 
P64
, 0);

49 
	`AT
(
NFP_CPP_ACTION_RW
, 0, 
P64
, P64);

51  -
EINVAL
;

53 
	}
}

55 
	$nå6000_nbi_¡©s
(
u32
 
ýp_id
)

57 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

58 
	`AT
(0, 0, 0, 
P32
);

59 
	`AT
(1, 0, 
P32
, 0);

60 
	`AT
(
NFP_CPP_ACTION_RW
, 0, 
P32
, P32);

62  -
EINVAL
;

64 
	}
}

66 
	$nå6000_nbi_tm
(
u32
 
ýp_id
)

68 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

69 
	`AT
(0, 0, 0, 
P64
);

70 
	`AT
(1, 0, 
P64
, 0);

71 
	`AT
(
NFP_CPP_ACTION_RW
, 0, 
P64
, P64);

73  -
EINVAL
;

75 
	}
}

77 
	$nå6000_nbi_µc
(
u32
 
ýp_id
)

79 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

80 
	`AT
(0, 0, 0, 
P64
);

81 
	`AT
(1, 0, 
P64
, 0);

82 
	`AT
(
NFP_CPP_ACTION_RW
, 0, 
P64
, P64);

84  -
EINVAL
;

86 
	}
}

88 
	$nå6000_nbi
(
u32
 
ýp_id
, 
u64
 
add»ss
)

90 
u64
 
»l_addr
 = 
add»ss
 & 0x3fFFFF;

92 ià(
»l_addr
 < (1 << 20))

93  
	`nå6000_nbi_dma
(
ýp_id
);

94 ià(
»l_addr
 < (2 << 20))

95  
	`nå6000_nbi_¡©s
(
ýp_id
);

96 ià(
»l_addr
 < (3 << 20))

97  
	`nå6000_nbi_tm
(
ýp_id
);

98  
	`nå6000_nbi_µc
(
ýp_id
);

99 
	}
}

104 
	$nå6000_mu_commÚ
(
u32
 
ýp_id
)

106 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

107 
	`AT
(
NFP_CPP_ACTION_RW
, 0, 
P64
, P64);

108 
	`AT
(
NFP_CPP_ACTION_RW
, 1, 
P64
, P64);

109 
	`AT
(
NFP_CPP_ACTION_RW
, 2, 
P64
, P64);

110 
	`AT
(
NFP_CPP_ACTION_RW
, 3, 
P64
, P64);

111 
	`AT
(0, 0, 0, 
P64
);

112 
	`AT
(0, 1, 0, 
P64
);

113 
	`AT
(0, 2, 0, 
P64
);

114 
	`AT
(0, 3, 0, 
P64
);

115 
	`AT
(1, 0, 
P64
, 0);

116 
	`AT
(1, 1, 
P64
, 0);

117 
	`AT
(1, 2, 
P64
, 0);

118 
	`AT
(1, 3, 
P64
, 0);

119 
	`AT
(3, 0, 0, 
P32
);

120 
	`AT
(3, 2, 
P32
, 0);

121 
	`AT
(4, 0, 
P32
, 0);

122 
	`AT
(4, 2, 0, 0);

123 
	`AT
(4, 3, 0, 
P32
);

124 
	`AT
(5, 0, 
P32
, 0);

125 
	`AT
(5, 3, 0, 
P32
);

126 
	`AT
(6, 0, 
P32
, 0);

127 
	`AT
(6, 3, 0, 
P32
);

128 
	`AT
(7, 0, 
P32
, 0);

129 
	`AT
(7, 3, 0, 
P32
);

130 
	`AT
(8, 0, 
P32
, 0);

131 
	`AT
(8, 3, 0, 
P32
);

132 
	`AT
(9, 0, 
P32
, 0);

133 
	`AT
(9, 3, 0, 
P32
);

134 
	`AT
(10, 0, 
P32
, 0);

135 
	`AT
(10, 3, 0, 
P32
);

136 
	`AT
(13, 0, 0, 
P32
);

137 
	`AT
(13, 1, 0, 
P32
);

138 
	`AT
(13, 2, 
P32
, 0);

139 
	`AT
(15, 0, 
P32
, 0);

140 
	`AT
(15, 3, 0, 
P32
);

141 
	`AT
(28, 0, 0, 
P32
);

142 
	`AT
(28, 1, 0, 
P32
);

143 
	`AT
(28, 2, 0, 
P32
);

144 
	`AT
(28, 3, 0, 
P32
);

145 
	`AT
(31, 0, 
P32
, 0);

146 
	`AT
(31, 1, 
P32
, 0);

147 
	`AT
(31, 2, 
P32
, 0);

148 
	`AT
(31, 3, 
P32
, 0);

150  -
EINVAL
;

152 
	}
}

154 
	$nå6000_mu_ùm
(
u32
 
ýp_id
)

156 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

157 
	`AT
(16, 1, 0, 
P32
);

158 
	`AT
(17, 1, 0, 
P32
);

159 
	`AT
(17, 3, 0, 
P64
);

160 
	`AT
(18, 2, 0, 
P64
);

161 
	`AT
(18, 3, 0, 
P64
);

162 
	`AT
(21, 0, 0, 
P64
);

163 
	`AT
(21, 1, 0, 
P64
);

164 
	`AT
(21, 2, 0, 
P64
);

165 
	`AT
(21, 3, 0, 
P64
);

167  
	`nå6000_mu_commÚ
(
ýp_id
);

169 
	}
}

171 
	$nå6000_mu_emu
(
u32
 
ýp_id
)

173 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

174 
	`AT
(18, 0, 0, 
P32
);

175 
	`AT
(18, 1, 0, 
P32
);

176 
	`AT
(18, 2, 
P32
, 0);

177 
	`AT
(18, 3, 
P32
, 0);

178 
	`AT
(20, 2, 
P32
, 0);

179 
	`AT
(21, 0, 0, 
P32
);

180 
	`AT
(21, 1, 0, 
P32
);

181 
	`AT
(21, 2, 0, 
P32
);

182 
	`AT
(22, 0, 0, 
P32
);

183 
	`AT
(22, 1, 0, 
P32
);

184 
	`AT
(22, 2, 0, 
P32
);

186  
	`nå6000_mu_commÚ
(
ýp_id
);

188 
	}
}

190 
	$nå6000_mu_imu
(
u32
 
ýp_id
)

192  
	`nå6000_mu_commÚ
(
ýp_id
);

193 
	}
}

195 
	$nå6000_mu
(
u32
 
ýp_id
, 
u64
 
add»ss
)

197 
µ
;

199 ià(
add»ss
 < 0x2000000000ULL)

200 
µ
 = 
	`nå6000_mu_ùm
(
ýp_id
);

201 ià(
add»ss
 < 0x8000000000ULL)

202 
µ
 = 
	`nå6000_mu_emu
(
ýp_id
);

203 ià(
add»ss
 < 0x9800000000ULL)

204 
µ
 = 
	`nå6000_mu_ùm
(
ýp_id
);

205 ià(
add»ss
 < 0x9C00000000ULL)

206 
µ
 = 
	`nå6000_mu_emu
(
ýp_id
);

207 ià(
add»ss
 < 0xA000000000ULL)

208 
µ
 = 
	`nå6000_mu_imu
(
ýp_id
);

210 
µ
 = 
	`nå6000_mu_ùm
(
ýp_id
);

212  
µ
;

213 
	}
}

215 
	$nå6000_ža
(
u32
 
ýp_id
)

217 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

218 
	`AT
(0, 1, 0, 
P32
);

219 
	`AT
(2, 0, 0, 
P32
);

220 
	`AT
(3, 0, 
P32
, 0);

222  
	`rg‘_rw
(
ýp_id
, 
P32
, 48, 4);

224 
	}
}

226 
	$nå6000_pci
(
u32
 
ýp_id
)

228 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

229 
	`AT
(2, 0, 0, 
P32
);

230 
	`AT
(3, 0, 
P32
, 0);

232  
	`rg‘_rw
(
ýp_id
, 
P32
, 4, 4);

234 
	}
}

236 
	$nå6000_üy±o
(
u32
 
ýp_id
)

238 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

239 
	`AT
(2, 0, 
P64
, 0);

241  
	`rg‘_rw
(
ýp_id
, 
P64
, 12, 4);

243 
	}
}

245 
	$nå6000_ÿp_xpb
(
u32
 
ýp_id
)

247 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

248 
	`AT
(0, 1, 0, 
P32
);

249 
	`AT
(0, 2, 
P32
, 0);

250 
	`AT
(1, 1, 
P32
, 0);

251 
	`AT
(1, 2, 
P32
, 0);

252 
	`AT
(2, 0, 0, 
P32
);

253 
	`AT
(2, 1, 0, 
P32
);

254 
	`AT
(2, 2, 0, 
P32
);

255 
	`AT
(2, 3, 0, 
P32
);

256 
	`AT
(3, 0, 
P32
, 0);

257 
	`AT
(3, 1, 
P32
, 0);

258 
	`AT
(3, 2, 
P32
, 0);

259 
	`AT
(3, 3, 
P32
, 0);

260 
	`AT
(
NFP_CPP_ACTION_RW
, 1, 
P32
, P32);

262  
	`rg‘_rw
(
ýp_id
, 
P32
, 1, 63);

264 
	}
}

266 
	$nå6000_þs
(
u32
 
ýp_id
)

268 
ýp_id
 & 
	`NFP_CPP_ID
(0, ~0, ~0)) {

269 
	`AT
(0, 3, 
P32
, 0);

270 
	`AT
(2, 0, 
P32
, 0);

271 
	`AT
(2, 1, 
P32
, 0);

272 
	`AT
(4, 0, 
P32
, 0);

273 
	`AT
(4, 1, 
P32
, 0);

274 
	`AT
(6, 0, 
P32
, 0);

275 
	`AT
(6, 1, 
P32
, 0);

276 
	`AT
(6, 2, 
P32
, 0);

277 
	`AT
(8, 2, 
P32
, 0);

278 
	`AT
(8, 3, 
P32
, 0);

279 
	`AT
(9, 0, 0, 
P32
);

280 
	`AT
(9, 1, 0, 
P32
);

281 
	`AT
(9, 2, 0, 
P32
);

282 
	`AT
(9, 3, 0, 
P32
);

283 
	`AT
(10, 0, 
P32
, 0);

284 
	`AT
(10, 2, 
P32
, 0);

285 
	`AT
(14, 0, 
P32
, 0);

286 
	`AT
(15, 1, 0, 
P32
);

287 
	`AT
(17, 2, 
P32
, 0);

288 
	`AT
(24, 0, 0, 
P32
);

289 
	`AT
(24, 1, 
P32
, 0);

290 
	`AT
(25, 0, 0, 
P32
);

291 
	`AT
(25, 1, 
P32
, 0);

293  
	`rg‘_rw
(
ýp_id
, 
P32
, 0, 64);

295 
	}
}

297 
	$nå_rg‘_pushpuÎ
(
u32
 
ýp_id
, 
u64
 
add»ss
)

299 
	`NFP_CPP_ID_TARGET_of
(
ýp_id
)) {

300 
NFP_CPP_TARGET_NBI
:

301  
	`nå6000_nbi
(
ýp_id
, 
add»ss
);

302 
NFP_CPP_TARGET_QDR
:

303  
	`rg‘_rw
(
ýp_id
, 
P32
, 24, 4);

304 
NFP_CPP_TARGET_ILA
:

305  
	`nå6000_ža
(
ýp_id
);

306 
NFP_CPP_TARGET_MU
:

307  
	`nå6000_mu
(
ýp_id
, 
add»ss
);

308 
NFP_CPP_TARGET_PCIE
:

309  
	`nå6000_pci
(
ýp_id
);

310 
NFP_CPP_TARGET_ARM
:

311 ià(
add»ss
 < 0x10000)

312  
	`rg‘_rw
(
ýp_id
, 
P64
, 1, 1);

314  
	`rg‘_rw
(
ýp_id
, 
P32
, 1, 1);

315 
NFP_CPP_TARGET_CRYPTO
:

316  
	`nå6000_üy±o
(
ýp_id
);

317 
NFP_CPP_TARGET_CT_XPB
:

318  
	`nå6000_ÿp_xpb
(
ýp_id
);

319 
NFP_CPP_TARGET_CLS
:

320  
	`nå6000_þs
(
ýp_id
);

322  
	`rg‘_rw
(
ýp_id
, 
P32
, 4, 4);

324  -
EINVAL
;

326 
	}
}

328 #undeà
AT


329 #undeà
P32


330 #undeà
P64


341 
	#_NIC_NFP6000_MU_LOCALITY_DIRECT
 2

	)

343 
	$nå_decode_basic
(
u64
 
addr
, *
de¡_i¦ªd
, 
ýp_tgt
,

344 
mode
, 
boÞ
 
addr40
, 
i¦d1
, 
i¦d0
)

346 
iid_lsb
, 
idx_lsb
;

349 ià(
ýp_tgt
 =ð
NFP_CPP_TARGET_MU
 || cµ_tgˆ=ð
NFP_CPP_TARGET_CT_XPB
)

350  -
EINVAL
;

352 
mode
) {

362 
iid_lsb
 = 
addr40
 ? 34 : 26;

363 *
de¡_i¦ªd
 = (
addr
 >> 
iid_lsb
) & 0x3F;

374 
idx_lsb
 = 
addr40
 ? 39 : 31;

375 ià(
addr
 & 
	`BIT_ULL
(
idx_lsb
))

376 *
de¡_i¦ªd
 = 
i¦d1
;

378 *
de¡_i¦ªd
 = 
i¦d0
;

392 
i¦d0
 &= ~1;

393 
i¦d1
 &= ~1;

395 
idx_lsb
 = 
addr40
 ? 39 : 31;

396 
iid_lsb
 = 
idx_lsb
 - 1;

398 ià(
addr
 & 
	`BIT_ULL
(
idx_lsb
))

399 *
de¡_i¦ªd
 = 
i¦d1
 | ()((
addr
 >> 
iid_lsb
) & 1);

401 *
de¡_i¦ªd
 = 
i¦d0
 | ()((
addr
 >> 
iid_lsb
) & 1);

414 
i¦d0
 &= ~3;

415 
i¦d1
 &= ~3;

417 
idx_lsb
 = 
addr40
 ? 39 : 31;

418 
iid_lsb
 = 
idx_lsb
 - 2;

420 ià(
addr
 & 
	`BIT_ULL
(
idx_lsb
))

421 *
de¡_i¦ªd
 = 
i¦d1
 | ()((
addr
 >> 
iid_lsb
) & 3);

423 *
de¡_i¦ªd
 = 
i¦d0
 | ()((
addr
 >> 
iid_lsb
) & 3);

427  -
EINVAL
;

429 
	}
}

431 
	$nå_’code_basic_qdr
(
u64
 
addr
, 
de¡_i¦ªd
, 
ýp_tgt
,

432 
mode
, 
boÞ
 
addr40
, 
i¦d1
, 
i¦d0
)

434 
v
, 
»t
;

437 
»t
 = 
	`nå_decode_basic
(
addr
, &
v
, 
ýp_tgt
, 
mode
, 
addr40
, 
i¦d1
, 
i¦d0
);

438 ià(
»t
)

439  
»t
;

442 ià(
de¡_i¦ªd
 !ð-1 && de¡_i¦ªd !ð
v
)

443  -
EINVAL
;

447 
	}
}

453 
	$nå_’code_basic_£¬ch
(
u64
 *
addr
, 
de¡_i¦ªd
, *
i¦d
,

454 
iid_lsb
, 
idx_lsb
, 
v_max
)

456 
i
, 
v
;

458 
i
 = 0; i < 2; i++)

459 
v
 = 0; v < 
v_max
; v++) {

460 ià(
de¡_i¦ªd
 !ð(
i¦d
[
i
] | 
v
))

463 *
addr
 &ð~
	`GENMASK_ULL
(
idx_lsb
, 
iid_lsb
);

464 *
addr
 |ð((
u64
)
i
 << 
idx_lsb
);

465 *
addr
 |ð((
u64
)
v
 << 
iid_lsb
);

469  -
ENODEV
;

470 
	}
}

475 
	$nå_’code_basic
(
u64
 *
addr
, 
de¡_i¦ªd
, 
ýp_tgt
,

476 
mode
, 
boÞ
 
addr40
, 
i¦d1
, 
i¦d0
)

478 
iid_lsb
, 
idx_lsb
;

479 
i¦d
[2];

480 
u64
 
v64
;

482 
i¦d
[0] = 
i¦d0
;

483 
i¦d
[1] = 
i¦d1
;

486 ià(
ýp_tgt
 =ð
NFP_CPP_TARGET_MU
 || cµ_tgˆ=ð
NFP_CPP_TARGET_CT_XPB
)

487  -
EINVAL
;

489 
mode
) {

491 ià(
ýp_tgt
 =ð
NFP_CPP_TARGET_QDR
 && !
addr40
)

496  
	`nå_’code_basic_qdr
(*
addr
, 
ýp_tgt
, 
de¡_i¦ªd
,

497 
mode
, 
addr40
, 
i¦d1
, 
i¦d0
);

499 
iid_lsb
 = 
addr40
 ? 34 : 26;

501 
v64
 = 
	`GENMASK_ULL
(
iid_lsb
 + 5, iid_lsb);

502 *
addr
 &ð~
v64
;

503 *
addr
 |ð((
u64
)
de¡_i¦ªd
 << 
iid_lsb
è& 
v64
;

506 ià(
ýp_tgt
 =ð
NFP_CPP_TARGET_QDR
 && !
addr40
)

507  
	`nå_’code_basic_qdr
(*
addr
, 
ýp_tgt
, 
de¡_i¦ªd
,

508 
mode
, 
addr40
, 
i¦d1
, 
i¦d0
);

510 
idx_lsb
 = 
addr40
 ? 39 : 31;

511 ià(
de¡_i¦ªd
 =ð
i¦d0
) {

513 *
addr
 &ð~
	`BIT_ULL
(
idx_lsb
);

517 ià(
de¡_i¦ªd
 =ð
i¦d1
) {

519 *
addr
 |ð
	`BIT_ULL
(
idx_lsb
);

523  -
ENODEV
;

528 ià(
ýp_tgt
 =ð
NFP_CPP_TARGET_QDR
 && !
addr40
)

533  
	`nå_’code_basic_qdr
(*
addr
, 
ýp_tgt
, 
de¡_i¦ªd
,

534 
mode
, 
addr40
, 
i¦d1
, 
i¦d0
);

540 
i¦d
[0] &= ~1;

541 
i¦d
[1] &= ~1;

543 
idx_lsb
 = 
addr40
 ? 39 : 31;

544 
iid_lsb
 = 
idx_lsb
 - 1;

546  
	`nå_’code_basic_£¬ch
(
addr
, 
de¡_i¦ªd
, 
i¦d
,

547 
iid_lsb
, 
idx_lsb
, 2);

549 ià(
ýp_tgt
 =ð
NFP_CPP_TARGET_QDR
 && !
addr40
)

554  
	`nå_’code_basic_qdr
(*
addr
, 
ýp_tgt
, 
de¡_i¦ªd
,

555 
mode
, 
addr40
, 
i¦d1
, 
i¦d0
);

557 
i¦d
[0] &= ~3;

558 
i¦d
[1] &= ~3;

560 
idx_lsb
 = 
addr40
 ? 39 : 31;

561 
iid_lsb
 = 
idx_lsb
 - 2;

563  
	`nå_’code_basic_£¬ch
(
addr
, 
de¡_i¦ªd
, 
i¦d
,

564 
iid_lsb
, 
idx_lsb
, 4);

566  -
EINVAL
;

568 
	}
}

570 
	$nå_’code_mu
(
u64
 *
addr
, 
de¡_i¦ªd
, 
mode
,

571 
boÞ
 
addr40
, 
i¦d1
, 
i¦d0
)

573 
iid_lsb
, 
idx_lsb
, 
loÿl™y_lsb
;

574 
i¦d
[2];

575 
u64
 
v64
;

576 
da
;

578 
i¦d
[0] = 
i¦d0
;

579 
i¦d
[1] = 
i¦d1
;

580 
loÿl™y_lsb
 = 
	`nå_ý·t_mu_loÿl™y_lsb
(
mode
, 
addr40
);

582 ià(((*
addr
 >> 
loÿl™y_lsb
è& 3è=ð
_NIC_NFP6000_MU_LOCALITY_DIRECT
)

583 
da
 = 1;

585 
da
 = 0;

587 
mode
) {

589 
iid_lsb
 = 
addr40
 ? 32 : 24;

590 
v64
 = 
	`GENMASK_ULL
(
iid_lsb
 + 5, iid_lsb);

591 *
addr
 &ð~
v64
;

592 *
addr
 |ð(((
u64
)
de¡_i¦ªd
è<< 
iid_lsb
è& 
v64
;

595 ià(
da
) {

596 
iid_lsb
 = 
addr40
 ? 32 : 24;

597 
v64
 = 
	`GENMASK_ULL
(
iid_lsb
 + 5, iid_lsb);

598 *
addr
 &ð~
v64
;

599 *
addr
 |ð(((
u64
)
de¡_i¦ªd
è<< 
iid_lsb
è& 
v64
;

603 
idx_lsb
 = 
addr40
 ? 37 : 29;

604 ià(
de¡_i¦ªd
 =ð
i¦d0
) {

605 *
addr
 &ð~
	`BIT_ULL
(
idx_lsb
);

609 ià(
de¡_i¦ªd
 =ð
i¦d1
) {

610 *
addr
 |ð
	`BIT_ULL
(
idx_lsb
);

614  -
ENODEV
;

616 ià(
da
) {

617 
iid_lsb
 = 
addr40
 ? 32 : 24;

618 
v64
 = 
	`GENMASK_ULL
(
iid_lsb
 + 5, iid_lsb);

619 *
addr
 &ð~
v64
;

620 *
addr
 |ð(((
u64
)
de¡_i¦ªd
è<< 
iid_lsb
è& 
v64
;

628 
i¦d
[0] &= ~1;

629 
i¦d
[1] &= ~1;

631 
idx_lsb
 = 
addr40
 ? 37 : 29;

632 
iid_lsb
 = 
idx_lsb
 - 1;

634  
	`nå_’code_basic_£¬ch
(
addr
, 
de¡_i¦ªd
, 
i¦d
,

635 
iid_lsb
, 
idx_lsb
, 2);

645 ià(
de¡_i¦ªd
 > 0 && (dest_island < 24 || dest_island > 26)) {

646 *
addr
 |ð((
u64
)
_NIC_NFP6000_MU_LOCALITY_DIRECT
)

647 << 
loÿl™y_lsb
;

648 
da
 = 1;

651 ià(
da
) {

652 
iid_lsb
 = 
addr40
 ? 32 : 24;

653 
v64
 = 
	`GENMASK_ULL
(
iid_lsb
 + 5, iid_lsb);

654 *
addr
 &ð~
v64
;

655 *
addr
 |ð(((
u64
)
de¡_i¦ªd
è<< 
iid_lsb
è& 
v64
;

659 
i¦d
[0] &= ~3;

660 
i¦d
[1] &= ~3;

662 
idx_lsb
 = 
addr40
 ? 37 : 29;

663 
iid_lsb
 = 
idx_lsb
 - 2;

665  
	`nå_’code_basic_£¬ch
(
addr
, 
de¡_i¦ªd
, 
i¦d
,

666 
iid_lsb
, 
idx_lsb
, 4);

668  -
EINVAL
;

670 
	}
}

672 
	$nå_ý·t_addr_’code
(
u64
 *
addr
, 
de¡_i¦ªd
, 
ýp_tgt
,

673 
mode
, 
boÞ
 
addr40
, 
i¦d1
, 
i¦d0
)

675 
ýp_tgt
) {

676 
NFP_CPP_TARGET_NBI
:

677 
NFP_CPP_TARGET_QDR
:

678 
NFP_CPP_TARGET_ILA
:

679 
NFP_CPP_TARGET_PCIE
:

680 
NFP_CPP_TARGET_ARM
:

681 
NFP_CPP_TARGET_CRYPTO
:

682 
NFP_CPP_TARGET_CLS
:

683  
	`nå_’code_basic
(
addr
, 
de¡_i¦ªd
, 
ýp_tgt
, 
mode
,

684 
addr40
, 
i¦d1
, 
i¦d0
);

686 
NFP_CPP_TARGET_MU
:

687  
	`nå_’code_mu
(
addr
, 
de¡_i¦ªd
, 
mode
,

688 
addr40
, 
i¦d1
, 
i¦d0
);

690 
NFP_CPP_TARGET_CT_XPB
:

691 ià(
mode
 !ð1 || 
addr40
)

692  -
EINVAL
;

693 *
addr
 &ð~
	`GENMASK_ULL
(29, 24);

694 *
addr
 |ð((
u64
)
de¡_i¦ªd
 << 24è& 
	`GENMASK_ULL
(29, 24);

697  -
EINVAL
;

699 
	}
}

701 
	$nå_rg‘_ýp
(
u32
 
ýp_i¦ªd_id
, 
u64
 
ýp_i¦ªd_add»ss
,

702 
u32
 *
ýp_rg‘_id
, 
u64
 *
ýp_rg‘_add»ss
,

703 cÚ¡ 
u32
 *
imb_bË
)

705 cÚ¡ 
i¦ªd
 = 
	`NFP_CPP_ID_ISLAND_of
(
ýp_i¦ªd_id
);

706 cÚ¡ 
rg‘
 = 
	`NFP_CPP_ID_TARGET_of
(
ýp_i¦ªd_id
);

707 
u32
 
imb
;

708 
”r
;

710 ià(
rg‘
 < 0 ||arget >= 16) {

711 
	`´_”r
("Inv®id CPP¬g‘: %d\n", 
rg‘
);

712  -
EINVAL
;

715 ià(
i¦ªd
 == 0) {

717 *
ýp_rg‘_id
 = 
ýp_i¦ªd_id
;

718 *
ýp_rg‘_add»ss
 = 
ýp_i¦ªd_add»ss
;

723 ià(!
imb_bË
)

724  -
EINVAL
;

726 
imb
 = 
imb_bË
[
rg‘
];

728 *
ýp_rg‘_add»ss
 = 
ýp_i¦ªd_add»ss
;

729 
”r
 = 
	`nå_ý·t_addr_’code
(
ýp_rg‘_add»ss
, 
i¦ªd
, 
rg‘
,

730 ((
imb
 >> 13) & 7), ((imb >> 12) & 1),

731 ((
imb
 >> 6) & 0x3f), ((imb >> 0) & 0x3f));

732 ià(
”r
) {

733 
	`´_”r
("Cª'ˆ’codCPP‡dd»ss: %d\n", 
”r
);

734  
”r
;

737 *
ýp_rg‘_id
 = 
	`NFP_CPP_ID
(
rg‘
,

738 
	`NFP_CPP_ID_ACTION_of
(
ýp_i¦ªd_id
),

739 
	`NFP_CPP_ID_TOKEN_of
(
ýp_i¦ªd_id
));

742 
	}
}

	@src/nic/main.c

4 
	~"../nåcÜe/nå_ýp.h
"

5 
	~"../nåcÜe/nå_n¥.h
"

6 
	~"../nå_­p.h
"

7 
	~"../nå_maš.h
"

9 
	$nå_nic_š™
(
nå_­p
 *
­p
)

11 
nå_pf
 *
pf
 = 
­p
->pf;

13 ià(
pf
->
‘h_tbl
 &&…f->
max_d©a_vnics
 !ðpf->‘h_tbl->
couÁ
) {

14 
	`nå_”r
(
pf
->
ýp
, "ETHƒntries don't match vNICs (%d vs %d)\n",

15 
pf
->
max_d©a_vnics
,…f->
‘h_tbl
->
couÁ
);

16  -
EINVAL
;

20 
	}
}

22 
	$nå_nic_¤iov_’abË
(
nå_­p
 *
­p
, 
num_vfs
)

25 
	}
}

27 
	$nå_nic_¤iov_di§bË
(
nå_­p
 *
­p
)

29 
	}
}

31 cÚ¡ 
nå_­p_ty³
 
	g­p_nic
 = {

32 .
id
 = 
NFP_APP_CORE_NIC
,

33 .
	gÇme
 = "nic",

35 .
	gš™
 = 
nå_nic_š™
,

36 .
	gvnic_®loc
 = 
nå_­p_nic_vnic_®loc
,

38 .
	g¤iov_’abË
 = 
nå_nic_¤iov_’abË
,

39 .
	g¤iov_di§bË
 = 
nå_nic_¤iov_di§bË
,

	@tests/samples/bpf/bpf_api.h

1 #iâdeà
__BPF_API__


2 
	#__BPF_API__


	)

11 
	~<¡dšt.h
>

13 
	~<lšux/pkt_þs.h
>

14 
	~<lšux/bpf.h
>

15 
	~<lšux/fž‹r.h
>

17 
	~<asm/by‹Üd”.h
>

19 
	~"bpf_–f.h
"

23 #iâdeà
__¡ršgify


24 
	#__¡ršgify
(
X
è#X

	)

27 #iâdeà
__maybe_unu£d


28 
	#__maybe_unu£d
 
	`__©Œibu‹__
((
__unu£d__
))

	)

31 #iâdeà
off£tof


32 
	#off£tof
(
TYPE
, 
MEMBER
è
	`__bužtš_off£tof
(TYPE, MEMBER)

	)

35 #iâdeà
lik–y


36 
	#lik–y
(
X
è
	`__bužtš_ex³ù
(!!(X), 1)

	)

39 #iâdeà
uÆik–y


40 
	#uÆik–y
(
X
è
	`__bužtš_ex³ù
(!!(X), 0)

	)

43 #iâdeà
htÚs


44 
	#htÚs
(
X
è
	`__cÚ¡ªt_htÚs
((X))

	)

47 #iâdeà
Áohs


48 
	#Áohs
(
X
è
	`__cÚ¡ªt_Áohs
((X))

	)

51 #iâdeà
htÚl


52 
	#htÚl
(
X
è
	`__cÚ¡ªt_htÚl
((X))

	)

55 #iâdeà
Áohl


56 
	#Áohl
(
X
è
	`__cÚ¡ªt_Áohl
((X))

	)

59 #iâdeà
__šlše__


60 
	#__šlše__
 
	`__©Œibu‹__
((
®ways_šlše
))

	)

65 #iâdeà
__£ùiÚ


66 
	#__£ùiÚ
(
NAME
) \

67 
	`__©Œibu‹__
((
	`£ùiÚ
(
NAME
), 
u£d
))

	)

70 #iâdeà
__£ùiÚ_ž


71 
	#__£ùiÚ_ž
(
ID
, 
KEY
) \

72 
	`__£ùiÚ
(
	`__¡ršgify
(
ID
è"/" __¡ršgify(
KEY
))

	)

75 #iâdeà
__£ùiÚ_xdp_’Œy


76 
	#__£ùiÚ_xdp_’Œy
 \

77 
	`__£ùiÚ
(
ELF_SECTION_PROG
)

	)

80 #iâdeà
__£ùiÚ_þs_’Œy


81 
	#__£ùiÚ_þs_’Œy
 \

82 
	`__£ùiÚ
(
ELF_SECTION_CLASSIFIER
)

	)

85 #iâdeà
__£ùiÚ_aù_’Œy


86 
	#__£ùiÚ_aù_’Œy
 \

87 
	`__£ùiÚ
(
ELF_SECTION_ACTION
)

	)

90 #iâdeà
__£ùiÚ_lwt_’Œy


91 
	#__£ùiÚ_lwt_’Œy
 \

92 
	`__£ùiÚ
(
ELF_SECTION_PROG
)

	)

95 #iâdeà
__£ùiÚ_liûn£


96 
	#__£ùiÚ_liûn£
 \

97 
	`__£ùiÚ
(
ELF_SECTION_LICENSE
)

	)

100 #iâdeà
__£ùiÚ_m­s


101 
	#__£ùiÚ_m­s
 \

102 
	`__£ùiÚ
(
ELF_SECTION_MAPS
)

	)

107 #iâdeà
BPF_LICENSE


108 
	#BPF_LICENSE
(
NAME
) \

109 
____liûn£
[] 
__£ùiÚ_liûn£
 = 
NAME


	)

114 #iâdeà
BPF_H_DEFAULT


115 
	#BPF_H_DEFAULT
 -1

	)

120 #iâdeà
__BPF_FUNC


121 
	#__BPF_FUNC
(
NAME
, ...) \

122 (* 
NAME
)(
__VA_ARGS__
è
__maybe_unu£d


	)

125 #iâdeà
BPF_FUNC


126 
	#BPF_FUNC
(
NAME
, ...) \

127 
	`__BPF_FUNC
(
NAME
, 
__VA_ARGS__
èð(*è
BPF_FUNC_
##
	)
NAME

131 *
BPF_FUNC
(
m­_lookup_–em
, *
m­
, cÚ¡ *
key
);

132 
BPF_FUNC
(
m­_upd©e_–em
, *
m­
, cÚ¡ *
key
,

133 cÚ¡ *
v®ue
, 
ušt32_t
 
æags
);

134 
BPF_FUNC
(
m­_d–‘e_–em
, *
m­
, cÚ¡ *
key
);

137 
ušt64_t
 
BPF_FUNC
(
ktime_g‘_ns
);

146 
BPF_FUNC
(
Œaû_´štk
, cÚ¡ *
fmt
, 
fmt_size
, ...);

148 #iâdeà
´š‰


149 
	#´š‰
(
fmt
, ...) \

151 
____fmt
[] = 
fmt
; \

152 
	`Œaû_´štk
(
____fmt
, (____fmt), ##
__VA_ARGS__
); \

153 })

	)

157 
BPF_FUNC
(
skb_¡Üe_by‹s
, 
__sk_buff
 *
skb
, 
ušt32_t
 
off
,

158 cÚ¡ *
äom
, 
ušt32_t
 
Ën
, ušt32_ˆ
æags
);

162 #iâdeà
lock_xadd


163 
	#lock_xadd
(
±r
, 
v®
è((è
	`__sync_ãtch_ªd_add
ÕŒ, v®))

	)

166 #iâdeà
mem£t


167 
	#mem£t
(
s
, 
c
, 
n
è
	`__bužtš_mem£t
((s), (c), (n))

	)

170 #iâdeà
memýy


171 
	#memýy
(
d
, 
s
, 
n
è
	`__bužtš_memýy
((d), (s), (n))

	)

174 #iâdeà
memmove


175 
	#memmove
(
d
, 
s
, 
n
è
	`__bužtš_memmove
((d), (s), (n))

	)

183 #iâdeà
memcmp


184 
	#memcmp
(
a
, 
b
, 
n
è
	`__bužtš_memcmp
(×), (b), (n))

	)

188 
	$lßd_by‹
(*
skb
, 
off
)

189 
	`asm
 ("llvm.bpf.load.byte");

191 
	$lßd_h®f
(*
skb
, 
off
)

192 
	`asm
 ("llvm.bpf.load.half");

194 
	$lßd_wÜd
(*
skb
, 
off
)

195 
	`asm
 ("llvm.bpf.load.word");

	@tests/samples/bpf/bpf_elf.h

1 #iâdeà
__BPF_ELF__


2 
	#__BPF_ELF__


	)

4 
	~<asm/ty³s.h
>

16 
	#ELF_SECTION_LICENSE
 "liûn£"

	)

17 
	#ELF_SECTION_MAPS
 "m­s"

	)

18 
	#ELF_SECTION_PROG
 "´og"

	)

19 
	#ELF_SECTION_CLASSIFIER
 "þassif›r"

	)

20 
	#ELF_SECTION_ACTION
 "aùiÚ"

	)

22 
	#ELF_MAX_MAPS
 64

	)

23 
	#ELF_MAX_LICENSE_LEN
 128

	)

26 
	#PIN_NONE
 0

	)

27 
	#PIN_OBJECT_NS
 1

	)

28 
	#PIN_GLOBAL_NS
 2

	)

31 
	sbpf_–f_m­
 {

32 
__u32
 
	mty³
;

33 
__u32
 
	msize_key
;

34 
__u32
 
	msize_v®ue
;

35 
__u32
 
	mmax_–em
;

36 
__u32
 
	mæags
;

37 
__u32
 
	mid
;

38 
__u32
 
	mpšnšg
;

	@tests/samples/bpf/bpf_endian.h

3 #iâdeà
__BPF_ENDIAN__


4 
	#__BPF_ENDIAN__


	)

6 
	~<lšux/swab.h
>

23 #ià
__BYTE_ORDER__
 =ð
__ORDER_LITTLE_ENDIAN__


24 
	#__bpf_Áohs
(
x
)
	`__bužtš_bsw­16
(x)

	)

25 
	#__bpf_htÚs
(
x
)
	`__bužtš_bsw­16
(x)

	)

26 
	#__bpf_cÚ¡ªt_Áohs
(
x
)
	`___cÚ¡ªt_swab16
(x)

	)

27 
	#__bpf_cÚ¡ªt_htÚs
(
x
)
	`___cÚ¡ªt_swab16
(x)

	)

28 
	#__bpf_Áohl
(
x
)
	`__bužtš_bsw­32
(x)

	)

29 
	#__bpf_htÚl
(
x
)
	`__bužtš_bsw­32
(x)

	)

30 
	#__bpf_cÚ¡ªt_Áohl
(
x
)
	`___cÚ¡ªt_swab32
(x)

	)

31 
	#__bpf_cÚ¡ªt_htÚl
(
x
)
	`___cÚ¡ªt_swab32
(x)

	)

32 #–ià
__BYTE_ORDER__
 =ð
__ORDER_BIG_ENDIAN__


33 
	#__bpf_Áohs
(
x
)(x)

	)

34 
	#__bpf_htÚs
(
x
)(x)

	)

35 
	#__bpf_cÚ¡ªt_Áohs
(
x
)(x)

	)

36 
	#__bpf_cÚ¡ªt_htÚs
(
x
)(x)

	)

37 
	#__bpf_Áohl
(
x
)(x)

	)

38 
	#__bpf_htÚl
(
x
)(x)

	)

39 
	#__bpf_cÚ¡ªt_Áohl
(
x
)(x)

	)

40 
	#__bpf_cÚ¡ªt_htÚl
(
x
)(x)

	)

45 
	#bpf_htÚs
(
x
)\

46 (
	`__bužtš_cÚ¡ªt_p
(
x
) ?\

47 
	`__bpf_cÚ¡ªt_htÚs
(
x
è: 
	`__bpf_htÚs
(x))

	)

48 
	#bpf_Áohs
(
x
)\

49 (
	`__bužtš_cÚ¡ªt_p
(
x
) ?\

50 
	`__bpf_cÚ¡ªt_Áohs
(
x
è: 
	`__bpf_Áohs
(x))

	)

51 
	#bpf_htÚl
(
x
)\

52 (
	`__bužtš_cÚ¡ªt_p
(
x
) ?\

53 
	`__bpf_cÚ¡ªt_htÚl
(
x
è: 
	`__bpf_htÚl
(x))

	)

54 
	#bpf_Áohl
(
x
)\

55 (
	`__bužtš_cÚ¡ªt_p
(
x
) ?\

56 
	`__bpf_cÚ¡ªt_Áohl
(
x
è: 
	`__bpf_Áohl
(x))

	)

	@tests/samples/bpf/bpf_helpers.h

1 #iâdeà
__BPF_HELPERS_H


2 
	#__BPF_HELPERS_H


	)

8 
	#SEC
(
NAME
è
	`__©Œibu‹__
((
	`£ùiÚ
(NAME), 
u£d
))

	)

11 *(*
	gbpf_m­_lookup_–em
)(*
	gm­
, *
	gkey
) =

12 (*è
BPF_FUNC_m­_lookup_–em
;

13 (*
bpf_m­_upd©e_–em
)(*
m­
, *
key
, *
v®ue
,

14 
æags
) =

15 (*è
BPF_FUNC_m­_upd©e_–em
;

16 (*
bpf_m­_d–‘e_–em
)(*
m­
, *
key
) =

17 (*è
BPF_FUNC_m­_d–‘e_–em
;

18 (*
bpf_´obe_»ad
)(*
d¡
, 
size
, *
un§ã_±r
) =

19 (*è
BPF_FUNC_´obe_»ad
;

20 (*
bpf_ktime_g‘_ns
)() =

21 (*è
BPF_FUNC_ktime_g‘_ns
;

22 (*
bpf_Œaû_´štk
)(cÚ¡ *
fmt
, 
fmt_size
, ...) =

23 (*è
BPF_FUNC_Œaû_´štk
;

24 (*
bpf_ž_ÿÎ
)(*
ùx
, *
m­
, 
šdex
) =

25 (*è
BPF_FUNC_ž_ÿÎ
;

26 (*
bpf_g‘_smp_´oûssÜ_id
)() =

27 (*è
BPF_FUNC_g‘_smp_´oûssÜ_id
;

28 (*
bpf_g‘_cu¼’t_pid_tgid
)() =

29 (*è
BPF_FUNC_g‘_cu¼’t_pid_tgid
;

30 (*
bpf_g‘_cu¼’t_uid_gid
)() =

31 (*è
BPF_FUNC_g‘_cu¼’t_uid_gid
;

32 (*
bpf_g‘_cu¼’t_comm
)(*
buf
, 
buf_size
) =

33 (*è
BPF_FUNC_g‘_cu¼’t_comm
;

34 (*
bpf_³rf_ev’t_»ad
)(*
m­
,

35 
æags
) =

36 (*è
BPF_FUNC_³rf_ev’t_»ad
;

37 (*
bpf_þÚe_»dœeù
)(*
ùx
, 
ifšdex
, 
æags
) =

38 (*è
BPF_FUNC_þÚe_»dœeù
;

39 (*
bpf_»dœeù
)(
ifšdex
, 
æags
) =

40 (*è
BPF_FUNC_»dœeù
;

41 (*
bpf_³rf_ev’t_ouut
)(*
ùx
, *
m­
,

42 
æags
, *
d©a
,

43 
size
) =

44 (*è
BPF_FUNC_³rf_ev’t_ouut
;

45 (*
bpf_g‘_¡ackid
)(*
ùx
, *
m­
, 
æags
) =

46 (*è
BPF_FUNC_g‘_¡ackid
;

47 (*
bpf_´obe_wr™e_u£r
)(*
d¡
, *
¤c
, 
size
) =

48 (*è
BPF_FUNC_´obe_wr™e_u£r
;

49 (*
bpf_cu¼’t_sk_und”_cgroup
)(*
m­
, 
šdex
) =

50 (*è
BPF_FUNC_cu¼’t_sk_und”_cgroup
;

51 (*
bpf_skb_g‘_tuÂ–_key
)(*
ùx
, *
key
, 
size
, 
æags
) =

52 (*è
BPF_FUNC_skb_g‘_tuÂ–_key
;

53 (*
bpf_skb_£t_tuÂ–_key
)(*
ùx
, *
key
, 
size
, 
æags
) =

54 (*è
BPF_FUNC_skb_£t_tuÂ–_key
;

55 (*
bpf_skb_g‘_tuÂ–_Ýt
)(*
ùx
, *
md
, 
size
) =

56 (*è
BPF_FUNC_skb_g‘_tuÂ–_Ýt
;

57 (*
bpf_skb_£t_tuÂ–_Ýt
)(*
ùx
, *
md
, 
size
) =

58 (*è
BPF_FUNC_skb_£t_tuÂ–_Ýt
;

59 (*
bpf_g‘_´ªdom_u32
)() =

60 (*è
BPF_FUNC_g‘_´ªdom_u32
;

61 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

62 (*è
BPF_FUNC_xdp_adju¡_h—d
;

67 
sk_buff
;

68 
	$lßd_by‹
(*
skb
,

69 
off
è
	`asm
("llvm.bpf.load.byte");

70 
	$lßd_h®f
(*
skb
,

71 
off
è
	`asm
("llvm.bpf.load.half");

72 
	$lßd_wÜd
(*
skb
,

73 
off
è
	`asm
("llvm.bpf.load.word");

78 
	sbpf_m­_def
 {

79 
ty³
;

80 
key_size
;

81 
v®ue_size
;

82 
max_’Œ›s
;

83 
m­_æags
;

84 
šÃr_m­_idx
;

87 (*
bpf_skb_lßd_by‹s
)(*
ùx
, 
off
, *
to
, 
Ën
) =

88 (*è
BPF_FUNC_skb_lßd_by‹s
;

89 (*
bpf_skb_¡Üe_by‹s
)(*
ùx
, 
off
, *
äom
, 
Ën
, 
æags
) =

90 (*è
BPF_FUNC_skb_¡Üe_by‹s
;

91 (*
bpf_l3_csum_»¶aû
)(*
ùx
, 
off
, 
äom
, 
to
, 
æags
) =

92 (*è
BPF_FUNC_l3_csum_»¶aû
;

93 (*
bpf_l4_csum_»¶aû
)(*
ùx
, 
off
, 
äom
, 
to
, 
æags
) =

94 (*è
BPF_FUNC_l4_csum_»¶aû
;

95 (*
bpf_skb_und”_cgroup
)(*
ùx
, *
m­
, 
šdex
) =

96 (*è
BPF_FUNC_skb_und”_cgroup
;

97 (*
bpf_skb_chªge_h—d
)(*, 
Ën
, 
æags
) =

98 (*è
BPF_FUNC_skb_chªge_h—d
;

100 #ià
	`defšed
(
__x86_64__
)

102 
	#PT_REGS_PARM1
(
x
è((x)->
di
)

	)

103 
	#PT_REGS_PARM2
(
x
è((x)->
si
)

	)

104 
	#PT_REGS_PARM3
(
x
è((x)->
dx
)

	)

105 
	#PT_REGS_PARM4
(
x
è((x)->
cx
)

	)

106 
	#PT_REGS_PARM5
(
x
è((x)->
r8
)

	)

107 
	#PT_REGS_RET
(
x
è((x)->
¥
)

	)

108 
	#PT_REGS_FP
(
x
è((x)->
bp
)

	)

109 
	#PT_REGS_RC
(
x
è((x)->
ax
)

	)

110 
	#PT_REGS_SP
(
x
è((x)->
¥
)

	)

111 
	#PT_REGS_IP
(
x
è((x)->

)

	)

113 #–ià
	`defšed
(
__s390x__
)

115 
	#PT_REGS_PARM1
(
x
è((x)->
g´s
[2])

	)

116 
	#PT_REGS_PARM2
(
x
è((x)->
g´s
[3])

	)

117 
	#PT_REGS_PARM3
(
x
è((x)->
g´s
[4])

	)

118 
	#PT_REGS_PARM4
(
x
è((x)->
g´s
[5])

	)

119 
	#PT_REGS_PARM5
(
x
è((x)->
g´s
[6])

	)

120 
	#PT_REGS_RET
(
x
è((x)->
g´s
[14])

	)

121 
	#PT_REGS_FP
(
x
è((x)->
g´s
[11]è

	)

122 
	#PT_REGS_RC
(
x
è((x)->
g´s
[2])

	)

123 
	#PT_REGS_SP
(
x
è((x)->
g´s
[15])

	)

124 
	#PT_REGS_IP
(
x
è((x)->
psw
.
addr
)

	)

126 #–ià
	`defšed
(
__¯rch64__
)

128 
	#PT_REGS_PARM1
(
x
è((x)->
»gs
[0])

	)

129 
	#PT_REGS_PARM2
(
x
è((x)->
»gs
[1])

	)

130 
	#PT_REGS_PARM3
(
x
è((x)->
»gs
[2])

	)

131 
	#PT_REGS_PARM4
(
x
è((x)->
»gs
[3])

	)

132 
	#PT_REGS_PARM5
(
x
è((x)->
»gs
[4])

	)

133 
	#PT_REGS_RET
(
x
è((x)->
»gs
[30])

	)

134 
	#PT_REGS_FP
(
x
è((x)->
»gs
[29]è

	)

135 
	#PT_REGS_RC
(
x
è((x)->
»gs
[0])

	)

136 
	#PT_REGS_SP
(
x
è((x)->
¥
)

	)

137 
	#PT_REGS_IP
(
x
è((x)->
pc
)

	)

139 #–ià
	`defšed
(
__pow”pc__
)

141 
	#PT_REGS_PARM1
(
x
è((x)->
g´
[3])

	)

142 
	#PT_REGS_PARM2
(
x
è((x)->
g´
[4])

	)

143 
	#PT_REGS_PARM3
(
x
è((x)->
g´
[5])

	)

144 
	#PT_REGS_PARM4
(
x
è((x)->
g´
[6])

	)

145 
	#PT_REGS_PARM5
(
x
è((x)->
g´
[7])

	)

146 
	#PT_REGS_RC
(
x
è((x)->
g´
[3])

	)

147 
	#PT_REGS_SP
(
x
è((x)->
¥
)

	)

148 
	#PT_REGS_IP
(
x
è((x)->
n
)

	)

150 #–ià
	`defšed
(
__¥¬c__
)

152 
	#PT_REGS_PARM1
(
x
è((x)->
u_»gs
[
UREG_I0
])

	)

153 
	#PT_REGS_PARM2
(
x
è((x)->
u_»gs
[
UREG_I1
])

	)

154 
	#PT_REGS_PARM3
(
x
è((x)->
u_»gs
[
UREG_I2
])

	)

155 
	#PT_REGS_PARM4
(
x
è((x)->
u_»gs
[
UREG_I3
])

	)

156 
	#PT_REGS_PARM5
(
x
è((x)->
u_»gs
[
UREG_I4
])

	)

157 
	#PT_REGS_RET
(
x
è((x)->
u_»gs
[
UREG_I7
])

	)

158 
	#PT_REGS_RC
(
x
è((x)->
u_»gs
[
UREG_I0
])

	)

159 
	#PT_REGS_SP
(
x
è((x)->
u_»gs
[
UREG_FP
])

	)

160 #ià
	`defšed
(
__¬ch64__
)

161 
	#PT_REGS_IP
(
x
è((x)->
c
)

	)

163 
	#PT_REGS_IP
(
x
è((x)->
pc
)

	)

168 #ifdeà
__pow”pc__


169 
	#BPF_KPROBE_READ_RET_IP
(

, 
ùx
è({ (èð(ùx)->
lšk
; 
	}
})

	)

170 
	#BPF_KRETPROBE_READ_RET_IP
 
BPF_KPROBE_READ_RET_IP


	)

171 #–ià
defšed
(
__¥¬c__
)

172 
	#BPF_KPROBE_READ_RET_IP
(

, 
ùx
è({ (èð
	`PT_REGS_RET
(ùx); })

	)

173 
	#BPF_KRETPROBE_READ_RET_IP
 
BPF_KPROBE_READ_RET_IP


	)

175 
	#BPF_KPROBE_READ_RET_IP
(

, 
ùx
) ({ \

176 
	`bpf_´obe_»ad
(&(

), (), (*)
	`PT_REGS_RET
(
ùx
)); })

	)

177 
	#BPF_KRETPROBE_READ_RET_IP
(

, 
ùx
) ({ \

178 
	`bpf_´obe_»ad
(&(

), (ip), \

179 (*)(
	`PT_REGS_FP
(
ùx
è+ (

))); })

	)

	@tests/samples/bpf/bpf_shared.h

1 #iâdeà
__BPF_SHARED__


2 
	#__BPF_SHARED__


	)

5 
	mBPF_MAP_ID_PROTO
,

6 
	mBPF_MAP_ID_QUEUE
,

7 
	mBPF_MAP_ID_DROPS
,

8 
	m__BPF_MAP_ID_MAX
,

9 
	#BPF_MAP_ID_MAX
 
__BPF_MAP_ID_MAX


	)

12 
	scouÁ_tu¶e
 {

13 
	m·ck‘s
;

14 
	mby‹s
;

17 
	scouÁ_queue
 {

18 
	mtÙ®
;

19 
	mmism©ch
;

	@tests/samples/bpf/da_-1_unspec.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_0_pass.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_1_pass.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_2_drop.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_3_unspec.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_4_nuke.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_5_nuke.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_6_unspec.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_7_redir.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_8_unspec.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/da_abort.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

7 
__£ùiÚ_þs_’Œy


8 
	$þs_’Œy
(
__sk_buff
 *
skb
)

10 ià(
	`lßd_by‹
(
skb
, 1300))

11  
TC_ACT_SHOT
;

12  
TC_ACT_STOLEN
;

13 
	}
}

	@tests/samples/bpf/da_n_unspec.c

1 
	~<lšux/fž‹r.h
>

2 
	~<lšux/bpf.h
>

4 
	~"bpf_­i.h
"

6 
__£ùiÚ_þs_’Œy


7 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

	@tests/samples/bpf/dpa_read.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

7 
	#THRU
 
TC_ACT_UNSPEC


	)

8 
	#DROP
 
TC_ACT_SHOT


	)

10 
__£ùiÚ_þs_’Œy


11 
	$þs_’Œy
(
__sk_buff
 *
skb
)

13 *
d©a
;

14 *
d©a2
;

15 *
d©a4
;

16 *
d©a8
;

18 
d©a
 = (*)()
skb
->data;

19 ià(
d©a
 + 64 > (*)()
skb
->
d©a_’d
)

20  
DROP
;

22 
d©a
 += 32;

23 
d©a2
 = (*)
d©a
;

24 
d©a4
 = (*)
d©a
;

25 
d©a8
 = (*)
d©a
;

27 ià(
d©a
[0] != 0x01 || data[1] != 0x02 ||

28 
d©a
[2] != 0x03 || data[3] != 0x04)

29  
DROP
;

31 ià(
d©a2
[0] != 0x0201 || data2[1] != 0x0403)

32  
DROP
;

34 ià(
d©a4
[0] != 0x04030201)

35  
DROP
;

37 ià(
d©a8
[0] != 0x0807060504030201)

38  
DROP
;

40 
d©a
 += 1;

41 
d©a2
 = (*)
d©a
;

42 
d©a4
 = (*)
d©a
;

43 
d©a8
 = (*)
d©a
;

45 ià(
d©a
[0] != 0x02 || data[1] != 0x03 ||

46 
d©a
[2] != 0x04 || data[3] != 0x05)

47  
DROP
;

49 ià(
d©a2
[0] != 0x0302 || data2[1] != 0x0504)

50  
DROP
;

52 ià(
d©a4
[0] != 0x05040302)

53  
DROP
;

55 ià(
d©a8
[0] != 0xbb08070605040302)

56  
DROP
;

58 
d©a
 -= 2;

59 
d©a2
 = (*)
d©a
;

60 
d©a4
 = (*)
d©a
;

61 
d©a8
 = (*)
d©a
;

63 ià(
d©a
[0] != 0xaa || data[1] != 0x01 ||

64 
d©a
[2] != 0x02 || data[3] != 0x03)

65  
DROP
;

67 ià(
d©a2
[0] != 0x01aa || data2[1] != 0x0302)

68  
DROP
;

70 ià(
d©a4
[0] != 0x030201aa)

71  
DROP
;

73 ià(
d©a8
[0] != 0x07060504030201aa)

74  
DROP
;

76  
THRU
;

77 
	}
}

	@tests/samples/bpf/dpa_var_off_11bit.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

7 
	#THRU
 
TC_ACT_UNSPEC


	)

8 
	#DROP
 
TC_ACT_SHOT


	)

10 
__£ùiÚ_þs_’Œy


11 
	$þs_’Œy
(
__sk_buff
 *
skb
)

13 *
d©a
, *
Ãw_ba£
;

14 
v¬_off
;

16 
d©a
 = (*)()
skb
->data;

17 ià(
d©a
 + 64 > (*)()
skb
->
d©a_’d
)

18  
DROP
;

20 
v¬_off
 = *(*)&
d©a
[32];

21 
v¬_off
 &= 0x7ff;

22 
Ãw_ba£
 = 
d©a
 + 
v¬_off
;

23 ià(
Ãw_ba£
 + 32 > (*)()
skb
->
d©a_’d
)

24  
DROP
;

26 ià(
Ãw_ba£
[0] != 0xaa)

27  
DROP
;

29  
THRU
;

30 
	}
}

	@tests/samples/bpf/dpa_var_off_9bit.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

7 
	#THRU
 
TC_ACT_UNSPEC


	)

8 
	#DROP
 
TC_ACT_SHOT


	)

10 
__£ùiÚ_þs_’Œy


11 
	$þs_’Œy
(
__sk_buff
 *
skb
)

13 *
d©a
, *
Ãw_ba£
;

14 
v¬_off
;

16 
d©a
 = (*)()
skb
->data;

17 ià(
d©a
 + 64 > (*)()
skb
->
d©a_’d
)

18  
DROP
;

20 
v¬_off
 = *(*)&
d©a
[32];

21 
v¬_off
 &= 0x1ff;

22 
Ãw_ba£
 = 
d©a
 + 
v¬_off
;

23 ià(
Ãw_ba£
 + 32 > (*)()
skb
->
d©a_’d
)

24  
DROP
;

26 ià(
Ãw_ba£
[0] != 0xaa)

27  
DROP
;

29  
THRU
;

30 
	}
}

	@tests/samples/bpf/drop.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

6 
	~"bpf_sh¬ed.h
"

8 
	#THRU
 
TC_ACT_UNSPEC


	)

9 
	#DROP
 
TC_ACT_SHOT


	)

11 
__£ùiÚ_þs_’Œy


12 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

14  
	gDROP
;

	@tests/samples/bpf/jeq_jgt.c

1 
	~<¡dšt.h
>

2 
	~<¡dboÞ.h
>

3 
	~<sys/ty³s.h
>

4 
	~<sys/sock‘.h
>

5 
	~<asm/ty³s.h
>

6 
	~<lšux/š.h
>

7 
	~<lšux/if.h
>

8 
	~<lšux/if_‘h”.h
>

9 
	~<lšux/.h
>

10 
	~<lšux/v6.h
>

11 
	~<lšux/if_tuÂ–.h
>

12 
	~<lšux/fž‹r.h
>

13 
	~<lšux/bpf.h
>

15 
	~"bpf_­i.h
"

17 
	#TRU
 0

	)

18 
	#DROP
 ~0U

	)

20 
	#RESa
 (2 * 0x¯¯¯¯ULL)

	)

21 
	#RESb
 (2 * 0xbbbbbbbbULL)

	)

22 
	#RESc
 (2 * 0xccccccccULL)

	)

24 
__£ùiÚ_þs_’Œy


25 
	$þs_’Œy
(
__sk_buff
 *
skb
)

27 
__u64
 
sum
 = 0;

29 
sum
 +ð
	`lßd_wÜd
(
skb
, 100);

30 
sum
 +ð
	`lßd_wÜd
(
skb
, 104);

32 ià(
sum
 =ð
RESa
)

33  
DROP
;

35 ià(
sum
 >ð
RESb
)

36  
DROP
;

38  
TRU
;

39 
	}
}

	@tests/samples/bpf/jhash.h

1 #iâdeà
_LINUX_JHASH_H


2 
	#_LINUX_JHASH_H


	)

25 
šlše
 
__u32
 
	$rÞ32
(
__u32
 
wÜd
, 
shiá
)

27  (
wÜd
 << 
shiá
) | (word >> ((-shift) & 31));

28 
	}
}

33 
	#__jhash_mix
(
a
, 
b
, 
c
) \

35 
a
 -ð
c
;‡ ^ð
	`rÞ32
(c, 4); c +ð
b
; \

36 
b
 -ð
a
; b ^ð
	`rÞ32
×, 6);‡ +ð
c
; \

37 
c
 -ð
b
; c ^ð
	`rÞ32
(b, 8); b +ð
a
; \

38 
a
 -ð
c
;‡ ^ð
	`rÞ32
(c, 16); c +ð
b
; \

39 
b
 -ð
a
; b ^ð
	`rÞ32
×, 19);‡ +ð
c
; \

40 
c
 -ð
b
; c ^ð
	`rÞ32
(b, 4); b +ð
a
; \

41 }

	)

43 
	#__jhash_fš®
(
a
, 
b
, 
c
) \

45 
c
 ^ð
b
; c -ð
	`rÞ32
(b, 14); \

46 
a
 ^ð
c
;‡ -ð
	`rÞ32
(c, 11); \

47 
b
 ^ð
a
; b -ð
	`rÞ32
(a, 25); \

48 
c
 ^ð
b
; c -ð
	`rÞ32
(b, 16); \

49 
a
 ^ð
c
;‡ -ð
	`rÞ32
(c, 4); \

50 
b
 ^ð
a
; b -ð
	`rÞ32
(a, 14); \

51 
c
 ^ð
b
; c -ð
	`rÞ32
(b, 24); \

52 }

	)

54 
	#JHASH_INITVAL
 0xd—db“f

	)

56 
	tu32
;

68 
šlše
 
u32
 
	$jhash
(cÚ¡ *
key
, 
u32
 
Ëngth
, u32 
š™v®
)

70 
u32
 
a
, 
b
, 
c
;

71 cÚ¡ *
k
 = 
key
;

74 
a
 = 
b
 = 
c
 = 
JHASH_INITVAL
 + 
Ëngth
 + 
š™v®
;

77 
Ëngth
 > 12) {

78 
a
 +ð*(
u32
 *)(
k
);

79 
b
 +ð*(
u32
 *)(
k
 + 4);

80 
c
 +ð*(
u32
 *)(
k
 + 8);

81 
	`__jhash_mix
(
a
, 
b
, 
c
);

82 
Ëngth
 -= 12;

83 
k
 += 12;

86 
Ëngth
) {

87 12: 
c
 +ð(
u32
)
k
[11]<<24;

88 11: 
c
 +ð(
u32
)
k
[10]<<16;

89 10: 
c
 +ð(
u32
)
k
[9]<<8;

90 9: 
c
 +ð
k
[8];

91 8: 
b
 +ð(
u32
)
k
[7]<<24;

92 7: 
b
 +ð(
u32
)
k
[6]<<16;

93 6: 
b
 +ð(
u32
)
k
[5]<<8;

94 5: 
b
 +ð
k
[4];

95 4: 
a
 +ð(
u32
)
k
[3]<<24;

96 3: 
a
 +ð(
u32
)
k
[2]<<16;

97 2: 
a
 +ð(
u32
)
k
[1]<<8;

98 1: 
a
 +ð
k
[0];

99 
	`__jhash_fš®
(
a
, 
b
, 
c
);

104  
c
;

105 
	}
}

114 
šlše
 
u32
 
	$jhash2
(cÚ¡ 
u32
 *
k
, u32 
Ëngth
, u32 
š™v®
)

116 
u32
 
a
, 
b
, 
c
;

119 
a
 = 
b
 = 
c
 = 
JHASH_INITVAL
 + (
Ëngth
<<2è+ 
š™v®
;

122 
Ëngth
 > 3) {

123 
a
 +ð
k
[0];

124 
b
 +ð
k
[1];

125 
c
 +ð
k
[2];

126 
	`__jhash_mix
(
a
, 
b
, 
c
);

127 
Ëngth
 -= 3;

128 
k
 += 3;

132 
Ëngth
) {

133 3: 
c
 +ð
k
[2];

134 2: 
b
 +ð
k
[1];

135 1: 
a
 +ð
k
[0];

136 
	`__jhash_fš®
(
a
, 
b
, 
c
);

141  
c
;

142 
	}
}

146 
šlše
 
u32
 
	$__jhash_nwÜds
(
u32
 
a
, u32 
b
, u32 
c
, u32 
š™v®
)

148 
a
 +ð
š™v®
;

149 
b
 +ð
š™v®
;

150 
c
 +ð
š™v®
;

152 
	`__jhash_fš®
(
a
, 
b
, 
c
);

154  
c
;

155 
	}
}

157 
šlše
 
u32
 
	$jhash_3wÜds
(
u32
 
a
, u32 
b
, u32 
c
, u32 
š™v®
)

159  
	`__jhash_nwÜds
(
a
, 
b
, 
c
, 
š™v®
 + 
JHASH_INITVAL
 + (3 << 2));

160 
	}
}

162 
šlše
 
u32
 
	$jhash_2wÜds
(
u32
 
a
, u32 
b
, u32 
š™v®
)

164  
	`__jhash_nwÜds
(
a
, 
b
, 0, 
š™v®
 + 
JHASH_INITVAL
 + (2 << 2));

165 
	}
}

167 
šlše
 
u32
 
	$jhash_1wÜd
(
u32
 
a
, u32 
š™v®
)

169  
	`__jhash_nwÜds
(
a
, 0, 0, 
š™v®
 + 
JHASH_INITVAL
 + (1 << 2));

170 
	}
}

	@tests/samples/bpf/jneq.c

1 
	~<¡dšt.h
>

2 
	~<¡dboÞ.h
>

3 
	~<sys/ty³s.h
>

4 
	~<sys/sock‘.h
>

5 
	~<asm/ty³s.h
>

6 
	~<lšux/š.h
>

7 
	~<lšux/if.h
>

8 
	~<lšux/if_‘h”.h
>

9 
	~<lšux/.h
>

10 
	~<lšux/v6.h
>

11 
	~<lšux/if_tuÂ–.h
>

12 
	~<lšux/fž‹r.h
>

13 
	~<lšux/bpf.h
>

15 
	~"bpf_­i.h
"

17 
	#TRU
 0

	)

18 
	#DROP
 ~0U

	)

20 
	#RESa
 (2 * 0x¯¯¯¯ULL)

	)

21 
	#RESb
 (2 * 0xbbbbbbbbULL)

	)

22 
	#RESc
 (2 * 0xccccccccULL)

	)

24 
__£ùiÚ_þs_’Œy


25 
	$þs_’Œy
(
__sk_buff
 *
skb
)

27 
__u64
 
sum
 = 0;

29 
sum
 +ð
	`lßd_wÜd
(
skb
, 100);

30 
sum
 +ð
	`lßd_wÜd
(
skb
, 104);

32 ià(
sum
 !ð
RESa
)

33  
DROP
;

35  
TRU
;

36 
	}
}

	@tests/samples/bpf/len.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

6 
	~"bpf_sh¬ed.h
"

8 
	#THRU
 
TC_ACT_UNSPEC


	)

9 
	#DROP
 
TC_ACT_SHOT


	)

11 
__£ùiÚ_þs_’Œy


12 
	$þs_’Œy
(
__sk_buff
 *
skb
)

14 ià(
skb
->
Ën
 > 1200)

15  
DROP
;

17  
THRU
;

18 
	}
}

	@tests/samples/bpf/maps.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

6 
	~"bpf_sh¬ed.h
"

8 
	#THRU
 
TC_ACT_UNSPEC


	)

9 
	#DROP
 
TC_ACT_SHOT


	)

11 
bpf_–f_m­
 
__£ùiÚ
("m­s"è
	gm­_drÝs
 = {

12 .
ty³
=
BPF_MAP_TYPE_ARRAY
,

13 .
	gid
=
BPF_MAP_ID_DROPS
,

14 .
	gsize_key
=(
ušt32_t
),

15 .
	gsize_v®ue
=(),

16 .
	gmax_–em
=64,

19 
__£ùiÚ_þs_’Œy


20 
	$þs_’Œy
(
__sk_buff
 *
skb
)

22 
ušt32_t
 
w
 = 
	`lßd_wÜd
(
skb
, 0);

23 
ušt32_t
 *
couÁ
;

25 
couÁ
 = 
	`m­_lookup_–em
(&
m­_drÝs
, &
w
);

26 ià(
couÁ
)

28 (*
couÁ
)++;

30  
THRU
;

31 
	}
}

	@tests/samples/bpf/mark.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

7 
	#THRU
 
TC_ACT_UNSPEC


	)

8 
	#DROP
 
TC_ACT_SHOT


	)

10 
__£ùiÚ_þs_’Œy


11 
	$þs_’Œy
(
__sk_buff
 *
skb
)

13 
skb
->
m¬k
 = 0xcafe;

15  
THRU
;

16 
	}
}

	@tests/samples/bpf/pass.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

6 
	~"bpf_sh¬ed.h
"

8 
	#THRU
 
TC_ACT_UNSPEC


	)

9 
	#DROP
 
TC_ACT_SHOT


	)

11 
__£ùiÚ_þs_’Œy


12 
þs_’Œy
(
__sk_buff
 *
skb
 
__©Œibu‹__
((
unu£d
)))

14  
	gTHRU
;

	@tests/samples/bpf/store.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

6 
	~"bpf_sh¬ed.h
"

8 
	#THRU
 
TC_ACT_UNSPEC


	)

9 
	#DROP
 
TC_ACT_SHOT


	)

11 
__£ùiÚ_þs_’Œy


12 
	$þs_’Œy
(
__sk_buff
 *
skb
)

14 
__u32
 
w
 = 0x01020304;

16 
	`skb_¡Üe_by‹s
(
skb
, 0, &
w
, 4, 0);

18  
THRU
;

19 
	}
}

	@tests/samples/bpf/tcp58.c

1 
	~<¡dšt.h
>

2 
	~<¡dboÞ.h
>

3 
	~<sys/ty³s.h
>

4 
	~<sys/sock‘.h
>

5 
	~<asm/ty³s.h
>

6 
	~<lšux/š.h
>

7 
	~<lšux/if.h
>

8 
	~<lšux/if_‘h”.h
>

9 
	~<lšux/.h
>

10 
	~<lšux/v6.h
>

11 
	~<lšux/if_tuÂ–.h
>

12 
	~<lšux/bpf.h
>

13 
	~<lšux/fž‹r.h
>

14 
	~<lšux/pkt_þs.h
>

16 
	~"bpf_­i.h
"

17 
	~"bpf_sh¬ed.h
"

19 
	#THRU
 
TC_ACT_UNSPEC


	)

20 
	#DROP
 
TC_ACT_SHOT


	)

22 
	$tý_check_pÜt
(
__sk_buff
 *
skb
, 
__u32
 
off£t
)

24 
__u16
 
tý_pÜt
 = 
	`lßd_h®f
(
skb
, 
off£t
 + 2);

26 ià(
tý_pÜt
 == 58)

27  
DROP
;

28  
THRU
;

29 
	}
}

31 
	$l3_
(
__sk_buff
 *
skb
, 
__u32
 
off£t
)

33 
__u8
 
l4_´Ùo
 =

34 
	`lßd_by‹
(
skb
, 
off£t
 + 
	`off£tof
(
hdr
, 
´ÙocÞ
));

36 ià(
l4_´Ùo
 =ð
IPPROTO_TCP
)

37  
	`tý_check_pÜt
(
skb
, 
off£t
 + (
hdr
));

38  
THRU
;

39 
	}
}

41 
	$l3_v6
(
__sk_buff
 *
skb
, 
__u32
 
off£t
)

43 
__u8
 
l4_´Ùo
 =

44 
	`lßd_by‹
(
skb
, 
off£t
 + 
	`off£tof
(
v6hdr
, 
Ãxthdr
));

46 ià(
l4_´Ùo
 =ð
IPPROTO_TCP
)

47  
	`tý_check_pÜt
(
skb
, 
off£t
 + (
hdr
));

48  
THRU
;

49 
	}
}

51 
	$l2_to_l3
(
__sk_buff
 *
skb
, 
__u16
 
´Ùo
, 
__u32
 
off£t
)

53 ià(
´Ùo
 =ð
ETH_P_IP
)

54  
	`l3_
(
skb
, 
off£t
);

55 ià(
´Ùo
 =ð
ETH_P_IPV6
)

56  
	`l3_v6
(
skb
, 
off£t
);

58  
THRU
;

59 
	}
}

61 
	$l2_vÏn1
(
__sk_buff
 *
skb
, 
__u32
 
off£t
)

63 
__u16
 
´Ùo
;

65 
´Ùo
 = 
	`lßd_h®f
(
skb
, 
off£t
 + 2);

67  
	`l2_to_l3
(
skb
, 
´Ùo
, 
off£t
 + (
‘hhdr
));

68 
	}
}

70 
	$l2
(
__sk_buff
 *
skb
, 
__u32
 
off£t
)

72 
__u16
 
´Ùo
;

74 
´Ùo
 = 
	`lßd_h®f
(
skb
, 
off£t
 + 
	`off£tof
(
‘hhdr
, 
h_´Ùo
));

76 ià(
´Ùo
 =ð
ETH_P_8021Q
)

77  
	`l2_vÏn1
(
skb
, 
off£t
 + (
‘hhdr
));

79  
	`l2_to_l3
(
skb
, 
´Ùo
, 
off£t
 + (
‘hhdr
));

80 
	}
}

82 
__£ùiÚ_þs_’Œy


83 
	$þs_’Œy
(
__sk_buff
 *
skb
)

85  
	`l2
(
skb
, 0);

86 
	}
}

88 
BPF_LICENSE
("GPL");

	@tests/samples/bpf/validate_ptr_type.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/fž‹r.h
>

3 
	~<lšux/pkt_þs.h
>

5 
	~"bpf_­i.h
"

6 
	~"bpf_sh¬ed.h
"

8 
	#THRU
 
TC_ACT_UNSPEC


	)

9 
	#DROP
 
TC_ACT_SHOT


	)

11 
__£ùiÚ_þs_’Œy


12 
	$þs_’Œy
(
__sk_buff
 *
skb
)

14 
__u8
 *
dp1
;

16 
dp1
 = (*)()
skb
->
queue_m­pšg
;

18 ià(
dp1
 + 0x100 > (
__u8
 *)()
skb
->
d©a_’d
)

20  
THRU
;

22 ià(*(
dp1
 + 0xb4))

23  
DROP
;

25  
THRU
;

26 
	}
}

	@tests/samples/c/map_stress.c

1 
	~<bpf.h
>

2 
	~<”ºo.h
>

3 
	~<±h»ad.h
>

4 
	~<¡dboÞ.h
>

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<uni¡d.h
>

10 
	#”r
(
msg
, 
¬g
...) \

11 
	`årštf
(
¡d”r
, "E¼Ü: %s: " 
msg
, 
__func__
, 
¬g
)

	)

12 
	#w¬n
(
msg
, 
¬g
...) \

13 
	`årštf
(
¡d”r
, "W¬nšg: %s: " 
msg
, 
__func__
, 
¬g
)

	)

14 
	#dbg
(
msg
, 
¬g
...) \

15 
	`årštf
(
¡dout
, "%s: " 
msg
, 
__func__
, 
¬g
)

	)

17 
	eaù
 {

18 
	mACT_GET_FIRST
,

19 
	mACT_GET_NEXT_VALID
,

20 
	mACT_GET_NEXT_NOEXIST
,

21 
	mACT_GET_NEXT_LAST
,

22 
	mACT_UPDATE_EXIST_ANY
,

23 
	mACT_UPDATE_EXIST_NOEXIST
,

24 
	mACT_UPDATE_EXIST_EXIST
,

25 
	mACT_UPDATE_NOEXIST_ANY
,

26 
	mACT_UPDATE_NOEXIST_NOEXIST
,

27 
	mACT_UPDATE_NOEXIST_EXIST
,

28 
	mACT_LOOKUP_EXIST
,

29 
	mACT_LOOKUP_NOEXIST
,

30 
	mACT_DELETE_EXIST
,

31 
	mACT_DELETE_NOEXIST
,

32 
	mACT_WALK
,

33 
	mNUM_ACTS
,

34 
	mACT_UPDATE_FULL
,

37 
	sth»ad
 {

38 
±h»ad_t
 
	mth»ad
;

39 
	mid
;

40 
¿ndom_d©a
 
	mr
;

41 
	mr_¡©e
[128];

42 
	mfd
;

43 
bpf_m­_šfo
 
	mšfo
;

46 
	gmax_’Œ›s
;

48 
	g”rút
;

49 
	gn_»p
;

51 
	$¿nd_ušt
(
th»ad
 *
this
, 
max
)

53 
v®
;

55 
	`¿ndom_r
(&
this
->
r
, &
v®
);

56  
v®
 % 
max
;

57 
	}
}

59 
	$g‘_key
(
th»ad
 *
this
)

61  
	`¿nd_ušt
(
this
, 
max_’Œ›s
);

62 
	}
}

64 
	$g‘_v®ue
(
th»ad
 *
this
)

66 
tmp
[2];

68 
	`¿ndom_r
(&
this
->
r
, &
tmp
[0]);

69 
	`¿ndom_r
(&
this
->
r
, &
tmp
[1]);

71  ()
tmp
[0] << 32 |mp[1];

72 
	}
}

74 
	$do_g‘_Ãxt
(
th»ad
 *
this
)

76 
Ãxtkey
[
this
->
šfo
.
key_size
];

77 
key
;

79 
key
 = 
	`g‘_key
(
this
);

81  
	`bpf_m­_g‘_Ãxt_key
(
this
->
fd
, &
key
, 
Ãxtkey
);

82 
	}
}

84 
	$do_g‘_fœ¡
(
th»ad
 *
this
)

86 
Ãxtkey
[
this
->
šfo
.
key_size
];

88  
	`bpf_m­_g‘_Ãxt_key
(
this
->
fd
, 
NULL
, 
Ãxtkey
);

89 
	}
}

91 
	$do_upd©e
(
th»ad
 *
this
)

93 
v®ue
;

94 
key
;

96 
key
 = 
	`g‘_key
(
this
);

97 
v®ue
 = 
	`g‘_v®ue
(
this
);

99  
	`bpf_m­_upd©e_–em
(
this
->
fd
, &
key
, &
v®ue
, 
BPF_ANY
);

100 
	}
}

102 
	$do_lookup
(
th»ad
 *
this
)

104 
v®ue
;

105 
key
;

107 
key
 = 
	`g‘_key
(
this
);

109  
	`bpf_m­_lookup_–em
(
this
->
fd
, &
key
, &
v®ue
);

110 
	}
}

112 
	$do_d–‘e
(
th»ad
 *
this
)

114 
key
;

116 
key
 = 
	`g‘_key
(
this
);

118  
	`bpf_m­_d–‘e_–em
(
this
->
fd
, &
key
);

119 
	}
}

121 
	$do_w®k
(
th»ad
 *
this
)

123 
Ãxtkey
[
this
->
šfo
.
key_size
];

124 
key
[
this
->
šfo
.
key_size
];

125 
”r
;

127 
”r
 = 
	`bpf_m­_g‘_Ãxt_key
(
this
->
fd
, 
NULL
, 
Ãxtkey
);

128 !
”r
) {

129 
	`memýy
(
key
, 
Ãxtkey
, 
this
->
šfo
.
key_size
);

130 
”r
 = 
	`bpf_m­_d–‘e_–em
(
this
->
fd
, &
key
);

134 
	}
}

136 
	$do_Úe
(
th»ad
 *
this
)

138 
aù
;

140 
	`¿ndom_r
(&
this
->
r
, &
aù
);

141 
aù
 %ð
NUM_ACTS
;

144 ià(
aù
 < 
ACT_UPDATE_EXIST_ANY
 ||‡ù =ð
ACT_WALK
) {

145 ià(
	`¿nd_ušt
(
this
, 7) < 5)

147 ià(
aù
 =ð
ACT_WALK
 && 
	`¿nd_ušt
(
this
, 7) < 5)

151 
aù
) {

152 
ACT_GET_FIRST
:

153  
	`do_g‘_fœ¡
(
this
);

154 
ACT_GET_NEXT_VALID
:

155 
ACT_GET_NEXT_NOEXIST
:

156 
ACT_GET_NEXT_LAST
:

157  
	`do_g‘_Ãxt
(
this
);

158 
ACT_UPDATE_EXIST_ANY
:

159 
ACT_UPDATE_EXIST_NOEXIST
:

160 
ACT_UPDATE_EXIST_EXIST
:

161 
ACT_UPDATE_NOEXIST_ANY
:

162 
ACT_UPDATE_NOEXIST_NOEXIST
:

163 
ACT_UPDATE_NOEXIST_EXIST
:

164  
	`do_upd©e
(
this
);

165 
ACT_LOOKUP_EXIST
:

166 
ACT_LOOKUP_NOEXIST
:

167  
	`do_lookup
(
this
);

168 
ACT_DELETE_EXIST
:

169 
ACT_DELETE_NOEXIST
:

170  
	`do_d–‘e
(
this
);

171 
ACT_WALK
:

172  
	`do_w®k
(
this
);

176 
	}
}

178 *
	$th»ad_maš
(*
¬g
)

180 
__u32
 
šfo_Ën
 = (
bpf_m­_šfo
);

181 
th»ad
 *
this
 = 
¬g
;

182 
i
;

183 
”r
;

185 ià(
	`š™¡©e_r
(
this
->
th»ad
,his->
r_¡©e
, (this->r_state),

186 &
this
->
r
)) {

187 
	`”r
("ÿn'ˆš™„ªdom: %s\n", 
	`¡»¼Ü
(
”ºo
));

188 
”r_út
;

191 
this
->
fd
 = 
	`bpf_m­_g‘_fd_by_id
Ñhis->
id
);

192 ià(
this
->
fd
 < 0) {

193 
	`”r
("ÿn'ˆÝ’ FD: %s\n", 
	`¡»¼Ü
(
”ºo
));

194 
”r_út
;

197 
	`mem£t
(&
this
->
šfo
, 0, (this->info));

198 
”r
 = 
	`bpf_obj_g‘_šfo_by_fd
(
this
->
fd
, &this->
šfo
, &
šfo_Ën
);

199 ià(
”r
) {

200 
	`”r
("ÿn'ˆg‘ info: %s\n", 
	`¡»¼Ü
(
”ºo
));

201 
”r_út
;

204 
i
 = 0; i < 
n_»p
; i++) {

205 
	`do_Úe
(
this
);

206 ià(!(
i
 % 128))

207 
	`dbg
("Thread %lx making…rogress %d/%ld...\n",

208 
this
->
th»ad
, 
i
, 
n_»p
);

211 
	`þo£
(
this
->
fd
);

213  
NULL
;

215 
”r_út
:

216 
”rút
++;

217  
NULL
;

218 
	}
}

220 
	$u§ge
(*
bšÇme
, 
»tcode
)

222 
	`´štf
("Usage: %s <map_id> <n_threads> <n_rep> <max_key>\n",

223 
bšÇme
);

224 
	`ex™
(
»tcode
);

226 
	}
}

228 
	$maš
(
¬gc
, **
¬gv
)

230 
id
, 
num_th»ads
;

231 
th»ad
 *
th»ads
;

232 
i
;

233 *
’d±r
;

234 
”r
;

236 ià(
¬gc
 != 5)

237 
	`u§ge
(
¬gv
[0], 1);

239 
id
 = 
	`¡¹oul
(
¬gv
[1], &
’d±r
, 0);

240 ià(*
’d±r
) {

241 
	`”r
("ÿn'ˆ·r£ % a ID", 
¬gv
[1]);

244 
num_th»ads
 = 
	`¡¹oul
(
¬gv
[2], &
’d±r
, 0);

245 ià(*
’d±r
) {

246 
	`”r
("ÿn'ˆ·r£ % a num_th»ads", 
¬gv
[2]);

249 
n_»p
 = 
	`¡¹oul
(
¬gv
[3], &
’d±r
, 0);

250 ià(*
’d±r
) {

251 
	`”r
("ÿn'ˆ·r£ % a n_»p", 
¬gv
[3]);

254 
max_’Œ›s
 = 
	`¡¹oul
(
¬gv
[4], &
’d±r
, 0);

255 ià(*
’d±r
) {

256 
	`”r
("ÿn'ˆ·r£ % a max_’Œ›s", 
¬gv
[4]);

260 
th»ads
 = 
	`ÿÎoc
(
num_th»ads
, (*threads));

262 
i
 = 0; i < 
num_th»ads
; i++) {

263 
th»ads
[
i
].
id
 = id;

265 
”r
 = 
	`±h»ad_ü—‹
(&
th»ads
[
i
].
th»ad
, 
NULL
, 
th»ad_maš
,

266 (*)&
th»ads
[
i
]);

267 ià(
”r
) {

268 
	`”r
("th»ad c»©iÚ fažed fÜh»ad %d\n", 
i
);

269 
num_th»ads
 = 
i
;

274 
i
 = 0; i < 
num_th»ads
; i++)

275 
	`±h»ad_još
(
th»ads
[
i
].
th»ad
, 
NULL
);

277 
	`ä“
(
th»ads
);

279  !!
”rút
;

280 
	}
}

	@tests/samples/c/udp_netcons_sink.c

1 
	~<as£¹.h
>

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<uni¡d.h
>

5 
	~<sys/ty³s.h
>

6 
	~<sys/sock‘.h
>

7 
	~<sys/¡©.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<fúŽ.h
>

10 
	~<”ºo.h
>

11 
	~<sched.h
>

13 
	$maš
(
¬gc
, cÚ¡ **
¬gv
)

15 
sched_·¿m
 sched_·¿m = { .
sched_´iÜ™y
 = 50, };

16 
sockaddr_š
 
addr
 = {};

17 
sockËn_t
 
add¾’
 = (
addr
);

18 
sock
, 
ofže
;

19 
buf
[1024];

20 
Ýt
;

21 
n
;

23 ià(
¬gc
 != 3) {

24 
	`årštf
(
¡d”r
, "U§ge: % <pÜt> <outfže>\n", 
¬gv
[0]);

27 
	`þo£
(2);

28 
	`þo£
(1);

29 
	`þo£
(0);

31 
	`as£¹
(!
	`sched_£tscheduËr
(0, 
SCHED_FIFO
, &
sched_·¿m
));

33 
sock
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 
IPPROTO_UDP
);

34 
	`as£¹
(
sock
 >= 0);

35 
ofže
 = 
	`Ý’
(
¬gv
[2], 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 0666);

36 
	`as£¹
(
ofže
 >= 0);

38 
Ýt
 = 1;

39 
	`as£¹
(!
	`£tsockÝt
(
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
Ýt
, (opt)));

40 
	`as£¹
(!
	`£tsockÝt
(
sock
, 
SOL_SOCKET
, 
SO_REUSEPORT
, &
Ýt
, (opt)));

41 
Ýt
 = 16777216;

42 
	`as£¹
(!
	`£tsockÝt
(
sock
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
Ýt
, (opt)));

44 
addr
.
sš_çmžy
 = 
AF_INET
;

45 
addr
.
sš_pÜt
 = 
	`htÚs
(
	`©oi
(
¬gv
[1]));

46 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

48 
	`as£¹
(!
	`bšd
(
sock
, (*)&
addr
, (addr)));

50 
n
 = 
	`»cväom
(
sock
, 
buf
, (buf), 0, (*)&
addr
, &
add¾’
);

51 
	`as£¹
(
n
 > 0);

52 
	`as£¹
(
	`wr™e
(
ofže
, 
buf
, 
n
) ==‚);

54 
	`as£¹
(!
	`cÚÃù
(
sock
, (*)&
addr
, (addr)));

57 
n
 = 
	`»ad
(
sock
, 
buf
, (buf));

58 
	`as£¹
(
n
 > 0);

59 
	`as£¹
(
	`wr™e
(
ofže
, 
buf
, 
n
) ==‚);

62 
	`þo£
(
sock
);

63 
	`þo£
(
ofže
);

66 
	}
}

	@tests/samples/mefw/rts.c

1 
	~<nå.h
>

3 #ià
NUM_SYMS
 > 0

4 
__expÜt
 
__d¿m
 
	go
;

5 #ià
NUM_SYMS
 > 1

6 
__expÜt
 
__ùm
 
	gtwo
[32];

7 #ià
NUM_SYMS
 > 2

8 
__expÜt
 
__d¿m
 
	gth»e
;

9 #ià
NUM_SYMS
 > 3

10 
__expÜt
 
__d¿m
 
	gthisi§v”ylÚgÇme000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000’d
;

11 
__expÜt
 
__d¿m
 
	ga5
;

12 
__expÜt
 
__d¿m
 
	ga6
;

13 
__expÜt
 
__d¿m
 
	ga7
;

14 
__expÜt
 
__d¿m
 
	ga8
;

15 
__expÜt
 
__d¿m
 
	ga9
;

16 
__expÜt
 
__d¿m
 
	ga10
;

17 
__expÜt
 
__d¿m
 
	ga11
;

18 
__expÜt
 
__d¿m
 
	ga12
;

19 
__expÜt
 
__d¿m
 
	ga13
;

20 
__expÜt
 
__d¿m
 
	ga14
;

21 
__expÜt
 
__d¿m
 
	ga15
;

22 
__expÜt
 
__d¿m
 
	ga16
;

23 
__expÜt
 
__d¿m
 
	ga17
;

24 #ià
NUM_SYMS
 > 17

25 
__expÜt
 
__d¿m
 
	ga18
;

26 
__expÜt
 
__d¿m
 
	ga19
;

27 
__expÜt
 
__d¿m
 
	ga20
;

28 
__expÜt
 
__d¿m
 
	ga21
;

29 
__expÜt
 
__d¿m
 
	ga22
;

30 
__expÜt
 
__d¿m
 
	ga23
;

31 
__expÜt
 
__d¿m
 
	ga24
;

32 
__expÜt
 
__d¿m
 
	ga25
;

33 
__expÜt
 
__d¿m
 
	ga26
;

34 
__expÜt
 
__d¿m
 
	ga27
;

35 
__expÜt
 
__d¿m
 
	ga28
;

36 
__expÜt
 
__d¿m
 
	ga29
;

37 
__expÜt
 
__d¿m
 
	ga30
;

38 
__expÜt
 
__d¿m
 
	ga31
;

39 
__expÜt
 
__d¿m
 
	ga32
;

40 
__expÜt
 
__d¿m
 
	ga33
;

41 
__expÜt
 
__d¿m
 
	ga34
;

42 
__expÜt
 
__d¿m
 
	ga35
;

43 
__expÜt
 
__d¿m
 
	ga36
;

44 
__expÜt
 
__d¿m
 
	ga37
;

45 
__expÜt
 
__d¿m
 
	ga38
;

46 
__expÜt
 
__d¿m
 
	ga39
;

47 
__expÜt
 
__d¿m
 
	ga40
;

48 
__expÜt
 
__d¿m
 
	ga41
;

49 
__expÜt
 
__d¿m
 
	ga42
;

50 
__expÜt
 
__d¿m
 
	ga43
;

51 
__expÜt
 
__d¿m
 
	ga44
;

52 
__expÜt
 
__d¿m
 
	ga45
;

53 
__expÜt
 
__d¿m
 
	ga46
;

54 
__expÜt
 
__d¿m
 
	ga47
;

55 
__expÜt
 
__d¿m
 
	ga48
;

56 
__expÜt
 
__d¿m
 
	ga49
;

57 
__expÜt
 
__d¿m
 
	ga50
;

58 
__expÜt
 
__d¿m
 
	ga51
;

59 
__expÜt
 
__d¿m
 
	ga52
;

60 
__expÜt
 
__d¿m
 
	ga53
;

61 
__expÜt
 
__d¿m
 
	ga54
;

62 
__expÜt
 
__d¿m
 
	ga55
;

63 
__expÜt
 
__d¿m
 
	ga56
;

64 
__expÜt
 
__d¿m
 
	ga57
;

65 
__expÜt
 
__d¿m
 
	ga58
;

66 
__expÜt
 
__d¿m
 
	ga59
;

67 
__expÜt
 
__d¿m
 
	ga60
;

68 
__expÜt
 
__d¿m
 
	ga61
;

69 
__expÜt
 
__d¿m
 
	ga62
;

70 
__expÜt
 
__d¿m
 
	ga63
;

71 
__expÜt
 
__d¿m
 
	ga64
;

72 
__expÜt
 
__d¿m
 
	ga65
;

73 
__expÜt
 
__d¿m
 
	ga66
;

74 
__expÜt
 
__d¿m
 
	ga67
;

75 
__expÜt
 
__d¿m
 
	ga68
;

76 
__expÜt
 
__d¿m
 
	ga69
;

77 
__expÜt
 
__d¿m
 
	ga70
;

78 
__expÜt
 
__d¿m
 
	ga71
;

79 
__expÜt
 
__d¿m
 
	ga72
;

80 
__expÜt
 
__d¿m
 
	ga73
;

81 
__expÜt
 
__d¿m
 
	ga74
;

82 
__expÜt
 
__d¿m
 
	ga75
;

83 
__expÜt
 
__d¿m
 
	ga76
;

84 
__expÜt
 
__d¿m
 
	ga77
;

85 
__expÜt
 
__d¿m
 
	ga78
;

86 
__expÜt
 
__d¿m
 
	ga79
;

87 
__expÜt
 
__d¿m
 
	ga80
;

88 
__expÜt
 
__d¿m
 
	ga81
;

89 
__expÜt
 
__d¿m
 
	ga82
;

90 
__expÜt
 
__d¿m
 
	ga83
;

91 
__expÜt
 
__d¿m
 
	ga84
;

92 
__expÜt
 
__d¿m
 
	ga85
;

93 
__expÜt
 
__d¿m
 
	ga86
;

94 
__expÜt
 
__d¿m
 
	ga87
;

95 
__expÜt
 
__d¿m
 
	ga88
;

96 
__expÜt
 
__d¿m
 
	ga89
;

97 
__expÜt
 
__d¿m
 
	ga90
;

98 
__expÜt
 
__d¿m
 
	ga91
;

99 
__expÜt
 
__d¿m
 
	ga92
;

100 
__expÜt
 
__d¿m
 
	ga93
;

101 
__expÜt
 
__d¿m
 
	ga94
;

102 
__expÜt
 
__d¿m
 
	ga95
;

103 
__expÜt
 
__d¿m
 
	ga96
;

104 
__expÜt
 
__d¿m
 
	ga97
;

105 
__expÜt
 
__d¿m
 
	ga98
;

106 
__expÜt
 
__d¿m
 
	ga99
;

107 
__expÜt
 
__d¿m
 
	ga100
;

115 
	$maš
()

118 
__asm
 
ùx_¬b
[
kžl
];

119 
	}
}

	@tests/samples/mefw/rts_vals.c

1 
	~<nå.h
>

3 
__expÜt
 
__ùm
 
	gsym_ùm
[32];

4 
__expÜt
 
__emem
 
	gsym_emem
[32];

5 
__expÜt
 
__deþ¥ec
((
emem0_ÿche_uµ”
)è
	gsym_ÿche
[32];

7 
	$maš
()

10 
__asm
 
ùx_¬b
[
kžl
];

11 
	}
}

	@tests/samples/xdp/adjust_head_0.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 0))

8  
XDP_ABORTED
;

10  
XDP_PASS
;

11 
	}
}

	@tests/samples/xdp/adjust_head_dec_ip.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
, *
d©a2
;

9 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 20 + 14 > (*)()
xdp
->
d©a_’d
)

11  
XDP_ABORTED
;

14 ià(*(
d©a
 + 12) != 0x8 || *(data + 13) != 0)

15  
XDP_PASS
;

18 ià(*(
d©a
 + 14 + 9) != 0x4)

19  
XDP_PASS
;

21 
d©a2
 = 
d©a
;

22 
d©a
 = data + 20;

24 *
d©a
++ = *
d©a2
++;

25 *
d©a
++ = *
d©a2
++;

26 *
d©a
++ = *
d©a2
++;

28 *
d©a
++ = *
d©a2
++;

29 *
d©a
++ = *
d©a2
++;

30 *
d©a
++ = *
d©a2
++;

32 *
d©a
++ = *
d©a2
++;

33 *
d©a
++ = *
d©a2
++;

34 *
d©a
++ = *
d©a2
++;

36 *
d©a
++ = *
d©a2
++;

37 *
d©a
++ = *
d©a2
++;

38 *
d©a
++ = *
d©a2
++;

41 *
d©a
++ = *
d©a2
++;

42 *
d©a
++ = *
d©a2
++;

44 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 20))

45  
XDP_ABORTED
;

47  
XDP_PASS
;

48 
	}
}

	@tests/samples/xdp/adjust_head_fail_long.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -(256 + 32 + 1)))

8  
XDP_ABORTED
;

10  
XDP_TX
;

11 
	}
}

	@tests/samples/xdp/adjust_head_fail_offload_close.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
;

9 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -94))

10  
XDP_ABORTED
;

12 
d©a
 = (*)()
xdp
->data;

13 ià(
d©a
 + 256 > (*)()
xdp
->
d©a_’d
)

14  
XDP_ABORTED
;

16 
	`__bužtš_memýy
(
d©a
, data + 94, 14);

17 
	`__bužtš_mem£t
(
d©a
 + 14, 0, 80);

19  
XDP_PASS
;

20 
	}
}

	@tests/samples/xdp/adjust_head_fail_offload_far.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
;

9 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 256 > (*)()
xdp
->
d©a_’d
)

11  
XDP_ABORTED
;

13 
	`__bužtš_memýy
(
d©a
 + 113, data, 14);

15 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 113))

16  
XDP_ABORTED
;

18  
XDP_PASS
;

19 
	}
}

	@tests/samples/xdp/adjust_head_fail_short.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 83))

8  
XDP_ABORTED
;

10  
XDP_TX
;

11 
	}
}

	@tests/samples/xdp/adjust_head_fail_twice_65k.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 0x10000))

8  
XDP_ABORTED
;

10 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 0x10000))

11  
XDP_ABORTED
;

13  
XDP_PASS
;

14 
	}
}

	@tests/samples/xdp/adjust_head_fail_twice_long.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -256))

8  
XDP_ABORTED
;

10 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -256))

11  
XDP_ABORTED
;

13  
XDP_PASS
;

14 
	}
}

	@tests/samples/xdp/adjust_head_fail_twice_short.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 256))

8  
XDP_ABORTED
;

10 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 256))

11  
XDP_ABORTED
;

13  
XDP_PASS
;

14 
	}
}

	@tests/samples/xdp/adjust_head_mfail_long.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -257))

8  
XDP_ABORTED
;

10  
XDP_TX
;

11 
	}
}

	@tests/samples/xdp/adjust_head_pass_offload_close.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
;

9 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -84))

10  
XDP_ABORTED
;

12 
d©a
 = (*)()
xdp
->data;

13 ià(
d©a
 + 256 > (*)()
xdp
->
d©a_’d
)

14  
XDP_ABORTED
;

16 
	`__bužtš_memýy
(
d©a
, data + 84, 14);

17 
	`__bužtš_mem£t
(
d©a
 + 14, 0, 70);

19  
XDP_PASS
;

20 
	}
}

	@tests/samples/xdp/adjust_head_pass_offload_close2.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
;

9 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -92))

10  
XDP_ABORTED
;

11 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 0))

12  
XDP_ABORTED
;

14 
d©a
 = (*)()
xdp
->data;

15 ià(
d©a
 + 256 > (*)()
xdp
->
d©a_’d
)

16  
XDP_ABORTED
;

18 
	`__bužtš_memýy
(
d©a
, data + 92, 14);

19 
	`__bužtš_mem£t
(
d©a
 + 14, 0, 79);

21  
XDP_PASS
;

22 
	}
}

	@tests/samples/xdp/adjust_head_pass_offload_far.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
;

9 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 256 > (*)()
xdp
->
d©a_’d
)

11  
XDP_ABORTED
;

13 
	`__bužtš_memýy
(
d©a
 + 46, data, 14);

15 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 46))

16  
XDP_ABORTED
;

18  
XDP_PASS
;

19 
	}
}

	@tests/samples/xdp/adjust_head_pass_offload_far2.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
;

9 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 256 > (*)()
xdp
->
d©a_’d
)

11  
XDP_ABORTED
;

13 
	`__bužtš_memýy
(
d©a
 + 112, data, 14);

15 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 112))

16  
XDP_ABORTED
;

17 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 0))

18  
XDP_ABORTED
;

20  
XDP_PASS
;

21 
	}
}

	@tests/samples/xdp/adjust_head_prep_224_pass.c

1 
	~<lšux/bpf.h
>

3 
	#MAX_ADJUST
 (256 - 32 )

	)

5 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

6 (*è
BPF_FUNC_xdp_adju¡_h—d
;

8 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

9 *
d©a8
;

10 *
d©a
, *
d©a2
;

11 
i
;

13 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -
MAX_ADJUST
))

14  
XDP_ABORTED
;

16 
d©a
 = (*)()
xdp
->data;

17 ià(
d©a
 + 64 + 
MAX_ADJUST
 >

18 (*)()
xdp
->
d©a_’d
)

19  
XDP_ABORTED
;

21 
d©a2
 = 
d©a
 + 
MAX_ADJUST
;

23 
i
 = 0; i < 12; i++)

24 
d©a
[
i
] = 
d©a2
[i];

26 
d©a
[12] = 0x12;

27 
d©a
[13] = 0x34;

28 
d©a
[14] = 0;

29 
d©a
[15] = 0;

32 
d©a8
 = (*)&
d©a
[16];

34 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

35 
i
 = 0; i < (
MAX_ADJUST
 - 16è/ (*
d©a8
); i++)

36 
d©a8
[
i
] = 0;

38  
XDP_PASS
;

39 
	}
}

	@tests/samples/xdp/adjust_head_prep_256.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
, *
d©a2
;

8 *
d©a8
;

10 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -256))

11  
XDP_ABORTED
;

13 
d©a
 = (*)()
xdp
->data;

14 ià(
d©a
 + 64 + 256 > (*)()
xdp
->
d©a_’d
)

15  
XDP_ABORTED
;

17 
d©a2
 = 
d©a
 + 256 + 6;

19 *
d©a
++ = *
d©a2
++;

20 *
d©a
++ = *
d©a2
++;

21 *
d©a
++ = *
d©a2
++;

23 *
d©a
++ = *
d©a2
++;

24 *
d©a
++ = *
d©a2
++;

25 *
d©a
++ = *
d©a2
++;

27 
d©a2
 -= 12;

29 *
d©a
++ = *
d©a2
++;

30 *
d©a
++ = *
d©a2
++;

31 *
d©a
++ = *
d©a2
++;

33 *
d©a
++ = *
d©a2
++;

34 *
d©a
++ = *
d©a2
++;

35 *
d©a
++ = *
d©a2
++;

38 *
d©a
++ = 0x12;

39 *
d©a
++ = 0x34;

41 *
d©a
++ = 0;

42 *
d©a
++ = 0;

45 
d©a8
 = (*)
d©a
;

46 *
d©a8
++ = 0;

47 *
d©a8
++ = 0;

48 *
d©a8
++ = 0;

49 *
d©a8
++ = 0;

50 *
d©a8
++ = 0;

52 *
d©a8
++ = 0;

53 *
d©a8
++ = 0;

54 *
d©a8
++ = 0;

55 *
d©a8
++ = 0;

56 *
d©a8
++ = 0;

58 *
d©a8
++ = 0;

59 *
d©a8
++ = 0;

60 *
d©a8
++ = 0;

61 *
d©a8
++ = 0;

62 *
d©a8
++ = 0;

64 *
d©a8
++ = 0;

65 *
d©a8
++ = 0;

66 *
d©a8
++ = 0;

67 *
d©a8
++ = 0;

68 *
d©a8
++ = 0;

70 *
d©a8
++ = 0;

71 *
d©a8
++ = 0;

72 *
d©a8
++ = 0;

73 *
d©a8
++ = 0;

74 *
d©a8
++ = 0;

76 *
d©a8
++ = 0;

77 *
d©a8
++ = 0;

78 *
d©a8
++ = 0;

79 *
d©a8
++ = 0;

80 *
d©a8
++ = 0;

82  
XDP_TX
;

83 
	}
}

	@tests/samples/xdp/adjust_head_prep_ip.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
, *
d©a2
;

8 *
d©a16
;

9 
Ž
;

11 
d©a
 = (*)()
xdp
->data;

12 ià(
d©a
 + 20 + 14 > (*)()
xdp
->
d©a_’d
)

13  
XDP_ABORTED
;

15 ià(*(
d©a
 + 12) != 0x8 || *(data + 13) != 0)

16  
XDP_PASS
;

18 
d©a16
 = (*)
d©a
 + 16;

19 
Ž
 = *
d©a16
;

20 
Ž
 = ((tl & 0xff) << 8) | (tl >> 8);

22 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -20))

23  
XDP_ABORTED
;

25 
d©a
 = (*)()
xdp
->data;

26 ià(
d©a
 + 64 > (*)()
xdp
->
d©a_’d
)

27  
XDP_ABORTED
;

29 
d©a2
 = 
d©a
 + 20;

31 *
d©a
++ = *
d©a2
++;

32 *
d©a
++ = *
d©a2
++;

33 *
d©a
++ = *
d©a2
++;

35 *
d©a
++ = *
d©a2
++;

36 *
d©a
++ = *
d©a2
++;

37 *
d©a
++ = *
d©a2
++;

39 *
d©a
++ = *
d©a2
++;

40 *
d©a
++ = *
d©a2
++;

41 *
d©a
++ = *
d©a2
++;

43 *
d©a
++ = *
d©a2
++;

44 *
d©a
++ = *
d©a2
++;

45 *
d©a
++ = *
d©a2
++;

48 *
d©a
++ = *
d©a2
++;

49 *
d©a
++ = *
d©a2
++;

52 *
d©a
++ = 0x45;

53 *
d©a
++ = 0x00;

55 
Ž
 += 20;

56 *
d©a
++ = 
Ž
 >> 8;

57 *
d©a
++ = 
Ž
 & 0xff;

59 *
d©a
++ = 0xca;

60 *
d©a
++ = 0xfe;

62 *
d©a
++ = 0x40;

63 *
d©a
++ = 0;

65 *
d©a
++ = 17;

67 *
d©a
++ = 4;

69 *
d©a
++ = 0x88;

70 *
d©a
++ = 0xe9 - (
Ž
 & 0xff);

72 *
d©a
++ = 10;

73 *
d©a
++ = 8;

74 *
d©a
++ = 1;

75 *
d©a
++ = 2;

77 *
d©a
++ = 10;

78 *
d©a
++ = 8;

79 *
d©a
++ = 1;

80 *
d©a
++ = 1;

82  
XDP_PASS
;

83 
	}
}

	@tests/samples/xdp/adjust_head_prep_mac.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
, *
d©a2
;

9 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -14))

10  
XDP_ABORTED
;

12 
d©a
 = (*)()
xdp
->data;

13 ià(
d©a
 + 64 + 14 > (*)()
xdp
->
d©a_’d
)

14  
XDP_ABORTED
;

16 
d©a2
 = 
d©a
 + 14 + 6;

18 *
d©a
++ = *
d©a2
++;

19 *
d©a
++ = *
d©a2
++;

20 *
d©a
++ = *
d©a2
++;

22 *
d©a
++ = *
d©a2
++;

23 *
d©a
++ = *
d©a2
++;

24 *
d©a
++ = *
d©a2
++;

26 
d©a2
 -= 12;

28 *
d©a
++ = *
d©a2
++;

29 *
d©a
++ = *
d©a2
++;

30 *
d©a
++ = *
d©a2
++;

32 *
d©a
++ = *
d©a2
++;

33 *
d©a
++ = *
d©a2
++;

34 *
d©a
++ = *
d©a2
++;

37 *
d©a
++ = 0x12;

38 *
d©a
++ = 0x34;

40  
XDP_TX
;

41 
	}
}

	@tests/samples/xdp/adjust_head_pull32.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 32))

8  
XDP_ABORTED
;

10  
XDP_PASS
;

11 
	}
}

	@tests/samples/xdp/adjust_head_push32.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -32))

8  
XDP_ABORTED
;

10  
XDP_PASS
;

11 
	}
}

	@tests/samples/xdp/adjust_head_trunc.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
, *
d©a2
;

9 
d©a2
 = 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 64 > (*)()
xdp
->
d©a_’d
)

11  
XDP_ABORTED
;

13 
d©a
 += 13;

14 
d©a2
 += 11;

16 *
d©a
-- = *
d©a2
--;

17 *
d©a
-- = *
d©a2
--;

18 *
d©a
-- = *
d©a2
--;

20 *
d©a
-- = *
d©a2
--;

21 *
d©a
-- = *
d©a2
--;

22 *
d©a
-- = *
d©a2
--;

24 *
d©a
-- = *
d©a2
--;

25 *
d©a
-- = *
d©a2
--;

26 *
d©a
-- = *
d©a2
--;

28 *
d©a
-- = *
d©a2
--;

29 *
d©a
-- = *
d©a2
--;

30 *
d©a
-- = *
d©a2
--;

32 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 2))

33  
XDP_ABORTED
;

35 
d©a2
 = 
d©a
 = (*)()
xdp
->data;

36 ià(
d©a
 + 64 > (*)()
xdp
->
d©a_’d
)

37  
XDP_ABORTED
;

39 
d©a2
 += 6;

41 *
d©a2
 ^ð*
d©a
; *data ^= *data2; *data2 ^= *data; data++; data2++;

42 *
d©a2
 ^ð*
d©a
; *data ^= *data2; *data2 ^= *data; data++; data2++;

43 *
d©a2
 ^ð*
d©a
; *data ^= *data2; *data2 ^= *data; data++; data2++;

45 *
d©a2
 ^ð*
d©a
; *data ^= *data2; *data2 ^= *data; data++; data2++;

46 *
d©a2
 ^ð*
d©a
; *data ^= *data2; *data2 ^= *data; data++; data2++;

47 *
d©a2
 ^ð*
d©a
; *data ^= *data2; *data2 ^= *data; data++; data2++;

50 *
d©a2
++ = 0x12;

51 *
d©a2
++ = 0x34;

53  
XDP_TX
;

54 
	}
}

	@tests/samples/xdp/adjust_head_trunc_pass.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
, *
d©a2
;

9 
d©a2
 = 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 64 + 14 > (*)()
xdp
->
d©a_’d
)

11  
XDP_ABORTED
;

13 
d©a
 = data + 64;

15 *
d©a
++ = *
d©a2
++;

16 *
d©a
++ = *
d©a2
++;

17 *
d©a
++ = *
d©a2
++;

19 *
d©a
++ = *
d©a2
++;

20 *
d©a
++ = *
d©a2
++;

21 *
d©a
++ = *
d©a2
++;

23 *
d©a
++ = *
d©a2
++;

24 *
d©a
++ = *
d©a2
++;

25 *
d©a
++ = *
d©a2
++;

27 *
d©a
++ = *
d©a2
++;

28 *
d©a
++ = *
d©a2
++;

29 *
d©a
++ = *
d©a2
++;

31 *
d©a
++ = 0x12;

32 *
d©a
++ = 0x34;

34 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 64))

35  
XDP_ABORTED
;

37  
XDP_PASS
;

38 
	}
}

	@tests/samples/xdp/adjust_head_trunc_to_14.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 *
d©a
, *
d©a2
;

9 
d©a2
 = 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 96 > (*)()
xdp
->
d©a_’d
)

11  
XDP_ABORTED
;

13 
d©a2
 = 
d©a
;

14 
d©a
 += 82 + 6;

16 *
d©a
++ = *
d©a2
++;

17 *
d©a
++ = *
d©a2
++;

18 *
d©a
++ = *
d©a2
++;

20 *
d©a
++ = *
d©a2
++;

21 *
d©a
++ = *
d©a2
++;

22 *
d©a
++ = *
d©a2
++;

24 
d©a
 -= 12;

26 *
d©a
++ = *
d©a2
++;

27 *
d©a
++ = *
d©a2
++;

28 *
d©a
++ = *
d©a2
++;

30 *
d©a
++ = *
d©a2
++;

31 *
d©a
++ = *
d©a2
++;

32 *
d©a
++ = *
d©a2
++;

34 
d©a
 += 6;

37 *
d©a
++ = 0x12;

38 *
d©a
++ = 0x34;

40 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 82))

41  
XDP_ABORTED
;

43  
XDP_TX
;

44 
	}
}

	@tests/samples/xdp/adjust_head_twice.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_h—d
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_h—d
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 16))

8  
XDP_ABORTED
;

10 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -16))

11  
XDP_ABORTED
;

13  
XDP_PASS
;

14 
	}
}

	@tests/samples/xdp/adjust_tail_14.c

1 
	~<lšux/bpf.h
>

3 (*
bpf_xdp_adju¡_ž
)(*
ùx
, 
off£t
) =

4 (*è
BPF_FUNC_xdp_adju¡_ž
;

6 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

7 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, xdp->
d©a
 - xdp->
d©a_’d
 + 14))

8  
XDP_ABORTED
;

10  
XDP_PASS
;

11 
	}
}

	@tests/samples/xdp/adjust_tail_multi.c

1 
	~<”ºo.h
>

2 
	~<lšux/bpf.h
>

4 (*
bpf_xdp_adju¡_ž
)(*
ùx
, 
off£t
) =

5 (*è
BPF_FUNC_xdp_adju¡_ž
;

7 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

9 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -1))

10  
XDP_ABORTED
;

11 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -2))

12  
XDP_ABORTED
;

13 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -3))

14  
XDP_ABORTED
;

15 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -4))

16  
XDP_ABORTED
;

17 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -5))

18  
XDP_ABORTED
;

21 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 5è!ð-
EINVAL
)

22  
XDP_ABORTED
;

24 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -15))

25  
XDP_ABORTED
;

27  
XDP_PASS
;

28 
	}
}

	@tests/samples/xdp/adjust_tail_negative_bad.c

1 
	~<”ºo.h
>

2 
	~<lšux/bpf.h
>

4 (*
bpf_xdp_adju¡_ž
)(*
ùx
, 
off£t
) =

5 (*è
BPF_FUNC_xdp_adju¡_ž
;

7 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

8 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -0x1000è!ð-
EINVAL
)

9  
XDP_ABORTED
;

10 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -0xffffè!ð-
EINVAL
)

11  
XDP_ABORTED
;

12 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -0x10000è!ð-
EINVAL
)

13  
XDP_ABORTED
;

14 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, -0x1000000è!ð-
EINVAL
)

15  
XDP_ABORTED
;

17 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, xdp->
d©a
 - xdp->
d©a_’d
è!ð-
EINVAL
)

18  
XDP_ABORTED
;

19 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, xdp->
d©a
 - xdp->
d©a_’d
 + 13è!ð-
EINVAL
)

20  
XDP_ABORTED
;

22  
XDP_PASS
;

23 
	}
}

	@tests/samples/xdp/adjust_tail_positive.c

1 
	~<”ºo.h
>

2 
	~<lšux/bpf.h
>

4 (*
bpf_xdp_adju¡_ž
)(*
ùx
, 
off£t
) =

5 (*è
BPF_FUNC_xdp_adju¡_ž
;

7 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

8 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 1è!ð-
EINVAL
)

9  
XDP_ABORTED
;

10 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 0x100è!ð-
EINVAL
)

11  
XDP_ABORTED
;

12 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 0xffffè!ð-
EINVAL
)

13  
XDP_ABORTED
;

14 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 0x10000è!ð-
EINVAL
)

15  
XDP_ABORTED
;

16 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 1U << 30è!ð-
EINVAL
)

17  
XDP_ABORTED
;

19 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 1U << 31è!ð-
EINVAL
)

20  
XDP_ABORTED
;

22 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, xdp->
d©a_’d
 - xdp->
d©a
è!ð-
EINVAL
)

23  
XDP_ABORTED
;

26 ià(
	`bpf_xdp_adju¡_ž
(
xdp
, 0è!ð-
EINVAL
)

27  
XDP_ABORTED
;

29  
XDP_PASS
;

30 
	}
}

	@tests/samples/xdp/app_l4lb.c

4 
	~<¡dboÞ.h
>

5 
	~<¡ddef.h
>

6 
	~<¡ršg.h
>

7 
	~<lšux/bpf.h
>

8 
	~<lšux/icmp.h
>

9 
	~<lšux/if_‘h”.h
>

10 
	~<lšux/if_vÏn.h
>

11 
	~<lšux/š.h
>

12 
	~<lšux/.h
>

13 
	~<lšux/tý.h
>

14 
	~<lšux/udp.h
>

15 
	~"../bpf/bpf_’dŸn.h
"

16 
	~"../bpf/bpf_h–³rs.h
"

17 
	~"../bpf/jhash.h
"

19 
	#MAX_SERVERS
 512

	)

21 
	#IP_FRAGMENTED
 65343

	)

23 
	spkt_m‘a
 {

24 
__be32
 
	m¤c
;

25 
__be32
 
	md¡
;

27 
__u32
 
	mpÜts
;

28 
__u16
 
	mpÜt16
[2];

32 
	sde¡_šfo
 {

33 
__u32
 
	m§ddr
;

34 
__u32
 
	mdaddr
;

35 
__u64
 
	mby‹s
;

36 
__u64
 
	mpkts
;

37 
__u8
 
	mdmac
[6];

40 
bpf_m­_def
 
SEC
("m­s"è
	g£rv”s
 = {

41 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

42 .
	gkey_size
 = (
__u32
),

43 .
	gv®ue_size
 = (
de¡_šfo
),

44 .
	gmax_’Œ›s
 = 
MAX_SERVERS
,

47 
__®ways_šlše
 
de¡_šfo
 *
	$hash_g‘_de¡
(
pkt_m‘a
 *
pkt
)

49 
__u32
 
key
;

50 
de¡_šfo
 *
Šl
;

53 
key
 = 
	`jhash_2wÜds
(
pkt
->
¤c
,…kt->
pÜts
, 
MAX_SERVERS
) % MAX_SERVERS;

56 
Šl
 = 
	`bpf_m­_lookup_–em
(&
£rv”s
, &
key
);

57 ià(!
Šl
) {

59 
key
 = 0;

60 
Šl
 = 
	`bpf_m­_lookup_–em
(&
£rv”s
, &
key
);

62  
Šl
;

63 
	}
}

65 
__®ways_šlše
 
boÞ
 
	$·r£_udp
(*
d©a
, 
__u64
 
off
, *
d©a_’d
,

66 
pkt_m‘a
 *
pkt
)

68 
udphdr
 *
udp
;

70 
udp
 = 
d©a
 + 
off
;

71 ià(
udp
 + 1 > 
d©a_’d
)

72  
çl£
;

74 
pkt
->
pÜt16
[0] = 
udp
->
sourû
;

75 
pkt
->
pÜt16
[1] = 
udp
->
de¡
;

77  
Œue
;

78 
	}
}

80 
__®ways_šlše
 
boÞ
 
	$·r£_tý
(*
d©a
, 
__u64
 
off
, *
d©a_’d
,

81 
pkt_m‘a
 *
pkt
)

83 
týhdr
 *
tý
;

85 
tý
 = 
d©a
 + 
off
;

86 ià(
tý
 + 1 > 
d©a_’d
)

87  
çl£
;

89 
pkt
->
pÜt16
[0] = 
tý
->
sourû
;

90 
pkt
->
pÜt16
[1] = 
tý
->
de¡
;

92  
Œue
;

93 
	}
}

95 
__®ways_šlše
 
	$£t_‘hhdr
(
‘hhdr
 *
Ãw_‘h
,

96 cÚ¡ 
‘hhdr
 *
Þd_‘h
,

97 cÚ¡ 
de¡_šfo
 *
Šl
,

98 
__be16
 
h_´Ùo
)

100 
	`memýy
(
Ãw_‘h
->
h_sourû
, 
Þd_‘h
->
h_de¡
, (new_eth->h_source));

101 
	`memýy
(
Ãw_‘h
->
h_de¡
, 
Šl
->
dmac
, (new_eth->h_dest));

102 
Ãw_‘h
->
h_´Ùo
 = h_proto;

103 
	}
}

105 
__®ways_šlše
 
	$´oûss_·ck‘
(
xdp_md
 *
ùx
, 
__u64
 
off
)

107 *
d©a_’d
 = (*)()
ùx
->data_end;

108 *
d©a
 = (*)()
ùx
->data;

109 
pkt_m‘a
 
pkt
 = {};

110 
‘hhdr
 *
Ãw_‘h
;

111 
‘hhdr
 *
Þd_‘h
;

112 
de¡_šfo
 *
Šl
;

113 
hdr
 
h_Šl
;

114 
hdr
 *
h
;

115 
__u16
 *
Ãxt_h_u16
;

116 
__u16
 
pkt_size
;

117 
__u16
 
·ylßd_Ën
;

118 
__u8
 
´ÙocÞ
;

119 
u32
 
csum
 = 0;

121 
h
 = 
d©a
 + 
off
;

122 ià(
h
 + 1 > 
d©a_’d
)

123  
XDP_DROP
;

124 ià(
h
->
ihl
 != 5)

125  
XDP_DROP
;

127 
´ÙocÞ
 = 
h
->protocol;

128 
·ylßd_Ën
 = 
	`bpf_Áohs
(
h
->
tÙ_Ën
);

129 
off
 +ð(
hdr
);

132 ià(
h
->
äag_off
 & 
IP_FRAGMENTED
)

133  
XDP_DROP
;

135 
pkt
.
¤c
 = 
h
->
§ddr
;

136 
pkt
.
d¡
 = 
h
->
daddr
;

139 ià(
´ÙocÞ
 =ð
IPPROTO_TCP
) {

140 ià(!
	`·r£_tý
(
d©a
, 
off
, 
d©a_’d
, &
pkt
))

141  
XDP_DROP
;

142 } ià(
´ÙocÞ
 =ð
IPPROTO_UDP
) {

143 ià(!
	`·r£_udp
(
d©a
, 
off
, 
d©a_’d
, &
pkt
))

144  
XDP_DROP
;

146  
XDP_PASS
;

150 
Šl
 = 
	`hash_g‘_de¡
(&
pkt
);

151 ià(!
Šl
)

152  
XDP_DROP
;

155 ià(
	`bpf_xdp_adju¡_h—d
(
ùx
, 0 - ()(
hdr
)))

156  
XDP_DROP
;

158 
d©a
 = (*)()
ùx
->data;

159 
d©a_’d
 = (*)()
ùx
->data_end;

162 
Ãw_‘h
 = 
d©a
;

163 
Þd_‘h
 = 
d©a
 + (*
h
);

165 ià(
Ãw_‘h
 + 1 > 
d©a_’d
 || 
Þd_‘h
 + 1 > data_end ||

166 
h
 + 1 > 
d©a_’d
)

167  
XDP_DROP
;

169 
	`£t_‘hhdr
(
Ãw_‘h
, 
Þd_‘h
, 
Šl
, 
	`bpf_htÚs
(
ETH_P_IP
));

172 
h_Šl
.
v”siÚ
 = 4;

173 
h_Šl
.
ihl
 = (*
h
) >> 2;

174 
h_Šl
.
äag_off
 = 0;

175 
h_Šl
.
´ÙocÞ
 = 
IPPROTO_IPIP
;

176 
h_Šl
.
check
 = 0;

177 
h_Šl
.
id
 = 0;

178 
h_Šl
.
tos
 = 0;

179 
h_Šl
.
tÙ_Ën
 = 
	`bpf_htÚs
(
·ylßd_Ën
 + (*
h
));

180 
h_Šl
.
daddr
 = 
Šl
->daddr;

181 
h_Šl
.
§ddr
 = 
Šl
->saddr;

182 
h_Šl
.
‰l
 = 8;

185 
Ãxt_h_u16
 = (
__u16
 *)&
h_Šl
;

186 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

187 
i
 = 0; i < ()(*
h
) >> 1; i++)

188 
csum
 +ð*
Ãxt_h_u16
++;

189 
h_Šl
.
check
 = ~((
csum
 & 0xffff) + (csum >> 16));

191 
h
 = 
d©a
 + (*
Ãw_‘h
);

192 *
h
 = 
h_Šl
;

195 
pkt_size
 = (
__u16
)(
d©a_’d
 - 
d©a
);

196 
	`__sync_ãtch_ªd_add
(&
Šl
->
pkts
, 1);

197 
	`__sync_ãtch_ªd_add
(&
Šl
->
by‹s
, 
pkt_size
);

199  
XDP_TX
;

200 
	}
}

202 
	$lßdb®
(
xdp_md
 *
ùx
)

204 *
d©a_’d
 = (*)()
ùx
->data_end;

205 *
d©a
 = (*)()
ùx
->data;

206 
‘hhdr
 *
‘h
 = 
d©a
;

207 
__u32
 
‘h_´Ùo
;

208 
__u32
 
nh_off
;

210 
nh_off
 = (
‘hhdr
);

211 ià(
d©a
 + 
nh_off
 > 
d©a_’d
)

212  
XDP_DROP
;

213 
‘h_´Ùo
 = 
‘h
->
h_´Ùo
;

216 ià(
‘h_´Ùo
 =ð
	`bpf_htÚs
(
ETH_P_IP
))

217  
	`´oûss_·ck‘
(
ùx
, 
nh_off
);

219  
XDP_PASS
;

220 
	}
}

222 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/app_packet_read.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/if_‘h”.h
>

3 
	~<lšux/.h
>

4 
	~<lšux/š.h
>

5 
	~<lšux/tý.h
>

6 
	~"../bpf/bpf_h–³rs.h
"

8 
bpf_m­_def
 
SEC
("m­s"è
	g‘hm­
 = {

9 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

10 .
	gkey_size
 = (
__u32
),

11 .
	gv®ue_size
 = (
‘hhdr
),

12 .
	gmax_’Œ›s
 = 1,

15 
bpf_m­_def
 
SEC
("m­s"è
	g
 = {

16 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

17 .
	gkey_size
 = (
__u32
),

18 .
	gv®ue_size
 = (
hdr
),

19 .
	gmax_’Œ›s
 = 1,

22 
bpf_m­_def
 
SEC
("m­s"è
	gtý
 = {

23 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

24 .
	gkey_size
 = (
__u32
),

25 .
	gv®ue_size
 = (
týhdr
),

26 .
	gmax_’Œ›s
 = 1,

29 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

30 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

31 .
	gkey_size
 = (),

32 .
	gv®ue_size
 = (),

33 .
	gmax_’Œ›s
 = 64,

36 
	s”rÜ
 {

37 
__u32
 
	mid
;

38 
__u32
 
	mv®1
;

39 
__u32
 
	mv®2
;

42 
__®ways_šlše


43 
	$debug_”r
(
xdp_md
 *
ùx
, 
__u32
 
id
, __u32 
v®1
, __u32 
v®2
)

45 
”rÜ
 
”r
;

47 
”r
.
id
 = id;

48 
”r
.
v®1
 = val1;

49 
”r
.
v®2
 = val2;

51 
	`bpf_³rf_ev’t_ouut
(
ùx
, &
·
, 0x1ffffffffULL, &
”r
, (err));

52 
	}
}

54 
__®ways_šlše


55 
__u8
 
	$mac_check
(
xdp_md
 *
ùx
, 
__u32
 
id
, *
p1
, *
p2
, 
__u16
 
Ën
)

57 
j
 = 0;

58 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

59 
j
 = 0; j < 
Ën
; j++) {

60 ià(*
p1
 !ð*
p2
) {

61 
	`debug_”r
(
ùx
, 
id
, *
p1
, *
p2
);

64 
p1
++;

65 
p2
++;

68 
	}
}

70 
	$xdp_´og1
(
xdp_md
 *
ùx
)

72 *
d©a_’d
 = (*)()
ùx
->data_end;

73 *
d©a
 = (*)()
ùx
->data;

75 
‘hhdr
 *
‘h
 = 
d©a
;

76 
‘hhdr
 *
‘h_m­v®
;

77 
týhdr
 *
tý_m­v®
;

78 
hdr
 *
_m­v®
;

79 
hdr
 *
h
;

80 
týhdr
 *
th
;

82 
__u8
 
»t_m­çž
 = 
XDP_ABORTED
;

83 
__u8
 
»t_çž
 = 
XDP_DROP
;

84 
__u8
 
»t_·ss
 = 
XDP_TX
;

85 
__u32
 
»t
 = 
»t_·ss
;

86 
__u32
 
check_id
 = 0;

87 
__u32
 
šdex
 = 0;

88 
__u64
 
nh_off
;

89 *
m­_mac
;

90 *
pkt_mac
;

93 
nh_off
 = (*
‘h
);

94 ià(
d©a
 + 
nh_off
 > 
d©a_’d
)

95  
XDP_PASS
;

97 
h
 = 
d©a
 + 
nh_off
;

98 ià(
h
 + 1 > 
d©a_’d
)

99  
XDP_PASS
;

101 
nh_off
 +ð(
hdr
);

102 ià(
h
->
´ÙocÞ
 !ð
IPPROTO_TCP
)

103  
XDP_PASS
;

105 
th
 = 
d©a
 + 
nh_off
;

106 ià(
d©a
 + 
nh_off
 + (*
th
è> 
d©a_’d
)

107  
XDP_PASS
;

110 
‘h_m­v®
 = 
	`bpf_m­_lookup_–em
(&
‘hm­
, &
šdex
);

111 ià(!
‘h_m­v®
)

112  
»t_m­çž
;

114 
_m­v®
 = 
	`bpf_m­_lookup_–em
(&

, &
šdex
);

115 ià(!
_m­v®
)

116  
»t_m­çž
;

118 
tý_m­v®
 = 
	`bpf_m­_lookup_–em
(&
tý
, &
šdex
);

119 ià(!
tý_m­v®
)

120  
»t_m­çž
;

122 
check_id
 = 1;

123 
m­_mac
 = (*)
‘h_m­v®
->
h_de¡
;

124 
pkt_mac
 = (*)
‘h
->
h_de¡
;

125 ià(
	`mac_check
(
ùx
, 
check_id
, 
m­_mac
, 
pkt_mac
, 6) != 1)

126 
»t
 = 
»t_çž
;

128 
check_id
 = 2;

129 
m­_mac
 = (*)
‘h_m­v®
->
h_sourû
;

130 
pkt_mac
 = (*)
‘h
->
h_sourû
;

131 ià(
	`mac_check
(
ùx
, 
check_id
, 
m­_mac
, 
pkt_mac
, 6) != 1)

132 
»t
 = 
»t_çž
;

134 ià(
‘h_m­v®
->
h_´Ùo
 !ð
‘h
->h_proto) {

135 
check_id
 = 3;

136 
	`debug_”r
(
ùx
, 
check_id
, 
‘h_m­v®
->
h_´Ùo
, 
‘h
->h_proto);

137 
»t
 = 
»t_çž
;

140 ià(
_m­v®
->
tos
 !ð
h
->tos) {

141 
check_id
 = 4;

142 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
tos
, 
h
->tos);

143 
»t
 = 
»t_çž
;

145 ià(
_m­v®
->
tÙ_Ën
 != 0x00) {

146 ià(
_m­v®
->
tÙ_Ën
 !ð
h
->tot_len) {

147 
check_id
 = 5;

148 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
tÙ_Ën
,

149 
h
->
tÙ_Ën
);

150 
»t
 = 
»t_çž
;

153 ià(
_m­v®
->
id
 != 0x00) {

154 ià(
_m­v®
->
id
 !ð
h
->id) {

155 
check_id
 = 6;

156 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
id
, 
h
->id);

157 
»t
 = 
»t_çž
;

160 ià(
_m­v®
->
äag_off
 !ð
h
->frag_off) {

161 
check_id
 = 7;

162 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
äag_off
, 
h
->frag_off);

163 
»t
 = 
»t_çž
;

165 ià(
_m­v®
->
‰l
 !ð
h
->ttl) {

166 
check_id
 = 8;

167 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
‰l
, 
h
->ttl);

168 
»t
 = 
»t_çž
;

170 ià(
_m­v®
->
´ÙocÞ
 !ð
h
->protocol) {

171 
check_id
 = 9;

172 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
´ÙocÞ
, 
h
->protocol);

173 
»t
 = 
»t_çž
;

175 ià(
_m­v®
->
check
 != 0x00) {

176 ià(
_m­v®
->
check
 !ð
h
->check) {

177 
check_id
 = 10;

178 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
check
, 
h
->check);

179 
»t
 = 
»t_çž
;

182 ià(
_m­v®
->
§ddr
 !ð
h
->saddr) {

183 
check_id
 = 11;

184 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
§ddr
, 
h
->saddr);

185 
»t
 = 
»t_çž
;

187 ià(
_m­v®
->
daddr
 !ð
h
->daddr) {

188 
check_id
 = 12;

189 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
daddr
, 
h
->daddr);

190 
»t
 = 
»t_çž
;

193 ià(
tý_m­v®
->
sourû
 !ð
th
->source) {

194 
check_id
 = 13;

195 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
sourû
, 
th
->source);

196 
»t
 = 
»t_çž
;

198 ià(
tý_m­v®
->
de¡
 !ð
th
->dest) {

199 
check_id
 = 14;

200 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
de¡
, 
th
->dest);

201 
»t
 = 
»t_çž
;

203 ià(
tý_m­v®
->
£q
 !ð
th
->seq) {

204 
check_id
 = 15;

205 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
£q
, 
th
->seq);

206 
»t
 = 
»t_çž
;

208 ià(
tý_m­v®
->
ack_£q
 !ð
th
->ack_seq) {

209 
check_id
 = 16;

210 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
ack_£q
, 
th
->ack_seq);

211 
»t
 = 
»t_çž
;

213 ià(
tý_m­v®
->
»s1
 !ð
th
->res1) {

214 
check_id
 = 17;

215 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
»s1
, 
th
->res1);

216 
»t
 = 
»t_çž
;

218 ià(
tý_m­v®
->
doff
 !ð
th
->doff) {

219 
check_id
 = 18;

220 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
doff
, 
th
->doff);

221 
»t
 = 
»t_çž
;

223 ià(
tý_m­v®
->
fš
 !ð
th
->fin) {

224 
check_id
 = 19;

225 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
fš
, 
th
->fin);

226 
»t
 = 
»t_çž
;

228 ià(
tý_m­v®
->
syn
 !ð
th
->syn) {

229 
check_id
 = 20;

230 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
syn
, 
th
->syn);

231 
»t
 = 
»t_çž
;

233 ià(
tý_m­v®
->
r¡
 !ð
th
->rst) {

234 
check_id
 = 21;

235 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
r¡
, 
th
->rst);

236 
»t
 = 
»t_çž
;

238 ià(
tý_m­v®
->
psh
 !ð
th
->psh) {

239 
check_id
 = 22;

240 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
psh
, 
th
->psh);

241 
»t
 = 
»t_çž
;

243 ià(
tý_m­v®
->
ack
 !ð
th
->ack) {

244 
check_id
 = 23;

245 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
ack
, 
th
->ack);

246 
»t
 = 
»t_çž
;

248 ià(
tý_m­v®
->
urg
 !ð
th
->urg) {

249 
check_id
 = 24;

250 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
urg
, 
th
->urg);

251 
»t
 = 
»t_çž
;

253 ià(
tý_m­v®
->
eû
 !ð
th
->ece) {

254 
check_id
 = 25;

255 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
eû
, 
th
->ece);

256 
»t
 = 
»t_çž
;

258 ià(
tý_m­v®
->
cwr
 !ð
th
->cwr) {

259 
check_id
 = 26;

260 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
cwr
, 
th
->cwr);

261 
»t
 = 
»t_çž
;

263 ià(
tý_m­v®
->
wšdow
 !ð
th
->window) {

264 
check_id
 = 27;

265 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
wšdow
, 
th
->window);

266 
»t
 = 
»t_çž
;

268 ià(
tý_m­v®
->
check
 != 0x00) {

269 ià(
tý_m­v®
->
check
 !ð
th
->check) {

270 
check_id
 = 28;

271 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
check
, 
th
->check);

272 
»t
 = 
»t_çž
;

275 ià(
tý_m­v®
->
urg_±r
 !ð
th
->urg_ptr) {

276 
check_id
 = 29;

277 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
urg_±r
, 
th
->urg_ptr);

278 
»t
 = 
»t_çž
;

283 
_m­v®
 = 
	`bpf_m­_lookup_–em
(&

, &
šdex
);

284 ià(!
_m­v®
)

285  
»t_m­çž
;

287 
tý_m­v®
 = 
	`bpf_m­_lookup_–em
(&
tý
, &
šdex
);

288 ià(!
tý_m­v®
)

289  
»t_m­çž
;

291 ià(
_m­v®
->
tos
 > 
h
->tos) {

292 
check_id
 = 30;

293 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
tos
, 
h
->tos);

294 
»t
 = 
»t_çž
;

296 ià(
_m­v®
->
tÙ_Ën
 != 0x00) {

297 ià(
_m­v®
->
tÙ_Ën
 > 
h
->tot_len) {

298 
check_id
 = 31;

299 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
tÙ_Ën
,

300 
h
->
tÙ_Ën
);

301 
»t
 = 
»t_çž
;

304 ià(
_m­v®
->
id
 != 0x00) {

305 ià(
_m­v®
->
id
 > 
h
->id) {

306 
check_id
 = 32;

307 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
id
, 
h
->id);

308 
»t
 = 
»t_çž
;

311 ià(
_m­v®
->
äag_off
 > 
h
->frag_off) {

312 
check_id
 = 33;

313 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
äag_off
, 
h
->frag_off);

314 
»t
 = 
»t_çž
;

316 ià(
_m­v®
->
‰l
 > 
h
->ttl) {

317 
check_id
 = 34;

318 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
‰l
, 
h
->ttl);

319 
»t
 = 
»t_çž
;

321 ià(
_m­v®
->
´ÙocÞ
 > 
h
->protocol) {

322 
check_id
 = 35;

323 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
´ÙocÞ
, 
h
->protocol);

324 
»t
 = 
»t_çž
;

326 ià(
_m­v®
->
check
 != 0x00) {

327 ià(
_m­v®
->
check
 > 
h
->check) {

328 
check_id
 = 36;

329 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
check
, 
h
->check);

330 
»t
 = 
»t_çž
;

333 ià(
_m­v®
->
§ddr
 > 
h
->saddr) {

334 
check_id
 = 37;

335 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
§ddr
, 
h
->saddr);

336 
»t
 = 
»t_çž
;

338 ià(
_m­v®
->
daddr
 > 
h
->daddr) {

339 
check_id
 = 38;

340 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
daddr
, 
h
->daddr);

341 
»t
 = 
»t_çž
;

343 ià(
tý_m­v®
->
sourû
 > 
th
->source) {

344 
check_id
 = 39;

345 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
sourû
, 
th
->source);

346 
»t
 = 
»t_çž
;

348 ià(
tý_m­v®
->
de¡
 > 
th
->dest) {

349 
check_id
 = 40;

350 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
de¡
, 
th
->dest);

351 
»t
 = 
»t_çž
;

353 ià(
tý_m­v®
->
£q
 > 
th
->seq) {

354 
check_id
 = 41;

355 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
£q
, 
th
->seq);

356 
»t
 = 
»t_çž
;

358 ià(
tý_m­v®
->
ack_£q
 > 
th
->ack_seq) {

359 
check_id
 = 42;

360 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
ack_£q
, 
th
->ack_seq);

361 
»t
 = 
»t_çž
;

363 ià(
tý_m­v®
->
wšdow
 > 
th
->window) {

364 
check_id
 = 43;

365 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
wšdow
, 
th
->window);

366 
»t
 = 
»t_çž
;

368 ià(
tý_m­v®
->
check
 != 0x00) {

369 ià(
tý_m­v®
->
check
 > 
th
->check) {

370 
check_id
 = 44;

371 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
check
, 
th
->check);

372 
»t
 = 
»t_çž
;

375 ià(
tý_m­v®
->
urg_±r
 > 
th
->urg_ptr) {

376 
check_id
 = 45;

377 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
urg_±r
, 
th
->urg_ptr);

378 
»t
 = 
»t_çž
;

383 
_m­v®
 = 
	`bpf_m­_lookup_–em
(&

, &
šdex
);

384 ià(!
_m­v®
)

385  
»t_m­çž
;

387 
tý_m­v®
 = 
	`bpf_m­_lookup_–em
(&
tý
, &
šdex
);

388 ià(!
tý_m­v®
)

389  
»t_m­çž
;

391 ià(
_m­v®
->
tos
 < 
h
->tos) {

392 
check_id
 = 46;

393 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
tos
, 
h
->tos);

394 
»t
 = 
»t_çž
;

396 ià(
_m­v®
->
tÙ_Ën
 != 0x00) {

397 ià(
_m­v®
->
tÙ_Ën
 < 
h
->tot_len) {

398 
check_id
 = 47;

399 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
tÙ_Ën
,

400 
h
->
tÙ_Ën
);

401 
»t
 = 
»t_çž
;

404 ià(
_m­v®
->
id
 != 0x00) {

405 ià(
_m­v®
->
id
 < 
h
->id) {

406 
check_id
 = 48;

407 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
id
, 
h
->id);

408 
»t
 = 
»t_çž
;

411 ià(
_m­v®
->
äag_off
 < 
h
->frag_off) {

412 
check_id
 = 49;

413 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
äag_off
, 
h
->frag_off);

414 
»t
 = 
»t_çž
;

416 ià(
_m­v®
->
‰l
 < 
h
->ttl) {

417 
check_id
 = 50;

418 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
‰l
, 
h
->ttl);

419 
»t
 = 
»t_çž
;

421 ià(
_m­v®
->
´ÙocÞ
 < 
h
->protocol) {

422 
check_id
 = 51;

423 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
´ÙocÞ
, 
h
->protocol);

424 
»t
 = 
»t_çž
;

426 ià(
_m­v®
->
check
 != 0x00) {

427 ià(
_m­v®
->
check
 < 
h
->check) {

428 
check_id
 = 52;

429 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
check
, 
h
->check);

430 
»t
 = 
»t_çž
;

433 ià(
_m­v®
->
§ddr
 < 
h
->saddr) {

434 
check_id
 = 53;

435 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
§ddr
, 
h
->saddr);

436 
»t
 = 
»t_çž
;

438 ià(
_m­v®
->
daddr
 < 
h
->daddr) {

439 
check_id
 = 54;

440 
	`debug_”r
(
ùx
, 
check_id
, 
_m­v®
->
daddr
, 
h
->daddr);

441 
»t
 = 
»t_çž
;

443 ià(
tý_m­v®
->
sourû
 < 
th
->source) {

444 
check_id
 = 55;

445 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
sourû
, 
th
->source);

446 
»t
 = 
»t_çž
;

448 ià(
tý_m­v®
->
de¡
 < 
th
->dest) {

449 
check_id
 = 56;

450 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
de¡
, 
th
->dest);

451 
»t
 = 
»t_çž
;

453 ià(
tý_m­v®
->
£q
 < 
th
->seq) {

454 
check_id
 = 57;

455 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
£q
, 
th
->seq);

456 
»t
 = 
»t_çž
;

458 ià(
tý_m­v®
->
ack_£q
 < 
th
->ack_seq) {

459 
check_id
 = 58;

460 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
ack_£q
, 
th
->ack_seq);

461 
»t
 = 
»t_çž
;

463 ià(
tý_m­v®
->
wšdow
 < 
th
->window) {

464 
check_id
 = 59;

465 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
wšdow
, 
th
->window);

466 
»t
 = 
»t_çž
;

468 ià(
tý_m­v®
->
check
 != 0x00) {

469 ià(
tý_m­v®
->
check
 < 
th
->check) {

470 
check_id
 = 60;

471 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
check
, 
th
->check);

472 
»t
 = 
»t_çž
;

475 ià(
tý_m­v®
->
urg_±r
 < 
th
->urg_ptr) {

476 
check_id
 = 61;

477 
	`debug_”r
(
ùx
, 
check_id
, 
tý_m­v®
->
urg_±r
, 
th
->urg_ptr);

478 
»t
 = 
»t_çž
;

481  
»t
;

482 
	}
}

484 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_pkt.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
	$xdp_´og1
(
xdp_md
 *
xdp
)

7 *
d©a
;

8 *
±r
;

10 
d©a
 = (*)()
xdp
->data;

11 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

12  
XDP_ABORTED
;

14 
±r
 = (*)(
d©a
 + 40);

15 
	`__sync_ãtch_ªd_add
(
±r
, 1);

17  
XDP_PASS
;

18 
	}
}

20 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_read.h

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
) * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0;

16 
__u32
 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

23 ià(!
v®ue
)

24  
XDP_DROP
;

26 
d©a
 = (*)
v®ue
;

27 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, 
d©a
[
READ_OFFSET
]);

29  
XDP_PASS
;

30 
	}
}

32 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_read0.c

1 cÚ¡ 
	gREAD_OFFSET
 = 0;

3 
	~"©omic_»ad.h
"

	@tests/samples/xdp/atomic_read1.c

1 cÚ¡ 
	gREAD_OFFSET
 = 1;

3 
	~"©omic_»ad.h
"

	@tests/samples/xdp/atomic_read11.c

1 cÚ¡ 
	gREAD_OFFSET
 = 11;

3 
	~"©omic_»ad.h
"

	@tests/samples/xdp/atomic_read3.c

1 cÚ¡ 
	gREAD_OFFSET
 = 3;

3 
	~"©omic_»ad.h
"

	@tests/samples/xdp/atomic_read64.h

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = () * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0;

16 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

23 ià(!
v®ue
)

24  
XDP_DROP
;

26 
d©a
 = (*)
v®ue
;

27 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, 
d©a
[
READ_OFFSET
]);

29  
XDP_PASS
;

30 
	}
}

32 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_read64_12.c

1 cÚ¡ 
	gREAD_OFFSET
 = 12;

3 
	~"©omic_»ad64.h
"

	@tests/samples/xdp/atomic_read64_16.c

1 cÚ¡ 
	gREAD_OFFSET
 = 16;

3 
	~"©omic_»ad64.h
"

	@tests/samples/xdp/atomic_read64_7.c

1 cÚ¡ 
	gREAD_OFFSET
 = 7;

3 
	~"©omic_»ad64.h
"

	@tests/samples/xdp/atomic_read64_8.c

1 cÚ¡ 
	gREAD_OFFSET
 = 8;

3 
	~"©omic_»ad64.h
"

	@tests/samples/xdp/atomic_read7.c

1 cÚ¡ 
	gREAD_OFFSET
 = 7;

3 
	~"©omic_»ad.h
"

	@tests/samples/xdp/atomic_read8.c

1 cÚ¡ 
	gREAD_OFFSET
 = 8;

3 
	~"©omic_»ad.h
"

	@tests/samples/xdp/atomic_short_val.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = 6,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 *
d©a
;

15 
__u32
 
key
 = 0;

17 
d©a
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

18 ià(!
d©a
)

19  
XDP_DROP
;

21 
d©a
 += 4;

22 
	`__sync_ãtch_ªd_add
((*)
d©a
, 1);

24  
XDP_PASS
;

25 
	}
}

27 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_stack.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
	$xdp_´og1
()

7 
v®ue
 = 0;

9 
	`__sync_ãtch_ªd_add
(&
v®ue
, 1);

11  
XDP_PASS
;

12 
	}
}

14 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_unalign4.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = 6,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 *
d©a
;

15 
__u32
 
key
 = 0;

17 
d©a
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

18 ià(!
d©a
)

19  
XDP_DROP
;

21 
d©a
 += 2;

22 
	`__sync_ãtch_ªd_add
((
__u32
 *)
d©a
, 1);

24  
XDP_PASS
;

25 
	}
}

27 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_unalign8.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = 12,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 *
d©a
;

15 
__u32
 
key
 = 0;

17 
d©a
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

18 ià(!
d©a
)

19  
XDP_DROP
;

21 
d©a
 += 4;

22 
	`__sync_ãtch_ªd_add
((*)
d©a
, 1);

24  
XDP_PASS
;

25 
	}
}

27 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_update_0.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u64
),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 
__u64
 
z”ov®
 = 0;

15 
__u32
 
key
 = 0;

16 
__u64
 *
v®ue
;

18 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

19 ià(!
v®ue
)

20 
	`bpf_m­_upd©e_–em
(&
rxút
, &
key
, &
z”ov®
, 
BPF_ANY
);

22 
	`__sync_ãtch_ªd_add
(
v®ue
, 1);

23  
XDP_PASS
;

24 
	}
}

26 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/atomic_update_non0.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u64
),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 
__u64
 
nÚz”ov®
 = 3;

15 
__u32
 
key
 = 0;

16 
__u64
 *
v®ue
;

18 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

19 ià(!
v®ue
)

20 
	`bpf_m­_upd©e_–em
(&
rxút
, &
key
, &
nÚz”ov®
, 
BPF_ANY
);

22 
	`__sync_ãtch_ªd_add
(
v®ue
, 1);

23  
XDP_PASS
;

24 
	}
}

26 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/dpa_read.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

4 *
d©a
;

5 *
d©a2
;

6 *
d©a4
;

7 *
d©a8
;

9 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 64 > (*)()
xdp
->
d©a_’d
)

11  
XDP_DROP
;

13 
d©a
 += 32;

14 
d©a2
 = (*)
d©a
;

15 
d©a4
 = (*)
d©a
;

16 
d©a8
 = (*)
d©a
;

18 ià(
d©a
[0] != 0x01 || data[1] != 0x02 ||

19 
d©a
[2] != 0x03 || data[3] != 0x04)

20  
XDP_DROP
;

22 ià(
d©a2
[0] != 0x0201 || data2[1] != 0x0403)

23  
XDP_DROP
;

25 ià(
d©a4
[0] != 0x04030201)

26  
XDP_DROP
;

28 ià(
d©a8
[0] != 0x0807060504030201)

29  
XDP_DROP
;

31 
d©a
 += 1;

32 
d©a2
 = (*)
d©a
;

33 
d©a4
 = (*)
d©a
;

34 
d©a8
 = (*)
d©a
;

36 ià(
d©a
[0] != 0x02 || data[1] != 0x03 ||

37 
d©a
[2] != 0x04 || data[3] != 0x05)

38  
XDP_DROP
;

40 ià(
d©a2
[0] != 0x0302 || data2[1] != 0x0504)

41  
XDP_DROP
;

43 ià(
d©a4
[0] != 0x05040302)

44  
XDP_DROP
;

46 ià(
d©a8
[0] != 0xbb08070605040302)

47  
XDP_DROP
;

49 
d©a
 -= 2;

50 
d©a2
 = (*)
d©a
;

51 
d©a4
 = (*)
d©a
;

52 
d©a8
 = (*)
d©a
;

54 ià(
d©a
[0] != 0xaa || data[1] != 0x01 ||

55 
d©a
[2] != 0x02 || data[3] != 0x03)

56  
XDP_DROP
;

58 ià(
d©a2
[0] != 0x01aa || data2[1] != 0x0302)

59  
XDP_DROP
;

61 ià(
d©a4
[0] != 0x030201aa)

62  
XDP_DROP
;

64 ià(
d©a8
[0] != 0x07060504030201aa)

65  
XDP_DROP
;

67  
XDP_PASS
;

68 
	}
}

	@tests/samples/xdp/dpa_var_off_11bit.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
)

5 *
d©a
, *
Ãw_ba£
;

6 
v¬_off
;

8 
d©a
 = (*)()
xdp
->data;

9 ià(
d©a
 + 64 > (*)()
xdp
->
d©a_’d
)

10  
XDP_DROP
;

12 
v¬_off
 = *(*)&
d©a
[32];

13 
v¬_off
 &= 0x7ff;

14 
Ãw_ba£
 = 
d©a
 + 
v¬_off
;

15 ià(
Ãw_ba£
 + 32 > (*)()
xdp
->
d©a_’d
)

16  
XDP_DROP
;

18 ià(
Ãw_ba£
[0] != 0x01)

19  
XDP_DROP
;

21  
XDP_PASS
;

22 
	}
}

	@tests/samples/xdp/dpa_var_off_9bit.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
)

5 *
d©a
, *
Ãw_ba£
;

6 
v¬_off
;

8 
d©a
 = (*)()
xdp
->data;

9 ià(
d©a
 + 64 > (*)()
xdp
->
d©a_’d
)

10  
XDP_DROP
;

12 
v¬_off
 = *(*)&
d©a
[32];

13 
v¬_off
 &= 0x1ff;

14 
Ãw_ba£
 = 
d©a
 + 
v¬_off
;

15 ià(
Ãw_ba£
 + 32 > (*)()
xdp
->
d©a_’d
)

16  
XDP_DROP
;

18 ià(
Ãw_ba£
[0] != 0x01)

19  
XDP_DROP
;

21  
XDP_PASS
;

22 
	}
}

	@tests/samples/xdp/dpa_write.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

4 *
d©a
;

5 *
d©a2
;

6 *
d©a4
;

7 *
d©a8
;

9 
d©a
 = (*)()
xdp
->data;

10 ià(
d©a
 + 64 > (*)()
xdp
->
d©a_’d
)

11  
XDP_DROP
;

13 
d©a
 += 32;

14 
d©a2
 = (*)
d©a
;

15 
d©a4
 = (*)
d©a
;

16 
d©a8
 = (*)
d©a
;

18 ià(
d©a8
[0] != 0x0807060504030201)

19  
XDP_DROP
;

21 
d©a8
[0] = 0xffffffffffffffff;

22 
d©a4
[0] = 0xeeeeeeee;

23 
d©a2
[1] = 0xdddd;

24 
d©a
[1] = data[8];

27 
d©a
 += 9;

28 
d©a2
 = (*)
d©a
;

29 
d©a4
 = (*)
d©a
;

30 
d©a8
 = (*)
d©a
;

32 
d©a8
[0] = 0xffffffffffffffff;

33 
d©a4
[0] = 0xeeeeeeee;

34 
d©a2
[1] = 0xdddd;

35 
d©a
[1] = data[8];

37  
XDP_PASS
;

38 
	}
}

	@tests/samples/xdp/drop.c

1 
	~<lšux/bpf.h
>

3 
xdp_´og1
(
xdp_md
 *
ùx
 
__©Œibu‹__
((
unu£d
))) {

4  
	gXDP_DROP
;

	@tests/samples/xdp/function_call_4_flat.c

1 
	~<lšux/bpf.h
>

3 
__©Œibu‹__
((
nošlše
))

4 
	$g»©”_Ü_equ®
(*
a
, *
b
) {

5  (
a
 >ð
b
);

6 
	}
}

8 
__©Œibu‹__
((
nošlše
))

9 
	$low”_thª
(*
a
, *
b
) {

10  (
a
 < 
b
);

11 
	}
}

13 
__©Œibu‹__
((
nošlše
))

14 
	$sub_ªd_add
(*
a
, *
b
, *
c
) {

15  (
b
 - 
a
 + (cÚ¡ )*
c
);

16 
	}
}

20 
xdp_´og1
(
xdp_md
 *
xdp
 
__©Œibu‹__
((
unu£d
))) {

21 *
	gd©a
, *
	gd©a_’d
;

22 
	gfoo
[32], 
	gi
;

24 
	gd©a
 = (*)()
xdp
->
d©a
;

25 
	gd©a_’d
 = (*)()
xdp
->
d©a_’d
;

27 ià(
	gd©a
 + 1 > 
	gd©a_’d
)

28  
	gXDP_DROP
;

31 ià(
low”_thª
(
d©a_’d
, 
d©a
))

32  
	gXDP_DROP
;

35 ià(
g»©”_Ü_equ®
(
d©a
, 
d©a_’d
))

36 
	gd©a
 = 
d©a_’d
;

37 #´agm¨
þªg
 
loÝ
 
uÄÞl
(
fuÎ
)

38 
	gi
 = 0; i < 32; i++)

39 
	gfoo
[
i
] = i;

41 ià(
sub_ªd_add
(
d©a
, 
d©a_’d
, 
foo
))

42  
	gXDP_PASS
;

45 ià(
g»©”_Ü_equ®
(
d©a_’d
, 
d©a
))

46  
	gXDP_PASS
;

48  
	gXDP_DROP
;

	@tests/samples/xdp/function_call_8_nested.c

1 
	~<lšux/bpf.h
>

3 
	#__nošlše__
 
	`__©Œibu‹__
((
nošlše
))

	)

5 
__nošlše__
 
	$func_a
(
x
) {

6  
x
 + 1;

7 
	}
}

9 
__nošlše__
 
	$func_b
(
x
) {

10  
	`func_a
(
x
 + 2);

11 
	}
}

13 
__nošlše__
 
	$func_c
(
x
) {

14  
	`func_b
(
x
 + 3);

15 
	}
}

17 
__nošlše__
 
	$func_d
(
x
) {

18  
	`func_c
(
x
 + 4);

19 
	}
}

21 
__nošlše__
 
	$func_e
(
x
) {

22  
	`func_d
(
x
 + 5);

23 
	}
}

25 
__nošlše__
 
	$func_f
(
x
) {

26  
	`func_e
(
x
 + 6);

27 
	}
}

29 
__nošlše__
 
	$func_g
(
x
) {

30  
	`func_f
(
x
 + 7);

31 
	}
}

35 
xdp_´og1
(
xdp_md
 *
xdp
 
__©Œibu‹__
((
unu£d
))) {

36 *
	gd©a
, *
	gd©a_’d
;

38 
	gd©a
 = (*)()
xdp
->
d©a
;

39 
	gd©a_’d
 = (*)()
xdp
->
d©a_’d
;

41 ià(
	gd©a
 + 39 + 1 > 
	gd©a_’d
)

42  
	gXDP_DROP
;

45 ià(
func_g
(*(
d©a
 + 14)) == 0xaa + 7 + 6 + 5 + 4 + 3 + 2 + 1)

46  
XDP_PASS
;

48  
	gXDP_DROP
;

	@tests/samples/xdp/function_call_helpers_adj_head.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_h–³rs.h
"

4 
do_adju¡_h—d
(
xdp_md
 *
xdp
, 
d–
, *
d©a
);

6 
	$xdp_´og1
(
xdp_md
 *
xdp
)

8 *
d©a_’d
 = (*)()
xdp
->data_end;

9 *
d©a
 = (*)()
xdp
->data;

10 
Ãw_Ën
, 
Þd_Ën
 = 
d©a_’d
 - 
d©a
;

12 ià(
d©a
 + 1 > 
d©a_’d
)

13  
XDP_ABORTED
;

15 ià(
	`do_adju¡_h—d
(
xdp
, -16, 
d©a
))

16  
XDP_ABORTED
;

18 
d©a_’d
 = (*)()
xdp
->data_end;

19 
d©a
 = (*)()
xdp
->data;

20 
Ãw_Ën
 = 
d©a_’d
 - 
d©a
;

21 ià(
Ãw_Ën
 !ð
Þd_Ën
 + 16)

22  
XDP_ABORTED
;

23 ià(
d©a
 + 1 > 
d©a_’d
)

24  
XDP_ABORTED
;

26 ià(
	`do_adju¡_h—d
(
xdp
, 16, 
d©a
))

27  
XDP_ABORTED
;

29 
d©a_’d
 = (*)()
xdp
->data_end;

30 
d©a
 = (*)()
xdp
->data;

31 
Ãw_Ën
 = 
d©a_’d
 - 
d©a
;

32 ià(
Ãw_Ën
 !ð
Þd_Ën
)

33  
XDP_ABORTED
;

35 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, -16) || bpf_xdp_adjust_head(xdp, 16))

36  
XDP_ABORTED
;

38  
XDP_PASS
;

39 
	}
}

42 
__©Œibu‹__
 ((
nošlše
))

43 
	$do_adju¡_h—d
(
xdp_md
 *
xdp
, 
d–
, *
d©a
)

45 ià(!
d©a
 || *data == 0xef)

48 ià(
	`bpf_xdp_adju¡_h—d
(
xdp
, 
d–
))

52 
	}
}

	@tests/samples/xdp/function_call_stack_large.c

1 
	~<lšux/bpf.h
>

3 
__©Œibu‹__
((
nošlše
))

4 
	$add4
(*
c
) {

5 
foo
[64];

6 
i
, 
»s
 = 0;

8 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

9 
i
 = 0; i < 64; i++)

10 
foo
[
i
] = ()(i % 8);

12 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

13 
i
 = 0; i < 64 / 2; i += 8)

14 ià(
foo
[
i
] + foo[64 - 1 - i] == 7)

15 
»s
++;

17  ()(
»s
 + *
c
);

18 
	}
}

22 
xdp_´og1
(
xdp_md
 *
xdp
 
__©Œibu‹__
((
unu£d
))) {

23 *
	gd©a
, *
	gd©a_’d
;

25 
	gd©a
 = (*)()
xdp
->
d©a
;

26 
	gd©a_’d
 = (*)()
xdp
->
d©a_’d
;

28 ià(
	gd©a
 + 1 > 
	gd©a_’d
)

29  
	gXDP_DROP
;

32 ià(
add4
(
d©a
) == *data + 4)

33  
XDP_PASS
;

35  
	gXDP_DROP
;

	@tests/samples/xdp/imm_relo.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1,

12 
	$´og
()

14 vÞ©ž
»t
;

15 
__u32
 
šdex
 = 0;

16 *
v®ue
;

17 
i
;

19 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

20 
i
 = 0; i < 256; i++)

21 
»t
 = 
XDP_ABORTED
;

23 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

24 
»t
 = 
XDP_PASS
;

25 ià(
»t
 !ð
XDP_PASS
) {

26 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

27 
i
 = 0; i < 256; i++)

28 
»t
 = 
XDP_ABORTED
;

30 ià(
v®ue
)

31  
XDP_TX
;

33  
»t
;

34 
	}
}

	@tests/samples/xdp/imm_relo2.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1,

12 
	$´og
()

14 vÞ©ž
»t
;

15 
__u32
 
šdex
 = 0;

16 *
v®ue
;

17 
i
;

19 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

20 
i
 = 0; i < 256; i++)

21 
»t
 = 
XDP_ABORTED
;

23 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

24 ià(
v®ue
)

25  
XDP_TX
;

27 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

28 
i
 = 0; i < 311; i++)

29 
»t
 = 
XDP_ABORTED
;

31 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

32 
»t
 = 
XDP_PASS
;

33 ià(
»t
 !ð
XDP_PASS
) {

34 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

35 
i
 = 0; i < 256; i++)

36 
»t
 = 
XDP_ABORTED
;

38 ià(
v®ue
)

39  
XDP_TX
;

41  
»t
;

42 
	}
}

	@tests/samples/xdp/map_array1.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1,

12 
	$´og
()

14 
__u32
 
šdex
 = 0;

15 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21  *
v®ue
;

22 
	}
}

	@tests/samples/xdp/map_array256.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 256,

12 
	$´og
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
šdex
;

16 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

23 
d©a
 += 14;

24 
šdex
 = *
d©a
;

26 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

27 ià(!
v®ue
)

28  
XDP_DROP
;

30  *
v®ue
;

31 
	}
}

	@tests/samples/xdp/map_array256_256.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 256,

12 
bpf_m­_def
 
SEC
("m­s"è
	g¬r2
 = {

13 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

14 .
	gkey_size
 = (
__u32
),

15 .
	gv®ue_size
 = (),

16 .
	gmax_’Œ›s
 = 256,

19 
	$´og
(
xdp_md
 *
xdp
)

21 *
d©a
;

22 
__u32
 
šdex
[2];

23 *
v®ue
;

25 
d©a
 = (*)()
xdp
->data;

26 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

27  
XDP_ABORTED
;

30 
d©a
 += 14;

31 
šdex
[0] = *
d©a
;

33 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
[0]);

34 ià(!
v®ue
)

35  
XDP_DROP
;

36 ià(*
v®ue
 !ð
XDP_PASS
)

37  *
v®ue
;

39 
d©a
++;

40 
šdex
[1] = *
d©a
;

42 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r2
, &
šdex
[1]);

43 ià(!
v®ue
)

44  
XDP_DROP
;

46  *
v®ue
;

47 
	}
}

	@tests/samples/xdp/map_array_256_varying_val_size.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
	sm­v®2
 {

6 
__u32
 
	mv®ue0
;

7 
__u32
 
	mv®ue1
;

10 
	sm­v®4
 {

11 
__u32
 
	mv®ue0
;

12 
__u32
 
	mv®ue1
;

13 
__u32
 
	mv®ue2
;

14 
__u32
 
	mv®ue3
;

17 
	sm­v®8
 {

18 
__u32
 
	mv®ue0
;

19 
__u32
 
	mv®ue1
;

20 
__u32
 
	mv®ue2
;

21 
__u32
 
	mv®ue3
;

22 
__u32
 
	mv®ue4
;

23 
__u32
 
	mv®ue5
;

24 
__u32
 
	mv®ue6
;

25 
__u32
 
	mv®ue7
;

28 
	sm­v®12
 {

29 
__u32
 
	mv®ue0
;

30 
__u32
 
	mv®ue1
;

31 
__u32
 
	mv®ue2
;

32 
__u32
 
	mv®ue3
;

33 
__u32
 
	mv®ue4
;

34 
__u32
 
	mv®ue5
;

35 
__u32
 
	mv®ue6
;

36 
__u32
 
	mv®ue7
;

37 
__u32
 
	mv®ue8
;

38 
__u32
 
	mv®ue9
;

39 
__u32
 
	mv®ueA
;

40 
__u32
 
	mv®ueB
;

43 
	sm­v®14
 {

44 
__u32
 
	mv®ue0
;

45 
__u32
 
	mv®ue1
;

46 
__u32
 
	mv®ue2
;

47 
__u32
 
	mv®ue3
;

48 
__u32
 
	mv®ue4
;

49 
__u32
 
	mv®ue5
;

50 
__u32
 
	mv®ue6
;

51 
__u32
 
	mv®ue7
;

52 
__u32
 
	mv®ue8
;

53 
__u32
 
	mv®ue9
;

54 
__u32
 
	mv®ueA
;

55 
__u32
 
	mv®ueB
;

56 
__u32
 
	mv®ueC
;

57 
__u32
 
	mv®ueD
;

60 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

61 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

62 .
	gkey_size
 = (
__u32
),

63 .
	gv®ue_size
 = (
m­v®2
),

64 .
	gmax_’Œ›s
 = 256,

67 
bpf_m­_def
 
SEC
("m­s"è
	g¬r1
 = {

68 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

69 .
	gkey_size
 = (
__u32
),

70 .
	gv®ue_size
 = (
m­v®4
),

71 .
	gmax_’Œ›s
 = 256,

74 
bpf_m­_def
 
SEC
("m­s"è
	g¬r2
 = {

75 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

76 .
	gkey_size
 = (
__u32
),

77 .
	gv®ue_size
 = (
m­v®8
),

78 .
	gmax_’Œ›s
 = 256,

81 
bpf_m­_def
 
SEC
("m­s"è
	g¬r3
 = {

82 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

83 .
	gkey_size
 = (
__u32
),

84 .
	gv®ue_size
 = (
m­v®12
),

85 .
	gmax_’Œ›s
 = 256,

88 
bpf_m­_def
 
SEC
("m­s"è
	g¬r4
 = {

89 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

90 .
	gkey_size
 = (
__u32
),

91 .
	gv®ue_size
 = (
m­v®14
),

92 .
	gmax_’Œ›s
 = 256,

95 
	$´og
(
xdp_md
 *
xdp
)

97 *
d©a
;

98 
__u32
 
šdex
;

99 *
v®ue
;

101 
d©a
 = (*)()
xdp
->data;

102 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

103  
XDP_ABORTED
;

106 
d©a
 += 14;

107 
šdex
 = *
d©a
;

109 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

110 ià(!
v®ue
)

111  
XDP_DROP
;

113 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r1
, &
šdex
);

114 ià(!
v®ue
)

115  
XDP_DROP
;

117 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r2
, &
šdex
);

118 ià(!
v®ue
)

119  
XDP_DROP
;

121 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r3
, &
šdex
);

122 ià(!
v®ue
)

123  
XDP_DROP
;

125 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r4
, &
šdex
);

126 ià(!
v®ue
)

127  
XDP_DROP
;

129  *
v®ue
;

130 
	}
}

	@tests/samples/xdp/map_array_u2l.c

1 
	#_MAP_TYPE_
 
BPF_MAP_TYPE_ARRAY


	)

3 
	~"m­_u2l_c
"

	@tests/samples/xdp/map_array_update_delete.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/”ºo.h
>

3 
	~"../bpf/bpf_­i.h
"

4 
	~"../bpf/bpf_h–³rs.h
"

6 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

7 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

8 .
	gkey_size
 = (
__u32
),

9 .
	gv®ue_size
 = (),

10 .
	gmax_’Œ›s
 = 100,

13 
	$´og
(
xdp_md
 *
xdp
)

15 *
d©a
;

16 
__u32
 *
pkt_±r
;

17 
__u32
 
šdex
;

18 
v®
;

19 *
v®ue
;

21 
d©a
 = (*)()
xdp
->data;

22 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

23  
XDP_ABORTED
;

25 
pkt_±r
 = (
__u32
 *)(
d©a
 + 14);

26 
v®
 = 
šdex
 = *
pkt_±r
;

29 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

30 ià(!
v®ue
)

31  
XDP_DROP
;

32 ià(
	`bpf_m­_upd©e_–em
(&
¬r
, &
šdex
, &
v®
, 
BPF_ANY
))

33  
XDP_DROP
;

34 ià(
	`bpf_m­_upd©e_–em
(&
¬r
, &
šdex
, &
v®
, 
BPF_NOEXIST
è!ð-
EEXIST
)

35  
XDP_DROP
;

37 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

38 ià(!
v®ue
)

39  
XDP_DROP
;

40 ià(*
v®ue
 !ð
šdex
)

41  
XDP_ABORTED
;

43 ià(
	`bpf_m­_d–‘e_–em
(&
¬r
, &
šdex
è!ð-
EINVAL
)

44  
XDP_DROP
;

45 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

46 ià(!
v®ue
)

47  
XDP_DROP
;

49 *
pkt_±r
 = 0;

50  
XDP_PASS
;

51 
	}
}

	@tests/samples/xdp/map_atomic.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 
__u32
 
key
 = 0;

15 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21 
	`__sync_ãtch_ªd_add
(
v®ue
, 1);

23  
XDP_PASS
;

24 
	}
}

26 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic32.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 
__u32
 
key
 = 0;

15 
__u32
 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21 
	`__sync_ãtch_ªd_add
(
v®ue
, 1);

23  
XDP_PASS
;

24 
	}
}

26 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_65k.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 
__u32
 
key
 = 0;

15 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21 
	`__sync_ãtch_ªd_add
(
v®ue
, 0x10000);

23  
XDP_PASS
;

24 
	}
}

26 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_65k32.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
()

14 
__u32
 
key
 = 0;

15 
__u32
 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21 
	`__sync_ãtch_ªd_add
(
v®ue
, 0x10000);

23  
XDP_PASS
;

24 
	}
}

26 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_adj.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = () * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 *
±r
;

16 
__u32
 
key
 = 0;

17 *
v®ue
;

19 
d©a
 = (*)()
xdp
->data;

20 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

21  
XDP_ABORTED
;

23 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

24 ià(!
v®ue
)

25  
XDP_DROP
;

27 
±r
 = (*)(
d©a
 + 40);

28 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, *
±r
);

30  
XDP_PASS
;

31 
	}
}

33 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_adj32.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
) * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0, *
±r
;

16 
__u32
 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

23 ià(!
v®ue
)

24  
XDP_DROP
;

26 
±r
 = (*)(
d©a
 + 40);

27 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, *
±r
);

29  
XDP_PASS
;

30 
	}
}

32 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_adj_short.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = () * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 *
±r
;

16 
__u32
 
key
 = 0;

17 *
v®ue
;

19 
d©a
 = (*)()
xdp
->data;

20 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

21  
XDP_ABORTED
;

23 ià(
d©a
[12] != 0x12 || data[13] != 0x22)

24  
XDP_DROP
;

26 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

27 ià(!
v®ue
)

28  
XDP_DROP
;

30 
±r
 = (*)(
d©a
 + 40);

31 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, *
±r
 >> 8);

33  
XDP_PASS
;

34 
	}
}

36 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_adj_short32.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
) * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0, *
±r
;

16 
__u32
 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 ià(
d©a
[12] != 0x12 || data[13] != 0x22)

23  
XDP_DROP
;

25 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

26 ià(!
v®ue
)

27  
XDP_DROP
;

29 
±r
 = (*)(
d©a
 + 40);

30 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, *
±r
 >> 8);

32  
XDP_PASS
;

33 
	}
}

35 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_data.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0;

16 
__u32
 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

23 ià(!
v®ue
)

24  
XDP_DROP
;

26 
	`__sync_ãtch_ªd_add
(
v®ue
, *(
d©a
 + 40));

28  
XDP_PASS
;

29 
	}
}

31 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_data32.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0;

16 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

23 ià(!
v®ue
)

24  
XDP_DROP
;

26 
	`__sync_ãtch_ªd_add
(
v®ue
, *(
d©a
 + 40));

28  
XDP_PASS
;

29 
	}
}

31 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_data32_32.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0, *
±r
;

16 
__u32
 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 ià(
d©a
[12] != 0x12 || data[13] != 0x22)

23  
XDP_DROP
;

25 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

26 ià(!
v®ue
)

27  
XDP_DROP
;

29 
±r
 = (*)(
d©a
 + 40);

30 
	`__sync_ãtch_ªd_add
(
v®ue
, *
±r
 >> 8);

32  
XDP_PASS
;

33 
	}
}

35 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_data32_64.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 *
±r
;

16 
__u32
 
key
 = 0;

17 *
v®ue
;

19 
d©a
 = (*)()
xdp
->data;

20 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

21  
XDP_ABORTED
;

23 ià(
d©a
[12] != 0x12 || data[13] != 0x22)

24  
XDP_DROP
;

26 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

27 ià(!
v®ue
)

28  
XDP_DROP
;

30 
±r
 = (*)(
d©a
 + 40);

31 
	`__sync_ãtch_ªd_add
(
v®ue
, *
±r
 >> 8);

33  
XDP_PASS
;

34 
	}
}

36 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_multi32.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
) * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
key
 = 0, *
±r
;

16 
__u32
 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

23 ià(!
v®ue
)

24  
XDP_DROP
;

26 
±r
 = (*)(
d©a
 + 40);

27 
	`__sync_ãtch_ªd_add
(
v®ue
 + 0, 1);

28 
	`__sync_ãtch_ªd_add
(
v®ue
 + 0, 1);

29 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, 1);

30 
	`__sync_ãtch_ªd_add
(
v®ue
 + 2, *
±r
 >> 8);

31 
	`__sync_ãtch_ªd_add
(
v®ue
 + 2, *
±r
 >> 8);

33  
XDP_PASS
;

34 
	}
}

36 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_atomic_multi64.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = () * 3,

9 .
	gmax_’Œ›s
 = 1,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 *
±r
;

16 
__u32
 
key
 = 0;

17 *
v®ue
;

19 
d©a
 = (*)()
xdp
->data;

20 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

21  
XDP_ABORTED
;

23 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
rxút
, &
key
);

24 ià(!
v®ue
)

25  
XDP_DROP
;

27 
±r
 = (*)(
d©a
 + 40);

28 
	`__sync_ãtch_ªd_add
(
v®ue
 + 0, 1);

29 
	`__sync_ãtch_ªd_add
(
v®ue
 + 0, 1);

30 
	`__sync_ãtch_ªd_add
(
v®ue
 + 1, 1);

31 
	`__sync_ãtch_ªd_add
(
v®ue
 + 2, *
±r
 >> 8);

32 
	`__sync_ãtch_ªd_add
(
v®ue
 + 2, *
±r
 >> 8);

34  
XDP_PASS
;

35 
	}
}

37 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/map_bad_elem.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = 33,

8 .
	gv®ue_size
 = 33,

9 .
	gmax_’Œ›s
 = 1,

12 
	$´og
()

14 
__u32
 
šdex
[16] = {};

15 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21  *
v®ue
;

22 
	}
}

	@tests/samples/xdp/map_bad_flags.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = 4,

8 .
	gv®ue_size
 = 8,

9 .
	gmax_’Œ›s
 = 1,

10 .
	gm­_æags
 = 
BPF_F_NO_PREALLOC
,

13 
	$´og
()

15 
__u32
 
šdex
 = 0;

16 *
v®ue
;

18 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

19 ià(!
v®ue
)

20  
XDP_DROP
;

22  *
v®ue
;

23 
	}
}

	@tests/samples/xdp/map_bad_key.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = 58,

8 .
	gv®ue_size
 = 1,

9 .
	gmax_’Œ›s
 = 1,

12 
	$´og
()

14 
__u32
 
šdex
[16] = {};

15 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21  *
v®ue
;

22 
	}
}

	@tests/samples/xdp/map_bad_key_array.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = 8,

8 .
	gv®ue_size
 = 8,

9 .
	gmax_’Œ›s
 = 1,

12 
	$´og
()

14 
__u32
 
šdex
 = 0;

15 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21  *
v®ue
;

22 
	}
}

	@tests/samples/xdp/map_bad_numa.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = 4,

8 .
	gv®ue_size
 = 8,

9 .
	gmax_’Œ›s
 = 1,

10 .
	gm­_æags
 = 
BPF_F_NUMA_NODE
,

13 
	$´og
()

15 
__u32
 
šdex
 = 0;

16 *
v®ue
;

18 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

19 ià(!
v®ue
)

20  
XDP_DROP
;

22  *
v®ue
;

23 
	}
}

	@tests/samples/xdp/map_bad_value.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = 1,

8 .
	gv®ue_size
 = 58,

9 .
	gmax_’Œ›s
 = 1,

12 
	$´og
()

14 
__u32
 
šdex
 = 0;

15 *
v®ue
;

17 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

18 ià(!
v®ue
)

19  
XDP_DROP
;

21  *
v®ue
;

22 
	}
}

	@tests/samples/xdp/map_htab1k_array1k.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 1000,

12 
bpf_m­_def
 
SEC
("m­s"è
	ghb
 = {

13 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

14 .
	gkey_size
 = (
__u32
),

15 .
	gv®ue_size
 = (),

16 .
	gmax_’Œ›s
 = 1000,

19 
	$´og
(
xdp_md
 *
xdp
)

21 *
d©a
;

22 
__u32
 
šdex
[2];

23 *
v®ue
;

25 
d©a
 = (*)()
xdp
->data;

26 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

27  
XDP_ABORTED
;

30 
d©a
 += 14;

31 
šdex
[0] = *
d©a
++;

32 
šdex
[1] = *
d©a
++;

34 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
[0]);

35 ià(!
v®ue
)

36  
XDP_DROP
;

37 ià(*
v®ue
 !ð
XDP_PASS
)

38  *
v®ue
;

40 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
hb
, &
šdex
[1]);

41 ià(!
v®ue
)

42  
XDP_DROP
;

44  *
v®ue
;

45 
	}
}

	@tests/samples/xdp/map_htab256.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 256,

12 
	$´og
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
šdex
;

16 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

23 
d©a
 += 14;

24 
šdex
 = *
d©a
;

26 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

27 ià(!
v®ue
)

28  
XDP_DROP
;

30  *
v®ue
;

31 
	}
}

	@tests/samples/xdp/map_htab256_256.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 256,

12 
bpf_m­_def
 
SEC
("m­s"è
	g¬r2
 = {

13 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

14 .
	gkey_size
 = (
__u32
),

15 .
	gv®ue_size
 = (),

16 .
	gmax_’Œ›s
 = 256,

19 
	$´og
(
xdp_md
 *
xdp
)

21 *
d©a
;

22 
__u32
 
šdex
[2];

23 *
v®ue
;

25 
d©a
 = (*)()
xdp
->data;

26 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

27  
XDP_ABORTED
;

30 
d©a
 += 14;

31 
šdex
[0] = *
d©a
;

33 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
[0]);

34 ià(!
v®ue
)

35  
XDP_DROP
;

36 ià(*
v®ue
 !ð
XDP_PASS
)

37  *
v®ue
;

39 
d©a
++;

40 
šdex
[1] = *
d©a
;

42 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r2
, &
šdex
[1]);

43 ià(!
v®ue
)

44  
XDP_DROP
;

46  *
v®ue
;

47 
	}
}

	@tests/samples/xdp/map_htab256k.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	ghb
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

7 .
	gkey_size
 = 6,

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = (1 << 18),

12 
	$´og
(
xdp_md
 *
xdp
)

14 
key
[6];

15 *
d©a
;

16 *
v®ue
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

23 
d©a
 += 14;

24 
	`memýy
(
key
, 
d©a
, 6);

26 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
hb
, 
key
);

27 ià(!
v®ue
)

28  
XDP_DROP
;

30  *
v®ue
;

31 
	}
}

	@tests/samples/xdp/map_htab2x16.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
	#A
(
_Çme_
) \

6 
bpf_m­_def
 
	`SEC
("m­s"è
_Çme_
 = { \

7 .
ty³
 = 
BPF_MAP_TYPE_HASH
, \

8 .
key_size
 = (
__u32
), \

9 .
v®ue_size
 = (), \

10 .
max_’Œ›s
 = 2, \

11 }

	)

13 
A
(
¬r0
);

14 
A
(
¬r1
);

15 
A
(
¬r2
);

16 
A
(
¬r3
);

17 
A
(
¬r4
);

18 
A
(
¬r5
);

19 
A
(
¬r6
);

20 
A
(
¬r7
);

21 
A
(
¬r8
);

22 
A
(
¬r9
);

23 
A
(
¬rA
);

24 
A
(
¬rB
);

25 
A
(
¬rC
);

26 
A
(
¬rD
);

27 
A
(
¬rE
);

28 
A
(
¬rF
);

30 
	$´og
()

32 
__u32
 
šdex
 = 0;

33 *
v®ue
;

35 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r0
, &
šdex
);

36 ià(!
v®ue
)

37  
XDP_DROP
;

38 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r1
, &
šdex
);

39 ià(!
v®ue
)

40  
XDP_DROP
;

41 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r2
, &
šdex
);

42 ià(!
v®ue
)

43  
XDP_DROP
;

44 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r3
, &
šdex
);

45 ià(!
v®ue
)

46  
XDP_DROP
;

47 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r4
, &
šdex
);

48 ià(!
v®ue
)

49  
XDP_DROP
;

50 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r5
, &
šdex
);

51 ià(!
v®ue
)

52  
XDP_DROP
;

53 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r6
, &
šdex
);

54 ià(!
v®ue
)

55  
XDP_DROP
;

56 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r7
, &
šdex
);

57 ià(!
v®ue
)

58  
XDP_DROP
;

59 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r8
, &
šdex
);

60 ià(!
v®ue
)

61  
XDP_DROP
;

62 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r9
, &
šdex
);

63 ià(!
v®ue
)

64  
XDP_DROP
;

65 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬rA
, &
šdex
);

66 ià(!
v®ue
)

67  
XDP_DROP
;

68 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬rB
, &
šdex
);

69 ià(!
v®ue
)

70  
XDP_DROP
;

71 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬rC
, &
šdex
);

72 ià(!
v®ue
)

73  
XDP_DROP
;

74 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬rD
, &
šdex
);

75 ià(!
v®ue
)

76  
XDP_DROP
;

77 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬rE
, &
šdex
);

78 ià(!
v®ue
)

79  
XDP_DROP
;

80 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬rF
, &
šdex
);

81 ià(!
v®ue
)

82  
XDP_DROP
;

84  *
v®ue
;

85 
	}
}

	@tests/samples/xdp/map_htab_u2l.c

1 
	#_MAP_TYPE_
 
BPF_MAP_TYPE_HASH


	)

3 
	~"m­_u2l_c
"

	@tests/samples/xdp/map_htab_update_delete.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/”ºo.h
>

3 
	~"../bpf/bpf_­i.h
"

4 
	~"../bpf/bpf_h–³rs.h
"

6 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

7 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

8 .
	gkey_size
 = (
__u32
),

9 .
	gv®ue_size
 = (),

10 .
	gmax_’Œ›s
 = 100,

13 
	$´og
(
xdp_md
 *
xdp
)

15 *
d©a
;

16 
__u32
 *
pkt_±r
;

17 
__u32
 
šdex
;

18 
v®
;

19 *
v®ue
;

21 
d©a
 = (*)()
xdp
->data;

22 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

23  
XDP_ABORTED
;

25 
pkt_±r
 = (
__u32
 *)(
d©a
 + 14);

26 
v®
 = 
šdex
 = *
pkt_±r
;

29 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

30 ià(
v®ue
)

31  
XDP_ABORTED
;

33 ià(
	`bpf_m­_upd©e_–em
(&
¬r
, &
šdex
, &
v®
, 
BPF_EXIST
è!ð-
ENOENT
)

34  
XDP_DROP
;

35 ià(
	`bpf_m­_upd©e_–em
(&
¬r
, &
šdex
, &
v®
, 
BPF_ANY
))

36  
XDP_DROP
;

37 ià(
	`bpf_m­_upd©e_–em
(&
¬r
, &
šdex
, &
v®
, 
BPF_NOEXIST
è!ð-
EEXIST
)

38  
XDP_DROP
;

40 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

41 ià(!
v®ue
)

42  
XDP_DROP
;

43 ià(*
v®ue
 !ð
šdex
)

44  
XDP_ABORTED
;

46 ià(
	`bpf_m­_d–‘e_–em
(&
¬r
, &
šdex
))

47  
XDP_DROP
;

48 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
šdex
);

49 ià(
v®ue
)

50  
XDP_DROP
;

51 ià(
	`bpf_m­_d–‘e_–em
(&
¬r
, &
šdex
è!ð-
ENOENT
)

52  
XDP_DROP
;

54 *
pkt_±r
 = 0;

55  
XDP_PASS
;

56 
	}
}

	@tests/samples/xdp/map_shared_call.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r1
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 128,

12 
bpf_m­_def
 
SEC
("m­s"è
	g¬r2
 = {

13 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

14 .
	gkey_size
 = (
__u32
),

15 .
	gv®ue_size
 = (),

16 .
	gmax_’Œ›s
 = 256,

19 
	$´og
(
xdp_md
 *
xdp
)

21 
bpf_m­_def
 *
m­
;

22 *
d©a
;

23 
__u32
 
šdex
;

24 *
v®ue
;

26 
d©a
 = (*)()
xdp
->data;

27 ià(
d©a
 + 32 > (*)()
xdp
->
d©a_’d
)

28  
XDP_ABORTED
;

31 
d©a
 += 14;

32 
šdex
 = *
d©a
;

34 
m­
 = 
d©a
[1] ? &
¬r2
 : &
¬r1
;

36 
v®ue
 = 
	`bpf_m­_lookup_–em
(
m­
, &
šdex
);

37 ià(!
v®ue
)

38  
XDP_DROP
;

40  *
v®ue
;

41 
	}
}

	@tests/samples/xdp/opt_mem_builtins.c

2 
	~<lšux/bpf.h
>

4 
	$xdp_´og1
(
xdp_md
 *
xdp
)

6 *
shÜt_d©a
;

7 *
št_d©a
;

8 *
d©a
;

9 
t
;

11 
d©a
 = (*)()
xdp
->data;

12 ià(
d©a
 + 94 > (*)()
xdp
->
d©a_’d
)

13  
XDP_ABORTED
;

15 ià(*(*)(
d©a
 + 12) != 0x2212)

16  
XDP_DROP
;

18 
t
 = *(*)(
d©a
 + 0);

19 *(*)(
d©a
 + 0) = *(*)(data + 6);

20 *(*)(
d©a
 + 6èð
t
;

22 
t
 = *(*)(
d©a
 + 4);

23 *(*)(
d©a
 + 4) = *(*)(data + 10);

24 *(*)(
d©a
 + 10èð
t
;

27 *(*)(
d©a
 + 12) = 0x3412;

29 
	`__bužtš_memýy
(
d©a
 + 14, data + 22, 8);

31 
shÜt_d©a
 = (*)(
d©a
 + 22);

32 
	`__bužtš_memmove
(
shÜt_d©a
, short_data + 1, 16);

34 
št_d©a
 = (*)(
d©a
 + 40);

35 
	`__bužtš_memmove
(
št_d©a
, int_data + 1, 32);

37  
XDP_TX
;

38 
	}
}

	@tests/samples/xdp/oversize.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
	$xdp_´og1
()

7 vÞ©ž
__u32
 
key
 = 0;

8 
i
;

10 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

11 
i
 = 0; i < 2000; i++)

12 ià(
key
)

13  
XDP_DROP
;

15  
XDP_PASS
;

16 
	}
}

18 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/pass.c

1 
	~<lšux/bpf.h
>

3 
xdp_´og1
(
xdp_md
 *
ùx
 
__©Œibu‹__
((
unu£d
))) {

4  
	gXDP_PASS
;

	@tests/samples/xdp/perf_event_output_1s.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
__u32
 
d©a
 = 0x01020304;

16 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0x1ffffffffULL, &
d©a
, 1);

18  
XDP_PASS
;

19 
	}
}

21 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_both.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
	sS
 {

15 
pid
;

16 
cook›
;

17 
t
[2];

18 } 
d©a
;

20 
d©a
.
pid
 = 0;

21 
d©a
.
cook›
 = 0x12345678;

22 
d©a
.
t
[0] = 1;

23 
d©a
.
t
[1] = 7;

25 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0x20ffffffffULL, &
d©a
, (data));

27  
XDP_PASS
;

28 
	}
}

30 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_cpu0.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
key
 = 0;

15 
__u64
 
Ën
;

17 
Ën
 = 
xdp
->
d©a_’d
 - xdp->
d©a
;

19 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 
Ën
 << 32, &
key
, 0);

21  
XDP_PASS
;

22 
	}
}

24 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_cpu_dyn.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
key
 = 0;

15 
__u64
 
Ën
;

17 
Ën
 = 
xdp
->
d©a_’d
 - xdp->
d©a
;

19 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 
Ën
 << 32 |†’, &
key
, 0);

21  
XDP_PASS
;

22 
	}
}

24 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_double.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·1
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
bpf_m­_def
 
SEC
("m­s"è
	g·2
 = {

13 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

14 .
	gkey_size
 = (),

15 .
	gv®ue_size
 = (),

16 .
	gmax_’Œ›s
 = 65,

19 
	$xdp_´og1
(
xdp_md
 *
xdp
)

21 
	sS
 {

22 
pid
;

23 
cook›
;

24 
t
[2];

25 } 
d©a
[2];

27 
d©a
[0].
pid
 = 0;

28 
d©a
[0].
cook›
 = 0x12345678;

29 
d©a
[0].
t
[0] = 1;

30 
d©a
[0].
t
[1] = 7;

32 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·1
, 0x20ffffffffULL,

33 &
d©a
[0], (data[0]));

35 
d©a
[1].
pid
 = 0xaabbccdd;

36 
d©a
[1].
cook›
 = 0xeeff00112233;

37 
d©a
[1].
t
[0] = 15;

38 
d©a
[1].
t
[1] = 7ULL << 32;

40 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·2
, 0x32ffffffffULL,

41 &
d©a
[1], (data[1]));

43  
XDP_PASS
;

44 
	}
}

46 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_dyn.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
key
 = 0;

15 
__u64
 
Ën
;

17 
Ën
 = 
xdp
->
d©a_’d
 - xdp->
d©a
;

19 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 
Ën
 << 32 | 0xffffffffULL, &
key
, 0);

21  
XDP_PASS
;

22 
	}
}

24 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_map.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

13 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

14 .
	gkey_size
 = (
__u32
),

15 .
	gv®ue_size
 = (),

16 .
	gmax_’Œ›s
 = 256,

19 
	$xdp_´og1
(
xdp_md
 *
xdp
)

21 
__u32
 
key
 = 0;

22 *
v®ue
;

24 
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¬r
, &
key
);

25 ià(!
v®ue
)

26  
XDP_DROP
;

28 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0xffffffffULL, 
v®ue
 + 1, 2);

30  
XDP_PASS
;

31 
	}
}

33 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_pkt.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
key
 = 0;

16 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0x20ffffffffULL, &
key
, 0);

18  
XDP_PASS
;

19 
	}
}

21 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_stack.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
	sS
 {

15 
pid
;

16 
cook›
;

17 
t
[2];

18 } 
d©a
;

20 
d©a
.
pid
 = 0;

21 
d©a
.
cook›
 = 0x12345678;

22 
d©a
.
t
[0] = 1;

23 
d©a
.
t
[1] = 7;

25 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0xffffffffULL, &
d©a
, (data));

27  
XDP_PASS
;

28 
	}
}

30 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_stack_unalign.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
	sS
 {

15 
pid
;

16 
cook›
;

17 
t
[2];

18 } 
d©a
;

20 
d©a
.
pid
 = 0;

21 
d©a
.
cook›
 = 0x12345678;

22 
d©a
.
t
[0] = 1;

23 
d©a
.
t
[1] = 7;

25 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0xffffffffULL, (*)&
d©a
 + 1, 4);

27  
XDP_PASS
;

28 
	}
}

30 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_too_big.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
__u64
 
keys
[32];

15 
__u64
 
Ën
;

16 
i
;

18 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

19 
i
 = 0; i < 32; i++)

20 
keys
[
i
] = 0;

22 
Ën
 = 
xdp
->
d©a_’d
 - xdp->
d©a
;

24 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 
Ën
 << 32 | 0xffffffffULL,

25 &
keys
, (keys));

27  
XDP_PASS
;

28 
	}
}

30 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/perf_event_output_twice.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g·
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

7 .
	gkey_size
 = (),

8 .
	gv®ue_size
 = (),

9 .
	gmax_’Œ›s
 = 64,

12 
	$xdp_´og1
(
xdp_md
 *
xdp
)

14 
	sS
 {

15 
pid
;

16 
cook›
;

17 
t
[2];

18 } 
d©a
[2];

20 
d©a
[0].
pid
 = 0;

21 
d©a
[0].
cook›
 = 0x12345678;

22 
d©a
[0].
t
[0] = 1;

23 
d©a
[0].
t
[1] = 7;

25 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0x20ffffffffULL,

26 &
d©a
[0], (data[0]));

28 
d©a
[1].
pid
 = 0xaabbccdd;

29 
d©a
[1].
cook›
 = 0xeeff00112233;

30 
d©a
[1].
t
[0] = 15;

31 
d©a
[1].
t
[1] = 7ULL << 32;

33 
	`bpf_³rf_ev’t_ouut
(
xdp
, &
·
, 0x32ffffffffULL,

34 &
d©a
[1], (data[1]));

36  
XDP_PASS
;

37 
	}
}

39 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/queue_select_q-1.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

4 
xdp
->
rx_queue_šdex
 = -1;

6  
XDP_PASS
;

7 
	}
}

	@tests/samples/xdp/queue_select_q1.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

4 
xdp
->
rx_queue_šdex
 = 1;

6  
XDP_PASS
;

7 
	}
}

	@tests/samples/xdp/queue_select_q123456.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

4 
xdp
->
rx_queue_šdex
 = 123456;

6  
XDP_PASS
;

7 
	}
}

	@tests/samples/xdp/queue_select_q63.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

4 
xdp
->
rx_queue_šdex
 = 63;

6  
XDP_PASS
;

7 
	}
}

	@tests/samples/xdp/random.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
bpf_m­_def
 
SEC
("m­s"è
	g¬r
 = {

6 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

7 .
	gkey_size
 = (
__u32
),

8 .
	gv®ue_size
 = (
__u32
),

9 .
	gmax_’Œ›s
 = 100,

12 
	$´og
(
xdp_md
 *
xdp
)

14 *
d©a
;

15 
__u32
 
šdex
, 
v®
;

16 
__u32
 *
pkt_±r
;

18 
d©a
 = (*)()
xdp
->data;

19 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

20  
XDP_ABORTED
;

22 ià(
d©a
[12] != 0x12 || data[13] != 0x22)

23  
XDP_DROP
;

25 
pkt_±r
 = (
__u32
 *)(
d©a
 + 14);

27 
šdex
 = *
pkt_±r
;

28 *
pkt_±r
 = 0;

29 
v®
 = 
	`bpf_g‘_´ªdom_u32
();

31 ià(
	`bpf_m­_upd©e_–em
(&
¬r
, &
šdex
, &
v®
, 
BPF_ANY
))

32  
XDP_DROP
;

34  
XDP_PASS
;

35 
	}
}

	@tests/samples/xdp/stack_corruption_on_lookup.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_h–³rs.h
"

4 
bpf_m­_def
 
SEC
("m­s"è
	gm­
 = {

5 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

6 .
	gkey_size
 = (
__u32
),

7 .
	gv®ue_size
 = (
__u32
),

8 .
	gmax_’Œ›s
 = 16,

12 
	mV1
 = 0x100,

13 
	mV2
,

14 
	mV3
,

17 
	$xdp_´og1
()

19 
__u32
 
keys
[4];

22 
keys
[0] = 
V1
;

23 
keys
[1] = 
V2
;

24 
keys
[2] = 
V3
;

27 
	`bpf_m­_lookup_–em
(&
m­
, &
keys
[0]);

29 ià(
keys
[0] !ð
V1
 || keys[1] !ð
V2
 || keys[2] !ð
V3
)

30  
XDP_DROP
;

33 
	`bpf_m­_lookup_–em
(&
m­
, &
keys
[0]);

34 
	`bpf_m­_lookup_–em
(&
m­
, &
keys
[1]);

35 
	`bpf_m­_lookup_–em
(&
m­
, &
keys
[2]);

37 ià(
keys
[0] !ð
V1
 || keys[1] !ð
V2
 || keys[2] !ð
V3
)

38  
XDP_DROP
;

41 
	`bpf_m­_lookup_–em
(&
m­
, &
keys
[2]);

42 
	`bpf_m­_lookup_–em
(&
m­
, &
keys
[1]);

43 
	`bpf_m­_lookup_–em
(&
m­
, &
keys
[0]);

45 ià(
keys
[0] !ð
V1
 || keys[1] !ð
V2
 || keys[2] !ð
V3
)

46  
XDP_DROP
;

48  
XDP_PASS
;

49 
	}
}

50 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/stack_corruption_on_update.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_h–³rs.h
"

4 
bpf_m­_def
 
SEC
("m­s"è
	gm­
 = {

5 .
ty³
 = 
BPF_MAP_TYPE_ARRAY
,

6 .
	gkey_size
 = (
__u32
),

7 .
	gv®ue_size
 = (
__u32
),

8 .
	gmax_’Œ›s
 = 16,

12 
	mV1
 = 0x100,

13 
	mV2
,

14 
	mV3
,

17 
	$xdp_´og1
()

19 
__u32
 
keys
[4];

22 
keys
[0] = 
V1
;

23 
keys
[1] = 
V2
;

24 
keys
[2] = 
V3
;

27 
	`bpf_m­_upd©e_–em
(&
m­
, &
keys
[0], &keys[2], 0);

29 ià(
keys
[0] !ð
V1
 || keys[1] !ð
V2
 || keys[2] !ð
V3
)

30  
XDP_DROP
;

33 
	`bpf_m­_upd©e_–em
(&
m­
, &
keys
[2], &keys[0], 0);

35 ià(
keys
[0] !ð
V1
 || keys[1] !ð
V2
 || keys[2] !ð
V3
)

36  
XDP_DROP
;

39 
	`bpf_m­_upd©e_–em
(&
m­
, &
keys
[0], &keys[1], 0);

41 ià(
keys
[0] !ð
V1
 || keys[1] !ð
V2
 || keys[2] !ð
V3
)

42  
XDP_DROP
;

45 
	`bpf_m­_upd©e_–em
(&
m­
, &
keys
[0], &keys[0], 0);

47 ià(
keys
[0] !ð
V1
 || keys[1] !ð
V2
 || keys[2] !ð
V3
)

48  
XDP_DROP
;

50  
XDP_PASS
;

51 
	}
}

52 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@tests/samples/xdp/swap.c

1 
	~<lšux/bpf.h
>

3 
	#_htÚs
 
__bužtš_bsw­16


	)

4 
	#_htÚl
 
__bužtš_bsw­32


	)

5 
	#_htÚq
 
__bužtš_bsw­64


	)

7 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

8 *
d©a
, *
d©a2
;

10 
d©a2
 = 
d©a
 = (*)()
xdp
->data;

11 ià(
d©a
 + 80 > (*)()
xdp
->
d©a_’d
)

12  
XDP_ABORTED
;

14 ià(*(*)(
d©a
 + 12) != 0x2212)

15  
XDP_DROP
;

17 
d©a
 += 14;

18 *(*)
d©a
 = 
	`_htÚs
(*(*)data);

19 
d©a
 += 2;

20 *(*)
d©a
 = 
	`_htÚl
(*(*)data);

21 
d©a
 += 4;

22 *(*)
d©a
 = 
	`_htÚq
(*(*)data);

23 
d©a
 += 8;

24 *(*)
d©a
 = 
	`_htÚs
(*(*)data);

25 
d©a
 += 8;

26 *(*)
d©a
 = 
	`_htÚl
(*(*)data);

27 
d©a
 += 8;

29  
XDP_PASS
;

30 
	}
}

	@tests/samples/xdp/tx.c

1 
	~<lšux/bpf.h
>

3 
	$xdp_´og1
(
xdp_md
 *
xdp
) {

4 *
d©a
, *
d©a2
;

5 
t
;

7 
d©a2
 = 
d©a
 = (*)()
xdp
->data;

8 ià(
d©a
 + 60 > (*)()
xdp
->
d©a_’d
)

9  
XDP_ABORTED
;

11 
t
 = *(*)(
d©a
 + 0);

12 *(*)(
d©a
 + 0) = *(*)(data + 6);

13 *(*)(
d©a
 + 6èð
t
;

15 
t
 = *(*)(
d©a
 + 4);

16 *(*)(
d©a
 + 4) = *(*)(data + 10);

17 *(*)(
d©a
 + 10èð
t
;

20 *(*)(
d©a
 + 12) = 0x3412;

22  
XDP_TX
;

23 
	}
}

	@tests/samples/xdp_performance/random_gen_128.c

1 
	~<lšux/bpf.h
>

2 
	~"../bpf/bpf_­i.h
"

3 
	~"../bpf/bpf_h–³rs.h
"

5 
	$´og
()

7 
__u32
 
v®
 =0, 
v®_´ev
 = 0;

9 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

10 
__u32
 
i
 = 0; i < 128; i++){

11 
v®
 = 
	`bpf_g‘_´ªdom_u32
();

12 ià(
v®
 =ð
v®_´ev
)

13  
XDP_DROP
;

14 
v®_´ev
 = 
v®
;

16  
XDP_TX
;

17 
	}
}

	@tests/samples/xdp_performance/synthetic_blocks/0_null.c

	@tests/samples/xdp_performance/synthetic_blocks/0_start.c

1 
	~<lšux/bpf.h
>

2 
	~<lšux/if_‘h”.h
>

3 
	~<lšux/š.h
>

4 
	~<lšux/.h
>

5 
	~<lšux/tý.h
>

6 
	~"../bpf/bpf_­i.h
"

7 
	~"../bpf/bpf_h–³rs.h
"

9 #ifdeà 
DEBUG


13 
	#bpf_debug
(
fmt
, ...) \

15 
____fmt
[] = 
fmt
; \

16 
	`bpf_Œaû_´štk
(
____fmt
, (____fmt), \

17 ##
__VA_ARGS__
); \

18 })

	)

20 
	#bpf_debug
(
fmt
, ...è{ } 0)

	)

23 
bpf_m­_def
 
SEC
("m­s"è
	grxút
 = {

24 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

25 .
	gkey_size
 = (
__u32
),

26 .
	gv®ue_size
 = (
__u64
),

27 .
	gmax_’Œ›s
 = 
MAXENTRIES
,

30 
bpf_m­_def
 
SEC
("m­s"è
	g¿nd
 = {

31 .
ty³
 = 
BPF_MAP_TYPE_HASH
,

32 .
	gkey_size
 = (
__u32
),

33 .
	gv®ue_size
 = (
__u64
),

34 .
	gmax_’Œ›s
 = 
MAXENTRIES
,

37 
	$h_checksum
(
hdr
 *
h
){

38 
__u16
 *
Ãxt_h_u16
 = (__u16 *)
h
;

39 
__u32
 
csum
 = 0;

41 
h
->
check
 = 0;

42 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

43 
i
 = 0; i < ()((*
h
) >> 1); i++){

44 
csum
 +ð(*
Ãxt_h_u16
++);

46 
h
->
check
 = ~((
csum
 & 0xffff) + (csum >> 16));

47 
	}
}

49 
	$tý_checksum
(*
d©a
,*
d©a_’d
, 
__u16
 
d©asize
){

52 
týhdr
 *
th
 = 
d©a
;

53 
__u16
 *
d©a_16
 = (__u16 *)
d©a
;

54 
__u32
 
csum
 = 0;

56 ià((*)(
d©a_16
+1è> 
d©a_’d
)

59 
th
->
check
 = 0;

61 #´agm¨
þªg
 
loÝ
 
	`uÄÞl
(
fuÎ
)

62 
i
 = 0; i < 
d©asize
; i++){

63 
csum
 +ð*
d©a_16
++;

64 ià((*)(
d©a_16
 + 1è> 
d©a_’d
){

65 
th
->
check
 = ~((
csum
 & 0xffff) + (csum >> 16));

69 
	}
}

71 
	$m­_lookup
(
key
, 
__u8
 *
m­look_couÁ
){

72 
__u64
 *
v®ue
 = 
	`bpf_m­_lookup_–em
(&
¿nd
, &
key
);

73 *
m­look_couÁ
 += 1;

75 ià(!
v®ue
){

76 
	`bpf_debug
("Rªd†ooku°%d key %d fažed\n", *
m­look_couÁ
, 
key
);

79 ià(
XADD
)

80 
	`__sync_ãtch_ªd_add
(
v®ue
, 1);

82 
	}
}

84 
	$xdp_´og1
(
xdp_md
 *
ùx
)

86 *
d©a_’d
 = (*)()
ùx
->data_end;

87 *
d©a
 = (*)()
ùx
->data;

88 
hdr
 *
h
;

89 
týhdr
 *
th
;

90 
__u8
 
_h—d”_Ëngth
 = 0;

91 
__u8
 
m­look_couÁ
 = 0;

92 
__u16
 
h_´Ùo
 = 0;

93 
__u64
 
nh_off
;

94 
__u64
 *
v®ue
;

97 
‘hhdr
 *
‘h
 = 
d©a
;

98 
nh_off
 = (*
‘h
);

100 ià(
d©a
 + 
nh_off
 > 
d©a_’d
)

101  
XDP_DROP
;

103 
h_´Ùo
 = 
‘h
->h_proto;

	@tests/samples/xdp_performance/synthetic_blocks/1_optional2.c

3 
	gbªÃd_mac_¤c
[6];

4 
	gbªÃd_mac_¤c
[0] = 0x00;

5 
	gbªÃd_mac_¤c
[1] = 0x15;

6 
	gbªÃd_mac_¤c
[2] = 0x4d;

7 
	gbªÃd_mac_¤c
[3] = 0x0e;

8 
	gbªÃd_mac_¤c
[4] = 0x04;

9 
	gbªÃd_mac_¤c
[5] = 0xFE;

11 if((
	gbªÃd_mac_¤c
[0] =ð
‘h
->
h_de¡
[0])

12 && (
bªÃd_mac_¤c
[1] =ð
‘h
->
h_de¡
[1])

13 && (
bªÃd_mac_¤c
[2] =ð
‘h
->
h_de¡
[2])

14 && (
bªÃd_mac_¤c
[3] =ð
‘h
->
h_de¡
[3])

15 && (
bªÃd_mac_¤c
[4] =ð
‘h
->
h_de¡
[4])

16 && (
bªÃd_mac_¤c
[5] =ð
‘h
->
h_de¡
[5]))

18  
XDP_PASS
;

21 
	gbªÃd_mac_¤c
[0] = 0x01;

22 
	gbªÃd_mac_¤c
[1] = 0x16;

23 
	gbªÃd_mac_¤c
[2] = 0x4F;

24 
	gbªÃd_mac_¤c
[3] = 0x0A;

25 
	gbªÃd_mac_¤c
[4] = 0x0A;

26 
	gbªÃd_mac_¤c
[5] = 0xFD;

28 if((
	gbªÃd_mac_¤c
[0] =ð
‘h
->
h_de¡
[0])

29 && (
bªÃd_mac_¤c
[1] =ð
‘h
->
h_de¡
[1])

30 && (
bªÃd_mac_¤c
[2] =ð
‘h
->
h_de¡
[2])

31 && (
bªÃd_mac_¤c
[3] =ð
‘h
->
h_de¡
[3])

32 && (
bªÃd_mac_¤c
[4] =ð
‘h
->
h_de¡
[4])

33 && (
bªÃd_mac_¤c
[5] =ð
‘h
->
h_de¡
[5]))

35  
XDP_PASS
;

38 
	gbªÃd_mac_¤c
[0] = 0x0E;

39 
	gbªÃd_mac_¤c
[1] = 0x1B;

40 
	gbªÃd_mac_¤c
[2] = 0x4B;

41 
	gbªÃd_mac_¤c
[3] = 0x0A;

42 
	gbªÃd_mac_¤c
[4] = 0x04;

43 
	gbªÃd_mac_¤c
[5] = 0xAB;

45 if((
	gbªÃd_mac_¤c
[0] =ð
‘h
->
h_de¡
[0])

46 && (
bªÃd_mac_¤c
[1] =ð
‘h
->
h_de¡
[1])

47 && (
bªÃd_mac_¤c
[2] =ð
‘h
->
h_de¡
[2])

48 && (
bªÃd_mac_¤c
[3] =ð
‘h
->
h_de¡
[3])

49 && (
bªÃd_mac_¤c
[4] =ð
‘h
->
h_de¡
[4])

50 && (
bªÃd_mac_¤c
[5] =ð
‘h
->
h_de¡
[5]))

52  
XDP_PASS
;

56 *
	gp
 = 
d©a
;

57 
	gd¡
[3];

58 
	gd¡
[0] = 
p
[0];

59 
	gd¡
[1] = 
p
[1];

60 
	gd¡
[2] = 
p
[2];

61 
	gp
[0] = 
p
[3];

62 
	gp
[1] = 
p
[4];

63 
	gp
[2] = 
p
[5];

64 
	gp
[3] = 
d¡
[0];

65 
	gp
[4] = 
d¡
[1];

66 
	gp
[5] = 
d¡
[2];

	@tests/samples/xdp_performance/synthetic_blocks/2_ipheader.c

3 ià(
	gh_´Ùo
 !ð
	$htÚs
(
ETH_P_IP
)) {

4  
XDP_PASS
;

5 
	}
}

7 
	gh
 = 
d©a
 + 
nh_off
;

8 ià((*)(
	gh
 + 1è> 
	gd©a_’d
)

9  
	gXDP_DROP
;

11 
__u32
 
	g´Ùo
 = 
h
->
´ÙocÞ
;

12 
	g_h—d”_Ëngth
 = (
h
->
ihl
) * 4;

	@tests/samples/xdp_performance/synthetic_blocks/3_map1.c

3 
__u32
 
	gkey
;

4 
	gkey
 = (((
h
->
§ddr
 & 0xFFFFè<< 16è+ iph->
id
è& 
MASK
;

5 if(!
	$m­_lookup
(
key
, &
m­look_couÁ
)){

6 
	`bpf_debug
("Return XDP dueo†ookup missing\n");

7  
XDP_DROP
;

8 
	}
}

	@tests/samples/xdp_performance/synthetic_blocks/4_optional3.c

3 ià(
	gh
->
	gv”siÚ
 != 4){

4 
bpf_debug
("IP Not version 4\n");

5  
	gXDP_PASS
;

6 } ià(
	gh
->
	gihl
 != 5){

7 
bpf_debug
("Wrong IP Header Len\n");

8  
	gXDP_PASS
;

9 } ià(
	gh
->
	gv”siÚ
 == 56){

10 
bpf_debug
("Wrong IP version\n");

11  
	gXDP_PASS
;

12 } ià(
Áohs
(
h
->
tÙ_Ën
) < 30){

13 
bpf_debug
("IP Totlenoo small\n");

14  
	gXDP_PASS
;

15 } ià(
	gh
->
	g‰l
 == 74){

16 
bpf_debug
("IP TTL is 74\n");

17  
	gXDP_PASS
;

18 } ià(
	gh
->
	gcheck
 == 62049){

19 
bpf_debug
("IP checksum is 62049\n");

20  
	gXDP_PASS
;

21 } ià(
	gh
->
	g§ddr
 == 12929){

22 
bpf_debug
("Blacklisted IP Addr\n");

23  
	gXDP_PASS
;

24 } ià(((
	gh
->
	g§ddr
 >> 16) & 0xFFFF) == 65535){

25 
bpf_debug
 ("IPƒnds in 255.255\n");

26  
	gXDP_PASS
;

29 
__u16
 
	gÞdcheck
 = 
h
->
check
;

30 
h_checksum
(
h
);

32 ià(
	gÞdcheck
 !ð
h
->
check
){

33 
bpf_debug
("Checksum„ecalc failed\n");

34  
	gXDP_PASS
;

38 
__u32
 
	g‹mp_s
 = 
h
->
§ddr
;

39 
	gh
->
	g§ddr
 = 
h
->
daddr
;

40 
	gh
->
	gdaddr
 = 
‹mp_s
;

	@tests/samples/xdp_performance/synthetic_blocks/5_map2.c

3 
	gkey
 = 
h
->
§ddr
 & 
MASK
;

4 if(!
	$m­_lookup
(
key
, &
m­look_couÁ
)){

5 
	`bpf_debug
("Return XDP dueo†ookup missing\n");

6  
XDP_DROP
;

7 
	}
}

	@tests/samples/xdp_performance/synthetic_blocks/6_tcp.c

3 
	gnh_off
 +ð(
hdr
);

4 ià(
	g´Ùo
 !ð
IPPROTO_TCP
){

5 
bpf_debug
("not TCP\n");

6  
	gXDP_PASS
;

9 
	gd©a
 +ð
nh_off
;

10 
	gth
 = 
d©a
;

11 ià(
	gd©a
 + (*
	gth
è> 
	gd©a_’d
)

12  
	gXDP_DROP
;

13 
__u32
 
	gpÜts
;

14 
	gpÜts
 = *(
__u32
 *)
d©a
;

	@tests/samples/xdp_performance/synthetic_blocks/7_map3.c

3 
	gkey
 = 
th
->
£q
 & 
MASK
;

4 if(!
	$m­_lookup
(
key
, &
m­look_couÁ
)){

5 
	`bpf_debug
("Return XDP dueo†ookup missing\n");

6  
XDP_DROP
;

7 
	}
}

	@tests/samples/xdp_performance/synthetic_blocks/8_option4.c

3 ià(
	gth
->
	g£q
 == 0x01){

4 
bpf_debug
("Seq‚umber is 0x01\n");

5  
	gXDP_PASS
;

6 } ià(
	gth
->
	gack_£q
 == 0x01){

7 
bpf_debug
("Ack is 0x01\n");

8  
	gXDP_PASS
;

9 } ià(
	gth
->
	gack_£q
 == 0x02){

10 
bpf_debug
("Seq‡ck is 0x02\n");

11  
	gXDP_PASS
;

12 } ià(
	gth
->
	gcheck
 == 0){

13 
bpf_debug
("Incorrect checksum\n");

14  
	gXDP_PASS
;

15 } ià(
	gth
->
	gurg_±r
 > 0x01){

16 
bpf_debug
("Incorrect urgent flagcp\n");

17  
	gXDP_TX
;

18 } ià(
	gth
->
	gsyn
 &&h->
	gfš
){

19 
bpf_debug
("Both Syn‡nd Fin set\n");

20  
	gXDP_PASS
;

21 } ià(
htÚs
(
th
->
de¡
è=ð22 && htÚsÑh->
sourû
) == 5){

22 
bpf_debug
("Accessing ssh…ort from…ort 5\n");

23  
	gXDP_PASS
;

24 } ià(
htÚs
(
th
->
de¡
è=ð80 && htÚsÑh->
sourû
) == 32){

25 
bpf_debug
("Accessing HTTP…ort from…ort 32\n");

26  
	gXDP_PASS
;

27 } ià(
htÚs
(
th
->
de¡
è=ð443 && htÚsÑh->
sourû
) == 91){

28 
bpf_debug
("Accessing HTTPS…ort from…ort 91\n");

29  
	gXDP_PASS
;

31 
__u16
 
	g‹mµÜt
 = 
th
->
sourû
;

32 
	gth
->
	gsourû
 = 
th
->
de¡
;

33 
	gth
->
	gde¡
 = 
‹mµÜt
;

	@tests/samples/xdp_performance/synthetic_blocks/9_option5.c

4 
__u16
 
	g·ck‘_Ëngth
 = 
Áohs
(
h
->
tÙ_Ën
è+ (*
‘h
);

5 
__u16
 
	gtýchecksumËngth
 = 
·ck‘_Ëngth
 - (*
‘h
è- 
_h—d”_Ëngth
;

7 ià((
	gd©a
 + 
	gtýchecksumËngth
è> 
	gd©a_’d
){

8 
bpf_debug
("Packet sizeƒrror\n");

9  
	gXDP_DROP
;

11 
tý_checksum
(
d©a
, 
d©a_’d
, 40);

	@tests/samples/xdp_performance/synthetic_blocks/a_map4.c

3 
	gkey
 = ((
th
->
de¡
 << 16è+h->
sourû
è& 
MASK
;

4 if(!
	$m­_lookup
(
key
, &
m­look_couÁ
)){

5 
	`bpf_debug
("Return XDP dueo†ookup missing\n");

6  
XDP_DROP
;

7 
	}
}

	@tests/samples/xdp_performance/synthetic_blocks/b_pktextend.c

3 
__u16
 
	gex‹nd_size
 = 20;

4 ià(
bpf_xdp_adju¡_h—d
(
ùx
, 0 - 
ex‹nd_size
))

5  
	gXDP_DROP
;

6 *
	gd©a_ext_¡¬t
 = (*)()
ùx
->
d©a
;

7 
	gd©a_’d
 = (*)()
ùx
->
d©a_’d
;

8 
	gd©a
 = 
d©a_ext_¡¬t
 + 
ex‹nd_size
;

11 
‘hhdr
 *
	gÃw_‘h
 = 
d©a_ext_¡¬t
;

12 
‘hhdr
 *
	gexi¡šg_‘h
 = 
d©a
;

13 if((*)(
	gexi¡šg_‘h
 + 1è> 
	gd©a_’d
)

14  
	gXDP_DROP
;

16 
memýy
(
Ãw_‘h
, 
exi¡šg_‘h
, (*existing_eth));

19 
	gh
 = 
d©a
 + (*
‘h
);

20 
hdr
 *
	gh_Ãw
 = 
d©a_ext_¡¬t
 + (*
‘h
);

22 ià((*)(
	gh
 + 1è> 
	gd©a_’d
)

23  
	gXDP_DROP
;

25 
	g_h—d”_Ëngth
 = (
h
->
ihl
) * 4;

26 
memýy
(
h_Ãw
, 
h
, 20);

28 
	gh_Ãw
->
	gtÙ_Ën
 +ð
Áohs
(
ex‹nd_size
);

29 
	gh_Ãw
->
	g´ÙocÞ
 = 
IPPROTO_IPIP
;

30 
h_checksum
(
h_Ãw
);

	@tests/samples/xdp_performance/synthetic_blocks/c_end.c

4 
	gm­look_couÁ
++;

5 
	gpÜts
 = 
pÜts
 & 
MASK
;

6 
	gv®ue
 = 
bpf_m­_lookup_–em
(&
rxút
, &
pÜts
);

8 ià(!
	gv®ue
){

9 
bpf_debug
("Cªˆfšd key %d iÀrxúˆm­\n", 
pÜts
);

10  
	gXDP_DROP
;

13  *
	gv®ue
;

17 
	g_liûn£
[] 
SEC
("license") = "GPL";

	@
1
.
0
271
8479
src/abm/cls.c
src/abm/ctrl.c
src/abm/main.c
src/abm/main.h
src/abm/qdisc.c
src/bpf/cmsg.c
src/bpf/fw.h
src/bpf/jit.c
src/bpf/main.c
src/bpf/main.h
src/bpf/offload.c
src/bpf/verifier.c
src/flower/action.c
src/flower/cmsg.c
src/flower/cmsg.h
src/flower/lag_conf.c
src/flower/main.c
src/flower/main.h
src/flower/match.c
src/flower/metadata.c
src/flower/offload.c
src/flower/tunnel_conf.c
src/nfd3/dp.c
src/nfd3/nfd3.h
src/nfd3/rings.c
src/nfdk/dp.c
src/nfdk/nfdk.h
src/nfdk/rings.c
src/nfp.mod.c
src/nfp_abi.h
src/nfp_app.c
src/nfp_app.h
src/nfp_app_nic.c
src/nfp_asm.c
src/nfp_asm.h
src/nfp_build_info.h
src/nfp_ctrl.c
src/nfp_dev_cpp.c
src/nfp_devlink.c
src/nfp_hwmon.c
src/nfp_hwmon_legacy.c
src/nfp_ioctl.h
src/nfp_main.c
src/nfp_main.h
src/nfp_modinfo.h
src/nfp_net.h
src/nfp_net_common.c
src/nfp_net_compat.c
src/nfp_net_compat.h
src/nfp_net_ctrl.c
src/nfp_net_ctrl.h
src/nfp_net_debugdump.c
src/nfp_net_debugfs.c
src/nfp_net_dp.c
src/nfp_net_dp.h
src/nfp_net_ethtool.c
src/nfp_net_main.c
src/nfp_net_repr.c
src/nfp_net_repr.h
src/nfp_net_sriov.c
src/nfp_net_sriov.h
src/nfp_netvf_main.c
src/nfp_plat.c
src/nfp_port.c
src/nfp_port.h
src/nfp_shared_buf.c
src/nfp_test_harness.h
src/nfp_test_harness_main.c
src/nfp_test_harness_rand.c
src/nfpcore/crc32.h
src/nfpcore/kcompat.h
src/nfpcore/nfp.h
src/nfpcore/nfp6000/nfp6000.h
src/nfpcore/nfp6000/nfp_xpb.h
src/nfpcore/nfp6000_pcie.c
src/nfpcore/nfp6000_pcie.h
src/nfpcore/nfp_arm.h
src/nfpcore/nfp_cpp.h
src/nfpcore/nfp_cppcore.c
src/nfpcore/nfp_cpplib.c
src/nfpcore/nfp_dev.c
src/nfpcore/nfp_dev.h
src/nfpcore/nfp_em_manager.c
src/nfpcore/nfp_export.c
src/nfpcore/nfp_hwinfo.c
src/nfpcore/nfp_mip.c
src/nfpcore/nfp_mutex.c
src/nfpcore/nfp_nbi.c
src/nfpcore/nfp_nbi.h
src/nfpcore/nfp_nbi_mac_eth.c
src/nfpcore/nfp_net_vnic.c
src/nfpcore/nfp_net_vnic.h
src/nfpcore/nfp_nffw.c
src/nfpcore/nfp_nffw.h
src/nfpcore/nfp_nsp.c
src/nfpcore/nfp_nsp.h
src/nfpcore/nfp_nsp_cmds.c
src/nfpcore/nfp_nsp_eth.c
src/nfpcore/nfp_platform.c
src/nfpcore/nfp_resource.c
src/nfpcore/nfp_rtsym.c
src/nfpcore/nfp_target.c
src/nic/main.c
tests/samples/bpf/bpf_api.h
tests/samples/bpf/bpf_elf.h
tests/samples/bpf/bpf_endian.h
tests/samples/bpf/bpf_helpers.h
tests/samples/bpf/bpf_shared.h
tests/samples/bpf/da_-1_unspec.c
tests/samples/bpf/da_0_pass.c
tests/samples/bpf/da_1_pass.c
tests/samples/bpf/da_2_drop.c
tests/samples/bpf/da_3_unspec.c
tests/samples/bpf/da_4_nuke.c
tests/samples/bpf/da_5_nuke.c
tests/samples/bpf/da_6_unspec.c
tests/samples/bpf/da_7_redir.c
tests/samples/bpf/da_8_unspec.c
tests/samples/bpf/da_abort.c
tests/samples/bpf/da_n_unspec.c
tests/samples/bpf/dpa_read.c
tests/samples/bpf/dpa_var_off_11bit.c
tests/samples/bpf/dpa_var_off_9bit.c
tests/samples/bpf/drop.c
tests/samples/bpf/jeq_jgt.c
tests/samples/bpf/jhash.h
tests/samples/bpf/jneq.c
tests/samples/bpf/len.c
tests/samples/bpf/maps.c
tests/samples/bpf/mark.c
tests/samples/bpf/pass.c
tests/samples/bpf/store.c
tests/samples/bpf/tcp58.c
tests/samples/bpf/validate_ptr_type.c
tests/samples/c/map_stress.c
tests/samples/c/udp_netcons_sink.c
tests/samples/mefw/rts.c
tests/samples/mefw/rts_vals.c
tests/samples/xdp/adjust_head_0.c
tests/samples/xdp/adjust_head_dec_ip.c
tests/samples/xdp/adjust_head_fail_long.c
tests/samples/xdp/adjust_head_fail_offload_close.c
tests/samples/xdp/adjust_head_fail_offload_far.c
tests/samples/xdp/adjust_head_fail_short.c
tests/samples/xdp/adjust_head_fail_twice_65k.c
tests/samples/xdp/adjust_head_fail_twice_long.c
tests/samples/xdp/adjust_head_fail_twice_short.c
tests/samples/xdp/adjust_head_mfail_long.c
tests/samples/xdp/adjust_head_pass_offload_close.c
tests/samples/xdp/adjust_head_pass_offload_close2.c
tests/samples/xdp/adjust_head_pass_offload_far.c
tests/samples/xdp/adjust_head_pass_offload_far2.c
tests/samples/xdp/adjust_head_prep_224_pass.c
tests/samples/xdp/adjust_head_prep_256.c
tests/samples/xdp/adjust_head_prep_ip.c
tests/samples/xdp/adjust_head_prep_mac.c
tests/samples/xdp/adjust_head_pull32.c
tests/samples/xdp/adjust_head_push32.c
tests/samples/xdp/adjust_head_trunc.c
tests/samples/xdp/adjust_head_trunc_pass.c
tests/samples/xdp/adjust_head_trunc_to_14.c
tests/samples/xdp/adjust_head_twice.c
tests/samples/xdp/adjust_tail_14.c
tests/samples/xdp/adjust_tail_multi.c
tests/samples/xdp/adjust_tail_negative_bad.c
tests/samples/xdp/adjust_tail_positive.c
tests/samples/xdp/app_l4lb.c
tests/samples/xdp/app_packet_read.c
tests/samples/xdp/atomic_pkt.c
tests/samples/xdp/atomic_read.h
tests/samples/xdp/atomic_read0.c
tests/samples/xdp/atomic_read1.c
tests/samples/xdp/atomic_read11.c
tests/samples/xdp/atomic_read3.c
tests/samples/xdp/atomic_read64.h
tests/samples/xdp/atomic_read64_12.c
tests/samples/xdp/atomic_read64_16.c
tests/samples/xdp/atomic_read64_7.c
tests/samples/xdp/atomic_read64_8.c
tests/samples/xdp/atomic_read7.c
tests/samples/xdp/atomic_read8.c
tests/samples/xdp/atomic_short_val.c
tests/samples/xdp/atomic_stack.c
tests/samples/xdp/atomic_unalign4.c
tests/samples/xdp/atomic_unalign8.c
tests/samples/xdp/atomic_update_0.c
tests/samples/xdp/atomic_update_non0.c
tests/samples/xdp/dpa_read.c
tests/samples/xdp/dpa_var_off_11bit.c
tests/samples/xdp/dpa_var_off_9bit.c
tests/samples/xdp/dpa_write.c
tests/samples/xdp/drop.c
tests/samples/xdp/function_call_4_flat.c
tests/samples/xdp/function_call_8_nested.c
tests/samples/xdp/function_call_helpers_adj_head.c
tests/samples/xdp/function_call_stack_large.c
tests/samples/xdp/imm_relo.c
tests/samples/xdp/imm_relo2.c
tests/samples/xdp/map_array1.c
tests/samples/xdp/map_array256.c
tests/samples/xdp/map_array256_256.c
tests/samples/xdp/map_array_256_varying_val_size.c
tests/samples/xdp/map_array_u2l.c
tests/samples/xdp/map_array_update_delete.c
tests/samples/xdp/map_atomic.c
tests/samples/xdp/map_atomic32.c
tests/samples/xdp/map_atomic_65k.c
tests/samples/xdp/map_atomic_65k32.c
tests/samples/xdp/map_atomic_adj.c
tests/samples/xdp/map_atomic_adj32.c
tests/samples/xdp/map_atomic_adj_short.c
tests/samples/xdp/map_atomic_adj_short32.c
tests/samples/xdp/map_atomic_data.c
tests/samples/xdp/map_atomic_data32.c
tests/samples/xdp/map_atomic_data32_32.c
tests/samples/xdp/map_atomic_data32_64.c
tests/samples/xdp/map_atomic_multi32.c
tests/samples/xdp/map_atomic_multi64.c
tests/samples/xdp/map_bad_elem.c
tests/samples/xdp/map_bad_flags.c
tests/samples/xdp/map_bad_key.c
tests/samples/xdp/map_bad_key_array.c
tests/samples/xdp/map_bad_numa.c
tests/samples/xdp/map_bad_value.c
tests/samples/xdp/map_htab1k_array1k.c
tests/samples/xdp/map_htab256.c
tests/samples/xdp/map_htab256_256.c
tests/samples/xdp/map_htab256k.c
tests/samples/xdp/map_htab2x16.c
tests/samples/xdp/map_htab_u2l.c
tests/samples/xdp/map_htab_update_delete.c
tests/samples/xdp/map_shared_call.c
tests/samples/xdp/opt_mem_builtins.c
tests/samples/xdp/oversize.c
tests/samples/xdp/pass.c
tests/samples/xdp/perf_event_output_1s.c
tests/samples/xdp/perf_event_output_both.c
tests/samples/xdp/perf_event_output_cpu0.c
tests/samples/xdp/perf_event_output_cpu_dyn.c
tests/samples/xdp/perf_event_output_double.c
tests/samples/xdp/perf_event_output_dyn.c
tests/samples/xdp/perf_event_output_map.c
tests/samples/xdp/perf_event_output_pkt.c
tests/samples/xdp/perf_event_output_stack.c
tests/samples/xdp/perf_event_output_stack_unalign.c
tests/samples/xdp/perf_event_output_too_big.c
tests/samples/xdp/perf_event_output_twice.c
tests/samples/xdp/queue_select_q-1.c
tests/samples/xdp/queue_select_q1.c
tests/samples/xdp/queue_select_q123456.c
tests/samples/xdp/queue_select_q63.c
tests/samples/xdp/random.c
tests/samples/xdp/stack_corruption_on_lookup.c
tests/samples/xdp/stack_corruption_on_update.c
tests/samples/xdp/swap.c
tests/samples/xdp/tx.c
tests/samples/xdp_performance/random_gen_128.c
tests/samples/xdp_performance/synthetic_blocks/0_null.c
tests/samples/xdp_performance/synthetic_blocks/0_start.c
tests/samples/xdp_performance/synthetic_blocks/1_optional2.c
tests/samples/xdp_performance/synthetic_blocks/2_ipheader.c
tests/samples/xdp_performance/synthetic_blocks/3_map1.c
tests/samples/xdp_performance/synthetic_blocks/4_optional3.c
tests/samples/xdp_performance/synthetic_blocks/5_map2.c
tests/samples/xdp_performance/synthetic_blocks/6_tcp.c
tests/samples/xdp_performance/synthetic_blocks/7_map3.c
tests/samples/xdp_performance/synthetic_blocks/8_option4.c
tests/samples/xdp_performance/synthetic_blocks/9_option5.c
tests/samples/xdp_performance/synthetic_blocks/a_map4.c
tests/samples/xdp_performance/synthetic_blocks/b_pktextend.c
tests/samples/xdp_performance/synthetic_blocks/c_end.c
